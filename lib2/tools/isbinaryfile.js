"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _fs = _interopRequireDefault(require("fs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
var max_bytes = 512;

function _default(bytes, size) {
  // Read the file with no encoding for raw buffer access.
  if (size === undefined) {
    var file = bytes;

    try {
      if (!_fs["default"].statSync(file).isFile()) return false;
    } catch (err) {// otherwise continue on
    }

    var descriptor = _fs["default"].openSync(file, 'r');

    try {
      bytes = Buffer.alloc(max_bytes);
      size = _fs["default"].readSync(descriptor, bytes, 0, bytes.length, 0);
    } finally {
      _fs["default"].closeSync(descriptor);
    }
  } // async version has a function instead of a `size`
  else if (typeof size === "function") {
      var file = bytes,
          callback = size;

      _fs["default"].stat(file, function (err, stat) {
        if (err || !stat.isFile()) return callback(null, false);

        _fs["default"].open(file, 'r', function (err, descriptor) {
          if (err) return callback(err);
          var bytes = Buffer.alloc(max_bytes); // Read the file with no encoding for raw buffer access.

          _fs["default"].read(descriptor, bytes, 0, bytes.length, 0, function (err, size, bytes) {
            _fs["default"].close(descriptor, function (err2) {
              if (err || err2) return callback(err || err2);
              return callback(null, isBinaryCheck(bytes, size));
            });
          });
        });
      });
    }

  return isBinaryCheck(bytes, size);
}

function isBinaryCheck(bytes, size) {
  if (size === 0) return false;
  var suspicious_bytes = 0;
  var total_bytes = Math.min(size, max_bytes);

  if (size >= 3 && bytes[0] == 0xEF && bytes[1] == 0xBB && bytes[2] == 0xBF) {
    // UTF-8 BOM. This isn't binary.
    return false;
  }

  for (var i = 0; i < total_bytes; i++) {
    if (bytes[i] === 0) {
      // NULL byte--it's binary!
      return true;
    } else if ((bytes[i] < 7 || bytes[i] > 14) && (bytes[i] < 32 || bytes[i] > 127)) {
      // UTF-8 detection
      if (bytes[i] > 193 && bytes[i] < 224 && i + 1 < total_bytes) {
        i++;

        if (bytes[i] > 127 && bytes[i] < 192) {
          continue;
        }
      } else if (bytes[i] > 223 && bytes[i] < 240 && i + 2 < total_bytes) {
        i++;

        if (bytes[i] > 127 && bytes[i] < 192 && bytes[i + 1] > 127 && bytes[i + 1] < 192) {
          i++;
          continue;
        }
      }

      suspicious_bytes++; // Read at least 32 bytes before making a decision

      if (i > 32 && suspicious_bytes * 100 / total_bytes > 10) {
        return true;
      }
    }
  }

  if (suspicious_bytes * 100 / total_bytes > 10) {
    return true;
  }

  return false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90b29scy9pc2JpbmFyeWZpbGUudHMiXSwibmFtZXMiOlsibWF4X2J5dGVzIiwiYnl0ZXMiLCJzaXplIiwidW5kZWZpbmVkIiwiZmlsZSIsImZzIiwic3RhdFN5bmMiLCJpc0ZpbGUiLCJlcnIiLCJkZXNjcmlwdG9yIiwib3BlblN5bmMiLCJCdWZmZXIiLCJhbGxvYyIsInJlYWRTeW5jIiwibGVuZ3RoIiwiY2xvc2VTeW5jIiwiY2FsbGJhY2siLCJzdGF0Iiwib3BlbiIsInJlYWQiLCJjbG9zZSIsImVycjIiLCJpc0JpbmFyeUNoZWNrIiwic3VzcGljaW91c19ieXRlcyIsInRvdGFsX2J5dGVzIiwiTWF0aCIsIm1pbiIsImkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFLQTs7OztBQUxBOzs7OztBQU1BLElBQUlBLFNBQVMsR0FBRyxHQUFoQjs7QUFFZSxrQkFBU0MsS0FBVCxFQUFnQkMsSUFBaEIsRUFBdUI7QUFDcEM7QUFDQSxNQUFJQSxJQUFJLEtBQUtDLFNBQWIsRUFBd0I7QUFDdEIsUUFBSUMsSUFBSSxHQUFHSCxLQUFYOztBQUNBLFFBQUk7QUFDRixVQUFHLENBQUNJLGVBQUdDLFFBQUgsQ0FBWUYsSUFBWixFQUFrQkcsTUFBbEIsRUFBSixFQUFnQyxPQUFPLEtBQVA7QUFDakMsS0FGRCxDQUVFLE9BQU9DLEdBQVAsRUFBWSxDQUNaO0FBQ0Q7O0FBQ0QsUUFBSUMsVUFBVSxHQUFHSixlQUFHSyxRQUFILENBQVlOLElBQVosRUFBa0IsR0FBbEIsQ0FBakI7O0FBQ0EsUUFBSTtBQUNGSCxNQUFBQSxLQUFLLEdBQUdVLE1BQU0sQ0FBQ0MsS0FBUCxDQUFhWixTQUFiLENBQVI7QUFDQUUsTUFBQUEsSUFBSSxHQUFHRyxlQUFHUSxRQUFILENBQVlKLFVBQVosRUFBd0JSLEtBQXhCLEVBQStCLENBQS9CLEVBQWtDQSxLQUFLLENBQUNhLE1BQXhDLEVBQWdELENBQWhELENBQVA7QUFDRCxLQUhELFNBR1U7QUFDUlQscUJBQUdVLFNBQUgsQ0FB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QVcsR0FBWCxJQUFrQjFCLEtBQUssQ0FBQzBCLENBQUQsQ0FBTCxHQUFXLEdBQWpDLEVBQXNDO0FBQ3BDO0FBQ0Q7QUFDRixPQUxELE1BTUssSUFBSTFCLEtBQUssQ0FBQzBCLENBQUQsQ0FBTCxHQUFXLEdBQVgsSUFBa0IxQixLQUFLLENBQUMwQixDQUFELENBQUwsR0FBVyxHQUE3QixJQUFvQ0EsQ0FBQyxHQUFHLENBQUosR0FBUUgsV0FBaEQsRUFBNkQ7QUFDaEVHLFFBQUFBLENBQUM7O0FBQ0QsWUFBSTFCLEtBQUssQ0FBQzBCLENBQUQsQ0FBTCxHQUFXLEdBQVgsSUFBa0IxQixLQUFLLENBQUMwQixDQUFELENBQUwsR0FBVyxHQUE3QixJQUFvQzFCLEtBQUssQ0FBQzBCLENBQUMsR0FBRyxDQUFMLENBQUwsR0FBZSxHQUFuRCxJQUEwRDFCLEtBQUssQ0FBQzBCLENBQUMsR0FBRyxDQUFMLENBQUwsR0FBZSxHQUE3RSxFQUFrRjtBQUNoRkEsVUFBQUEsQ0FBQztBQUNEO0FBQ0Q7QUFDRjs7QUFDREosTUFBQUEsZ0JBQWdCLEdBZjZELENBZ0I3RTs7QUFDQSxVQUFJSSxDQUFDLEdBQUcsRUFBSixJQUFXSixnQkFBZ0IsR0FBRyxHQUFwQixHQUEyQkMsV0FBM0IsR0FBeUMsRUFBdkQsRUFBMkQ7QUFDekQsZUFBTyxJQUFQO0FBQ0Q7QUFDRjtBQUNGOztBQUVELE1BQUtELGdCQUFnQixHQUFHLEdBQXBCLEdBQTJCQyxXQUEzQixHQUF5QyxFQUE3QyxFQUFpRDtBQUMvQyxXQUFPLElBQVA7QUFDRDs7QUFFRCxTQUFPLEtBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMTMgdGhlIFBNMiBwcm9qZWN0IGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIGxpY2Vuc2UgdGhhdFxuICogY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuXG4gKi9cbmltcG9ydCBmcyBmcm9tICdmcyc7XG52YXIgbWF4X2J5dGVzID0gNTEyO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbihieXRlcywgc2l6ZT8pIHtcbiAgLy8gUmVhZCB0aGUgZmlsZSB3aXRoIG5vIGVuY29kaW5nIGZvciByYXcgYnVmZmVyIGFjY2Vzcy5cbiAgaWYgKHNpemUgPT09IHVuZGVmaW5lZCkge1xuICAgIHZhciBmaWxlID0gYnl0ZXM7XG4gICAgdHJ5IHtcbiAgICAgIGlmKCFmcy5zdGF0U3luYyhmaWxlKS5pc0ZpbGUoKSkgcmV0dXJuIGZhbHNlO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gb3RoZXJ3aXNlIGNvbnRpbnVlIG9uXG4gICAgfVxuICAgIHZhciBkZXNjcmlwdG9yID0gZnMub3BlblN5bmMoZmlsZSwgJ3InKTtcbiAgICB0cnkge1xuICAgICAgYnl0ZXMgPSBCdWZmZXIuYWxsb2MobWF4X2J5dGVzKTtcbiAgICAgIHNpemUgPSBmcy5yZWFkU3luYyhkZXNjcmlwdG9yLCBieXRlcywgMCwgYnl0ZXMubGVuZ3RoLCAwKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgZnMuY2xvc2VTeW5jKGRlc2NyaXB0b3IpO1xuICAgIH1cbiAgfVxuICAvLyBhc3luYyB2ZXJzaW9uIGhhcyBhIGZ1bmN0aW9uIGluc3RlYWQgb2YgYSBgc2l6ZWBcbiAgZWxzZSBpZiAodHlwZW9mIHNpemUgPT09IFwiZnVuY3Rpb25cIikge1xuICAgIHZhciBmaWxlID0gYnl0ZXMsIGNhbGxiYWNrID0gc2l6ZTtcbiAgICBmcy5zdGF0KGZpbGUsIGZ1bmN0aW9uKGVyciwgc3RhdCkge1xuICAgICAgaWYgKGVyciB8fCAhc3RhdC5pc0ZpbGUoKSkgcmV0dXJuIGNhbGxiYWNrKG51bGwsIGZhbHNlKTtcblxuICAgICAgZnMub3BlbihmaWxlLCAncicsIGZ1bmN0aW9uKGVyciwgZGVzY3JpcHRvcil7XG4gICAgICAgIGlmIChlcnIpIHJldHVybiBjYWxsYmFjayhlcnIpO1xuICAgICAgICB2YXIgYnl0ZXMgPSBCdWZmZXIuYWxsb2MobWF4X2J5dGVzKTtcbiAgICAgICAgLy8gUmVhZCB0aGUgZmlsZSB3aXRoIG5vIGVuY29kaW5nIGZvciByYXcgYnVmZmVyIGFjY2Vzcy5cbiAgICAgICAgZnMucmVhZChkZXNjcmlwdG9yLCBieXRlcywgMCwgYnl0ZXMubGVuZ3RoLCAwLCBmdW5jdGlvbihlcnIsIHNpemUsIGJ5dGVzKXtcbiAgICAgICAgICBmcy5jbG9zZShkZXNjcmlwdG9yLCBmdW5jdGlvbihlcnIyKXtcbiAgICAgICAgICAgIGlmIChlcnIgfHwgZXJyMilcbiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVyciB8fCBlcnIyKTtcbiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBpc0JpbmFyeUNoZWNrKGJ5dGVzLCBzaXplKSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gaXNCaW5hcnlDaGVjayhieXRlcywgc2l6ZSk7XG59XG5cbmZ1bmN0aW9uIGlzQmluYXJ5Q2hlY2soYnl0ZXMsIHNpemUpIHtcbiAgaWYgKHNpemUgPT09IDApXG4gICAgcmV0dXJuIGZhbHNlO1xuXG4gIHZhciBzdXNwaWNpb3VzX2J5dGVzID0gMDtcbiAgdmFyIHRvdGFsX2J5dGVzID0gTWF0aC5taW4oc2l6ZSwgbWF4X2J5dGVzKTtcblxuICBpZiAoc2l6ZSA+PSAzICYmIGJ5dGVzWzBdID09IDB4RUYgJiYgYnl0ZXNbMV0gPT0gMHhCQiAmJiBieXRlc1syXSA9PSAweEJGKSB7XG4gICAgLy8gVVRGLTggQk9NLiBUaGlzIGlzbid0IGJpbmFyeS5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBmb3IgKHZhciBpID0gMDsgaSA8IHRvdGFsX2J5dGVzOyBpKyspIHtcbiAgICBpZiAoYnl0ZXNbaV0gPT09IDApIHsgLy8gTlVMTCBieXRlLS1pdCdzIGJpbmFyeSFcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBlbHNlIGlmICgoYnl0ZXNbaV0gPCA3IHx8IGJ5dGVzW2ldID4gMTQpICYmIChieXRlc1tpXSA8IDMyIHx8IGJ5dGVzW2ldID4gMTI3KSkge1xuICAgICAgLy8gVVRGLTggZGV0ZWN0aW9uXG4gICAgICBpZiAoYnl0ZXNbaV0gPiAxOTMgJiYgYnl0ZXNbaV0gPCAyMjQgJiYgaSArIDEgPCB0b3RhbF9ieXRlcykge1xuICAgICAgICBpKys7XG4gICAgICAgIGlmIChieXRlc1tpXSA+IDEyNyAmJiBieXRlc1tpXSA8IDE5Mikge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBlbHNlIGlmIChieXRlc1tpXSA+IDIyMyAmJiBieXRlc1tpXSA8IDI0MCAmJiBpICsgMiA8IHRvdGFsX2J5dGVzKSB7XG4gICAgICAgIGkrKztcbiAgICAgICAgaWYgKGJ5dGVzW2ldID4gMTI3ICYmIGJ5dGVzW2ldIDwgMTkyICYmIGJ5dGVzW2kgKyAxXSA+IDEyNyAmJiBieXRlc1tpICsgMV0gPCAxOTIpIHtcbiAgICAgICAgICBpKys7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHN1c3BpY2lvdXNfYnl0ZXMrKztcbiAgICAgIC8vIFJlYWQgYXQgbGVhc3QgMzIgYnl0ZXMgYmVmb3JlIG1ha2luZyBhIGRlY2lzaW9uXG4gICAgICBpZiAoaSA+IDMyICYmIChzdXNwaWNpb3VzX2J5dGVzICogMTAwKSAvIHRvdGFsX2J5dGVzID4gMTApIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKChzdXNwaWNpb3VzX2J5dGVzICogMTAwKSAvIHRvdGFsX2J5dGVzID4gMTApIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn1cbiJdfQ==
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _fs = _interopRequireDefault(require("fs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
var max_bytes = 512;

function _default(bytes, size) {
  // Read the file with no encoding for raw buffer access.
  if (size === undefined) {
    var file = bytes;

    try {
      if (!_fs["default"].statSync(file).isFile()) return false;
    } catch (err) {// otherwise continue on
    }

    var descriptor = _fs["default"].openSync(file, 'r');

    try {
      bytes = Buffer.alloc(max_bytes);
      size = _fs["default"].readSync(descriptor, bytes, 0, bytes.length, 0);
    } finally {
      _fs["default"].closeSync(descriptor);
    }
  } // async version has a function instead of a `size`
  else if (typeof size === "function") {
      var file = bytes,
          callback = size;

      _fs["default"].stat(file, function (err, stat) {
        if (err || !stat.isFile()) return callback(null, false);

        _fs["default"].open(file, 'r', function (err, descriptor) {
          if (err) return callback(err);
          var bytes = Buffer.alloc(max_bytes); // Read the file with no encoding for raw buffer access.

          _fs["default"].read(descriptor, bytes, 0, bytes.length, 0, function (err, size, bytes) {
            _fs["default"].close(descriptor, function (err2) {
              if (err || err2) return callback(err || err2);
              return callback(null, isBinaryCheck(bytes, size));
            });
          });
        });
      });
    }

  return isBinaryCheck(bytes, size);
}

function isBinaryCheck(bytes, size) {
  if (size === 0) return false;
  var suspicious_bytes = 0;
  var total_bytes = Math.min(size, max_bytes);

  if (size >= 3 && bytes[0] == 0xEF && bytes[1] == 0xBB && bytes[2] == 0xBF) {
    // UTF-8 BOM. This isn't binary.
    return false;
  }

  for (var i = 0; i < total_bytes; i++) {
    if (bytes[i] === 0) {
      // NULL byte--it's binary!
      return true;
    } else if ((bytes[i] < 7 || bytes[i] > 14) && (bytes[i] < 32 || bytes[i] > 127)) {
      // UTF-8 detection
      if (bytes[i] > 193 && bytes[i] < 224 && i + 1 < total_bytes) {
        i++;

        if (bytes[i] > 127 && bytes[i] < 192) {
          continue;
        }
      } else if (bytes[i] > 223 && bytes[i] < 240 && i + 2 < total_bytes) {
        i++;

        if (bytes[i] > 127 && bytes[i] < 192 && bytes[i + 1] > 127 && bytes[i + 1] < 192) {
          i++;
          continue;
        }
      }

      suspicious_bytes++; // Read at least 32 bytes before making a decision

      if (i > 32 && suspicious_bytes * 100 / total_bytes > 10) {
        return true;
      }
    }
  }

  if (suspicious_bytes * 100 / total_bytes > 10) {
    return true;
  }

  return false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90b29scy9pc2JpbmFyeWZpbGUudHMiXSwibmFtZXMiOlsibWF4X2J5dGVzIiwiYnl0ZXMiLCJzaXplIiwidW5kZWZpbmVkIiwiZmlsZSIsImZzIiwic3RhdFN5bmMiLCJpc0ZpbGUiLCJlcnIiLCJkZXNjcmlwdG9yIiwib3BlblN5bmMiLCJCdWZmZXIiLCJhbGxvYyIsInJlYWRTeW5jIiwibGVuZ3RoIiwiY2xvc2VTeW5jIiwiY2FsbGJhY2siLCJzdGF0Iiwib3BlbiIsInJlYWQiLCJjbG9zZSIsImVycjIiLCJpc0JpbmFyeUNoZWNrIiwic3VzcGljaW91c19ieXRlcyIsInRvdGFsX2J5dGVzIiwiTWF0aCIsIm1pbiIsImkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFLQTs7OztBQUxBOzs7OztBQU1BLElBQUlBLFNBQVMsR0FBRyxHQUFoQjs7QUFFZSxrQkFBU0MsS0FBVCxFQUFnQkMsSUFBaEIsRUFBdUI7QUFDcEM7QUFDQSxNQUFJQSxJQUFJLEtBQUtDLFNBQWIsRUFBd0I7QUFDdEIsUUFBSUMsSUFBSSxHQUFHSCxLQUFYOztBQUNBLFFBQUk7QUFDRixVQUFHLENBQUNJLGVBQUdDLFFBQUgsQ0FBWUYsSUFBWixFQUFrQkcsTUFBbEIsRUFBSixFQUFnQyxPQUFPLEtBQVA7QUFDakMsS0FGRCxDQUVFLE9BQU9DLEdBQVAsRUFBWSxDQUNaO0FBQ0Q7O0FBQ0QsUUFBSUMsVUFBVSxHQUFHSixlQUFHSyxRQUFILENBQVlOLElBQVosRUFBa0IsR0FBbEIsQ0FBakI7O0FBQ0EsUUFBSTtBQUNGSCxNQUFBQSxLQUFLLEdBQUdVLE1BQU0sQ0FBQ0MsS0FBUCxDQUFhWixTQUFiLENBQVI7QUFDQUUsTUFBQUEsSUFBSSxHQUFHRyxlQUFHUSxRQUFILENBQVlKLFVBQVosRUFBd0JSLEtBQXhCLEVBQStCLENBQS9CLEVBQWtDQSxLQUFLLENBQUNhLE1BQXhDLEVBQWdELENBQWhELENBQVA7QUFDRCxLQUhELFNBR1U7QUFDUlQscUJBQUdVLFNBQUgsQ0FB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QVcsR0FBWCxJQUFrQjFCLEtBQUssQ0FBQzBCLENBQUQsQ0FBTCxHQUFXLEdBQWpDLEVBQXNDO0FBQ3BDO0FBQ0Q7QUFDRixPQUxELE1BTUssSUFBSTFCLEtBQUssQ0FBQzBCLENBQUQsQ0FBTCxHQUFXLEdBQVgsSUFBa0IxQixLQUFLLENBQUMwQixDQUFELENBQUwsR0FBVyxHQUE3QixJQUFvQ0EsQ0FBQyxHQUFHLENBQUosR0FBUUgsV0FBaEQsRUFBNkQ7QUFDaEVHLFFBQUFBLENBQUM7O0FBQ0QsWUFBSTFCLEtBQUssQ0FBQzBCLENBQUQsQ0FBTCxHQUFXLEdBQVgsSUFBa0IxQixLQUFLLENBQUMwQixDQUFELENBQUwsR0FBVyxHQUE3QixJQUFvQzFCLEtBQUssQ0FBQzBCLENBQUMsR0FBRyxDQUFMLENBQUwsR0FBZSxHQUFuRCxJQUEwRDFCLEtBQUssQ0FBQzBCLENBQUMsR0FBRyxDQUFMLENBQUwsR0FBZSxHQUE3RSxFQUFrRjtBQUNoRkEsVUFBQUEsQ0FBQztBQUNEO0FBQ0Q7QUFDRjs7QUFDREosTUFBQUEsZ0JBQWdCLEdBZjZELENBZ0I3RTs7QUFDQSxVQUFJSSxDQUFDLEdBQUcsRUFBSixJQUFXSixnQkFBZ0IsR0FBRyxHQUFwQixHQUEyQkMsV0FBM0IsR0FBeUMsRUFBdkQsRUFBMkQ7QUFDekQsZUFBTyxJQUFQO0FBQ0Q7QUFDRjtBQUNGOztBQUVELE1BQUtELGdCQUFnQixHQUFHLEdBQXBCLEdBQTJCQyxXQUEzQixHQUF5QyxFQUE3QyxFQUFpRDtBQUMvQyxXQUFPLElBQVA7QUFDRDs7QUFFRCxTQUFPLEtBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgMjAxMyB0aGUgUE0yIHByb2plY3QgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBsaWNlbnNlIHRoYXRcclxuICogY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuXHJcbiAqL1xyXG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xyXG52YXIgbWF4X2J5dGVzID0gNTEyO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24oYnl0ZXMsIHNpemU/KSB7XHJcbiAgLy8gUmVhZCB0aGUgZmlsZSB3aXRoIG5vIGVuY29kaW5nIGZvciByYXcgYnVmZmVyIGFjY2Vzcy5cclxuICBpZiAoc2l6ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICB2YXIgZmlsZSA9IGJ5dGVzO1xyXG4gICAgdHJ5IHtcclxuICAgICAgaWYoIWZzLnN0YXRTeW5jKGZpbGUpLmlzRmlsZSgpKSByZXR1cm4gZmFsc2U7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgLy8gb3RoZXJ3aXNlIGNvbnRpbnVlIG9uXHJcbiAgICB9XHJcbiAgICB2YXIgZGVzY3JpcHRvciA9IGZzLm9wZW5TeW5jKGZpbGUsICdyJyk7XHJcbiAgICB0cnkge1xyXG4gICAgICBieXRlcyA9IEJ1ZmZlci5hbGxvYyhtYXhfYnl0ZXMpO1xyXG4gICAgICBzaXplID0gZnMucmVhZFN5bmMoZGVzY3JpcHRvciwgYnl0ZXMsIDAsIGJ5dGVzLmxlbmd0aCwgMCk7XHJcbiAgICB9IGZpbmFsbHkge1xyXG4gICAgICBmcy5jbG9zZVN5bmMoZGVzY3JpcHRvcik7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8vIGFzeW5jIHZlcnNpb24gaGFzIGEgZnVuY3Rpb24gaW5zdGVhZCBvZiBhIGBzaXplYFxyXG4gIGVsc2UgaWYgKHR5cGVvZiBzaXplID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgIHZhciBmaWxlID0gYnl0ZXMsIGNhbGxiYWNrID0gc2l6ZTtcclxuICAgIGZzLnN0YXQoZmlsZSwgZnVuY3Rpb24oZXJyLCBzdGF0KSB7XHJcbiAgICAgIGlmIChlcnIgfHwgIXN0YXQuaXNGaWxlKCkpIHJldHVybiBjYWxsYmFjayhudWxsLCBmYWxzZSk7XHJcblxyXG4gICAgICBmcy5vcGVuKGZpbGUsICdyJywgZnVuY3Rpb24oZXJyLCBkZXNjcmlwdG9yKXtcclxuICAgICAgICBpZiAoZXJyKSByZXR1cm4gY2FsbGJhY2soZXJyKTtcclxuICAgICAgICB2YXIgYnl0ZXMgPSBCdWZmZXIuYWxsb2MobWF4X2J5dGVzKTtcclxuICAgICAgICAvLyBSZWFkIHRoZSBmaWxlIHdpdGggbm8gZW5jb2RpbmcgZm9yIHJhdyBidWZmZXIgYWNjZXNzLlxyXG4gICAgICAgIGZzLnJlYWQoZGVzY3JpcHRvciwgYnl0ZXMsIDAsIGJ5dGVzLmxlbmd0aCwgMCwgZnVuY3Rpb24oZXJyLCBzaXplLCBieXRlcyl7XHJcbiAgICAgICAgICBmcy5jbG9zZShkZXNjcmlwdG9yLCBmdW5jdGlvbihlcnIyKXtcclxuICAgICAgICAgICAgaWYgKGVyciB8fCBlcnIyKVxyXG4gICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIgfHwgZXJyMik7XHJcbiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBpc0JpbmFyeUNoZWNrKGJ5dGVzLCBzaXplKSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHJldHVybiBpc0JpbmFyeUNoZWNrKGJ5dGVzLCBzaXplKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNCaW5hcnlDaGVjayhieXRlcywgc2l6ZSkge1xyXG4gIGlmIChzaXplID09PSAwKVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG5cclxuICB2YXIgc3VzcGljaW91c19ieXRlcyA9IDA7XHJcbiAgdmFyIHRvdGFsX2J5dGVzID0gTWF0aC5taW4oc2l6ZSwgbWF4X2J5dGVzKTtcclxuXHJcbiAgaWYgKHNpemUgPj0gMyAmJiBieXRlc1swXSA9PSAweEVGICYmIGJ5dGVzWzFdID09IDB4QkIgJiYgYnl0ZXNbMl0gPT0gMHhCRikge1xyXG4gICAgLy8gVVRGLTggQk9NLiBUaGlzIGlzbid0IGJpbmFyeS5cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgdG90YWxfYnl0ZXM7IGkrKykge1xyXG4gICAgaWYgKGJ5dGVzW2ldID09PSAwKSB7IC8vIE5VTEwgYnl0ZS0taXQncyBiaW5hcnkhXHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoKGJ5dGVzW2ldIDwgNyB8fCBieXRlc1tpXSA+IDE0KSAmJiAoYnl0ZXNbaV0gPCAzMiB8fCBieXRlc1tpXSA+IDEyNykpIHtcclxuICAgICAgLy8gVVRGLTggZGV0ZWN0aW9uXHJcbiAgICAgIGlmIChieXRlc1tpXSA+IDE5MyAmJiBieXRlc1tpXSA8IDIyNCAmJiBpICsgMSA8IHRvdGFsX2J5dGVzKSB7XHJcbiAgICAgICAgaSsrO1xyXG4gICAgICAgIGlmIChieXRlc1tpXSA+IDEyNyAmJiBieXRlc1tpXSA8IDE5Mikge1xyXG4gICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGVsc2UgaWYgKGJ5dGVzW2ldID4gMjIzICYmIGJ5dGVzW2ldIDwgMjQwICYmIGkgKyAyIDwgdG90YWxfYnl0ZXMpIHtcclxuICAgICAgICBpKys7XHJcbiAgICAgICAgaWYgKGJ5dGVzW2ldID4gMTI3ICYmIGJ5dGVzW2ldIDwgMTkyICYmIGJ5dGVzW2kgKyAxXSA+IDEyNyAmJiBieXRlc1tpICsgMV0gPCAxOTIpIHtcclxuICAgICAgICAgIGkrKztcclxuICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBzdXNwaWNpb3VzX2J5dGVzKys7XHJcbiAgICAgIC8vIFJlYWQgYXQgbGVhc3QgMzIgYnl0ZXMgYmVmb3JlIG1ha2luZyBhIGRlY2lzaW9uXHJcbiAgICAgIGlmIChpID4gMzIgJiYgKHN1c3BpY2lvdXNfYnl0ZXMgKiAxMDApIC8gdG90YWxfYnl0ZXMgPiAxMCkge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpZiAoKHN1c3BpY2lvdXNfYnl0ZXMgKiAxMDApIC8gdG90YWxfYnl0ZXMgPiAxMCkge1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gZmFsc2U7XHJcbn1cclxuIl19
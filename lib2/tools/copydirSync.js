"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

/*
  options: {
    utimes: false,  // Boolean | Object, keep utimes if true
    mode: false,    // Boolean | Number, keep file mode if true
    cover: true,    // Boolean, cover if file exists
    filter: true,   // Boolean | Function, file filter
  }
*/
function copydirSync(from, to, options) {
  if (typeof options === 'function') {
    options = {
      filter: options
    };
  }

  if (typeof options === 'undefined') options = {};

  if (typeof options.cover === 'undefined') {
    options.cover = true;
  }

  options.filter = typeof options.filter === 'function' ? options.filter : function (state, filepath, filename) {
    return options.filter;
  };

  var stats = _fs["default"].lstatSync(from);

  var statsname = stats.isDirectory() ? 'directory' : stats.isFile() ? 'file' : stats.isSymbolicLink() ? 'symbolicLink' : '';
  var valid = options.filter(statsname, from, _path["default"].dirname(from), _path["default"].basename(from));

  if (statsname === 'directory' || statsname === 'symbolicLink') {
    // Directory or SymbolicLink
    if (valid) {
      try {
        _fs["default"].statSync(to);
      } catch (err) {
        if (err.code === 'ENOENT') {
          _fs["default"].mkdirSync(to);

          options.debug && console.log('>> ' + to);
        } else {
          throw err;
        }
      }

      rewriteSync(to, options, stats);
      if (statsname != 'symbolicLink') listDirectorySync(from, to, options);
    }
  } else if (stats.isFile()) {
    // File
    if (valid) {
      if (options.cover) {
        writeFileSync(from, to, options, stats);
      } else {
        try {
          _fs["default"].statSync(to);
        } catch (err) {
          if (err.code === 'ENOENT') {
            writeFileSync(from, to, options, stats);
          } else {
            throw err;
          }
        }
      }
    }
  } else {
    throw new Error('stats invalid: ' + from);
  }
}

;

function listDirectorySync(from, to, options) {
  var files = _fs["default"].readdirSync(from);

  copyFromArraySync(files, from, to, options);
}

function copyFromArraySync(files, from, to, options) {
  if (files.length === 0) return true;
  var f = files.shift();
  copydirSync(_path["default"].join(from, f), _path["default"].join(to, f), options);
  copyFromArraySync(files, from, to, options);
}

function writeFileSync(from, to, options, stats) {
  _fs["default"].writeFileSync(to, _fs["default"].readFileSync(from, 'binary'), 'binary');

  options.debug && console.log('>> ' + to);
  rewriteSync(to, options, stats);
}

function rewriteSync(f, options, stats, callback) {
  if (options.cover) {
    var mode = options.mode === true ? stats.mode : options.mode;
    var utimes = options.utimes === true ? {
      atime: stats.atime,
      mtime: stats.mtime
    } : options.utimes;
    mode && _fs["default"].chmodSync(f, mode);
    utimes && _fs["default"].utimesSync(f, utimes.atime, utimes.mtime);
  }

  return true;
}

var _default = copydirSync;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90b29scy9jb3B5ZGlyU3luYy50cyJdLCJuYW1lcyI6WyJjb3B5ZGlyU3luYyIsImZyb20iLCJ0byIsIm9wdGlvbnMiLCJmaWx0ZXIiLCJjb3ZlciIsInN0YXRlIiwiZmlsZXBhdGgiLCJmaWxlbmFtZSIsInN0YXRzIiwiZnMiLCJsc3RhdFN5bmMiLCJzdGF0c25hbWUiLCJpc0RpcmVjdG9yeSIsImlzRmlsZSIsImlzU3ltYm9saWNMaW5rIiwidmFsaWQiLCJwYXRoIiwiZGlybmFtZSIsImJhc2VuYW1lIiwic3RhdFN5bmMiLCJlcnIiLCJjb2RlIiwibWtkaXJTeW5jIiwiZGVidWciLCJjb25zb2xlIiwibG9nIiwicmV3cml0ZVN5bmMiLCJsaXN0RGlyZWN0b3J5U3luYyIsIndyaXRlRmlsZVN5bmMiLCJFcnJvciIsImZpbGVzIiwicmVhZGRpclN5bmMiLCJjb3B5RnJvbUFycmF5U3luYyIsImxlbmd0aCIsImYiLCJzaGlmdCIsImpvaW4iLCJyZWFkRmlsZVN5bmMiLCJjYWxsYmFjayIsIm1vZGUiLCJ1dGltZXMiLCJhdGltZSIsIm10aW1lIiwiY2htb2RTeW5jIiwidXRpbWVzU3luYyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBUUEsU0FBU0EsV0FBVCxDQUFxQkMsSUFBckIsRUFBMkJDLEVBQTNCLEVBQStCQyxPQUEvQixFQUF5QztBQUN2QyxNQUFJLE9BQU9BLE9BQVAsS0FBbUIsVUFBdkIsRUFBbUM7QUFDakNBLElBQUFBLE9BQU8sR0FBRztBQUNSQyxNQUFBQSxNQUFNLEVBQUVEO0FBREEsS0FBVjtBQUdEOztBQUNELE1BQUcsT0FBT0EsT0FBUCxLQUFtQixXQUF0QixFQUFtQ0EsT0FBTyxHQUFHLEVBQVY7O0FBQ25DLE1BQUcsT0FBT0EsT0FBTyxDQUFDRSxLQUFmLEtBQXlCLFdBQTVCLEVBQXlDO0FBQ3ZDRixJQUFBQSxPQUFPLENBQUNFLEtBQVIsR0FBZ0IsSUFBaEI7QUFDRDs7QUFD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LEtBQUssRUFBRWpDLEtBQUssQ0FBQ2lDLEtBRHdCO0FBRXJDQyxNQUFBQSxLQUFLLEVBQUVsQyxLQUFLLENBQUNrQztBQUZ3QixLQUExQixHQUdUeEMsT0FBTyxDQUFDc0MsTUFIWjtBQUlBRCxJQUFBQSxJQUFJLElBQUk5QixlQUFHa0MsU0FBSCxDQUFhVCxDQUFiLEVBQWdCSyxJQUFoQixDQUFSO0FBQ0FDLElBQUFBLE1BQU0sSUFBSS9CLGVBQUdtQyxVQUFILENBQWNWLENBQWQsRUFBaUJNLE1BQU0sQ0FBQ0MsS0FBeEIsRUFBK0JELE1BQU0sQ0FBQ0UsS0FBdEMsQ0FBVjtBQUNEOztBQUNELFNBQU8sSUFBUDtBQUNEOztlQUVjM0MsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbi8qXG4gIG9wdGlvbnM6IHtcbiAgICB1dGltZXM6IGZhbHNlLCAgLy8gQm9vbGVhbiB8IE9iamVjdCwga2VlcCB1dGltZXMgaWYgdHJ1ZVxuICAgIG1vZGU6IGZhbHNlLCAgICAvLyBCb29sZWFuIHwgTnVtYmVyLCBrZWVwIGZpbGUgbW9kZSBpZiB0cnVlXG4gICAgY292ZXI6IHRydWUsICAgIC8vIEJvb2xlYW4sIGNvdmVyIGlmIGZpbGUgZXhpc3RzXG4gICAgZmlsdGVyOiB0cnVlLCAgIC8vIEJvb2xlYW4gfCBGdW5jdGlvbiwgZmlsZSBmaWx0ZXJcbiAgfVxuKi9cbmZ1bmN0aW9uIGNvcHlkaXJTeW5jKGZyb20sIHRvLCBvcHRpb25zPykge1xuICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdmdW5jdGlvbicpIHtcbiAgICBvcHRpb25zID0ge1xuICAgICAgZmlsdGVyOiBvcHRpb25zXG4gICAgfTtcbiAgfVxuICBpZih0eXBlb2Ygb3B0aW9ucyA9PT0gJ3VuZGVmaW5lZCcpIG9wdGlvbnMgPSB7fTtcbiAgaWYodHlwZW9mIG9wdGlvbnMuY292ZXIgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgb3B0aW9ucy5jb3ZlciA9IHRydWU7XG4gIH1cbiAgb3B0aW9ucy5maWx0ZXIgPSB0eXBlb2Ygb3B0aW9ucy5maWx0ZXIgPT09ICdmdW5jdGlvbicgPyBvcHRpb25zLmZpbHRlciA6IGZ1bmN0aW9uKHN0YXRlLCBmaWxlcGF0aCwgZmlsZW5hbWUpIHtcbiAgICByZXR1cm4gb3B0aW9ucy5maWx0ZXI7XG4gIH07XG4gIHZhciBzdGF0cyA9IGZzLmxzdGF0U3luYyhmcm9tKTtcbiAgdmFyIHN0YXRzbmFtZSA9IHN0YXRzLmlzRGlyZWN0b3J5KCkgPyAnZGlyZWN0b3J5JyA6XG4gICAgc3RhdHMuaXNGaWxlKCkgPyAnZmlsZScgOlxuICAgICAgc3RhdHMuaXNTeW1ib2xpY0xpbmsoKSA/ICdzeW1ib2xpY0xpbmsnIDpcbiAgICAgICcnO1xuICB2YXIgdmFsaWQgPSBvcHRpb25zLmZpbHRlcihzdGF0c25hbWUsIGZyb20sIHBhdGguZGlybmFtZShmcm9tKSwgcGF0aC5iYXNlbmFtZShmcm9tKSk7XG5cbiAgaWYgKHN0YXRzbmFtZSA9PT0gJ2RpcmVjdG9yeScgfHwgc3RhdHNuYW1lID09PSAnc3ltYm9saWNMaW5rJykge1xuICAgIC8vIERpcmVjdG9yeSBvciBTeW1ib2xpY0xpbmtcbiAgICBpZih2YWxpZCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgZnMuc3RhdFN5bmModG8pO1xuICAgICAgfSBjYXRjaChlcnIpIHtcbiAgICAgICAgaWYoZXJyLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICAgICAgZnMubWtkaXJTeW5jKHRvKTtcbiAgICAgICAgICBvcHRpb25zLmRlYnVnICYmIGNvbnNvbGUubG9nKCc+PiAnICsgdG8pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV3cml0ZVN5bmModG8sIG9wdGlvbnMsIHN0YXRzKTtcbiAgICAgIGlmIChzdGF0c25hbWUgIT0gJ3N5bWJvbGljTGluaycpXG4gICAgICAgIGxpc3REaXJlY3RvcnlTeW5jKGZyb20sIHRvLCBvcHRpb25zKTtcbiAgICB9XG4gIH0gZWxzZSBpZihzdGF0cy5pc0ZpbGUoKSkge1xuICAgIC8vIEZpbGVcbiAgICBpZih2YWxpZCkge1xuICAgICAgaWYob3B0aW9ucy5jb3Zlcikge1xuICAgICAgICB3cml0ZUZpbGVTeW5jKGZyb20sIHRvLCBvcHRpb25zLCBzdGF0cyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGZzLnN0YXRTeW5jKHRvKTtcbiAgICAgICAgfSBjYXRjaChlcnIpIHtcbiAgICAgICAgICBpZihlcnIuY29kZSA9PT0gJ0VOT0VOVCcpIHtcbiAgICAgICAgICAgIHdyaXRlRmlsZVN5bmMoZnJvbSwgdG8sIG9wdGlvbnMsIHN0YXRzKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3N0YXRzIGludmFsaWQ6ICcrIGZyb20pO1xuICB9XG59O1xuXG5mdW5jdGlvbiBsaXN0RGlyZWN0b3J5U3luYyhmcm9tLCB0bywgb3B0aW9ucykge1xuICB2YXIgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhmcm9tKTtcbiAgY29weUZyb21BcnJheVN5bmMoZmlsZXMsIGZyb20sIHRvLCBvcHRpb25zKTtcbn1cblxuZnVuY3Rpb24gY29weUZyb21BcnJheVN5bmMoZmlsZXMsIGZyb20sIHRvLCBvcHRpb25zKSB7XG4gIGlmKGZpbGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHRydWU7XG4gIHZhciBmID0gZmlsZXMuc2hpZnQoKTtcbiAgY29weWRpclN5bmMocGF0aC5qb2luKGZyb20sIGYpLCBwYXRoLmpvaW4odG8sIGYpLCBvcHRpb25zKTtcbiAgY29weUZyb21BcnJheVN5bmMoZmlsZXMsIGZyb20sIHRvLCBvcHRpb25zKTtcbn1cblxuZnVuY3Rpb24gd3JpdGVGaWxlU3luYyhmcm9tLCB0bywgb3B0aW9ucywgc3RhdHMpIHtcbiAgZnMud3JpdGVGaWxlU3luYyh0bywgZnMucmVhZEZpbGVTeW5jKGZyb20sICdiaW5hcnknKSwgJ2JpbmFyeScpO1xuICBvcHRpb25zLmRlYnVnICYmIGNvbnNvbGUubG9nKCc+PiAnICsgdG8pO1xuICByZXdyaXRlU3luYyh0bywgb3B0aW9ucywgc3RhdHMpO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlU3luYyhmLCBvcHRpb25zLCBzdGF0cywgY2FsbGJhY2s/KSB7XG4gIGlmKG9wdGlvbnMuY292ZXIpIHtcbiAgICB2YXIgbW9kZSA9IG9wdGlvbnMubW9kZSA9PT0gdHJ1ZSA/IHN0YXRzLm1vZGUgOiBvcHRpb25zLm1vZGU7XG4gICAgdmFyIHV0aW1lcyA9IG9wdGlvbnMudXRpbWVzID09PSB0cnVlID8ge1xuICAgICAgYXRpbWU6IHN0YXRzLmF0aW1lLFxuICAgICAgbXRpbWU6IHN0YXRzLm10aW1lXG4gICAgfSA6IG9wdGlvbnMudXRpbWVzO1xuICAgIG1vZGUgJiYgZnMuY2htb2RTeW5jKGYsIG1vZGUpO1xuICAgIHV0aW1lcyAmJiBmcy51dGltZXNTeW5jKGYsIHV0aW1lcy5hdGltZSwgdXRpbWVzLm10aW1lKTtcbiAgfVxuICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY29weWRpclN5bmM7XG4iXX0=
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _util = _interopRequireDefault(require("util"));

var _schema = _interopRequireDefault(require("../API/schema"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */

/**
 * Validator of configured file / commander options.
 */
var Config = {
  _errMsgs: {
    'require': '"%s" is required',
    'type': 'Expect "%s" to be a typeof %s, but now is %s',
    'regex': 'Verify "%s" with regex failed, %s',
    'max': 'The maximum of "%s" is %s, but now is %s',
    'min': 'The minimum of "%s" is %s, but now is %s'
  },

  /**
   * Schema definition.
   * @returns {exports|*}
   */
  get schema() {
    // Cache.
    if (this._schema) {
      return this._schema;
    } // Render aliases.


    this._schema = _schema["default"];

    for (var k in this._schema) {
      if (k.indexOf('\\') > 0) {
        continue;
      }

      var aliases = [k.split('_').map(function (n, i) {
        if (i != 0 && n && n.length > 1) {
          return n[0].toUpperCase() + n.slice(1);
        }

        return n;
      }).join('')];

      if (this._schema[k].alias && Array.isArray(this._schema[k].alias)) {
        // If multiple aliases, merge
        this._schema[k].alias.forEach(function (alias) {
          aliases.splice(0, 0, alias);
        });
      } else if (this._schema[k].alias) aliases.splice(0, 0, this._schema[k].alias);

      this._schema[k].alias = aliases;
    }

    return this._schema;
  },

  /**
   * Filter / Alias options
   */
  filterOptions: function filterOptions(cmd) {
    var conf = {};
    var schema = this.schema;

    for (var key in schema) {
      var aliases = schema[key].alias;
      aliases && aliases.forEach(function (alias) {
        if (typeof cmd[alias] !== 'undefined') {
          conf[key] || (conf[key] = cmd[alias]);
        }
      });
    }

    return conf;
  },

  /**
   * Verify JSON configurations.
   * @param {Object} json
   * @returns {{errors: Array, config: {}}}
   */
  validateJSON: function validateJSON(json) {
    // clone config
    var conf = _util["default"].inherits({}, json),
        res = {};

    this._errors = [];
    var regexKeys = {},
        defines = this.schema;

    for (var sk in defines) {
      // Pick up RegExp keys.
      if (sk.indexOf('\\') >= 0) {
        regexKeys[sk] = false;
        continue;
      }

      var aliases = defines[sk].alias;
      aliases && aliases.forEach(function (alias) {
        conf[sk] || (conf[sk] = json[alias]);
      });
      var val = conf[sk];
      delete conf[sk]; // Validate key-value pairs.

      if (val === undefined || val === null || (val = this._valid(sk, val)) === null) {
        // If value is not defined
        // Set default value (via schema.json)
        if (typeof defines[sk]["default"] !== 'undefined') res[sk] = defines[sk]["default"];
        continue;
      } //console.log(sk, val, val === null, val === undefined);


      res[sk] = val;
    } // Validate RegExp values.


    var hasRegexKey = false;

    for (var k in regexKeys) {
      hasRegexKey = true;
      regexKeys[k] = new RegExp(k);
    }

    if (hasRegexKey) {
      for (var k in conf) {
        for (var rk in regexKeys) {
          if (regexKeys[rk].test(k)) if (this._valid(k, conf[k], defines[rk])) {
            res[k] = conf[k];
            delete conf[k];
          }
        }
      }
    }

    return {
      errors: this._errors,
      config: res
    };
  },

  /**
   * Validate key-value pairs by specific schema
   * @param {String} key
   * @param {Mixed} value
   * @param {Object} sch
   * @returns {*}
   * @private
   */
  _valid: function _valid(key, value, sch) {
    var sch = sch || this.schema[key],
        scht = typeof sch.type == 'string' ? [sch.type] : sch.type; // Required value.

    var undef = typeof value == 'undefined';

    if (this._error(sch.require && undef, 'require', key)) {
      return null;
    } // If undefined, make a break.


    if (undef) {
      return null;
    } // Wrap schema types.


    scht = scht.map(function (t) {
      return '[object ' + t[0].toUpperCase() + t.slice(1) + ']';
    }); // Typeof value.

    var type = Object.prototype.toString.call(value),
        nt = '[object Number]'; // Auto parse Number

    if (type != '[object Boolean]' && scht.indexOf(nt) >= 0 && !isNaN(value)) {
      value = parseFloat(value);
      type = nt;
    } // Verify types.


    if (this._error(!~scht.indexOf(type), 'type', key, scht.join(' / '), type)) {
      return null;
    } // Verify RegExp if exists.


    if (this._error(type == '[object String]' && sch.regex && !new RegExp(sch.regex).test(value), 'regex', key, sch.desc || 'should match ' + sch.regex)) {
      return null;
    } // Verify maximum / minimum of Number value.


    if (type == '[object Number]') {
      if (this._error(typeof sch.max != 'undefined' && value > sch.max, 'max', key, sch.max, value)) {
        return null;
      }

      if (this._error(typeof sch.min != 'undefined' && value < sch.min, 'min', key, sch.min, value)) {
        return null;
      }
    } // If first type is Array, but current is String, try to split them.


    if (scht.length > 1 && type != scht[0] && type == '[object String]') {
      if (scht[0] == '[object Array]') {
        // unfortunately, js does not support lookahead RegExp (/(?<!\\)\s+/) now (until next ver).
        value = value.split(/([\w\-]+\="[^"]*")|([\w\-]+\='[^']*')|"([^"]*)"|'([^']*)'|\s/).filter(function (v) {
          return v && v.trim();
        });
      }
    } // Custom types: sbyte && stime.


    if (sch.ext_type && type == '[object String]' && value.length >= 2) {
      var seed = {
        'sbyte': {
          'G': 1024 * 1024 * 1024,
          'M': 1024 * 1024,
          'K': 1024
        },
        'stime': {
          'h': 60 * 60 * 1000,
          'm': 60 * 1000,
          's': 1000
        }
      }[sch.ext_type];

      if (seed) {
        value = parseFloat(value.slice(0, -1)) * seed[value.slice(-1)];
      }
    }

    return value;
  },

  /**
   * Wrap errors.
   * @param {Boolean} possible A value indicates whether it is an error or not.
   * @param {String} type
   * @returns {*}
   * @private
   */
  _error: function _error(possible, type) {
    if (possible) {
      var args = Array.prototype.slice.call(arguments);
      args.splice(0, 2, this._errMsgs[type]);
      this._errors && this._errors.push(_util["default"].format.apply(null, args));
    }

    return possible;
  }
};
var _default = Config;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90b29scy9Db25maWcudHMiXSwibmFtZXMiOlsiQ29uZmlnIiwiX2Vyck1zZ3MiLCJzY2hlbWEiLCJfc2NoZW1hIiwiayIsImluZGV4T2YiLCJhbGlhc2VzIiwic3BsaXQiLCJtYXAiLCJuIiwiaSIsImxlbmd0aCIsInRvVXBwZXJDYXNlIiwic2xpY2UiLCJqb2luIiwiYWxpYXMiLCJBcnJheSIsImlzQXJyYXkiLCJmb3JFYWNoIiwic3BsaWNlIiwiZmlsdGVyT3B0aW9ucyIsImNtZCIsImNvbmYiLCJrZXkiLCJ2YWxpZGF0ZUpTT04iLCJqc29uIiwidXRpbCIsImluaGVyaXRzIiwicmVzIiwiX2Vycm9ycyIsInJlZ2V4S2V5cyIsImRlZmluZXMiLCJzayIsInZhbCIsInVuZGVmaW5lZCIsIl92YWxpZCIsImhhc1JlZ2V4S2V5IiwiUmVnRXhwIiwicmsiLCJ0ZXN0IiwiZXJyb3JzIiwiY29uZmlnIiwidmFsdWUiLCJzY2giLCJzY2h0IiwidHlwZSIsInVuZGVmIiwiX2Vycm9yIiwicmVxdWlyZSIsInQiLCJPYmplY3QiLCJwcm90b3R5cGUiLCJ0b1N0cmluZyIsImNhbGwiLCJudCIsImlzTmFOIiwicGFyc2VGbG9hdCIsInJlZ2V4IiwiZGVzYyIsIm1heCIsIm1pbiIsImZpbHRlciIsInYiLCJ0cmltIiwiZXh0X3R5cGUiLCJzZWVkIiwicG9zc2libGUiLCJhcmdzIiwiYXJndW1lbnRzIiwicHVzaCIsImZvcm1hdCIsImFwcGx5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBS0E7O0FBQ0E7Ozs7QUFOQTs7Ozs7O0FBUUE7OztBQUdBLElBQU1BLE1BQU0sR0FBRztBQUNiQyxFQUFBQSxRQUFRLEVBQUU7QUFDUixlQUFXLGtCQURIO0FBRVIsWUFBVyw4Q0FGSDtBQUdSLGFBQVcsbUNBSEg7QUFJUixXQUFXLDBDQUpIO0FBS1IsV0FBVztBQUxILEdBREc7O0FBUWI7Ozs7QUFJQSxNQUFJQyxNQUFKLEdBQVk7QUFDVjtBQUNBLFFBQUksS0FBS0Ms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QyxJQUFiLENBQWtCM0MsaUJBQUs0QyxNQUFMLENBQVlDLEtBQVosQ0FBa0IsSUFBbEIsRUFBd0JKLElBQXhCLENBQWxCLENBQWhCO0FBQ0Q7O0FBQ0QsV0FBT0QsUUFBUDtBQUNEO0FBM09ZLENBQWY7ZUE4T2VsRSxNIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgMjAxMyB0aGUgUE0yIHByb2plY3QgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgbGljZW5zZSB0aGF0XG4gKiBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS5cbiAqL1xuaW1wb3J0IHV0aWwgZnJvbSAndXRpbCc7XG5pbXBvcnQgc2NoZW1hIGZyb20gJy4uL0FQSS9zY2hlbWEnO1xuXG4vKipcbiAqIFZhbGlkYXRvciBvZiBjb25maWd1cmVkIGZpbGUgLyBjb21tYW5kZXIgb3B0aW9ucy5cbiAqL1xuY29uc3QgQ29uZmlnID0ge1xuICBfZXJyTXNnczoge1xuICAgICdyZXF1aXJlJzogJ1wiJXNcIiBpcyByZXF1aXJlZCcsXG4gICAgJ3R5cGUnICAgOiAnRXhwZWN0IFwiJXNcIiB0byBiZSBhIHR5cGVvZiAlcywgYnV0IG5vdyBpcyAlcycsXG4gICAgJ3JlZ2V4JyAgOiAnVmVyaWZ5IFwiJXNcIiB3aXRoIHJlZ2V4IGZhaWxlZCwgJXMnLFxuICAgICdtYXgnICAgIDogJ1RoZSBtYXhpbXVtIG9mIFwiJXNcIiBpcyAlcywgYnV0IG5vdyBpcyAlcycsXG4gICAgJ21pbicgICAgOiAnVGhlIG1pbmltdW0gb2YgXCIlc1wiIGlzICVzLCBidXQgbm93IGlzICVzJ1xuICB9LFxuICAvKipcbiAgICogU2NoZW1hIGRlZmluaXRpb24uXG4gICAqIEByZXR1cm5zIHtleHBvcnRzfCp9XG4gICAqL1xuICBnZXQgc2NoZW1hKCl7XG4gICAgLy8gQ2FjaGUuXG4gICAgaWYgKHRoaXMuX3NjaGVtYSkge1xuICAgICAgcmV0dXJuIHRoaXMuX3NjaGVtYTtcbiAgICB9XG4gICAgLy8gUmVuZGVyIGFsaWFzZXMuXG4gICAgdGhpcy5fc2NoZW1hID0gc2NoZW1hO1xuICAgIGZvciAodmFyIGsgaW4gdGhpcy5fc2NoZW1hKSB7XG4gICAgICBpZiAoay5pbmRleE9mKCdcXFxcJykgPiAwKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgdmFyIGFsaWFzZXMgPSBbXG4gICAgICAgIGsuc3BsaXQoJ18nKS5tYXAoZnVuY3Rpb24obiwgaSl7XG4gICAgICAgICAgaWYgKGkgIT0gMCAmJiBuICYmIG4ubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgcmV0dXJuIG5bMF0udG9VcHBlckNhc2UoKSArIG4uc2xpY2UoMSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBuO1xuICAgICAgICB9KS5qb2luKCcnKVxuICAgICAgXTtcblxuICAgICAgaWYgKHRoaXMuX3NjaGVtYVtrXS5hbGlhcyAmJiBBcnJheS5pc0FycmF5KHRoaXMuX3NjaGVtYVtrXS5hbGlhcykpIHtcbiAgICAgICAgLy8gSWYgbXVsdGlwbGUgYWxpYXNlcywgbWVyZ2VcbiAgICAgICAgdGhpcy5fc2NoZW1hW2tdLmFsaWFzLmZvckVhY2goZnVuY3Rpb24oYWxpYXMpIHtcbiAgICAgICAgICBhbGlhc2VzLnNwbGljZSgwLCAwLCBhbGlhcyk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgZWxzZSBpZiAodGhpcy5fc2NoZW1hW2tdLmFsaWFzKVxuICAgICAgICBhbGlhc2VzLnNwbGljZSgwLCAwLCB0aGlzLl9zY2hlbWFba10uYWxpYXMpO1xuXG4gICAgICB0aGlzLl9zY2hlbWFba10uYWxpYXMgPSBhbGlhc2VzO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fc2NoZW1hO1xuICB9LFxuXG4gIC8qKlxuICAgKiBGaWx0ZXIgLyBBbGlhcyBvcHRpb25zXG4gICAqL1xuICBmaWx0ZXJPcHRpb25zOiBmdW5jdGlvbihjbWQpIHtcbiAgICB2YXIgY29uZiA9IHt9O1xuICAgIHZhciBzY2hlbWEgPSB0aGlzLnNjaGVtYTtcblxuICAgIGZvciAodmFyIGtleSBpbiBzY2hlbWEpIHtcbiAgICAgIHZhciBhbGlhc2VzID0gc2NoZW1hW2tleV0uYWxpYXM7XG4gICAgICBhbGlhc2VzICYmIGFsaWFzZXMuZm9yRWFjaChmdW5jdGlvbihhbGlhcyl7XG4gICAgICAgIGlmICh0eXBlb2YoY21kW2FsaWFzXSkgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgY29uZltrZXldIHx8IChjb25mW2tleV0gPSBjbWRbYWxpYXNdKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbmY7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFZlcmlmeSBKU09OIGNvbmZpZ3VyYXRpb25zLlxuICAgKiBAcGFyYW0ge09iamVjdH0ganNvblxuICAgKiBAcmV0dXJucyB7e2Vycm9yczogQXJyYXksIGNvbmZpZzoge319fVxuICAgKi9cbiAgdmFsaWRhdGVKU09OOiBmdW5jdGlvbihqc29uKXtcbiAgICAvLyBjbG9uZSBjb25maWdcbiAgICB2YXIgY29uZjogYW55ID0gdXRpbC5pbmhlcml0cyh7fSwganNvbiksXG4gICAgICAgIHJlcyA9IHt9O1xuICAgIHRoaXMuX2Vycm9ycyA9IFtdO1xuXG4gICAgdmFyIHJlZ2V4S2V5cyA9IHt9LCBkZWZpbmVzID0gdGhpcy5zY2hlbWE7XG5cbiAgICBmb3IgKHZhciBzayBpbiBkZWZpbmVzKSB7XG4gICAgICAvLyBQaWNrIHVwIFJlZ0V4cCBrZXlzLlxuICAgICAgaWYgKHNrLmluZGV4T2YoJ1xcXFwnKSA+PSAwKSB7XG4gICAgICAgIHJlZ2V4S2V5c1tza10gPSBmYWxzZTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIHZhciBhbGlhc2VzID0gZGVmaW5lc1tza10uYWxpYXM7XG5cbiAgICAgIGFsaWFzZXMgJiYgYWxpYXNlcy5mb3JFYWNoKGZ1bmN0aW9uKGFsaWFzKXtcbiAgICAgICAgY29uZltza10gfHwgKGNvbmZbc2tdID0ganNvblthbGlhc10pO1xuICAgICAgfSlcblxuICAgICAgdmFyIHZhbCA9IGNvbmZbc2tdO1xuICAgICAgZGVsZXRlIGNvbmZbc2tdO1xuXG4gICAgICAvLyBWYWxpZGF0ZSBrZXktdmFsdWUgcGFpcnMuXG4gICAgICBpZiAodmFsID09PSB1bmRlZmluZWQgfHxcbiAgICAgICAgICB2YWwgPT09IG51bGwgfHxcbiAgICAgICAgICAoKHZhbCA9IHRoaXMuX3ZhbGlkKHNrLCB2YWwpKSA9PT0gbnVsbCkpIHtcblxuICAgICAgICAvLyBJZiB2YWx1ZSBpcyBub3QgZGVmaW5lZFxuICAgICAgICAvLyBTZXQgZGVmYXVsdCB2YWx1ZSAodmlhIHNjaGVtYS5qc29uKVxuICAgICAgICBpZiAodHlwZW9mKGRlZmluZXNbc2tdLmRlZmF1bHQpICE9PSAndW5kZWZpbmVkJylcbiAgICAgICAgICByZXNbc2tdID0gZGVmaW5lc1tza10uZGVmYXVsdDtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICAvL2NvbnNvbGUubG9nKHNrLCB2YWwsIHZhbCA9PT0gbnVsbCwgdmFsID09PSB1bmRlZmluZWQpO1xuICAgICAgcmVzW3NrXSA9IHZhbDtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBSZWdFeHAgdmFsdWVzLlxuICAgIHZhciBoYXNSZWdleEtleSA9IGZhbHNlO1xuICAgIGZvciAodmFyIGsgaW4gcmVnZXhLZXlzKSB7XG4gICAgICBoYXNSZWdleEtleSA9IHRydWU7XG4gICAgICByZWdleEtleXNba10gPSBuZXcgUmVnRXhwKGspO1xuICAgIH1cbiAgICBpZiAoaGFzUmVnZXhLZXkpIHtcbiAgICAgIGZvciAodmFyIGsgaW4gY29uZikge1xuICAgICAgICBmb3IgKHZhciByayBpbiByZWdleEtleXMpIHtcbiAgICAgICAgICBpZiAocmVnZXhLZXlzW3JrXS50ZXN0KGspKVxuICAgICAgICAgICAgaWYgKHRoaXMuX3ZhbGlkKGssIGNvbmZba10sIGRlZmluZXNbcmtdKSkge1xuICAgICAgICAgICAgICByZXNba10gPSBjb25mW2tdO1xuICAgICAgICAgICAgICBkZWxldGUgY29uZltrXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7ZXJyb3JzOiB0aGlzLl9lcnJvcnMsIGNvbmZpZzogcmVzfTtcbiAgfSxcblxuICAvKipcbiAgICogVmFsaWRhdGUga2V5LXZhbHVlIHBhaXJzIGJ5IHNwZWNpZmljIHNjaGVtYVxuICAgKiBAcGFyYW0ge1N0cmluZ30ga2V5XG4gICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hcbiAgICogQHJldHVybnMgeyp9XG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBfdmFsaWQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUsIHNjaCl7XG4gICAgdmFyIHNjaCA9IHNjaCB8fCB0aGlzLnNjaGVtYVtrZXldLFxuICAgICAgICBzY2h0ID0gdHlwZW9mIHNjaC50eXBlID09ICdzdHJpbmcnID8gW3NjaC50eXBlXSA6IHNjaC50eXBlO1xuXG4gICAgLy8gUmVxdWlyZWQgdmFsdWUuXG4gICAgdmFyIHVuZGVmID0gdHlwZW9mIHZhbHVlID09ICd1bmRlZmluZWQnO1xuICAgIGlmKHRoaXMuX2Vycm9yKHNjaC5yZXF1aXJlICYmIHVuZGVmLCAncmVxdWlyZScsIGtleSkpe1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gSWYgdW5kZWZpbmVkLCBtYWtlIGEgYnJlYWsuXG4gICAgaWYgKHVuZGVmKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBXcmFwIHNjaGVtYSB0eXBlcy5cbiAgICBzY2h0ID0gc2NodC5tYXAoZnVuY3Rpb24odCl7XG4gICAgICByZXR1cm4gJ1tvYmplY3QgJyArIHRbMF0udG9VcHBlckNhc2UoKSArIHQuc2xpY2UoMSkgKyAnXSdcbiAgICB9KTtcblxuICAgIC8vIFR5cGVvZiB2YWx1ZS5cbiAgICB2YXIgdHlwZSA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksIG50ID0gJ1tvYmplY3QgTnVtYmVyXSc7XG5cbiAgICAvLyBBdXRvIHBhcnNlIE51bWJlclxuICAgIGlmICh0eXBlICE9ICdbb2JqZWN0IEJvb2xlYW5dJyAmJiBzY2h0LmluZGV4T2YobnQpID49IDAgJiYgIWlzTmFOKHZhbHVlKSkge1xuICAgICAgdmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTtcbiAgICAgIHR5cGUgPSBudDtcbiAgICB9XG5cbiAgICAvLyBWZXJpZnkgdHlwZXMuXG4gICAgaWYgKHRoaXMuX2Vycm9yKCF+c2NodC5pbmRleE9mKHR5cGUpLCAndHlwZScsIGtleSwgc2NodC5qb2luKCcgLyAnKSwgdHlwZSkpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8vIFZlcmlmeSBSZWdFeHAgaWYgZXhpc3RzLlxuICAgIGlmICh0aGlzLl9lcnJvcih0eXBlID09ICdbb2JqZWN0IFN0cmluZ10nICYmIHNjaC5yZWdleCAmJiAhKG5ldyBSZWdFeHAoc2NoLnJlZ2V4KSkudGVzdCh2YWx1ZSksXG4gICAgICAgICdyZWdleCcsIGtleSwgc2NoLmRlc2MgfHwgKCdzaG91bGQgbWF0Y2ggJyArIHNjaC5yZWdleCkpKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBWZXJpZnkgbWF4aW11bSAvIG1pbmltdW0gb2YgTnVtYmVyIHZhbHVlLlxuICAgIGlmICh0eXBlID09ICdbb2JqZWN0IE51bWJlcl0nKSB7XG4gICAgICBpZiAodGhpcy5fZXJyb3IodHlwZW9mIHNjaC5tYXggIT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgPiBzY2gubWF4LCAnbWF4Jywga2V5LCBzY2gubWF4LCB2YWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fZXJyb3IodHlwZW9mIHNjaC5taW4gIT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgPCBzY2gubWluLCAnbWluJywga2V5LCBzY2gubWluLCB2YWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gSWYgZmlyc3QgdHlwZSBpcyBBcnJheSwgYnV0IGN1cnJlbnQgaXMgU3RyaW5nLCB0cnkgdG8gc3BsaXQgdGhlbS5cbiAgICBpZihzY2h0Lmxlbmd0aCA+IDEgJiYgdHlwZSAhPSBzY2h0WzBdICYmIHR5cGUgPT0gJ1tvYmplY3QgU3RyaW5nXScpe1xuICAgICAgaWYoc2NodFswXSA9PSAnW29iamVjdCBBcnJheV0nKSB7XG4gICAgICAgIC8vIHVuZm9ydHVuYXRlbHksIGpzIGRvZXMgbm90IHN1cHBvcnQgbG9va2FoZWFkIFJlZ0V4cCAoLyg/PCFcXFxcKVxccysvKSBub3cgKHVudGlsIG5leHQgdmVyKS5cbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5zcGxpdCgvKFtcXHdcXC1dK1xcPVwiW15cIl0qXCIpfChbXFx3XFwtXStcXD0nW14nXSonKXxcIihbXlwiXSopXCJ8JyhbXiddKiknfFxccy8pXG4gICAgICAgICAgLmZpbHRlcihmdW5jdGlvbih2KXtcbiAgICAgICAgICAgIHJldHVybiB2ICYmIHYudHJpbSgpO1xuICAgICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEN1c3RvbSB0eXBlczogc2J5dGUgJiYgc3RpbWUuXG4gICAgaWYoc2NoLmV4dF90eXBlICYmIHR5cGUgPT0gJ1tvYmplY3QgU3RyaW5nXScgJiYgdmFsdWUubGVuZ3RoID49IDIpIHtcbiAgICAgIHZhciBzZWVkID0ge1xuICAgICAgICAnc2J5dGUnOiB7XG4gICAgICAgICAgJ0cnOiAxMDI0ICogMTAyNCAqIDEwMjQsXG4gICAgICAgICAgJ00nOiAxMDI0ICogMTAyNCxcbiAgICAgICAgICAnSyc6IDEwMjRcbiAgICAgICAgfSxcbiAgICAgICAgJ3N0aW1lJzoge1xuICAgICAgICAgICdoJzogNjAgKiA2MCAqIDEwMDAsXG4gICAgICAgICAgJ20nOiA2MCAqIDEwMDAsXG4gICAgICAgICAgJ3MnOiAxMDAwXG4gICAgICAgIH1cbiAgICAgIH1bc2NoLmV4dF90eXBlXTtcblxuICAgICAgaWYoc2VlZCl7XG4gICAgICAgIHZhbHVlID0gcGFyc2VGbG9hdCh2YWx1ZS5zbGljZSgwLCAtMSkpICogKHNlZWRbdmFsdWUuc2xpY2UoLTEpXSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbiAgfSxcblxuICAvKipcbiAgICogV3JhcCBlcnJvcnMuXG4gICAqIEBwYXJhbSB7Qm9vbGVhbn0gcG9zc2libGUgQSB2YWx1ZSBpbmRpY2F0ZXMgd2hldGhlciBpdCBpcyBhbiBlcnJvciBvciBub3QuXG4gICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlXG4gICAqIEByZXR1cm5zIHsqfVxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgX2Vycm9yOiBmdW5jdGlvbihwb3NzaWJsZSwgdHlwZSl7XG4gICAgaWYgKHBvc3NpYmxlKSB7XG4gICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7XG4gICAgICBhcmdzLnNwbGljZSgwLCAyLCB0aGlzLl9lcnJNc2dzW3R5cGVdKTtcbiAgICAgIHRoaXMuX2Vycm9ycyAmJiB0aGlzLl9lcnJvcnMucHVzaCh1dGlsLmZvcm1hdC5hcHBseShudWxsLCBhcmdzIGFzIGFueSkpO1xuICAgIH1cbiAgICByZXR1cm4gcG9zc2libGU7XG4gIH0sXG59O1xuXG5leHBvcnQgZGVmYXVsdCBDb25maWc7XG4iXX0=
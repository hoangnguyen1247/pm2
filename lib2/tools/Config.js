"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _util = _interopRequireDefault(require("util"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */

/**
 * Validator of configured file / commander options.
 */
var Config = {
  _errMsgs: {
    'require': '"%s" is required',
    'type': 'Expect "%s" to be a typeof %s, but now is %s',
    'regex': 'Verify "%s" with regex failed, %s',
    'max': 'The maximum of "%s" is %s, but now is %s',
    'min': 'The minimum of "%s" is %s, but now is %s'
  },

  /**
   * Schema definition.
   * @returns {exports|*}
   */
  get schema() {
    // Cache.
    if (this._schema) {
      return this._schema;
    } // Render aliases.


    this._schema = require("../API/schema");

    for (var k in this._schema) {
      if (k.indexOf('\\') > 0) {
        continue;
      }

      var aliases = [k.split('_').map(function (n, i) {
        if (i != 0 && n && n.length > 1) {
          return n[0].toUpperCase() + n.slice(1);
        }

        return n;
      }).join('')];

      if (this._schema[k].alias && Array.isArray(this._schema[k].alias)) {
        // If multiple aliases, merge
        this._schema[k].alias.forEach(function (alias) {
          aliases.splice(0, 0, alias);
        });
      } else if (this._schema[k].alias) aliases.splice(0, 0, this._schema[k].alias);

      this._schema[k].alias = aliases;
    }

    return this._schema;
  },

  /**
   * Filter / Alias options
   */
  filterOptions: function filterOptions(cmd) {
    var conf = {};
    var schema = this.schema;

    for (var key in schema) {
      var aliases = schema[key].alias;
      aliases && aliases.forEach(function (alias) {
        if (typeof cmd[alias] !== 'undefined') {
          conf[key] || (conf[key] = cmd[alias]);
        }
      });
    }

    return conf;
  },

  /**
   * Verify JSON configurations.
   * @param {Object} json
   * @returns {{errors: Array, config: {}}}
   */
  validateJSON: function validateJSON(json) {
    // clone config
    var conf = _util["default"].inherits({}, json),
        res = {};

    this._errors = [];
    var regexKeys = {},
        defines = this.schema;

    for (var sk in defines) {
      // Pick up RegExp keys.
      if (sk.indexOf('\\') >= 0) {
        regexKeys[sk] = false;
        continue;
      }

      var aliases = defines[sk].alias;
      aliases && aliases.forEach(function (alias) {
        conf[sk] || (conf[sk] = json[alias]);
      });
      var val = conf[sk];
      delete conf[sk]; // Validate key-value pairs.

      if (val === undefined || val === null || (val = this._valid(sk, val)) === null) {
        // If value is not defined
        // Set default value (via schema.json)
        if (typeof defines[sk]["default"] !== 'undefined') res[sk] = defines[sk]["default"];
        continue;
      } //console.log(sk, val, val === null, val === undefined);


      res[sk] = val;
    } // Validate RegExp values.


    var hasRegexKey = false;

    for (var k in regexKeys) {
      hasRegexKey = true;
      regexKeys[k] = new RegExp(k);
    }

    if (hasRegexKey) {
      for (var k in conf) {
        for (var rk in regexKeys) {
          if (regexKeys[rk].test(k)) if (this._valid(k, conf[k], defines[rk])) {
            res[k] = conf[k];
            delete conf[k];
          }
        }
      }
    }

    return {
      errors: this._errors,
      config: res
    };
  },

  /**
   * Validate key-value pairs by specific schema
   * @param {String} key
   * @param {Mixed} value
   * @param {Object} sch
   * @returns {*}
   * @private
   */
  _valid: function _valid(key, value, sch) {
    var sch = sch || this.schema[key],
        scht = typeof sch.type == 'string' ? [sch.type] : sch.type; // Required value.

    var undef = typeof value == 'undefined';

    if (this._error(sch.require && undef, 'require', key)) {
      return null;
    } // If undefined, make a break.


    if (undef) {
      return null;
    } // Wrap schema types.


    scht = scht.map(function (t) {
      return '[object ' + t[0].toUpperCase() + t.slice(1) + ']';
    }); // Typeof value.

    var type = Object.prototype.toString.call(value),
        nt = '[object Number]'; // Auto parse Number

    if (type != '[object Boolean]' && scht.indexOf(nt) >= 0 && !isNaN(value)) {
      value = parseFloat(value);
      type = nt;
    } // Verify types.


    if (this._error(!~scht.indexOf(type), 'type', key, scht.join(' / '), type)) {
      return null;
    } // Verify RegExp if exists.


    if (this._error(type == '[object String]' && sch.regex && !new RegExp(sch.regex).test(value), 'regex', key, sch.desc || 'should match ' + sch.regex)) {
      return null;
    } // Verify maximum / minimum of Number value.


    if (type == '[object Number]') {
      if (this._error(typeof sch.max != 'undefined' && value > sch.max, 'max', key, sch.max, value)) {
        return null;
      }

      if (this._error(typeof sch.min != 'undefined' && value < sch.min, 'min', key, sch.min, value)) {
        return null;
      }
    } // If first type is Array, but current is String, try to split them.


    if (scht.length > 1 && type != scht[0] && type == '[object String]') {
      if (scht[0] == '[object Array]') {
        // unfortunately, js does not support lookahead RegExp (/(?<!\\)\s+/) now (until next ver).
        value = value.split(/([\w\-]+\="[^"]*")|([\w\-]+\='[^']*')|"([^"]*)"|'([^']*)'|\s/).filter(function (v) {
          return v && v.trim();
        });
      }
    } // Custom types: sbyte && stime.


    if (sch.ext_type && type == '[object String]' && value.length >= 2) {
      var seed = {
        'sbyte': {
          'G': 1024 * 1024 * 1024,
          'M': 1024 * 1024,
          'K': 1024
        },
        'stime': {
          'h': 60 * 60 * 1000,
          'm': 60 * 1000,
          's': 1000
        }
      }[sch.ext_type];

      if (seed) {
        value = parseFloat(value.slice(0, -1)) * seed[value.slice(-1)];
      }
    }

    return value;
  },

  /**
   * Wrap errors.
   * @param {Boolean} possible A value indicates whether it is an error or not.
   * @param {String} type
   * @returns {*}
   * @private
   */
  _error: function _error(possible, type) {
    if (possible) {
      var args = Array.prototype.slice.call(arguments);
      args.splice(0, 2, this._errMsgs[type]);
      this._errors && this._errors.push(_util["default"].format.apply(null, args));
    }

    return possible;
  }
};
var _default = Config;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90b29scy9Db25maWcudHMiXSwibmFtZXMiOlsiQ29uZmlnIiwiX2Vyck1zZ3MiLCJzY2hlbWEiLCJfc2NoZW1hIiwicmVxdWlyZSIsImsiLCJpbmRleE9mIiwiYWxpYXNlcyIsInNwbGl0IiwibWFwIiwibiIsImkiLCJsZW5ndGgiLCJ0b1VwcGVyQ2FzZSIsInNsaWNlIiwiam9pbiIsImFsaWFzIiwiQXJyYXkiLCJpc0FycmF5IiwiZm9yRWFjaCIsInNwbGljZSIsImZpbHRlck9wdGlvbnMiLCJjbWQiLCJjb25mIiwia2V5IiwidmFsaWRhdGVKU09OIiwianNvbiIsInV0aWwiLCJpbmhlcml0cyIsInJlcyIsIl9lcnJvcnMiLCJyZWdleEtleXMiLCJkZWZpbmVzIiwic2siLCJ2YWwiLCJ1bmRlZmluZWQiLCJfdmFsaWQiLCJoYXNSZWdleEtleSIsIlJlZ0V4cCIsInJrIiwidGVzdCIsImVycm9ycyIsImNvbmZpZyIsInZhbHVlIiwic2NoIiwic2NodCIsInR5cGUiLCJ1bmRlZiIsIl9lcnJvciIsInQiLCJPYmplY3QiLCJwcm90b3R5cGUiLCJ0b1N0cmluZyIsImNhbGwiLCJudCIsImlzTmFOIiwicGFyc2VGbG9hdCIsInJlZ2V4IiwiZGVzYyIsIm1heCIsIm1pbiIsImZpbHRlciIsInYiLCJ0cmltIiwiZXh0X3R5cGUiLCJzZWVkIiwicG9zc2libGUiLCJhcmdzIiwiYXJndW1lbnRzIiwicHVzaCIsImZvcm1hdCIsImFwcGx5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBS0E7Ozs7QUFMQTs7Ozs7O0FBT0E7OztBQUdBLElBQU1BLE1BQU0sR0FBRztBQUNiQyxFQUFBQSxRQUFRLEVBQUU7QUFDUixlQUFXLGtCQURIO0FBRVIsWUFBVyw4Q0FGSDtBQUdSLGFBQVcsbUNBSEg7QUFJUixXQUFXLDBDQUpIO0FBS1IsV0FBVztBQUxILEdBREc7O0FBUWI7Ozs7QUFJQSxNQUFJQyxNQUFKLEdBQVk7QUFDVjtBQUNBLFFBQUksS0FBS0MsT0FBVCxF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LElBQWIsQ0FBa0IxQyxpQkFBSzJDLE1BQUwsQ0FBWUMsS0FBWixDQUFrQixJQUFsQixFQUF3QkosSUFBeEIsQ0FBbEIsQ0FBaEI7QUFDRDs7QUFDRCxXQUFPRCxRQUFQO0FBQ0Q7QUEzT1ksQ0FBZjtlQThPZWxFLE0iLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29weXJpZ2h0IDIwMTMgdGhlIFBNMiBwcm9qZWN0IGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgbGljZW5zZSB0aGF0XHJcbiAqIGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLlxyXG4gKi9cclxuaW1wb3J0IHV0aWwgZnJvbSAndXRpbCc7XHJcblxyXG4vKipcclxuICogVmFsaWRhdG9yIG9mIGNvbmZpZ3VyZWQgZmlsZSAvIGNvbW1hbmRlciBvcHRpb25zLlxyXG4gKi9cclxuY29uc3QgQ29uZmlnID0ge1xyXG4gIF9lcnJNc2dzOiB7XHJcbiAgICAncmVxdWlyZSc6ICdcIiVzXCIgaXMgcmVxdWlyZWQnLFxyXG4gICAgJ3R5cGUnICAgOiAnRXhwZWN0IFwiJXNcIiB0byBiZSBhIHR5cGVvZiAlcywgYnV0IG5vdyBpcyAlcycsXHJcbiAgICAncmVnZXgnICA6ICdWZXJpZnkgXCIlc1wiIHdpdGggcmVnZXggZmFpbGVkLCAlcycsXHJcbiAgICAnbWF4JyAgICA6ICdUaGUgbWF4aW11bSBvZiBcIiVzXCIgaXMgJXMsIGJ1dCBub3cgaXMgJXMnLFxyXG4gICAgJ21pbicgICAgOiAnVGhlIG1pbmltdW0gb2YgXCIlc1wiIGlzICVzLCBidXQgbm93IGlzICVzJ1xyXG4gIH0sXHJcbiAgLyoqXHJcbiAgICogU2NoZW1hIGRlZmluaXRpb24uXHJcbiAgICogQHJldHVybnMge2V4cG9ydHN8Kn1cclxuICAgKi9cclxuICBnZXQgc2NoZW1hKCl7XHJcbiAgICAvLyBDYWNoZS5cclxuICAgIGlmICh0aGlzLl9zY2hlbWEpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuX3NjaGVtYTtcclxuICAgIH1cclxuICAgIC8vIFJlbmRlciBhbGlhc2VzLlxyXG4gICAgdGhpcy5fc2NoZW1hID0gcmVxdWlyZSgnLi4vQVBJL3NjaGVtYScpO1xyXG4gICAgZm9yICh2YXIgayBpbiB0aGlzLl9zY2hlbWEpIHtcclxuICAgICAgaWYgKGsuaW5kZXhPZignXFxcXCcpID4gMCkge1xyXG4gICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICB9XHJcbiAgICAgIHZhciBhbGlhc2VzID0gW1xyXG4gICAgICAgIGsuc3BsaXQoJ18nKS5tYXAoZnVuY3Rpb24obiwgaSl7XHJcbiAgICAgICAgICBpZiAoaSAhPSAwICYmIG4gJiYgbi5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuWzBdLnRvVXBwZXJDYXNlKCkgKyBuLnNsaWNlKDEpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIG47XHJcbiAgICAgICAgfSkuam9pbignJylcclxuICAgICAgXTtcclxuXHJcbiAgICAgIGlmICh0aGlzLl9zY2hlbWFba10uYWxpYXMgJiYgQXJyYXkuaXNBcnJheSh0aGlzLl9zY2hlbWFba10uYWxpYXMpKSB7XHJcbiAgICAgICAgLy8gSWYgbXVsdGlwbGUgYWxpYXNlcywgbWVyZ2VcclxuICAgICAgICB0aGlzLl9zY2hlbWFba10uYWxpYXMuZm9yRWFjaChmdW5jdGlvbihhbGlhcykge1xyXG4gICAgICAgICAgYWxpYXNlcy5zcGxpY2UoMCwgMCwgYWxpYXMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2UgaWYgKHRoaXMuX3NjaGVtYVtrXS5hbGlhcylcclxuICAgICAgICBhbGlhc2VzLnNwbGljZSgwLCAwLCB0aGlzLl9zY2hlbWFba10uYWxpYXMpO1xyXG5cclxuICAgICAgdGhpcy5fc2NoZW1hW2tdLmFsaWFzID0gYWxpYXNlcztcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLl9zY2hlbWE7XHJcbiAgfSxcclxuXHJcbiAgLyoqXHJcbiAgICogRmlsdGVyIC8gQWxpYXMgb3B0aW9uc1xyXG4gICAqL1xyXG4gIGZpbHRlck9wdGlvbnM6IGZ1bmN0aW9uKGNtZCkge1xyXG4gICAgdmFyIGNvbmYgPSB7fTtcclxuICAgIHZhciBzY2hlbWEgPSB0aGlzLnNjaGVtYTtcclxuXHJcbiAgICBmb3IgKHZhciBrZXkgaW4gc2NoZW1hKSB7XHJcbiAgICAgIHZhciBhbGlhc2VzID0gc2NoZW1hW2tleV0uYWxpYXM7XHJcbiAgICAgIGFsaWFzZXMgJiYgYWxpYXNlcy5mb3JFYWNoKGZ1bmN0aW9uKGFsaWFzKXtcclxuICAgICAgICBpZiAodHlwZW9mKGNtZFthbGlhc10pICE9PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgICAgY29uZltrZXldIHx8IChjb25mW2tleV0gPSBjbWRbYWxpYXNdKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBjb25mO1xyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIFZlcmlmeSBKU09OIGNvbmZpZ3VyYXRpb25zLlxyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBqc29uXHJcbiAgICogQHJldHVybnMge3tlcnJvcnM6IEFycmF5LCBjb25maWc6IHt9fX1cclxuICAgKi9cclxuICB2YWxpZGF0ZUpTT046IGZ1bmN0aW9uKGpzb24pe1xyXG4gICAgLy8gY2xvbmUgY29uZmlnXHJcbiAgICB2YXIgY29uZjogYW55ID0gdXRpbC5pbmhlcml0cyh7fSwganNvbiksXHJcbiAgICAgICAgcmVzID0ge307XHJcbiAgICB0aGlzLl9lcnJvcnMgPSBbXTtcclxuXHJcbiAgICB2YXIgcmVnZXhLZXlzID0ge30sIGRlZmluZXMgPSB0aGlzLnNjaGVtYTtcclxuXHJcbiAgICBmb3IgKHZhciBzayBpbiBkZWZpbmVzKSB7XHJcbiAgICAgIC8vIFBpY2sgdXAgUmVnRXhwIGtleXMuXHJcbiAgICAgIGlmIChzay5pbmRleE9mKCdcXFxcJykgPj0gMCkge1xyXG4gICAgICAgIHJlZ2V4S2V5c1tza10gPSBmYWxzZTtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdmFyIGFsaWFzZXMgPSBkZWZpbmVzW3NrXS5hbGlhcztcclxuXHJcbiAgICAgIGFsaWFzZXMgJiYgYWxpYXNlcy5mb3JFYWNoKGZ1bmN0aW9uKGFsaWFzKXtcclxuICAgICAgICBjb25mW3NrXSB8fCAoY29uZltza10gPSBqc29uW2FsaWFzXSk7XHJcbiAgICAgIH0pXHJcblxyXG4gICAgICB2YXIgdmFsID0gY29uZltza107XHJcbiAgICAgIGRlbGV0ZSBjb25mW3NrXTtcclxuXHJcbiAgICAgIC8vIFZhbGlkYXRlIGtleS12YWx1ZSBwYWlycy5cclxuICAgICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkIHx8XHJcbiAgICAgICAgICB2YWwgPT09IG51bGwgfHxcclxuICAgICAgICAgICgodmFsID0gdGhpcy5fdmFsaWQoc2ssIHZhbCkpID09PSBudWxsKSkge1xyXG5cclxuICAgICAgICAvLyBJZiB2YWx1ZSBpcyBub3QgZGVmaW5lZFxyXG4gICAgICAgIC8vIFNldCBkZWZhdWx0IHZhbHVlICh2aWEgc2NoZW1hLmpzb24pXHJcbiAgICAgICAgaWYgKHR5cGVvZihkZWZpbmVzW3NrXS5kZWZhdWx0KSAhPT0gJ3VuZGVmaW5lZCcpXHJcbiAgICAgICAgICByZXNbc2tdID0gZGVmaW5lc1tza10uZGVmYXVsdDtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG4gICAgICAvL2NvbnNvbGUubG9nKHNrLCB2YWwsIHZhbCA9PT0gbnVsbCwgdmFsID09PSB1bmRlZmluZWQpO1xyXG4gICAgICByZXNbc2tdID0gdmFsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFZhbGlkYXRlIFJlZ0V4cCB2YWx1ZXMuXHJcbiAgICB2YXIgaGFzUmVnZXhLZXkgPSBmYWxzZTtcclxuICAgIGZvciAodmFyIGsgaW4gcmVnZXhLZXlzKSB7XHJcbiAgICAgIGhhc1JlZ2V4S2V5ID0gdHJ1ZTtcclxuICAgICAgcmVnZXhLZXlzW2tdID0gbmV3IFJlZ0V4cChrKTtcclxuICAgIH1cclxuICAgIGlmIChoYXNSZWdleEtleSkge1xyXG4gICAgICBmb3IgKHZhciBrIGluIGNvbmYpIHtcclxuICAgICAgICBmb3IgKHZhciByayBpbiByZWdleEtleXMpIHtcclxuICAgICAgICAgIGlmIChyZWdleEtleXNbcmtdLnRlc3QoaykpXHJcbiAgICAgICAgICAgIGlmICh0aGlzLl92YWxpZChrLCBjb25mW2tdLCBkZWZpbmVzW3JrXSkpIHtcclxuICAgICAgICAgICAgICByZXNba10gPSBjb25mW2tdO1xyXG4gICAgICAgICAgICAgIGRlbGV0ZSBjb25mW2tdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHtlcnJvcnM6IHRoaXMuX2Vycm9ycywgY29uZmlnOiByZXN9O1xyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIFZhbGlkYXRlIGtleS12YWx1ZSBwYWlycyBieSBzcGVjaWZpYyBzY2hlbWFcclxuICAgKiBAcGFyYW0ge1N0cmluZ30ga2V5XHJcbiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWVcclxuICAgKiBAcGFyYW0ge09iamVjdH0gc2NoXHJcbiAgICogQHJldHVybnMgeyp9XHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICBfdmFsaWQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUsIHNjaCl7XHJcbiAgICB2YXIgc2NoID0gc2NoIHx8IHRoaXMuc2NoZW1hW2tleV0sXHJcbiAgICAgICAgc2NodCA9IHR5cGVvZiBzY2gudHlwZSA9PSAnc3RyaW5nJyA/IFtzY2gudHlwZV0gOiBzY2gudHlwZTtcclxuXHJcbiAgICAvLyBSZXF1aXJlZCB2YWx1ZS5cclxuICAgIHZhciB1bmRlZiA9IHR5cGVvZiB2YWx1ZSA9PSAndW5kZWZpbmVkJztcclxuICAgIGlmKHRoaXMuX2Vycm9yKHNjaC5yZXF1aXJlICYmIHVuZGVmLCAncmVxdWlyZScsIGtleSkpe1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBJZiB1bmRlZmluZWQsIG1ha2UgYSBicmVhay5cclxuICAgIGlmICh1bmRlZikge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBXcmFwIHNjaGVtYSB0eXBlcy5cclxuICAgIHNjaHQgPSBzY2h0Lm1hcChmdW5jdGlvbih0KXtcclxuICAgICAgcmV0dXJuICdbb2JqZWN0ICcgKyB0WzBdLnRvVXBwZXJDYXNlKCkgKyB0LnNsaWNlKDEpICsgJ10nXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBUeXBlb2YgdmFsdWUuXHJcbiAgICB2YXIgdHlwZSA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksIG50ID0gJ1tvYmplY3QgTnVtYmVyXSc7XHJcblxyXG4gICAgLy8gQXV0byBwYXJzZSBOdW1iZXJcclxuICAgIGlmICh0eXBlICE9ICdbb2JqZWN0IEJvb2xlYW5dJyAmJiBzY2h0LmluZGV4T2YobnQpID49IDAgJiYgIWlzTmFOKHZhbHVlKSkge1xyXG4gICAgICB2YWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpO1xyXG4gICAgICB0eXBlID0gbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVmVyaWZ5IHR5cGVzLlxyXG4gICAgaWYgKHRoaXMuX2Vycm9yKCF+c2NodC5pbmRleE9mKHR5cGUpLCAndHlwZScsIGtleSwgc2NodC5qb2luKCcgLyAnKSwgdHlwZSkpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVmVyaWZ5IFJlZ0V4cCBpZiBleGlzdHMuXHJcbiAgICBpZiAodGhpcy5fZXJyb3IodHlwZSA9PSAnW29iamVjdCBTdHJpbmddJyAmJiBzY2gucmVnZXggJiYgIShuZXcgUmVnRXhwKHNjaC5yZWdleCkpLnRlc3QodmFsdWUpLFxyXG4gICAgICAgICdyZWdleCcsIGtleSwgc2NoLmRlc2MgfHwgKCdzaG91bGQgbWF0Y2ggJyArIHNjaC5yZWdleCkpKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFZlcmlmeSBtYXhpbXVtIC8gbWluaW11bSBvZiBOdW1iZXIgdmFsdWUuXHJcbiAgICBpZiAodHlwZSA9PSAnW29iamVjdCBOdW1iZXJdJykge1xyXG4gICAgICBpZiAodGhpcy5fZXJyb3IodHlwZW9mIHNjaC5tYXggIT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgPiBzY2gubWF4LCAnbWF4Jywga2V5LCBzY2gubWF4LCB2YWx1ZSkpIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5fZXJyb3IodHlwZW9mIHNjaC5taW4gIT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgPCBzY2gubWluLCAnbWluJywga2V5LCBzY2gubWluLCB2YWx1ZSkpIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIElmIGZpcnN0IHR5cGUgaXMgQXJyYXksIGJ1dCBjdXJyZW50IGlzIFN0cmluZywgdHJ5IHRvIHNwbGl0IHRoZW0uXHJcbiAgICBpZihzY2h0Lmxlbmd0aCA+IDEgJiYgdHlwZSAhPSBzY2h0WzBdICYmIHR5cGUgPT0gJ1tvYmplY3QgU3RyaW5nXScpe1xyXG4gICAgICBpZihzY2h0WzBdID09ICdbb2JqZWN0IEFycmF5XScpIHtcclxuICAgICAgICAvLyB1bmZvcnR1bmF0ZWx5LCBqcyBkb2VzIG5vdCBzdXBwb3J0IGxvb2thaGVhZCBSZWdFeHAgKC8oPzwhXFxcXClcXHMrLykgbm93ICh1bnRpbCBuZXh0IHZlcikuXHJcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5zcGxpdCgvKFtcXHdcXC1dK1xcPVwiW15cIl0qXCIpfChbXFx3XFwtXStcXD0nW14nXSonKXxcIihbXlwiXSopXCJ8JyhbXiddKiknfFxccy8pXHJcbiAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uKHYpe1xyXG4gICAgICAgICAgICByZXR1cm4gdiAmJiB2LnRyaW0oKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ3VzdG9tIHR5cGVzOiBzYnl0ZSAmJiBzdGltZS5cclxuICAgIGlmKHNjaC5leHRfdHlwZSAmJiB0eXBlID09ICdbb2JqZWN0IFN0cmluZ10nICYmIHZhbHVlLmxlbmd0aCA+PSAyKSB7XHJcbiAgICAgIHZhciBzZWVkID0ge1xyXG4gICAgICAgICdzYnl0ZSc6IHtcclxuICAgICAgICAgICdHJzogMTAyNCAqIDEwMjQgKiAxMDI0LFxyXG4gICAgICAgICAgJ00nOiAxMDI0ICogMTAyNCxcclxuICAgICAgICAgICdLJzogMTAyNFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgJ3N0aW1lJzoge1xyXG4gICAgICAgICAgJ2gnOiA2MCAqIDYwICogMTAwMCxcclxuICAgICAgICAgICdtJzogNjAgKiAxMDAwLFxyXG4gICAgICAgICAgJ3MnOiAxMDAwXHJcbiAgICAgICAgfVxyXG4gICAgICB9W3NjaC5leHRfdHlwZV07XHJcblxyXG4gICAgICBpZihzZWVkKXtcclxuICAgICAgICB2YWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUuc2xpY2UoMCwgLTEpKSAqIChzZWVkW3ZhbHVlLnNsaWNlKC0xKV0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbiAgfSxcclxuXHJcbiAgLyoqXHJcbiAgICogV3JhcCBlcnJvcnMuXHJcbiAgICogQHBhcmFtIHtCb29sZWFufSBwb3NzaWJsZSBBIHZhbHVlIGluZGljYXRlcyB3aGV0aGVyIGl0IGlzIGFuIGVycm9yIG9yIG5vdC5cclxuICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZVxyXG4gICAqIEByZXR1cm5zIHsqfVxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgX2Vycm9yOiBmdW5jdGlvbihwb3NzaWJsZSwgdHlwZSl7XHJcbiAgICBpZiAocG9zc2libGUpIHtcclxuICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpO1xyXG4gICAgICBhcmdzLnNwbGljZSgwLCAyLCB0aGlzLl9lcnJNc2dzW3R5cGVdKTtcclxuICAgICAgdGhpcy5fZXJyb3JzICYmIHRoaXMuX2Vycm9ycy5wdXNoKHV0aWwuZm9ybWF0LmFwcGx5KG51bGwsIGFyZ3MgYXMgYW55KSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcG9zc2libGU7XHJcbiAgfSxcclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IENvbmZpZztcclxuIl19
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _path = _interopRequireDefault(require("path"));

var _child_process = require("child_process");

var _chalk = _interopRequireDefault(require("chalk"));

var _parallel = _interopRequireDefault(require("async/parallel"));

var _constants = _interopRequireDefault(require("../../../constants"));

var _Common = _interopRequireDefault(require("../../Common"));

var INTERNAL_MODULES = {
  'deep-monitoring': {
    dependencies: [{
      name: 'v8-profiler-node8'
    }, {
      name: 'gc-stats'
    }, {
      name: 'event-loop-inspector'
    }]
  },
  'gc-stats': {
    name: 'gc-stats'
  },
  'event-loop-inspector': {
    name: 'event-loop-inspector'
  },
  'v8-profiler': {
    name: 'v8-profiler-node8'
  },
  'profiler': {
    name: 'v8-profiler-node8'
  },
  'typescript': {
    dependencies: [{
      name: 'typescript'
    }, {
      name: 'ts-node@latest'
    }]
  },
  'livescript': {
    name: 'livescript'
  },
  'coffee-script': {
    name: 'coffee-script',
    message: 'Coffeescript v1 support'
  },
  'coffeescript': {
    name: 'coffeescript',
    message: 'Coffeescript v2 support'
  }
};

function install(module, cb, verbose) {
  if (!module || !module.name || module.name.length === 0) {
    return cb(new Error('No module name !'));
  }

  if (typeof verbose === 'undefined') {
    verbose = true;
  }

  installLangModule(module.name, function (err) {
    var display = module.message || module.name;

    if (err) {
      if (verbose) {
        _Common["default"].printError(_constants["default"].PREFIX_MSG_MOD_ERR + _chalk["default"].bold.green(display + ' installation has FAILED (checkout previous logs)'));
      }

      return cb(err);
    }

    if (verbose) {
      _Common["default"].printOut(_constants["default"].PREFIX_MSG + _chalk["default"].bold.green(display + ' ENABLED'));
    }

    return cb();
  });
}

function installMultipleModules(modules, cb, post_install) {
  var functionList = [];

  for (var i = 0; i < modules.length; i++) {
    functionList.push(function (index) {
      return function (callback) {
        var module = modules[index];

        if (typeof modules[index] === 'string') {
          module = {
            name: modules[index]
          };
        }

        install(module, function ($post_install, err, $index, $modules) {
          try {
            var install_instance = (0, _child_process.spawn)(post_install[modules[index]], {
              stdio: 'inherit',
              env: process.env,
              shell: true,
              cwd: process.cwd()
            });

            _Common["default"].printOut(_constants["default"].PREFIX_MSG_MOD + 'Running configuraton script.');
          } catch (e) {
            _Common["default"].printOut(_constants["default"].PREFIX_MSG_MOD + 'No configuraton script found.');
          }

          callback(null, {
            module: module,
            err: err
          });
        }, false);
      };
    }(i));
  }

  (0, _parallel["default"])(functionList, function (err, results) {
    for (var i = 0; i < results.length; i++) {
      var display = results[i].module.message || results[i].module.name;

      if (results[i].err) {
        err = results[i].err;

        _Common["default"].printError(_constants["default"].PREFIX_MSG_MOD_ERR + _chalk["default"].bold.green(display + ' installation has FAILED (checkout previous logs)'));
      } else {
        _Common["default"].printOut(_constants["default"].PREFIX_MSG + _chalk["default"].bold.green(display + ' ENABLED'));
      }
    }

    if (cb) cb(err);
  });
}

;

function installLangModule(module_name, cb) {
  var node_module_path = _path["default"].resolve(_path["default"].join(__dirname, '../../../'));

  _Common["default"].printOut(_constants["default"].PREFIX_MSG_MOD + 'Calling ' + _chalk["default"].bold.red('[NPM]') + ' to install ' + module_name + ' ...');

  var install_instance = (0, _child_process.spawn)(_constants["default"].IS_WINDOWS ? 'npm.cmd' : 'npm', ['install', module_name, '--loglevel=error'], {
    stdio: 'inherit',
    env: process.env,
    shell: true,
    cwd: node_module_path
  });
  install_instance.on('close', function (code) {
    if (code > 0) return cb(new Error('Module install failed'));
    return cb(null);
  });
  install_instance.on('error', function (err) {
    console.error(err.stack || err);
  });
}

;
var _default = {
  install: install,
  INTERNAL_MODULES: INTERNAL_MODULES,
  installMultipleModules: installMultipleModules
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BUEkvTW9kdWxlcy9MT0NBTC50cyJdLCJuYW1lcyI6WyJJTlRFUk5BTF9NT0RVTEVTIiwiZGVwZW5kZW5jaWVzIiwibmFtZSIsIm1lc3NhZ2UiLCJpbnN0YWxsIiwibW9kdWxlIiwiY2IiLCJ2ZXJib3NlIiwibGVuZ3RoIiwiRXJyb3IiLCJpbnN0YWxsTGFuZ01vZHVsZSIsImVyciIsImRpc3BsYXkiLCJDb21tb24iLCJwcmludEVycm9yIiwiY3N0IiwiUFJFRklYX01TR19NT0RfRVJSIiwiY2hhbGsiLCJib2xkIiwiZ3JlZW4iLCJwcmludE91dCIsIlBSRUZJWF9NU0ciLCJpbnN0YWxsTXVsdGlwbGVNb2R1bGVzIiwibW9kdWxlcyIsInBvc3RfaW5zdGFsbCIsImZ1bmN0aW9uTGlzdCIsImkiLCJwdXNoIiwiaW5kZXgiLCJjYWxsYmFjayIsIiRwb3N0X2luc3RhbGwiLCIkaW5kZXgiLCIkbW9kdWxlcyIsImluc3RhbGxfaW5zdGFuY2UiLCJzdGRpbyIsImVudiIsInByb2Nlc3MiLCJzaGVsbCIsImN3ZCIsIlBSRUZJWF9NU0dfTU9EIiwiZSIsInJlc3VsdHMiLCJtb2R1bGVfbmFtZSIsIm5vZGVfbW9kdWxlX3BhdGgiLCJwYXRoIiwicmVzb2x2ZSIsImpvaW4iLCJfX2Rpcm5hbWUiLCJyZWQiLCJJU19XSU5ET1dTIiwib24iLCJjb2RlIiwiY29uc29sZSIsImVycm9yIiwic3RhY2siXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUVBLElBQUlBLGdCQUFnQixHQUFHO0FBQ3JCLHFCQUFtQjtBQUNqQkMsSUFBQUEsWUFBWSxFQUFFLENBQUM7QUFBRUMsTUFBQUEsSUFBSSxFQUFFO0FBQVIsS0FBRCxFQUFnQztBQUFFQSxNQUFBQSxJQUFJLEVBQUU7QUFBUixLQUFoQyxFQUFzRDtBQUFFQSxNQUFBQSxJQUFJLEVBQUU7QUFBUixLQUF0RDtBQURHLEdBREU7QUFJckIsY0FB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LENBQW9CLE9BQXBCLEVBQTZCLFVBQVVDLElBQVYsRUFBZ0I7QUFDM0MsUUFBSUEsSUFBSSxHQUFHLENBQVgsRUFDRSxPQUFPN0MsRUFBRSxDQUFDLElBQUlHLEtBQUosQ0FBVSx1QkFBVixDQUFELENBQVQ7QUFDRixXQUFPSCxFQUFFLENBQUMsSUFBRCxDQUFUO0FBQ0QsR0FKRDtBQU1BMkIsRUFBQUEsZ0JBQWdCLENBQUNpQixFQUFqQixDQUFvQixPQUFwQixFQUE2QixVQUFVdkMsR0FBVixFQUFlO0FBQzFDeUMsSUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWMxQyxHQUFHLENBQUMyQyxLQUFKLElBQWEzQyxHQUEzQjtBQUNELEdBRkQ7QUFHRDs7QUFBQTtlQUVjO0FBQ2JQLEVBQUFBLE9BQU8sRUFBUEEsT0FEYTtBQUViSixFQUFBQSxnQkFBZ0IsRUFBaEJBLGdCQUZhO0FBR2JzQixFQUFBQSxzQkFBc0IsRUFBdEJBO0FBSGEsQyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBzcGF3biB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBwYXJhbGxlbCBmcm9tICdhc3luYy9wYXJhbGxlbCc7XG5cbmltcG9ydCBjc3QgZnJvbSAnLi4vLi4vLi4vY29uc3RhbnRzJztcbmltcG9ydCBDb21tb24gZnJvbSAnLi4vLi4vQ29tbW9uJztcblxudmFyIElOVEVSTkFMX01PRFVMRVMgPSB7XG4gICdkZWVwLW1vbml0b3JpbmcnOiB7XG4gICAgZGVwZW5kZW5jaWVzOiBbeyBuYW1lOiAndjgtcHJvZmlsZXItbm9kZTgnIH0sIHsgbmFtZTogJ2djLXN0YXRzJyB9LCB7IG5hbWU6ICdldmVudC1sb29wLWluc3BlY3RvcicgfV1cbiAgfSxcbiAgJ2djLXN0YXRzJzogeyBuYW1lOiAnZ2Mtc3RhdHMnIH0sXG4gICdldmVudC1sb29wLWluc3BlY3Rvcic6IHsgbmFtZTogJ2V2ZW50LWxvb3AtaW5zcGVjdG9yJyB9LFxuICAndjgtcHJvZmlsZXInOiB7IG5hbWU6ICd2OC1wcm9maWxlci1ub2RlOCcgfSxcbiAgJ3Byb2ZpbGVyJzogeyBuYW1lOiAndjgtcHJvZmlsZXItbm9kZTgnIH0sXG4gICd0eXBlc2NyaXB0JzogeyBkZXBlbmRlbmNpZXM6IFt7IG5hbWU6ICd0eXBlc2NyaXB0JyB9LCB7IG5hbWU6ICd0cy1ub2RlQGxhdGVzdCcgfV0gfSxcbiAgJ2xpdmVzY3JpcHQnOiB7IG5hbWU6ICdsaXZlc2NyaXB0JyB9LFxuICAnY29mZmVlLXNjcmlwdCc6IHsgbmFtZTogJ2NvZmZlZS1zY3JpcHQnLCBtZXNzYWdlOiAnQ29mZmVlc2NyaXB0IHYxIHN1cHBvcnQnIH0sXG4gICdjb2ZmZWVzY3JpcHQnOiB7IG5hbWU6ICdjb2ZmZWVzY3JpcHQnLCBtZXNzYWdlOiAnQ29mZmVlc2NyaXB0IHYyIHN1cHBvcnQnIH1cbn07XG5cbmZ1bmN0aW9uIGluc3RhbGwobW9kdWxlLCBjYiwgdmVyYm9zZT8pIHtcbiAgaWYgKCFtb2R1bGUgfHwgIW1vZHVsZS5uYW1lIHx8IG1vZHVsZS5uYW1lLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBjYihuZXcgRXJyb3IoJ05vIG1vZHVsZSBuYW1lICEnKSk7XG4gIH1cblxuICBpZiAodHlwZW9mIHZlcmJvc2UgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgdmVyYm9zZSA9IHRydWU7XG4gIH1cblxuICBpbnN0YWxsTGFuZ01vZHVsZShtb2R1bGUubmFtZSwgZnVuY3Rpb24gKGVycikge1xuICAgIHZhciBkaXNwbGF5ID0gbW9kdWxlLm1lc3NhZ2UgfHwgbW9kdWxlLm5hbWU7XG4gICAgaWYgKGVycikge1xuICAgICAgaWYgKHZlcmJvc2UpIHsgQ29tbW9uLnByaW50RXJyb3IoY3N0LlBSRUZJWF9NU0dfTU9EX0VSUiArIGNoYWxrLmJvbGQuZ3JlZW4oZGlzcGxheSArICcgaW5zdGFsbGF0aW9uIGhhcyBGQUlMRUQgKGNoZWNrb3V0IHByZXZpb3VzIGxvZ3MpJykpOyB9XG4gICAgICByZXR1cm4gY2IoZXJyKTtcbiAgICB9XG5cbiAgICBpZiAodmVyYm9zZSkgeyBDb21tb24ucHJpbnRPdXQoY3N0LlBSRUZJWF9NU0cgKyBjaGFsay5ib2xkLmdyZWVuKGRpc3BsYXkgKyAnIEVOQUJMRUQnKSk7IH1cbiAgICByZXR1cm4gY2IoKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGluc3RhbGxNdWx0aXBsZU1vZHVsZXMobW9kdWxlcywgY2IsIHBvc3RfaW5zdGFsbD8pIHtcbiAgdmFyIGZ1bmN0aW9uTGlzdCA9IFtdO1xuICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZHVsZXMubGVuZ3RoOyBpKyspIHtcbiAgICBmdW5jdGlvbkxpc3QucHVzaCgoZnVuY3Rpb24gKGluZGV4KSB7XG4gICAgICByZXR1cm4gZnVuY3Rpb24gKGNhbGxiYWNrKSB7XG4gICAgICAgIHZhciBtb2R1bGUgPSBtb2R1bGVzW2luZGV4XTtcbiAgICAgICAgaWYgKHR5cGVvZiBtb2R1bGVzW2luZGV4XSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICBtb2R1bGUgPSB7IG5hbWU6IG1vZHVsZXNbaW5kZXhdIH07XG4gICAgICAgIH1cbiAgICAgICAgaW5zdGFsbChtb2R1bGUsIGZ1bmN0aW9uICgkcG9zdF9pbnN0YWxsLCBlcnIsICRpbmRleCwgJG1vZHVsZXMpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgdmFyIGluc3RhbGxfaW5zdGFuY2UgPSBzcGF3bihwb3N0X2luc3RhbGxbbW9kdWxlc1tpbmRleF1dLCB7XG4gICAgICAgICAgICAgIHN0ZGlvOiAnaW5oZXJpdCcsXG4gICAgICAgICAgICAgIGVudjogcHJvY2Vzcy5lbnYsXG4gICAgICAgICAgICAgIHNoZWxsOiB0cnVlLFxuICAgICAgICAgICAgICBjd2Q6IHByb2Nlc3MuY3dkKClcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgQ29tbW9uLnByaW50T3V0KGNzdC5QUkVGSVhfTVNHX01PRCArICdSdW5uaW5nIGNvbmZpZ3VyYXRvbiBzY3JpcHQuJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICBDb21tb24ucHJpbnRPdXQoY3N0LlBSRUZJWF9NU0dfTU9EICsgJ05vIGNvbmZpZ3VyYXRvbiBzY3JpcHQgZm91bmQuJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHsgbW9kdWxlOiBtb2R1bGUsIGVycjogZXJyIH0pO1xuICAgICAgICB9LCBmYWxzZSk7XG4gICAgICB9O1xuICAgIH0pKGkpKTtcbiAgfVxuXG4gIHBhcmFsbGVsKGZ1bmN0aW9uTGlzdCwgZnVuY3Rpb24gKGVyciwgcmVzdWx0cykge1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKykge1xuICAgICAgdmFyIGRpc3BsYXkgPSByZXN1bHRzW2ldLm1vZHVsZS5tZXNzYWdlIHx8IHJlc3VsdHNbaV0ubW9kdWxlLm5hbWU7XG4gICAgICBpZiAocmVzdWx0c1tpXS5lcnIpIHtcbiAgICAgICAgZXJyID0gcmVzdWx0c1tpXS5lcnI7XG4gICAgICAgIENvbW1vbi5wcmludEVycm9yKGNzdC5QUkVGSVhfTVNHX01PRF9FUlIgKyBjaGFsay5ib2xkLmdyZWVuKGRpc3BsYXkgKyAnIGluc3RhbGxhdGlvbiBoYXMgRkFJTEVEIChjaGVja291dCBwcmV2aW91cyBsb2dzKScpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIENvbW1vbi5wcmludE91dChjc3QuUFJFRklYX01TRyArIGNoYWxrLmJvbGQuZ3JlZW4oZGlzcGxheSArICcgRU5BQkxFRCcpKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY2IpIGNiKGVycik7XG4gIH0pO1xufTtcblxuZnVuY3Rpb24gaW5zdGFsbExhbmdNb2R1bGUobW9kdWxlX25hbWUsIGNiKSB7XG4gIHZhciBub2RlX21vZHVsZV9wYXRoID0gcGF0aC5yZXNvbHZlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi8uLi8nKSk7XG4gIENvbW1vbi5wcmludE91dChjc3QuUFJFRklYX01TR19NT0QgKyAnQ2FsbGluZyAnICsgY2hhbGsuYm9sZC5yZWQoJ1tOUE1dJykgKyAnIHRvIGluc3RhbGwgJyArIG1vZHVsZV9uYW1lICsgJyAuLi4nKTtcblxuICB2YXIgaW5zdGFsbF9pbnN0YW5jZSA9IHNwYXduKGNzdC5JU19XSU5ET1dTID8gJ25wbS5jbWQnIDogJ25wbScsIFsnaW5zdGFsbCcsIG1vZHVsZV9uYW1lLCAnLS1sb2dsZXZlbD1lcnJvciddLCB7XG4gICAgc3RkaW86ICdpbmhlcml0JyxcbiAgICBlbnY6IHByb2Nlc3MuZW52LFxuICAgIHNoZWxsOiB0cnVlLFxuICAgIGN3ZDogbm9kZV9tb2R1bGVfcGF0aFxuICB9KTtcblxuICBpbnN0YWxsX2luc3RhbmNlLm9uKCdjbG9zZScsIGZ1bmN0aW9uIChjb2RlKSB7XG4gICAgaWYgKGNvZGUgPiAwKVxuICAgICAgcmV0dXJuIGNiKG5ldyBFcnJvcignTW9kdWxlIGluc3RhbGwgZmFpbGVkJykpO1xuICAgIHJldHVybiBjYihudWxsKTtcbiAgfSk7XG5cbiAgaW5zdGFsbF9pbnN0YW5jZS5vbignZXJyb3InLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnIuc3RhY2sgfHwgZXJyKTtcbiAgfSk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGluc3RhbGwsXG4gIElOVEVSTkFMX01PRFVMRVMsXG4gIGluc3RhbGxNdWx0aXBsZU1vZHVsZXNcbn1cbiJdfQ==
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _eachLimit = _interopRequireDefault(require("async/eachLimit"));

var _forEachLimit = _interopRequireDefault(require("async/forEachLimit"));

var _Configuration = _interopRequireDefault(require("../../Configuration"));

var _constants = _interopRequireDefault(require("../../../constants"));

var _Common = _interopRequireDefault(require("../../Common"));

var _NPM = _interopRequireDefault(require("./NPM"));

var _TAR = _interopRequireDefault(require("./TAR"));

var _LOCAL = _interopRequireDefault(require("./LOCAL"));

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
var Modularizer = {};
/**
 * PM2 Module System.
 */

Modularizer.install = function (CLI, module_name, opts, cb) {
  module_name = module_name.replace(/[;`|]/g, "");

  if (typeof opts == 'function') {
    cb = opts;
    opts = {};
  }

  if (_LOCAL["default"].INTERNAL_MODULES.hasOwnProperty(module_name)) {
    _Common["default"].logMod("Adding dependency ".concat(module_name, " to PM2 Runtime"));

    var currentModule = _LOCAL["default"].INTERNAL_MODULES[module_name];

    if (currentModule && currentModule.hasOwnProperty('dependencies')) {
      _LOCAL["default"].installMultipleModules(currentModule.dependencies, cb);
    } else {
      _LOCAL["default"].install(currentModule, cb);
    }
  } else if (module_name == '.') {
    _Common["default"].logMod("Installing local NPM module");

    return _NPM["default"].localStart(CLI, opts, cb);
  } else if (opts.tarball || /\.tar\.gz$/i.test(module_name)) {
    _Common["default"].logMod("Installing TAR module");

    _TAR["default"].install(CLI, module_name, opts, cb);
  } else {
    _Common["default"].logMod("Installing NPM ".concat(module_name, " module"));

    _NPM["default"].install(CLI, module_name, opts, cb);
  }
};
/**
 * Launch All Modules
 * Used PM2 at startup
 */


Modularizer.launchModules = function (CLI, cb) {
  var modules = Modularizer.listModules();
  if (!modules) return cb(); // 1#

  function launchNPMModules(cb) {
    if (!modules.npm_modules) return launchTARModules(cb);
    (0, _eachLimit["default"])(Object.keys(modules.npm_modules), 1, function (module_name, next) {
      _NPM["default"].start(CLI, modules, module_name, next);
    }, function () {
      launchTARModules(cb);
    });
  } // 2#


  function launchTARModules(cb) {
    if (!modules.tar_modules) return cb();
    (0, _eachLimit["default"])(Object.keys(modules.tar_modules), 1, function (module_name, next) {
      _TAR["default"].start(CLI, module_name, next);
    }, function () {
      return cb ? cb(null) : false;
    });
  }

  launchNPMModules(cb);
};

Modularizer["package"] = function (CLI, module_path, cb) {
  var fullpath = process.cwd();
  if (module_path) fullpath = require('path').resolve(module_path);

  _TAR["default"].package1(fullpath, process.cwd(), cb);
};
/**
 * Uninstall module
 */


Modularizer.uninstall = function (CLI, module_name, cb) {
  _Common["default"].printOut(_constants["default"].PREFIX_MSG_MOD + 'Uninstalling module ' + module_name);

  var modules_list = Modularizer.listModules();

  if (module_name == 'all') {
    if (!modules_list) return cb();
    return (0, _forEachLimit["default"])(Object.keys(modules_list.npm_modules), 1, function (module_name, next) {
      _NPM["default"].uninstall(CLI, module_name, next);
    }, function () {
      (0, _forEachLimit["default"])(Object.keys(modules_list.tar_modules), 1, function (module_name, next) {
        _TAR["default"].uninstall(CLI, module_name, next);
      }, cb);
    });
  }

  if (modules_list.npm_modules[module_name]) {
    _NPM["default"].uninstall(CLI, module_name, cb);
  } else if (modules_list.tar_modules[module_name]) {
    _TAR["default"].uninstall(CLI, module_name, cb);
  } else {
    _Common["default"].errMod('Unknown module');

    CLI.exitCli(1);
  }
};
/**
 * List modules based on modules present in ~/.pm2/modules/ folder
 */


Modularizer.listModules = function () {
  return {
    npm_modules: _Configuration["default"].getSync(_constants["default"].MODULE_CONF_PREFIX) || {},
    tar_modules: _Configuration["default"].getSync(_constants["default"].MODULE_CONF_PREFIX_TAR) || {}
  };
};

Modularizer.getAdditionalConf = function (app_name) {
  return _NPM["default"].getModuleConf(app_name);
};

Modularizer.publish = function (PM2, folder, opts, cb) {
  if (opts.npm == true) {
    _NPM["default"].publish(opts, cb);
  } else {
    _TAR["default"].publish(PM2, folder, cb);
  }
};

Modularizer.generateSample = function (app_name, cb) {
  _NPM["default"].generateSample(app_name, cb);
};

var _default = Modularizer;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BUEkvTW9kdWxlcy9Nb2R1bGFyaXplci50cyJdLCJuYW1lcyI6WyJNb2R1bGFyaXplciIsImluc3RhbGwiLCJDTEkiLCJtb2R1bGVfbmFtZSIsIm9wdHMiLCJjYiIsInJlcGxhY2UiLCJMT0NBTCIsIklOVEVSTkFMX01PRFVMRVMiLCJoYXNPd25Qcm9wZXJ0eSIsIkNvbW1vbiIsImxvZ01vZCIsImN1cnJlbnRNb2R1bGUiLCJpbnN0YWxsTXVsdGlwbGVNb2R1bGVzIiwiZGVwZW5kZW5jaWVzIiwiTlBNIiwibG9jYWxTdGFydCIsInRhcmJhbGwiLCJ0ZXN0IiwiVEFSIiwibGF1bmNoTW9kdWxlcyIsIm1vZHVsZXMiLCJsaXN0TW9kdWxlcyIsImxhdW5jaE5QTU1vZHVsZXMiLCJucG1fbW9kdWxlcyIsImxhdW5jaFRBUk1vZHVsZXMiLCJPYmplY3QiLCJrZXlzIiwibmV4dCIsInN0YXJ0IiwidGFyX21vZHVsZXMiLCJtb2R1bGVfcGF0aCIsImZ1bGxwYXRoIiwicHJvY2VzcyIsImN3ZCIsInJlcXVpcmUiLCJyZXNvbHZlIiwicGFja2FnZTEiLCJ1bmluc3RhbGwiLCJwcmludE91dCIsImNzdCIsIlBSRUZJWF9NU0dfTU9EIiwibW9kdWxlc19saXN0IiwiZXJyTW9kIiwiZXhpdENsaSIsIkNvbmZpZ3VyYXRpb24iLCJnZXRTeW5jIiwiTU9EVUxFX0NPTkZfUFJFRklYIiwiTU9EVUxFX0NPTkZfUFJFRklYX1RBUiIsImdldEFkZGl0aW9uYWxDb25mIiwiYXBwX25hbWUiLCJnZXRNb2R1bGVDb25mIiwicHVibGlzaCIsIlBNMiIsImZvbGRlciIsIm5wbSIsImdlbmVyYXRlU2FtcGxlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFNQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFkQTs7Ozs7QUFnQkEsSUFBSUEsV0FBZ0IsR0FBRyxFQUF2QjtBQUVBOzs7O0FBR0FBLFdBQVcsQ0FBQ0MsT0FBWixHQUFz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QixFQUE0QkMsRUFBNUIsRUFBZ0M7QUFDcEQsTUFBSUQsSUFBSSxDQUFDbUQsR0FBTCxJQUFZLElBQWhCLEVBQXNCO0FBQ3BCeEMsb0JBQUlxQyxPQUFKLENBQVloRCxJQUFaLEVBQWtCQyxFQUFsQjtBQUNELEdBRkQsTUFHSztBQUNIYyxvQkFBSWlDLE9BQUosQ0FBWUMsR0FBWixFQUFpQkMsTUFBakIsRUFBeUJqRCxFQUF6QjtBQUNEO0FBQ0YsQ0FQRDs7QUFTQUwsV0FBVyxDQUFDd0QsY0FBWixHQUE2QixVQUFTTixRQUFULEVBQW1CN0MsRUFBbkIsRUFBdUI7QUFDbERVLGtCQUFJeUMsY0FBSixDQUFtQk4sUUFBbkIsRUFBNkI3QyxFQUE3QjtBQUNELENBRkQ7O2VBSWVMLFciLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAyMDEzIHRoZSBQTTIgcHJvamVjdCBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBsaWNlbnNlIHRoYXRcbiAqIGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLlxuICovXG5pbXBvcnQgcGF0aCAgICAgICAgICBmcm9tICdwYXRoJztcbmltcG9ydCBlYWNoTGltaXQgICAgIGZyb20gJ2FzeW5jL2VhY2hMaW1pdCc7XG5pbXBvcnQgZm9yRWFjaExpbWl0ICBmcm9tICdhc3luYy9mb3JFYWNoTGltaXQnO1xuXG5pbXBvcnQgQ29uZmlndXJhdGlvbiBmcm9tICcuLi8uLi9Db25maWd1cmF0aW9uJztcbmltcG9ydCBjc3QgZnJvbSAnLi4vLi4vLi4vY29uc3RhbnRzJztcbmltcG9ydCBDb21tb24gZnJvbSAnLi4vLi4vQ29tbW9uJztcbmltcG9ydCBOUE0gZnJvbSAnLi9OUE0nO1xuaW1wb3J0IFRBUiBmcm9tICcuL1RBUic7XG5pbXBvcnQgTE9DQUwgZnJvbSAnLi9MT0NBTCc7XG5cbnZhciBNb2R1bGFyaXplcjogYW55ID0ge307XG5cbi8qKlxuICogUE0yIE1vZHVsZSBTeXN0ZW0uXG4gKi9cbk1vZHVsYXJpemVyLmluc3RhbGwgPSBmdW5jdGlvbiAoQ0xJLCBtb2R1bGVfbmFtZSwgb3B0cywgY2IpIHtcbiAgbW9kdWxlX25hbWUgPSBtb2R1bGVfbmFtZS5yZXBsYWNlKC9bO2B8XS9nLCBcIlwiKTtcbiAgaWYgKHR5cGVvZihvcHRzKSA9PSAnZnVuY3Rpb24nKSB7XG4gICAgY2IgPSBvcHRzO1xuICAgIG9wdHMgPSB7fTtcbiAgfVxuXG4gIGlmIChMT0NBTC5JTlRFUk5BTF9NT0RVTEVTLmhhc093blByb3BlcnR5KG1vZHVsZV9uYW1lKSkge1xuICAgIENvbW1vbi5sb2dNb2QoYEFkZGluZyBkZXBlbmRlbmN5ICR7bW9kdWxlX25hbWV9IHRvIFBNMiBSdW50aW1lYCk7XG4gICAgdmFyIGN1cnJlbnRNb2R1bGUgPSBMT0NBTC5JTlRFUk5BTF9NT0RVTEVTW21vZHVsZV9uYW1lXTtcbiAgICBpZiAoY3VycmVudE1vZHVsZSAmJiBjdXJyZW50TW9kdWxlLmhhc093blByb3BlcnR5KCdkZXBlbmRlbmNpZXMnKSkge1xuICAgICAgTE9DQUwuaW5zdGFsbE11bHRpcGxlTW9kdWxlcyhjdXJyZW50TW9kdWxlLmRlcGVuZGVuY2llcywgY2IpO1xuICAgIH0gZWxzZSB7XG4gICAgICBMT0NBTC5pbnN0YWxsKGN1cnJlbnRNb2R1bGUsIGNiKTtcbiAgICB9XG4gIH1cbiAgZWxzZSBpZiAobW9kdWxlX25hbWUgPT0gJy4nKSB7XG4gICAgQ29tbW9uLmxvZ01vZChgSW5zdGFsbGluZyBsb2NhbCBOUE0gbW9kdWxlYCk7XG4gICAgcmV0dXJuIE5QTS5sb2NhbFN0YXJ0KENMSSwgb3B0cywgY2IpXG4gIH1cbiAgZWxzZSBpZiAob3B0cy50YXJiYWxsIHx8IC9cXC50YXJcXC5neiQvaS50ZXN0KG1vZHVsZV9uYW1lKSkge1xuICAgIENvbW1vbi5sb2dNb2QoYEluc3RhbGxpbmcgVEFSIG1vZHVsZWApO1xuICAgIFRBUi5pbnN0YWxsKENMSSwgbW9kdWxlX25hbWUsIG9wdHMsIGNiKVxuICB9XG4gIGVsc2Uge1xuICAgIENvbW1vbi5sb2dNb2QoYEluc3RhbGxpbmcgTlBNICR7bW9kdWxlX25hbWV9IG1vZHVsZWApO1xuICAgIE5QTS5pbnN0YWxsKENMSSwgbW9kdWxlX25hbWUsIG9wdHMsIGNiKVxuICB9XG59O1xuXG4vKipcbiAqIExhdW5jaCBBbGwgTW9kdWxlc1xuICogVXNlZCBQTTIgYXQgc3RhcnR1cFxuICovXG5Nb2R1bGFyaXplci5sYXVuY2hNb2R1bGVzID0gZnVuY3Rpb24oQ0xJLCBjYikge1xuICB2YXIgbW9kdWxlcyA9IE1vZHVsYXJpemVyLmxpc3RNb2R1bGVzKCk7XG5cbiAgaWYgKCFtb2R1bGVzKSByZXR1cm4gY2IoKTtcblxuICAvLyAxI1xuICBmdW5jdGlvbiBsYXVuY2hOUE1Nb2R1bGVzKGNiKSB7XG4gICAgaWYgKCFtb2R1bGVzLm5wbV9tb2R1bGVzKSByZXR1cm4gbGF1bmNoVEFSTW9kdWxlcyhjYilcblxuICAgIGVhY2hMaW1pdChPYmplY3Qua2V5cyhtb2R1bGVzLm5wbV9tb2R1bGVzKSwgMSwgZnVuY3Rpb24obW9kdWxlX25hbWUsIG5leHQpIHtcbiAgICAgIE5QTS5zdGFydChDTEksIG1vZHVsZXMsIG1vZHVsZV9uYW1lLCBuZXh0KVxuICAgIH0sIGZ1bmN0aW9uKCkge1xuICAgICAgbGF1bmNoVEFSTW9kdWxlcyhjYilcbiAgICB9KTtcbiAgfVxuXG4gIC8vIDIjXG4gIGZ1bmN0aW9uIGxhdW5jaFRBUk1vZHVsZXMoY2IpIHtcbiAgICBpZiAoIW1vZHVsZXMudGFyX21vZHVsZXMpIHJldHVybiBjYigpXG5cbiAgICBlYWNoTGltaXQoT2JqZWN0LmtleXMobW9kdWxlcy50YXJfbW9kdWxlcyksIDEsIGZ1bmN0aW9uKG1vZHVsZV9uYW1lLCBuZXh0KSB7XG4gICAgICBUQVIuc3RhcnQoQ0xJLCBtb2R1bGVfbmFtZSwgbmV4dClcbiAgICB9LCBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBjYiA/IGNiKG51bGwpIDogZmFsc2U7XG4gICAgfSk7XG4gIH1cblxuICBsYXVuY2hOUE1Nb2R1bGVzKGNiKVxufVxuXG5Nb2R1bGFyaXplci5wYWNrYWdlID0gZnVuY3Rpb24oQ0xJLCBtb2R1bGVfcGF0aCwgY2IpIHtcbiAgdmFyIGZ1bGxwYXRoID0gcHJvY2Vzcy5jd2QoKVxuICBpZiAobW9kdWxlX3BhdGgpXG4gICAgZnVsbHBhdGggPSByZXF1aXJlKCdwYXRoJykucmVzb2x2ZShtb2R1bGVfcGF0aClcbiAgVEFSLnBhY2thZ2UxKGZ1bGxwYXRoLCBwcm9jZXNzLmN3ZCgpLCBjYilcbn1cblxuLyoqXG4gKiBVbmluc3RhbGwgbW9kdWxlXG4gKi9cbk1vZHVsYXJpemVyLnVuaW5zdGFsbCA9IGZ1bmN0aW9uKENMSSwgbW9kdWxlX25hbWUsIGNiKSB7XG4gIENvbW1vbi5wcmludE91dChjc3QuUFJFRklYX01TR19NT0QgKyAnVW5pbnN0YWxsaW5nIG1vZHVsZSAnICsgbW9kdWxlX25hbWUpO1xuICB2YXIgbW9kdWxlc19saXN0ID0gTW9kdWxhcml6ZXIubGlzdE1vZHVsZXMoKTtcblxuICBpZiAobW9kdWxlX25hbWUgPT0gJ2FsbCcpIHtcbiAgICBpZiAoIW1vZHVsZXNfbGlzdCkgcmV0dXJuIGNiKCk7XG5cbiAgICByZXR1cm4gZm9yRWFjaExpbWl0KE9iamVjdC5rZXlzKG1vZHVsZXNfbGlzdC5ucG1fbW9kdWxlcyksIDEsIGZ1bmN0aW9uKG1vZHVsZV9uYW1lLCBuZXh0KSB7XG4gICAgICBOUE0udW5pbnN0YWxsKENMSSwgbW9kdWxlX25hbWUsIG5leHQpXG4gICAgfSwgKCkgPT4ge1xuICAgICAgZm9yRWFjaExpbWl0KE9iamVjdC5rZXlzKG1vZHVsZXNfbGlzdC50YXJfbW9kdWxlcyksIDEsIGZ1bmN0aW9uKG1vZHVsZV9uYW1lLCBuZXh0KSB7XG4gICAgICAgIFRBUi51bmluc3RhbGwoQ0xJLCBtb2R1bGVfbmFtZSwgbmV4dClcbiAgICAgIH0sIGNiKVxuICAgIH0pO1xuICB9XG5cbiAgaWYgKG1vZHVsZXNfbGlzdC5ucG1fbW9kdWxlc1ttb2R1bGVfbmFtZV0pIHtcbiAgICBOUE0udW5pbnN0YWxsKENMSSwgbW9kdWxlX25hbWUsIGNiKVxuICB9IGVsc2UgaWYgKG1vZHVsZXNfbGlzdC50YXJfbW9kdWxlc1ttb2R1bGVfbmFtZV0pIHtcbiAgICBUQVIudW5pbnN0YWxsKENMSSwgbW9kdWxlX25hbWUsIGNiKVxuICB9XG4gIGVsc2Uge1xuICAgIENvbW1vbi5lcnJNb2QoJ1Vua25vd24gbW9kdWxlJylcbiAgICBDTEkuZXhpdENsaSgxKVxuICB9XG59O1xuXG4vKipcbiAqIExpc3QgbW9kdWxlcyBiYXNlZCBvbiBtb2R1bGVzIHByZXNlbnQgaW4gfi8ucG0yL21vZHVsZXMvIGZvbGRlclxuICovXG5Nb2R1bGFyaXplci5saXN0TW9kdWxlcyA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4ge1xuICAgIG5wbV9tb2R1bGVzOiBDb25maWd1cmF0aW9uLmdldFN5bmMoY3N0Lk1PRFVMRV9DT05GX1BSRUZJWCkgfHwge30sXG4gICAgdGFyX21vZHVsZXM6IENvbmZpZ3VyYXRpb24uZ2V0U3luYyhjc3QuTU9EVUxFX0NPTkZfUFJFRklYX1RBUikgfHwge31cbiAgfVxufTtcblxuTW9kdWxhcml6ZXIuZ2V0QWRkaXRpb25hbENvbmYgPSBmdW5jdGlvbihhcHBfbmFtZSkge1xuICByZXR1cm4gTlBNLmdldE1vZHVsZUNvbmYoYXBwX25hbWUpXG59O1xuXG5Nb2R1bGFyaXplci5wdWJsaXNoID0gZnVuY3Rpb24oUE0yLCBmb2xkZXIsIG9wdHMsIGNiKSB7XG4gIGlmIChvcHRzLm5wbSA9PSB0cnVlKSB7XG4gICAgTlBNLnB1Ymxpc2gob3B0cywgY2IpXG4gIH1cbiAgZWxzZSB7XG4gICAgVEFSLnB1Ymxpc2goUE0yLCBmb2xkZXIsIGNiKVxuICB9XG59O1xuXG5Nb2R1bGFyaXplci5nZW5lcmF0ZVNhbXBsZSA9IGZ1bmN0aW9uKGFwcF9uYW1lLCBjYikge1xuICBOUE0uZ2VuZXJhdGVTYW1wbGUoYXBwX25hbWUsIGNiKVxufTtcblxuZXhwb3J0IGRlZmF1bHQgTW9kdWxhcml6ZXI7XG4iXX0=
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _eachLimit = _interopRequireDefault(require("async/eachLimit"));

var _forEachLimit = _interopRequireDefault(require("async/forEachLimit"));

var _Configuration = _interopRequireDefault(require("../../Configuration"));

var _constants = _interopRequireDefault(require("../../../constants"));

var _Common = _interopRequireDefault(require("../../Common"));

var _NPM = _interopRequireDefault(require("./NPM"));

var _TAR = _interopRequireDefault(require("./TAR"));

var _LOCAL = _interopRequireDefault(require("./LOCAL"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
var Modularizer = {};
/**
 * PM2 Module System.
 */

Modularizer.install = function (CLI, module_name, opts, cb) {
  module_name = module_name.replace(/[;`|]/g, "");

  if (typeof opts == 'function') {
    cb = opts;
    opts = {};
  }

  if (_LOCAL["default"].INTERNAL_MODULES.hasOwnProperty(module_name)) {
    _Common["default"].logMod("Adding dependency ".concat(module_name, " to PM2 Runtime"));

    var currentModule = _LOCAL["default"].INTERNAL_MODULES[module_name];

    if (currentModule && currentModule.hasOwnProperty('dependencies')) {
      _LOCAL["default"].installMultipleModules(currentModule.dependencies, cb);
    } else {
      _LOCAL["default"].install(currentModule, cb);
    }
  } else if (module_name == '.') {
    _Common["default"].logMod("Installing local NPM module");

    return _NPM["default"].localStart(CLI, opts, cb);
  } else if (opts.tarball || /\.tar\.gz$/i.test(module_name)) {
    _Common["default"].logMod("Installing TAR module");

    _TAR["default"].install(CLI, module_name, opts, cb);
  } else {
    _Common["default"].logMod("Installing NPM ".concat(module_name, " module"));

    _NPM["default"].install(CLI, module_name, opts, cb);
  }
};
/**
 * Launch All Modules
 * Used PM2 at startup
 */


Modularizer.launchModules = function (CLI, cb) {
  var modules = Modularizer.listModules();
  if (!modules) return cb(); // 1#

  function launchNPMModules(cb) {
    if (!modules.npm_modules) return launchTARModules(cb);
    (0, _eachLimit["default"])(Object.keys(modules.npm_modules), 1, function (module_name, next) {
      _NPM["default"].start(CLI, modules, module_name, next);
    }, function () {
      launchTARModules(cb);
    });
  } // 2#


  function launchTARModules(cb) {
    if (!modules.tar_modules) return cb();
    (0, _eachLimit["default"])(Object.keys(modules.tar_modules), 1, function (module_name, next) {
      _TAR["default"].start(CLI, module_name, next);
    }, function () {
      return cb ? cb(null) : false;
    });
  }

  launchNPMModules(cb);
};

Modularizer["package"] = function (CLI, module_path, cb) {
  var fullpath = process.cwd();
  if (module_path) fullpath = require('path').resolve(module_path);

  _TAR["default"].package1(fullpath, process.cwd(), cb);
};
/**
 * Uninstall module
 */


Modularizer.uninstall = function (CLI, module_name, cb) {
  _Common["default"].printOut(_constants["default"].PREFIX_MSG_MOD + 'Uninstalling module ' + module_name);

  var modules_list = Modularizer.listModules();

  if (module_name == 'all') {
    if (!modules_list) return cb();
    return (0, _forEachLimit["default"])(Object.keys(modules_list.npm_modules), 1, function (module_name, next) {
      _NPM["default"].uninstall(CLI, module_name, next);
    }, function () {
      (0, _forEachLimit["default"])(Object.keys(modules_list.tar_modules), 1, function (module_name, next) {
        _TAR["default"].uninstall(CLI, module_name, next);
      }, cb);
    });
  }

  if (modules_list.npm_modules[module_name]) {
    _NPM["default"].uninstall(CLI, module_name, cb);
  } else if (modules_list.tar_modules[module_name]) {
    _TAR["default"].uninstall(CLI, module_name, cb);
  } else {
    _Common["default"].errMod('Unknown module');

    CLI.exitCli(1);
  }
};
/**
 * List modules based on modules present in ~/.pm2/modules/ folder
 */


Modularizer.listModules = function () {
  return {
    npm_modules: _Configuration["default"].getSync(_constants["default"].MODULE_CONF_PREFIX) || {},
    tar_modules: _Configuration["default"].getSync(_constants["default"].MODULE_CONF_PREFIX_TAR) || {}
  };
};

Modularizer.getAdditionalConf = function (app_name) {
  return _NPM["default"].getModuleConf(app_name);
};

Modularizer.publish = function (PM2, folder, opts, cb) {
  if (opts.npm == true) {
    _NPM["default"].publish(opts, cb);
  } else {
    _TAR["default"].publish(PM2, folder, cb);
  }
};

Modularizer.generateSample = function (app_name, cb) {
  _NPM["default"].generateSample(app_name, cb);
};

var _default = Modularizer;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BUEkvTW9kdWxlcy9Nb2R1bGFyaXplci50cyJdLCJuYW1lcyI6WyJNb2R1bGFyaXplciIsImluc3RhbGwiLCJDTEkiLCJtb2R1bGVfbmFtZSIsIm9wdHMiLCJjYiIsInJlcGxhY2UiLCJMT0NBTCIsIklOVEVSTkFMX01PRFVMRVMiLCJoYXNPd25Qcm9wZXJ0eSIsIkNvbW1vbiIsImxvZ01vZCIsImN1cnJlbnRNb2R1bGUiLCJpbnN0YWxsTXVsdGlwbGVNb2R1bGVzIiwiZGVwZW5kZW5jaWVzIiwiTlBNIiwibG9jYWxTdGFydCIsInRhcmJhbGwiLCJ0ZXN0IiwiVEFSIiwibGF1bmNoTW9kdWxlcyIsIm1vZHVsZXMiLCJsaXN0TW9kdWxlcyIsImxhdW5jaE5QTU1vZHVsZXMiLCJucG1fbW9kdWxlcyIsImxhdW5jaFRBUk1vZHVsZXMiLCJPYmplY3QiLCJrZXlzIiwibmV4dCIsInN0YXJ0IiwidGFyX21vZHVsZXMiLCJtb2R1bGVfcGF0aCIsImZ1bGxwYXRoIiwicHJvY2VzcyIsImN3ZCIsInJlcXVpcmUiLCJyZXNvbHZlIiwicGFja2FnZTEiLCJ1bmluc3RhbGwiLCJwcmludE91dCIsImNzdCIsIlBSRUZJWF9NU0dfTU9EIiwibW9kdWxlc19saXN0IiwiZXJyTW9kIiwiZXhpdENsaSIsIkNvbmZpZ3VyYXRpb24iLCJnZXRTeW5jIiwiTU9EVUxFX0NPTkZfUFJFRklYIiwiTU9EVUxFX0NPTkZfUFJFRklYX1RBUiIsImdldEFkZGl0aW9uYWxDb25mIiwiYXBwX25hbWUiLCJnZXRNb2R1bGVDb25mIiwicHVibGlzaCIsIlBNMiIsImZvbGRlciIsIm5wbSIsImdlbmVyYXRlU2FtcGxlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBTUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFkQTs7Ozs7QUFnQkEsSUFBSUEsV0FBZ0IsR0FBRyxFQUF2QjtBQUVBOzs7O0FBR0FBLFdBQVcsQ0FBQ0MsT0FBWixHQUFz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QixFQUE0QkMsRUFBNUIsRUFBZ0M7QUFDcEQsTUFBSUQsSUFBSSxDQUFDbUQsR0FBTCxJQUFZLElBQWhCLEVBQXNCO0FBQ3BCeEMsb0JBQUlxQyxPQUFKLENBQVloRCxJQUFaLEVBQWtCQyxFQUFsQjtBQUNELEdBRkQsTUFHSztBQUNIYyxvQkFBSWlDLE9BQUosQ0FBWUMsR0FBWixFQUFpQkMsTUFBakIsRUFBeUJqRCxFQUF6QjtBQUNEO0FBQ0YsQ0FQRDs7QUFTQUwsV0FBVyxDQUFDd0QsY0FBWixHQUE2QixVQUFTTixRQUFULEVBQW1CN0MsRUFBbkIsRUFBdUI7QUFDbERVLGtCQUFJeUMsY0FBSixDQUFtQk4sUUFBbkIsRUFBNkI3QyxFQUE3QjtBQUNELENBRkQ7O2VBSWVMLFciLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29weXJpZ2h0IDIwMTMgdGhlIFBNMiBwcm9qZWN0IGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgbGljZW5zZSB0aGF0XHJcbiAqIGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLlxyXG4gKi9cclxuaW1wb3J0IHBhdGggICAgICAgICAgZnJvbSAncGF0aCc7XHJcbmltcG9ydCBlYWNoTGltaXQgICAgIGZyb20gJ2FzeW5jL2VhY2hMaW1pdCc7XHJcbmltcG9ydCBmb3JFYWNoTGltaXQgIGZyb20gJ2FzeW5jL2ZvckVhY2hMaW1pdCc7XHJcblxyXG5pbXBvcnQgQ29uZmlndXJhdGlvbiBmcm9tICcuLi8uLi9Db25maWd1cmF0aW9uJztcclxuaW1wb3J0IGNzdCBmcm9tICcuLi8uLi8uLi9jb25zdGFudHMnO1xyXG5pbXBvcnQgQ29tbW9uIGZyb20gJy4uLy4uL0NvbW1vbic7XHJcbmltcG9ydCBOUE0gZnJvbSAnLi9OUE0nO1xyXG5pbXBvcnQgVEFSIGZyb20gJy4vVEFSJztcclxuaW1wb3J0IExPQ0FMIGZyb20gJy4vTE9DQUwnO1xyXG5cclxudmFyIE1vZHVsYXJpemVyOiBhbnkgPSB7fTtcclxuXHJcbi8qKlxyXG4gKiBQTTIgTW9kdWxlIFN5c3RlbS5cclxuICovXHJcbk1vZHVsYXJpemVyLmluc3RhbGwgPSBmdW5jdGlvbiAoQ0xJLCBtb2R1bGVfbmFtZSwgb3B0cywgY2IpIHtcclxuICBtb2R1bGVfbmFtZSA9IG1vZHVsZV9uYW1lLnJlcGxhY2UoL1s7YHxdL2csIFwiXCIpO1xyXG4gIGlmICh0eXBlb2Yob3B0cykgPT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgY2IgPSBvcHRzO1xyXG4gICAgb3B0cyA9IHt9O1xyXG4gIH1cclxuXHJcbiAgaWYgKExPQ0FMLklOVEVSTkFMX01PRFVMRVMuaGFzT3duUHJvcGVydHkobW9kdWxlX25hbWUpKSB7XHJcbiAgICBDb21tb24ubG9nTW9kKGBBZGRpbmcgZGVwZW5kZW5jeSAke21vZHVsZV9uYW1lfSB0byBQTTIgUnVudGltZWApO1xyXG4gICAgdmFyIGN1cnJlbnRNb2R1bGUgPSBMT0NBTC5JTlRFUk5BTF9NT0RVTEVTW21vZHVsZV9uYW1lXTtcclxuICAgIGlmIChjdXJyZW50TW9kdWxlICYmIGN1cnJlbnRNb2R1bGUuaGFzT3duUHJvcGVydHkoJ2RlcGVuZGVuY2llcycpKSB7XHJcbiAgICAgIExPQ0FMLmluc3RhbGxNdWx0aXBsZU1vZHVsZXMoY3VycmVudE1vZHVsZS5kZXBlbmRlbmNpZXMsIGNiKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIExPQ0FMLmluc3RhbGwoY3VycmVudE1vZHVsZSwgY2IpO1xyXG4gICAgfVxyXG4gIH1cclxuICBlbHNlIGlmIChtb2R1bGVfbmFtZSA9PSAnLicpIHtcclxuICAgIENvbW1vbi5sb2dNb2QoYEluc3RhbGxpbmcgbG9jYWwgTlBNIG1vZHVsZWApO1xyXG4gICAgcmV0dXJuIE5QTS5sb2NhbFN0YXJ0KENMSSwgb3B0cywgY2IpXHJcbiAgfVxyXG4gIGVsc2UgaWYgKG9wdHMudGFyYmFsbCB8fCAvXFwudGFyXFwuZ3okL2kudGVzdChtb2R1bGVfbmFtZSkpIHtcclxuICAgIENvbW1vbi5sb2dNb2QoYEluc3RhbGxpbmcgVEFSIG1vZHVsZWApO1xyXG4gICAgVEFSLmluc3RhbGwoQ0xJLCBtb2R1bGVfbmFtZSwgb3B0cywgY2IpXHJcbiAgfVxyXG4gIGVsc2Uge1xyXG4gICAgQ29tbW9uLmxvZ01vZChgSW5zdGFsbGluZyBOUE0gJHttb2R1bGVfbmFtZX0gbW9kdWxlYCk7XHJcbiAgICBOUE0uaW5zdGFsbChDTEksIG1vZHVsZV9uYW1lLCBvcHRzLCBjYilcclxuICB9XHJcbn07XHJcblxyXG4vKipcclxuICogTGF1bmNoIEFsbCBNb2R1bGVzXHJcbiAqIFVzZWQgUE0yIGF0IHN0YXJ0dXBcclxuICovXHJcbk1vZHVsYXJpemVyLmxhdW5jaE1vZHVsZXMgPSBmdW5jdGlvbihDTEksIGNiKSB7XHJcbiAgdmFyIG1vZHVsZXMgPSBNb2R1bGFyaXplci5saXN0TW9kdWxlcygpO1xyXG5cclxuICBpZiAoIW1vZHVsZXMpIHJldHVybiBjYigpO1xyXG5cclxuICAvLyAxI1xyXG4gIGZ1bmN0aW9uIGxhdW5jaE5QTU1vZHVsZXMoY2IpIHtcclxuICAgIGlmICghbW9kdWxlcy5ucG1fbW9kdWxlcykgcmV0dXJuIGxhdW5jaFRBUk1vZHVsZXMoY2IpXHJcblxyXG4gICAgZWFjaExpbWl0KE9iamVjdC5rZXlzKG1vZHVsZXMubnBtX21vZHVsZXMpLCAxLCBmdW5jdGlvbihtb2R1bGVfbmFtZSwgbmV4dCkge1xyXG4gICAgICBOUE0uc3RhcnQoQ0xJLCBtb2R1bGVzLCBtb2R1bGVfbmFtZSwgbmV4dClcclxuICAgIH0sIGZ1bmN0aW9uKCkge1xyXG4gICAgICBsYXVuY2hUQVJNb2R1bGVzKGNiKVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvLyAyI1xyXG4gIGZ1bmN0aW9uIGxhdW5jaFRBUk1vZHVsZXMoY2IpIHtcclxuICAgIGlmICghbW9kdWxlcy50YXJfbW9kdWxlcykgcmV0dXJuIGNiKClcclxuXHJcbiAgICBlYWNoTGltaXQoT2JqZWN0LmtleXMobW9kdWxlcy50YXJfbW9kdWxlcyksIDEsIGZ1bmN0aW9uKG1vZHVsZV9uYW1lLCBuZXh0KSB7XHJcbiAgICAgIFRBUi5zdGFydChDTEksIG1vZHVsZV9uYW1lLCBuZXh0KVxyXG4gICAgfSwgZnVuY3Rpb24oKSB7XHJcbiAgICAgIHJldHVybiBjYiA/IGNiKG51bGwpIDogZmFsc2U7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGxhdW5jaE5QTU1vZHVsZXMoY2IpXHJcbn1cclxuXHJcbk1vZHVsYXJpemVyLnBhY2thZ2UgPSBmdW5jdGlvbihDTEksIG1vZHVsZV9wYXRoLCBjYikge1xyXG4gIHZhciBmdWxscGF0aCA9IHByb2Nlc3MuY3dkKClcclxuICBpZiAobW9kdWxlX3BhdGgpXHJcbiAgICBmdWxscGF0aCA9IHJlcXVpcmUoJ3BhdGgnKS5yZXNvbHZlKG1vZHVsZV9wYXRoKVxyXG4gIFRBUi5wYWNrYWdlMShmdWxscGF0aCwgcHJvY2Vzcy5jd2QoKSwgY2IpXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBVbmluc3RhbGwgbW9kdWxlXHJcbiAqL1xyXG5Nb2R1bGFyaXplci51bmluc3RhbGwgPSBmdW5jdGlvbihDTEksIG1vZHVsZV9uYW1lLCBjYikge1xyXG4gIENvbW1vbi5wcmludE91dChjc3QuUFJFRklYX01TR19NT0QgKyAnVW5pbnN0YWxsaW5nIG1vZHVsZSAnICsgbW9kdWxlX25hbWUpO1xyXG4gIHZhciBtb2R1bGVzX2xpc3QgPSBNb2R1bGFyaXplci5saXN0TW9kdWxlcygpO1xyXG5cclxuICBpZiAobW9kdWxlX25hbWUgPT0gJ2FsbCcpIHtcclxuICAgIGlmICghbW9kdWxlc19saXN0KSByZXR1cm4gY2IoKTtcclxuXHJcbiAgICByZXR1cm4gZm9yRWFjaExpbWl0KE9iamVjdC5rZXlzKG1vZHVsZXNfbGlzdC5ucG1fbW9kdWxlcyksIDEsIGZ1bmN0aW9uKG1vZHVsZV9uYW1lLCBuZXh0KSB7XHJcbiAgICAgIE5QTS51bmluc3RhbGwoQ0xJLCBtb2R1bGVfbmFtZSwgbmV4dClcclxuICAgIH0sICgpID0+IHtcclxuICAgICAgZm9yRWFjaExpbWl0KE9iamVjdC5rZXlzKG1vZHVsZXNfbGlzdC50YXJfbW9kdWxlcyksIDEsIGZ1bmN0aW9uKG1vZHVsZV9uYW1lLCBuZXh0KSB7XHJcbiAgICAgICAgVEFSLnVuaW5zdGFsbChDTEksIG1vZHVsZV9uYW1lLCBuZXh0KVxyXG4gICAgICB9LCBjYilcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgaWYgKG1vZHVsZXNfbGlzdC5ucG1fbW9kdWxlc1ttb2R1bGVfbmFtZV0pIHtcclxuICAgIE5QTS51bmluc3RhbGwoQ0xJLCBtb2R1bGVfbmFtZSwgY2IpXHJcbiAgfSBlbHNlIGlmIChtb2R1bGVzX2xpc3QudGFyX21vZHVsZXNbbW9kdWxlX25hbWVdKSB7XHJcbiAgICBUQVIudW5pbnN0YWxsKENMSSwgbW9kdWxlX25hbWUsIGNiKVxyXG4gIH1cclxuICBlbHNlIHtcclxuICAgIENvbW1vbi5lcnJNb2QoJ1Vua25vd24gbW9kdWxlJylcclxuICAgIENMSS5leGl0Q2xpKDEpXHJcbiAgfVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIExpc3QgbW9kdWxlcyBiYXNlZCBvbiBtb2R1bGVzIHByZXNlbnQgaW4gfi8ucG0yL21vZHVsZXMvIGZvbGRlclxyXG4gKi9cclxuTW9kdWxhcml6ZXIubGlzdE1vZHVsZXMgPSBmdW5jdGlvbigpIHtcclxuICByZXR1cm4ge1xyXG4gICAgbnBtX21vZHVsZXM6IENvbmZpZ3VyYXRpb24uZ2V0U3luYyhjc3QuTU9EVUxFX0NPTkZfUFJFRklYKSB8fCB7fSxcclxuICAgIHRhcl9tb2R1bGVzOiBDb25maWd1cmF0aW9uLmdldFN5bmMoY3N0Lk1PRFVMRV9DT05GX1BSRUZJWF9UQVIpIHx8IHt9XHJcbiAgfVxyXG59O1xyXG5cclxuTW9kdWxhcml6ZXIuZ2V0QWRkaXRpb25hbENvbmYgPSBmdW5jdGlvbihhcHBfbmFtZSkge1xyXG4gIHJldHVybiBOUE0uZ2V0TW9kdWxlQ29uZihhcHBfbmFtZSlcclxufTtcclxuXHJcbk1vZHVsYXJpemVyLnB1Ymxpc2ggPSBmdW5jdGlvbihQTTIsIGZvbGRlciwgb3B0cywgY2IpIHtcclxuICBpZiAob3B0cy5ucG0gPT0gdHJ1ZSkge1xyXG4gICAgTlBNLnB1Ymxpc2gob3B0cywgY2IpXHJcbiAgfVxyXG4gIGVsc2Uge1xyXG4gICAgVEFSLnB1Ymxpc2goUE0yLCBmb2xkZXIsIGNiKVxyXG4gIH1cclxufTtcclxuXHJcbk1vZHVsYXJpemVyLmdlbmVyYXRlU2FtcGxlID0gZnVuY3Rpb24oYXBwX25hbWUsIGNiKSB7XHJcbiAgTlBNLmdlbmVyYXRlU2FtcGxlKGFwcF9uYW1lLCBjYilcclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IE1vZHVsYXJpemVyO1xyXG4iXX0=
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _Common = _interopRequireDefault(require("../Common"));

var _constants = _interopRequireDefault(require("../../constants"));

var _UX = _interopRequireDefault(require("./UX"));

var _chalk = _interopRequireDefault(require("chalk"));

var _Configuration = _interopRequireDefault(require("../Configuration"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _default(CLI) {
  CLI.prototype.get = function (key, cb) {
    var that = this;

    if (!key || key == 'all') {
      displayConf(function (err, data) {
        if (err) return cb ? cb(_Common["default"].retErr(err)) : that.exitCli(_constants["default"].ERROR_EXIT);
        return cb ? cb(null, {
          success: true
        }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
      });
      return false;
    }

    _Configuration["default"].get(key, function (err, data) {
      if (err) {
        return cb ? cb(_Common["default"].retErr(err)) : that.exitCli(_constants["default"].ERROR_EXIT);
      } // pm2 conf module-name


      if (key.indexOf(':') === -1 && key.indexOf('.') === -1) {
        displayConf(key, function () {
          console.log('Modules configuration. Copy/Paste line to edit values.');
          return cb ? cb(null, {
            success: true
          }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
        });
        return false;
      } // pm2 conf module-name:key


      var module_name, key_name;

      if (key.indexOf(':') > -1) {
        module_name = key.split(':')[0];
        key_name = key.split(':')[1];
      } else if (key.indexOf('.') > -1) {
        module_name = key.split('.')[0];
        key_name = key.split('.')[1];
      }

      _Common["default"].printOut('Value for module ' + _chalk["default"].blue(module_name), 'key ' + _chalk["default"].blue(key_name) + ': ' + _chalk["default"].bold.green(data));

      return cb ? cb(null, {
        success: true
      }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
    });
  };

  CLI.prototype.set = function (key, value, cb) {
    var that = this;

    if (!key) {
      interactiveConfigEdit(function (err) {
        if (err) return cb ? cb(_Common["default"].retErr(err)) : that.exitCli(_constants["default"].ERROR_EXIT);
        return cb ? cb(null, {
          success: true
        }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
      });
      return false;
    }
    /**
     * Set value
     */


    _Configuration["default"].set(key, value, function (err) {
      if (err) return cb ? cb(_Common["default"].retErr(err)) : that.exitCli(_constants["default"].ERROR_EXIT);
      var values = [];
      if (key.indexOf('.') > -1) values = key.split('.');
      if (key.indexOf(':') > -1) values = key.split(':');

      if (values && values.length > 1) {
        // The first element is the app name (module_conf.json)
        var app_name = values[0];
        process.env.PM2_PROGRAMMATIC = 'true';
        that.restart(app_name, {
          updateEnv: true
        }, function (err, data) {
          process.env.PM2_PROGRAMMATIC = 'false';
          if (!err) _Common["default"].printOut(_constants["default"].PREFIX_MSG + 'Module %s restarted', app_name);

          _Common["default"].log('Setting changed');

          displayConf(app_name, function () {
            return cb ? cb(null, {
              success: true
            }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
          });
        });
        return false;
      }

      displayConf(null, function () {
        return cb ? cb(null, {
          success: true
        }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
      });
    });
  };

  CLI.prototype.multiset = function (serial, cb) {
    var that = this;

    _Configuration["default"].multiset(serial, function (err, data) {
      if (err) return cb ? cb({
        success: false,
        err: err
      }) : that.exitCli(_constants["default"].ERROR_EXIT);
      var values = [];
      var key = serial.match(/(?:[^ "]+|"[^"]*")+/g)[0];
      if (key.indexOf('.') > -1) values = key.split('.');
      if (key.indexOf(':') > -1) values = key.split(':');

      if (values && values.length > 1) {
        // The first element is the app name (module_conf.json)
        var app_name = values[0];
        process.env.PM2_PROGRAMMATIC = 'true';
        that.restart(app_name, {
          updateEnv: true
        }, function (err, data) {
          process.env.PM2_PROGRAMMATIC = 'false';
          if (!err) _Common["default"].printOut(_constants["default"].PREFIX_MSG + 'Module %s restarted', app_name);
          displayConf(app_name, function () {
            return cb ? cb(null, {
              success: true
            }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
          });
        });
        return false;
      }

      displayConf(app_name, function () {
        return cb ? cb(null, {
          success: true
        }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
      });
    });
  };

  CLI.prototype.unset = function (key, cb) {
    var that = this;

    _Configuration["default"].unset(key, function (err) {
      if (err) {
        return cb ? cb(_Common["default"].retErr(err)) : that.exitCli(_constants["default"].ERROR_EXIT);
      }

      displayConf(function () {
        cb ? cb(null, {
          success: true
        }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
      });
    });
  };

  CLI.prototype.conf = function (key, value, cb) {
    var that = this;

    if (typeof value === 'function') {
      cb = value;
      value = null;
    } // If key + value = set


    if (key && value) {
      that.set(key, value, function (err) {
        if (err) return cb ? cb(_Common["default"].retErr(err)) : that.exitCli(_constants["default"].ERROR_EXIT);
        return cb ? cb(null, {
          success: true
        }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
      });
    } // If only key = get
    else if (key) {
        that.get(key, function (err, data) {
          if (err) return cb ? cb(_Common["default"].retErr(err)) : that.exitCli(_constants["default"].ERROR_EXIT);
          return cb ? cb(null, {
            success: true
          }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
        });
      } else {
        interactiveConfigEdit(function (err) {
          if (err) return cb ? cb(_Common["default"].retErr(err)) : that.exitCli(_constants["default"].ERROR_EXIT);
          return cb ? cb(null, {
            success: true
          }) : that.exitCli(_constants["default"].SUCCESS_EXIT);
        });
      }
  };
}

;

function interactiveConfigEdit(cb) {
  _UX["default"].helpers.openEditor(_constants["default"].PM2_MODULE_CONF_FILE, function (err, data) {
    _Common["default"].printOut(_chalk["default"].bold('Module configuration (%s) edited.'), _constants["default"].PM2_MODULE_CONF_FILE);

    _Common["default"].printOut(_chalk["default"].bold('To take changes into account, please restart module related.'), _constants["default"].PM2_MODULE_CONF_FILE);

    if (err) return cb(_Common["default"].retErr(err));
    return cb(null, {
      success: true
    });
  });
}
/**
 * Configuration
 */


function displayConf(target_app, cb) {
  if (typeof target_app == 'function') {
    cb = target_app;
    target_app = null;
  }

  _Configuration["default"].getAll(function (err, data) {
    _UX["default"].helpers.dispKeys(data, target_app);

    return cb();
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BUEkvQ29uZmlndXJhdGlvbi50cyJdLCJuYW1lcyI6WyJDTEkiLCJwcm90b3R5cGUiLCJnZXQiLCJrZXkiLCJjYiIsInRoYXQiLCJkaXNwbGF5Q29uZiIsImVyciIsImRhdGEiLCJDb21tb24iLCJyZXRFcnIiLCJleGl0Q2xpIiwiY3N0IiwiRVJST1JfRVhJVCIsInN1Y2Nlc3MiLCJTVUNDRVNTX0VYSVQiLCJDb25maWd1cmF0aW9uIiwiaW5kZXhPZiIsImNvbnNvbGUiLCJsb2ciLCJtb2R1bGVfbmFtZSIsImtleV9uYW1lIiwic3BsaXQiLCJwcmludE91dCIsImNoYWxrIiwiYmx1ZSIsImJvbGQiLCJncmVlbiIsInNldCIsInZhbHVlIiwiaW50ZXJhY3RpdmVDb25maWdFZGl0IiwidmFsdWVzIiwibGVuZ3RoIiwiYXBwX25hbWUiLCJwcm9jZXNzIiwiZW52IiwiUE0yX1BST0dSQU1NQVRJQyIsInJlc3RhcnQiLCJ1cGRhdGVFbnYiLCJQUkVGSVhfTVNHIiwibXVsdGlzZXQiLCJzZXJpYWwiLCJtYXRjaCIsInVuc2V0IiwiY29uZiIsIlVYIiwiaGVscGVycyIsIm9wZW5FZGl0b3IiLCJQTTJfTU9EVUxFX0NPTkZfRklMRSIsInRhcmdldF9hcHAiLCJnZXRBbGwiLCJkaXNwS2V5cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRWUsa0JBQVNBLEdBQVQsRUFBYztBQUUzQkEsRUFBQUEsR0FBRyxDQUFDQyxTQUFKLENBQWNDLEdBQWQsR0FBb0IsVUFBU0MsR0FBVCxFQUFjQyxFQUFkLEVBQWtCO0FBQ3BDLFFBQUlDLElBQUksR0FBRyxJQUFYOztBQUVBLFFBQUksQ0FBQ0YsR0FBRCxJQUFRQSxHQUFHLElBQUksS0FBbkIsRUFBMEI7QUFDeEJHLE1BQUFBLFdBQVcsQ0FBQyxVQUFTQyxHQUFULEVBQWNDLElBQWQsRUFBb0I7QUFDOUIsWUFBSUQsR0FBSixFQUNFLE9BQU9ILEVBQUUsR0FB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RUFBakMsRUFBc0M7QUFDcEMsTUFBSSxPQUFPNkMsVUFBUCxJQUFzQixVQUExQixFQUFzQztBQUNwQzdDLElBQUFBLEVBQUUsR0FBRzZDLFVBQUw7QUFDQUEsSUFBQUEsVUFBVSxHQUFHLElBQWI7QUFDRDs7QUFFRGpDLDRCQUFja0MsTUFBZCxDQUFxQixVQUFTM0MsR0FBVCxFQUFjQyxJQUFkLEVBQW9CO0FBQ3ZDcUMsbUJBQUdDLE9BQUgsQ0FBV0ssUUFBWCxDQUFvQjNDLElBQXBCLEVBQTBCeUMsVUFBMUI7O0FBQ0EsV0FBTzdDLEVBQUUsRUFBVDtBQUNELEdBSEQ7QUFJRCIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgQ29tbW9uICAgICAgICAgICAgICAgZnJvbSAnLi4vQ29tbW9uJztcclxuaW1wb3J0IGNzdCAgICAgICAgICAgICAgICAgIGZyb20gJy4uLy4uL2NvbnN0YW50cyc7XHJcbmltcG9ydCBVWCAgICAgICAgICAgICAgICAgICBmcm9tICcuL1VYJztcclxuaW1wb3J0IGNoYWxrICAgICAgICAgICAgICAgIGZyb20gJ2NoYWxrJztcclxuaW1wb3J0IENvbmZpZ3VyYXRpb24gICAgICAgIGZyb20gJy4uL0NvbmZpZ3VyYXRpb24nO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24oQ0xJKSB7XHJcblxyXG4gIENMSS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24oa2V5LCBjYikge1xyXG4gICAgdmFyIHRoYXQgPSB0aGlzO1xyXG5cclxuICAgIGlmICgha2V5IHx8IGtleSA9PSAnYWxsJykge1xyXG4gICAgICBkaXNwbGF5Q29uZihmdW5jdGlvbihlcnIsIGRhdGEpIHtcclxuICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgcmV0dXJuIGNiID8gY2IoQ29tbW9uLnJldEVycihlcnIpKSA6IHRoYXQuZXhpdENsaShjc3QuRVJST1JfRVhJVCk7XHJcbiAgICAgICAgcmV0dXJuIGNiID8gY2IobnVsbCwge3N1Y2Nlc3M6dHJ1ZX0pIDogdGhhdC5leGl0Q2xpKGNzdC5TVUNDRVNTX0VYSVQpO1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgQ29uZmlndXJhdGlvbi5nZXQoa2V5LCBmdW5jdGlvbihlcnIsIGRhdGEpIHtcclxuICAgICAgaWYgKGVycikge1xyXG4gICAgICAgIHJldHVybiBjYiA/IGNiKENvbW1vbi5yZXRFcnIoZXJyKSkgOiB0aGF0LmV4aXRDbGkoY3N0LkVSUk9SX0VYSVQpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIHBtMiBjb25mIG1vZHVsZS1uYW1lXHJcbiAgICAgIGlmIChrZXkuaW5kZXhPZignOicpID09PSAtMSAmJiBrZXkuaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICAgIGRpc3BsYXlDb25mKGtleSwgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnTW9kdWxlcyBjb25maWd1cmF0aW9uLiBDb3B5L1Bhc3RlIGxpbmUgdG8gZWRpdCB2YWx1ZXMuJylcclxuICAgICAgICAgIHJldHVybiBjYiA/IGNiKG51bGwsIHtzdWNjZXNzOnRydWV9KSA6IHRoYXQuZXhpdENsaShjc3QuU1VDQ0VTU19FWElUKVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICAvLyBwbTIgY29uZiBtb2R1bGUtbmFtZTprZXlcclxuICAgICAgdmFyIG1vZHVsZV9uYW1lLCBrZXlfbmFtZTtcclxuXHJcbiAgICAgIGlmIChrZXkuaW5kZXhPZignOicpID4gLTEpIHtcclxuICAgICAgICBtb2R1bGVfbmFtZSA9IGtleS5zcGxpdCgnOicpWzBdO1xyXG4gICAgICAgIGtleV9uYW1lICAgID0ga2V5LnNwbGl0KCc6JylbMV07XHJcbiAgICAgIH0gZWxzZSBpZiAoa2V5LmluZGV4T2YoJy4nKSA+IC0xKSB7XHJcbiAgICAgICAgbW9kdWxlX25hbWUgPSBrZXkuc3BsaXQoJy4nKVswXTtcclxuICAgICAgICBrZXlfbmFtZSAgICA9IGtleS5zcGxpdCgnLicpWzFdO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBDb21tb24ucHJpbnRPdXQoJ1ZhbHVlIGZvciBtb2R1bGUgJyArIGNoYWxrLmJsdWUobW9kdWxlX25hbWUpLCAna2V5ICcgKyBjaGFsay5ibHVlKGtleV9uYW1lKSArICc6ICcgKyBjaGFsay5ib2xkLmdyZWVuKGRhdGEpKTtcclxuXHJcblxyXG4gICAgICByZXR1cm4gY2IgPyBjYihudWxsLCB7c3VjY2Vzczp0cnVlfSkgOiB0aGF0LmV4aXRDbGkoY3N0LlNVQ0NFU1NfRVhJVCk7XHJcbiAgICB9KTtcclxuICB9O1xyXG5cclxuICBDTEkucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIGNiKSB7XHJcbiAgICB2YXIgdGhhdCA9IHRoaXM7XHJcblxyXG4gICAgaWYgKCFrZXkpIHtcclxuICAgICAgaW50ZXJhY3RpdmVDb25maWdFZGl0KGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgICByZXR1cm4gY2IgPyBjYihDb21tb24ucmV0RXJyKGVycikpIDogdGhhdC5leGl0Q2xpKGNzdC5FUlJPUl9FWElUKTtcclxuICAgICAgICByZXR1cm4gY2IgPyBjYihudWxsLCB7c3VjY2Vzczp0cnVlfSkgOiB0aGF0LmV4aXRDbGkoY3N0LlNVQ0NFU1NfRVhJVCk7XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTZXQgdmFsdWVcclxuICAgICAqL1xyXG4gICAgQ29uZmlndXJhdGlvbi5zZXQoa2V5LCB2YWx1ZSwgZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgcmV0dXJuIGNiID8gY2IoQ29tbW9uLnJldEVycihlcnIpKSA6IHRoYXQuZXhpdENsaShjc3QuRVJST1JfRVhJVCk7XHJcblxyXG4gICAgICB2YXIgdmFsdWVzID0gW107XHJcblxyXG4gICAgICBpZiAoa2V5LmluZGV4T2YoJy4nKSA+IC0xKVxyXG4gICAgICAgIHZhbHVlcyA9IGtleS5zcGxpdCgnLicpO1xyXG5cclxuICAgICAgaWYgKGtleS5pbmRleE9mKCc6JykgPiAtMSlcclxuICAgICAgICB2YWx1ZXMgPSBrZXkuc3BsaXQoJzonKTtcclxuXHJcbiAgICAgIGlmICh2YWx1ZXMgJiYgdmFsdWVzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAvLyBUaGUgZmlyc3QgZWxlbWVudCBpcyB0aGUgYXBwIG5hbWUgKG1vZHVsZV9jb25mLmpzb24pXHJcbiAgICAgICAgdmFyIGFwcF9uYW1lID0gdmFsdWVzWzBdO1xyXG5cclxuICAgICAgICBwcm9jZXNzLmVudi5QTTJfUFJPR1JBTU1BVElDID0gJ3RydWUnO1xyXG4gICAgICAgIHRoYXQucmVzdGFydChhcHBfbmFtZSwge1xyXG4gICAgICAgICAgdXBkYXRlRW52IDogdHJ1ZVxyXG4gICAgICAgIH0sIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xyXG4gICAgICAgICAgcHJvY2Vzcy5lbnYuUE0yX1BST0dSQU1NQVRJQyA9ICdmYWxzZSc7XHJcbiAgICAgICAgICBpZiAoIWVycilcclxuICAgICAgICAgICAgQ29tbW9uLnByaW50T3V0KGNzdC5QUkVGSVhfTVNHICsgJ01vZHVsZSAlcyByZXN0YXJ0ZWQnLCBhcHBfbmFtZSk7XHJcbiAgICAgICAgICBDb21tb24ubG9nKCdTZXR0aW5nIGNoYW5nZWQnKVxyXG4gICAgICAgICAgZGlzcGxheUNvbmYoYXBwX25hbWUsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gY2IgPyBjYihudWxsLCB7c3VjY2Vzczp0cnVlfSkgOiB0aGF0LmV4aXRDbGkoY3N0LlNVQ0NFU1NfRVhJVCk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgZGlzcGxheUNvbmYobnVsbCwgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIGNiID8gY2IobnVsbCwge3N1Y2Nlc3M6dHJ1ZX0pIDogdGhhdC5leGl0Q2xpKGNzdC5TVUNDRVNTX0VYSVQpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG4gIENMSS5wcm90b3R5cGUubXVsdGlzZXQgPSBmdW5jdGlvbihzZXJpYWwsIGNiKSB7XHJcbiAgICB2YXIgdGhhdCA9IHRoaXM7XHJcblxyXG4gICAgQ29uZmlndXJhdGlvbi5tdWx0aXNldChzZXJpYWwsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xyXG4gICAgICBpZiAoZXJyKVxyXG4gICAgICAgIHJldHVybiBjYiA/IGNiKHtzdWNjZXNzOmZhbHNlLCBlcnI6ZXJyfSkgOiB0aGF0LmV4aXRDbGkoY3N0LkVSUk9SX0VYSVQpO1xyXG5cclxuICAgICAgdmFyIHZhbHVlcyA9IFtdO1xyXG4gICAgICB2YXIga2V5ID0gc2VyaWFsLm1hdGNoKC8oPzpbXiBcIl0rfFwiW15cIl0qXCIpKy9nKVswXTtcclxuXHJcbiAgICAgIGlmIChrZXkuaW5kZXhPZignLicpID4gLTEpXHJcbiAgICAgICAgdmFsdWVzID0ga2V5LnNwbGl0KCcuJyk7XHJcblxyXG4gICAgICBpZiAoa2V5LmluZGV4T2YoJzonKSA+IC0xKVxyXG4gICAgICAgIHZhbHVlcyA9IGtleS5zcGxpdCgnOicpO1xyXG5cclxuICAgICAgaWYgKHZhbHVlcyAmJiB2YWx1ZXMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgIC8vIFRoZSBmaXJzdCBlbGVtZW50IGlzIHRoZSBhcHAgbmFtZSAobW9kdWxlX2NvbmYuanNvbilcclxuICAgICAgICB2YXIgYXBwX25hbWUgPSB2YWx1ZXNbMF07XHJcblxyXG4gICAgICAgIHByb2Nlc3MuZW52LlBNMl9QUk9HUkFNTUFUSUMgPSAndHJ1ZSc7XHJcbiAgICAgICAgdGhhdC5yZXN0YXJ0KGFwcF9uYW1lLCB7XHJcbiAgICAgICAgICB1cGRhdGVFbnYgOiB0cnVlXHJcbiAgICAgICAgfSwgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XHJcbiAgICAgICAgICBwcm9jZXNzLmVudi5QTTJfUFJPR1JBTU1BVElDID0gJ2ZhbHNlJztcclxuICAgICAgICAgIGlmICghZXJyKVxyXG4gICAgICAgICAgICBDb21tb24ucHJpbnRPdXQoY3N0LlBSRUZJWF9NU0cgKyAnTW9kdWxlICVzIHJlc3RhcnRlZCcsIGFwcF9uYW1lKTtcclxuICAgICAgICAgIGRpc3BsYXlDb25mKGFwcF9uYW1lLCBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNiID8gY2IobnVsbCwge3N1Y2Nlc3M6dHJ1ZX0pIDogdGhhdC5leGl0Q2xpKGNzdC5TVUNDRVNTX0VYSVQpXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgZGlzcGxheUNvbmYoYXBwX25hbWUsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiBjYiA/IGNiKG51bGwsIHtzdWNjZXNzOnRydWV9KSA6IHRoYXQuZXhpdENsaShjc3QuU1VDQ0VTU19FWElUKVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG4gIENMSS5wcm90b3R5cGUudW5zZXQgPSBmdW5jdGlvbihrZXksIGNiKSB7XHJcbiAgICB2YXIgdGhhdCA9IHRoaXM7XHJcblxyXG4gICAgQ29uZmlndXJhdGlvbi51bnNldChrZXksIGZ1bmN0aW9uKGVycikge1xyXG4gICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgcmV0dXJuIGNiID8gY2IoQ29tbW9uLnJldEVycihlcnIpKSA6IHRoYXQuZXhpdENsaShjc3QuRVJST1JfRVhJVCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGRpc3BsYXlDb25mKGZ1bmN0aW9uKCkgeyBjYiA/IGNiKG51bGwsIHtzdWNjZXNzOnRydWV9KSA6IHRoYXQuZXhpdENsaShjc3QuU1VDQ0VTU19FWElUKSB9KTtcclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG4gIENMSS5wcm90b3R5cGUuY29uZiA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIGNiKSB7XHJcbiAgICB2YXIgdGhhdCA9IHRoaXM7XHJcblxyXG4gICAgaWYgKHR5cGVvZih2YWx1ZSkgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgY2IgPSB2YWx1ZTtcclxuICAgICAgdmFsdWUgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIElmIGtleSArIHZhbHVlID0gc2V0XHJcbiAgICBpZiAoa2V5ICYmIHZhbHVlKSB7XHJcbiAgICAgIHRoYXQuc2V0KGtleSwgdmFsdWUsIGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgICByZXR1cm4gY2IgPyBjYihDb21tb24ucmV0RXJyKGVycikpIDogdGhhdC5leGl0Q2xpKGNzdC5FUlJPUl9FWElUKTtcclxuICAgICAgICByZXR1cm4gY2IgPyBjYihudWxsLCB7c3VjY2Vzczp0cnVlfSkgOiB0aGF0LmV4aXRDbGkoY3N0LlNVQ0NFU1NfRVhJVCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy8gSWYgb25seSBrZXkgPSBnZXRcclxuICAgIGVsc2UgaWYgKGtleSkge1xyXG4gICAgICB0aGF0LmdldChrZXksIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xyXG4gICAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgICByZXR1cm4gY2IgPyBjYihDb21tb24ucmV0RXJyKGVycikpIDogdGhhdC5leGl0Q2xpKGNzdC5FUlJPUl9FWElUKTtcclxuICAgICAgICByZXR1cm4gY2IgPyBjYihudWxsLCB7c3VjY2Vzczp0cnVlfSkgOiB0aGF0LmV4aXRDbGkoY3N0LlNVQ0NFU1NfRVhJVCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGludGVyYWN0aXZlQ29uZmlnRWRpdChmdW5jdGlvbihlcnIpIHtcclxuICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgcmV0dXJuIGNiID8gY2IoQ29tbW9uLnJldEVycihlcnIpKSA6IHRoYXQuZXhpdENsaShjc3QuRVJST1JfRVhJVCk7XHJcbiAgICAgICAgcmV0dXJuIGNiID8gY2IobnVsbCwge3N1Y2Nlc3M6dHJ1ZX0pIDogdGhhdC5leGl0Q2xpKGNzdC5TVUNDRVNTX0VYSVQpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9O1xyXG5cclxufTtcclxuXHJcbmZ1bmN0aW9uIGludGVyYWN0aXZlQ29uZmlnRWRpdChjYikge1xyXG4gIFVYLmhlbHBlcnMub3BlbkVkaXRvcihjc3QuUE0yX01PRFVMRV9DT05GX0ZJTEUsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xyXG4gICAgQ29tbW9uLnByaW50T3V0KGNoYWxrLmJvbGQoJ01vZHVsZSBjb25maWd1cmF0aW9uICglcykgZWRpdGVkLicpLCBjc3QuUE0yX01PRFVMRV9DT05GX0ZJTEUpO1xyXG4gICAgQ29tbW9uLnByaW50T3V0KGNoYWxrLmJvbGQoJ1RvIHRha2UgY2hhbmdlcyBpbnRvIGFjY291bnQsIHBsZWFzZSByZXN0YXJ0IG1vZHVsZSByZWxhdGVkLicpLCBjc3QuUE0yX01PRFVMRV9DT05GX0ZJTEUpO1xyXG4gICAgaWYgKGVycilcclxuICAgICAgcmV0dXJuIGNiKENvbW1vbi5yZXRFcnIoZXJyKSk7XHJcbiAgICByZXR1cm4gY2IobnVsbCwge3N1Y2Nlc3M6dHJ1ZX0pO1xyXG4gIH0pO1xyXG5cclxufVxyXG5cclxuLyoqXHJcbiAqIENvbmZpZ3VyYXRpb25cclxuICovXHJcbmZ1bmN0aW9uIGRpc3BsYXlDb25mKHRhcmdldF9hcHAsIGNiPykge1xyXG4gIGlmICh0eXBlb2YodGFyZ2V0X2FwcCkgPT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgY2IgPSB0YXJnZXRfYXBwO1xyXG4gICAgdGFyZ2V0X2FwcCA9IG51bGw7XHJcbiAgfVxyXG5cclxuICBDb25maWd1cmF0aW9uLmdldEFsbChmdW5jdGlvbihlcnIsIGRhdGEpIHtcclxuICAgIFVYLmhlbHBlcnMuZGlzcEtleXMoZGF0YSwgdGFyZ2V0X2FwcCk7XHJcbiAgICByZXR1cm4gY2IoKTtcclxuICB9KTtcclxufVxyXG4iXX0=
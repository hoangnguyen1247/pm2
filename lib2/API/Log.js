"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _util = _interopRequireDefault(require("util"));

var _chalk = _interopRequireDefault(require("chalk"));

var _forEachLimit = _interopRequireDefault(require("async/forEachLimit"));

var _dayjs = _interopRequireDefault(require("dayjs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
var Log = {};
var DEFAULT_PADDING = '          ';
/**
 * Tail logs from file stream.
 * @param {Object} apps_list
 * @param {Number} lines
 * @param {Boolean} raw
 * @param {Function} callback
 * @return
 */

Log.tail = function (apps_list, lines, raw, callback) {
  var that = this;
  if (lines === 0 || apps_list.length === 0) return callback && callback();
  var count = 0;

  var getLastLines = function getLastLines(filename, lines, callback) {
    var chunk = '';
    var size = Math.max(0, _fs["default"].statSync(filename).size - lines * 200);
    var chunkArr;

    var fd = _fs["default"].createReadStream(filename, {
      start: size
    });

    fd.on('data', function (data) {
      chunk += data.toString();
    });
    fd.on('end', function () {
      chunkArr = chunk.split('\n').slice(-(lines + 1));
      chunkArr.pop();
      callback(chunkArr);
    });
  };

  apps_list.sort(function (a, b) {
    return (_fs["default"].existsSync(a.path) ? _fs["default"].statSync(a.path).mtime.valueOf() : 0) - (_fs["default"].existsSync(b.path) ? _fs["default"].statSync(b.path).mtime.valueOf() : 0);
  });
  (0, _forEachLimit["default"])(apps_list, 1, function (app, next) {
    if (!_fs["default"].existsSync(app.path || '')) return next();
    getLastLines(app.path, lines, function (output) {
      console.log(_chalk["default"].grey('%s last %d lines:'), app.path, lines);
      output.forEach(function (out) {
        if (raw) return app.type === 'err' ? console.error(out) : console.log(out);
        if (app.type === 'out') process.stdout.write(_chalk["default"].green(pad(DEFAULT_PADDING, app.app_name) + ' | '));else if (app.type === 'err') process.stdout.write(_chalk["default"].red(pad(DEFAULT_PADDING, app.app_name) + ' | '));else process.stdout.write(_chalk["default"].blue(pad(DEFAULT_PADDING, 'PM2') + ' | '));
        console.log(out);
      });
      if (output.length) process.stdout.write('\n');
      next();
    });
  }, function () {
    callback && callback();
  });
};
/**
 * Stream logs in realtime from the bus eventemitter.
 * @param {String} id
 * @param {Boolean} raw
 * @return
 */


Log.stream = function (Client, id, raw, timestamp, exclusive, highlight) {
  var that = this;
  Client.launchBus(function (err, bus, socket) {
    socket.on('reconnect attempt', function () {
      if (global._auto_exit === true) {
        if (timestamp) process.stdout.write(_chalk["default"]['dim'](_chalk["default"].grey((0, _dayjs["default"])().format(timestamp) + ' ')));
        process.stdout.write(_chalk["default"].blue(pad(DEFAULT_PADDING, 'PM2') + ' | ') + '[[[ Target PM2 killed. ]]]');
        process.exit(0);
      }
    });
    var min_padding = 3;
    bus.on('log:*', function (type, packet) {
      if (id !== 'all' && packet.process.name != id && packet.process.pm_id != id) return;
      if (type === 'out' && exclusive === 'err' || type === 'err' && exclusive === 'out' || type === 'PM2' && exclusive !== false) return;
      var lines;
      if (typeof packet.data === 'string') lines = (packet.data || '').split('\n');else return;
      lines.forEach(function (line) {
        if (!line || line.length === 0) return;
        if (raw) return type === 'err' ? process.stderr.write(_util["default"].format(line) + '\n') : process.stdout.write(_util["default"].format(line) + '\n');
        if (timestamp) process.stdout.write(_chalk["default"]['dim'](_chalk["default"].grey((0, _dayjs["default"])().format(timestamp) + ' ')));
        var name = packet.process.pm_id + '|' + packet.process.name;
        if (name.length > min_padding) min_padding = name.length + 1;
        if (type === 'out') process.stdout.write(_chalk["default"].green(pad(' '.repeat(min_padding), name) + ' | '));else if (type === 'err') process.stdout.write(_chalk["default"].red(pad(' '.repeat(min_padding), name) + ' | '));else if (!raw && (id === 'all' || id === 'PM2')) process.stdout.write(_chalk["default"].blue(pad(' '.repeat(min_padding), 'PM2') + ' | '));
        if (highlight) process.stdout.write(_util["default"].format(line).replace(highlight, _chalk["default"].bgBlackBright(highlight)) + '\n');else process.stdout.write(_util["default"].format(line) + '\n');
      });
    });
  });
};

Log.devStream = function (Client, id, raw, timestamp, exclusive) {
  var that = this;
  Client.launchBus(function (err, bus) {
    setTimeout(function () {
      bus.on('process:event', function (packet) {
        if (packet.event == 'online') console.log(_chalk["default"].green('[rundev] App %s restarted'), packet.process.name);
      });
    }, 1000);
    var min_padding = 3;
    bus.on('log:*', function (type, packet) {
      if (id !== 'all' && packet.process.name != id && packet.process.pm_id != id) return;
      if (type === 'out' && exclusive === 'err' || type === 'err' && exclusive === 'out' || type === 'PM2' && exclusive !== false) return;
      if (type === 'PM2') return;
      var name = packet.process.pm_id + '|' + packet.process.name;
      var lines;
      if (typeof packet.data === 'string') lines = (packet.data || '').split('\n');else return;
      lines.forEach(function (line) {
        if (!line || line.length === 0) return;
        if (raw) return process.stdout.write(_util["default"].format(line) + '\n');
        if (timestamp) process.stdout.write(_chalk["default"]['dim'](_chalk["default"].grey((0, _dayjs["default"])().format(timestamp) + ' ')));
        var name = packet.process.name + '-' + packet.process.pm_id;
        if (name.length > min_padding) min_padding = name.length + 1;
        if (type === 'out') process.stdout.write(_chalk["default"].green(pad(' '.repeat(min_padding), name) + ' | '));else if (type === 'err') process.stdout.write(_chalk["default"].red(pad(' '.repeat(min_padding), name) + ' | '));else if (!raw && (id === 'all' || id === 'PM2')) process.stdout.write(_chalk["default"].blue(pad(' '.repeat(min_padding), 'PM2') + ' | '));
        process.stdout.write(_util["default"].format(line) + '\n');
      });
    });
  });
};

Log.jsonStream = function (Client, id) {
  var that = this;
  Client.launchBus(function (err, bus) {
    if (err) console.error(err);
    bus.on('process:event', function (packet) {
      process.stdout.write(JSON.stringify({
        timestamp: (0, _dayjs["default"])(packet.at),
        type: 'process_event',
        status: packet.event,
        app_name: packet.process.name
      }));
      process.stdout.write('\n');
    });
    bus.on('log:*', function (type, packet) {
      if (id !== 'all' && packet.process.name != id && packet.process.pm_id != id) return;
      if (type === 'PM2') return;
      if (typeof packet.data == 'string') packet.data = packet.data.replace(/(\r\n|\n|\r)/gm, '');
      process.stdout.write(JSON.stringify({
        message: packet.data,
        timestamp: (0, _dayjs["default"])(packet.at),
        type: type,
        process_id: packet.process.pm_id,
        app_name: packet.process.name
      }));
      process.stdout.write('\n');
    });
  });
};

Log.formatStream = function (Client, id, raw, timestamp, exclusive, highlight) {
  var that = this;
  Client.launchBus(function (err, bus) {
    bus.on('log:*', function (type, packet) {
      if (id !== 'all' && packet.process.name != id && packet.process.pm_id != id) return;
      if (type === 'out' && exclusive === 'err' || type === 'err' && exclusive === 'out' || type === 'PM2' && exclusive !== false) return;
      if (type === 'PM2' && raw) return;
      var name = packet.process.name + '-' + packet.process.pm_id;
      var lines;
      if (typeof packet.data === 'string') lines = (packet.data || '').split('\n');else return;
      lines.forEach(function (line) {
        if (!line || line.length === 0) return;

        if (!raw) {
          if (timestamp) process.stdout.write('timestamp=' + (0, _dayjs["default"])().format(timestamp) + ' ');
          if (packet.process.name === 'PM2') process.stdout.write('app=pm2 ');
          if (packet.process.name !== 'PM2') process.stdout.write('app=' + packet.process.name + ' id=' + packet.process.pm_id + ' ');
          if (type === 'out') process.stdout.write('type=out ');else if (type === 'err') process.stdout.write('type=error ');
        }

        process.stdout.write('message=');
        if (highlight) process.stdout.write(_util["default"].format(line).replace(highlight, _chalk["default"].bgBlackBright(highlight)) + '\n');else process.stdout.write(_util["default"].format(line) + '\n');
      });
    });
  });
};

function pad(pad, str, padLeft) {
  if (typeof str === 'undefined') return pad;

  if (padLeft) {
    return (pad + str).slice(-pad.length);
  } else {
    return (str + pad).substring(0, pad.length);
  }
}

var _default = Log;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BUEkvTG9nLnRzIl0sIm5hbWVzIjpbIkxvZyIsIkRFRkFVTFRfUEFERElORyIsInRhaWwiLCJhcHBzX2xpc3QiLCJsaW5lcyIsInJhdyIsImNhbGxiYWNrIiwidGhhdCIsImxlbmd0aCIsImNvdW50IiwiZ2V0TGFzdExpbmVzIiwiZmlsZW5hbWUiLCJjaHVuayIsInNpemUiLCJNYXRoIiwibWF4IiwiZnMiLCJzdGF0U3luYyIsImNodW5rQXJyIiwiZmQiLCJjcmVhdGVSZWFkU3RyZWFtIiwic3RhcnQiLCJvbiIsImRhdGEiLCJ0b1N0cmluZyIsInNwbGl0Iiwic2xpY2UiLCJwb3AiLCJzb3J0IiwiYSIsImIiLCJleGlzdHNTeW5jIiwicGF0aCIsIm10aW1lIiwidmFsdWVPZiIsImFwcCIsIm5leHQiLCJvdXRwdXQiLCJjb25zb2xlIiwibG9nIiwiY2hhbGsiLCJncmV5IiwiZm9yRWFjaCIsIm91dCIsInR5cGUiLCJlcnJvciIsInByb2Nlc3MiLCJzdGRvdXQiLCJ3cml0ZSIsImdyZWVuIiwicGFkIiwiYXBwX25hbWUiLCJyZWQiLCJibHVlIiwic3RyZWFtIiwiQ2xpZW50IiwiaWQiLCJ0aW1lc3RhbXAiLCJleGNsdXNpdmUiLCJoaWdobGlnaHQiLCJsYXVuY2hCdXMiLCJlcnIiLCJidXMiLCJzb2NrZXQiLCJnbG9iYWwiLCJfYXV0b19leGl0IiwiZm9ybWF0IiwiZXhpdCIsIm1pbl9wYWRkaW5nIiwicGFja2V0IiwibmFtZSIsInBtX2lkIiwibGluZSIsInN0ZGVyciIsInV0aWwiLCJyZXBlYXQiLCJyZXBsYWNlIiwiYmdCbGFja0JyaWdodCIsImRldlN0cmVhbSIsInNldFRpbWVvdXQiLCJldmVudCIsImpzb25TdHJlYW0iLCJKU09OIiwic3RyaW5naWZ5IiwiYXQiLCJzdGF0dXMiLCJtZXNzYWdlIiwicHJvY2Vzc19pZCIsImZvcm1hdFN0cmVhbSIsInN0ciIsInBhZExlZnQiLCJzdWJzdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7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QyxHQUFsQixFQUF1QkMsT0FBdkIsRUFBaUM7QUFDL0IsTUFBSSxPQUFPRCxHQUFQLEtBQWUsV0FBbkIsRUFDRSxPQUFPdkMsR0FBUDs7QUFDRixNQUFJd0MsT0FBSixFQUFhO0FBQ1gsV0FBTyxDQUFDeEMsR0FBRyxHQUFHdUMsR0FBUCxFQUFZL0QsS0FBWixDQUFrQixDQUFDd0IsR0FBRyxDQUFDMUMsTUFBdkIsQ0FBUDtBQUNELEdBRkQsTUFFTztBQUNMLFdBQU8sQ0FBQ2lGLEdBQUcsR0FBR3ZDLEdBQVAsRUFBWXlDLFNBQVosQ0FBc0IsQ0FBdEIsRUFBeUJ6QyxHQUFHLENBQUMxQyxNQUE3QixDQUFQO0FBQ0Q7QUFDRjs7ZUFFY1IsRyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgMjAxMyB0aGUgUE0yIHByb2plY3QgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBsaWNlbnNlIHRoYXRcclxuICogY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuXHJcbiAqL1xyXG5pbXBvcnQgZnMgICAgIGZyb20gJ2ZzJztcclxuaW1wb3J0ICAgIHV0aWwgICBmcm9tICd1dGlsJztcclxuaW1wb3J0ICAgIGNoYWxrICBmcm9tICdjaGFsayc7XHJcbmltcG9ydCAgICBmb3JFYWNoTGltaXQgIGZyb20gJ2FzeW5jL2ZvckVhY2hMaW1pdCc7XHJcbmltcG9ydCAgICBkYXlqcyBmcm9tICdkYXlqcyc7XHJcblxyXG52YXIgTG9nOiBhbnkgPSB7fTtcclxuXHJcbnZhciBERUZBVUxUX1BBRERJTkcgPSAnICAgICAgICAgICc7XHJcblxyXG4vKipcclxuICogVGFpbCBsb2dzIGZyb20gZmlsZSBzdHJlYW0uXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBhcHBzX2xpc3RcclxuICogQHBhcmFtIHtOdW1iZXJ9IGxpbmVzXHJcbiAqIEBwYXJhbSB7Qm9vbGVhbn0gcmF3XHJcbiAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrXHJcbiAqIEByZXR1cm5cclxuICovXHJcblxyXG5Mb2cudGFpbCA9IGZ1bmN0aW9uKGFwcHNfbGlzdCwgbGluZXMsIHJhdywgY2FsbGJhY2spIHtcclxuICB2YXIgdGhhdCA9IHRoaXM7XHJcblxyXG4gIGlmIChsaW5lcyA9PT0gMCB8fCBhcHBzX2xpc3QubGVuZ3RoID09PSAwKVxyXG4gICAgcmV0dXJuIGNhbGxiYWNrICYmIGNhbGxiYWNrKCk7XHJcblxyXG4gIHZhciBjb3VudCA9IDA7XHJcblxyXG4gIHZhciBnZXRMYXN0TGluZXMgPSBmdW5jdGlvbiAoZmlsZW5hbWUsIGxpbmVzLCBjYWxsYmFjaykge1xyXG4gICAgdmFyIGNodW5rID0gJyc7XHJcbiAgICB2YXIgc2l6ZSA9IE1hdGgubWF4KDAsIGZzLnN0YXRTeW5jKGZpbGVuYW1lKS5zaXplIC0gKGxpbmVzICogMjAwKSk7XHJcblxyXG4gICAgbGV0IGNodW5rQXJyO1xyXG4gICAgdmFyIGZkID0gZnMuY3JlYXRlUmVhZFN0cmVhbShmaWxlbmFtZSwge3N0YXJ0IDogc2l6ZX0pO1xyXG4gICAgZmQub24oJ2RhdGEnLCBmdW5jdGlvbihkYXRhKSB7IGNodW5rICs9IGRhdGEudG9TdHJpbmcoKTsgfSk7XHJcbiAgICBmZC5vbignZW5kJywgZnVuY3Rpb24oKSB7XHJcbiAgICAgIGNodW5rQXJyID0gY2h1bmsuc3BsaXQoJ1xcbicpLnNsaWNlKC0obGluZXMrMSkpO1xyXG4gICAgICBjaHVua0Fyci5wb3AoKTtcclxuICAgICAgY2FsbGJhY2soY2h1bmtBcnIpO1xyXG4gICAgfSk7XHJcbiAgfTtcclxuXHJcbiAgYXBwc19saXN0LnNvcnQoZnVuY3Rpb24oYSwgYikge1xyXG4gICAgcmV0dXJuIChmcy5leGlzdHNTeW5jKGEucGF0aCkgPyBmcy5zdGF0U3luYyhhLnBhdGgpLm10aW1lLnZhbHVlT2YoKSA6IDApIC1cclxuICAgICAgKGZzLmV4aXN0c1N5bmMoYi5wYXRoKSA/IGZzLnN0YXRTeW5jKGIucGF0aCkubXRpbWUudmFsdWVPZigpIDogMCk7XHJcbiAgfSk7XHJcblxyXG4gIGZvckVhY2hMaW1pdChhcHBzX2xpc3QsIDEsIGZ1bmN0aW9uKGFwcCwgbmV4dCkge1xyXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKGFwcC5wYXRoIHx8ICcnKSlcclxuICAgICAgcmV0dXJuIG5leHQoKTtcclxuXHJcbiAgICBnZXRMYXN0TGluZXMoYXBwLnBhdGgsIGxpbmVzLCBmdW5jdGlvbihvdXRwdXQpIHtcclxuICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JleSgnJXMgbGFzdCAlZCBsaW5lczonKSwgYXBwLnBhdGgsIGxpbmVzKTtcclxuICAgICAgb3V0cHV0LmZvckVhY2goZnVuY3Rpb24ob3V0KSB7XHJcbiAgICAgICAgaWYgKHJhdylcclxuICAgICAgICAgIHJldHVybiBhcHAudHlwZSA9PT0gJ2VycicgPyBjb25zb2xlLmVycm9yKG91dCkgOiBjb25zb2xlLmxvZyhvdXQpO1xyXG4gICAgICAgIGlmIChhcHAudHlwZSA9PT0gJ291dCcpXHJcbiAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShjaGFsay5ncmVlbihwYWQoREVGQVVMVF9QQURESU5HLCBhcHAuYXBwX25hbWUpICArICcgfCAnKSk7XHJcbiAgICAgICAgZWxzZSBpZiAoYXBwLnR5cGUgPT09ICdlcnInKVxyXG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoY2hhbGsucmVkKHBhZChERUZBVUxUX1BBRERJTkcsIGFwcC5hcHBfbmFtZSkgICsgJyB8ICcpKTtcclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShjaGFsay5ibHVlKHBhZChERUZBVUxUX1BBRERJTkcsICdQTTInKSArICcgfCAnKSk7XHJcbiAgICAgICAgY29uc29sZS5sb2cob3V0KTtcclxuICAgICAgfSk7XHJcbiAgICAgIGlmIChvdXRwdXQubGVuZ3RoKVxyXG4gICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKCdcXG4nKTtcclxuICAgICAgbmV4dCgpO1xyXG4gICAgfSk7XHJcbiAgfSwgZnVuY3Rpb24oKSB7XHJcbiAgICBjYWxsYmFjayAmJiBjYWxsYmFjaygpO1xyXG4gIH0pO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIFN0cmVhbSBsb2dzIGluIHJlYWx0aW1lIGZyb20gdGhlIGJ1cyBldmVudGVtaXR0ZXIuXHJcbiAqIEBwYXJhbSB7U3RyaW5nfSBpZFxyXG4gKiBAcGFyYW0ge0Jvb2xlYW59IHJhd1xyXG4gKiBAcmV0dXJuXHJcbiAqL1xyXG5cclxuTG9nLnN0cmVhbSA9IGZ1bmN0aW9uKENsaWVudCwgaWQsIHJhdywgdGltZXN0YW1wLCBleGNsdXNpdmUsIGhpZ2hsaWdodCkge1xyXG4gIHZhciB0aGF0ID0gdGhpcztcclxuXHJcbiAgQ2xpZW50LmxhdW5jaEJ1cyhmdW5jdGlvbihlcnIsIGJ1cywgc29ja2V0KSB7XHJcblxyXG4gICAgc29ja2V0Lm9uKCdyZWNvbm5lY3QgYXR0ZW1wdCcsIGZ1bmN0aW9uKCkge1xyXG4gICAgICBpZiAoKGdsb2JhbCBhcyBhbnkpLl9hdXRvX2V4aXQgPT09IHRydWUpIHtcclxuICAgICAgICBpZiAodGltZXN0YW1wKVxyXG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoY2hhbGtbJ2RpbSddKGNoYWxrLmdyZXkoZGF5anMoKS5mb3JtYXQodGltZXN0YW1wKSArICcgJykpKTtcclxuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShjaGFsay5ibHVlKHBhZChERUZBVUxUX1BBRERJTkcsICdQTTInKSArICcgfCAnKSArICdbW1sgVGFyZ2V0IFBNMiBraWxsZWQuIF1dXScpO1xyXG4gICAgICAgIHByb2Nlc3MuZXhpdCgwKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgdmFyIG1pbl9wYWRkaW5nID0gM1xyXG5cclxuICAgIGJ1cy5vbignbG9nOionLCBmdW5jdGlvbih0eXBlLCBwYWNrZXQpIHtcclxuICAgICAgaWYgKGlkICE9PSAnYWxsJ1xyXG4gICAgICAgICAgJiYgcGFja2V0LnByb2Nlc3MubmFtZSAhPSBpZFxyXG4gICAgICAgICAgJiYgcGFja2V0LnByb2Nlc3MucG1faWQgIT0gaWQpXHJcbiAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgaWYgKCh0eXBlID09PSAnb3V0JyAmJiBleGNsdXNpdmUgPT09ICdlcnInKVxyXG4gICAgICAgICB8fCAodHlwZSA9PT0gJ2VycicgJiYgZXhjbHVzaXZlID09PSAnb3V0JylcclxuICAgICAgICAgfHwgKHR5cGUgPT09ICdQTTInICYmIGV4Y2x1c2l2ZSAhPT0gZmFsc2UpKVxyXG4gICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgIHZhciBsaW5lcztcclxuXHJcbiAgICAgIGlmICh0eXBlb2YocGFja2V0LmRhdGEpID09PSAnc3RyaW5nJylcclxuICAgICAgICBsaW5lcyA9IChwYWNrZXQuZGF0YSB8fCAnJykuc3BsaXQoJ1xcbicpO1xyXG4gICAgICBlbHNlXHJcbiAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgbGluZXMuZm9yRWFjaChmdW5jdGlvbihsaW5lKSB7XHJcbiAgICAgICAgaWYgKCFsaW5lIHx8IGxpbmUubGVuZ3RoID09PSAwKSByZXR1cm47XHJcblxyXG4gICAgICAgIGlmIChyYXcpXHJcbiAgICAgICAgICByZXR1cm4gdHlwZSA9PT0gJ2VycicgPyBwcm9jZXNzLnN0ZGVyci53cml0ZSh1dGlsLmZvcm1hdChsaW5lKSArICdcXG4nKSA6IHByb2Nlc3Muc3Rkb3V0LndyaXRlKHV0aWwuZm9ybWF0KGxpbmUpICsgJ1xcbicpO1xyXG5cclxuICAgICAgICBpZiAodGltZXN0YW1wKVxyXG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoY2hhbGtbJ2RpbSddKGNoYWxrLmdyZXkoZGF5anMoKS5mb3JtYXQodGltZXN0YW1wKSArICcgJykpKTtcclxuXHJcbiAgICAgICAgdmFyIG5hbWUgPSBwYWNrZXQucHJvY2Vzcy5wbV9pZCArICd8JyArIHBhY2tldC5wcm9jZXNzLm5hbWU7XHJcblxyXG4gICAgICAgIGlmIChuYW1lLmxlbmd0aCA+IG1pbl9wYWRkaW5nKVxyXG4gICAgICAgICAgbWluX3BhZGRpbmcgPSBuYW1lLmxlbmd0aCArIDFcclxuXHJcbiAgICAgICAgaWYgKHR5cGUgPT09ICdvdXQnKVxyXG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoY2hhbGsuZ3JlZW4ocGFkKCcgJy5yZXBlYXQobWluX3BhZGRpbmcpLCBuYW1lKSAgKyAnIHwgJykpO1xyXG4gICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdlcnInKVxyXG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoY2hhbGsucmVkKHBhZCgnICcucmVwZWF0KG1pbl9wYWRkaW5nKSwgbmFtZSkgICsgJyB8ICcpKTtcclxuICAgICAgICBlbHNlIGlmICghcmF3ICYmIChpZCA9PT0gJ2FsbCcgfHwgaWQgPT09ICdQTTInKSlcclxuICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGNoYWxrLmJsdWUocGFkKCcgJy5yZXBlYXQobWluX3BhZGRpbmcpLCAnUE0yJykgKyAnIHwgJykpO1xyXG4gICAgICAgIGlmIChoaWdobGlnaHQpXHJcbiAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSh1dGlsLmZvcm1hdChsaW5lKS5yZXBsYWNlKGhpZ2hsaWdodCwgY2hhbGsuYmdCbGFja0JyaWdodChoaWdobGlnaHQpKSArICdcXG4nKTtcclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSh1dGlsLmZvcm1hdChsaW5lKSsgJ1xcbicpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59O1xyXG5cclxuTG9nLmRldlN0cmVhbSA9IGZ1bmN0aW9uKENsaWVudCwgaWQsIHJhdywgdGltZXN0YW1wLCBleGNsdXNpdmUpIHtcclxuICB2YXIgdGhhdCA9IHRoaXM7XHJcblxyXG4gIENsaWVudC5sYXVuY2hCdXMoZnVuY3Rpb24oZXJyLCBidXMpIHtcclxuXHJcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xyXG4gICAgICBidXMub24oJ3Byb2Nlc3M6ZXZlbnQnLCBmdW5jdGlvbihwYWNrZXQpIHtcclxuICAgICAgICBpZiAocGFja2V0LmV2ZW50ID09ICdvbmxpbmUnKVxyXG4gICAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JlZW4oJ1tydW5kZXZdIEFwcCAlcyByZXN0YXJ0ZWQnKSwgcGFja2V0LnByb2Nlc3MubmFtZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSwgMTAwMCk7XHJcblxyXG4gICAgdmFyIG1pbl9wYWRkaW5nID0gM1xyXG5cclxuICAgIGJ1cy5vbignbG9nOionLCBmdW5jdGlvbih0eXBlLCBwYWNrZXQpIHtcclxuICAgICAgaWYgKGlkICE9PSAnYWxsJ1xyXG4gICAgICAgICAgJiYgcGFja2V0LnByb2Nlc3MubmFtZSAhPSBpZFxyXG4gICAgICAgICAgJiYgcGFja2V0LnByb2Nlc3MucG1faWQgIT0gaWQpXHJcbiAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgaWYgKCh0eXBlID09PSAnb3V0JyAmJiBleGNsdXNpdmUgPT09ICdlcnInKVxyXG4gICAgICAgICAgfHwgKHR5cGUgPT09ICdlcnInICYmIGV4Y2x1c2l2ZSA9PT0gJ291dCcpXHJcbiAgICAgICAgICB8fCAodHlwZSA9PT0gJ1BNMicgJiYgZXhjbHVzaXZlICE9PSBmYWxzZSkpXHJcbiAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgaWYgKHR5cGUgPT09ICdQTTInKVxyXG4gICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgIHZhciBuYW1lID0gcGFja2V0LnByb2Nlc3MucG1faWQgKyAnfCcgKyBwYWNrZXQucHJvY2Vzcy5uYW1lO1xyXG5cclxuICAgICAgdmFyIGxpbmVzO1xyXG5cclxuICAgICAgaWYgKHR5cGVvZihwYWNrZXQuZGF0YSkgPT09ICdzdHJpbmcnKVxyXG4gICAgICAgIGxpbmVzID0gKHBhY2tldC5kYXRhIHx8ICcnKS5zcGxpdCgnXFxuJyk7XHJcbiAgICAgIGVsc2VcclxuICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICBsaW5lcy5mb3JFYWNoKGZ1bmN0aW9uKGxpbmUpIHtcclxuICAgICAgICBpZiAoIWxpbmUgfHwgbGluZS5sZW5ndGggPT09IDApIHJldHVybjtcclxuXHJcbiAgICAgICAgaWYgKHJhdylcclxuICAgICAgICAgIHJldHVybiBwcm9jZXNzLnN0ZG91dC53cml0ZSh1dGlsLmZvcm1hdChsaW5lKSArICdcXG4nKTtcclxuXHJcbiAgICAgICAgaWYgKHRpbWVzdGFtcClcclxuICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGNoYWxrWydkaW0nXShjaGFsay5ncmV5KGRheWpzKCkuZm9ybWF0KHRpbWVzdGFtcCkgKyAnICcpKSk7XHJcblxyXG4gICAgICAgIHZhciBuYW1lID0gcGFja2V0LnByb2Nlc3MubmFtZSArICctJyArIHBhY2tldC5wcm9jZXNzLnBtX2lkO1xyXG5cclxuICAgICAgICBpZiAobmFtZS5sZW5ndGggPiBtaW5fcGFkZGluZylcclxuICAgICAgICAgIG1pbl9wYWRkaW5nID0gbmFtZS5sZW5ndGggKyAxXHJcblxyXG4gICAgICAgIGlmICh0eXBlID09PSAnb3V0JylcclxuICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGNoYWxrLmdyZWVuKHBhZCgnICcucmVwZWF0KG1pbl9wYWRkaW5nKSwgbmFtZSkgICsgJyB8ICcpKTtcclxuICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnZXJyJylcclxuICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGNoYWxrLnJlZChwYWQoJyAnLnJlcGVhdChtaW5fcGFkZGluZyksIG5hbWUpICArICcgfCAnKSk7XHJcbiAgICAgICAgZWxzZSBpZiAoIXJhdyAmJiAoaWQgPT09ICdhbGwnIHx8IGlkID09PSAnUE0yJykpXHJcbiAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShjaGFsay5ibHVlKHBhZCgnICcucmVwZWF0KG1pbl9wYWRkaW5nKSwgJ1BNMicpICsgJyB8ICcpKTtcclxuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSh1dGlsLmZvcm1hdChsaW5lKSArICdcXG4nKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufTtcclxuXHJcbkxvZy5qc29uU3RyZWFtID0gZnVuY3Rpb24oQ2xpZW50LCBpZCkge1xyXG4gIHZhciB0aGF0ID0gdGhpcztcclxuXHJcbiAgQ2xpZW50LmxhdW5jaEJ1cyhmdW5jdGlvbihlcnIsIGJ1cykge1xyXG4gICAgaWYgKGVycikgY29uc29sZS5lcnJvcihlcnIpO1xyXG5cclxuICAgIGJ1cy5vbigncHJvY2VzczpldmVudCcsIGZ1bmN0aW9uKHBhY2tldCkge1xyXG4gICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgdGltZXN0YW1wIDogZGF5anMocGFja2V0LmF0KSxcclxuICAgICAgICB0eXBlICAgICAgOiAncHJvY2Vzc19ldmVudCcsXHJcbiAgICAgICAgc3RhdHVzICAgIDogcGFja2V0LmV2ZW50LFxyXG4gICAgICAgIGFwcF9uYW1lICA6IHBhY2tldC5wcm9jZXNzLm5hbWVcclxuICAgICAgfSkpO1xyXG4gICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSgnXFxuJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBidXMub24oJ2xvZzoqJywgZnVuY3Rpb24odHlwZSwgcGFja2V0KSB7XHJcbiAgICAgIGlmIChpZCAhPT0gJ2FsbCdcclxuICAgICAgICAgICYmIHBhY2tldC5wcm9jZXNzLm5hbWUgIT0gaWRcclxuICAgICAgICAgICYmIHBhY2tldC5wcm9jZXNzLnBtX2lkICE9IGlkKVxyXG4gICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgIGlmICh0eXBlID09PSAnUE0yJylcclxuICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICBpZiAodHlwZW9mKHBhY2tldC5kYXRhKSA9PSAnc3RyaW5nJylcclxuICAgICAgICBwYWNrZXQuZGF0YSA9IHBhY2tldC5kYXRhLnJlcGxhY2UoLyhcXHJcXG58XFxufFxccikvZ20sJycpO1xyXG5cclxuICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgIG1lc3NhZ2UgOiBwYWNrZXQuZGF0YSxcclxuICAgICAgICB0aW1lc3RhbXAgOiBkYXlqcyhwYWNrZXQuYXQpLFxyXG4gICAgICAgIHR5cGUgOiB0eXBlLFxyXG4gICAgICAgIHByb2Nlc3NfaWQgOiBwYWNrZXQucHJvY2Vzcy5wbV9pZCxcclxuICAgICAgICBhcHBfbmFtZSA6IHBhY2tldC5wcm9jZXNzLm5hbWVcclxuICAgICAgfSkpO1xyXG4gICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSgnXFxuJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufTtcclxuXHJcbkxvZy5mb3JtYXRTdHJlYW0gPSBmdW5jdGlvbihDbGllbnQsIGlkLCByYXcsIHRpbWVzdGFtcCwgZXhjbHVzaXZlLCBoaWdobGlnaHQpIHtcclxuICB2YXIgdGhhdCA9IHRoaXM7XHJcblxyXG4gIENsaWVudC5sYXVuY2hCdXMoZnVuY3Rpb24oZXJyLCBidXMpIHtcclxuXHJcbiAgICBidXMub24oJ2xvZzoqJywgZnVuY3Rpb24odHlwZSwgcGFja2V0KSB7XHJcbiAgICAgIGlmIChpZCAhPT0gJ2FsbCdcclxuICAgICAgICAgICYmIHBhY2tldC5wcm9jZXNzLm5hbWUgIT0gaWRcclxuICAgICAgICAgICYmIHBhY2tldC5wcm9jZXNzLnBtX2lkICE9IGlkKVxyXG4gICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgIGlmICgodHlwZSA9PT0gJ291dCcgJiYgZXhjbHVzaXZlID09PSAnZXJyJylcclxuICAgICAgICAgIHx8ICh0eXBlID09PSAnZXJyJyAmJiBleGNsdXNpdmUgPT09ICdvdXQnKVxyXG4gICAgICAgICAgfHwgKHR5cGUgPT09ICdQTTInICYmIGV4Y2x1c2l2ZSAhPT0gZmFsc2UpKVxyXG4gICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgIGlmICh0eXBlID09PSAnUE0yJyAmJiByYXcpXHJcbiAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgdmFyIG5hbWUgPSBwYWNrZXQucHJvY2Vzcy5uYW1lICsgJy0nICsgcGFja2V0LnByb2Nlc3MucG1faWQ7XHJcblxyXG4gICAgICB2YXIgbGluZXM7XHJcblxyXG4gICAgICBpZiAodHlwZW9mKHBhY2tldC5kYXRhKSA9PT0gJ3N0cmluZycpXHJcbiAgICAgICAgbGluZXMgPSAocGFja2V0LmRhdGEgfHwgJycpLnNwbGl0KCdcXG4nKTtcclxuICAgICAgZWxzZVxyXG4gICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgIGxpbmVzLmZvckVhY2goZnVuY3Rpb24obGluZSkge1xyXG4gICAgICAgIGlmICghbGluZSB8fCBsaW5lLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xyXG5cclxuICAgICAgICBpZiAoIXJhdykge1xyXG4gICAgICAgICAgaWYgKHRpbWVzdGFtcClcclxuICAgICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoJ3RpbWVzdGFtcD0nICsgZGF5anMoKS5mb3JtYXQodGltZXN0YW1wKSArICcgJyk7XHJcbiAgICAgICAgICBpZiAocGFja2V0LnByb2Nlc3MubmFtZSA9PT0gJ1BNMicpXHJcbiAgICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKCdhcHA9cG0yICcpO1xyXG4gICAgICAgICAgaWYgKHBhY2tldC5wcm9jZXNzLm5hbWUgIT09ICdQTTInKVxyXG4gICAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSgnYXBwPScgKyBwYWNrZXQucHJvY2Vzcy5uYW1lICsgJyBpZD0nICsgcGFja2V0LnByb2Nlc3MucG1faWQgKyAnICcpO1xyXG4gICAgICAgICAgaWYgKHR5cGUgPT09ICdvdXQnKVxyXG4gICAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSgndHlwZT1vdXQgJyk7XHJcbiAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnZXJyJylcclxuICAgICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoJ3R5cGU9ZXJyb3IgJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSgnbWVzc2FnZT0nKTtcclxuICAgICAgICBpZiAoaGlnaGxpZ2h0KVxyXG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUodXRpbC5mb3JtYXQobGluZSkucmVwbGFjZShoaWdobGlnaHQsIGNoYWxrLmJnQmxhY2tCcmlnaHQoaGlnaGxpZ2h0KSkgKyAnXFxuJyk7XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUodXRpbC5mb3JtYXQobGluZSkgKyAnXFxuJyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn07XHJcblxyXG5mdW5jdGlvbiBwYWQocGFkLCBzdHIsIHBhZExlZnQ/KSB7XHJcbiAgaWYgKHR5cGVvZiBzdHIgPT09ICd1bmRlZmluZWQnKVxyXG4gICAgcmV0dXJuIHBhZDtcclxuICBpZiAocGFkTGVmdCkge1xyXG4gICAgcmV0dXJuIChwYWQgKyBzdHIpLnNsaWNlKC1wYWQubGVuZ3RoKTtcclxuICB9IGVsc2Uge1xyXG4gICAgcmV0dXJuIChzdHIgKyBwYWQpLnN1YnN0cmluZygwLCBwYWQubGVuZ3RoKTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IExvZztcclxuIl19
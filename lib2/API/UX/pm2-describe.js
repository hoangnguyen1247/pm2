"use strict";

var _cliTableau = _interopRequireDefault(require("cli-tableau"));

var _chalk = _interopRequireDefault(require("chalk"));

var _helpers = _interopRequireDefault(require("./helpers.js"));

var _Common = _interopRequireDefault(require("../../Common.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var postModuleInfos = function postModuleInfos(module_name, human_info) {
  var table = new _cliTableau["default"]({
    style: {
      'padding-left': 1,
      head: ['cyan', 'bold'],
      compact: true
    }
  });
  var disp = {};
  human_info.unshift(['Module name', module_name]);
  human_info.forEach(function (info) {
    var obj = {};
    obj[_chalk["default"].bold.cyan(info[0])] = info[1];
    table.push(obj);
  });
  console.log();
  console.log(_chalk["default"].bold.inverse(' Module %s infos '), module_name);
  console.log(table.toString());
};
/**
 * Description
 * @method describeTable
 * @param {Object} proc process list
 */


module.exports = function (proc) {
  var table = new _cliTableau["default"]({
    style: {
      'padding-left': 1,
      head: ['cyan', 'bold'],
      compact: true
    }
  });
  var pm2_env = proc.pm2_env;
  var created_at = 'N/A';

  if (pm2_env.axm_options && pm2_env.axm_options.human_info) {
    postModuleInfos(pm2_env.name, pm2_env.axm_options.human_info);
  }

  try {
    if (pm2_env.created_at != null) created_at = new Date(pm2_env.created_at).toISOString();
  } catch (e) {}

  console.log(_chalk["default"].bold.inverse(' Describing process with id %d - name %s '), pm2_env.pm_id, pm2_env.name);

  _helpers["default"].safe_push(table, {
    'status': _helpers["default"].colorStatus(pm2_env.status)
  }, {
    'name': pm2_env.name
  }, {
    'namespace': pm2_env.namespace
  }, {
    'version': pm2_env.version
  }, {
    'restarts': pm2_env.restart_time
  }, {
    'uptime': pm2_env.pm_uptime && pm2_env.status == 'online' ? _helpers["default"].timeSince(pm2_env.pm_uptime) : 0
  }, {
    'script path': pm2_env.pm_exec_path
  }, {
    'script args': pm2_env.args ? (typeof pm2_env.args == 'string' ? JSON.parse(pm2_env.args.replace(/'/g, '"')) : pm2_env.args).join(' ') : null
  }, {
    'error log path': pm2_env.pm_err_log_path
  }, {
    'out log path': pm2_env.pm_out_log_path
  }, {
    'pid path': pm2_env.pm_pid_path
  }, {
    'interpreter': pm2_env.exec_interpreter
  }, {
    'interpreter args': pm2_env.node_args.length != 0 ? pm2_env.node_args : null
  }, {
    'script id': pm2_env.pm_id
  }, {
    'exec cwd': pm2_env.pm_cwd
  }, {
    'exec mode': pm2_env.exec_mode
  }, {
    'node.js version': pm2_env.node_version
  }, {
    'node env': pm2_env.env.NODE_ENV
  }, {
    'watch & reload': pm2_env.watch ? _chalk["default"].green.bold('✔') : '✘'
  }, {
    'unstable restarts': pm2_env.unstable_restarts
  }, {
    'created at': created_at
  });

  if ('pm_log_path' in pm2_env) {
    table.splice(6, 0, {
      'entire log path': pm2_env.pm_log_path
    });
  }

  if ('cron_restart' in pm2_env) {
    table.splice(5, 0, {
      'cron restart': pm2_env.cron_restart
    });
  }

  console.log(table.toString());
  /**
   * Module conf display
   */

  if (pm2_env.axm_options && pm2_env.axm_options.module_conf && Object.keys(pm2_env.axm_options.module_conf).length > 0) {
    var table_conf = new _cliTableau["default"]({
      style: {
        'padding-left': 1,
        head: ['cyan', 'bold'],
        compact: true
      }
    });
    console.log('Process configuration');
    Object.keys(pm2_env.axm_options.module_conf).forEach(function (key) {
      var tmp = {};
      tmp[key] = pm2_env.axm_options.module_conf[key];

      _helpers["default"].safe_push(table_conf, tmp);
    });
    console.log(table_conf.toString());
  }
  /**
   * Versioning metadata
   */


  if (pm2_env.versioning) {
    var table2 = new _cliTableau["default"]({
      style: {
        'padding-left': 1,
        head: ['cyan', 'bold'],
        compact: true
      }
    });
    console.log(_chalk["default"].inverse.bold(' Revision control metadata '));

    _helpers["default"].safe_push(table2, {
      'revision control': pm2_env.versioning.type
    }, {
      'remote url': pm2_env.versioning.url
    }, {
      'repository root': pm2_env.versioning.repo_path
    }, {
      'last update': pm2_env.versioning.update_time
    }, {
      'revision': pm2_env.versioning.revision
    }, {
      'comment': pm2_env.versioning.comment ? pm2_env.versioning.comment.trim().slice(0, 60) : ''
    }, {
      'branch': pm2_env.versioning.branch
    });

    console.log(table2.toString());
  }

  if (pm2_env.axm_actions && Object.keys(pm2_env.axm_actions).length > 0) {
    var table_actions = new _cliTableau["default"]({
      style: {
        'padding-left': 1,
        head: ['cyan', 'bold'],
        compact: true
      }
    });
    console.log(_chalk["default"].inverse.bold(' Actions available '));
    pm2_env.axm_actions.forEach(function (action_set) {
      _helpers["default"].safe_push(table_actions, [action_set.action_name]);
    });
    console.log(table_actions.toString());

    _Common["default"].printOut(_chalk["default"].white.italic(' Trigger via: pm2 trigger %s <action_name>\n'), pm2_env.name);
  }

  if (pm2_env.axm_monitor && Object.keys(pm2_env.axm_monitor).length > 0) {
    var table_probes = new _cliTableau["default"]({
      style: {
        'padding-left': 1,
        head: ['cyan', 'bold'],
        compact: true
      }
    });
    console.log(_chalk["default"].inverse.bold(' Code metrics value '));
    Object.keys(pm2_env.axm_monitor).forEach(function (key) {
      var obj = {};
      var metric_name = pm2_env.axm_monitor[key].hasOwnProperty("value") ? pm2_env.axm_monitor[key].value : pm2_env.axm_monitor[key];
      var metric_unit = pm2_env.axm_monitor[key].hasOwnProperty("unit") ? pm2_env.axm_monitor[key].unit : '';
      var value = "".concat(metric_name, " ").concat(metric_unit);
      obj[key] = value;

      _helpers["default"].safe_push(table_probes, obj);
    });
    console.log(table_probes.toString());
  }

  var table_env = new _cliTableau["default"]({
    style: {
      'padding-left': 1,
      head: ['cyan', 'bold'],
      compact: true
    }
  });
  console.log(_chalk["default"].inverse.bold(' Divergent env variables from local env '));

  var _env = _Common["default"].safeExtend({}, pm2_env);

  var diff_env = {};
  Object.keys(process.env).forEach(function (k) {
    if (!_env[k] || _env[k] != process.env[k]) {
      diff_env[k] = process.env[k];
    }
  });
  Object.keys(diff_env).forEach(function (key) {
    var obj = {};

    if (_env[key]) {
      obj[key] = _env[key].slice(0, process.stdout.columns - 60);

      _helpers["default"].safe_push(table_env, obj);
    }
  });
  console.log(table_env.toString());
  console.log();

  _Common["default"].printOut(_chalk["default"].white.italic(' Add your own code metrics: http://bit.ly/code-metrics'));

  _Common["default"].printOut(_chalk["default"].white.italic(' Use `pm2 logs %s [--lines 1000]` to display logs'), pm2_env.name);

  _Common["default"].printOut(_chalk["default"].white.italic(' Use `pm2 env %s` to display environment variables'), pm2_env.pm_id);

  _Common["default"].printOut(_chalk["default"].white.italic(' Use `pm2 monit` to monitor CPU and Memory usage'), pm2_env.name);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BUEkvVVgvcG0yLWRlc2NyaWJlLnRzIl0sIm5hbWVzIjpbInBvc3RNb2R1bGVJbmZvcyIsIm1vZHVsZV9uYW1lIiwiaHVtYW5faW5mbyIsInRhYmxlIiwiVGFibGUiLCJzdHlsZSIsImhlYWQiLCJjb21wYWN0IiwiZGlzcCIsInVuc2hpZnQiLCJmb3JFYWNoIiwiaW5mbyIsIm9iaiIsImNoYWxrIiwiYm9sZCIsImN5YW4iLCJwdXNoIiwiY29uc29sZSIsImxvZyIsImludmVyc2UiLCJ0b1N0cmluZyIsIm1vZHVsZSIsImV4cG9ydHMiLCJwcm9jIiwicG0yX2VudiIsImNyZWF0ZWRfYXQiLCJheG1fb3B0aW9ucyIsIm5hbWUiLCJEYXRlIiwidG9JU09TdHJpbmciLCJlIiwicG1faWQiLCJVeEhlbHBlcnMiLCJzYWZlX3B1c2giLCJjb2xvclN0YXR1cyIsInN0YXR1cyIsIm5hbWVzcGFjZSIsInZlcnNpb24iLCJyZXN0YXJ0X3RpbWUiLCJwbV91cHRpbWUiLCJ0aW1lU2luY2UiLCJwbV9leGVjX3BhdGgiLCJhcmdzIiwiSlNPTiIsInBhcnNlIiwicmVwbGFjZSIsImpvaW4iLCJwbV9lcnJfbG9nX3BhdGgiLCJwbV9vdXRfbG9nX3BhdGgiLCJwbV9waWRfcGF0aCIsImV4ZWNfaW50ZXJwcmV0ZXIiLCJub2RlX2FyZ3MiLCJsZW5ndGgiLCJwbV9jd2QiLCJleGVjX21vZGUiLCJub2RlX3ZlcnNpb24iLCJlbnYiLCJOT0RFX0VOViIsIndhdGNoIiwiZ3JlZW4iLCJ1bnN0YWJsZV9yZXN0YXJ0cyIsInNwbGljZSIsInBtX2xvZ19wYXRoIiwiY3Jvbl9yZXN0YXJ0IiwibW9kdWxlX2NvbmYiLCJPYmplY3QiLCJrZXlzIiwidGFibGVfY29uZiIsImtleSIsInRtcCIsInZlcnNpb25pbmciLCJ0YWJsZTIiLCJ0eXBlIiwidXJsIiwicmVwb19wYXRoIiwidXBkYXRlX3RpbWUiLCJyZXZpc2lvbiIsImNvbW1lbnQiLCJ0cmltIiwic2xpY2UiLCJicmFuY2giLCJheG1fYWN0aW9ucyIsInRhYmxlX2FjdGlvbnMiLCJhY3Rpb25fc2V0IiwiYWN0aW9uX25hbWUiLCJDb21tb24iLCJwcmludE91dCIsIndoaXRlIiwiaXRhbGljIiwiYXhtX21vbml0b3IiLCJ0YWJsZV9wcm9iZXMiLCJtZXRyaWNfbmFtZSIsImhhc093blByb3BlcnR5IiwidmFsdWUiLCJtZXRyaWNfdW5pdCIsInVuaXQiLCJ0YWJsZV9lbnYiLCJfZW52Iiwic2FmZUV4dGVuZCIsImRpZmZfZW52IiwicHJvY2VzcyIsImsiLCJzdGRvdXQiLCJjb2x1bW5zIl0sIm1hcHBpbmdzIjoiOztBQUFBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsSUFBSUEsZUFBZSxHQUFHLFNBQWxCQSxlQUFrQixDQUFTQyxXQUFULEVBQXNCQyxVQUF0QixFQUFrQztBQUN0RCxNQUFJQyxLQUFLLEdBQUcsSUFBSUMsc0JBQUosQ0FBVTtBQUNwQkMsSUFBQUEsS0FBSyxFQUFHO0FBQUMsc0JBQWlCLENBQWxCO0FBQXFCQyxNQUFBQSxJQUFJLEVBQUcsQ0FBQyxNQUFELEVBQVMsTUFBVCxDQUE1QjtBQUE4Q0MsTUFBQUEsT0FBTyxFQUFHO0FBQXhEO0FBRFksR0FBVixDQUFaO0FBSUEsTUFBSUMsSUFBSSxHQUFHLEVBQVg7QUFFQU4sRUFBQUEsVUFBVSxDQUFDTyxPQUFYLENBQW1CLENBQUMsYUFBRCxFQUFnQlIsV0FBaEIsQ0FBbkI7QUFDQUMsRUFBQUEsVUFBVSxDQUFDUSxPQUFYLENBQW1CLFVBQVNDLElBQVQsRUFBZTtBQUNoQyxRQUFJQyxHQUFHLEdBQUcsRUFBVjtBQUNBQSxJQUFBQSxHQUFHLENBQUNDLGtCQUFNQyxJQUFOLENBQVdDLElBQVgsQ0FBZ0JKLElBQUksQ0FBQyxDQUFELENBQXBCLENBQUQsQ0FBSCxHQUFnQ0EsSUFBSSxDQUFDLENBQUQsQ0FBcEM7QUFDQVIsSUFBQUEsS0FBSyxDQUFDYSxJQUFOLENBQVdKLEdBQVg7QUFDRCxHQUpEO0FBTUFLLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUjtB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MEUsS0FBTixDQUFZQyxNQUFaLENBQW1CLGtEQUFuQixDQUFoQixFQUF3RmhFLE9BQU8sQ0FBQ0csSUFBaEc7QUFDRCxDQWhLRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBUYWJsZSBmcm9tICdjbGktdGFibGVhdSc7XHJcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XHJcbmltcG9ydCBVeEhlbHBlcnMgZnJvbSAnLi9oZWxwZXJzLmpzJztcclxuaW1wb3J0IENvbW1vbiBmcm9tICcuLi8uLi9Db21tb24uanMnO1xyXG5cclxudmFyIHBvc3RNb2R1bGVJbmZvcyA9IGZ1bmN0aW9uKG1vZHVsZV9uYW1lLCBodW1hbl9pbmZvKSB7XHJcbiAgdmFyIHRhYmxlID0gbmV3IFRhYmxlKHtcclxuICAgIHN0eWxlIDogeydwYWRkaW5nLWxlZnQnIDogMSwgaGVhZCA6IFsnY3lhbicsICdib2xkJ10sIGNvbXBhY3QgOiB0cnVlfVxyXG4gIH0pXHJcblxyXG4gIHZhciBkaXNwID0ge31cclxuXHJcbiAgaHVtYW5faW5mby51bnNoaWZ0KFsnTW9kdWxlIG5hbWUnLCBtb2R1bGVfbmFtZV0pXHJcbiAgaHVtYW5faW5mby5mb3JFYWNoKGZ1bmN0aW9uKGluZm8pIHtcclxuICAgIHZhciBvYmogPSB7fVxyXG4gICAgb2JqW2NoYWxrLmJvbGQuY3lhbihpbmZvWzBdKV0gPSBpbmZvWzFdXHJcbiAgICB0YWJsZS5wdXNoKG9iailcclxuICB9KVxyXG5cclxuICBjb25zb2xlLmxvZygpXHJcbiAgY29uc29sZS5sb2coY2hhbGsuYm9sZC5pbnZlcnNlKCcgTW9kdWxlICVzIGluZm9zICcpLCBtb2R1bGVfbmFtZSlcclxuICBjb25zb2xlLmxvZyh0YWJsZS50b1N0cmluZygpKVxyXG59XHJcblxyXG4vKipcclxuICogRGVzY3JpcHRpb25cclxuICogQG1ldGhvZCBkZXNjcmliZVRhYmxlXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9jIHByb2Nlc3MgbGlzdFxyXG4gKi9cclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihwcm9jKSB7XHJcbiAgdmFyIHRhYmxlID0gbmV3IFRhYmxlKHtcclxuICAgIHN0eWxlIDogeydwYWRkaW5nLWxlZnQnIDogMSwgaGVhZCA6IFsnY3lhbicsICdib2xkJ10sIGNvbXBhY3QgOiB0cnVlfVxyXG4gIH0pXHJcblxyXG4gIHZhciBwbTJfZW52ID0gcHJvYy5wbTJfZW52XHJcblxyXG4gIHZhciBjcmVhdGVkX2F0ID0gJ04vQSdcclxuXHJcbiAgaWYgKHBtMl9lbnYuYXhtX29wdGlvbnMgJiYgcG0yX2Vudi5heG1fb3B0aW9ucy5odW1hbl9pbmZvKSB7XHJcbiAgICBwb3N0TW9kdWxlSW5mb3MocG0yX2Vudi5uYW1lLCBwbTJfZW52LmF4bV9vcHRpb25zLmh1bWFuX2luZm8pXHJcbiAgfVxyXG5cclxuICB0cnkge1xyXG4gICAgaWYgKHBtMl9lbnYuY3JlYXRlZF9hdCAhPSBudWxsKVxyXG4gICAgICBjcmVhdGVkX2F0ID0gbmV3IERhdGUocG0yX2Vudi5jcmVhdGVkX2F0KS50b0lTT1N0cmluZygpXHJcbiAgfSBjYXRjaCAoZSkge1xyXG4gIH1cclxuXHJcbiAgY29uc29sZS5sb2coY2hhbGsuYm9sZC5pbnZlcnNlKCcgRGVzY3JpYmluZyBwcm9jZXNzIHdpdGggaWQgJWQgLSBuYW1lICVzICcpLCBwbTJfZW52LnBtX2lkLCBwbTJfZW52Lm5hbWUpXHJcbiAgVXhIZWxwZXJzLnNhZmVfcHVzaCh0YWJsZSxcclxuICAgICAgICAgICAgeyAnc3RhdHVzJyA6IFV4SGVscGVycy5jb2xvclN0YXR1cyhwbTJfZW52LnN0YXR1cykgfSxcclxuICAgICAgICAgICAgeyAnbmFtZSc6IHBtMl9lbnYubmFtZSB9LFxyXG4gICAgICAgICAgICB7ICduYW1lc3BhY2UnOiBwbTJfZW52Lm5hbWVzcGFjZSB9LFxyXG4gICAgICAgICAgICB7ICd2ZXJzaW9uJzogcG0yX2Vudi52ZXJzaW9uIH0sXHJcbiAgICAgICAgICAgIHsgJ3Jlc3RhcnRzJyA6IHBtMl9lbnYucmVzdGFydF90aW1lIH0sXHJcbiAgICAgICAgICAgIHsgJ3VwdGltZScgOiAocG0yX2Vudi5wbV91cHRpbWUgJiYgcG0yX2Vudi5zdGF0dXMgPT0gJ29ubGluZScpID8gVXhIZWxwZXJzLnRpbWVTaW5jZShwbTJfZW52LnBtX3VwdGltZSkgOiAwIH0sXHJcbiAgICAgICAgICAgIHsgJ3NjcmlwdCBwYXRoJyA6IHBtMl9lbnYucG1fZXhlY19wYXRoIH0sXHJcbiAgICAgICAgICAgIHsgJ3NjcmlwdCBhcmdzJyA6IHBtMl9lbnYuYXJncyA/ICh0eXBlb2YgcG0yX2Vudi5hcmdzID09ICdzdHJpbmcnID8gSlNPTi5wYXJzZShwbTJfZW52LmFyZ3MucmVwbGFjZSgvJy9nLCAnXCInKSk6cG0yX2Vudi5hcmdzKS5qb2luKCcgJykgOiBudWxsIH0sXHJcbiAgICAgICAgICAgIHsgJ2Vycm9yIGxvZyBwYXRoJyA6IHBtMl9lbnYucG1fZXJyX2xvZ19wYXRoIH0sXHJcbiAgICAgICAgICAgIHsgJ291dCBsb2cgcGF0aCcgOiBwbTJfZW52LnBtX291dF9sb2dfcGF0aCB9LFxyXG4gICAgICAgICAgICB7ICdwaWQgcGF0aCcgOiBwbTJfZW52LnBtX3BpZF9wYXRoIH0sXHJcblxyXG4gICAgICAgICAgICB7ICdpbnRlcnByZXRlcicgOiBwbTJfZW52LmV4ZWNfaW50ZXJwcmV0ZXIgfSxcclxuICAgICAgICAgICAgeyAnaW50ZXJwcmV0ZXIgYXJncycgOiBwbTJfZW52Lm5vZGVfYXJncy5sZW5ndGggIT0gMCA/IHBtMl9lbnYubm9kZV9hcmdzIDogbnVsbCB9LFxyXG5cclxuICAgICAgICAgICAgeyAnc2NyaXB0IGlkJyA6IHBtMl9lbnYucG1faWQgfSxcclxuICAgICAgICAgICAgeyAnZXhlYyBjd2QnIDogcG0yX2Vudi5wbV9jd2QgfSxcclxuXHJcbiAgICAgICAgICAgIHsgJ2V4ZWMgbW9kZScgOiBwbTJfZW52LmV4ZWNfbW9kZSB9LFxyXG4gICAgICAgICAgICB7ICdub2RlLmpzIHZlcnNpb24nIDogcG0yX2Vudi5ub2RlX3ZlcnNpb24gfSxcclxuICAgICAgICAgICAgeyAnbm9kZSBlbnYnOiBwbTJfZW52LmVudi5OT0RFX0VOViB9LFxyXG4gICAgICAgICAgICB7ICd3YXRjaCAmIHJlbG9hZCcgOiBwbTJfZW52LndhdGNoID8gY2hhbGsuZ3JlZW4uYm9sZCgn4pyUJykgOiAn4pyYJyB9LFxyXG4gICAgICAgICAgICB7ICd1bnN0YWJsZSByZXN0YXJ0cycgOiBwbTJfZW52LnVuc3RhYmxlX3Jlc3RhcnRzIH0sXHJcbiAgICAgICAgICAgIHsgJ2NyZWF0ZWQgYXQnIDogY3JlYXRlZF9hdCB9XHJcbiAgICAgICAgICAgKVxyXG5cclxuICBpZiAoJ3BtX2xvZ19wYXRoJyBpbiBwbTJfZW52KXtcclxuICAgIHRhYmxlLnNwbGljZSg2LCAwLCB7J2VudGlyZSBsb2cgcGF0aCc6IHBtMl9lbnYucG1fbG9nX3BhdGh9KVxyXG4gIH1cclxuXHJcbiAgaWYgKCdjcm9uX3Jlc3RhcnQnIGluIHBtMl9lbnYpe1xyXG4gICAgdGFibGUuc3BsaWNlKDUsIDAsIHsnY3JvbiByZXN0YXJ0JzogcG0yX2Vudi5jcm9uX3Jlc3RhcnR9KVxyXG4gIH1cclxuXHJcbiAgY29uc29sZS5sb2codGFibGUudG9TdHJpbmcoKSlcclxuXHJcbiAgLyoqXHJcbiAgICogTW9kdWxlIGNvbmYgZGlzcGxheVxyXG4gICAqL1xyXG4gIGlmIChwbTJfZW52LmF4bV9vcHRpb25zICYmXHJcbiAgICAgIHBtMl9lbnYuYXhtX29wdGlvbnMubW9kdWxlX2NvbmYgJiZcclxuICAgICAgT2JqZWN0LmtleXMocG0yX2Vudi5heG1fb3B0aW9ucy5tb2R1bGVfY29uZikubGVuZ3RoID4gMCkge1xyXG4gICAgdmFyIHRhYmxlX2NvbmYgPSBuZXcgVGFibGUoe1xyXG4gICAgICBzdHlsZSA6IHsncGFkZGluZy1sZWZ0JyA6IDEsIGhlYWQgOiBbJ2N5YW4nLCAnYm9sZCddLCBjb21wYWN0IDogdHJ1ZX1cclxuICAgIH0pXHJcbiAgICBjb25zb2xlLmxvZygnUHJvY2VzcyBjb25maWd1cmF0aW9uJylcclxuXHJcbiAgICBPYmplY3Qua2V5cyhwbTJfZW52LmF4bV9vcHRpb25zLm1vZHVsZV9jb25mKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkge1xyXG4gICAgICB2YXIgdG1wID0ge31cclxuICAgICAgdG1wW2tleV0gPSBwbTJfZW52LmF4bV9vcHRpb25zLm1vZHVsZV9jb25mW2tleV1cclxuICAgICAgVXhIZWxwZXJzLnNhZmVfcHVzaCh0YWJsZV9jb25mLCB0bXApXHJcbiAgICB9KVxyXG5cclxuICAgIGNvbnNvbGUubG9nKHRhYmxlX2NvbmYudG9TdHJpbmcoKSlcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFZlcnNpb25pbmcgbWV0YWRhdGFcclxuICAgKi9cclxuICBpZiAocG0yX2Vudi52ZXJzaW9uaW5nKSB7XHJcblxyXG4gICAgdmFyIHRhYmxlMiA9IG5ldyBUYWJsZSh7XHJcbiAgICAgIHN0eWxlIDogeydwYWRkaW5nLWxlZnQnIDogMSwgaGVhZCA6IFsnY3lhbicsICdib2xkJ10sIGNvbXBhY3QgOiB0cnVlfVxyXG4gICAgfSlcclxuXHJcbiAgICBjb25zb2xlLmxvZyhjaGFsay5pbnZlcnNlLmJvbGQoJyBSZXZpc2lvbiBjb250cm9sIG1ldGFkYXRhICcpKVxyXG4gICAgVXhIZWxwZXJzLnNhZmVfcHVzaCh0YWJsZTIsXHJcbiAgICAgICAgICAgICAgeyAncmV2aXNpb24gY29udHJvbCcgOiBwbTJfZW52LnZlcnNpb25pbmcudHlwZSB9LFxyXG4gICAgICAgICAgICAgIHsgJ3JlbW90ZSB1cmwnIDogcG0yX2Vudi52ZXJzaW9uaW5nLnVybCB9LFxyXG4gICAgICAgICAgICAgIHsgJ3JlcG9zaXRvcnkgcm9vdCcgOiBwbTJfZW52LnZlcnNpb25pbmcucmVwb19wYXRoIH0sXHJcbiAgICAgICAgICAgICAgeyAnbGFzdCB1cGRhdGUnIDogcG0yX2Vudi52ZXJzaW9uaW5nLnVwZGF0ZV90aW1lIH0sXHJcbiAgICAgICAgICAgICAgeyAncmV2aXNpb24nIDogcG0yX2Vudi52ZXJzaW9uaW5nLnJldmlzaW9uIH0sXHJcbiAgICAgICAgICAgICAgeyAnY29tbWVudCcgOiAgcG0yX2Vudi52ZXJzaW9uaW5nLmNvbW1lbnQgPyBwbTJfZW52LnZlcnNpb25pbmcuY29tbWVudC50cmltKCkuc2xpY2UoMCwgNjApIDogJycgfSxcclxuICAgICAgICAgICAgICB7ICdicmFuY2gnIDogIHBtMl9lbnYudmVyc2lvbmluZy5icmFuY2ggfVxyXG4gICAgICAgICAgICAgKVxyXG4gICAgY29uc29sZS5sb2codGFibGUyLnRvU3RyaW5nKCkpXHJcbiAgfVxyXG5cclxuICBpZiAocG0yX2Vudi5heG1fYWN0aW9ucyAmJiBPYmplY3Qua2V5cyhwbTJfZW52LmF4bV9hY3Rpb25zKS5sZW5ndGggPiAwKSB7XHJcbiAgICB2YXIgdGFibGVfYWN0aW9ucyA9IG5ldyBUYWJsZSh7XHJcbiAgICAgIHN0eWxlIDogeydwYWRkaW5nLWxlZnQnIDogMSwgaGVhZCA6IFsnY3lhbicsICdib2xkJ10sIGNvbXBhY3QgOiB0cnVlfVxyXG4gICAgfSlcclxuXHJcbiAgICBjb25zb2xlLmxvZyhjaGFsay5pbnZlcnNlLmJvbGQoJyBBY3Rpb25zIGF2YWlsYWJsZSAnKSlcclxuICAgIHBtMl9lbnYuYXhtX2FjdGlvbnMuZm9yRWFjaChmdW5jdGlvbihhY3Rpb25fc2V0KSB7XHJcbiAgICAgIFV4SGVscGVycy5zYWZlX3B1c2godGFibGVfYWN0aW9ucywgW2FjdGlvbl9zZXQuYWN0aW9uX25hbWVdKVxyXG4gICAgfSlcclxuXHJcbiAgICBjb25zb2xlLmxvZyh0YWJsZV9hY3Rpb25zLnRvU3RyaW5nKCkpXHJcbiAgICBDb21tb24ucHJpbnRPdXQoY2hhbGsud2hpdGUuaXRhbGljKCcgVHJpZ2dlciB2aWE6IHBtMiB0cmlnZ2VyICVzIDxhY3Rpb25fbmFtZT5cXG4nKSwgcG0yX2Vudi5uYW1lKVxyXG4gIH1cclxuXHJcbiAgaWYgKHBtMl9lbnYuYXhtX21vbml0b3IgJiYgT2JqZWN0LmtleXMocG0yX2Vudi5heG1fbW9uaXRvcikubGVuZ3RoID4gMCkge1xyXG4gICAgdmFyIHRhYmxlX3Byb2JlcyA9IG5ldyBUYWJsZSh7XHJcbiAgICAgIHN0eWxlIDogeydwYWRkaW5nLWxlZnQnIDogMSwgaGVhZCA6IFsnY3lhbicsICdib2xkJ10sIGNvbXBhY3QgOiB0cnVlfVxyXG4gICAgfSlcclxuXHJcbiAgICBjb25zb2xlLmxvZyhjaGFsay5pbnZlcnNlLmJvbGQoJyBDb2RlIG1ldHJpY3MgdmFsdWUgJykpXHJcbiAgICBPYmplY3Qua2V5cyhwbTJfZW52LmF4bV9tb25pdG9yKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkge1xyXG4gICAgICB2YXIgb2JqID0ge31cclxuICAgICAgdmFyIG1ldHJpY19uYW1lID0gcG0yX2Vudi5heG1fbW9uaXRvcltrZXldLmhhc093blByb3BlcnR5KFwidmFsdWVcIikgPyBwbTJfZW52LmF4bV9tb25pdG9yW2tleV0udmFsdWUgOiBwbTJfZW52LmF4bV9tb25pdG9yW2tleV1cclxuICAgICAgdmFyIG1ldHJpY191bml0ID0gcG0yX2Vudi5heG1fbW9uaXRvcltrZXldLmhhc093blByb3BlcnR5KFwidW5pdFwiKSA/IHBtMl9lbnYuYXhtX21vbml0b3Jba2V5XS51bml0IDogJydcclxuICAgICAgdmFyIHZhbHVlID0gYCR7bWV0cmljX25hbWV9ICR7bWV0cmljX3VuaXR9YFxyXG4gICAgICBvYmpba2V5XSA9IHZhbHVlXHJcbiAgICAgIFV4SGVscGVycy5zYWZlX3B1c2godGFibGVfcHJvYmVzLCBvYmopXHJcbiAgICB9KVxyXG5cclxuICAgIGNvbnNvbGUubG9nKHRhYmxlX3Byb2Jlcy50b1N0cmluZygpKVxyXG4gIH1cclxuXHJcbiAgdmFyIHRhYmxlX2VudiA9IG5ldyBUYWJsZSh7XHJcbiAgICBzdHlsZSA6IHsncGFkZGluZy1sZWZ0JyA6IDEsIGhlYWQgOiBbJ2N5YW4nLCAnYm9sZCddLCBjb21wYWN0IDogdHJ1ZX1cclxuICB9KVxyXG5cclxuICBjb25zb2xlLmxvZyhjaGFsay5pbnZlcnNlLmJvbGQoJyBEaXZlcmdlbnQgZW52IHZhcmlhYmxlcyBmcm9tIGxvY2FsIGVudiAnKSlcclxuXHJcbiAgdmFyIF9lbnYgPSBDb21tb24uc2FmZUV4dGVuZCh7fSwgcG0yX2VudilcclxuICB2YXIgZGlmZl9lbnYgPSB7fVxyXG5cclxuICBPYmplY3Qua2V5cyhwcm9jZXNzLmVudikuZm9yRWFjaChrID0+IHtcclxuICAgIGlmICghX2VudltrXSB8fCBfZW52W2tdICE9IHByb2Nlc3MuZW52W2tdKSB7XHJcbiAgICAgIGRpZmZfZW52W2tdID0gcHJvY2Vzcy5lbnZba11cclxuICAgIH1cclxuICB9KVxyXG5cclxuICBPYmplY3Qua2V5cyhkaWZmX2VudikuZm9yRWFjaChmdW5jdGlvbihrZXkpIHtcclxuICAgIHZhciBvYmogPSB7fVxyXG4gICAgaWYgKF9lbnZba2V5XSkge1xyXG4gICAgICBvYmpba2V5XSA9IF9lbnZba2V5XS5zbGljZSgwLCBwcm9jZXNzLnN0ZG91dC5jb2x1bW5zIC0gNjApXHJcbiAgICAgIFV4SGVscGVycy5zYWZlX3B1c2godGFibGVfZW52LCBvYmopXHJcbiAgICB9XHJcbiAgfSlcclxuXHJcbiAgY29uc29sZS5sb2codGFibGVfZW52LnRvU3RyaW5nKCkpXHJcbiAgY29uc29sZS5sb2coKVxyXG4gIENvbW1vbi5wcmludE91dChjaGFsay53aGl0ZS5pdGFsaWMoJyBBZGQgeW91ciBvd24gY29kZSBtZXRyaWNzOiBodHRwOi8vYml0Lmx5L2NvZGUtbWV0cmljcycpKVxyXG4gIENvbW1vbi5wcmludE91dChjaGFsay53aGl0ZS5pdGFsaWMoJyBVc2UgYHBtMiBsb2dzICVzIFstLWxpbmVzIDEwMDBdYCB0byBkaXNwbGF5IGxvZ3MnKSwgcG0yX2Vudi5uYW1lKVxyXG4gIENvbW1vbi5wcmludE91dChjaGFsay53aGl0ZS5pdGFsaWMoJyBVc2UgYHBtMiBlbnYgJXNgIHRvIGRpc3BsYXkgZW52aXJvbm1lbnQgdmFyaWFibGVzJyksIHBtMl9lbnYucG1faWQpXHJcbiAgQ29tbW9uLnByaW50T3V0KGNoYWxrLndoaXRlLml0YWxpYygnIFVzZSBgcG0yIG1vbml0YCB0byBtb25pdG9yIENQVSBhbmQgTWVtb3J5IHVzYWdlJyksIHBtMl9lbnYubmFtZSlcclxufVxyXG4iXX0=
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _cliTableau = _interopRequireDefault(require("cli-tableau"));

var _chalk = _interopRequireDefault(require("chalk"));

var _helpers = _interopRequireDefault(require("./helpers"));

var _Common = _interopRequireDefault(require("../../Common"));

var postModuleInfos = function postModuleInfos(module_name, human_info) {
  var table = new _cliTableau["default"]({
    style: {
      'padding-left': 1,
      head: ['cyan', 'bold'],
      compact: true
    }
  });
  var disp = {};
  human_info.unshift(['Module name', module_name]);
  human_info.forEach(function (info) {
    var obj = {};
    obj[_chalk["default"].bold.cyan(info[0])] = info[1];
    table.push(obj);
  });
  console.log();
  console.log(_chalk["default"].bold.inverse(' Module %s infos '), module_name);
  console.log(table.toString());
};
/**
 * Description
 * @method describeTable
 * @param {Object} proc process list
 */


function _default(proc) {
  var table = new _cliTableau["default"]({
    style: {
      'padding-left': 1,
      head: ['cyan', 'bold'],
      compact: true
    }
  });
  var pm2_env = proc.pm2_env;
  var created_at = 'N/A';

  if (pm2_env.axm_options && pm2_env.axm_options.human_info) {
    postModuleInfos(pm2_env.name, pm2_env.axm_options.human_info);
  }

  try {
    if (pm2_env.created_at != null) created_at = new Date(pm2_env.created_at).toISOString();
  } catch (e) {}

  console.log(_chalk["default"].bold.inverse(' Describing process with id %d - name %s '), pm2_env.pm_id, pm2_env.name);

  _helpers["default"].safe_push(table, {
    'status': _helpers["default"].colorStatus(pm2_env.status)
  }, {
    'name': pm2_env.name
  }, {
    'namespace': pm2_env.namespace
  }, {
    'version': pm2_env.version
  }, {
    'restarts': pm2_env.restart_time
  }, {
    'uptime': pm2_env.pm_uptime && pm2_env.status == 'online' ? _helpers["default"].timeSince(pm2_env.pm_uptime) : 0
  }, {
    'script path': pm2_env.pm_exec_path
  }, {
    'script args': pm2_env.args ? (typeof pm2_env.args == 'string' ? JSON.parse(pm2_env.args.replace(/'/g, '"')) : pm2_env.args).join(' ') : null
  }, {
    'error log path': pm2_env.pm_err_log_path
  }, {
    'out log path': pm2_env.pm_out_log_path
  }, {
    'pid path': pm2_env.pm_pid_path
  }, {
    'interpreter': pm2_env.exec_interpreter
  }, {
    'interpreter args': pm2_env.node_args.length != 0 ? pm2_env.node_args : null
  }, {
    'script id': pm2_env.pm_id
  }, {
    'exec cwd': pm2_env.pm_cwd
  }, {
    'exec mode': pm2_env.exec_mode
  }, {
    'node.js version': pm2_env.node_version
  }, {
    'node env': pm2_env.env.NODE_ENV
  }, {
    'watch & reload': pm2_env.watch ? _chalk["default"].green.bold('✔') : '✘'
  }, {
    'unstable restarts': pm2_env.unstable_restarts
  }, {
    'created at': created_at
  });

  if ('pm_log_path' in pm2_env) {
    table.splice(6, 0, {
      'entire log path': pm2_env.pm_log_path
    });
  }

  if ('cron_restart' in pm2_env) {
    table.splice(5, 0, {
      'cron restart': pm2_env.cron_restart
    });
  }

  console.log(table.toString());
  /**
   * Module conf display
   */

  if (pm2_env.axm_options && pm2_env.axm_options.module_conf && Object.keys(pm2_env.axm_options.module_conf).length > 0) {
    var table_conf = new _cliTableau["default"]({
      style: {
        'padding-left': 1,
        head: ['cyan', 'bold'],
        compact: true
      }
    });
    console.log('Process configuration');
    Object.keys(pm2_env.axm_options.module_conf).forEach(function (key) {
      var tmp = {};
      tmp[key] = pm2_env.axm_options.module_conf[key];

      _helpers["default"].safe_push(table_conf, tmp);
    });
    console.log(table_conf.toString());
  }
  /**
   * Versioning metadata
   */


  if (pm2_env.versioning) {
    var table2 = new _cliTableau["default"]({
      style: {
        'padding-left': 1,
        head: ['cyan', 'bold'],
        compact: true
      }
    });
    console.log(_chalk["default"].inverse.bold(' Revision control metadata '));

    _helpers["default"].safe_push(table2, {
      'revision control': pm2_env.versioning.type
    }, {
      'remote url': pm2_env.versioning.url
    }, {
      'repository root': pm2_env.versioning.repo_path
    }, {
      'last update': pm2_env.versioning.update_time
    }, {
      'revision': pm2_env.versioning.revision
    }, {
      'comment': pm2_env.versioning.comment ? pm2_env.versioning.comment.trim().slice(0, 60) : ''
    }, {
      'branch': pm2_env.versioning.branch
    });

    console.log(table2.toString());
  }

  if (pm2_env.axm_actions && Object.keys(pm2_env.axm_actions).length > 0) {
    var table_actions = new _cliTableau["default"]({
      style: {
        'padding-left': 1,
        head: ['cyan', 'bold'],
        compact: true
      }
    });
    console.log(_chalk["default"].inverse.bold(' Actions available '));
    pm2_env.axm_actions.forEach(function (action_set) {
      _helpers["default"].safe_push(table_actions, [action_set.action_name]);
    });
    console.log(table_actions.toString());

    _Common["default"].printOut(_chalk["default"].white.italic(' Trigger via: pm2 trigger %s <action_name>\n'), pm2_env.name);
  }

  if (pm2_env.axm_monitor && Object.keys(pm2_env.axm_monitor).length > 0) {
    var table_probes = new _cliTableau["default"]({
      style: {
        'padding-left': 1,
        head: ['cyan', 'bold'],
        compact: true
      }
    });
    console.log(_chalk["default"].inverse.bold(' Code metrics value '));
    Object.keys(pm2_env.axm_monitor).forEach(function (key) {
      var obj = {};
      var metric_name = pm2_env.axm_monitor[key].hasOwnProperty("value") ? pm2_env.axm_monitor[key].value : pm2_env.axm_monitor[key];
      var metric_unit = pm2_env.axm_monitor[key].hasOwnProperty("unit") ? pm2_env.axm_monitor[key].unit : '';
      var value = "".concat(metric_name, " ").concat(metric_unit);
      obj[key] = value;

      _helpers["default"].safe_push(table_probes, obj);
    });
    console.log(table_probes.toString());
  }

  var table_env = new _cliTableau["default"]({
    style: {
      'padding-left': 1,
      head: ['cyan', 'bold'],
      compact: true
    }
  });
  console.log(_chalk["default"].inverse.bold(' Divergent env variables from local env '));

  var _env = _Common["default"].safeExtend({}, pm2_env);

  var diff_env = {};
  Object.keys(process.env).forEach(function (k) {
    if (!_env[k] || _env[k] != process.env[k]) {
      diff_env[k] = process.env[k];
    }
  });
  Object.keys(diff_env).forEach(function (key) {
    var obj = {};

    if (_env[key]) {
      obj[key] = _env[key].slice(0, process.stdout.columns - 60);

      _helpers["default"].safe_push(table_env, obj);
    }
  });
  console.log(table_env.toString());
  console.log();

  _Common["default"].printOut(_chalk["default"].white.italic(' Add your own code metrics: http://bit.ly/code-metrics'));

  _Common["default"].printOut(_chalk["default"].white.italic(' Use `pm2 logs %s [--lines 1000]` to display logs'), pm2_env.name);

  _Common["default"].printOut(_chalk["default"].white.italic(' Use `pm2 env %s` to display environment variables'), pm2_env.pm_id);

  _Common["default"].printOut(_chalk["default"].white.italic(' Use `pm2 monit` to monitor CPU and Memory usage'), pm2_env.name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BUEkvVVgvcG0yLWRlc2NyaWJlLnRzIl0sIm5hbWVzIjpbInBvc3RNb2R1bGVJbmZvcyIsIm1vZHVsZV9uYW1lIiwiaHVtYW5faW5mbyIsInRhYmxlIiwiVGFibGUiLCJzdHlsZSIsImhlYWQiLCJjb21wYWN0IiwiZGlzcCIsInVuc2hpZnQiLCJmb3JFYWNoIiwiaW5mbyIsIm9iaiIsImNoYWxrIiwiYm9sZCIsImN5YW4iLCJwdXNoIiwiY29uc29sZSIsImxvZyIsImludmVyc2UiLCJ0b1N0cmluZyIsInByb2MiLCJwbTJfZW52IiwiY3JlYXRlZF9hdCIsImF4bV9vcHRpb25zIiwibmFtZSIsIkRhdGUiLCJ0b0lTT1N0cmluZyIsImUiLCJwbV9pZCIsIlV4SGVscGVycyIsInNhZmVfcHVzaCIsImNvbG9yU3RhdHVzIiwic3RhdHVzIiwibmFtZXNwYWNlIiwidmVyc2lvbiIsInJlc3RhcnRfdGltZSIsInBtX3VwdGltZSIsInRpbWVTaW5jZSIsInBtX2V4ZWNfcGF0aCIsImFyZ3MiLCJKU09OIiwicGFyc2UiLCJyZXBsYWNlIiwiam9pbiIsInBtX2Vycl9sb2dfcGF0aCIsInBtX291dF9sb2dfcGF0aCIsInBtX3BpZF9wYXRoIiwiZXhlY19pbnRlcnByZXRlciIsIm5vZGVfYXJncyIsImxlbmd0aCIsInBtX2N3ZCIsImV4ZWNfbW9kZSIsIm5vZGVfdmVyc2lvbiIsImVudiIsIk5PREVfRU5WIiwid2F0Y2giLCJncmVlbiIsInVuc3RhYmxlX3Jlc3RhcnRzIiwic3BsaWNlIiwicG1fbG9nX3BhdGgiLCJjcm9uX3Jlc3RhcnQiLCJtb2R1bGVfY29uZiIsIk9iamVjdCIsImtleXMiLCJ0YWJsZV9jb25mIiwia2V5IiwidG1wIiwidmVyc2lvbmluZyIsInRhYmxlMiIsInR5cGUiLCJ1cmwiLCJyZXBvX3BhdGgiLCJ1cGRhdGVfdGltZSIsInJldmlzaW9uIiwiY29tbWVudCIsInRyaW0iLCJzbGljZSIsImJyYW5jaCIsImF4bV9hY3Rpb25zIiwidGFibGVfYWN0aW9ucyIsImFjdGlvbl9zZXQiLCJhY3Rpb25fbmFtZSIsIkNvbW1vbiIsInByaW50T3V0Iiwid2hpdGUiLCJpdGFsaWMiLCJheG1fbW9uaXRvciIsInRhYmxlX3Byb2JlcyIsIm1ldHJpY19uYW1lIiwiaGFzT3duUHJvcGVydHkiLCJ2YWx1ZSIsIm1ldHJpY191bml0IiwidW5pdCIsInRhYmxlX2VudiIsIl9lbnYiLCJzYWZlRXh0ZW5kIiwiZGlmZl9lbnYiLCJwcm9jZXNzIiwiayIsInN0ZG91dCIsImNvbHVtbnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLGVBQWUsR0FBRyxTQUFsQkEsZUFBa0IsQ0FBVUMsV0FBVixFQUF1QkMsVUFBdkIsRUFBbUM7QUFDdkQsTUFBSUMsS0FBSyxHQUFHLElBQUlDLHNCQUFKLENBQVU7QUFDcEJDLElBQUFBLEtBQUssRUFBRTtBQUFFLHNCQUFnQixDQUFsQjtBQUFxQkMsTUFBQUEsSUFBSSxFQUFFLENBQUMsTUFBRCxFQUFTLE1BQVQsQ0FBM0I7QUFBNkNDLE1BQUFBLE9BQU8sRUFBRTtBQUF0RDtBQURhLEdBQVYsQ0FBWjtBQUlBLE1BQUlDLElBQUksR0FBRyxFQUFYO0FBRUFOLEVBQUFBLFVBQVUsQ0FBQ08sT0FBWCxDQUFtQixDQUFDLGFBQUQsRUFBZ0JSLFdBQWhCLENBQW5CO0FBQ0FDLEVBQUFBLFVBQVUsQ0FBQ1EsT0FBWCxDQUFtQixVQUFVQyxJQUFWLEVBQWdCO0FBQ2pDLFFBQUlDLEdBQUcsR0FBRyxFQUFWO0FBQ0FBLElBQUFBLEdBQUcsQ0FBQ0Msa0JBQU1DLElBQU4sQ0FBV0MsSUFBWCxDQUFnQkosSUFBSSxDQUFDLENBQUQsQ0FBcEIsQ0FBRCxDQUFILEdBQWdDQSxJQUFJLENBQUMsQ0FBRCxDQUFwQztBQUNBUixJQUFBQSxLQUFLLENBQUNhLElBQU4sQ0FBV0osR0FBWDtBQUNELEdBSkQ7QUFNQUssRUFBQUEsT0FBTyxDQUFDQyxHQUFSO0FBQ0FELEVBQUFBLE9B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QUF3RmhFLE9BQU8sQ0FBQ0csSUFBaEc7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBUYWJsZSBmcm9tICdjbGktdGFibGVhdSc7XG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IFV4SGVscGVycyBmcm9tICcuL2hlbHBlcnMnO1xuaW1wb3J0IENvbW1vbiBmcm9tICcuLi8uLi9Db21tb24nO1xuXG52YXIgcG9zdE1vZHVsZUluZm9zID0gZnVuY3Rpb24gKG1vZHVsZV9uYW1lLCBodW1hbl9pbmZvKSB7XG4gIHZhciB0YWJsZSA9IG5ldyBUYWJsZSh7XG4gICAgc3R5bGU6IHsgJ3BhZGRpbmctbGVmdCc6IDEsIGhlYWQ6IFsnY3lhbicsICdib2xkJ10sIGNvbXBhY3Q6IHRydWUgfVxuICB9KVxuXG4gIHZhciBkaXNwID0ge31cblxuICBodW1hbl9pbmZvLnVuc2hpZnQoWydNb2R1bGUgbmFtZScsIG1vZHVsZV9uYW1lXSlcbiAgaHVtYW5faW5mby5mb3JFYWNoKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgdmFyIG9iaiA9IHt9XG4gICAgb2JqW2NoYWxrLmJvbGQuY3lhbihpbmZvWzBdKV0gPSBpbmZvWzFdXG4gICAgdGFibGUucHVzaChvYmopXG4gIH0pXG5cbiAgY29uc29sZS5sb2coKVxuICBjb25zb2xlLmxvZyhjaGFsay5ib2xkLmludmVyc2UoJyBNb2R1bGUgJXMgaW5mb3MgJyksIG1vZHVsZV9uYW1lKVxuICBjb25zb2xlLmxvZyh0YWJsZS50b1N0cmluZygpKVxufVxuXG4vKipcbiAqIERlc2NyaXB0aW9uXG4gKiBAbWV0aG9kIGRlc2NyaWJlVGFibGVcbiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9jIHByb2Nlc3MgbGlzdFxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiAocHJvYykge1xuICB2YXIgdGFibGUgPSBuZXcgVGFibGUoe1xuICAgIHN0eWxlOiB7ICdwYWRkaW5nLWxlZnQnOiAxLCBoZWFkOiBbJ2N5YW4nLCAnYm9sZCddLCBjb21wYWN0OiB0cnVlIH1cbiAgfSlcblxuICB2YXIgcG0yX2VudiA9IHByb2MucG0yX2VudlxuXG4gIHZhciBjcmVhdGVkX2F0ID0gJ04vQSdcblxuICBpZiAocG0yX2Vudi5heG1fb3B0aW9ucyAmJiBwbTJfZW52LmF4bV9vcHRpb25zLmh1bWFuX2luZm8pIHtcbiAgICBwb3N0TW9kdWxlSW5mb3MocG0yX2Vudi5uYW1lLCBwbTJfZW52LmF4bV9vcHRpb25zLmh1bWFuX2luZm8pXG4gIH1cblxuICB0cnkge1xuICAgIGlmIChwbTJfZW52LmNyZWF0ZWRfYXQgIT0gbnVsbClcbiAgICAgIGNyZWF0ZWRfYXQgPSBuZXcgRGF0ZShwbTJfZW52LmNyZWF0ZWRfYXQpLnRvSVNPU3RyaW5nKClcbiAgfSBjYXRjaCAoZSkge1xuICB9XG5cbiAgY29uc29sZS5sb2coY2hhbGsuYm9sZC5pbnZlcnNlKCcgRGVzY3JpYmluZyBwcm9jZXNzIHdpdGggaWQgJWQgLSBuYW1lICVzICcpLCBwbTJfZW52LnBtX2lkLCBwbTJfZW52Lm5hbWUpXG4gIFV4SGVscGVycy5zYWZlX3B1c2godGFibGUsXG4gICAgeyAnc3RhdHVzJzogVXhIZWxwZXJzLmNvbG9yU3RhdHVzKHBtMl9lbnYuc3RhdHVzKSB9LFxuICAgIHsgJ25hbWUnOiBwbTJfZW52Lm5hbWUgfSxcbiAgICB7ICduYW1lc3BhY2UnOiBwbTJfZW52Lm5hbWVzcGFjZSB9LFxuICAgIHsgJ3ZlcnNpb24nOiBwbTJfZW52LnZlcnNpb24gfSxcbiAgICB7ICdyZXN0YXJ0cyc6IHBtMl9lbnYucmVzdGFydF90aW1lIH0sXG4gICAgeyAndXB0aW1lJzogKHBtMl9lbnYucG1fdXB0aW1lICYmIHBtMl9lbnYuc3RhdHVzID09ICdvbmxpbmUnKSA/IFV4SGVscGVycy50aW1lU2luY2UocG0yX2Vudi5wbV91cHRpbWUpIDogMCB9LFxuICAgIHsgJ3NjcmlwdCBwYXRoJzogcG0yX2Vudi5wbV9leGVjX3BhdGggfSxcbiAgICB7ICdzY3JpcHQgYXJncyc6IHBtMl9lbnYuYXJncyA/ICh0eXBlb2YgcG0yX2Vudi5hcmdzID09ICdzdHJpbmcnID8gSlNPTi5wYXJzZShwbTJfZW52LmFyZ3MucmVwbGFjZSgvJy9nLCAnXCInKSkgOiBwbTJfZW52LmFyZ3MpLmpvaW4oJyAnKSA6IG51bGwgfSxcbiAgICB7ICdlcnJvciBsb2cgcGF0aCc6IHBtMl9lbnYucG1fZXJyX2xvZ19wYXRoIH0sXG4gICAgeyAnb3V0IGxvZyBwYXRoJzogcG0yX2Vudi5wbV9vdXRfbG9nX3BhdGggfSxcbiAgICB7ICdwaWQgcGF0aCc6IHBtMl9lbnYucG1fcGlkX3BhdGggfSxcblxuICAgIHsgJ2ludGVycHJldGVyJzogcG0yX2Vudi5leGVjX2ludGVycHJldGVyIH0sXG4gICAgeyAnaW50ZXJwcmV0ZXIgYXJncyc6IHBtMl9lbnYubm9kZV9hcmdzLmxlbmd0aCAhPSAwID8gcG0yX2Vudi5ub2RlX2FyZ3MgOiBudWxsIH0sXG5cbiAgICB7ICdzY3JpcHQgaWQnOiBwbTJfZW52LnBtX2lkIH0sXG4gICAgeyAnZXhlYyBjd2QnOiBwbTJfZW52LnBtX2N3ZCB9LFxuXG4gICAgeyAnZXhlYyBtb2RlJzogcG0yX2Vudi5leGVjX21vZGUgfSxcbiAgICB7ICdub2RlLmpzIHZlcnNpb24nOiBwbTJfZW52Lm5vZGVfdmVyc2lvbiB9LFxuICAgIHsgJ25vZGUgZW52JzogcG0yX2Vudi5lbnYuTk9ERV9FTlYgfSxcbiAgICB7ICd3YXRjaCAmIHJlbG9hZCc6IHBtMl9lbnYud2F0Y2ggPyBjaGFsay5ncmVlbi5ib2xkKCfinJQnKSA6ICfinJgnIH0sXG4gICAgeyAndW5zdGFibGUgcmVzdGFydHMnOiBwbTJfZW52LnVuc3RhYmxlX3Jlc3RhcnRzIH0sXG4gICAgeyAnY3JlYXRlZCBhdCc6IGNyZWF0ZWRfYXQgfVxuICApXG5cbiAgaWYgKCdwbV9sb2dfcGF0aCcgaW4gcG0yX2Vudikge1xuICAgIHRhYmxlLnNwbGljZSg2LCAwLCB7ICdlbnRpcmUgbG9nIHBhdGgnOiBwbTJfZW52LnBtX2xvZ19wYXRoIH0pXG4gIH1cblxuICBpZiAoJ2Nyb25fcmVzdGFydCcgaW4gcG0yX2Vudikge1xuICAgIHRhYmxlLnNwbGljZSg1LCAwLCB7ICdjcm9uIHJlc3RhcnQnOiBwbTJfZW52LmNyb25fcmVzdGFydCB9KVxuICB9XG5cbiAgY29uc29sZS5sb2codGFibGUudG9TdHJpbmcoKSlcblxuICAvKipcbiAgICogTW9kdWxlIGNvbmYgZGlzcGxheVxuICAgKi9cbiAgaWYgKHBtMl9lbnYuYXhtX29wdGlvbnMgJiZcbiAgICBwbTJfZW52LmF4bV9vcHRpb25zLm1vZHVsZV9jb25mICYmXG4gICAgT2JqZWN0LmtleXMocG0yX2Vudi5heG1fb3B0aW9ucy5tb2R1bGVfY29uZikubGVuZ3RoID4gMCkge1xuICAgIHZhciB0YWJsZV9jb25mID0gbmV3IFRhYmxlKHtcbiAgICAgIHN0eWxlOiB7ICdwYWRkaW5nLWxlZnQnOiAxLCBoZWFkOiBbJ2N5YW4nLCAnYm9sZCddLCBjb21wYWN0OiB0cnVlIH1cbiAgICB9KVxuICAgIGNvbnNvbGUubG9nKCdQcm9jZXNzIGNvbmZpZ3VyYXRpb24nKVxuXG4gICAgT2JqZWN0LmtleXMocG0yX2Vudi5heG1fb3B0aW9ucy5tb2R1bGVfY29uZikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XG4gICAgICB2YXIgdG1wID0ge31cbiAgICAgIHRtcFtrZXldID0gcG0yX2Vudi5heG1fb3B0aW9ucy5tb2R1bGVfY29uZltrZXldXG4gICAgICBVeEhlbHBlcnMuc2FmZV9wdXNoKHRhYmxlX2NvbmYsIHRtcClcbiAgICB9KVxuXG4gICAgY29uc29sZS5sb2codGFibGVfY29uZi50b1N0cmluZygpKVxuICB9XG5cbiAgLyoqXG4gICAqIFZlcnNpb25pbmcgbWV0YWRhdGFcbiAgICovXG4gIGlmIChwbTJfZW52LnZlcnNpb25pbmcpIHtcblxuICAgIHZhciB0YWJsZTIgPSBuZXcgVGFibGUoe1xuICAgICAgc3R5bGU6IHsgJ3BhZGRpbmctbGVmdCc6IDEsIGhlYWQ6IFsnY3lhbicsICdib2xkJ10sIGNvbXBhY3Q6IHRydWUgfVxuICAgIH0pXG5cbiAgICBjb25zb2xlLmxvZyhjaGFsay5pbnZlcnNlLmJvbGQoJyBSZXZpc2lvbiBjb250cm9sIG1ldGFkYXRhICcpKVxuICAgIFV4SGVscGVycy5zYWZlX3B1c2godGFibGUyLFxuICAgICAgeyAncmV2aXNpb24gY29udHJvbCc6IHBtMl9lbnYudmVyc2lvbmluZy50eXBlIH0sXG4gICAgICB7ICdyZW1vdGUgdXJsJzogcG0yX2Vudi52ZXJzaW9uaW5nLnVybCB9LFxuICAgICAgeyAncmVwb3NpdG9yeSByb290JzogcG0yX2Vudi52ZXJzaW9uaW5nLnJlcG9fcGF0aCB9LFxuICAgICAgeyAnbGFzdCB1cGRhdGUnOiBwbTJfZW52LnZlcnNpb25pbmcudXBkYXRlX3RpbWUgfSxcbiAgICAgIHsgJ3JldmlzaW9uJzogcG0yX2Vudi52ZXJzaW9uaW5nLnJldmlzaW9uIH0sXG4gICAgICB7ICdjb21tZW50JzogcG0yX2Vudi52ZXJzaW9uaW5nLmNvbW1lbnQgPyBwbTJfZW52LnZlcnNpb25pbmcuY29tbWVudC50cmltKCkuc2xpY2UoMCwgNjApIDogJycgfSxcbiAgICAgIHsgJ2JyYW5jaCc6IHBtMl9lbnYudmVyc2lvbmluZy5icmFuY2ggfVxuICAgIClcbiAgICBjb25zb2xlLmxvZyh0YWJsZTIudG9TdHJpbmcoKSlcbiAgfVxuXG4gIGlmIChwbTJfZW52LmF4bV9hY3Rpb25zICYmIE9iamVjdC5rZXlzKHBtMl9lbnYuYXhtX2FjdGlvbnMpLmxlbmd0aCA+IDApIHtcbiAgICB2YXIgdGFibGVfYWN0aW9ucyA9IG5ldyBUYWJsZSh7XG4gICAgICBzdHlsZTogeyAncGFkZGluZy1sZWZ0JzogMSwgaGVhZDogWydjeWFuJywgJ2JvbGQnXSwgY29tcGFjdDogdHJ1ZSB9XG4gICAgfSlcblxuICAgIGNvbnNvbGUubG9nKGNoYWxrLmludmVyc2UuYm9sZCgnIEFjdGlvbnMgYXZhaWxhYmxlICcpKVxuICAgIHBtMl9lbnYuYXhtX2FjdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAoYWN0aW9uX3NldCkge1xuICAgICAgVXhIZWxwZXJzLnNhZmVfcHVzaCh0YWJsZV9hY3Rpb25zLCBbYWN0aW9uX3NldC5hY3Rpb25fbmFtZV0pXG4gICAgfSlcblxuICAgIGNvbnNvbGUubG9nKHRhYmxlX2FjdGlvbnMudG9TdHJpbmcoKSlcbiAgICBDb21tb24ucHJpbnRPdXQoY2hhbGsud2hpdGUuaXRhbGljKCcgVHJpZ2dlciB2aWE6IHBtMiB0cmlnZ2VyICVzIDxhY3Rpb25fbmFtZT5cXG4nKSwgcG0yX2Vudi5uYW1lKVxuICB9XG5cbiAgaWYgKHBtMl9lbnYuYXhtX21vbml0b3IgJiYgT2JqZWN0LmtleXMocG0yX2Vudi5heG1fbW9uaXRvcikubGVuZ3RoID4gMCkge1xuICAgIHZhciB0YWJsZV9wcm9iZXMgPSBuZXcgVGFibGUoe1xuICAgICAgc3R5bGU6IHsgJ3BhZGRpbmctbGVmdCc6IDEsIGhlYWQ6IFsnY3lhbicsICdib2xkJ10sIGNvbXBhY3Q6IHRydWUgfVxuICAgIH0pXG5cbiAgICBjb25zb2xlLmxvZyhjaGFsay5pbnZlcnNlLmJvbGQoJyBDb2RlIG1ldHJpY3MgdmFsdWUgJykpXG4gICAgT2JqZWN0LmtleXMocG0yX2Vudi5heG1fbW9uaXRvcikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XG4gICAgICB2YXIgb2JqID0ge31cbiAgICAgIHZhciBtZXRyaWNfbmFtZSA9IHBtMl9lbnYuYXhtX21vbml0b3Jba2V5XS5oYXNPd25Qcm9wZXJ0eShcInZhbHVlXCIpID8gcG0yX2Vudi5heG1fbW9uaXRvcltrZXldLnZhbHVlIDogcG0yX2Vudi5heG1fbW9uaXRvcltrZXldXG4gICAgICB2YXIgbWV0cmljX3VuaXQgPSBwbTJfZW52LmF4bV9tb25pdG9yW2tleV0uaGFzT3duUHJvcGVydHkoXCJ1bml0XCIpID8gcG0yX2Vudi5heG1fbW9uaXRvcltrZXldLnVuaXQgOiAnJ1xuICAgICAgdmFyIHZhbHVlID0gYCR7bWV0cmljX25hbWV9ICR7bWV0cmljX3VuaXR9YFxuICAgICAgb2JqW2tleV0gPSB2YWx1ZVxuICAgICAgVXhIZWxwZXJzLnNhZmVfcHVzaCh0YWJsZV9wcm9iZXMsIG9iailcbiAgICB9KVxuXG4gICAgY29uc29sZS5sb2codGFibGVfcHJvYmVzLnRvU3RyaW5nKCkpXG4gIH1cblxuICB2YXIgdGFibGVfZW52ID0gbmV3IFRhYmxlKHtcbiAgICBzdHlsZTogeyAncGFkZGluZy1sZWZ0JzogMSwgaGVhZDogWydjeWFuJywgJ2JvbGQnXSwgY29tcGFjdDogdHJ1ZSB9XG4gIH0pXG5cbiAgY29uc29sZS5sb2coY2hhbGsuaW52ZXJzZS5ib2xkKCcgRGl2ZXJnZW50IGVudiB2YXJpYWJsZXMgZnJvbSBsb2NhbCBlbnYgJykpXG5cbiAgdmFyIF9lbnYgPSBDb21tb24uc2FmZUV4dGVuZCh7fSwgcG0yX2VudilcbiAgdmFyIGRpZmZfZW52ID0ge31cblxuICBPYmplY3Qua2V5cyhwcm9jZXNzLmVudikuZm9yRWFjaChrID0+IHtcbiAgICBpZiAoIV9lbnZba10gfHwgX2VudltrXSAhPSBwcm9jZXNzLmVudltrXSkge1xuICAgICAgZGlmZl9lbnZba10gPSBwcm9jZXNzLmVudltrXVxuICAgIH1cbiAgfSlcblxuICBPYmplY3Qua2V5cyhkaWZmX2VudikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XG4gICAgdmFyIG9iaiA9IHt9XG4gICAgaWYgKF9lbnZba2V5XSkge1xuICAgICAgb2JqW2tleV0gPSBfZW52W2tleV0uc2xpY2UoMCwgcHJvY2Vzcy5zdGRvdXQuY29sdW1ucyAtIDYwKVxuICAgICAgVXhIZWxwZXJzLnNhZmVfcHVzaCh0YWJsZV9lbnYsIG9iailcbiAgICB9XG4gIH0pXG5cbiAgY29uc29sZS5sb2codGFibGVfZW52LnRvU3RyaW5nKCkpXG4gIGNvbnNvbGUubG9nKClcbiAgQ29tbW9uLnByaW50T3V0KGNoYWxrLndoaXRlLml0YWxpYygnIEFkZCB5b3VyIG93biBjb2RlIG1ldHJpY3M6IGh0dHA6Ly9iaXQubHkvY29kZS1tZXRyaWNzJykpXG4gIENvbW1vbi5wcmludE91dChjaGFsay53aGl0ZS5pdGFsaWMoJyBVc2UgYHBtMiBsb2dzICVzIFstLWxpbmVzIDEwMDBdYCB0byBkaXNwbGF5IGxvZ3MnKSwgcG0yX2Vudi5uYW1lKVxuICBDb21tb24ucHJpbnRPdXQoY2hhbGsud2hpdGUuaXRhbGljKCcgVXNlIGBwbTIgZW52ICVzYCB0byBkaXNwbGF5IGVudmlyb25tZW50IHZhcmlhYmxlcycpLCBwbTJfZW52LnBtX2lkKVxuICBDb21tb24ucHJpbnRPdXQoY2hhbGsud2hpdGUuaXRhbGljKCcgVXNlIGBwbTIgbW9uaXRgIHRvIG1vbml0b3IgQ1BVIGFuZCBNZW1vcnkgdXNhZ2UnKSwgcG0yX2Vudi5uYW1lKVxufVxuIl19
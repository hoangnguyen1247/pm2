"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _pm2Multimeter = _interopRequireDefault(require("pm2-multimeter"));

var _os = _interopRequireDefault(require("os"));

var _path = _interopRequireDefault(require("path"));

var _chalk = _interopRequireDefault(require("chalk"));

var _UX = _interopRequireDefault(require("./UX"));

var _debug = _interopRequireDefault(require("debug"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
// pm2-htop
// Library who interacts with PM2 to display processes resources in htop way
// by Strzelewicz Alexandre
var debug = (0, _debug["default"])('pm2:monit'); // Cst for light programs

var RATIO_T1 = Math.floor(_os["default"].totalmem() / 500); // Cst for medium programs

var RATIO_T2 = Math.floor(_os["default"].totalmem() / 50); // Cst for heavy programs

var RATIO_T3 = Math.floor(_os["default"].totalmem() / 5); // Cst for heavy programs

var RATIO_T4 = Math.floor(_os["default"].totalmem());
var Monit = {}; //helper to get bars.length (num bars printed)

Object.size = function (obj) {
  var size = 0,
      key;

  for (key in obj) {
    if (obj.hasOwnProperty(key)) size++;
  }

  return size;
};
/**
 * Reset the monitor through charm, basically \033c
 * @param  String msg optional message to show
 * @return Monit
 */


Monit.reset = function (msg) {
  this.multi.charm.reset();
  this.multi.write('\x1B[32m⌬ PM2 \x1B[39mmonitoring\x1B[96m (To go further check out https://app.pm2.io) \x1B[39m\n\n');

  if (msg) {
    this.multi.write(msg);
  }

  this.bars = {};
  return this;
};
/**
 * Synchronous Monitor init method
 * @method init
 * @return Monit
 */


Monit.init = function () {
  this.multi = (0, _pm2Multimeter["default"])(process);
  this.multi.on('^C', this.stop);
  this.reset();
  return this;
};
/**
 * Stops monitor
 * @method stop
 */


Monit.stop = function () {
  this.multi.charm.destroy();
  process.exit(0);
};
/**
 * Refresh monitor
 * @method refresh
 * @param {} processes
 * @return this
 */


Monit.refresh = function (processes) {
  debug('Monit refresh');

  if (!processes) {
    processes = [];
  }

  var num = processes.length;
  this.num_bars = Object.size(this.bars);

  if (num !== this.num_bars) {
    debug('Monit addProcesses - actual: %s, new: %s', this.num_bars, num);
    return this.addProcesses(processes);
  } else {
    if (num === 0) {
      return;
    }

    debug('Monit refresh');
    var proc;

    for (var i = 0; i < num; i++) {
      proc = processes[i]; //this is to avoid a print issue when the process is restarted for example
      //we might also check for the pid but restarted|restarting will be rendered bad

      if (this.bars[proc.pm_id] && proc.pm2_env.status !== this.bars[proc.pm_id].status) {
        debug('bars for %s does not exist', proc.pm_id);
        this.addProcesses(processes);
        break;
      }

      this.updateBars(proc);
    }
  }

  return this;
};

Monit.addProcess = function (proc, i) {
  if (proc.pm_id in this.bars) {
    return;
  }

  if (proc.monit.error) throw new Error(JSON.stringify(proc.monit.error));

  var process_name = proc.pm2_env.name || _path["default"].basename(proc.pm2_env.pm_exec_path);

  var status = proc.pm2_env.status == 'online' ? _chalk["default"].green.bold('●') : _chalk["default"].red.bold('●');
  this.multi.write(' ' + status + ' ' + _chalk["default"].green.bold(process_name));
  this.multi.write('\n');
  this.multi.write('[' + proc.pm2_env.pm_id + '] [' + proc.pm2_env.exec_mode + ']\n');
  var bar_cpu = this.multi(40, i * 2 + 3 + i, {
    width: 30,
    solid: {
      text: '|',
      foreground: 'white',
      background: 'blue'
    },
    empty: {
      text: ' '
    }
  });
  var bar_memory = this.multi(40, i * 2 + 4 + i, {
    width: 30,
    solid: {
      text: '|',
      foreground: 'white',
      background: 'red'
    },
    empty: {
      text: ' '
    }
  });
  this.bars[proc.pm_id] = {
    memory: bar_memory,
    cpu: bar_cpu,
    status: proc.pm2_env.status
  };
  this.updateBars(proc);
  this.multi.write('\n');
  return this;
};

Monit.addProcesses = function (processes) {
  if (!processes) {
    processes = [];
  }

  this.reset();
  var num = processes.length;

  if (num > 0) {
    for (var i = 0; i < num; i++) {
      this.addProcess(processes[i], i);
    }
  } else {
    this.reset('No processes to monit');
  }
}; // Draw memory bars

/**
 * Description
 * @method drawRatio
 * @param {} bar_memory
 * @param {} memory
 * @return
 */


Monit.drawRatio = function (bar_memory, memory) {
  var scale = 0;
  if (memory < RATIO_T1) scale = RATIO_T1;else if (memory < RATIO_T2) scale = RATIO_T2;else if (memory < RATIO_T3) scale = RATIO_T3;else scale = RATIO_T4;
  bar_memory.ratio(memory, scale, _UX["default"].helpers.bytesToSize(memory, 3));
};
/**
 * Updates bars informations
 * @param  {} proc       proc object
 * @return  this
 */


Monit.updateBars = function (proc) {
  if (this.bars[proc.pm_id]) {
    if (proc.pm2_env.status !== 'online' || proc.pm2_env.status !== this.bars[proc.pm_id].status) {
      this.bars[proc.pm_id].cpu.percent(0, _chalk["default"].red(proc.pm2_env.status));
      this.drawRatio(this.bars[proc.pm_id].memory, 0, _chalk["default"].red(proc.pm2_env.status));
    } else if (!proc.monit) {
      this.bars[proc.pm_id].cpu.percent(0, _chalk["default"].red('No data'));
      this.drawRatio(this.bars[proc.pm_id].memory, 0, _chalk["default"].red('No data'));
    } else {
      this.bars[proc.pm_id].cpu.percent(proc.monit.cpu);
      this.drawRatio(this.bars[proc.pm_id].memory, proc.monit.memory);
    }
  }

  return this;
};

var _default = Monit;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BUEkvTW9uaXQudHMiXSwibmFtZXMiOlsiZGVidWciLCJSQVRJT19UMSIsIk1hdGgiLCJmbG9vciIsIm9zIiwidG90YWxtZW0iLCJSQVRJT19UMiIsIlJBVElPX1QzIiwiUkFUSU9fVDQiLCJNb25pdCIsIk9iamVjdCIsInNpemUiLCJvYmoiLCJrZXkiLCJoYXNPd25Qcm9wZXJ0eSIsInJlc2V0IiwibXNnIiwibXVsdGkiLCJjaGFybSIsIndyaXRlIiwiYmFycyIsImluaXQiLCJwcm9jZXNzIiwib24iLCJzdG9wIiwiZGVzdHJveSIsImV4aXQiLCJyZWZyZXNoIiwicHJvY2Vzc2VzIiwibnVtIiwibGVuZ3RoIiwibnVtX2JhcnMiLCJhZGRQcm9jZXNzZXMiLCJwcm9jIiwiaSIsInBtX2lkIiwicG0yX2VudiIsInN0YXR1cyIsInVwZGF0ZUJhcnMiLCJhZGRQcm9jZXNzIiwibW9uaXQiLCJlcnJvciIsIkVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsInByb2Nlc3NfbmFtZSIsIm5hbWUiLCJwIiwiYmFzZW5hbWUiLCJwbV9leGVjX3BhdGgiLCJjaGFsayIsImdyZWVuIiwiYm9sZCIsInJlZCIsImV4ZWNfbW9kZSIsImJhcl9jcHUiLCJ3aWR0aCIsInNvbGlkIiwidGV4dCIsImZvcmVncm91bmQiLCJiYWNrZ3JvdW5kIiwiZW1wdHkiLCJiYXJfbWVtb3J5IiwibWVtb3J5IiwiY3B1IiwiZHJhd1JhdGlvIiwic2NhbGUiLCJyYXRpbyIsIlVYIiwiaGVscGVycyIsImJ5dGVzVG9TaXplIiwicGVyY2VudCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQVNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUVBOzs7O0FBaEJBOzs7OztBQUtBO0FBQ0E7QUFDQTtBQVdBLElBQU1BLEtBQUssR0FBRyx1QkFBWSxXQUFaLENBQWQsQyxDQUVBOztBQUNBLElBQU1DLFFBQVEsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVdDLGVBQUdDLFFBQUgsS0FBZ0Is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SSxDQUFDTyxLQUFMLENBQVd3QixHQUE3QztBQUNBLFdBQUtDLFNBQUwsQ0FBZSxLQUFLN0MsSUFBTCxDQUFVYSxJQUFJLENBQUNFLEtBQWYsRUFBc0I0QixNQUFyQyxFQUE2QzlCLElBQUksQ0FBQ08sS0FBTCxDQUFXdUIsTUFBeEQ7QUFDRDtBQUNGOztBQUVELFNBQU8sSUFBUDtBQUNELENBZkQ7O2VBaUJldEQsSyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMTMgdGhlIFBNMiBwcm9qZWN0IGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIGxpY2Vuc2UgdGhhdFxuICogY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuXG4gKi9cbi8vIHBtMi1odG9wXG4vLyBMaWJyYXJ5IHdobyBpbnRlcmFjdHMgd2l0aCBQTTIgdG8gZGlzcGxheSBwcm9jZXNzZXMgcmVzb3VyY2VzIGluIGh0b3Agd2F5XG4vLyBieSBTdHJ6ZWxld2ljeiBBbGV4YW5kcmVcblxuaW1wb3J0IG11bHRpbWV0ZXIgZnJvbSAncG0yLW11bHRpbWV0ZXInO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcblxuaW1wb3J0IFVYIGZyb20gJy4vVVgnO1xuXG5pbXBvcnQgZGVidWdMb2dnZXIgZnJvbSAnZGVidWcnO1xuXG5jb25zdCBkZWJ1ZyA9IGRlYnVnTG9nZ2VyKCdwbTI6bW9uaXQnKTtcblxuLy8gQ3N0IGZvciBsaWdodCBwcm9ncmFtc1xuY29uc3QgUkFUSU9fVDEgPSBNYXRoLmZsb29yKG9zLnRvdGFsbWVtKCkgLyA1MDApO1xuLy8gQ3N0IGZvciBtZWRpdW0gcHJvZ3JhbXNcbmNvbnN0IFJBVElPX1QyID0gTWF0aC5mbG9vcihvcy50b3RhbG1lbSgpIC8gNTApO1xuLy8gQ3N0IGZvciBoZWF2eSBwcm9ncmFtc1xuY29uc3QgUkFUSU9fVDMgPSBNYXRoLmZsb29yKG9zLnRvdGFsbWVtKCkgLyA1KTtcbi8vIENzdCBmb3IgaGVhdnkgcHJvZ3JhbXNcbmNvbnN0IFJBVElPX1Q0ID0gTWF0aC5mbG9vcihvcy50b3RhbG1lbSgpKTtcblxudmFyIE1vbml0OiBhbnkgPSB7fTtcblxuLy9oZWxwZXIgdG8gZ2V0IGJhcnMubGVuZ3RoIChudW0gYmFycyBwcmludGVkKVxuT2JqZWN0LnNpemUgPSBmdW5jdGlvbiAob2JqKSB7XG4gIHZhciBzaXplID0gMCwga2V5O1xuICBmb3IgKGtleSBpbiBvYmopIHtcbiAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHNpemUrKztcbiAgfVxuICByZXR1cm4gc2l6ZTtcbn07XG5cbi8qKlxuICogUmVzZXQgdGhlIG1vbml0b3IgdGhyb3VnaCBjaGFybSwgYmFzaWNhbGx5IFxcMDMzY1xuICogQHBhcmFtICBTdHJpbmcgbXNnIG9wdGlvbmFsIG1lc3NhZ2UgdG8gc2hvd1xuICogQHJldHVybiBNb25pdFxuICovXG5Nb25pdC5yZXNldCA9IGZ1bmN0aW9uIChtc2cpIHtcblxuICB0aGlzLm11bHRpLmNoYXJtLnJlc2V0KCk7XG5cbiAgdGhpcy5tdWx0aS53cml0ZSgnXFx4MUJbMzJt4oysIFBNMiBcXHgxQlszOW1tb25pdG9yaW5nXFx4MUJbOTZtIChUbyBnbyBmdXJ0aGVyIGNoZWNrIG91dCBodHRwczovL2FwcC5wbTIuaW8pIFxceDFCWzM5bVxcblxcbicpO1xuXG4gIGlmIChtc2cpIHtcbiAgICB0aGlzLm11bHRpLndyaXRlKG1zZyk7XG4gIH1cblxuICB0aGlzLmJhcnMgPSB7fTtcblxuICByZXR1cm4gdGhpcztcbn1cblxuLyoqXG4gKiBTeW5jaHJvbm91cyBNb25pdG9yIGluaXQgbWV0aG9kXG4gKiBAbWV0aG9kIGluaXRcbiAqIEByZXR1cm4gTW9uaXRcbiAqL1xuTW9uaXQuaW5pdCA9IGZ1bmN0aW9uICgpIHtcblxuICB0aGlzLm11bHRpID0gbXVsdGltZXRlcihwcm9jZXNzKTtcblxuICB0aGlzLm11bHRpLm9uKCdeQycsIHRoaXMuc3RvcCk7XG5cbiAgdGhpcy5yZXNldCgpO1xuXG4gIHJldHVybiB0aGlzO1xufVxuXG4vKipcbiAqIFN0b3BzIG1vbml0b3JcbiAqIEBtZXRob2Qgc3RvcFxuICovXG5Nb25pdC5zdG9wID0gZnVuY3Rpb24gKCkge1xuICB0aGlzLm11bHRpLmNoYXJtLmRlc3Ryb3koKTtcbiAgcHJvY2Vzcy5leGl0KDApO1xufVxuXG5cbi8qKlxuICogUmVmcmVzaCBtb25pdG9yXG4gKiBAbWV0aG9kIHJlZnJlc2hcbiAqIEBwYXJhbSB7fSBwcm9jZXNzZXNcbiAqIEByZXR1cm4gdGhpc1xuICovXG5Nb25pdC5yZWZyZXNoID0gZnVuY3Rpb24gKHByb2Nlc3Nlcykge1xuICBkZWJ1ZygnTW9uaXQgcmVmcmVzaCcpO1xuXG4gIGlmICghcHJvY2Vzc2VzKSB7XG4gICAgcHJvY2Vzc2VzID0gW107XG4gIH1cblxuICB2YXIgbnVtID0gcHJvY2Vzc2VzLmxlbmd0aDtcbiAgdGhpcy5udW1fYmFycyA9IE9iamVjdC5zaXplKHRoaXMuYmFycyk7XG5cbiAgaWYgKG51bSAhPT0gdGhpcy5udW1fYmFycykge1xuICAgIGRlYnVnKCdNb25pdCBhZGRQcm9jZXNzZXMgLSBhY3R1YWw6ICVzLCBuZXc6ICVzJywgdGhpcy5udW1fYmFycywgbnVtKTtcbiAgICByZXR1cm4gdGhpcy5hZGRQcm9jZXNzZXMocHJvY2Vzc2VzKTtcbiAgfSBlbHNlIHtcblxuICAgIGlmIChudW0gPT09IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBkZWJ1ZygnTW9uaXQgcmVmcmVzaCcpO1xuICAgIHZhciBwcm9jO1xuXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBudW07IGkrKykge1xuICAgICAgcHJvYyA9IHByb2Nlc3Nlc1tpXTtcblxuICAgICAgLy90aGlzIGlzIHRvIGF2b2lkIGEgcHJpbnQgaXNzdWUgd2hlbiB0aGUgcHJvY2VzcyBpcyByZXN0YXJ0ZWQgZm9yIGV4YW1wbGVcbiAgICAgIC8vd2UgbWlnaHQgYWxzbyBjaGVjayBmb3IgdGhlIHBpZCBidXQgcmVzdGFydGVkfHJlc3RhcnRpbmcgd2lsbCBiZSByZW5kZXJlZCBiYWRcbiAgICAgIGlmICh0aGlzLmJhcnNbcHJvYy5wbV9pZF0gJiYgcHJvYy5wbTJfZW52LnN0YXR1cyAhPT0gdGhpcy5iYXJzW3Byb2MucG1faWRdLnN0YXR1cykge1xuICAgICAgICBkZWJ1ZygnYmFycyBmb3IgJXMgZG9lcyBub3QgZXhpc3QnLCBwcm9jLnBtX2lkKTtcbiAgICAgICAgdGhpcy5hZGRQcm9jZXNzZXMocHJvY2Vzc2VzKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIHRoaXMudXBkYXRlQmFycyhwcm9jKTtcblxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0aGlzO1xufVxuXG5Nb25pdC5hZGRQcm9jZXNzID0gZnVuY3Rpb24gKHByb2MsIGkpIHtcbiAgaWYgKHByb2MucG1faWQgaW4gdGhpcy5iYXJzKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKHByb2MubW9uaXQuZXJyb3IpXG4gICAgdGhyb3cgbmV3IEVycm9yKEpTT04uc3RyaW5naWZ5KHByb2MubW9uaXQuZXJyb3IpKTtcblxuICB2YXIgcHJvY2Vzc19uYW1lID0gcHJvYy5wbTJfZW52Lm5hbWUgfHwgcC5iYXNlbmFtZShwcm9jLnBtMl9lbnYucG1fZXhlY19wYXRoKTtcbiAgdmFyIHN0YXR1cyA9IHByb2MucG0yX2Vudi5zdGF0dXMgPT0gJ29ubGluZScgPyBjaGFsay5ncmVlbi5ib2xkKCfil48nKSA6IGNoYWxrLnJlZC5ib2xkKCfil48nKTtcblxuICB0aGlzLm11bHRpLndyaXRlKCcgJyArIHN0YXR1cyArICcgJyArIGNoYWxrLmdyZWVuLmJvbGQocHJvY2Vzc19uYW1lKSk7XG4gIHRoaXMubXVsdGkud3JpdGUoJ1xcbicpO1xuICB0aGlzLm11bHRpLndyaXRlKCdbJyArIHByb2MucG0yX2Vudi5wbV9pZCArICddIFsnICsgcHJvYy5wbTJfZW52LmV4ZWNfbW9kZSArICddXFxuJyk7XG5cbiAgdmFyIGJhcl9jcHUgPSB0aGlzLm11bHRpKDQwLCAoaSAqIDIpICsgMyArIGksIHtcbiAgICB3aWR0aDogMzAsXG4gICAgc29saWQ6IHtcbiAgICAgIHRleHQ6ICd8JyxcbiAgICAgIGZvcmVncm91bmQ6ICd3aGl0ZScsXG4gICAgICBiYWNrZ3JvdW5kOiAnYmx1ZSdcbiAgICB9LFxuICAgIGVtcHR5OiB7XG4gICAgICB0ZXh0OiAnICdcbiAgICB9XG4gIH0pO1xuXG4gIHZhciBiYXJfbWVtb3J5ID0gdGhpcy5tdWx0aSg0MCwgKGkgKiAyKSArIDQgKyBpLCB7XG4gICAgd2lkdGg6IDMwLFxuICAgIHNvbGlkOiB7XG4gICAgICB0ZXh0OiAnfCcsXG4gICAgICBmb3JlZ3JvdW5kOiAnd2hpdGUnLFxuICAgICAgYmFja2dyb3VuZDogJ3JlZCdcbiAgICB9LFxuICAgIGVtcHR5OiB7XG4gICAgICB0ZXh0OiAnICdcbiAgICB9XG4gIH0pO1xuXG4gIHRoaXMuYmFyc1twcm9jLnBtX2lkXSA9IHtcbiAgICBtZW1vcnk6IGJhcl9tZW1vcnksXG4gICAgY3B1OiBiYXJfY3B1LFxuICAgIHN0YXR1czogcHJvYy5wbTJfZW52LnN0YXR1c1xuICB9O1xuXG4gIHRoaXMudXBkYXRlQmFycyhwcm9jKTtcblxuICB0aGlzLm11bHRpLndyaXRlKCdcXG4nKTtcblxuICByZXR1cm4gdGhpcztcbn1cblxuTW9uaXQuYWRkUHJvY2Vzc2VzID0gZnVuY3Rpb24gKHByb2Nlc3Nlcykge1xuXG4gIGlmICghcHJvY2Vzc2VzKSB7XG4gICAgcHJvY2Vzc2VzID0gW107XG4gIH1cblxuICB0aGlzLnJlc2V0KCk7XG5cbiAgdmFyIG51bSA9IHByb2Nlc3Nlcy5sZW5ndGg7XG5cbiAgaWYgKG51bSA+IDApIHtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG51bTsgaSsrKSB7XG4gICAgICB0aGlzLmFkZFByb2Nlc3MocHJvY2Vzc2VzW2ldLCBpKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgdGhpcy5yZXNldCgnTm8gcHJvY2Vzc2VzIHRvIG1vbml0Jyk7XG4gIH1cblxufVxuXG4vLyBEcmF3IG1lbW9yeSBiYXJzXG4vKipcbiAqIERlc2NyaXB0aW9uXG4gKiBAbWV0aG9kIGRyYXdSYXRpb1xuICogQHBhcmFtIHt9IGJhcl9tZW1vcnlcbiAqIEBwYXJhbSB7fSBtZW1vcnlcbiAqIEByZXR1cm5cbiAqL1xuTW9uaXQuZHJhd1JhdGlvID0gZnVuY3Rpb24gKGJhcl9tZW1vcnksIG1lbW9yeSkge1xuICB2YXIgc2NhbGUgPSAwO1xuXG4gIGlmIChtZW1vcnkgPCBSQVRJT19UMSkgc2NhbGUgPSBSQVRJT19UMTtcbiAgZWxzZSBpZiAobWVtb3J5IDwgUkFUSU9fVDIpIHNjYWxlID0gUkFUSU9fVDI7XG4gIGVsc2UgaWYgKG1lbW9yeSA8IFJBVElPX1QzKSBzY2FsZSA9IFJBVElPX1QzO1xuICBlbHNlIHNjYWxlID0gUkFUSU9fVDQ7XG5cbiAgYmFyX21lbW9yeS5yYXRpbyhtZW1vcnksXG4gICAgc2NhbGUsXG4gICAgVVguaGVscGVycy5ieXRlc1RvU2l6ZShtZW1vcnksIDMpKTtcbn07XG5cbi8qKlxuICogVXBkYXRlcyBiYXJzIGluZm9ybWF0aW9uc1xuICogQHBhcmFtICB7fSBwcm9jICAgICAgIHByb2Mgb2JqZWN0XG4gKiBAcmV0dXJuICB0aGlzXG4gKi9cbk1vbml0LnVwZGF0ZUJhcnMgPSBmdW5jdGlvbiAocHJvYykge1xuICBpZiAodGhpcy5iYXJzW3Byb2MucG1faWRdKSB7XG4gICAgaWYgKHByb2MucG0yX2Vudi5zdGF0dXMgIT09ICdvbmxpbmUnIHx8IHByb2MucG0yX2Vudi5zdGF0dXMgIT09IHRoaXMuYmFyc1twcm9jLnBtX2lkXS5zdGF0dXMpIHtcbiAgICAgIHRoaXMuYmFyc1twcm9jLnBtX2lkXS5jcHUucGVyY2VudCgwLCBjaGFsay5yZWQocHJvYy5wbTJfZW52LnN0YXR1cykpO1xuICAgICAgdGhpcy5kcmF3UmF0aW8odGhpcy5iYXJzW3Byb2MucG1faWRdLm1lbW9yeSwgMCwgY2hhbGsucmVkKHByb2MucG0yX2Vudi5zdGF0dXMpKTtcbiAgICB9IGVsc2UgaWYgKCFwcm9jLm1vbml0KSB7XG4gICAgICB0aGlzLmJhcnNbcHJvYy5wbV9pZF0uY3B1LnBlcmNlbnQoMCwgY2hhbGsucmVkKCdObyBkYXRhJykpO1xuICAgICAgdGhpcy5kcmF3UmF0aW8odGhpcy5iYXJzW3Byb2MucG1faWRdLm1lbW9yeSwgMCwgY2hhbGsucmVkKCdObyBkYXRhJykpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmJhcnNbcHJvYy5wbV9pZF0uY3B1LnBlcmNlbnQocHJvYy5tb25pdC5jcHUpO1xuICAgICAgdGhpcy5kcmF3UmF0aW8odGhpcy5iYXJzW3Byb2MucG1faWRdLm1lbW9yeSwgcHJvYy5tb25pdC5tZW1vcnkpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0aGlzO1xufVxuXG5leHBvcnQgZGVmYXVsdCBNb25pdDtcbiJdfQ==
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;
exports.generateDockerfile = generateDockerfile;
exports.parseAndSwitch = parseAndSwitch;
exports.switchDockerFile = switchDockerFile;

var _child_process = require("child_process");

var _chalk = _interopRequireDefault(require("chalk"));

var _util = _interopRequireDefault(require("util"));

var fmt = _interopRequireWildcard(require("../tools/fmt.js"));

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _constants = _interopRequireDefault(require("../../constants.js"));

var _promiseMin = _interopRequireDefault(require("../tools/promise.min.js"));

function pspawn(cmd) {
  return new _promiseMin["default"](function (resolve, reject) {
    var p_cmd = cmd.split(' ');
    var install_instance = (0, _child_process.spawn)(p_cmd[0], p_cmd.splice(1, cmd.length), {
      stdio: 'inherit',
      env: process.env,
      shell: true
    });
    install_instance.on('close', function (code) {
      if (code != 0) {
        console.log(_chalk["default"].bold.red('Command failed'));
        return reject(new Error('Bad cmd return'));
      }

      return resolve();
    });
    install_instance.on('error', function (err) {
      return reject(err);
    });
  });
}

function checkDockerSetup() {
  return new _promiseMin["default"](function (resolve, reject) {
    (0, _child_process.exec)("docker version -f '{{.Client.Version}}'", function (err, stdout, stderr) {
      if (err) {
        console.error(_chalk["default"].red.bold('[Docker access] Error while trying to use docker command'));

        if (err.message && err.message.indexOf('Cannot connect to the Docker') > -1) {
          console.log();
          console.log(_chalk["default"].blue.bold('[Solution] Setup Docker to be able to be used without sudo rights:'));
          console.log(_chalk["default"].bold('$ sudo groupadd docker'));
          console.log(_chalk["default"].bold('$ sudo usermod -aG docker $USER'));
          console.log(_chalk["default"].bold('Then LOGOUT and LOGIN your Linux session'));
          console.log('Read more: http://bit.ly/29JGdCE');
        }

        return reject(err);
      }

      return resolve();
    });
  });
}
/**
 * Switch Dockerfile mode
 * check test/programmatic/containerizer.mocha.js
 */


function parseAndSwitch(file_content, main_file, opts) {
  var lines = file_content.split('\n');
  var mode = opts.mode;
  lines[0] = 'FROM keymetrics/pm2:' + opts.node_version;

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];

    if (['## DISTRIBUTION MODE', '## DEVELOPMENT MODE'].indexOf(line) > -1 || i == lines.length - 1) {
      lines.splice(i, lines.length);
      lines[i] = '## ' + mode.toUpperCase() + ' MODE';
      lines[i + 1] = 'ENV NODE_ENV=' + (mode == 'distribution' ? 'production' : mode);

      if (mode == 'distribution') {
        lines[i + 2] = 'COPY . /var/app';
        lines[i + 3] = 'CMD ["pm2-docker", "' + main_file + '", "--env", "production"]';
      }

      if (mode == 'development') {
        lines[i + 2] = 'CMD ["pm2-dev", "' + main_file + '", "--env", "development"]';
      }

      break;
    }
  }

  ;
  lines = lines.join('\n');
  return lines;
}

;
/**
 * Replace ENV, COPY and CMD depending on the mode
 * @param {String} docker_filepath Dockerfile absolute path
 * @param {String} main_file       Main file to start in container
 * @param {String} mode            Mode to switch the Dockerfile
 */

function switchDockerFile(docker_filepath, main_file, opts) {
  return new _promiseMin["default"](function (resolve, reject) {
    var data = _fs["default"].readFileSync(docker_filepath, 'utf8').toString();

    if (['distribution', 'development'].indexOf(opts.mode) == -1) return reject(new Error('Unknown mode'));
    var lines = parseAndSwitch(data, main_file, opts);

    _fs["default"].writeFile(docker_filepath, lines, function (err) {
      if (err) return reject(err);
      resolve({
        Dockerfile_path: docker_filepath,
        Dockerfile: lines,
        CMD: ''
      });
    });
  });
}
/**
 * Generate sample Dockerfile (lib/templates/Dockerfiles)
 * @param {String} docker_filepath Dockerfile absolute path
 * @param {String} main_file       Main file to start in container
 * @param {String} mode            Mode to switch the Dockerfile
 */


function generateDockerfile(docker_filepath, main_file, opts) {
  return new _promiseMin["default"](function (resolve, reject) {
    var tpl_file = _path["default"].join(_constants["default"].TEMPLATE_FOLDER, _constants["default"].DOCKERFILE_NODEJS);

    var template = _fs["default"].readFileSync(tpl_file, {
      encoding: 'utf8'
    });

    var CMD;
    template = parseAndSwitch(template, main_file, opts);

    _fs["default"].writeFile(docker_filepath, template, function (err) {
      if (err) return reject(err);
      resolve({
        Dockerfile_path: docker_filepath,
        Dockerfile: template,
        CMD: CMD
      });
    });
  });
}

function handleExit(CLI, opts, mode) {
  process.on('SIGINT', function () {
    CLI.disconnect();
    if (mode != 'distribution') return false;
    (0, _child_process.exec)('docker ps -lq', function (err, stdout, stderr) {
      if (err) {
        console.error(err);
      }

      require('vizion').analyze({
        folder: process.cwd()
      }, function recur_path(err, meta) {
        if (!err && meta.revision) {
          var commit_id = _util["default"].format('#%s(%s) %s', meta.branch, meta.revision.slice(0, 5), meta.comment);

          console.log(_chalk["default"].bold.magenta('$ docker commit -m "%s" %s %s'), commit_id, stdout.replace('\n', ''), opts.imageName);
        } else console.log(_chalk["default"].bold.magenta('$ docker commit %s %s'), stdout.replace('\n', ''), opts.imageName);

        console.log(_chalk["default"].bold.magenta('$ docker push %s'), opts.imageName);
      });
    });
  });
}

function _default(CLI) {
  CLI.prototype.generateDockerfile = function (script, opts) {
    var docker_filepath = _path["default"].join(process.cwd(), 'Dockerfile');

    var that = this;

    _fs["default"].stat(docker_filepath, function (err, stat) {
      if (err || opts.force == true) {
        generateDockerfile(docker_filepath, script, {
          mode: 'development'
        }).then(function () {
          console.log(_chalk["default"].bold('New Dockerfile generated in current folder'));
          console.log(_chalk["default"].bold('You can now run\n$ pm2 docker:dev <file|config>'));
          return that.exitCli(_constants["default"].SUCCESS_EXIT);
        });
        return false;
      }

      console.log(_chalk["default"].red.bold('Dockerfile already exists in this folder, use --force if you want to replace it'));
      that.exitCli(_constants["default"].ERROR_EXIT);
    });
  };

  CLI.prototype.dockerMode = function (script, opts, mode) {
    var promptly = require('promptly');

    var self = this;
    handleExit(self, opts, mode);

    if (mode == 'distribution' && !opts.imageName) {
      console.error(_chalk["default"].bold.red('--image-name [name] option is missing'));
      return self.exitCli(_constants["default"].ERROR_EXIT);
    }

    var template;
    var app_path, main_script;
    var image_name;
    var node_version = opts.nodeVersion ? opts.nodeVersion.split('.')[0] : 'latest';
    image_name = opts.imageName || require('crypto').randomBytes(6).toString('hex');

    if (script.indexOf('/') > -1) {
      app_path = _path["default"].join(process.cwd(), _path["default"].dirname(script));
      main_script = _path["default"].basename(script);
    } else {
      app_path = process.cwd();
      main_script = script;
    }

    checkDockerSetup().then(function () {
      /////////////////////////
      // Generate Dockerfile //
      /////////////////////////
      return new _promiseMin["default"](function (resolve, reject) {
        var docker_filepath = _path["default"].join(process.cwd(), 'Dockerfile');

        _fs["default"].stat(docker_filepath, function (err, stat) {
          if (err) {
            // Dockerfile does not exist, generate one
            // console.log(chalk.blue.bold('Generating new Dockerfile'));
            if (opts.force == true) {
              return resolve(generateDockerfile(docker_filepath, main_script, {
                node_version: node_version,
                mode: mode
              }));
            }

            if (opts.dockerdaemon) return resolve(generateDockerfile(docker_filepath, main_script, {
              node_version: node_version,
              mode: mode
            }));
            promptly.prompt('No Dockerfile in current directory, ok to generate a new one? (y/n)', function (err, value) {
              if (value == 'y') return resolve(generateDockerfile(docker_filepath, main_script, {
                node_version: node_version,
                mode: mode
              }));else return self.exitCli(_constants["default"].SUCCESS_EXIT);
            });
            return false;
          }

          return resolve(switchDockerFile(docker_filepath, main_script, {
            node_version: node_version,
            mode: mode
          }));
        });
      });
    }).then(function (_template) {
      template = _template;
      return _promiseMin["default"].resolve();
    }).then(function () {
      //////////////////
      // Docker build //
      //////////////////
      var docker_build = _util["default"].format('docker build -t %s -f %s', image_name, template.Dockerfile_path);

      if (opts.fresh == true) docker_build += ' --no-cache';
      docker_build += ' .';
      console.log();
      fmt.sep();
      fmt.title('Building Boot System');
      fmt.field('Type', _chalk["default"].cyan.bold('Docker'));
      fmt.field('Mode', mode);
      fmt.field('Image name', image_name);
      fmt.field('Docker build command', docker_build);
      fmt.field('Dockerfile path', template.Dockerfile_path);
      fmt.sep();
      return pspawn(docker_build);
    }).then(function () {
      ////////////////
      // Docker run //
      ////////////////
      var docker_run = 'docker run --net host';
      if (opts.dockerdaemon == true) docker_run += ' -d';
      if (mode != 'distribution') docker_run += _util["default"].format(' -v %s:/var/app -v /var/app/node_modules', app_path);
      docker_run += ' ' + image_name;
      var dockerfile_parsed = template.Dockerfile.split('\n');
      var base_image = dockerfile_parsed[0];
      var run_cmd = dockerfile_parsed[dockerfile_parsed.length - 1];
      console.log();
      fmt.sep();
      fmt.title('Booting');
      fmt.field('Type', _chalk["default"].cyan.bold('Docker'));
      fmt.field('Mode', mode);
      fmt.field('Base Image', base_image);
      fmt.field('Image Name', image_name);
      fmt.field('Docker Command', docker_run);
      fmt.field('RUN Command', run_cmd);
      fmt.field('CWD', app_path);
      fmt.sep();
      return pspawn(docker_run);
    }).then(function () {
      console.log(_chalk["default"].blue.bold('>>> Leaving Docker instance uuid=%s'), image_name);
      self.disconnect();
      return _promiseMin["default"].resolve();
    })["catch"](function (err) {
      console.log();
      console.log(_chalk["default"].grey('Raw error=', err.message));
      self.disconnect();
    });
  };
}

;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BUEkvQ29udGFpbmVyaXplci50cyJdLCJuYW1lcyI6WyJwc3Bhd24iLCJjbWQiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInBfY21kIiwic3BsaXQiLCJpbnN0YWxsX2luc3RhbmNlIiwic3BsaWNlIiwibGVuZ3RoIiwic3RkaW8iLCJlbnYiLCJwcm9jZXNzIiwic2hlbGwiLCJvbiIsImNvZGUiLCJjb25zb2xlIiwibG9nIiwiY2hhbGsiLCJib2xkIiwicmVkIiwiRXJyb3IiLCJlcnIiLCJjaGVja0RvY2tlclNldHVwIiwic3Rkb3V0Iiwic3RkZXJyIiwiZXJyb3IiLCJtZXNzYWdlIiwiaW5kZXhPZiIsImJsdWUiLCJwYXJzZUFuZFN3aXRjaCIsImZpbGVfY29udGVudCIsIm1haW5fZmlsZSIsIm9wdHMiLCJsaW5lcyIsIm1vZGUiLCJub2RlX3ZlcnNpb24iLCJpIiwibGluZSIsInRvVXBwZXJDYXNlIiwiam9pbiIsInN3aXRjaERvY2tlckZpbGUiLCJkb2NrZXJfZmlsZXBhdGgiLCJkYXRhIiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsIndyaXRlRmlsZSIsIkRvY2tlcmZpbGVfcGF0aCIsIkRvY2tlcmZpbGUiLCJDTUQiLCJnZW5lcmF0ZURvY2tlcmZpbGUiLCJ0cGxfZmlsZSIsInBhdGgiLCJjc3QiLCJURU1QTEFURV9GT0xERVIiLCJET0NLRVJGSUxFX05PREVKUyIsInRlbXBsYXRlIiwiZW5jb2RpbmciLCJoYW5kbGVFeGl0IiwiQ0xJIiwiZGlzY29ubmVjdCIsInJlcXVpcmUiLCJhbmFseXplIiwiZm9sZGVyIiwiY3dkIiwicmVjdXJfcGF0aCIsIm1ldGEiLCJyZXZpc2lvbiIsImNvbW1pdF9pZCIsInV0aWwiLCJmb3JtYXQiLCJicmFuY2giLCJzbGljZSIsImNvbW1lbnQiLCJtYWdlbnRhIiwicmVwbGFjZSIsImltYWdlTmFtZSIsInByb3RvdHlwZSIsInNjcmlwdCIsInRoYXQiLCJzdGF0IiwiZm9yY2UiLCJ0aGVuIiwiZXhpdENsaSIsIlNVQ0NFU1NfRVhJVCIsIkVSUk9SX0VYSVQiLCJkb2NrZXJNb2RlIiwicHJvbXB0bHkiLCJzZWxmIiwiYXBwX3BhdGgiLCJtYWluX3NjcmlwdCIsImltYWdlX25hbWUiLCJub2RlVmVyc2lvbiIsInJhbmRvbUJ5dGVzIiwiZGlybmFtZSIsImJhc2VuYW1lIiwiZG9ja2VyZGFlbW9uIiwicHJvbXB0IiwidmFsdWUiLCJfdGVtcGxhdGUiLCJkb2NrZXJfYnVpbGQiLCJmcmVzaCIsImZtdCIsInNlcCIsInRpdGxlIiwiZmllbGQiLCJjeWFuIiwiZG9ja2VyX3J1biIsImRvY2tlcmZpbGVfcGFyc2VkIiwiYmFzZV9pbWFnZSIsInJ1bl9jbWQiLCJncmV5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLFNBQVNBLE1BQVQsQ0FBZ0JDLEdBQWhCLEVBQXFCO0FBQ25CLFNBQU8sSUFBSUMsc0JBQUosQ0FBWSxVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUM1QyxRQUFJQyxLQUFLLEdBQUdKLEdBQUcsQ0FBQ0ssS0FBSixDQUFVLEdBQVYsQ0FBWjtBQUVBLFFBQUlDLGdCQUFnQixHQUFHLDBCQUFNRixLQUFLLENBQUMsQ0FBRCxDQUFYLEVBQWdCQSxLQUFLLENBQUNHLE1BQU4sQ0FBYSxDQUFiLEVBQWdCUCxHQUFHLENBQUNRLE1BQXBCLENBQWhCLEVBQTZDO0FBQ2xFQyxNQUFBQSxLQUFLLEVBQUUsU0FEMkQ7QUFFbEVDLE1BQUFBLEdBQUcsRUFBRUMsT0FBTyxDQUFDRCxHQUZxRDtBQUdsRUUsTUFBQUEsS0FBSyxFQUFFO0FBSDJELEtBQTdDLENBQXZCO0FBTUFOLElBQUFBLGdCQUFnQixDQUFDTyxFQUFqQixDQUFvQixPQUFwQixFQUE2QixVQUFVQyxJQUFWLEVBQWdCO0FBQzNDLFVBQUlBLElBQUksSUFBSSxDQUFaLEVBQWU7QUFDYkMsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlDLGtCQUFNQyxJQUFOLENBQVdDLEdBQVgsQ0FBZSxnQkFBZixDQUFaO0FBQ0EsZUFBT2hCLE1BQU0sQ0FBQyxJQUFJaUIsS0FBSixDQUFVLGdCQUFWLENBQUQsQ0FBYjtBQUNEOztBQUNELGFBQU9sQixPQUFPLEVBQWQ7QUFDRCxLQU5EO0FBUUFJLElBQUFBLGdCQUFnQixDQUFDTyxFQUFqQixDQUFvQixPQUFwQixFQUE2QixVQUFVUSxHQUFWLEVBQWU7QUFDMUMsYUFBT2xCLE1BQU0sQ0FBQ2tCLEdBQUQsQ0FBYjtBQUNELEtBRkQ7QUFHRCxHQXBCTSxDQUFQO0FBcUJEOztBQUVELFNBQVNDLGdCQUFULEdBQTRCO0FBQzFCLFNBQU8sSUFBSXJCLHNCQUFKLENBQVksVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDNUMsNkJBQUsseUNBQUwsRUFBZ0QsVUFBVWtCLEdBQVYsRUFBZUUsTUFBZixFQUF1QkMsTUFBdkIsRUFBK0I7QUFDN0UsVUFBSUgsR0FBSixFQUFTO0FBQ1BOLFFBQUFBLE9BQU8sQ0FBQ1UsS0FBUixDQUFjUixrQkFBTUUsR0FBTixDQUFVRCxJQUFWLENBQWUsMERBQWYsQ0FBZDs7QUFDQSxZQUFJRyxHQUFHLENBQUNLLE9BQUosSUFBZUwsR0FBRyxDQUFDSyxPQUFKLENBQVlDLE9BQVosQ0FBb0IsOEJBQXBCLElBQXNELENBQUMsQ0FBMUUsRUFBNkU7QUFDM0VaLFVBQUFBLE9BQU8sQ0FBQ0MsR0FBUjtBQUNBRCxVQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsa0JBQU1XLElBQU4sQ0FBV1YsSUFBWCxDQUFnQixvRUFBaEIsQ0FBWjtBQUNBSCxVQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsa0JBQU1DLElBQU4sQ0FBVyx3QkFBWCxDQUFaO0FBQ0FILFVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxrQkFBTUMsSUFBTixDQUFXLGlDQUFYLENBQVo7QUFDQUgsVUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlDLGtCQUFNQyxJQUFOLENBQVcsMENBQVgsQ0FBWjtBQUNBSCxVQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxrQ0FBWjtBQUNEOztBQUNELGVBQU9iLE1BQU0sQ0FBQ2tCLEdBQUQsQ0FBYjtBQUNEOztBQUNELGFBQU9uQixPQUFPLEVBQWQ7QUFDRCxLQWREO0FBZUQsR0FoQk0sQ0FBUDtBQWlCRDtBQUVEOzs7Ozs7QUFJQSxTQUFTMkIsY0FBVCxDQUF3QkMsWUFBeEIsRUFBc0NDLFNBQXRDLEVBQWlEQyxJQUFqRCxFQUF1RDtBQUNyRCxNQUFJQyxLQUFLLEdBQUdILFlBQVksQ0FBQ3pCLEtBQWIsQ0FBbUIsSUFBbkIsQ0FBWjtBQUNBLE1BQUk2QixJQUFJLEdBQUdGLElBQUksQ0FBQ0UsSUFBaEI7QUFFQUQsRUFBQUEsS0FBSyxDQUFDLENBQUQsQ0FBTCxHQUFXLHlCQUF5QkQsSUFBSSxDQUFDRyxZQUF6Qzs7QUFFQSxPQUFLLElBQUlDLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdILEtBQUssQ0FBQ3pCLE1BQTFCLEVBQWtDNEIsQ0FBQyxFQUFuQyxFQUF1QztBQUNyQyxRQUFJQyxJQUFJLEdBQUdKLEtBQUssQ0FBQ0csQ0FBRCxDQUFoQjs7QUFFQSxRQUFJLENBQUMsc0JBQUQsRUFBeUIscUJBQXpCLEVBQWdEVCxPQUFoRCxDQUF3RFUsSUFBeEQsSUFBZ0UsQ0FBQyxDQUFqRSxJQUNGRCxDQUFDLElBQUlILEtBQUssQ0FBQ3pCLE1BQU4sR0FBZSxDQUR0QixFQUN5QjtBQUN2QnlCLE1BQUFBLEtBQUssQ0FBQzFCLE1BQU4sQ0FBYTZCLENBQWIsRUFBZ0JILEtBQUssQ0FBQ3pCLE1BQXRCO0FBQ0F5QixNQUFBQSxLQUFLLENBQUNHLENBQUQsQ0FBTCxHQUFXLFFBQVFGLElBQUksQ0FBQ0ksV0FBTCxFQUFSLEdBQTZCLE9BQXhDO0FBQ0FMLE1BQUFBLEtBQUssQ0FBQ0csQ0FBQyxHQUFHLENBQUwsQ0FBTCxHQUFlLG1CQUFtQkYsSUFBSSxJQUFJLGNBQVIsR0FBeUIsWUFBekIsR0FBd0NBLElBQTNELENBQWY7O0FBRUEsVUFBSUEsSUFBSSxJQUFJLGNBQVosRUFBNEI7QUFDMUJELFFBQUFBLEtBQUssQ0FBQ0csQ0FBQyxHQUFHLENBQUwsQ0FBTCxHQUFlLGlCQUFmO0FBQ0FILFFBQUFBLEtBQUssQ0FBQ0csQ0FBQyxHQUFHLENBQUwsQ0FBTCxHQUFlLHlCQUF5QkwsU0FBekIsR0FBcUMsMkJBQXBEO0FBQ0Q7O0FBQ0QsVUFBSUcsSUFBSSxJQUFJLGFBQVosRUFBMkI7QUFDekJELFFBQUFBLEtBQUssQ0FBQ0csQ0FBQyxHQUFHLENBQUwsQ0FBTCxHQUFlLHNCQUFzQkwsU0FBdEIsR0FBa0MsNEJBQWpEO0FBQ0Q7O0FBQ0Q7QUFDRDtBQUNGOztBQUFBO0FBQ0RFLEVBQUFBLEtBQUssR0FBR0EsS0FBSyxDQUFDTSxJQUFOLENBQVcsSUFBWCxDQUFSO0FBQ0EsU0FBT04sS0FBUDtBQUNEOztBQUFBO0FBRUQ7Ozs7Ozs7QUFNQSxTQUFTTyxnQkFBVCxDQUEwQkMsZUFBMUIsRUFBMkNWLFNBQTNDLEVBQXNEQyxJQUF0RCxFQUE0RDtBQUMxRCxTQUFPLElBQUkvQixzQkFBSixDQUFZLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQzVDLFFBQUl1QyxJQUFJLEdBQUdDLGVBQUdDLFlBQUgsQ0FBZ0JILGVBQWhCLEVBQWlDLE1BQWpDLEVBQXlDSSxRQUF6QyxFQUFYOztBQUVBLFFBQUksQ0FBQyxjQUFELEVBQWlCLGFBQWpCLEVBQWdDbEIsT0FBaEMsQ0FBd0NLLElBQUksQ0FBQ0UsSUFBN0MsS0FBc0QsQ0FBQyxDQUEzRCxFQUNFLE9BQU8vQixNQUFNLENBQUMsSUFBSWlCLEtBQUosQ0FBVSxjQUFWLENBQUQsQ0FBYjtBQUVGLFFBQUlhLEtBQUssR0FBR0osY0FBYyxDQUFDYSxJQUFELEVBQU9YLFNBQVAsRUFBa0JDLElBQWxCLENBQTFCOztBQUNBVyxtQkFBR0csU0FBSCxDQUFhTCxlQUFiLEVBQThCUixLQUE5QixFQUFxQyxVQUFVWixHQUFWLEVBQWU7QUFDbEQsVUFBSUEsR0FBSixFQUFTLE9BQU9sQixNQUFNLENBQUNrQixHQUFELENBQWI7QUFDVG5CLE1BQUFBLE9BQU8sQ0FBQztBQUNONkMsUUFBQUEsZUFBZSxFQUFFTixlQURYO0FBRU5PLFFBQUFBLFVBQVUsRUFBRWYsS0FGTjtBQUdOZ0IsUUFBQUEsR0FBRyxFQUFFO0FBSEMsT0FBRCxDQUFQO0FBS0QsS0FQRDtBQVFELEdBZk0sQ0FBUDtBQWdCRDtBQUVEOzs7Ozs7OztBQU1BLFNBQVNDLGtCQUFULENBQTRCVCxlQUE1QixFQUE2Q1YsU0FBN0MsRUFBd0RDLElBQXhELEVBQThEO0FBQzVELFNBQU8sSUFBSS9CLHNCQUFKLENBQVksVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDNUMsUUFBSWdELFFBQVEsR0FBR0MsaUJBQUtiLElBQUwsQ0FBVWMsc0JBQUlDLGVBQWQsRUFBK0JELHNCQUFJRSxpQkFBbkMsQ0FBZjs7QUFDQSxRQUFJQyxRQUFRLEdBQUdiLGVBQUdDLFlBQUgsQ0FBZ0JPLFFBQWhCLEVBQTBCO0FBQUVNLE1BQUFBLFFBQVEsRUFBRTtBQUFaLEtBQTFCLENBQWY7O0FBQ0EsUUFBSVIsR0FBSjtBQUVBTyxJQUFBQSxRQUFRLEdBQUczQixjQUFjLENBQUMyQixRQUFELEVBQVd6QixTQUFYLEVBQXNCQyxJQUF0QixDQUF6Qjs7QUFFQVcsbUJBQUdHLFNBQUgsQ0FBYUwsZUFBYixFQUE4QmUsUUFBOUIsRUFBd0MsVUFBVW5DLEdBQVYsRUFBZTtBQUNyRCxVQUFJQSxHQUFKLEVBQVMsT0FBT2xCLE1BQU0sQ0FBQ2tCLEdBQUQsQ0FBYjtBQUNUbkIsTUFBQUEsT0FBTyxDQUFDO0FBQ042QyxRQUFBQSxlQUFlLEVBQUVOLGVBRFg7QUFFTk8sUUFBQUEsVUFBVSxFQUFFUSxRQUZOO0FBR05QLFFBQUFBLEdBQUcsRUFBRUE7QUFIQyxPQUFELENBQVA7QUFLRCxLQVBEO0FBUUQsR0FmTSxDQUFQO0FBZ0JEOztBQUVELFNBQVNTLFVBQVQsQ0FBb0JDLEdBQXBCLEVBQXlCM0IsSUFBekIsRUFBK0JFLElBQS9CLEVBQXFDO0FBQ25DdkIsRUFBQUEsT0FBTyxDQUFDRSxFQUFSLENBQVcsUUFBWCxFQUFxQixZQUFZO0FBQy9COEMsSUFBQUEsR0FBRyxDQUFDQyxVQUFKO0FBRUEsUUFBSTFCLElBQUksSUFBSSxjQUFaLEVBQ0UsT0FBTyxLQUFQO0FBRUYsNkJBQUssZUFBTCxFQUFzQixVQUFVYixHQUFWLEVBQWVFLE1BQWYsRUFBdUJDLE1BQXZCLEVBQStCO0FBQ25ELFVBQUlILEdBQUosRUFBUztBQUNQTixRQUFBQSxPQUFPLENBQUNVLEtBQVIsQ0FBY0osR0FBZDtBQUNEOztBQUNEd0MsTUFBQUEsT0FBTyxDQUFDLFFBQUQsQ0FBUCxDQUFrQkMsT0FBbEIsQ0FBMEI7QUFBRUMsUUFBQUEsTUFBTSxFQUFFcEQsT0FBTyxDQUFDcUQsR0FBUjtBQUFWLE9BQTFCLEVBQXFELFNBQVNDLFVBQVQsQ0FBb0I1QyxHQUFwQixFQUF5QjZDLElBQXpCLEVBQStCO0FBQ2xGLFlBQUksQ0FBQzdDLEdBQUQsSUFBUTZDLElBQUksQ0FBQ0MsUUFBakIsRUFBMkI7QUFDekIsY0FBSUMsU0FBUyxHQUFHQyxpQkFBS0MsTUFBTCxDQUFZLFlBQVosRUFDZEosSUFBSSxDQUFDSyxNQURTLEVBRWRMLElBQUksQ0FBQ0MsUUFBTCxDQUFjSyxLQUFkLENBQW9CLENBQXBCLEVBQXVCLENBQXZCLENBRmMsRUFHZE4sSUFBSSxDQUFDTyxPQUhTLENBQWhCOztBQUtBMUQsVUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlDLGtCQUFNQyxJQUFOLENBQVd3RCxPQUFYLENBQW1CLCtCQUFuQixDQUFaLEVBQ0VOLFNBREYsRUFFRTdDLE1BQU0sQ0FBQ29ELE9BQVAsQ0FBZSxJQUFmLEVBQXFCLEVBQXJCLENBRkYsRUFHRTNDLElBQUksQ0FBQzRDLFNBSFA7QUFJRCxTQVZELE1BWUU3RCxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsa0JBQU1DLElBQU4sQ0FBV3dELE9BQVgsQ0FBbUIsdUJBQW5CLENBQVosRUFBeURuRCxNQUFNLENBQUNvRCxPQUFQLENBQWUsSUFBZixFQUFxQixFQUFyQixDQUF6RCxFQUFtRjNDLElBQUksQ0FBQzRDLFNBQXhGOztBQUVGN0QsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlDLGtCQUFNQyxJQUFOLENBQVd3RCxPQUFYLENBQW1CLGtCQUFuQixDQUFaLEVBQW9EMUMsSUFBSSxDQUFDNEMsU0FBekQ7QUFDRCxPQWhCRDtBQWlCRCxLQXJCRDtBQXNCRCxHQTVCRDtBQTZCRDs7QUFFYyxrQkFBVWpCLEdBQVYsRUFBZTtBQUM1QkEsRUFBQUEsR0FBRyxDQUFDa0IsU0FBSixDQUFjM0Isa0JBQWQsR0FBbUMsVUFBVTRCLE1BQVYsRUFBa0I5QyxJQUFsQixFQUF3QjtBQUN6RCxRQUFJUyxlQUFlLEdBQUdXLGlCQUFLYixJQUFMLENBQVU1QixPQUFPLENBQUNxRCxHQUFSLEVBQVYsRUFBeUIsWUFBekIsQ0FBdEI7O0FBQ0EsUUFBSWUsSUFBSSxHQUFHLElBQVg7O0FBRUFwQyxtQkFBR3FDLElBQUgsQ0FBUXZDLGVBQVIsRUFBeUIsVUFBVXBCLEdBQVYsRUFBZTJELElBQWYsRUFBcUI7QUFDNUMsVUFBSTNELEdBQUcsSUFBSVcsSUFBSSxDQUFDaUQsS0FBTCxJQUFjLElBQXpCLEVBQStCO0FBQzdCL0IsUUFBQUEsa0JBQWtCLENBQUNULGVBQUQsRUFBa0JxQyxNQUFsQixFQUEwQjtBQUMxQzVDLFVBQUFBLElBQUksRUFBRTtBQURvQyxTQUExQixDQUFsQixDQUdHZ0QsSUFISCxDQUdRLFlBQVk7QUFDaEJuRSxVQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsa0JBQU1DLElBQU4sQ0FBVyw0Q0FBWCxDQUFaO0FBQ0FILFVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxrQkFBTUMsSUFBTixDQUFXLGlEQUFYLENBQVo7QUFDQSxpQkFBTzZELElBQUksQ0FBQ0ksT0FBTCxDQUFhOUIsc0JBQUkrQixZQUFqQixDQUFQO0FBQ0QsU0FQSDtBQVFBLGVBQU8sS0FBUDtBQUNEOztBQUNEckUsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlDLGtCQUFNRSxHQUFOLENBQVVELElBQVYsQ0FBZSxpRkFBZixDQUFaO0FBQ0E2RCxNQUFBQSxJQUFJLENBQUNJLE9BQUwsQ0FBYTlCLHNCQUFJZ0MsVUFBakI7QUFDRCxLQWREO0FBZUQsR0FuQkQ7O0FBcUJBMUIsRUFBQUEsR0FBRyxDQUFDa0IsU0FBSixDQUFjUyxVQUFkLEdBQTJCLFVBQVVSLE1BQVYsRUFBa0I5QyxJQUFsQixFQUF3QkUsSUFBeEIsRUFBOEI7QUFDdkQsUUFBSXFELFFBQVEsR0FBRzFCLE9BQU8sQ0FBQyxVQUFELENBQXRCOztBQUNBLFFBQUkyQixJQUFJLEdBQUcsSUFBWDtBQUNBOUIsSUFBQUEsVUFBVSxDQUFDOEIsSUFBRCxFQUFPeEQsSUFBUCxFQUFhRSxJQUFiLENBQVY7O0FBRUEsUUFBSUEsSUFBSSxJQUFJLGNBQVIsSUFBMEIsQ0FBQ0YsSUFBSSxDQUFDNEMsU0FBcEMsRUFBK0M7QUFDN0M3RCxNQUFBQSxPQUFPLENBQUNVLEtBQVIsQ0FBY1Isa0JBQU1DLElBQU4sQ0FBV0MsR0FBWCxDQUFlLHVDQUFmLENBQWQ7QUFDQSxhQUFPcUUsSUFBSSxDQUFDTCxPQUFMLENBQWE5QixzQkFBSWdDLFVBQWpCLENBQVA7QUFDRDs7QUFFRCxRQUFJN0IsUUFBSjtBQUNBLFFBQUlpQyxRQUFKLEVBQWNDLFdBQWQ7QUFDQSxRQUFJQyxVQUFKO0FBQ0EsUUFBSXhELFlBQVksR0FBR0gsSUFBSSxDQUFDNEQsV0FBTCxHQUFtQjVELElBQUksQ0FBQzRELFdBQUwsQ0FBaUJ2RixLQUFqQixDQUF1QixHQUF2QixFQUE0QixDQUE1QixDQUFuQixHQUFvRCxRQUF2RTtBQUVBc0YsSUFBQUEsVUFBVSxHQUFHM0QsSUFBSSxDQUFDNEMsU0FBTCxJQUFrQmYsT0FBTyxDQUFDLFFBQUQsQ0FBUCxDQUFrQmdDLFdBQWxCLENBQThCLENBQTlCLEVBQWlDaEQsUUFBakMsQ0FBMEMsS0FBMUMsQ0FBL0I7O0FBRUEsUUFBSWlDLE1BQU0sQ0FBQ25ELE9BQVAsQ0FBZSxHQUFmLElBQXNCLENBQUMsQ0FBM0IsRUFBOEI7QUFDNUI4RCxNQUFBQSxRQUFRLEdBQUdyQyxpQkFBS2IsSUFBTCxDQUFVNUIsT0FBTyxDQUFDcUQsR0FBUixFQUFWLEVBQXlCWixpQkFBSzBDLE9BQUwsQ0FBYWhCLE1BQWIsQ0FBekIsQ0FBWDtBQUNBWSxNQUFBQSxXQUFXLEdBQUd0QyxpQkFBSzJDLFFBQUwsQ0FBY2pCLE1BQWQsQ0FBZDtBQUNELEtBSEQsTUFJSztBQUNIVyxNQUFBQSxRQUFRLEdBQUc5RSxPQUFPLENBQUNxRCxHQUFSLEVBQVg7QUFDQTBCLE1BQUFBLFdBQVcsR0FBR1osTUFBZDtBQUNEOztBQUVEeEQsSUFBQUEsZ0JBQWdCLEdBQ2I0RCxJQURILENBQ1EsWUFBWTtBQUNoQjtBQUNBO0FBQ0E7QUFDQSxhQUFPLElBQUlqRixzQkFBSixDQUFZLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQzVDLFlBQUlzQyxlQUFlLEdBQUdXLGlCQUFLYixJQUFMLENBQVU1QixPQUFPLENBQUNxRCxHQUFSLEVBQVYsRUFBeUIsWUFBekIsQ0FBdEI7O0FBRUFyQix1QkFBR3FDLElBQUgsQ0FBUXZDLGVBQVIsRUFBeUIsVUFBVXBCLEdBQVYsRUFBZTJELElBQWYsRUFBcUI7QUFDNUMsY0FBSTNELEdBQUosRUFBUztBQUNQO0FBQ0E7QUFDQSxnQkFBSVcsSUFBSSxDQUFDaUQsS0FBTCxJQUFjLElBQWxCLEVBQXdCO0FBQ3RCLHFCQUFPL0UsT0FBTyxDQUFDZ0Qsa0JBQWtCLENBQUNULGVBQUQsRUFBa0JpRCxXQUFsQixFQUErQjtBQUM5RHZELGdCQUFBQSxZQUFZLEVBQUVBLFlBRGdEO0FBRTlERCxnQkFBQUEsSUFBSSxFQUFFQTtBQUZ3RCxlQUEvQixDQUFuQixDQUFkO0FBSUQ7O0FBQ0QsZ0JBQUlGLElBQUksQ0FBQ2dFLFlBQVQsRUFDRSxPQUFPOUYsT0FBTyxDQUFDZ0Qsa0JBQWtCLENBQUNULGVBQUQsRUFBa0JpRCxXQUFsQixFQUErQjtBQUM5RHZELGNBQUFBLFlBQVksRUFBRUEsWUFEZ0Q7QUFFOURELGNBQUFBLElBQUksRUFBRUE7QUFGd0QsYUFBL0IsQ0FBbkIsQ0FBZDtBQUlGcUQsWUFBQUEsUUFBUSxDQUFDVSxNQUFULENBQWdCLHFFQUFoQixFQUF1RixVQUFVNUUsR0FBVixFQUFlNkUsS0FBZixFQUFzQjtBQUMzRyxrQkFBSUEsS0FBSyxJQUFJLEdBQWIsRUFDRSxPQUFPaEcsT0FBTyxDQUFDZ0Qsa0JBQWtCLENBQUNULGVBQUQsRUFBa0JpRCxXQUFsQixFQUErQjtBQUM5RHZELGdCQUFBQSxZQUFZLEVBQUVBLFlBRGdEO0FBRTlERCxnQkFBQUEsSUFBSSxFQUFFQTtBQUZ3RCxlQUEvQixDQUFuQixDQUFkLENBREYsS0FNRSxPQUFPc0QsSUFBSSxDQUFDTCxPQUFMLENBQWE5QixzQkFBSStCLFlBQWpCLENBQVA7QUFDSCxhQVJEO0FBU0EsbUJBQU8sS0FBUDtBQUNEOztBQUNELGlCQUFPbEYsT0FBTyxDQUFDc0MsZ0JBQWdCLENBQUNDLGVBQUQsRUFBa0JpRCxXQUFsQixFQUErQjtBQUM1RHZELFlBQUFBLFlBQVksRUFBRUEsWUFEOEM7QUFFNURELFlBQUFBLElBQUksRUFBRUE7QUFGc0QsV0FBL0IsQ0FBakIsQ0FBZDtBQUlELFNBOUJEO0FBK0JELE9BbENNLENBQVA7QUFtQ0QsS0F4Q0gsRUF5Q0dnRCxJQXpDSCxDQXlDUSxVQUFVaUIsU0FBVixFQUFxQjtBQUN6QjNDLE1BQUFBLFFBQVEsR0FBRzJDLFNBQVg7QUFDQSxhQUFPbEcsdUJBQVFDLE9BQVIsRUFBUDtBQUNELEtBNUNILEVBNkNHZ0YsSUE3Q0gsQ0E2Q1EsWUFBWTtBQUNoQjtBQUNBO0FBQ0E7QUFFQSxVQUFJa0IsWUFBWSxHQUFHL0IsaUJBQUtDLE1BQUwsQ0FBWSwwQkFBWixFQUNqQnFCLFVBRGlCLEVBRWpCbkMsUUFBUSxDQUFDVCxlQUZRLENBQW5COztBQUlBLFVBQUlmLElBQUksQ0FBQ3FFLEtBQUwsSUFBYyxJQUFsQixFQUNFRCxZQUFZLElBQUksYUFBaEI7QUFDRkEsTUFBQUEsWUFBWSxJQUFJLElBQWhCO0FBRUFyRixNQUFBQSxPQUFPLENBQUNDLEdBQVI7QUFDQXNGLE1BQUFBLEdBQUcsQ0FBQ0MsR0FBSjtBQUNBRCxNQUFBQSxHQUFHLENBQUNFLEtBQUosQ0FBVSxzQkFBVjtBQUNBRixNQUFBQSxHQUFHLENBQUNHLEtBQUosQ0FBVSxNQUFWLEVBQWtCeEYsa0JBQU15RixJQUFOLENBQVd4RixJQUFYLENBQWdCLFFBQWhCLENBQWxCO0FBQ0FvRixNQUFBQSxHQUFHLENBQUNHLEtBQUosQ0FBVSxNQUFWLEVBQWtCdkUsSUFBbEI7QUFDQW9FLE1BQUFBLEdBQUcsQ0FBQ0csS0FBSixDQUFVLFlBQVYsRUFBd0JkLFVBQXhCO0FBQ0FXLE1BQUFBLEdBQUcsQ0FBQ0csS0FBSixDQUFVLHNCQUFWLEVBQWtDTCxZQUFsQztBQUNBRSxNQUFBQSxHQUFHLENBQUNHLEtBQUosQ0FBVSxpQkFBVixFQUE2QmpELFFBQVEsQ0FBQ1QsZUFBdEM7QUFDQXVELE1BQUFBLEdBQUcsQ0FBQ0MsR0FBSjtBQUVBLGFBQU94RyxNQUFNLENBQUNxRyxZQUFELENBQWI7QUFDRCxLQXJFSCxFQXNFR2xCLElBdEVILENBc0VRLFlBQVk7QUFDaEI7QUFDQTtBQUNBO0FBRUEsVUFBSXlCLFVBQVUsR0FBRyx1QkFBakI7QUFFQSxVQUFJM0UsSUFBSSxDQUFDZ0UsWUFBTCxJQUFxQixJQUF6QixFQUNFVyxVQUFVLElBQUksS0FBZDtBQUNGLFVBQUl6RSxJQUFJLElBQUksY0FBWixFQUNFeUUsVUFBVSxJQUFJdEMsaUJBQUtDLE1BQUwsQ0FBWSwwQ0FBWixFQUF3RG1CLFFBQXhELENBQWQ7QUFDRmtCLE1BQUFBLFVBQVUsSUFBSSxNQUFNaEIsVUFBcEI7QUFDQSxVQUFJaUIsaUJBQWlCLEdBQUdwRCxRQUFRLENBQUNSLFVBQVQsQ0FBb0IzQyxLQUFwQixDQUEwQixJQUExQixDQUF4QjtBQUNBLFVBQUl3RyxVQUFVLEdBQUdELGlCQUFpQixDQUFDLENBQUQsQ0FBbEM7QUFDQSxVQUFJRSxPQUFPLEdBQUdGLGlCQUFpQixDQUFDQSxpQkFBaUIsQ0FBQ3BHLE1BQWxCLEdBQTJCLENBQTVCLENBQS9CO0FBRUFPLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUjtBQUNBc0YsTUFBQUEsR0FBRyxDQUFDQyxHQUFKO0FBQ0FELE1BQUFBLEdBQUcsQ0FBQ0UsS0FBSixDQUFVLFNBQVY7QUFDQUYsTUFBQUEsR0FBRyxDQUFDRyxLQUFKLENBQVUsTUFBVixFQUFrQnhGLGtCQUFNeUYsSUFBTixDQUFXeEYsSUFBWCxDQUFnQixRQUFoQixDQUFsQjtBQUNBb0YsTUFBQUEsR0FBRyxDQUFDRyxLQUFKLENBQVUsTUFBVixFQUFrQnZFLElBQWxCO0FBQ0FvRSxNQUFBQSxHQUFHLENBQUNHLEtBQUosQ0FBVSxZQUFWLEVBQXdCSSxVQUF4QjtBQUNBUCxNQUFBQSxHQUFHLENBQUNHLEtBQUosQ0FBVSxZQUFWLEVBQXdCZCxVQUF4QjtBQUNBVyxNQUFBQSxHQUFHLENBQUNHLEtBQUosQ0FBVSxnQkFBVixFQUE0QkUsVUFBNUI7QUFDQUwsTUFBQUEsR0FBRyxDQUFDRyxLQUFKLENBQVUsYUFBVixFQUF5QkssT0FBekI7QUFDQVIsTUFBQUEsR0FBRyxDQUFDRyxLQUFKLENBQVUsS0FBVixFQUFpQmhCLFFBQWpCO0FBQ0FhLE1BQUFBLEdBQUcsQ0FBQ0MsR0FBSjtBQUNBLGFBQU94RyxNQUFNLENBQUM0RyxVQUFELENBQWI7QUFDRCxLQWxHSCxFQW1HR3pCLElBbkdILENBbUdRLFlBQVk7QUFDaEJuRSxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsa0JBQU1XLElBQU4sQ0FBV1YsSUFBWCxDQUFnQixxQ0FBaEIsQ0FBWixFQUFvRXlFLFVBQXBFO0FBQ0FILE1BQUFBLElBQUksQ0FBQzVCLFVBQUw7QUFDQSxhQUFPM0QsdUJBQVFDLE9BQVIsRUFBUDtBQUNELEtBdkdILFdBd0dTLFVBQVVtQixHQUFWLEVBQWU7QUFDcEJOLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUjtBQUNBRCxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsa0JBQU04RixJQUFOLENBQVcsWUFBWCxFQUF5QjFGLEdBQUcsQ0FBQ0ssT0FBN0IsQ0FBWjtBQUNBOEQsTUFBQUEsSUFBSSxDQUFDNUIsVUFBTDtBQUNELEtBNUdIO0FBOEdELEdBeElEO0FBMElEOztBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBzcGF3biB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCB1dGlsIGZyb20gJ3V0aWwnO1xuaW1wb3J0ICogYXMgZm10IGZyb20gJy4uL3Rvb2xzL2ZtdC5qcyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgY3N0IGZyb20gJy4uLy4uL2NvbnN0YW50cy5qcyc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICcuLi90b29scy9wcm9taXNlLm1pbi5qcyc7XG5cbmZ1bmN0aW9uIHBzcGF3bihjbWQpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICB2YXIgcF9jbWQgPSBjbWQuc3BsaXQoJyAnKTtcblxuICAgIHZhciBpbnN0YWxsX2luc3RhbmNlID0gc3Bhd24ocF9jbWRbMF0sIHBfY21kLnNwbGljZSgxLCBjbWQubGVuZ3RoKSwge1xuICAgICAgc3RkaW86ICdpbmhlcml0JyxcbiAgICAgIGVudjogcHJvY2Vzcy5lbnYsXG4gICAgICBzaGVsbDogdHJ1ZVxuICAgIH0pO1xuXG4gICAgaW5zdGFsbF9pbnN0YW5jZS5vbignY2xvc2UnLCBmdW5jdGlvbiAoY29kZSkge1xuICAgICAgaWYgKGNvZGUgIT0gMCkge1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkLnJlZCgnQ29tbWFuZCBmYWlsZWQnKSk7XG4gICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKCdCYWQgY21kIHJldHVybicpKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXNvbHZlKCk7XG4gICAgfSk7XG5cbiAgICBpbnN0YWxsX2luc3RhbmNlLm9uKCdlcnJvcicsIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNoZWNrRG9ja2VyU2V0dXAoKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgZXhlYyhcImRvY2tlciB2ZXJzaW9uIC1mICd7ey5DbGllbnQuVmVyc2lvbn19J1wiLCBmdW5jdGlvbiAoZXJyLCBzdGRvdXQsIHN0ZGVycikge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZC5ib2xkKCdbRG9ja2VyIGFjY2Vzc10gRXJyb3Igd2hpbGUgdHJ5aW5nIHRvIHVzZSBkb2NrZXIgY29tbWFuZCcpKTtcbiAgICAgICAgaWYgKGVyci5tZXNzYWdlICYmIGVyci5tZXNzYWdlLmluZGV4T2YoJ0Nhbm5vdCBjb25uZWN0IHRvIHRoZSBEb2NrZXInKSA+IC0xKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ibHVlLmJvbGQoJ1tTb2x1dGlvbl0gU2V0dXAgRG9ja2VyIHRvIGJlIGFibGUgdG8gYmUgdXNlZCB3aXRob3V0IHN1ZG8gcmlnaHRzOicpKTtcbiAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkKCckIHN1ZG8gZ3JvdXBhZGQgZG9ja2VyJykpO1xuICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQoJyQgc3VkbyB1c2VybW9kIC1hRyBkb2NrZXIgJFVTRVInKSk7XG4gICAgICAgICAgY29uc29sZS5sb2coY2hhbGsuYm9sZCgnVGhlbiBMT0dPVVQgYW5kIExPR0lOIHlvdXIgTGludXggc2Vzc2lvbicpKTtcbiAgICAgICAgICBjb25zb2xlLmxvZygnUmVhZCBtb3JlOiBodHRwOi8vYml0Lmx5LzI5SkdkQ0UnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzb2x2ZSgpO1xuICAgIH0pO1xuICB9KTtcbn1cblxuLyoqXG4gKiBTd2l0Y2ggRG9ja2VyZmlsZSBtb2RlXG4gKiBjaGVjayB0ZXN0L3Byb2dyYW1tYXRpYy9jb250YWluZXJpemVyLm1vY2hhLmpzXG4gKi9cbmZ1bmN0aW9uIHBhcnNlQW5kU3dpdGNoKGZpbGVfY29udGVudCwgbWFpbl9maWxlLCBvcHRzKSB7XG4gIHZhciBsaW5lcyA9IGZpbGVfY29udGVudC5zcGxpdCgnXFxuJyk7XG4gIHZhciBtb2RlID0gb3B0cy5tb2RlO1xuXG4gIGxpbmVzWzBdID0gJ0ZST00ga2V5bWV0cmljcy9wbTI6JyArIG9wdHMubm9kZV92ZXJzaW9uO1xuXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgbGluZXMubGVuZ3RoOyBpKyspIHtcbiAgICB2YXIgbGluZSA9IGxpbmVzW2ldO1xuXG4gICAgaWYgKFsnIyMgRElTVFJJQlVUSU9OIE1PREUnLCAnIyMgREVWRUxPUE1FTlQgTU9ERSddLmluZGV4T2YobGluZSkgPiAtMSB8fFxuICAgICAgaSA9PSBsaW5lcy5sZW5ndGggLSAxKSB7XG4gICAgICBsaW5lcy5zcGxpY2UoaSwgbGluZXMubGVuZ3RoKTtcbiAgICAgIGxpbmVzW2ldID0gJyMjICcgKyBtb2RlLnRvVXBwZXJDYXNlKCkgKyAnIE1PREUnO1xuICAgICAgbGluZXNbaSArIDFdID0gJ0VOViBOT0RFX0VOVj0nICsgKG1vZGUgPT0gJ2Rpc3RyaWJ1dGlvbicgPyAncHJvZHVjdGlvbicgOiBtb2RlKTtcblxuICAgICAgaWYgKG1vZGUgPT0gJ2Rpc3RyaWJ1dGlvbicpIHtcbiAgICAgICAgbGluZXNbaSArIDJdID0gJ0NPUFkgLiAvdmFyL2FwcCc7XG4gICAgICAgIGxpbmVzW2kgKyAzXSA9ICdDTUQgW1wicG0yLWRvY2tlclwiLCBcIicgKyBtYWluX2ZpbGUgKyAnXCIsIFwiLS1lbnZcIiwgXCJwcm9kdWN0aW9uXCJdJztcbiAgICAgIH1cbiAgICAgIGlmIChtb2RlID09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgbGluZXNbaSArIDJdID0gJ0NNRCBbXCJwbTItZGV2XCIsIFwiJyArIG1haW5fZmlsZSArICdcIiwgXCItLWVudlwiLCBcImRldmVsb3BtZW50XCJdJztcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfTtcbiAgbGluZXMgPSBsaW5lcy5qb2luKCdcXG4nKTtcbiAgcmV0dXJuIGxpbmVzO1xufTtcblxuLyoqXG4gKiBSZXBsYWNlIEVOViwgQ09QWSBhbmQgQ01EIGRlcGVuZGluZyBvbiB0aGUgbW9kZVxuICogQHBhcmFtIHtTdHJpbmd9IGRvY2tlcl9maWxlcGF0aCBEb2NrZXJmaWxlIGFic29sdXRlIHBhdGhcbiAqIEBwYXJhbSB7U3RyaW5nfSBtYWluX2ZpbGUgICAgICAgTWFpbiBmaWxlIHRvIHN0YXJ0IGluIGNvbnRhaW5lclxuICogQHBhcmFtIHtTdHJpbmd9IG1vZGUgICAgICAgICAgICBNb2RlIHRvIHN3aXRjaCB0aGUgRG9ja2VyZmlsZVxuICovXG5mdW5jdGlvbiBzd2l0Y2hEb2NrZXJGaWxlKGRvY2tlcl9maWxlcGF0aCwgbWFpbl9maWxlLCBvcHRzKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgdmFyIGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoZG9ja2VyX2ZpbGVwYXRoLCAndXRmOCcpLnRvU3RyaW5nKCk7XG5cbiAgICBpZiAoWydkaXN0cmlidXRpb24nLCAnZGV2ZWxvcG1lbnQnXS5pbmRleE9mKG9wdHMubW9kZSkgPT0gLTEpXG4gICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcignVW5rbm93biBtb2RlJykpO1xuXG4gICAgdmFyIGxpbmVzID0gcGFyc2VBbmRTd2l0Y2goZGF0YSwgbWFpbl9maWxlLCBvcHRzKVxuICAgIGZzLndyaXRlRmlsZShkb2NrZXJfZmlsZXBhdGgsIGxpbmVzLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICByZXNvbHZlKHtcbiAgICAgICAgRG9ja2VyZmlsZV9wYXRoOiBkb2NrZXJfZmlsZXBhdGgsXG4gICAgICAgIERvY2tlcmZpbGU6IGxpbmVzLFxuICAgICAgICBDTUQ6ICcnXG4gICAgICB9KTtcbiAgICB9KVxuICB9KTtcbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSBzYW1wbGUgRG9ja2VyZmlsZSAobGliL3RlbXBsYXRlcy9Eb2NrZXJmaWxlcylcbiAqIEBwYXJhbSB7U3RyaW5nfSBkb2NrZXJfZmlsZXBhdGggRG9ja2VyZmlsZSBhYnNvbHV0ZSBwYXRoXG4gKiBAcGFyYW0ge1N0cmluZ30gbWFpbl9maWxlICAgICAgIE1haW4gZmlsZSB0byBzdGFydCBpbiBjb250YWluZXJcbiAqIEBwYXJhbSB7U3RyaW5nfSBtb2RlICAgICAgICAgICAgTW9kZSB0byBzd2l0Y2ggdGhlIERvY2tlcmZpbGVcbiAqL1xuZnVuY3Rpb24gZ2VuZXJhdGVEb2NrZXJmaWxlKGRvY2tlcl9maWxlcGF0aCwgbWFpbl9maWxlLCBvcHRzKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgdmFyIHRwbF9maWxlID0gcGF0aC5qb2luKGNzdC5URU1QTEFURV9GT0xERVIsIGNzdC5ET0NLRVJGSUxFX05PREVKUyk7XG4gICAgdmFyIHRlbXBsYXRlID0gZnMucmVhZEZpbGVTeW5jKHRwbF9maWxlLCB7IGVuY29kaW5nOiAndXRmOCcgfSk7XG4gICAgdmFyIENNRDtcblxuICAgIHRlbXBsYXRlID0gcGFyc2VBbmRTd2l0Y2godGVtcGxhdGUsIG1haW5fZmlsZSwgb3B0cyk7XG5cbiAgICBmcy53cml0ZUZpbGUoZG9ja2VyX2ZpbGVwYXRoLCB0ZW1wbGF0ZSwgZnVuY3Rpb24gKGVycikge1xuICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgcmVzb2x2ZSh7XG4gICAgICAgIERvY2tlcmZpbGVfcGF0aDogZG9ja2VyX2ZpbGVwYXRoLFxuICAgICAgICBEb2NrZXJmaWxlOiB0ZW1wbGF0ZSxcbiAgICAgICAgQ01EOiBDTURcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gaGFuZGxlRXhpdChDTEksIG9wdHMsIG1vZGUpIHtcbiAgcHJvY2Vzcy5vbignU0lHSU5UJywgZnVuY3Rpb24gKCkge1xuICAgIENMSS5kaXNjb25uZWN0KCk7XG5cbiAgICBpZiAobW9kZSAhPSAnZGlzdHJpYnV0aW9uJylcbiAgICAgIHJldHVybiBmYWxzZTtcblxuICAgIGV4ZWMoJ2RvY2tlciBwcyAtbHEnLCBmdW5jdGlvbiAoZXJyLCBzdGRvdXQsIHN0ZGVycikge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICB9XG4gICAgICByZXF1aXJlKCd2aXppb24nKS5hbmFseXplKHsgZm9sZGVyOiBwcm9jZXNzLmN3ZCgpIH0sIGZ1bmN0aW9uIHJlY3VyX3BhdGgoZXJyLCBtZXRhKSB7XG4gICAgICAgIGlmICghZXJyICYmIG1ldGEucmV2aXNpb24pIHtcbiAgICAgICAgICB2YXIgY29tbWl0X2lkID0gdXRpbC5mb3JtYXQoJyMlcyglcykgJXMnLFxuICAgICAgICAgICAgbWV0YS5icmFuY2gsXG4gICAgICAgICAgICBtZXRhLnJldmlzaW9uLnNsaWNlKDAsIDUpLFxuICAgICAgICAgICAgbWV0YS5jb21tZW50KTtcblxuICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQubWFnZW50YSgnJCBkb2NrZXIgY29tbWl0IC1tIFwiJXNcIiAlcyAlcycpLFxuICAgICAgICAgICAgY29tbWl0X2lkLFxuICAgICAgICAgICAgc3Rkb3V0LnJlcGxhY2UoJ1xcbicsICcnKSxcbiAgICAgICAgICAgIG9wdHMuaW1hZ2VOYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlXG4gICAgICAgICAgY29uc29sZS5sb2coY2hhbGsuYm9sZC5tYWdlbnRhKCckIGRvY2tlciBjb21taXQgJXMgJXMnKSwgc3Rkb3V0LnJlcGxhY2UoJ1xcbicsICcnKSwgb3B0cy5pbWFnZU5hbWUpO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQubWFnZW50YSgnJCBkb2NrZXIgcHVzaCAlcycpLCBvcHRzLmltYWdlTmFtZSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChDTEkpIHtcbiAgQ0xJLnByb3RvdHlwZS5nZW5lcmF0ZURvY2tlcmZpbGUgPSBmdW5jdGlvbiAoc2NyaXB0LCBvcHRzKSB7XG4gICAgdmFyIGRvY2tlcl9maWxlcGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAnRG9ja2VyZmlsZScpO1xuICAgIHZhciB0aGF0ID0gdGhpcztcblxuICAgIGZzLnN0YXQoZG9ja2VyX2ZpbGVwYXRoLCBmdW5jdGlvbiAoZXJyLCBzdGF0KSB7XG4gICAgICBpZiAoZXJyIHx8IG9wdHMuZm9yY2UgPT0gdHJ1ZSkge1xuICAgICAgICBnZW5lcmF0ZURvY2tlcmZpbGUoZG9ja2VyX2ZpbGVwYXRoLCBzY3JpcHQsIHtcbiAgICAgICAgICBtb2RlOiAnZGV2ZWxvcG1lbnQnXG4gICAgICAgIH0pXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsuYm9sZCgnTmV3IERvY2tlcmZpbGUgZ2VuZXJhdGVkIGluIGN1cnJlbnQgZm9sZGVyJykpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsuYm9sZCgnWW91IGNhbiBub3cgcnVuXFxuJCBwbTIgZG9ja2VyOmRldiA8ZmlsZXxjb25maWc+JykpO1xuICAgICAgICAgICAgcmV0dXJuIHRoYXQuZXhpdENsaShjc3QuU1VDQ0VTU19FWElUKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgY29uc29sZS5sb2coY2hhbGsucmVkLmJvbGQoJ0RvY2tlcmZpbGUgYWxyZWFkeSBleGlzdHMgaW4gdGhpcyBmb2xkZXIsIHVzZSAtLWZvcmNlIGlmIHlvdSB3YW50IHRvIHJlcGxhY2UgaXQnKSk7XG4gICAgICB0aGF0LmV4aXRDbGkoY3N0LkVSUk9SX0VYSVQpO1xuICAgIH0pO1xuICB9O1xuXG4gIENMSS5wcm90b3R5cGUuZG9ja2VyTW9kZSA9IGZ1bmN0aW9uIChzY3JpcHQsIG9wdHMsIG1vZGUpIHtcbiAgICB2YXIgcHJvbXB0bHkgPSByZXF1aXJlKCdwcm9tcHRseScpO1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBoYW5kbGVFeGl0KHNlbGYsIG9wdHMsIG1vZGUpO1xuXG4gICAgaWYgKG1vZGUgPT0gJ2Rpc3RyaWJ1dGlvbicgJiYgIW9wdHMuaW1hZ2VOYW1lKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGNoYWxrLmJvbGQucmVkKCctLWltYWdlLW5hbWUgW25hbWVdIG9wdGlvbiBpcyBtaXNzaW5nJykpO1xuICAgICAgcmV0dXJuIHNlbGYuZXhpdENsaShjc3QuRVJST1JfRVhJVCk7XG4gICAgfVxuXG4gICAgdmFyIHRlbXBsYXRlO1xuICAgIHZhciBhcHBfcGF0aCwgbWFpbl9zY3JpcHQ7XG4gICAgdmFyIGltYWdlX25hbWU7XG4gICAgdmFyIG5vZGVfdmVyc2lvbiA9IG9wdHMubm9kZVZlcnNpb24gPyBvcHRzLm5vZGVWZXJzaW9uLnNwbGl0KCcuJylbMF0gOiAnbGF0ZXN0JztcblxuICAgIGltYWdlX25hbWUgPSBvcHRzLmltYWdlTmFtZSB8fCByZXF1aXJlKCdjcnlwdG8nKS5yYW5kb21CeXRlcyg2KS50b1N0cmluZygnaGV4Jyk7XG5cbiAgICBpZiAoc2NyaXB0LmluZGV4T2YoJy8nKSA+IC0xKSB7XG4gICAgICBhcHBfcGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBwYXRoLmRpcm5hbWUoc2NyaXB0KSk7XG4gICAgICBtYWluX3NjcmlwdCA9IHBhdGguYmFzZW5hbWUoc2NyaXB0KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBhcHBfcGF0aCA9IHByb2Nlc3MuY3dkKCk7XG4gICAgICBtYWluX3NjcmlwdCA9IHNjcmlwdDtcbiAgICB9XG5cbiAgICBjaGVja0RvY2tlclNldHVwKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgICAgICAvLyBHZW5lcmF0ZSBEb2NrZXJmaWxlIC8vXG4gICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICB2YXIgZG9ja2VyX2ZpbGVwYXRoID0gcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksICdEb2NrZXJmaWxlJyk7XG5cbiAgICAgICAgICBmcy5zdGF0KGRvY2tlcl9maWxlcGF0aCwgZnVuY3Rpb24gKGVyciwgc3RhdCkge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAvLyBEb2NrZXJmaWxlIGRvZXMgbm90IGV4aXN0LCBnZW5lcmF0ZSBvbmVcbiAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coY2hhbGsuYmx1ZS5ib2xkKCdHZW5lcmF0aW5nIG5ldyBEb2NrZXJmaWxlJykpO1xuICAgICAgICAgICAgICBpZiAob3B0cy5mb3JjZSA9PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoZ2VuZXJhdGVEb2NrZXJmaWxlKGRvY2tlcl9maWxlcGF0aCwgbWFpbl9zY3JpcHQsIHtcbiAgICAgICAgICAgICAgICAgIG5vZGVfdmVyc2lvbjogbm9kZV92ZXJzaW9uLFxuICAgICAgICAgICAgICAgICAgbW9kZTogbW9kZVxuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAob3B0cy5kb2NrZXJkYWVtb24pXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoZ2VuZXJhdGVEb2NrZXJmaWxlKGRvY2tlcl9maWxlcGF0aCwgbWFpbl9zY3JpcHQsIHtcbiAgICAgICAgICAgICAgICAgIG5vZGVfdmVyc2lvbjogbm9kZV92ZXJzaW9uLFxuICAgICAgICAgICAgICAgICAgbW9kZTogbW9kZVxuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgcHJvbXB0bHkucHJvbXB0KCdObyBEb2NrZXJmaWxlIGluIGN1cnJlbnQgZGlyZWN0b3J5LCBvayB0byBnZW5lcmF0ZSBhIG5ldyBvbmU/ICh5L24pJywgZnVuY3Rpb24gKGVyciwgdmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gJ3knKVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoZ2VuZXJhdGVEb2NrZXJmaWxlKGRvY2tlcl9maWxlcGF0aCwgbWFpbl9zY3JpcHQsIHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZV92ZXJzaW9uOiBub2RlX3ZlcnNpb24sXG4gICAgICAgICAgICAgICAgICAgIG1vZGU6IG1vZGVcbiAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5leGl0Q2xpKGNzdC5TVUNDRVNTX0VYSVQpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoc3dpdGNoRG9ja2VyRmlsZShkb2NrZXJfZmlsZXBhdGgsIG1haW5fc2NyaXB0LCB7XG4gICAgICAgICAgICAgIG5vZGVfdmVyc2lvbjogbm9kZV92ZXJzaW9uLFxuICAgICAgICAgICAgICBtb2RlOiBtb2RlXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChfdGVtcGxhdGUpIHtcbiAgICAgICAgdGVtcGxhdGUgPSBfdGVtcGxhdGU7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vL1xuICAgICAgICAvLyBEb2NrZXIgYnVpbGQgLy9cbiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAgICAgdmFyIGRvY2tlcl9idWlsZCA9IHV0aWwuZm9ybWF0KCdkb2NrZXIgYnVpbGQgLXQgJXMgLWYgJXMnLFxuICAgICAgICAgIGltYWdlX25hbWUsXG4gICAgICAgICAgdGVtcGxhdGUuRG9ja2VyZmlsZV9wYXRoKTtcblxuICAgICAgICBpZiAob3B0cy5mcmVzaCA9PSB0cnVlKVxuICAgICAgICAgIGRvY2tlcl9idWlsZCArPSAnIC0tbm8tY2FjaGUnO1xuICAgICAgICBkb2NrZXJfYnVpbGQgKz0gJyAuJztcblxuICAgICAgICBjb25zb2xlLmxvZygpO1xuICAgICAgICBmbXQuc2VwKCk7XG4gICAgICAgIGZtdC50aXRsZSgnQnVpbGRpbmcgQm9vdCBTeXN0ZW0nKTtcbiAgICAgICAgZm10LmZpZWxkKCdUeXBlJywgY2hhbGsuY3lhbi5ib2xkKCdEb2NrZXInKSk7XG4gICAgICAgIGZtdC5maWVsZCgnTW9kZScsIG1vZGUpO1xuICAgICAgICBmbXQuZmllbGQoJ0ltYWdlIG5hbWUnLCBpbWFnZV9uYW1lKTtcbiAgICAgICAgZm10LmZpZWxkKCdEb2NrZXIgYnVpbGQgY29tbWFuZCcsIGRvY2tlcl9idWlsZCk7XG4gICAgICAgIGZtdC5maWVsZCgnRG9ja2VyZmlsZSBwYXRoJywgdGVtcGxhdGUuRG9ja2VyZmlsZV9wYXRoKTtcbiAgICAgICAgZm10LnNlcCgpO1xuXG4gICAgICAgIHJldHVybiBwc3Bhd24oZG9ja2VyX2J1aWxkKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgIC8vLy8vLy8vLy8vLy8vLy9cbiAgICAgICAgLy8gRG9ja2VyIHJ1biAvL1xuICAgICAgICAvLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAgICAgdmFyIGRvY2tlcl9ydW4gPSAnZG9ja2VyIHJ1biAtLW5ldCBob3N0JztcblxuICAgICAgICBpZiAob3B0cy5kb2NrZXJkYWVtb24gPT0gdHJ1ZSlcbiAgICAgICAgICBkb2NrZXJfcnVuICs9ICcgLWQnO1xuICAgICAgICBpZiAobW9kZSAhPSAnZGlzdHJpYnV0aW9uJylcbiAgICAgICAgICBkb2NrZXJfcnVuICs9IHV0aWwuZm9ybWF0KCcgLXYgJXM6L3Zhci9hcHAgLXYgL3Zhci9hcHAvbm9kZV9tb2R1bGVzJywgYXBwX3BhdGgpO1xuICAgICAgICBkb2NrZXJfcnVuICs9ICcgJyArIGltYWdlX25hbWU7XG4gICAgICAgIHZhciBkb2NrZXJmaWxlX3BhcnNlZCA9IHRlbXBsYXRlLkRvY2tlcmZpbGUuc3BsaXQoJ1xcbicpO1xuICAgICAgICB2YXIgYmFzZV9pbWFnZSA9IGRvY2tlcmZpbGVfcGFyc2VkWzBdO1xuICAgICAgICB2YXIgcnVuX2NtZCA9IGRvY2tlcmZpbGVfcGFyc2VkW2RvY2tlcmZpbGVfcGFyc2VkLmxlbmd0aCAtIDFdO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKCk7XG4gICAgICAgIGZtdC5zZXAoKTtcbiAgICAgICAgZm10LnRpdGxlKCdCb290aW5nJyk7XG4gICAgICAgIGZtdC5maWVsZCgnVHlwZScsIGNoYWxrLmN5YW4uYm9sZCgnRG9ja2VyJykpO1xuICAgICAgICBmbXQuZmllbGQoJ01vZGUnLCBtb2RlKTtcbiAgICAgICAgZm10LmZpZWxkKCdCYXNlIEltYWdlJywgYmFzZV9pbWFnZSk7XG4gICAgICAgIGZtdC5maWVsZCgnSW1hZ2UgTmFtZScsIGltYWdlX25hbWUpO1xuICAgICAgICBmbXQuZmllbGQoJ0RvY2tlciBDb21tYW5kJywgZG9ja2VyX3J1bik7XG4gICAgICAgIGZtdC5maWVsZCgnUlVOIENvbW1hbmQnLCBydW5fY21kKTtcbiAgICAgICAgZm10LmZpZWxkKCdDV0QnLCBhcHBfcGF0aCk7XG4gICAgICAgIGZtdC5zZXAoKTtcbiAgICAgICAgcmV0dXJuIHBzcGF3bihkb2NrZXJfcnVuKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJsdWUuYm9sZCgnPj4+IExlYXZpbmcgRG9ja2VyIGluc3RhbmNlIHV1aWQ9JXMnKSwgaW1hZ2VfbmFtZSk7XG4gICAgICAgIHNlbGYuZGlzY29ubmVjdCgpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JleSgnUmF3IGVycm9yPScsIGVyci5tZXNzYWdlKSk7XG4gICAgICAgIHNlbGYuZGlzY29ubmVjdCgpO1xuICAgICAgfSk7XG5cbiAgfTtcblxufTtcblxuZXhwb3J0IHtcbiAgZ2VuZXJhdGVEb2NrZXJmaWxlLFxuICBwYXJzZUFuZFN3aXRjaCxcbiAgc3dpdGNoRG9ja2VyRmlsZSxcbn1cbiJdfQ==
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;
exports.generateDockerfile = generateDockerfile;
exports.parseAndSwitch = parseAndSwitch;
exports.switchDockerFile = switchDockerFile;

var _child_process = require("child_process");

var _chalk = _interopRequireDefault(require("chalk"));

var _util = _interopRequireDefault(require("util"));

var fmt = _interopRequireWildcard(require("../tools/fmt"));

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _constants = _interopRequireDefault(require("../../constants"));

var _promise = _interopRequireDefault(require("../tools/promise.min"));

function pspawn(cmd) {
  return new _promise["default"](function (resolve, reject) {
    var p_cmd = cmd.split(' ');
    var install_instance = (0, _child_process.spawn)(p_cmd[0], p_cmd.splice(1, cmd.length), {
      stdio: 'inherit',
      env: process.env,
      shell: true
    });
    install_instance.on('close', function (code) {
      if (code != 0) {
        console.log(_chalk["default"].bold.red('Command failed'));
        return reject(new Error('Bad cmd return'));
      }

      return resolve();
    });
    install_instance.on('error', function (err) {
      return reject(err);
    });
  });
}

function checkDockerSetup() {
  return new _promise["default"](function (resolve, reject) {
    (0, _child_process.exec)("docker version -f '{{.Client.Version}}'", function (err, stdout, stderr) {
      if (err) {
        console.error(_chalk["default"].red.bold('[Docker access] Error while trying to use docker command'));

        if (err.message && err.message.indexOf('Cannot connect to the Docker') > -1) {
          console.log();
          console.log(_chalk["default"].blue.bold('[Solution] Setup Docker to be able to be used without sudo rights:'));
          console.log(_chalk["default"].bold('$ sudo groupadd docker'));
          console.log(_chalk["default"].bold('$ sudo usermod -aG docker $USER'));
          console.log(_chalk["default"].bold('Then LOGOUT and LOGIN your Linux session'));
          console.log('Read more: http://bit.ly/29JGdCE');
        }

        return reject(err);
      }

      return resolve();
    });
  });
}
/**
 * Switch Dockerfile mode
 * check test/programmatic/containerizer.mocha.js
 */


function parseAndSwitch(file_content, main_file, opts) {
  var lines = file_content.split('\n');
  var mode = opts.mode;
  lines[0] = 'FROM keymetrics/pm2:' + opts.node_version;

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];

    if (['## DISTRIBUTION MODE', '## DEVELOPMENT MODE'].indexOf(line) > -1 || i == lines.length - 1) {
      lines.splice(i, lines.length);
      lines[i] = '## ' + mode.toUpperCase() + ' MODE';
      lines[i + 1] = 'ENV NODE_ENV=' + (mode == 'distribution' ? 'production' : mode);

      if (mode == 'distribution') {
        lines[i + 2] = 'COPY . /var/app';
        lines[i + 3] = 'CMD ["pm2-docker", "' + main_file + '", "--env", "production"]';
      }

      if (mode == 'development') {
        lines[i + 2] = 'CMD ["pm2-dev", "' + main_file + '", "--env", "development"]';
      }

      break;
    }
  }

  ;
  lines = lines.join('\n');
  return lines;
}

;
/**
 * Replace ENV, COPY and CMD depending on the mode
 * @param {String} docker_filepath Dockerfile absolute path
 * @param {String} main_file       Main file to start in container
 * @param {String} mode            Mode to switch the Dockerfile
 */

function switchDockerFile(docker_filepath, main_file, opts) {
  return new _promise["default"](function (resolve, reject) {
    var data = _fs["default"].readFileSync(docker_filepath, 'utf8').toString();

    if (['distribution', 'development'].indexOf(opts.mode) == -1) return reject(new Error('Unknown mode'));
    var lines = parseAndSwitch(data, main_file, opts);

    _fs["default"].writeFile(docker_filepath, lines, function (err) {
      if (err) return reject(err);
      resolve({
        Dockerfile_path: docker_filepath,
        Dockerfile: lines,
        CMD: ''
      });
    });
  });
}
/**
 * Generate sample Dockerfile (lib/templates/Dockerfiles)
 * @param {String} docker_filepath Dockerfile absolute path
 * @param {String} main_file       Main file to start in container
 * @param {String} mode            Mode to switch the Dockerfile
 */


function generateDockerfile(docker_filepath, main_file, opts) {
  return new _promise["default"](function (resolve, reject) {
    var tpl_file = _path["default"].join(_constants["default"].TEMPLATE_FOLDER, _constants["default"].DOCKERFILE_NODEJS);

    var template = _fs["default"].readFileSync(tpl_file, {
      encoding: 'utf8'
    });

    var CMD;
    template = parseAndSwitch(template, main_file, opts);

    _fs["default"].writeFile(docker_filepath, template, function (err) {
      if (err) return reject(err);
      resolve({
        Dockerfile_path: docker_filepath,
        Dockerfile: template,
        CMD: CMD
      });
    });
  });
}

function handleExit(CLI, opts, mode) {
  process.on('SIGINT', function () {
    CLI.disconnect();
    if (mode != 'distribution') return false;
    (0, _child_process.exec)('docker ps -lq', function (err, stdout, stderr) {
      if (err) {
        console.error(err);
      }

      require('vizion').analyze({
        folder: process.cwd()
      }, function recur_path(err, meta) {
        if (!err && meta.revision) {
          var commit_id = _util["default"].format('#%s(%s) %s', meta.branch, meta.revision.slice(0, 5), meta.comment);

          console.log(_chalk["default"].bold.magenta('$ docker commit -m "%s" %s %s'), commit_id, stdout.replace('\n', ''), opts.imageName);
        } else console.log(_chalk["default"].bold.magenta('$ docker commit %s %s'), stdout.replace('\n', ''), opts.imageName);

        console.log(_chalk["default"].bold.magenta('$ docker push %s'), opts.imageName);
      });
    });
  });
}

function _default(CLI) {
  CLI.prototype.generateDockerfile = function (script, opts) {
    var docker_filepath = _path["default"].join(process.cwd(), 'Dockerfile');

    var that = this;

    _fs["default"].stat(docker_filepath, function (err, stat) {
      if (err || opts.force == true) {
        generateDockerfile(docker_filepath, script, {
          mode: 'development'
        }).then(function () {
          console.log(_chalk["default"].bold('New Dockerfile generated in current folder'));
          console.log(_chalk["default"].bold('You can now run\n$ pm2 docker:dev <file|config>'));
          return that.exitCli(_constants["default"].SUCCESS_EXIT);
        });
        return false;
      }

      console.log(_chalk["default"].red.bold('Dockerfile already exists in this folder, use --force if you want to replace it'));
      that.exitCli(_constants["default"].ERROR_EXIT);
    });
  };

  CLI.prototype.dockerMode = function (script, opts, mode) {
    var promptly = require('promptly');

    var self = this;
    handleExit(self, opts, mode);

    if (mode == 'distribution' && !opts.imageName) {
      console.error(_chalk["default"].bold.red('--image-name [name] option is missing'));
      return self.exitCli(_constants["default"].ERROR_EXIT);
    }

    var template;
    var app_path, main_script;
    var image_name;
    var node_version = opts.nodeVersion ? opts.nodeVersion.split('.')[0] : 'latest';
    image_name = opts.imageName || require('crypto').randomBytes(6).toString('hex');

    if (script.indexOf('/') > -1) {
      app_path = _path["default"].join(process.cwd(), _path["default"].dirname(script));
      main_script = _path["default"].basename(script);
    } else {
      app_path = process.cwd();
      main_script = script;
    }

    checkDockerSetup().then(function () {
      /////////////////////////
      // Generate Dockerfile //
      /////////////////////////
      return new _promise["default"](function (resolve, reject) {
        var docker_filepath = _path["default"].join(process.cwd(), 'Dockerfile');

        _fs["default"].stat(docker_filepath, function (err, stat) {
          if (err) {
            // Dockerfile does not exist, generate one
            // console.log(chalk.blue.bold('Generating new Dockerfile'));
            if (opts.force == true) {
              return resolve(generateDockerfile(docker_filepath, main_script, {
                node_version: node_version,
                mode: mode
              }));
            }

            if (opts.dockerdaemon) return resolve(generateDockerfile(docker_filepath, main_script, {
              node_version: node_version,
              mode: mode
            }));
            promptly.prompt('No Dockerfile in current directory, ok to generate a new one? (y/n)', function (err, value) {
              if (value == 'y') return resolve(generateDockerfile(docker_filepath, main_script, {
                node_version: node_version,
                mode: mode
              }));else return self.exitCli(_constants["default"].SUCCESS_EXIT);
            });
            return false;
          }

          return resolve(switchDockerFile(docker_filepath, main_script, {
            node_version: node_version,
            mode: mode
          }));
        });
      });
    }).then(function (_template) {
      template = _template;
      return _promise["default"].resolve();
    }).then(function () {
      //////////////////
      // Docker build //
      //////////////////
      var docker_build = _util["default"].format('docker build -t %s -f %s', image_name, template.Dockerfile_path);

      if (opts.fresh == true) docker_build += ' --no-cache';
      docker_build += ' .';
      console.log();
      fmt.sep();
      fmt.title('Building Boot System');
      fmt.field('Type', _chalk["default"].cyan.bold('Docker'));
      fmt.field('Mode', mode);
      fmt.field('Image name', image_name);
      fmt.field('Docker build command', docker_build);
      fmt.field('Dockerfile path', template.Dockerfile_path);
      fmt.sep();
      return pspawn(docker_build);
    }).then(function () {
      ////////////////
      // Docker run //
      ////////////////
      var docker_run = 'docker run --net host';
      if (opts.dockerdaemon == true) docker_run += ' -d';
      if (mode != 'distribution') docker_run += _util["default"].format(' -v %s:/var/app -v /var/app/node_modules', app_path);
      docker_run += ' ' + image_name;
      var dockerfile_parsed = template.Dockerfile.split('\n');
      var base_image = dockerfile_parsed[0];
      var run_cmd = dockerfile_parsed[dockerfile_parsed.length - 1];
      console.log();
      fmt.sep();
      fmt.title('Booting');
      fmt.field('Type', _chalk["default"].cyan.bold('Docker'));
      fmt.field('Mode', mode);
      fmt.field('Base Image', base_image);
      fmt.field('Image Name', image_name);
      fmt.field('Docker Command', docker_run);
      fmt.field('RUN Command', run_cmd);
      fmt.field('CWD', app_path);
      fmt.sep();
      return pspawn(docker_run);
    }).then(function () {
      console.log(_chalk["default"].blue.bold('>>> Leaving Docker instance uuid=%s'), image_name);
      self.disconnect();
      return _promise["default"].resolve();
    })["catch"](function (err) {
      console.log();
      console.log(_chalk["default"].grey('Raw error=', err.message));
      self.disconnect();
    });
  };
}

;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BUEkvQ29udGFpbmVyaXplci50cyJdLCJuYW1lcyI6WyJwc3Bhd24iLCJjbWQiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInBfY21kIiwic3BsaXQiLCJpbnN0YWxsX2luc3RhbmNlIiwic3BsaWNlIiwibGVuZ3RoIiwic3RkaW8iLCJlbnYiLCJwcm9jZXNzIiwic2hlbGwiLCJvbiIsImNvZGUiLCJjb25zb2xlIiwibG9nIiwiY2hhbGsiLCJib2xkIiwicmVkIiwiRXJyb3IiLCJlcnIiLCJjaGVja0RvY2tlclNldHVwIiwic3Rkb3V0Iiwic3RkZXJyIiwiZXJyb3IiLCJtZXNzYWdlIiwiaW5kZXhPZiIsImJsdWUiLCJwYXJzZUFuZFN3aXRjaCIsImZpbGVfY29udGVudCIsIm1haW5fZmlsZSIsIm9wdHMiLCJsaW5lcyIsIm1vZGUiLCJub2RlX3ZlcnNpb24iLCJpIiwibGluZSIsInRvVXBwZXJDYXNlIiwiam9pbiIsInN3aXRjaERvY2tlckZpbGUiLCJkb2NrZXJfZmlsZXBhdGgiLCJkYXRhIiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsIndyaXRlRmlsZSIsIkRvY2tlcmZpbGVfcGF0aCIsIkRvY2tlcmZpbGUiLCJDTUQiLCJnZW5lcmF0ZURvY2tlcmZpbGUiLCJ0cGxfZmlsZSIsInBhdGgiLCJjc3QiLCJURU1QTEFURV9GT0xERVIiLCJET0NLRVJGSUxFX05PREVKUyIsInRlbXBsYXRlIiwiZW5jb2RpbmciLCJoYW5kbGVFeGl0IiwiQ0xJIiwiZGlzY29ubmVjdCIsInJlcXVpcmUiLCJhbmFseXplIiwiZm9sZGVyIiwiY3dkIiwicmVjdXJfcGF0aCIsIm1ldGEiLCJyZXZpc2lvbiIsImNvbW1pdF9pZCIsInV0aWwiLCJmb3JtYXQiLCJicmFuY2giLCJzbGljZSIsImNvbW1lbnQiLCJtYWdlbnRhIiwicmVwbGFjZSIsImltYWdlTmFtZSIsInByb3RvdHlwZSIsInNjcmlwdCIsInRoYXQiLCJzdGF0IiwiZm9yY2UiLCJ0aGVuIiwiZXhpdENsaSIsIlNVQ0NFU1NfRVhJVCIsIkVSUk9SX0VYSVQiLCJkb2NrZXJNb2RlIiwicHJvbXB0bHkiLCJzZWxmIiwiYXBwX3BhdGgiLCJtYWluX3NjcmlwdCIsImltYWdlX25hbWUiLCJub2RlVmVyc2lvbiIsInJhbmRvbUJ5dGVzIiwiZGlybmFtZSIsImJhc2VuYW1lIiwiZG9ja2VyZGFlbW9uIiwicHJvbXB0IiwidmFsdWUiLCJfdGVtcGxhdGUiLCJkb2NrZXJfYnVpbGQiLCJmcmVzaCIsImZtdCIsInNlcCIsInRpdGxlIiwiZmllbGQiLCJjeWFuIiwiZG9ja2VyX3J1biIsImRvY2tlcmZpbGVfcGFyc2VkIiwiYmFzZV9pbWFnZSIsInJ1bl9jbWQiLCJncmV5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLFNBQVNBLE1BQVQsQ0FBZ0JDLEdBQWhCLEVBQXFCO0FBQ2pCLFNBQU8sSUFBSUMsbUJBQUosQ0FBWSxVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUMxQyxRQUFJQyxLQUFLLEdBQUdKLEdBQUcsQ0FBQ0ssS0FBSixDQUFVLEdBQVYsQ0FBWjtBQUVBLFFBQUlDLGdCQUFnQixHQUFHLDBCQUFNRixLQUFLLENBQUMsQ0FBRCxDQUFYLEVBQWdCQSxLQUFLLENBQUNHLE1BQU4sQ0FBYSxDQUFiLEVBQWdCUCxHQUFHLENBQUNRLE1BQXBCLENBQWhCLEVBQTZDO0FBQ2hFQyxNQUFBQSxLQUFLLEVBQUUsU0FEeUQ7QUFFaEVDLE1BQUFBLEdBQUcsRUFBRUMsT0FBTyxDQUFDRCxHQUZtRDtBQUdoRUUsTUFBQUEsS0FBSyxFQUFFO0FBSHlELEtBQTdDLENBQXZCO0FBTUFOLElBQUFBLGdCQUFnQixDQUFDTyxFQUFqQixDQUFvQixPQUFwQixFQUE2QixVQUFVQyxJQUFWLEVBQWdCO0FBQ3pDLFVBQUlBLElBQUksSUFBSSxDQUFaLEVBQWU7QUFDWEMsUUFBQUEsT0FBTyxDQUFD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QUFDSCxLQTVHTDtBQThHSCxHQXhJRDtBQTBJSDs7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgc3Bhd24gfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgdXRpbCBmcm9tICd1dGlsJztcbmltcG9ydCAqIGFzIGZtdCBmcm9tICcuLi90b29scy9mbXQnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGNzdCBmcm9tICcuLi8uLi9jb25zdGFudHMnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAnLi4vdG9vbHMvcHJvbWlzZS5taW4nO1xuXG5mdW5jdGlvbiBwc3Bhd24oY21kKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgdmFyIHBfY21kID0gY21kLnNwbGl0KCcgJyk7XG5cbiAgICAgICAgdmFyIGluc3RhbGxfaW5zdGFuY2UgPSBzcGF3bihwX2NtZFswXSwgcF9jbWQuc3BsaWNlKDEsIGNtZC5sZW5ndGgpLCB7XG4gICAgICAgICAgICBzdGRpbzogJ2luaGVyaXQnLFxuICAgICAgICAgICAgZW52OiBwcm9jZXNzLmVudixcbiAgICAgICAgICAgIHNoZWxsOiB0cnVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGluc3RhbGxfaW5zdGFuY2Uub24oJ2Nsb3NlJywgZnVuY3Rpb24gKGNvZGUpIHtcbiAgICAgICAgICAgIGlmIChjb2RlICE9IDApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkLnJlZCgnQ29tbWFuZCBmYWlsZWQnKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChuZXcgRXJyb3IoJ0JhZCBjbWQgcmV0dXJuJykpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaW5zdGFsbF9pbnN0YW5jZS5vbignZXJyb3InLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBjaGVja0RvY2tlclNldHVwKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGV4ZWMoXCJkb2NrZXIgdmVyc2lvbiAtZiAne3suQ2xpZW50LlZlcnNpb259fSdcIiwgZnVuY3Rpb24gKGVyciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZC5ib2xkKCdbRG9ja2VyIGFjY2Vzc10gRXJyb3Igd2hpbGUgdHJ5aW5nIHRvIHVzZSBkb2NrZXIgY29tbWFuZCcpKTtcbiAgICAgICAgICAgICAgICBpZiAoZXJyLm1lc3NhZ2UgJiYgZXJyLm1lc3NhZ2UuaW5kZXhPZignQ2Fubm90IGNvbm5lY3QgdG8gdGhlIERvY2tlcicpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsuYmx1ZS5ib2xkKCdbU29sdXRpb25dIFNldHVwIERvY2tlciB0byBiZSBhYmxlIHRvIGJlIHVzZWQgd2l0aG91dCBzdWRvIHJpZ2h0czonKSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQoJyQgc3VkbyBncm91cGFkZCBkb2NrZXInKSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQoJyQgc3VkbyB1c2VybW9kIC1hRyBkb2NrZXIgJFVTRVInKSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQoJ1RoZW4gTE9HT1VUIGFuZCBMT0dJTiB5b3VyIExpbnV4IHNlc3Npb24nKSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdSZWFkIG1vcmU6IGh0dHA6Ly9iaXQubHkvMjlKR2RDRScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBTd2l0Y2ggRG9ja2VyZmlsZSBtb2RlXG4gKiBjaGVjayB0ZXN0L3Byb2dyYW1tYXRpYy9jb250YWluZXJpemVyLm1vY2hhLmpzXG4gKi9cbmZ1bmN0aW9uIHBhcnNlQW5kU3dpdGNoKGZpbGVfY29udGVudCwgbWFpbl9maWxlLCBvcHRzKSB7XG4gICAgdmFyIGxpbmVzID0gZmlsZV9jb250ZW50LnNwbGl0KCdcXG4nKTtcbiAgICB2YXIgbW9kZSA9IG9wdHMubW9kZTtcblxuICAgIGxpbmVzWzBdID0gJ0ZST00ga2V5bWV0cmljcy9wbTI6JyArIG9wdHMubm9kZV92ZXJzaW9uO1xuXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykge1xuICAgICAgICB2YXIgbGluZSA9IGxpbmVzW2ldO1xuXG4gICAgICAgIGlmIChbJyMjIERJU1RSSUJVVElPTiBNT0RFJywgJyMjIERFVkVMT1BNRU5UIE1PREUnXS5pbmRleE9mKGxpbmUpID4gLTEgfHxcbiAgICAgICAgICAgIGkgPT0gbGluZXMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgbGluZXMuc3BsaWNlKGksIGxpbmVzLmxlbmd0aCk7XG4gICAgICAgICAgICBsaW5lc1tpXSA9ICcjIyAnICsgbW9kZS50b1VwcGVyQ2FzZSgpICsgJyBNT0RFJztcbiAgICAgICAgICAgIGxpbmVzW2kgKyAxXSA9ICdFTlYgTk9ERV9FTlY9JyArIChtb2RlID09ICdkaXN0cmlidXRpb24nID8gJ3Byb2R1Y3Rpb24nIDogbW9kZSk7XG5cbiAgICAgICAgICAgIGlmIChtb2RlID09ICdkaXN0cmlidXRpb24nKSB7XG4gICAgICAgICAgICAgICAgbGluZXNbaSArIDJdID0gJ0NPUFkgLiAvdmFyL2FwcCc7XG4gICAgICAgICAgICAgICAgbGluZXNbaSArIDNdID0gJ0NNRCBbXCJwbTItZG9ja2VyXCIsIFwiJyArIG1haW5fZmlsZSArICdcIiwgXCItLWVudlwiLCBcInByb2R1Y3Rpb25cIl0nO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG1vZGUgPT0gJ2RldmVsb3BtZW50Jykge1xuICAgICAgICAgICAgICAgIGxpbmVzW2kgKyAyXSA9ICdDTUQgW1wicG0yLWRldlwiLCBcIicgKyBtYWluX2ZpbGUgKyAnXCIsIFwiLS1lbnZcIiwgXCJkZXZlbG9wbWVudFwiXSc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH07XG4gICAgbGluZXMgPSBsaW5lcy5qb2luKCdcXG4nKTtcbiAgICByZXR1cm4gbGluZXM7XG59O1xuXG4vKipcbiAqIFJlcGxhY2UgRU5WLCBDT1BZIGFuZCBDTUQgZGVwZW5kaW5nIG9uIHRoZSBtb2RlXG4gKiBAcGFyYW0ge1N0cmluZ30gZG9ja2VyX2ZpbGVwYXRoIERvY2tlcmZpbGUgYWJzb2x1dGUgcGF0aFxuICogQHBhcmFtIHtTdHJpbmd9IG1haW5fZmlsZSAgICAgICBNYWluIGZpbGUgdG8gc3RhcnQgaW4gY29udGFpbmVyXG4gKiBAcGFyYW0ge1N0cmluZ30gbW9kZSAgICAgICAgICAgIE1vZGUgdG8gc3dpdGNoIHRoZSBEb2NrZXJmaWxlXG4gKi9cbmZ1bmN0aW9uIHN3aXRjaERvY2tlckZpbGUoZG9ja2VyX2ZpbGVwYXRoLCBtYWluX2ZpbGUsIG9wdHMpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICB2YXIgZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhkb2NrZXJfZmlsZXBhdGgsICd1dGY4JykudG9TdHJpbmcoKTtcblxuICAgICAgICBpZiAoWydkaXN0cmlidXRpb24nLCAnZGV2ZWxvcG1lbnQnXS5pbmRleE9mKG9wdHMubW9kZSkgPT0gLTEpXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcignVW5rbm93biBtb2RlJykpO1xuXG4gICAgICAgIHZhciBsaW5lcyA9IHBhcnNlQW5kU3dpdGNoKGRhdGEsIG1haW5fZmlsZSwgb3B0cylcbiAgICAgICAgZnMud3JpdGVGaWxlKGRvY2tlcl9maWxlcGF0aCwgbGluZXMsIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgIERvY2tlcmZpbGVfcGF0aDogZG9ja2VyX2ZpbGVwYXRoLFxuICAgICAgICAgICAgICAgIERvY2tlcmZpbGU6IGxpbmVzLFxuICAgICAgICAgICAgICAgIENNRDogJydcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgIH0pO1xufVxuXG4vKipcbiAqIEdlbmVyYXRlIHNhbXBsZSBEb2NrZXJmaWxlIChsaWIvdGVtcGxhdGVzL0RvY2tlcmZpbGVzKVxuICogQHBhcmFtIHtTdHJpbmd9IGRvY2tlcl9maWxlcGF0aCBEb2NrZXJmaWxlIGFic29sdXRlIHBhdGhcbiAqIEBwYXJhbSB7U3RyaW5nfSBtYWluX2ZpbGUgICAgICAgTWFpbiBmaWxlIHRvIHN0YXJ0IGluIGNvbnRhaW5lclxuICogQHBhcmFtIHtTdHJpbmd9IG1vZGUgICAgICAgICAgICBNb2RlIHRvIHN3aXRjaCB0aGUgRG9ja2VyZmlsZVxuICovXG5mdW5jdGlvbiBnZW5lcmF0ZURvY2tlcmZpbGUoZG9ja2VyX2ZpbGVwYXRoLCBtYWluX2ZpbGUsIG9wdHMpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICB2YXIgdHBsX2ZpbGUgPSBwYXRoLmpvaW4oY3N0LlRFTVBMQVRFX0ZPTERFUiwgY3N0LkRPQ0tFUkZJTEVfTk9ERUpTKTtcbiAgICAgICAgdmFyIHRlbXBsYXRlID0gZnMucmVhZEZpbGVTeW5jKHRwbF9maWxlLCB7IGVuY29kaW5nOiAndXRmOCcgfSk7XG4gICAgICAgIHZhciBDTUQ7XG5cbiAgICAgICAgdGVtcGxhdGUgPSBwYXJzZUFuZFN3aXRjaCh0ZW1wbGF0ZSwgbWFpbl9maWxlLCBvcHRzKTtcblxuICAgICAgICBmcy53cml0ZUZpbGUoZG9ja2VyX2ZpbGVwYXRoLCB0ZW1wbGF0ZSwgZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgRG9ja2VyZmlsZV9wYXRoOiBkb2NrZXJfZmlsZXBhdGgsXG4gICAgICAgICAgICAgICAgRG9ja2VyZmlsZTogdGVtcGxhdGUsXG4gICAgICAgICAgICAgICAgQ01EOiBDTURcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gaGFuZGxlRXhpdChDTEksIG9wdHMsIG1vZGUpIHtcbiAgICBwcm9jZXNzLm9uKCdTSUdJTlQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIENMSS5kaXNjb25uZWN0KCk7XG5cbiAgICAgICAgaWYgKG1vZGUgIT0gJ2Rpc3RyaWJ1dGlvbicpXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgZXhlYygnZG9ja2VyIHBzIC1scScsIGZ1bmN0aW9uIChlcnIsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVxdWlyZSgndml6aW9uJykuYW5hbHl6ZSh7IGZvbGRlcjogcHJvY2Vzcy5jd2QoKSB9LCBmdW5jdGlvbiByZWN1cl9wYXRoKGVyciwgbWV0YSkge1xuICAgICAgICAgICAgICAgIGlmICghZXJyICYmIG1ldGEucmV2aXNpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbW1pdF9pZCA9IHV0aWwuZm9ybWF0KCcjJXMoJXMpICVzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGEuYnJhbmNoLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0YS5yZXZpc2lvbi5zbGljZSgwLCA1KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGEuY29tbWVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsuYm9sZC5tYWdlbnRhKCckIGRvY2tlciBjb21taXQgLW0gXCIlc1wiICVzICVzJyksXG4gICAgICAgICAgICAgICAgICAgICAgICBjb21taXRfaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQucmVwbGFjZSgnXFxuJywgJycpLFxuICAgICAgICAgICAgICAgICAgICAgICAgb3B0cy5pbWFnZU5hbWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQubWFnZW50YSgnJCBkb2NrZXIgY29tbWl0ICVzICVzJyksIHN0ZG91dC5yZXBsYWNlKCdcXG4nLCAnJyksIG9wdHMuaW1hZ2VOYW1lKTtcblxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQubWFnZW50YSgnJCBkb2NrZXIgcHVzaCAlcycpLCBvcHRzLmltYWdlTmFtZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChDTEkpIHtcbiAgICBDTEkucHJvdG90eXBlLmdlbmVyYXRlRG9ja2VyZmlsZSA9IGZ1bmN0aW9uIChzY3JpcHQsIG9wdHMpIHtcbiAgICAgICAgdmFyIGRvY2tlcl9maWxlcGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAnRG9ja2VyZmlsZScpO1xuICAgICAgICB2YXIgdGhhdCA9IHRoaXM7XG5cbiAgICAgICAgZnMuc3RhdChkb2NrZXJfZmlsZXBhdGgsIGZ1bmN0aW9uIChlcnIsIHN0YXQpIHtcbiAgICAgICAgICAgIGlmIChlcnIgfHwgb3B0cy5mb3JjZSA9PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgZ2VuZXJhdGVEb2NrZXJmaWxlKGRvY2tlcl9maWxlcGF0aCwgc2NyaXB0LCB7XG4gICAgICAgICAgICAgICAgICAgIG1vZGU6ICdkZXZlbG9wbWVudCdcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkKCdOZXcgRG9ja2VyZmlsZSBnZW5lcmF0ZWQgaW4gY3VycmVudCBmb2xkZXInKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkKCdZb3UgY2FuIG5vdyBydW5cXG4kIHBtMiBkb2NrZXI6ZGV2IDxmaWxlfGNvbmZpZz4nKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5leGl0Q2xpKGNzdC5TVUNDRVNTX0VYSVQpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5yZWQuYm9sZCgnRG9ja2VyZmlsZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGlzIGZvbGRlciwgdXNlIC0tZm9yY2UgaWYgeW91IHdhbnQgdG8gcmVwbGFjZSBpdCcpKTtcbiAgICAgICAgICAgIHRoYXQuZXhpdENsaShjc3QuRVJST1JfRVhJVCk7XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBDTEkucHJvdG90eXBlLmRvY2tlck1vZGUgPSBmdW5jdGlvbiAoc2NyaXB0LCBvcHRzLCBtb2RlKSB7XG4gICAgICAgIHZhciBwcm9tcHRseSA9IHJlcXVpcmUoJ3Byb21wdGx5Jyk7XG4gICAgICAgIHZhciBzZWxmID0gdGhpcztcbiAgICAgICAgaGFuZGxlRXhpdChzZWxmLCBvcHRzLCBtb2RlKTtcblxuICAgICAgICBpZiAobW9kZSA9PSAnZGlzdHJpYnV0aW9uJyAmJiAhb3B0cy5pbWFnZU5hbWUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoY2hhbGsuYm9sZC5yZWQoJy0taW1hZ2UtbmFtZSBbbmFtZV0gb3B0aW9uIGlzIG1pc3NpbmcnKSk7XG4gICAgICAgICAgICByZXR1cm4gc2VsZi5leGl0Q2xpKGNzdC5FUlJPUl9FWElUKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciB0ZW1wbGF0ZTtcbiAgICAgICAgdmFyIGFwcF9wYXRoLCBtYWluX3NjcmlwdDtcbiAgICAgICAgdmFyIGltYWdlX25hbWU7XG4gICAgICAgIHZhciBub2RlX3ZlcnNpb24gPSBvcHRzLm5vZGVWZXJzaW9uID8gb3B0cy5ub2RlVmVyc2lvbi5zcGxpdCgnLicpWzBdIDogJ2xhdGVzdCc7XG5cbiAgICAgICAgaW1hZ2VfbmFtZSA9IG9wdHMuaW1hZ2VOYW1lIHx8IHJlcXVpcmUoJ2NyeXB0bycpLnJhbmRvbUJ5dGVzKDYpLnRvU3RyaW5nKCdoZXgnKTtcblxuICAgICAgICBpZiAoc2NyaXB0LmluZGV4T2YoJy8nKSA+IC0xKSB7XG4gICAgICAgICAgICBhcHBfcGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBwYXRoLmRpcm5hbWUoc2NyaXB0KSk7XG4gICAgICAgICAgICBtYWluX3NjcmlwdCA9IHBhdGguYmFzZW5hbWUoc2NyaXB0KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGFwcF9wYXRoID0gcHJvY2Vzcy5jd2QoKTtcbiAgICAgICAgICAgIG1haW5fc2NyaXB0ID0gc2NyaXB0O1xuICAgICAgICB9XG5cbiAgICAgICAgY2hlY2tEb2NrZXJTZXR1cCgpXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgICAgICAgICAgICAgIC8vIEdlbmVyYXRlIERvY2tlcmZpbGUgLy9cbiAgICAgICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRvY2tlcl9maWxlcGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAnRG9ja2VyZmlsZScpO1xuXG4gICAgICAgICAgICAgICAgICAgIGZzLnN0YXQoZG9ja2VyX2ZpbGVwYXRoLCBmdW5jdGlvbiAoZXJyLCBzdGF0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG9ja2VyZmlsZSBkb2VzIG5vdCBleGlzdCwgZ2VuZXJhdGUgb25lXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coY2hhbGsuYmx1ZS5ib2xkKCdHZW5lcmF0aW5nIG5ldyBEb2NrZXJmaWxlJykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLmZvcmNlID09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoZ2VuZXJhdGVEb2NrZXJmaWxlKGRvY2tlcl9maWxlcGF0aCwgbWFpbl9zY3JpcHQsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVfdmVyc2lvbjogbm9kZV92ZXJzaW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZTogbW9kZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLmRvY2tlcmRhZW1vbilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoZ2VuZXJhdGVEb2NrZXJmaWxlKGRvY2tlcl9maWxlcGF0aCwgbWFpbl9zY3JpcHQsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVfdmVyc2lvbjogbm9kZV92ZXJzaW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZTogbW9kZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbXB0bHkucHJvbXB0KCdObyBEb2NrZXJmaWxlIGluIGN1cnJlbnQgZGlyZWN0b3J5LCBvayB0byBnZW5lcmF0ZSBhIG5ldyBvbmU/ICh5L24pJywgZnVuY3Rpb24gKGVyciwgdmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09ICd5JylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKGdlbmVyYXRlRG9ja2VyZmlsZShkb2NrZXJfZmlsZXBhdGgsIG1haW5fc2NyaXB0LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZV92ZXJzaW9uOiBub2RlX3ZlcnNpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZTogbW9kZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5leGl0Q2xpKGNzdC5TVUNDRVNTX0VYSVQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHN3aXRjaERvY2tlckZpbGUoZG9ja2VyX2ZpbGVwYXRoLCBtYWluX3NjcmlwdCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVfdmVyc2lvbjogbm9kZV92ZXJzaW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGU6IG1vZGVcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKF90ZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gX3RlbXBsYXRlO1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgICAgICAgICAgICAgLy8gRG9ja2VyIGJ1aWxkIC8vXG4gICAgICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAgICAgICAgICAgICB2YXIgZG9ja2VyX2J1aWxkID0gdXRpbC5mb3JtYXQoJ2RvY2tlciBidWlsZCAtdCAlcyAtZiAlcycsXG4gICAgICAgICAgICAgICAgICAgIGltYWdlX25hbWUsXG4gICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLkRvY2tlcmZpbGVfcGF0aCk7XG5cbiAgICAgICAgICAgICAgICBpZiAob3B0cy5mcmVzaCA9PSB0cnVlKVxuICAgICAgICAgICAgICAgICAgICBkb2NrZXJfYnVpbGQgKz0gJyAtLW5vLWNhY2hlJztcbiAgICAgICAgICAgICAgICBkb2NrZXJfYnVpbGQgKz0gJyAuJztcblxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCk7XG4gICAgICAgICAgICAgICAgZm10LnNlcCgpO1xuICAgICAgICAgICAgICAgIGZtdC50aXRsZSgnQnVpbGRpbmcgQm9vdCBTeXN0ZW0nKTtcbiAgICAgICAgICAgICAgICBmbXQuZmllbGQoJ1R5cGUnLCBjaGFsay5jeWFuLmJvbGQoJ0RvY2tlcicpKTtcbiAgICAgICAgICAgICAgICBmbXQuZmllbGQoJ01vZGUnLCBtb2RlKTtcbiAgICAgICAgICAgICAgICBmbXQuZmllbGQoJ0ltYWdlIG5hbWUnLCBpbWFnZV9uYW1lKTtcbiAgICAgICAgICAgICAgICBmbXQuZmllbGQoJ0RvY2tlciBidWlsZCBjb21tYW5kJywgZG9ja2VyX2J1aWxkKTtcbiAgICAgICAgICAgICAgICBmbXQuZmllbGQoJ0RvY2tlcmZpbGUgcGF0aCcsIHRlbXBsYXRlLkRvY2tlcmZpbGVfcGF0aCk7XG4gICAgICAgICAgICAgICAgZm10LnNlcCgpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHBzcGF3bihkb2NrZXJfYnVpbGQpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vXG4gICAgICAgICAgICAgICAgLy8gRG9ja2VyIHJ1biAvL1xuICAgICAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy9cblxuICAgICAgICAgICAgICAgIHZhciBkb2NrZXJfcnVuID0gJ2RvY2tlciBydW4gLS1uZXQgaG9zdCc7XG5cbiAgICAgICAgICAgICAgICBpZiAob3B0cy5kb2NrZXJkYWVtb24gPT0gdHJ1ZSlcbiAgICAgICAgICAgICAgICAgICAgZG9ja2VyX3J1biArPSAnIC1kJztcbiAgICAgICAgICAgICAgICBpZiAobW9kZSAhPSAnZGlzdHJpYnV0aW9uJylcbiAgICAgICAgICAgICAgICAgICAgZG9ja2VyX3J1biArPSB1dGlsLmZvcm1hdCgnIC12ICVzOi92YXIvYXBwIC12IC92YXIvYXBwL25vZGVfbW9kdWxlcycsIGFwcF9wYXRoKTtcbiAgICAgICAgICAgICAgICBkb2NrZXJfcnVuICs9ICcgJyArIGltYWdlX25hbWU7XG4gICAgICAgICAgICAgICAgdmFyIGRvY2tlcmZpbGVfcGFyc2VkID0gdGVtcGxhdGUuRG9ja2VyZmlsZS5zcGxpdCgnXFxuJyk7XG4gICAgICAgICAgICAgICAgdmFyIGJhc2VfaW1hZ2UgPSBkb2NrZXJmaWxlX3BhcnNlZFswXTtcbiAgICAgICAgICAgICAgICB2YXIgcnVuX2NtZCA9IGRvY2tlcmZpbGVfcGFyc2VkW2RvY2tlcmZpbGVfcGFyc2VkLmxlbmd0aCAtIDFdO1xuXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgICAgICAgICBmbXQuc2VwKCk7XG4gICAgICAgICAgICAgICAgZm10LnRpdGxlKCdCb290aW5nJyk7XG4gICAgICAgICAgICAgICAgZm10LmZpZWxkKCdUeXBlJywgY2hhbGsuY3lhbi5ib2xkKCdEb2NrZXInKSk7XG4gICAgICAgICAgICAgICAgZm10LmZpZWxkKCdNb2RlJywgbW9kZSk7XG4gICAgICAgICAgICAgICAgZm10LmZpZWxkKCdCYXNlIEltYWdlJywgYmFzZV9pbWFnZSk7XG4gICAgICAgICAgICAgICAgZm10LmZpZWxkKCdJbWFnZSBOYW1lJywgaW1hZ2VfbmFtZSk7XG4gICAgICAgICAgICAgICAgZm10LmZpZWxkKCdEb2NrZXIgQ29tbWFuZCcsIGRvY2tlcl9ydW4pO1xuICAgICAgICAgICAgICAgIGZtdC5maWVsZCgnUlVOIENvbW1hbmQnLCBydW5fY21kKTtcbiAgICAgICAgICAgICAgICBmbXQuZmllbGQoJ0NXRCcsIGFwcF9wYXRoKTtcbiAgICAgICAgICAgICAgICBmbXQuc2VwKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHBzcGF3bihkb2NrZXJfcnVuKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbGsuYmx1ZS5ib2xkKCc+Pj4gTGVhdmluZyBEb2NrZXIgaW5zdGFuY2UgdXVpZD0lcycpLCBpbWFnZV9uYW1lKTtcbiAgICAgICAgICAgICAgICBzZWxmLmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZXkoJ1JhdyBlcnJvcj0nLCBlcnIubWVzc2FnZSkpO1xuICAgICAgICAgICAgICAgIHNlbGYuZGlzY29ubmVjdCgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICB9O1xuXG59O1xuXG5leHBvcnQge1xuICAgIGdlbmVyYXRlRG9ja2VyZmlsZSxcbiAgICBwYXJzZUFuZFN3aXRjaCxcbiAgICBzd2l0Y2hEb2NrZXJGaWxlLFxufVxuIl19
"use strict";

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _constants = _interopRequireDefault(require("../constants"));

var _Utility = _interopRequireDefault(require("./Utility"));

var _ProcessUtils = _interopRequireDefault(require("./ProcessUtils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

// Load all env-vars from master.
var pm2_env = JSON.parse(process.env.pm2_env);

for (var k in pm2_env) {
  process.env[k] = pm2_env[k];
} // Rename process


process.title = process.env.PROCESS_TITLE || 'node ' + pm2_env.pm_exec_path;
delete process.env.pm2_env;
/**
 * Main entrance to wrap the desired code
 */

(function ProcessContainer() {
  _ProcessUtils["default"].injectModules();

  var stdFile = pm2_env.pm_log_path;
  var outFile = pm2_env.pm_out_log_path;
  var errFile = pm2_env.pm_err_log_path;
  var pidFile = pm2_env.pm_pid_path;
  var script = pm2_env.pm_exec_path;
  var original_send = process.send;

  if (typeof process.env.source_map_support != 'undefined' && process.env.source_map_support !== 'false') {
    require('source-map-support').install();
  }

  process.send = function (message) {
    if (process.connected) return original_send.apply(this, arguments);
  }; //send node version


  if (process.versions && process.versions.node) {
    process.send({
      'node_version': process.versions.node
    });
  }

  if (_constants["default"].MODIFY_REQUIRE) require.main.filename = pm2_env.pm_exec_path; // Resets global paths for require()

  require('module')._initPaths();

  try {
    var pid = process.pid;
    if (typeof pid !== 'undefined') _fs["default"].writeFileSync(pidFile, process.pid.toString());
  } catch (e) {
    console.error(e.stack || e);
  } // Add args to process if args specified on start


  if (process.env.args != null) process.argv = process.argv.concat(pm2_env.args); // stdio, including: out, err and entire (both out and err if necessary).

  var stds = {
    out: outFile,
    err: errFile
  };
  stdFile && (stds.std = stdFile); // uid/gid management

  if (pm2_env.uid || pm2_env.gid) {
    try {
      if (process.env.gid) process.setgid(pm2_env.gid);
      if (pm2_env.uid) process.setuid(pm2_env.uid);
    } catch (e) {
      setTimeout(function () {
        console.error('%s on call %s', e.message, e.syscall);
        console.error('%s is not accessible', pm2_env.uid);
        return process.exit(1);
      }, 100);
    }
  }

  exec(script, stds);
})();
/**
 * Description
 * @method exec
 * @param {} script
 * @param {} stds
 * @return
 */


function exec(script, stds) {
  if (_path["default"].extname(script) == '.coffee') {
    try {
      require('coffee-script/register');
    } catch (e) {
      console.error('Failed to load CoffeeScript interpreter:', e.message || e);
    }
  }

  if (_path["default"].extname(script) == '.ls') {
    try {
      require('livescript');
    } catch (e) {
      console.error('Failed to load LiveScript interpreter:', e.message || e);
    }
  }

  if (_path["default"].extname(script) == '.ts' || _path["default"].extname(script) == '.tsx') {
    try {
      require('ts-node/register');
    } catch (e) {
      console.error('Failed to load Typescript interpreter:', e.message || e);
    }
  }

  process.on('message', function (msg) {
    if (msg.type === 'log:reload') {
      for (var k in stds) {
        if (_typeof(stds[k]) == 'object' && !isNaN(stds[k].fd)) {
          if (stds[k].destroy) stds[k].destroy();else if (stds[k].end) stds[k].end();else if (stds[k].close) stds[k].close();
          stds[k] = stds[k]._file;
        }
      }

      _Utility["default"].startLogging(stds, function (err) {
        if (err) return console.error('Failed to reload logs:', err.stack);
        console.log('Reloading log...');
      });
    }
  });
  var dayjs = null;
  if (pm2_env.log_date_format) _Utility["default"].startLogging(stds, function (err) {
    if (err) {
      process.send({
        type: 'process:exception',
        data: {
          message: err.message,
          syscall: 'ProcessContainer.startLogging'
        }
      });
      throw err;
      return;
    }

    process.stderr.write = function (write) {
      return function (string, cb) {
        var log_data = null; // Disable logs if specified

        if (pm2_env.disable_logs === true) {
          return cb ? cb() : false;
        }

        if (pm2_env.log_type && pm2_env.log_type === 'json') {
          log_data = JSON.stringify({
            message: string.toString(),
            timestamp: pm2_env.log_date_format && dayjs ? dayjs().format(pm2_env.log_date_format) : new Date().toISOString(),
            type: 'err',
            process_id: pm2_env.pm_id,
            app_name: pm2_env.name
          }) + '\n';
        } else if (pm2_env.log_date_format && dayjs) log_data = "".concat(dayjs().format(pm2_env.log_date_format), ": ").concat(string.toString());else log_data = string.toString();

        process.send({
          type: 'log:err',
          topic: 'log:err',
          data: log_data
        });
        if (_Utility["default"].checkPathIsNull(pm2_env.pm_err_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) return cb ? cb() : false; // TODO: please check this

        var encoding = "";
        stds.std && stds.std.write && stds.std.write(log_data, encoding);
        stds.err && stds.err.write && stds.err.write(log_data, encoding, cb);
      };
    }(process.stderr.write);

    process.stdout.write = function (write) {
      return function (string, cb) {
        var log_data = null; // Disable logs if specified

        if (pm2_env.disable_logs === true) {
          return cb ? cb() : false;
        }

        if (pm2_env.log_type && pm2_env.log_type === 'json') {
          log_data = JSON.stringify({
            message: string.toString(),
            timestamp: pm2_env.log_date_format && dayjs ? dayjs().format(pm2_env.log_date_format) : new Date().toISOString(),
            type: 'out',
            process_id: pm2_env.pm_id,
            app_name: pm2_env.name
          }) + '\n';
        } else if (pm2_env.log_date_format && dayjs) log_data = "".concat(dayjs().format(pm2_env.log_date_format), ": ").concat(string.toString());else log_data = string.toString();

        process.send({
          type: 'log:out',
          data: log_data
        });
        if (_Utility["default"].checkPathIsNull(pm2_env.pm_out_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) return cb ? cb() : null; // TODO: please check this

        var encoding = "";
        stds.std && stds.std.write && stds.std.write(log_data, encoding);
        stds.out && stds.out.write && stds.out.write(log_data, encoding, cb);
      };
    }(process.stdout.write);

    function getUncaughtExceptionListener(listener) {
      return function uncaughtListener(err) {
        var error = err && err.stack ? err.stack : err;

        if (listener === 'unhandledRejection') {
          error = 'You have triggered an unhandledRejection, you may have forgotten to catch a Promise rejection:\n' + error;
        }

        logError(['std', 'err'], error); // Notify master that an uncaughtException has been catched

        try {
          if (err) {
            var errObj = {};
            Object.getOwnPropertyNames(err).forEach(function (key) {
              errObj[key] = err[key];
            });
          }

          process.send({
            type: 'log:err',
            topic: 'log:err',
            data: '\n' + error + '\n'
          });
          process.send({
            type: 'process:exception',
            data: errObj !== undefined ? errObj : {
              message: 'No error but ' + listener + ' was caught!'
            }
          });
        } catch (e) {
          logError(['std', 'err'], 'Channel is already closed can\'t broadcast error:\n' + e.stack);
        }

        if (!process.listeners(listener).filter(function (listener) {
          return listener !== uncaughtListener;
        }).length) {
          if (listener == 'uncaughtException') {
            process.emit('disconnect');
            process.exit(_constants["default"].CODE_UNCAUGHTEXCEPTION);
          }
        }
      };
    }

    process.on('uncaughtException', getUncaughtExceptionListener('uncaughtException'));
    process.on('unhandledRejection', getUncaughtExceptionListener('unhandledRejection')); // Change dir to fix process.cwd

    process.chdir(pm2_env.pm_cwd || process.env.PWD || _path["default"].dirname(script));
    if (_ProcessUtils["default"].isESModule(script) === true) Promise.resolve("".concat(process.env.pm_exec_path)).then(function (s) {
      return _interopRequireWildcard(require(s));
    });else require('module')._load(script, null, true);

    function logError(types, error) {
      try {
        types.forEach(function (type) {
          stds[type] && typeof stds[type].write == 'function' && stds[type].write(error + '\n');
        });
      } catch (e) {}
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Qcm9jZXNzQ29udGFpbmVyLnRzIl0sIm5hbWVzIjpbInBtMl9lbnYiLCJKU09OIiwicGFyc2UiLCJwcm9jZXNzIiwiZW52IiwiayIsInRpdGxlIiwiUFJPQ0VTU19USVRMRSIsInBtX2V4ZWNfcGF0aCIsIlByb2Nlc3NDb250YWluZXIiLCJQcm9jZXNzVXRpbHMiLCJpbmplY3RNb2R1bGVzIiwic3RkRmlsZSIsInBtX2xvZ19wYXRoIiwib3V0RmlsZSIsInBtX291dF9sb2dfcGF0aCIsImVyckZpbGUiLCJwbV9lcnJfbG9nX3BhdGgiLCJwaWRGaWxlIiwicG1fcGlkX3BhdGgiLCJzY3JpcHQiLCJvcmlnaW5hbF9zZW5kIiwic2VuZCIsInNvdXJjZV9tYXBfc3VwcG9ydCIsInJlcXVpcmUiLCJpbnN0YWxsIiwibWVzc2FnZSIsImNvbm5lY3RlZCIsImFwcGx5IiwiYXJndW1lbnRzIiwidmVyc2lvbnMiLCJub2RlIiwiY3N0IiwiTU9ESUZZX1JFUVVJUkUiLCJtYWluIiwiZmlsZW5hbWUiLCJfaW5pdFBhdGhzIiwicGlkIiwiZnMiLCJ3cml0ZUZpbGVTeW5jIiwidG9TdHJpbmciLCJlIiwiY29uc29sZSIsImVycm9yIiwic3RhY2siLCJhcmdzIiwiYXJndiIsImNvbmNhdCIsInN0ZHMiLCJvdXQiLCJlcnIiLCJzdGQiLCJ1aWQiLCJnaWQiLCJzZXRnaWQiLCJzZXR1aWQiLCJzZXRUaW1lb3V0Iiwic3lzY2FsbCIsImV4aXQiLCJleGVjIiwicCIsImV4dG5hbWUiLCJvbiIsIm1zZyIsInR5cGUiLCJpc05hTiIsImZkIiwiZGVzdHJveSIsImVuZCIsImNsb3NlIiwiX2ZpbGUiLCJVdGlsaXR5Iiwic3RhcnRMb2dnaW5nIiwibG9nIiwiZGF5anMiLCJsb2dfZGF0ZV9mb3JtYXQiLCJkYXRhIiwic3RkZXJyIiwid3JpdGUiLCJzdHJpbmciLCJjYiIsImxvZ19kYXRhIiwiZGlzYWJsZV9sb2dzIiwibG9nX3R5cGUiLCJzdHJpbmdpZnkiLCJ0aW1lc3RhbXAiLCJmb3JtYXQiLCJEYXRlIiwidG9JU09TdHJpbmciLCJwcm9jZXNzX2lkIiwicG1faWQiLCJhcHBfbmFtZSIsIm5hbWUiLCJ0b3BpYyIsImNoZWNrUGF0aElzTnVsbCIsImVuY29kaW5nIiwic3Rkb3V0IiwiZ2V0VW5jYXVnaHRFeGNlcHRpb25MaXN0ZW5lciIsImxpc3RlbmVyIiwidW5jYXVnaHRMaXN0ZW5lciIsImxvZ0Vycm9yIiwiZXJyT2JqIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsImZvckVhY2giLCJrZXkiLCJ1bmRlZmluZWQiLCJsaXN0ZW5lcnMiLCJmaWx0ZXIiLCJsZW5ndGgiLCJlbWl0IiwiQ09ERV9VTkNBVUdIVEVYQ0VQVElPTiIsImNoZGlyIiwicG1fY3dkIiwiUFdEIiwiZGlybmFtZSIsImlzRVNNb2R1bGUiLCJfbG9hZCIsInR5cGVzIl0sIm1hcHBpbmdzIjoiOztBQVdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7O0FBR0E7QUFDQSxJQUFJQSxPQUFPLEdBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUosT0FBdkIsQ0FBZDs7QUFDQSxLQUFLLElBQUlLLENBQVQsSUFBY0wsT0FBZCxFQUF1QjtBQUNyQkcsRUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlDLENBQVosSUFBaUJMLE9BQU8sQ0FBQ0ssQ0FBRCxDQUF4QjtBQUNELEMsQ0FFRDs7O0FBQ0FGLE9BQU8sQ0FBQ0csS0FBUixHQUFnQkgsT0FBTyxDQUFDQyxHQUFSLENBQVlHLGFBQVosSUFBNkIsVUFBVVAsT0FBTyxDQUFDUSxZQUEvRDtBQUVBLE9BQU9MLE9BQU8sQ0FBQ0MsR0FBUixDQUFZSixPQUFuQjtBQUVBOzs7O0FBR0EsQ0FBQyxTQUFTUyxnQkFBVCxHQUE0QjtBQUUzQkMsMkJBQWFDLGFBQWI7O0FBRUEsTUFBSUMsT0FBTyxHQUFHWixPQUFPLENBQUNhLFdBQXRCO0FBQ0EsTUFBSUMsT0FBTyxHQUFHZCxPQUFPLENBQUNlLGVBQXRCO0FB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V2MsS0FBWCxDQUFpQm5DLEtBQUssR0FBRyxJQUF6QixDQUF2RDtBQUNELFNBRkQ7QUFHRCxPQUpELENBSUUsT0FBT0YsQ0FBUCxFQUFVLENBQUc7QUFDaEI7QUFDRixHQTVKRDtBQTZKRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMTMgdGhlIFBNMiBwcm9qZWN0IGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIGxpY2Vuc2UgdGhhdFxuICogY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuXG4gKlxuICogVGhpcyBmaWxlIHdyYXAgdGFyZ2V0IGFwcGxpY2F0aW9uXG4gKiAtIHJlZGlyZWN0IHN0ZGluLCBzdGRlcnIgdG8gYnVzICsgbG9nIGZpbGVzXG4gKiAtIHJlbmFtZSBwcm9jZXNzXG4gKiAtIHBpZFxuICovXG5cbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcCBmcm9tICdwYXRoJztcbmltcG9ydCBjc3QgZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCBVdGlsaXR5IGZyb20gJy4vVXRpbGl0eSc7XG5pbXBvcnQgUHJvY2Vzc1V0aWxzIGZyb20gJy4vUHJvY2Vzc1V0aWxzJztcbmltcG9ydCBkYXlqcyBmcm9tICdkYXlqcyc7XG5cbi8vIExvYWQgYWxsIGVudi12YXJzIGZyb20gbWFzdGVyLlxudmFyIHBtMl9lbnYgPSBKU09OLnBhcnNlKHByb2Nlc3MuZW52LnBtMl9lbnYpO1xuZm9yICh2YXIgayBpbiBwbTJfZW52KSB7XG4gIHByb2Nlc3MuZW52W2tdID0gcG0yX2VudltrXTtcbn1cblxuLy8gUmVuYW1lIHByb2Nlc3NcbnByb2Nlc3MudGl0bGUgPSBwcm9jZXNzLmVudi5QUk9DRVNTX1RJVExFIHx8ICdub2RlICcgKyBwbTJfZW52LnBtX2V4ZWNfcGF0aDtcblxuZGVsZXRlIHByb2Nlc3MuZW52LnBtMl9lbnY7XG5cbi8qKlxuICogTWFpbiBlbnRyYW5jZSB0byB3cmFwIHRoZSBkZXNpcmVkIGNvZGVcbiAqL1xuKGZ1bmN0aW9uIFByb2Nlc3NDb250YWluZXIoKSB7XG5cbiAgUHJvY2Vzc1V0aWxzLmluamVjdE1vZHVsZXMoKVxuXG4gIHZhciBzdGRGaWxlID0gcG0yX2Vudi5wbV9sb2dfcGF0aDtcbiAgdmFyIG91dEZpbGUgPSBwbTJfZW52LnBtX291dF9sb2dfcGF0aDtcbiAgdmFyIGVyckZpbGUgPSBwbTJfZW52LnBtX2Vycl9sb2dfcGF0aDtcbiAgdmFyIHBpZEZpbGUgPSBwbTJfZW52LnBtX3BpZF9wYXRoO1xuICB2YXIgc2NyaXB0ID0gcG0yX2Vudi5wbV9leGVjX3BhdGg7XG5cbiAgdmFyIG9yaWdpbmFsX3NlbmQgPSBwcm9jZXNzLnNlbmQ7XG5cbiAgaWYgKHR5cGVvZiAocHJvY2Vzcy5lbnYuc291cmNlX21hcF9zdXBwb3J0KSAhPSAndW5kZWZpbmVkJyAmJlxuICAgIHByb2Nlc3MuZW52LnNvdXJjZV9tYXBfc3VwcG9ydCAhPT0gJ2ZhbHNlJykge1xuICAgIHJlcXVpcmUoJ3NvdXJjZS1tYXAtc3VwcG9ydCcpLmluc3RhbGwoKTtcbiAgfVxuXG4gIHByb2Nlc3Muc2VuZCA9IGZ1bmN0aW9uIChtZXNzYWdlKSB7XG4gICAgaWYgKHByb2Nlc3MuY29ubmVjdGVkKVxuICAgICAgcmV0dXJuIG9yaWdpbmFsX3NlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzIGFzIGFueSk7XG4gIH07XG5cbiAgLy9zZW5kIG5vZGUgdmVyc2lvblxuICBpZiAocHJvY2Vzcy52ZXJzaW9ucyAmJiBwcm9jZXNzLnZlcnNpb25zLm5vZGUpIHtcbiAgICBwcm9jZXNzLnNlbmQoe1xuICAgICAgJ25vZGVfdmVyc2lvbic6IHByb2Nlc3MudmVyc2lvbnMubm9kZVxuICAgIH0pO1xuICB9XG5cbiAgaWYgKGNzdC5NT0RJRllfUkVRVUlSRSlcbiAgICByZXF1aXJlLm1haW4uZmlsZW5hbWUgPSBwbTJfZW52LnBtX2V4ZWNfcGF0aDtcblxuICAvLyBSZXNldHMgZ2xvYmFsIHBhdGhzIGZvciByZXF1aXJlKClcbiAgcmVxdWlyZSgnbW9kdWxlJykuX2luaXRQYXRocygpO1xuXG4gIHRyeSB7XG4gICAgdmFyIHBpZCA9IHByb2Nlc3MucGlkXG4gICAgaWYgKHR5cGVvZiAocGlkKSAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICBmcy53cml0ZUZpbGVTeW5jKHBpZEZpbGUsIHByb2Nlc3MucGlkLnRvU3RyaW5nKCkpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgY29uc29sZS5lcnJvcihlLnN0YWNrIHx8IGUpO1xuICB9XG5cbiAgLy8gQWRkIGFyZ3MgdG8gcHJvY2VzcyBpZiBhcmdzIHNwZWNpZmllZCBvbiBzdGFydFxuICBpZiAocHJvY2Vzcy5lbnYuYXJncyAhPSBudWxsKVxuICAgIHByb2Nlc3MuYXJndiA9IHByb2Nlc3MuYXJndi5jb25jYXQocG0yX2Vudi5hcmdzKTtcblxuICAvLyBzdGRpbywgaW5jbHVkaW5nOiBvdXQsIGVyciBhbmQgZW50aXJlIChib3RoIG91dCBhbmQgZXJyIGlmIG5lY2Vzc2FyeSkuXG4gIHZhciBzdGRzOiBhbnkgPSB7XG4gICAgb3V0OiBvdXRGaWxlLFxuICAgIGVycjogZXJyRmlsZVxuICB9O1xuICBzdGRGaWxlICYmIChzdGRzLnN0ZCA9IHN0ZEZpbGUpO1xuXG4gIC8vIHVpZC9naWQgbWFuYWdlbWVudFxuICBpZiAocG0yX2Vudi51aWQgfHwgcG0yX2Vudi5naWQpIHtcbiAgICB0cnkge1xuICAgICAgaWYgKHByb2Nlc3MuZW52LmdpZClcbiAgICAgICAgcHJvY2Vzcy5zZXRnaWQocG0yX2Vudi5naWQpO1xuICAgICAgaWYgKHBtMl9lbnYudWlkKVxuICAgICAgICBwcm9jZXNzLnNldHVpZChwbTJfZW52LnVpZCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJyVzIG9uIGNhbGwgJXMnLCBlLm1lc3NhZ2UsIGUuc3lzY2FsbCk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJyVzIGlzIG5vdCBhY2Nlc3NpYmxlJywgcG0yX2Vudi51aWQpO1xuICAgICAgICByZXR1cm4gcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgfSwgMTAwKTtcbiAgICB9XG4gIH1cblxuICBleGVjKHNjcmlwdCwgc3Rkcyk7XG59KSgpO1xuXG4vKipcbiAqIERlc2NyaXB0aW9uXG4gKiBAbWV0aG9kIGV4ZWNcbiAqIEBwYXJhbSB7fSBzY3JpcHRcbiAqIEBwYXJhbSB7fSBzdGRzXG4gKiBAcmV0dXJuXG4gKi9cbmZ1bmN0aW9uIGV4ZWMoc2NyaXB0LCBzdGRzKSB7XG4gIGlmIChwLmV4dG5hbWUoc2NyaXB0KSA9PSAnLmNvZmZlZScpIHtcbiAgICB0cnkge1xuICAgICAgcmVxdWlyZSgnY29mZmVlLXNjcmlwdC9yZWdpc3RlcicpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIENvZmZlZVNjcmlwdCBpbnRlcnByZXRlcjonLCBlLm1lc3NhZ2UgfHwgZSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHAuZXh0bmFtZShzY3JpcHQpID09ICcubHMnKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJlcXVpcmUoJ2xpdmVzY3JpcHQnKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBMaXZlU2NyaXB0IGludGVycHJldGVyOicsIGUubWVzc2FnZSB8fCBlKTtcbiAgICB9XG4gIH1cblxuICBpZiAocC5leHRuYW1lKHNjcmlwdCkgPT0gJy50cycgfHwgcC5leHRuYW1lKHNjcmlwdCkgPT0gJy50c3gnKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJlcXVpcmUoJ3RzLW5vZGUvcmVnaXN0ZXInKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBUeXBlc2NyaXB0IGludGVycHJldGVyOicsIGUubWVzc2FnZSB8fCBlKTtcbiAgICB9XG4gIH1cblxuICBwcm9jZXNzLm9uKCdtZXNzYWdlJywgZnVuY3Rpb24gKG1zZykge1xuICAgIGlmIChtc2cudHlwZSA9PT0gJ2xvZzpyZWxvYWQnKSB7XG4gICAgICBmb3IgKHZhciBrIGluIHN0ZHMpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBzdGRzW2tdID09ICdvYmplY3QnICYmICFpc05hTihzdGRzW2tdLmZkKSkge1xuICAgICAgICAgIGlmIChzdGRzW2tdLmRlc3Ryb3kpIHN0ZHNba10uZGVzdHJveSgpO1xuICAgICAgICAgIGVsc2UgaWYgKHN0ZHNba10uZW5kKSBzdGRzW2tdLmVuZCgpO1xuICAgICAgICAgIGVsc2UgaWYgKHN0ZHNba10uY2xvc2UpIHN0ZHNba10uY2xvc2UoKTtcbiAgICAgICAgICBzdGRzW2tdID0gc3Rkc1trXS5fZmlsZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgVXRpbGl0eS5zdGFydExvZ2dpbmcoc3RkcywgZnVuY3Rpb24gKGVycikge1xuICAgICAgICBpZiAoZXJyKVxuICAgICAgICAgIHJldHVybiBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gcmVsb2FkIGxvZ3M6JywgZXJyLnN0YWNrKTtcbiAgICAgICAgY29uc29sZS5sb2coJ1JlbG9hZGluZyBsb2cuLi4nKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgdmFyIGRheWpzID0gbnVsbDtcblxuICBpZiAocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQpXG5cbiAgVXRpbGl0eS5zdGFydExvZ2dpbmcoc3RkcywgZnVuY3Rpb24gKGVycikge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIHByb2Nlc3Muc2VuZCh7XG4gICAgICAgIHR5cGU6ICdwcm9jZXNzOmV4Y2VwdGlvbicsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZSxcbiAgICAgICAgICBzeXNjYWxsOiAnUHJvY2Vzc0NvbnRhaW5lci5zdGFydExvZ2dpbmcnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhyb3cgZXJyO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHByb2Nlc3Muc3RkZXJyLndyaXRlID0gKGZ1bmN0aW9uICh3cml0ZSkge1xuICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzdHJpbmcsIGNiKSB7XG4gICAgICAgIHZhciBsb2dfZGF0YSA9IG51bGw7XG5cbiAgICAgICAgLy8gRGlzYWJsZSBsb2dzIGlmIHNwZWNpZmllZFxuICAgICAgICBpZiAocG0yX2Vudi5kaXNhYmxlX2xvZ3MgPT09IHRydWUpIHtcbiAgICAgICAgICByZXR1cm4gY2IgPyBjYigpIDogZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocG0yX2Vudi5sb2dfdHlwZSAmJiBwbTJfZW52LmxvZ190eXBlID09PSAnanNvbicpIHtcbiAgICAgICAgICBsb2dfZGF0YSA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IHN0cmluZy50b1N0cmluZygpLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCAmJiBkYXlqcyA/XG4gICAgICAgICAgICAgIGRheWpzKCkuZm9ybWF0KHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0KSA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIHR5cGU6ICdlcnInLFxuICAgICAgICAgICAgcHJvY2Vzc19pZDogcG0yX2Vudi5wbV9pZCxcbiAgICAgICAgICAgIGFwcF9uYW1lOiBwbTJfZW52Lm5hbWVcbiAgICAgICAgICB9KSArICdcXG4nO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0ICYmIGRheWpzKVxuICAgICAgICAgIGxvZ19kYXRhID0gYCR7ZGF5anMoKS5mb3JtYXQocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQpfTogJHtzdHJpbmcudG9TdHJpbmcoKX1gO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgbG9nX2RhdGEgPSBzdHJpbmcudG9TdHJpbmcoKTtcblxuICAgICAgICBwcm9jZXNzLnNlbmQoe1xuICAgICAgICAgIHR5cGU6ICdsb2c6ZXJyJyxcbiAgICAgICAgICB0b3BpYzogJ2xvZzplcnInLFxuICAgICAgICAgIGRhdGE6IGxvZ19kYXRhXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChVdGlsaXR5LmNoZWNrUGF0aElzTnVsbChwbTJfZW52LnBtX2Vycl9sb2dfcGF0aCkgJiZcbiAgICAgICAgICAoIXBtMl9lbnYucG1fbG9nX3BhdGggfHwgVXRpbGl0eS5jaGVja1BhdGhJc051bGwocG0yX2Vudi5wbV9sb2dfcGF0aCkpKVxuICAgICAgICAgIHJldHVybiBjYiA/IGNiKCkgOiBmYWxzZTtcblxuICAgICAgICAvLyBUT0RPOiBwbGVhc2UgY2hlY2sgdGhpc1xuICAgICAgICBjb25zdCBlbmNvZGluZyA9IFwiXCI7XG4gICAgICAgIHN0ZHMuc3RkICYmIHN0ZHMuc3RkLndyaXRlICYmIHN0ZHMuc3RkLndyaXRlKGxvZ19kYXRhLCBlbmNvZGluZyk7XG4gICAgICAgIHN0ZHMuZXJyICYmIHN0ZHMuZXJyLndyaXRlICYmIHN0ZHMuZXJyLndyaXRlKGxvZ19kYXRhLCBlbmNvZGluZywgY2IpO1xuICAgICAgfTtcbiAgICB9KShwcm9jZXNzLnN0ZGVyci53cml0ZSk7XG5cbiAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSA9IChmdW5jdGlvbiAod3JpdGUpIHtcbiAgICAgIHJldHVybiBmdW5jdGlvbiAoc3RyaW5nLCBjYikge1xuICAgICAgICB2YXIgbG9nX2RhdGEgPSBudWxsO1xuXG4gICAgICAgIC8vIERpc2FibGUgbG9ncyBpZiBzcGVjaWZpZWRcbiAgICAgICAgaWYgKHBtMl9lbnYuZGlzYWJsZV9sb2dzID09PSB0cnVlKSB7XG4gICAgICAgICAgcmV0dXJuIGNiID8gY2IoKSA6IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBtMl9lbnYubG9nX3R5cGUgJiYgcG0yX2Vudi5sb2dfdHlwZSA9PT0gJ2pzb24nKSB7XG4gICAgICAgICAgbG9nX2RhdGEgPSBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICBtZXNzYWdlOiBzdHJpbmcudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIHRpbWVzdGFtcDogcG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQgJiYgZGF5anMgP1xuICAgICAgICAgICAgICBkYXlqcygpLmZvcm1hdChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCkgOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICB0eXBlOiAnb3V0JyxcbiAgICAgICAgICAgIHByb2Nlc3NfaWQ6IHBtMl9lbnYucG1faWQsXG4gICAgICAgICAgICBhcHBfbmFtZTogcG0yX2Vudi5uYW1lXG4gICAgICAgICAgfSkgKyAnXFxuJztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCAmJiBkYXlqcylcbiAgICAgICAgICBsb2dfZGF0YSA9IGAke2RheWpzKCkuZm9ybWF0KHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0KX06ICR7c3RyaW5nLnRvU3RyaW5nKCl9YDtcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGxvZ19kYXRhID0gc3RyaW5nLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgcHJvY2Vzcy5zZW5kKHtcbiAgICAgICAgICB0eXBlOiAnbG9nOm91dCcsXG4gICAgICAgICAgZGF0YTogbG9nX2RhdGFcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKFV0aWxpdHkuY2hlY2tQYXRoSXNOdWxsKHBtMl9lbnYucG1fb3V0X2xvZ19wYXRoKSAmJlxuICAgICAgICAgICghcG0yX2Vudi5wbV9sb2dfcGF0aCB8fCBVdGlsaXR5LmNoZWNrUGF0aElzTnVsbChwbTJfZW52LnBtX2xvZ19wYXRoKSkpXG4gICAgICAgICAgcmV0dXJuIGNiID8gY2IoKSA6IG51bGw7XG5cbiAgICAgICAgLy8gVE9ETzogcGxlYXNlIGNoZWNrIHRoaXNcbiAgICAgICAgY29uc3QgZW5jb2RpbmcgPSBcIlwiO1xuICAgICAgICBzdGRzLnN0ZCAmJiBzdGRzLnN0ZC53cml0ZSAmJiBzdGRzLnN0ZC53cml0ZShsb2dfZGF0YSwgZW5jb2RpbmcpO1xuICAgICAgICBzdGRzLm91dCAmJiBzdGRzLm91dC53cml0ZSAmJiBzdGRzLm91dC53cml0ZShsb2dfZGF0YSwgZW5jb2RpbmcsIGNiKTtcbiAgICAgIH07XG4gICAgfSkocHJvY2Vzcy5zdGRvdXQud3JpdGUpO1xuXG4gICAgZnVuY3Rpb24gZ2V0VW5jYXVnaHRFeGNlcHRpb25MaXN0ZW5lcihsaXN0ZW5lcikge1xuICAgICAgcmV0dXJuIGZ1bmN0aW9uIHVuY2F1Z2h0TGlzdGVuZXIoZXJyKSB7XG4gICAgICAgIHZhciBlcnJvciA9IGVyciAmJiBlcnIuc3RhY2sgPyBlcnIuc3RhY2sgOiBlcnI7XG5cbiAgICAgICAgaWYgKGxpc3RlbmVyID09PSAndW5oYW5kbGVkUmVqZWN0aW9uJykge1xuICAgICAgICAgIGVycm9yID0gJ1lvdSBoYXZlIHRyaWdnZXJlZCBhbiB1bmhhbmRsZWRSZWplY3Rpb24sIHlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gY2F0Y2ggYSBQcm9taXNlIHJlamVjdGlvbjpcXG4nICsgZXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICBsb2dFcnJvcihbJ3N0ZCcsICdlcnInXSwgZXJyb3IpO1xuXG4gICAgICAgIC8vIE5vdGlmeSBtYXN0ZXIgdGhhdCBhbiB1bmNhdWdodEV4Y2VwdGlvbiBoYXMgYmVlbiBjYXRjaGVkXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgdmFyIGVyck9iaiA9IHt9O1xuXG4gICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhlcnIpLmZvckVhY2goZnVuY3Rpb24gKGtleSkge1xuICAgICAgICAgICAgICBlcnJPYmpba2V5XSA9IGVycltrZXldO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcHJvY2Vzcy5zZW5kKHtcbiAgICAgICAgICAgIHR5cGU6ICdsb2c6ZXJyJyxcbiAgICAgICAgICAgIHRvcGljOiAnbG9nOmVycicsXG4gICAgICAgICAgICBkYXRhOiAnXFxuJyArIGVycm9yICsgJ1xcbidcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwcm9jZXNzLnNlbmQoe1xuICAgICAgICAgICAgdHlwZTogJ3Byb2Nlc3M6ZXhjZXB0aW9uJyxcbiAgICAgICAgICAgIGRhdGE6IGVyck9iaiAhPT0gdW5kZWZpbmVkID8gZXJyT2JqIDogeyBtZXNzYWdlOiAnTm8gZXJyb3IgYnV0ICcgKyBsaXN0ZW5lciArICcgd2FzIGNhdWdodCEnIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIGxvZ0Vycm9yKFsnc3RkJywgJ2VyciddLCAnQ2hhbm5lbCBpcyBhbHJlYWR5IGNsb3NlZCBjYW5cXCd0IGJyb2FkY2FzdCBlcnJvcjpcXG4nICsgZS5zdGFjayk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXByb2Nlc3MubGlzdGVuZXJzKGxpc3RlbmVyKS5maWx0ZXIoZnVuY3Rpb24gKGxpc3RlbmVyKSB7XG4gICAgICAgICAgcmV0dXJuIGxpc3RlbmVyICE9PSB1bmNhdWdodExpc3RlbmVyO1xuICAgICAgICB9KS5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAobGlzdGVuZXIgPT0gJ3VuY2F1Z2h0RXhjZXB0aW9uJykge1xuICAgICAgICAgICAgcHJvY2Vzcy5lbWl0KCdkaXNjb25uZWN0Jyk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoY3N0LkNPREVfVU5DQVVHSFRFWENFUFRJT04pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgZ2V0VW5jYXVnaHRFeGNlcHRpb25MaXN0ZW5lcigndW5jYXVnaHRFeGNlcHRpb24nKSk7XG4gICAgcHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgZ2V0VW5jYXVnaHRFeGNlcHRpb25MaXN0ZW5lcigndW5oYW5kbGVkUmVqZWN0aW9uJykpO1xuXG4gICAgLy8gQ2hhbmdlIGRpciB0byBmaXggcHJvY2Vzcy5jd2RcbiAgICBwcm9jZXNzLmNoZGlyKHBtMl9lbnYucG1fY3dkIHx8IHByb2Nlc3MuZW52LlBXRCB8fCBwLmRpcm5hbWUoc2NyaXB0KSk7XG5cbiAgICBpZiAoUHJvY2Vzc1V0aWxzLmlzRVNNb2R1bGUoc2NyaXB0KSA9PT0gdHJ1ZSlcbiAgICAgIGltcG9ydChwcm9jZXNzLmVudi5wbV9leGVjX3BhdGgpO1xuICAgIGVsc2VcbiAgICAgIHJlcXVpcmUoJ21vZHVsZScpLl9sb2FkKHNjcmlwdCwgbnVsbCwgdHJ1ZSk7XG5cbiAgICBmdW5jdGlvbiBsb2dFcnJvcih0eXBlcywgZXJyb3IpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHR5cGVzLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHtcbiAgICAgICAgICBzdGRzW3R5cGVdICYmIHR5cGVvZiBzdGRzW3R5cGVdLndyaXRlID09ICdmdW5jdGlvbicgJiYgc3Rkc1t0eXBlXS53cml0ZShlcnJvciArICdcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlKSB7IH1cbiAgICB9XG4gIH0pO1xufVxuIl19
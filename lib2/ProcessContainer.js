"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard2 = _interopRequireDefault(require("@babel/runtime/helpers/interopRequireWildcard"));

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _constants = _interopRequireDefault(require("../constants"));

var _Utility = _interopRequireDefault(require("./Utility"));

var _ProcessUtils = _interopRequireDefault(require("./ProcessUtils"));

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 *
 * This file wrap target application
 * - redirect stdin, stderr to bus + log files
 * - rename process
 * - pid
 */
// Load all env-vars from master.
var pm2_env = JSON.parse(process.env.pm2_env);

for (var k in pm2_env) {
  process.env[k] = pm2_env[k];
} // Rename process


process.title = process.env.PROCESS_TITLE || 'node ' + pm2_env.pm_exec_path;
delete process.env.pm2_env;
/**
 * Main entrance to wrap the desired code
 */

(function ProcessContainer() {
  _ProcessUtils["default"].injectModules();

  var stdFile = pm2_env.pm_log_path;
  var outFile = pm2_env.pm_out_log_path;
  var errFile = pm2_env.pm_err_log_path;
  var pidFile = pm2_env.pm_pid_path;
  var script = pm2_env.pm_exec_path;
  var original_send = process.send;

  if (typeof process.env.source_map_support != 'undefined' && process.env.source_map_support !== 'false') {
    require('source-map-support').install();
  }

  process.send = function (message) {
    if (process.connected) return original_send.apply(this, arguments);
  }; //send node version


  if (process.versions && process.versions.node) {
    process.send({
      'node_version': process.versions.node
    });
  }

  if (_constants["default"].MODIFY_REQUIRE) require.main.filename = pm2_env.pm_exec_path; // Resets global paths for require()

  require('module')._initPaths();

  try {
    var pid = process.pid;
    if (typeof pid !== 'undefined') _fs["default"].writeFileSync(pidFile, process.pid.toString());
  } catch (e) {
    console.error(e.stack || e);
  } // Add args to process if args specified on start


  if (process.env.args != null) process.argv = process.argv.concat(pm2_env.args); // stdio, including: out, err and entire (both out and err if necessary).

  var stds = {
    out: outFile,
    err: errFile
  };
  stdFile && (stds.std = stdFile); // uid/gid management

  if (pm2_env.uid || pm2_env.gid) {
    try {
      if (process.env.gid) process.setgid(pm2_env.gid);
      if (pm2_env.uid) process.setuid(pm2_env.uid);
    } catch (e) {
      setTimeout(function () {
        console.error('%s on call %s', e.message, e.syscall);
        console.error('%s is not accessible', pm2_env.uid);
        return process.exit(1);
      }, 100);
    }
  }

  exec(script, stds);
})();
/**
 * Description
 * @method exec
 * @param {} script
 * @param {} stds
 * @return
 */


function exec(script, stds) {
  if (_path["default"].extname(script) == '.coffee') {
    try {
      require('coffee-script/register');
    } catch (e) {
      console.error('Failed to load CoffeeScript interpreter:', e.message || e);
    }
  }

  if (_path["default"].extname(script) == '.ls') {
    try {
      require('livescript');
    } catch (e) {
      console.error('Failed to load LiveScript interpreter:', e.message || e);
    }
  }

  if (_path["default"].extname(script) == '.ts' || _path["default"].extname(script) == '.tsx') {
    try {
      require('ts-node/register');
    } catch (e) {
      console.error('Failed to load Typescript interpreter:', e.message || e);
    }
  }

  process.on('message', function (msg) {
    if (msg.type === 'log:reload') {
      for (var k in stds) {
        if ((0, _typeof2["default"])(stds[k]) == 'object' && !isNaN(stds[k].fd)) {
          if (stds[k].destroy) stds[k].destroy();else if (stds[k].end) stds[k].end();else if (stds[k].close) stds[k].close();
          stds[k] = stds[k]._file;
        }
      }

      _Utility["default"].startLogging(stds, function (err) {
        if (err) return console.error('Failed to reload logs:', err.stack);
        console.log('Reloading log...');
      });
    }
  });
  var dayjs = null;
  if (pm2_env.log_date_format) _Utility["default"].startLogging(stds, function (err) {
    if (err) {
      process.send({
        type: 'process:exception',
        data: {
          message: err.message,
          syscall: 'ProcessContainer.startLogging'
        }
      });
      throw err;
      return;
    }

    process.stderr.write = function (write) {
      return function (string, cb) {
        var log_data = null; // Disable logs if specified

        if (pm2_env.disable_logs === true) {
          return cb ? cb() : false;
        }

        if (pm2_env.log_type && pm2_env.log_type === 'json') {
          log_data = JSON.stringify({
            message: string.toString(),
            timestamp: pm2_env.log_date_format && dayjs ? dayjs().format(pm2_env.log_date_format) : new Date().toISOString(),
            type: 'err',
            process_id: pm2_env.pm_id,
            app_name: pm2_env.name
          }) + '\n';
        } else if (pm2_env.log_date_format && dayjs) log_data = "".concat(dayjs().format(pm2_env.log_date_format), ": ").concat(string.toString());else log_data = string.toString();

        process.send({
          type: 'log:err',
          topic: 'log:err',
          data: log_data
        });
        if (_Utility["default"].checkPathIsNull(pm2_env.pm_err_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) return cb ? cb() : false; // TODO: please check this

        var encoding = "";
        stds.std && stds.std.write && stds.std.write(log_data, encoding);
        stds.err && stds.err.write && stds.err.write(log_data, encoding, cb);
      };
    }(process.stderr.write);

    process.stdout.write = function (write) {
      return function (string, cb) {
        var log_data = null; // Disable logs if specified

        if (pm2_env.disable_logs === true) {
          return cb ? cb() : false;
        }

        if (pm2_env.log_type && pm2_env.log_type === 'json') {
          log_data = JSON.stringify({
            message: string.toString(),
            timestamp: pm2_env.log_date_format && dayjs ? dayjs().format(pm2_env.log_date_format) : new Date().toISOString(),
            type: 'out',
            process_id: pm2_env.pm_id,
            app_name: pm2_env.name
          }) + '\n';
        } else if (pm2_env.log_date_format && dayjs) log_data = "".concat(dayjs().format(pm2_env.log_date_format), ": ").concat(string.toString());else log_data = string.toString();

        process.send({
          type: 'log:out',
          data: log_data
        });
        if (_Utility["default"].checkPathIsNull(pm2_env.pm_out_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) return cb ? cb() : null; // TODO: please check this

        var encoding = "";
        stds.std && stds.std.write && stds.std.write(log_data, encoding);
        stds.out && stds.out.write && stds.out.write(log_data, encoding, cb);
      };
    }(process.stdout.write);

    function getUncaughtExceptionListener(listener) {
      return function uncaughtListener(err) {
        var error = err && err.stack ? err.stack : err;

        if (listener === 'unhandledRejection') {
          error = 'You have triggered an unhandledRejection, you may have forgotten to catch a Promise rejection:\n' + error;
        }

        logError(['std', 'err'], error); // Notify master that an uncaughtException has been catched

        try {
          if (err) {
            var errObj = {};
            Object.getOwnPropertyNames(err).forEach(function (key) {
              errObj[key] = err[key];
            });
          }

          process.send({
            type: 'log:err',
            topic: 'log:err',
            data: '\n' + error + '\n'
          });
          process.send({
            type: 'process:exception',
            data: errObj !== undefined ? errObj : {
              message: 'No error but ' + listener + ' was caught!'
            }
          });
        } catch (e) {
          logError(['std', 'err'], 'Channel is already closed can\'t broadcast error:\n' + e.stack);
        }

        if (!process.listeners(listener).filter(function (listener) {
          return listener !== uncaughtListener;
        }).length) {
          if (listener == 'uncaughtException') {
            process.emit('disconnect');
            process.exit(_constants["default"].CODE_UNCAUGHTEXCEPTION);
          }
        }
      };
    }

    process.on('uncaughtException', getUncaughtExceptionListener('uncaughtException'));
    process.on('unhandledRejection', getUncaughtExceptionListener('unhandledRejection')); // Change dir to fix process.cwd

    process.chdir(pm2_env.pm_cwd || process.env.PWD || _path["default"].dirname(script));
    if (_ProcessUtils["default"].isESModule(script) === true) Promise.resolve("".concat(process.env.pm_exec_path)).then(function (s) {
      return (0, _interopRequireWildcard2["default"])(require(s));
    });else require('module')._load(script, null, true);

    function logError(types, error) {
      try {
        types.forEach(function (type) {
          stds[type] && typeof stds[type].write == 'function' && stds[type].write(error + '\n');
        });
      } catch (e) {}
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Qcm9jZXNzQ29udGFpbmVyLnRzIl0sIm5hbWVzIjpbInBtMl9lbnYiLCJKU09OIiwicGFyc2UiLCJwcm9jZXNzIiwiZW52IiwiayIsInRpdGxlIiwiUFJPQ0VTU19USVRMRSIsInBtX2V4ZWNfcGF0aCIsIlByb2Nlc3NDb250YWluZXIiLCJQcm9jZXNzVXRpbHMiLCJpbmplY3RNb2R1bGVzIiwic3RkRmlsZSIsInBtX2xvZ19wYXRoIiwib3V0RmlsZSIsInBtX291dF9sb2dfcGF0aCIsImVyckZpbGUiLCJwbV9lcnJfbG9nX3BhdGgiLCJwaWRGaWxlIiwicG1fcGlkX3BhdGgiLCJzY3JpcHQiLCJvcmlnaW5hbF9zZW5kIiwic2VuZCIsInNvdXJjZV9tYXBfc3VwcG9ydCIsInJlcXVpcmUiLCJpbnN0YWxsIiwibWVzc2FnZSIsImNvbm5lY3RlZCIsImFwcGx5IiwiYXJndW1lbnRzIiwidmVyc2lvbnMiLCJub2RlIiwiY3N0IiwiTU9ESUZZX1JFUVVJUkUiLCJtYWluIiwiZmlsZW5hbWUiLCJfaW5pdFBhdGhzIiwicGlkIiwiZnMiLCJ3cml0ZUZpbGVTeW5jIiwidG9TdHJpbmciLCJlIiwiY29uc29sZSIsImVycm9yIiwic3RhY2siLCJhcmdzIiwiYXJndiIsImNvbmNhdCIsInN0ZHMiLCJvdXQiLCJlcnIiLCJzdGQiLCJ1aWQiLCJnaWQiLCJzZXRnaWQiLCJzZXR1aWQiLCJzZXRUaW1lb3V0Iiwic3lzY2FsbCIsImV4aXQiLCJleGVjIiwicCIsImV4dG5hbWUiLCJvbiIsIm1zZyIsInR5cGUiLCJpc05hTiIsImZkIiwiZGVzdHJveSIsImVuZCIsImNsb3NlIiwiX2ZpbGUiLCJVdGlsaXR5Iiwic3RhcnRMb2dnaW5nIiwibG9nIiwiZGF5anMiLCJsb2dfZGF0ZV9mb3JtYXQiLCJkYXRhIiwic3RkZXJyIiwid3JpdGUiLCJzdHJpbmciLCJjYiIsImxvZ19kYXRhIiwiZGlzYWJsZV9sb2dzIiwibG9nX3R5cGUiLCJzdHJpbmdpZnkiLCJ0aW1lc3RhbXAiLCJmb3JtYXQiLCJEYXRlIiwidG9JU09TdHJpbmciLCJwcm9jZXNzX2lkIiwicG1faWQiLCJhcHBfbmFtZSIsIm5hbWUiLCJ0b3BpYyIsImNoZWNrUGF0aElzTnVsbCIsImVuY29kaW5nIiwic3Rkb3V0IiwiZ2V0VW5jYXVnaHRFeGNlcHRpb25MaXN0ZW5lciIsImxpc3RlbmVyIiwidW5jYXVnaHRMaXN0ZW5lciIsImxvZ0Vycm9yIiwiZXJyT2JqIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsImZvckVhY2giLCJrZXkiLCJ1bmRlZmluZWQiLCJsaXN0ZW5lcnMiLCJmaWx0ZXIiLCJsZW5ndGgiLCJlbWl0IiwiQ09ERV9VTkNBVUdIVEVYQ0VQVElPTiIsImNoZGlyIiwicG1fY3dkIiwiUFdEIiwiZGlybmFtZSIsImlzRVNNb2R1bGUiLCJfbG9hZCIsInR5cGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQVdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQWZBOzs7Ozs7Ozs7O0FBa0JBO0FBQ0EsSUFBSUEsT0FBTyxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0MsT0FBTyxDQUFDQyxHQUFSLENBQVlKLE9BQXZCLENBQWQ7O0FBQ0EsS0FBSyxJQUFJSyxDQUFULElBQWNMLE9BQWQsRUFBdUI7QUFDckJHLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxDQUFaLElBQWlCTCxPQUFPLENBQUNLLENBQUQsQ0FBeEI7QUFDRCxDLENBRUQ7OztBQUNBRixPQUFPLENBQUNHLEtBQVIsR0FBZ0JILE9BQU8sQ0FBQ0MsR0FBUixDQUFZRyxhQUFaLElBQTZCLFVBQVVQLE9BQU8sQ0FBQ1EsWUFBL0Q7QUFFQSxPQUFPTCxPQUFPLENBQUNDLEdBQVIsQ0FBWUosT0FBbkI7QUFFQTs7OztBQUdBLENBQUMsU0FBU1MsZ0JBQVQsR0FBNEI7QUFFM0JDLDJCQUFhQyxhQUFiOztBQUVBLE1BQUlDLE9BQU8sR0FBR1osT0FBTyxDQUFDYSxXQUF0QjtBQUNBLE1BQUlDLE9BQU8sR0FBR2QsT0FBTyxD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LElBQUQsQ0FBSixDQUFXYyxLQUFYLENBQWlCbkMsS0FBSyxHQUFHLElBQXpCLENBQXZEO0FBQ0QsU0FGRDtBQUdELE9BSkQsQ0FJRSxPQUFPRixDQUFQLEVBQVUsQ0FBRztBQUNoQjtBQUNGLEdBNUpEO0FBNkpEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgMjAxMyB0aGUgUE0yIHByb2plY3QgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgbGljZW5zZSB0aGF0XG4gKiBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS5cbiAqXG4gKiBUaGlzIGZpbGUgd3JhcCB0YXJnZXQgYXBwbGljYXRpb25cbiAqIC0gcmVkaXJlY3Qgc3RkaW4sIHN0ZGVyciB0byBidXMgKyBsb2cgZmlsZXNcbiAqIC0gcmVuYW1lIHByb2Nlc3NcbiAqIC0gcGlkXG4gKi9cblxuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGNzdCBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IFV0aWxpdHkgZnJvbSAnLi9VdGlsaXR5JztcbmltcG9ydCBQcm9jZXNzVXRpbHMgZnJvbSAnLi9Qcm9jZXNzVXRpbHMnO1xuaW1wb3J0IGRheWpzIGZyb20gJ2RheWpzJztcblxuLy8gTG9hZCBhbGwgZW52LXZhcnMgZnJvbSBtYXN0ZXIuXG52YXIgcG0yX2VudiA9IEpTT04ucGFyc2UocHJvY2Vzcy5lbnYucG0yX2Vudik7XG5mb3IgKHZhciBrIGluIHBtMl9lbnYpIHtcbiAgcHJvY2Vzcy5lbnZba10gPSBwbTJfZW52W2tdO1xufVxuXG4vLyBSZW5hbWUgcHJvY2Vzc1xucHJvY2Vzcy50aXRsZSA9IHByb2Nlc3MuZW52LlBST0NFU1NfVElUTEUgfHwgJ25vZGUgJyArIHBtMl9lbnYucG1fZXhlY19wYXRoO1xuXG5kZWxldGUgcHJvY2Vzcy5lbnYucG0yX2VudjtcblxuLyoqXG4gKiBNYWluIGVudHJhbmNlIHRvIHdyYXAgdGhlIGRlc2lyZWQgY29kZVxuICovXG4oZnVuY3Rpb24gUHJvY2Vzc0NvbnRhaW5lcigpIHtcblxuICBQcm9jZXNzVXRpbHMuaW5qZWN0TW9kdWxlcygpXG5cbiAgdmFyIHN0ZEZpbGUgPSBwbTJfZW52LnBtX2xvZ19wYXRoO1xuICB2YXIgb3V0RmlsZSA9IHBtMl9lbnYucG1fb3V0X2xvZ19wYXRoO1xuICB2YXIgZXJyRmlsZSA9IHBtMl9lbnYucG1fZXJyX2xvZ19wYXRoO1xuICB2YXIgcGlkRmlsZSA9IHBtMl9lbnYucG1fcGlkX3BhdGg7XG4gIHZhciBzY3JpcHQgPSBwbTJfZW52LnBtX2V4ZWNfcGF0aDtcblxuICB2YXIgb3JpZ2luYWxfc2VuZCA9IHByb2Nlc3Muc2VuZDtcblxuICBpZiAodHlwZW9mIChwcm9jZXNzLmVudi5zb3VyY2VfbWFwX3N1cHBvcnQpICE9ICd1bmRlZmluZWQnICYmXG4gICAgcHJvY2Vzcy5lbnYuc291cmNlX21hcF9zdXBwb3J0ICE9PSAnZmFsc2UnKSB7XG4gICAgcmVxdWlyZSgnc291cmNlLW1hcC1zdXBwb3J0JykuaW5zdGFsbCgpO1xuICB9XG5cbiAgcHJvY2Vzcy5zZW5kID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHtcbiAgICBpZiAocHJvY2Vzcy5jb25uZWN0ZWQpXG4gICAgICByZXR1cm4gb3JpZ2luYWxfc2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMgYXMgYW55KTtcbiAgfTtcblxuICAvL3NlbmQgbm9kZSB2ZXJzaW9uXG4gIGlmIChwcm9jZXNzLnZlcnNpb25zICYmIHByb2Nlc3MudmVyc2lvbnMubm9kZSkge1xuICAgIHByb2Nlc3Muc2VuZCh7XG4gICAgICAnbm9kZV92ZXJzaW9uJzogcHJvY2Vzcy52ZXJzaW9ucy5ub2RlXG4gICAgfSk7XG4gIH1cblxuICBpZiAoY3N0Lk1PRElGWV9SRVFVSVJFKVxuICAgIHJlcXVpcmUubWFpbi5maWxlbmFtZSA9IHBtMl9lbnYucG1fZXhlY19wYXRoO1xuXG4gIC8vIFJlc2V0cyBnbG9iYWwgcGF0aHMgZm9yIHJlcXVpcmUoKVxuICByZXF1aXJlKCdtb2R1bGUnKS5faW5pdFBhdGhzKCk7XG5cbiAgdHJ5IHtcbiAgICB2YXIgcGlkID0gcHJvY2Vzcy5waWRcbiAgICBpZiAodHlwZW9mIChwaWQpICE9PSAndW5kZWZpbmVkJylcbiAgICAgIGZzLndyaXRlRmlsZVN5bmMocGlkRmlsZSwgcHJvY2Vzcy5waWQudG9TdHJpbmcoKSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmVycm9yKGUuc3RhY2sgfHwgZSk7XG4gIH1cblxuICAvLyBBZGQgYXJncyB0byBwcm9jZXNzIGlmIGFyZ3Mgc3BlY2lmaWVkIG9uIHN0YXJ0XG4gIGlmIChwcm9jZXNzLmVudi5hcmdzICE9IG51bGwpXG4gICAgcHJvY2Vzcy5hcmd2ID0gcHJvY2Vzcy5hcmd2LmNvbmNhdChwbTJfZW52LmFyZ3MpO1xuXG4gIC8vIHN0ZGlvLCBpbmNsdWRpbmc6IG91dCwgZXJyIGFuZCBlbnRpcmUgKGJvdGggb3V0IGFuZCBlcnIgaWYgbmVjZXNzYXJ5KS5cbiAgdmFyIHN0ZHM6IGFueSA9IHtcbiAgICBvdXQ6IG91dEZpbGUsXG4gICAgZXJyOiBlcnJGaWxlXG4gIH07XG4gIHN0ZEZpbGUgJiYgKHN0ZHMuc3RkID0gc3RkRmlsZSk7XG5cbiAgLy8gdWlkL2dpZCBtYW5hZ2VtZW50XG4gIGlmIChwbTJfZW52LnVpZCB8fCBwbTJfZW52LmdpZCkge1xuICAgIHRyeSB7XG4gICAgICBpZiAocHJvY2Vzcy5lbnYuZ2lkKVxuICAgICAgICBwcm9jZXNzLnNldGdpZChwbTJfZW52LmdpZCk7XG4gICAgICBpZiAocG0yX2Vudi51aWQpXG4gICAgICAgIHByb2Nlc3Muc2V0dWlkKHBtMl9lbnYudWlkKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignJXMgb24gY2FsbCAlcycsIGUubWVzc2FnZSwgZS5zeXNjYWxsKTtcbiAgICAgICAgY29uc29sZS5lcnJvcignJXMgaXMgbm90IGFjY2Vzc2libGUnLCBwbTJfZW52LnVpZCk7XG4gICAgICAgIHJldHVybiBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICB9LCAxMDApO1xuICAgIH1cbiAgfVxuXG4gIGV4ZWMoc2NyaXB0LCBzdGRzKTtcbn0pKCk7XG5cbi8qKlxuICogRGVzY3JpcHRpb25cbiAqIEBtZXRob2QgZXhlY1xuICogQHBhcmFtIHt9IHNjcmlwdFxuICogQHBhcmFtIHt9IHN0ZHNcbiAqIEByZXR1cm5cbiAqL1xuZnVuY3Rpb24gZXhlYyhzY3JpcHQsIHN0ZHMpIHtcbiAgaWYgKHAuZXh0bmFtZShzY3JpcHQpID09ICcuY29mZmVlJykge1xuICAgIHRyeSB7XG4gICAgICByZXF1aXJlKCdjb2ZmZWUtc2NyaXB0L3JlZ2lzdGVyJyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGxvYWQgQ29mZmVlU2NyaXB0IGludGVycHJldGVyOicsIGUubWVzc2FnZSB8fCBlKTtcbiAgICB9XG4gIH1cblxuICBpZiAocC5leHRuYW1lKHNjcmlwdCkgPT0gJy5scycpIHtcbiAgICB0cnkge1xuICAgICAgcmVxdWlyZSgnbGl2ZXNjcmlwdCcpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIExpdmVTY3JpcHQgaW50ZXJwcmV0ZXI6JywgZS5tZXNzYWdlIHx8IGUpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChwLmV4dG5hbWUoc2NyaXB0KSA9PSAnLnRzJyB8fCBwLmV4dG5hbWUoc2NyaXB0KSA9PSAnLnRzeCcpIHtcbiAgICB0cnkge1xuICAgICAgcmVxdWlyZSgndHMtbm9kZS9yZWdpc3RlcicpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIFR5cGVzY3JpcHQgaW50ZXJwcmV0ZXI6JywgZS5tZXNzYWdlIHx8IGUpO1xuICAgIH1cbiAgfVxuXG4gIHByb2Nlc3Mub24oJ21lc3NhZ2UnLCBmdW5jdGlvbiAobXNnKSB7XG4gICAgaWYgKG1zZy50eXBlID09PSAnbG9nOnJlbG9hZCcpIHtcbiAgICAgIGZvciAodmFyIGsgaW4gc3Rkcykge1xuICAgICAgICBpZiAodHlwZW9mIHN0ZHNba10gPT0gJ29iamVjdCcgJiYgIWlzTmFOKHN0ZHNba10uZmQpKSB7XG4gICAgICAgICAgaWYgKHN0ZHNba10uZGVzdHJveSkgc3Rkc1trXS5kZXN0cm95KCk7XG4gICAgICAgICAgZWxzZSBpZiAoc3Rkc1trXS5lbmQpIHN0ZHNba10uZW5kKCk7XG4gICAgICAgICAgZWxzZSBpZiAoc3Rkc1trXS5jbG9zZSkgc3Rkc1trXS5jbG9zZSgpO1xuICAgICAgICAgIHN0ZHNba10gPSBzdGRzW2tdLl9maWxlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBVdGlsaXR5LnN0YXJ0TG9nZ2luZyhzdGRzLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgcmV0dXJuIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byByZWxvYWQgbG9nczonLCBlcnIuc3RhY2spO1xuICAgICAgICBjb25zb2xlLmxvZygnUmVsb2FkaW5nIGxvZy4uLicpO1xuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICB2YXIgZGF5anMgPSBudWxsO1xuXG4gIGlmIChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdClcblxuICBVdGlsaXR5LnN0YXJ0TG9nZ2luZyhzdGRzLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgcHJvY2Vzcy5zZW5kKHtcbiAgICAgICAgdHlwZTogJ3Byb2Nlc3M6ZXhjZXB0aW9uJyxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICAgIHN5c2NhbGw6ICdQcm9jZXNzQ29udGFpbmVyLnN0YXJ0TG9nZ2luZydcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcHJvY2Vzcy5zdGRlcnIud3JpdGUgPSAoZnVuY3Rpb24gKHdyaXRlKSB7XG4gICAgICByZXR1cm4gZnVuY3Rpb24gKHN0cmluZywgY2IpIHtcbiAgICAgICAgdmFyIGxvZ19kYXRhID0gbnVsbDtcblxuICAgICAgICAvLyBEaXNhYmxlIGxvZ3MgaWYgc3BlY2lmaWVkXG4gICAgICAgIGlmIChwbTJfZW52LmRpc2FibGVfbG9ncyA9PT0gdHJ1ZSkge1xuICAgICAgICAgIHJldHVybiBjYiA/IGNiKCkgOiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwbTJfZW52LmxvZ190eXBlICYmIHBtMl9lbnYubG9nX3R5cGUgPT09ICdqc29uJykge1xuICAgICAgICAgIGxvZ19kYXRhID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgbWVzc2FnZTogc3RyaW5nLnRvU3RyaW5nKCksXG4gICAgICAgICAgICB0aW1lc3RhbXA6IHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0ICYmIGRheWpzID9cbiAgICAgICAgICAgICAgZGF5anMoKS5mb3JtYXQocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQpIDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgdHlwZTogJ2VycicsXG4gICAgICAgICAgICBwcm9jZXNzX2lkOiBwbTJfZW52LnBtX2lkLFxuICAgICAgICAgICAgYXBwX25hbWU6IHBtMl9lbnYubmFtZVxuICAgICAgICAgIH0pICsgJ1xcbic7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQgJiYgZGF5anMpXG4gICAgICAgICAgbG9nX2RhdGEgPSBgJHtkYXlqcygpLmZvcm1hdChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCl9OiAke3N0cmluZy50b1N0cmluZygpfWA7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICBsb2dfZGF0YSA9IHN0cmluZy50b1N0cmluZygpO1xuXG4gICAgICAgIHByb2Nlc3Muc2VuZCh7XG4gICAgICAgICAgdHlwZTogJ2xvZzplcnInLFxuICAgICAgICAgIHRvcGljOiAnbG9nOmVycicsXG4gICAgICAgICAgZGF0YTogbG9nX2RhdGFcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKFV0aWxpdHkuY2hlY2tQYXRoSXNOdWxsKHBtMl9lbnYucG1fZXJyX2xvZ19wYXRoKSAmJlxuICAgICAgICAgICghcG0yX2Vudi5wbV9sb2dfcGF0aCB8fCBVdGlsaXR5LmNoZWNrUGF0aElzTnVsbChwbTJfZW52LnBtX2xvZ19wYXRoKSkpXG4gICAgICAgICAgcmV0dXJuIGNiID8gY2IoKSA6IGZhbHNlO1xuXG4gICAgICAgIC8vIFRPRE86IHBsZWFzZSBjaGVjayB0aGlzXG4gICAgICAgIGNvbnN0IGVuY29kaW5nID0gXCJcIjtcbiAgICAgICAgc3Rkcy5zdGQgJiYgc3Rkcy5zdGQud3JpdGUgJiYgc3Rkcy5zdGQud3JpdGUobG9nX2RhdGEsIGVuY29kaW5nKTtcbiAgICAgICAgc3Rkcy5lcnIgJiYgc3Rkcy5lcnIud3JpdGUgJiYgc3Rkcy5lcnIud3JpdGUobG9nX2RhdGEsIGVuY29kaW5nLCBjYik7XG4gICAgICB9O1xuICAgIH0pKHByb2Nlc3Muc3RkZXJyLndyaXRlKTtcblxuICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlID0gKGZ1bmN0aW9uICh3cml0ZSkge1xuICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzdHJpbmcsIGNiKSB7XG4gICAgICAgIHZhciBsb2dfZGF0YSA9IG51bGw7XG5cbiAgICAgICAgLy8gRGlzYWJsZSBsb2dzIGlmIHNwZWNpZmllZFxuICAgICAgICBpZiAocG0yX2Vudi5kaXNhYmxlX2xvZ3MgPT09IHRydWUpIHtcbiAgICAgICAgICByZXR1cm4gY2IgPyBjYigpIDogZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocG0yX2Vudi5sb2dfdHlwZSAmJiBwbTJfZW52LmxvZ190eXBlID09PSAnanNvbicpIHtcbiAgICAgICAgICBsb2dfZGF0YSA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IHN0cmluZy50b1N0cmluZygpLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCAmJiBkYXlqcyA/XG4gICAgICAgICAgICAgIGRheWpzKCkuZm9ybWF0KHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0KSA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIHR5cGU6ICdvdXQnLFxuICAgICAgICAgICAgcHJvY2Vzc19pZDogcG0yX2Vudi5wbV9pZCxcbiAgICAgICAgICAgIGFwcF9uYW1lOiBwbTJfZW52Lm5hbWVcbiAgICAgICAgICB9KSArICdcXG4nO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0ICYmIGRheWpzKVxuICAgICAgICAgIGxvZ19kYXRhID0gYCR7ZGF5anMoKS5mb3JtYXQocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQpfTogJHtzdHJpbmcudG9TdHJpbmcoKX1gO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgbG9nX2RhdGEgPSBzdHJpbmcudG9TdHJpbmcoKTtcblxuICAgICAgICBwcm9jZXNzLnNlbmQoe1xuICAgICAgICAgIHR5cGU6ICdsb2c6b3V0JyxcbiAgICAgICAgICBkYXRhOiBsb2dfZGF0YVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoVXRpbGl0eS5jaGVja1BhdGhJc051bGwocG0yX2Vudi5wbV9vdXRfbG9nX3BhdGgpICYmXG4gICAgICAgICAgKCFwbTJfZW52LnBtX2xvZ19wYXRoIHx8IFV0aWxpdHkuY2hlY2tQYXRoSXNOdWxsKHBtMl9lbnYucG1fbG9nX3BhdGgpKSlcbiAgICAgICAgICByZXR1cm4gY2IgPyBjYigpIDogbnVsbDtcblxuICAgICAgICAvLyBUT0RPOiBwbGVhc2UgY2hlY2sgdGhpc1xuICAgICAgICBjb25zdCBlbmNvZGluZyA9IFwiXCI7XG4gICAgICAgIHN0ZHMuc3RkICYmIHN0ZHMuc3RkLndyaXRlICYmIHN0ZHMuc3RkLndyaXRlKGxvZ19kYXRhLCBlbmNvZGluZyk7XG4gICAgICAgIHN0ZHMub3V0ICYmIHN0ZHMub3V0LndyaXRlICYmIHN0ZHMub3V0LndyaXRlKGxvZ19kYXRhLCBlbmNvZGluZywgY2IpO1xuICAgICAgfTtcbiAgICB9KShwcm9jZXNzLnN0ZG91dC53cml0ZSk7XG5cbiAgICBmdW5jdGlvbiBnZXRVbmNhdWdodEV4Y2VwdGlvbkxpc3RlbmVyKGxpc3RlbmVyKSB7XG4gICAgICByZXR1cm4gZnVuY3Rpb24gdW5jYXVnaHRMaXN0ZW5lcihlcnIpIHtcbiAgICAgICAgdmFyIGVycm9yID0gZXJyICYmIGVyci5zdGFjayA/IGVyci5zdGFjayA6IGVycjtcblxuICAgICAgICBpZiAobGlzdGVuZXIgPT09ICd1bmhhbmRsZWRSZWplY3Rpb24nKSB7XG4gICAgICAgICAgZXJyb3IgPSAnWW91IGhhdmUgdHJpZ2dlcmVkIGFuIHVuaGFuZGxlZFJlamVjdGlvbiwgeW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBjYXRjaCBhIFByb21pc2UgcmVqZWN0aW9uOlxcbicgKyBlcnJvcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxvZ0Vycm9yKFsnc3RkJywgJ2VyciddLCBlcnJvcik7XG5cbiAgICAgICAgLy8gTm90aWZ5IG1hc3RlciB0aGF0IGFuIHVuY2F1Z2h0RXhjZXB0aW9uIGhhcyBiZWVuIGNhdGNoZWRcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICB2YXIgZXJyT2JqID0ge307XG5cbiAgICAgICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGVycikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XG4gICAgICAgICAgICAgIGVyck9ialtrZXldID0gZXJyW2tleV07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBwcm9jZXNzLnNlbmQoe1xuICAgICAgICAgICAgdHlwZTogJ2xvZzplcnInLFxuICAgICAgICAgICAgdG9waWM6ICdsb2c6ZXJyJyxcbiAgICAgICAgICAgIGRhdGE6ICdcXG4nICsgZXJyb3IgKyAnXFxuJ1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHByb2Nlc3Muc2VuZCh7XG4gICAgICAgICAgICB0eXBlOiAncHJvY2VzczpleGNlcHRpb24nLFxuICAgICAgICAgICAgZGF0YTogZXJyT2JqICE9PSB1bmRlZmluZWQgPyBlcnJPYmogOiB7IG1lc3NhZ2U6ICdObyBlcnJvciBidXQgJyArIGxpc3RlbmVyICsgJyB3YXMgY2F1Z2h0IScgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgbG9nRXJyb3IoWydzdGQnLCAnZXJyJ10sICdDaGFubmVsIGlzIGFscmVhZHkgY2xvc2VkIGNhblxcJ3QgYnJvYWRjYXN0IGVycm9yOlxcbicgKyBlLnN0YWNrKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcHJvY2Vzcy5saXN0ZW5lcnMobGlzdGVuZXIpLmZpbHRlcihmdW5jdGlvbiAobGlzdGVuZXIpIHtcbiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIgIT09IHVuY2F1Z2h0TGlzdGVuZXI7XG4gICAgICAgIH0pLmxlbmd0aCkge1xuICAgICAgICAgIGlmIChsaXN0ZW5lciA9PSAndW5jYXVnaHRFeGNlcHRpb24nKSB7XG4gICAgICAgICAgICBwcm9jZXNzLmVtaXQoJ2Rpc2Nvbm5lY3QnKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdChjc3QuQ09ERV9VTkNBVUdIVEVYQ0VQVElPTik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCBnZXRVbmNhdWdodEV4Y2VwdGlvbkxpc3RlbmVyKCd1bmNhdWdodEV4Y2VwdGlvbicpKTtcbiAgICBwcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCBnZXRVbmNhdWdodEV4Y2VwdGlvbkxpc3RlbmVyKCd1bmhhbmRsZWRSZWplY3Rpb24nKSk7XG5cbiAgICAvLyBDaGFuZ2UgZGlyIHRvIGZpeCBwcm9jZXNzLmN3ZFxuICAgIHByb2Nlc3MuY2hkaXIocG0yX2Vudi5wbV9jd2QgfHwgcHJvY2Vzcy5lbnYuUFdEIHx8IHAuZGlybmFtZShzY3JpcHQpKTtcblxuICAgIGlmIChQcm9jZXNzVXRpbHMuaXNFU01vZHVsZShzY3JpcHQpID09PSB0cnVlKVxuICAgICAgaW1wb3J0KHByb2Nlc3MuZW52LnBtX2V4ZWNfcGF0aCk7XG4gICAgZWxzZVxuICAgICAgcmVxdWlyZSgnbW9kdWxlJykuX2xvYWQoc2NyaXB0LCBudWxsLCB0cnVlKTtcblxuICAgIGZ1bmN0aW9uIGxvZ0Vycm9yKHR5cGVzLCBlcnJvcikge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdHlwZXMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkge1xuICAgICAgICAgIHN0ZHNbdHlwZV0gJiYgdHlwZW9mIHN0ZHNbdHlwZV0ud3JpdGUgPT0gJ2Z1bmN0aW9uJyAmJiBzdGRzW3R5cGVdLndyaXRlKGVycm9yICsgJ1xcbicpO1xuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHsgfVxuICAgIH1cbiAgfSk7XG59XG4iXX0=
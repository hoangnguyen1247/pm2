"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _fclone = _interopRequireDefault(require("fclone"));

var _fs = _interopRequireDefault(require("fs"));

var _waterfall = _interopRequireDefault(require("async/waterfall"));

var _util = _interopRequireDefault(require("util"));

var _url = _interopRequireDefault(require("url"));

var _dayjs = _interopRequireDefault(require("dayjs"));

var _constants = _interopRequireDefault(require("../constants"));

var _findPackageJson = _interopRequireDefault(require("./tools/find-package-json"));

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */

/**
 * Common Utilities ONLY USED IN ->DAEMON<-
 */
var Utility = {
  findPackageVersion: function findPackageVersion(fullpath) {
    var version;

    try {
      version = (0, _findPackageJson["default"])(fullpath).next().value.version;
    } catch (e) {
      version = 'N/A';
    }

    return version;
  },
  getDate: function getDate() {
    return Date.now();
  },
  extendExtraConfig: function extendExtraConfig(proc, opts) {
    if (opts.env && opts.env.current_conf) {
      if (opts.env.current_conf.env && (0, _typeof2["default"])(opts.env.current_conf.env) === 'object' && Object.keys(opts.env.current_conf.env).length === 0) delete opts.env.current_conf.env;
      Utility.extendMix(proc.pm2_env, opts.env.current_conf);
      delete opts.env.current_conf;
    }
  },
  formatCLU: function formatCLU(process) {
    if (!process.pm2_env) {
      return process;
    }

    var obj = Utility.clone(process.pm2_env);
    delete obj.env;
    return obj;
  },
  extend: function extend(destination, source) {
    if (!source || (0, _typeof2["default"])(source) != 'object') return destination;
    Object.keys(source).forEach(function (new_key) {
      if (source[new_key] != '[object Object]') destination[new_key] = source[new_key];
    });
    return destination;
  },
  // Same as extend but drop value with 'null'
  extendMix: function extendMix(destination, source) {
    if (!source || (0, _typeof2["default"])(source) != 'object') return destination;
    Object.keys(source).forEach(function (new_key) {
      if (source[new_key] == 'null') delete destination[new_key];else destination[new_key] = source[new_key];
    });
    return destination;
  },
  whichFileExists: function whichFileExists(file_arr) {
    var f = null;
    file_arr.some(function (file) {
      try {
        _fs["default"].statSync(file);
      } catch (e) {
        return false;
      }

      f = file;
      return true;
    });
    return f;
  },
  clone: function clone(obj) {
    if (obj === null || obj === undefined) return {};
    return (0, _fclone["default"])(obj);
  },
  overrideConsole: function overrideConsole(bus) {
    if (_constants["default"].PM2_LOG_DATE_FORMAT && typeof _constants["default"].PM2_LOG_DATE_FORMAT == 'string') {
      // Generate timestamp prefix
      var timestamp = function timestamp() {
        return "".concat((0, _dayjs["default"])(Date.now()).format('YYYY-MM-DDTHH:mm:ss'), ":");
      };

      var hacks = ['info', 'log', 'error', 'warn'],
          consoled = {}; // store console functions.

      hacks.forEach(function (method) {
        consoled[method] = console[method];
      });
      hacks.forEach(function (k) {
        console[k] = function () {
          if (bus) {
            bus.emit('log:PM2', {
              process: {
                pm_id: 'PM2',
                name: 'PM2',
                rev: null
              },
              at: Utility.getDate(),
              data: _util["default"].format.apply(this, arguments) + '\n'
            });
          } // do not destroy variable insertion


          arguments[0] && (arguments[0] = timestamp() + ' PM2 ' + k + ': ' + arguments[0]);
          consoled[k].apply(console, arguments);
        };
      });
    }
  },
  startLogging: function startLogging(stds, callback) {
    /**
     * Start log outgoing messages
     * @method startLogging
     * @param {} callback
     * @return
     */
    // Make sure directories of `logs` and `pids` exist.
    // try {
    //   ['logs', 'pids'].forEach(function(n){
    //     console.log(n);
    //     (function(_path){
    //       !fs.existsSync(_path) && fs.mkdirSync(_path, '0755');
    //     })(path.resolve(cst.PM2_ROOT_PATH, n));
    //   });
    // } catch(err) {
    //   return callback(new Error('can not create directories (logs/pids):' + err.message));
    // }
    // waterfall.
    var flows = []; // types of stdio, should be sorted as `std(entire log)`, `out`, `err`.

    var types = Object.keys(stds).sort(function (x, y) {
      return -x.charCodeAt(0) + y.charCodeAt(0);
    }); // Create write streams.

    (function createWS(pio) {
      if (pio.length != 1) {
        return false;
      }

      var io = pio[0]; // If `std` is a Stream type, try next `std`.
      // compatible with `pm2 reloadLogs`

      if ((0, _typeof2["default"])(stds[io]) == 'object' && !isNaN(stds[io].fd)) {
        return createWS(types.splice(0, 1));
      }

      flows.push(function (next) {
        var file = stds[io]; // if file contains ERR or /dev/null, dont try to create stream since he dont want logs

        if (!file || file.indexOf('NULL') > -1 || file.indexOf('/dev/null') > -1) return next();
        stds[io] = _fs["default"].createWriteStream(file, {
          flags: 'a'
        }).once('error', next).on('open', function () {
          stds[io].removeListener('error', next);
          stds[io].on('error', function (err) {
            console.error(err);
          });
          next();
        });
        stds[io]._file = file;
      });
      return createWS(types.splice(0, 1));
    })(types.splice(0, 1));

    (0, _waterfall["default"])(flows, callback);
  },

  /**
   * Function parse the module name and returns it as canonic:
   * - Makes the name based on installation filename.
   * - Removes the Github author, module version and git branch from original name.
   *
   * @param {string} module_name
   * @returns {string} Canonic module name (without trimed parts).
   * @example Always returns 'pm2-slack' for inputs 'ma-zal/pm2-slack', 'ma-zal/pm2-slack#own-branch',
   *          'pm2-slack-1.0.0.tgz' or 'pm2-slack@1.0.0'.
   */
  getCanonicModuleName: function getCanonicModuleName(module_name) {
    if (typeof module_name !== 'string') return null;
    var canonic_module_name = module_name; // Returns the module name from a .tgz package name (or the original name if it is not a valid pkg).
    // Input: The package name (e.g. "foo.tgz", "foo-1.0.0.tgz", "folder/foo.tgz")
    // Output: The module name

    if (canonic_module_name.match(/\.tgz($|\?)/)) {
      if (canonic_module_name.match(/^(.+\/)?([^\/]+)\.tgz($|\?)/)) {
        canonic_module_name = canonic_module_name.match(/^(.+\/)?([^\/]+)\.tgz($|\?)/)[2];

        if (canonic_module_name.match(/^(.+)-[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9_]+\.[0-9]+)?$/)) {
          canonic_module_name = canonic_module_name.match(/^(.+)-[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9_]+\.[0-9]+)?$/)[1];
        }
      }
    } //pm2 install git+https://github.com/user/module


    if (canonic_module_name.indexOf('git+') !== -1) {
      canonic_module_name = canonic_module_name.split('/').pop();
    } //pm2 install https://github.com/user/module


    if (canonic_module_name.indexOf('http') !== -1) {
      var uri = _url["default"].parse(canonic_module_name);

      canonic_module_name = uri.pathname.split('/').pop();
    } //pm2 install file:///home/user/module
    else if (canonic_module_name.indexOf('file://') === 0) {
        canonic_module_name = canonic_module_name.replace(/\/$/, '').split('/').pop();
      } //pm2 install username/module
      else if (canonic_module_name.indexOf('/') !== -1) {
          if (canonic_module_name.charAt(0) !== "@") {
            canonic_module_name = canonic_module_name.split('/')[1];
          }
        } //pm2 install @somescope/module@2.1.0-beta


    if (canonic_module_name.lastIndexOf('@') > 0) {
      canonic_module_name = canonic_module_name.substr(0, canonic_module_name.lastIndexOf("@"));
    } //pm2 install module#some-branch


    if (canonic_module_name.indexOf('#') !== -1) {
      canonic_module_name = canonic_module_name.split('#')[0];
    }

    if (canonic_module_name.indexOf('.git') !== -1) {
      canonic_module_name = canonic_module_name.replace('.git', '');
    }

    return canonic_module_name;
  },
  checkPathIsNull: function checkPathIsNull(path) {
    return path === 'NULL' || path === '/dev/null' || path === '\\\\.\\NUL';
  },
  generateUUID: function generateUUID() {
    var s = [];
    var hexDigits = "0123456789abcdef";

    for (var i = 0; i < 36; i++) {
      s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
    }

    s[14] = "4";
    s[19] = hexDigits.substr(s[19] & 0x3 | 0x8, 1);
    s[8] = s[13] = s[18] = s[23] = "-";
    return s.join("");
  }
};
var _default = Utility;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9VdGlsaXR5LnRzIl0sIm5hbWVzIjpbIlV0aWxpdHkiLCJmaW5kUGFja2FnZVZlcnNpb24iLCJmdWxscGF0aCIsInZlcnNpb24iLCJuZXh0IiwidmFsdWUiLCJlIiwiZ2V0RGF0ZSIsIkRhdGUiLCJub3ciLCJleHRlbmRFeHRyYUNvbmZpZyIsInByb2MiLCJvcHRzIiwiZW52IiwiY3VycmVudF9jb25mIiwiT2JqZWN0Iiwia2V5cyIsImxlbmd0aCIsImV4dGVuZE1peCIsInBtMl9lbnYiLCJmb3JtYXRDTFUiLCJwcm9jZXNzIiwib2JqIiwiY2xvbmUiLCJleHRlbmQiLCJkZXN0aW5hdGlvbiIsInNvdXJjZSIsImZvckVhY2giLCJuZXdfa2V5Iiwid2hpY2hGaWxlRXhpc3RzIiwiZmlsZV9hcnIiLCJmIiwic29tZSIsImZpbGUiLCJmcyIsInN0YXRTeW5jIiwidW5kZWZpbmVkIiwib3ZlcnJpZGVDb25zb2xlIiwiYnVzIiwiY3N0IiwiUE0yX0xPR19EQVRFX0ZPUk1BVCIsInRpbWVzdGFtcCIsImZvcm1hdCIsImhhY2tzIiwiY29uc29sZWQiLCJtZXRob2QiLCJjb25zb2xlIiwiayIsImVtaXQiLCJwbV9pZCIsIm5hbWUiLCJyZXYiLCJhdCIsImRhdGEiLCJ1dGlsIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJzdGFydExvZ2dpbmciLCJzdGRzIiwiY2FsbGJhY2siLCJmbG93cyIsInR5cGVzIiwic29ydCIsIngiLCJ5IiwiY2hhckNvZGVBdCIsImNyZWF0ZVdTIiwicGlvIiwiaW8iLCJpc05hTiIsImZkIiwic3BsaWNlIiwicHVzaCIsImluZGV4T2YiLCJjcmVhdGVXcml0ZVN0cmVhbSIsImZsYWdzIiwib25jZSIsIm9uIiwicmVtb3ZlTGlzdGVuZXIiLCJlcnIiLCJlcnJvciIsIl9maWxlIiwiZ2V0Q2Fub25pY01vZHVsZU5hbWUiLCJtb2R1bGVfbmFtZSIsImNhbm9uaWNfbW9kdWxlX25hbWUiLCJtYXRjaCIsInNwbGl0IiwicG9wIiwidXJpIiwidXJsIiwicGFyc2UiLCJwYXRobmFtZSIsInJlcGxhY2UiLCJjaGFyQXQiLCJsYXN0SW5kZXhPZiIsInN1YnN0ciIsImNoZWNrUGF0aElzTnVsbCIsInBhdGgiLCJnZW5lcmF0ZVVVSUQiLCJzIiwiaGV4RGlnaXRzIiwiaSIsIk1hdGgiLCJmbG9vciIsInJhbmRvbSIsImpvaW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBVUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBakJBOzs7Ozs7QUFNQTs7O0FBYUEsSUFBSUEsT0FBTyxHQUFHO0FBQ1pDLEVBQUFBLGtCQUFrQixFQUFHLDRCQUFTQyxRQUFULEVBQW1CO0FBQ3RDLFFBQUlDLE9BQUo7O0FBRUEsUUFBSTtBQUNGQSxNQUFBQSxPQUFPLEdBQUcsaUNBQWdCRCxRQUFoQixFQUEwQkUsSUFBMUIsR0FBaUNDLEtBQWpDLENBQXVDRixPQUFqRDtBQUNELEtBRkQsQ0FFRSxPQUFNRyxDQUFOLEVBQVM7QUFDVEgsTUFBQUEsT0FBTyxHQUFHLEtBQVY7QUFDRDs7QUFDRCxXQUFPQSxPQUFQO0FBQ0QsR0FWVztBQVdaSSxFQUFBQSxPQUFPLEVBQUcsbUJBQVc7QUFDbkIsV0FBT0MsSUFBSSxDQUFDQyxHQUFMLEVBQVA7QUFDRCxHQWJXO0FBY1pDLEVBQUFBLGlCQUFpQixFQUFHLDJCQUFTQyxJQUFULEVBQWVDLElBQWYsRUFBcUI7QUFDdkMsUUFBSUEsSUFBSSxDQUFDQyxHQUFMLElBQVlELElBQUksQ0FBQ0MsR0FBTCxDQUFTQyxZQUF6QixFQUF1QztBQUNyQyxVQUFJRixJQUFJLENBQUNDLEdBQUwsQ0FBU0MsWUFBVCxDQUFzQkQsR0FBdEIsSUFDQSx5QkFBT0QsSUFBSSxDQUFDQyxHQUFMLENBQVNDLFlBQVQsQ0FBc0JELEdBQTdCLE1BQXNDLFFBRHRDLElBRUFFLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZSixJQUFJLENBQUNDLEdBQUwsQ0FBU0MsWUFBVCxDQUFzQkQsR0FBbEMsRUFBdUNJLE1BQXZDLEtBQWtELENB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SyxZQUEzRDtBQUNELEdBcFBXO0FBc1BaQyxFQUFBQSxZQUFZLEVBQUUsd0JBQVk7QUFDeEIsUUFBSUMsQ0FBQyxHQUFHLEVBQVI7QUFDQSxRQUFJQyxTQUFTLEdBQUcsa0JBQWhCOztBQUNBLFNBQUssSUFBSUMsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBRyxFQUFwQixFQUF3QkEsQ0FBQyxFQUF6QixFQUE2QjtBQUMzQkYsTUFBQUEsQ0FBQyxDQUFDRSxDQUFELENBQUQsR0FBT0QsU0FBUyxDQUFDTCxNQUFWLENBQWlCTyxJQUFJLENBQUNDLEtBQUwsQ0FBV0QsSUFBSSxDQUFDRSxNQUFMLEtBQWdCLElBQTNCLENBQWpCLEVBQW1ELENBQW5ELENBQVA7QUFDRDs7QUFDREwsSUFBQUEsQ0FBQyxDQUFDLEVBQUQsQ0FBRCxHQUFRLEdBQVI7QUFDQUEsSUFBQUEsQ0FBQyxDQUFDLEVBQUQsQ0FBRCxHQUFRQyxTQUFTLENBQUNMLE1BQVYsQ0FBa0JJLENBQUMsQ0FBQyxFQUFELENBQUQsR0FBUSxHQUFULEdBQWdCLEdBQWpDLEVBQXNDLENBQXRDLENBQVI7QUFDQUEsSUFBQUEsQ0FBQyxDQUFDLENBQUQsQ0FBRCxHQUFPQSxDQUFDLENBQUMsRUFBRCxDQUFELEdBQVFBLENBQUMsQ0FBQyxFQUFELENBQUQsR0FBUUEsQ0FBQyxDQUFDLEVBQUQsQ0FBRCxHQUFRLEdBQS9CO0FBQ0EsV0FBT0EsQ0FBQyxDQUFDTSxJQUFGLENBQU8sRUFBUCxDQUFQO0FBQ0Q7QUFoUVcsQ0FBZDtlQW9RZXpHLE8iLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAyMDEzIHRoZSBQTTIgcHJvamVjdCBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBsaWNlbnNlIHRoYXRcbiAqIGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLlxuICovXG5cbi8qKlxuICogQ29tbW9uIFV0aWxpdGllcyBPTkxZIFVTRUQgSU4gLT5EQUVNT048LVxuICovXG5cbmltcG9ydCBmY2xvbmUgZnJvbSAnZmNsb25lJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgd2F0ZXJmYWxsIGZyb20gJ2FzeW5jL3dhdGVyZmFsbCc7XG5pbXBvcnQgdXRpbCBmcm9tICd1dGlsJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCBkYXlqcyBmcm9tICdkYXlqcyc7XG5pbXBvcnQgY3N0IGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgZmluZFBhY2thZ2VKc29uIGZyb20gJy4vdG9vbHMvZmluZC1wYWNrYWdlLWpzb24nO1xuXG52YXIgVXRpbGl0eSA9IHtcbiAgZmluZFBhY2thZ2VWZXJzaW9uIDogZnVuY3Rpb24oZnVsbHBhdGgpIHtcbiAgICB2YXIgdmVyc2lvblxuXG4gICAgdHJ5IHtcbiAgICAgIHZlcnNpb24gPSBmaW5kUGFja2FnZUpzb24oZnVsbHBhdGgpLm5leHQoKS52YWx1ZS52ZXJzaW9uXG4gICAgfSBjYXRjaChlKSB7XG4gICAgICB2ZXJzaW9uID0gJ04vQSdcbiAgICB9XG4gICAgcmV0dXJuIHZlcnNpb25cbiAgfSxcbiAgZ2V0RGF0ZSA6IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBEYXRlLm5vdygpO1xuICB9LFxuICBleHRlbmRFeHRyYUNvbmZpZyA6IGZ1bmN0aW9uKHByb2MsIG9wdHMpIHtcbiAgICBpZiAob3B0cy5lbnYgJiYgb3B0cy5lbnYuY3VycmVudF9jb25mKSB7XG4gICAgICBpZiAob3B0cy5lbnYuY3VycmVudF9jb25mLmVudiAmJlxuICAgICAgICAgIHR5cGVvZihvcHRzLmVudi5jdXJyZW50X2NvbmYuZW52KSA9PT0gJ29iamVjdCcgJiZcbiAgICAgICAgICBPYmplY3Qua2V5cyhvcHRzLmVudi5jdXJyZW50X2NvbmYuZW52KS5sZW5ndGggPT09IDApXG4gICAgICAgIGRlbGV0ZSBvcHRzLmVudi5jdXJyZW50X2NvbmYuZW52XG5cbiAgICAgIFV0aWxpdHkuZXh0ZW5kTWl4KHByb2MucG0yX2Vudiwgb3B0cy5lbnYuY3VycmVudF9jb25mKTtcbiAgICAgIGRlbGV0ZSBvcHRzLmVudi5jdXJyZW50X2NvbmY7XG4gICAgfVxuICB9LFxuICBmb3JtYXRDTFUgOiBmdW5jdGlvbihwcm9jZXNzKSB7XG4gICAgaWYgKCFwcm9jZXNzLnBtMl9lbnYpIHtcbiAgICAgIHJldHVybiBwcm9jZXNzO1xuICAgIH1cblxuICAgIHZhciBvYmogPSBVdGlsaXR5LmNsb25lKHByb2Nlc3MucG0yX2Vudik7XG4gICAgZGVsZXRlIG9iai5lbnY7XG5cbiAgICByZXR1cm4gb2JqO1xuICB9LFxuICBleHRlbmQgOiBmdW5jdGlvbihkZXN0aW5hdGlvbiwgc291cmNlKXtcbiAgICBpZiAoIXNvdXJjZSB8fCB0eXBlb2Ygc291cmNlICE9ICdvYmplY3QnKSByZXR1cm4gZGVzdGluYXRpb247XG5cbiAgICAgIE9iamVjdC5rZXlzKHNvdXJjZSkuZm9yRWFjaChmdW5jdGlvbihuZXdfa2V5KSB7XG4gICAgICAgIGlmIChzb3VyY2VbbmV3X2tleV0gIT0gJ1tvYmplY3QgT2JqZWN0XScpXG4gICAgICAgICAgZGVzdGluYXRpb25bbmV3X2tleV0gPSBzb3VyY2VbbmV3X2tleV07XG4gICAgICB9KTtcblxuICAgIHJldHVybiBkZXN0aW5hdGlvbjtcbiAgfSxcbiAgLy8gU2FtZSBhcyBleHRlbmQgYnV0IGRyb3AgdmFsdWUgd2l0aCAnbnVsbCdcbiAgZXh0ZW5kTWl4IDogZnVuY3Rpb24oZGVzdGluYXRpb24sIHNvdXJjZSl7XG4gICAgaWYgKCFzb3VyY2UgfHwgdHlwZW9mIHNvdXJjZSAhPSAnb2JqZWN0JykgcmV0dXJuIGRlc3RpbmF0aW9uO1xuXG4gICAgT2JqZWN0LmtleXMoc291cmNlKS5mb3JFYWNoKGZ1bmN0aW9uKG5ld19rZXkpIHtcbiAgICAgIGlmIChzb3VyY2VbbmV3X2tleV0gPT0gJ251bGwnKVxuICAgICAgICBkZWxldGUgZGVzdGluYXRpb25bbmV3X2tleV07XG4gICAgICBlbHNlXG4gICAgICAgIGRlc3RpbmF0aW9uW25ld19rZXldID0gc291cmNlW25ld19rZXldXG4gICAgfSk7XG5cbiAgICByZXR1cm4gZGVzdGluYXRpb247XG4gIH0sXG5cbiAgd2hpY2hGaWxlRXhpc3RzIDogZnVuY3Rpb24oZmlsZV9hcnIpIHtcbiAgICB2YXIgZiA9IG51bGw7XG5cbiAgICBmaWxlX2Fyci5zb21lKGZ1bmN0aW9uKGZpbGUpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGZzLnN0YXRTeW5jKGZpbGUpO1xuICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGYgPSBmaWxlO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSk7XG4gICAgcmV0dXJuIGY7XG4gIH0sXG4gIGNsb25lICAgICA6IGZ1bmN0aW9uKG9iaikge1xuICAgIGlmIChvYmogPT09IG51bGwgfHwgb2JqID09PSB1bmRlZmluZWQpIHJldHVybiB7fTtcbiAgICByZXR1cm4gZmNsb25lKG9iaik7XG4gIH0sXG4gIG92ZXJyaWRlQ29uc29sZSA6IGZ1bmN0aW9uKGJ1cykge1xuICAgIGlmIChjc3QuUE0yX0xPR19EQVRFX0ZPUk1BVCAmJiB0eXBlb2YgY3N0LlBNMl9MT0dfREFURV9GT1JNQVQgPT0gJ3N0cmluZycpIHtcbiAgICAgIC8vIEdlbmVyYXRlIHRpbWVzdGFtcCBwcmVmaXhcbiAgICAgIGZ1bmN0aW9uIHRpbWVzdGFtcCgpe1xuICAgICAgICByZXR1cm4gYCR7ZGF5anMoRGF0ZS5ub3coKSkuZm9ybWF0KCdZWVlZLU1NLUREVEhIOm1tOnNzJyl9OmA7XG4gICAgICB9XG5cbiAgICAgIHZhciBoYWNrcyA9IFsnaW5mbycsICdsb2cnLCAnZXJyb3InLCAnd2FybiddLCBjb25zb2xlZCA9IHt9O1xuXG4gICAgICAvLyBzdG9yZSBjb25zb2xlIGZ1bmN0aW9ucy5cbiAgICAgIGhhY2tzLmZvckVhY2goZnVuY3Rpb24obWV0aG9kKXtcbiAgICAgICAgY29uc29sZWRbbWV0aG9kXSA9IGNvbnNvbGVbbWV0aG9kXTtcbiAgICAgIH0pO1xuXG4gICAgICBoYWNrcy5mb3JFYWNoKGZ1bmN0aW9uKGspe1xuICAgICAgICBjb25zb2xlW2tdID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICBpZiAoYnVzKSB7XG4gICAgICAgICAgICBidXMuZW1pdCgnbG9nOlBNMicsIHtcbiAgICAgICAgICAgICAgcHJvY2VzcyA6IHtcbiAgICAgICAgICAgICAgICBwbV9pZCAgICAgIDogJ1BNMicsXG4gICAgICAgICAgICAgICAgbmFtZSAgICAgICA6ICdQTTInLFxuICAgICAgICAgICAgICAgIHJldiAgICAgICAgOiBudWxsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIGF0ICA6IFV0aWxpdHkuZ2V0RGF0ZSgpLFxuICAgICAgICAgICAgICBkYXRhIDogdXRpbC5mb3JtYXQuYXBwbHkodGhpcywgYXJndW1lbnRzIGFzIGFueSkgKyAnXFxuJ1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIGRvIG5vdCBkZXN0cm95IHZhcmlhYmxlIGluc2VydGlvblxuICAgICAgICAgIGFyZ3VtZW50c1swXSAmJiAoYXJndW1lbnRzWzBdID0gdGltZXN0YW1wKCkgKyAnIFBNMiAnICsgayArICc6ICcgKyBhcmd1bWVudHNbMF0pO1xuICAgICAgICAgIGNvbnNvbGVkW2tdLmFwcGx5KGNvbnNvbGUsIGFyZ3VtZW50cyk7XG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG4gIHN0YXJ0TG9nZ2luZyA6IGZ1bmN0aW9uKHN0ZHMsIGNhbGxiYWNrKSB7XG4gICAgLyoqXG4gICAgICogU3RhcnQgbG9nIG91dGdvaW5nIG1lc3NhZ2VzXG4gICAgICogQG1ldGhvZCBzdGFydExvZ2dpbmdcbiAgICAgKiBAcGFyYW0ge30gY2FsbGJhY2tcbiAgICAgKiBAcmV0dXJuXG4gICAgICovXG4gICAgLy8gTWFrZSBzdXJlIGRpcmVjdG9yaWVzIG9mIGBsb2dzYCBhbmQgYHBpZHNgIGV4aXN0LlxuICAgIC8vIHRyeSB7XG4gICAgLy8gICBbJ2xvZ3MnLCAncGlkcyddLmZvckVhY2goZnVuY3Rpb24obil7XG4gICAgLy8gICAgIGNvbnNvbGUubG9nKG4pO1xuICAgIC8vICAgICAoZnVuY3Rpb24oX3BhdGgpe1xuICAgIC8vICAgICAgICFmcy5leGlzdHNTeW5jKF9wYXRoKSAmJiBmcy5ta2RpclN5bmMoX3BhdGgsICcwNzU1Jyk7XG4gICAgLy8gICAgIH0pKHBhdGgucmVzb2x2ZShjc3QuUE0yX1JPT1RfUEFUSCwgbikpO1xuICAgIC8vICAgfSk7XG4gICAgLy8gfSBjYXRjaChlcnIpIHtcbiAgICAvLyAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoJ2NhbiBub3QgY3JlYXRlIGRpcmVjdG9yaWVzIChsb2dzL3BpZHMpOicgKyBlcnIubWVzc2FnZSkpO1xuICAgIC8vIH1cblxuICAgIC8vIHdhdGVyZmFsbC5cbiAgICB2YXIgZmxvd3MgPSBbXTtcbiAgICAvLyB0eXBlcyBvZiBzdGRpbywgc2hvdWxkIGJlIHNvcnRlZCBhcyBgc3RkKGVudGlyZSBsb2cpYCwgYG91dGAsIGBlcnJgLlxuICAgIHZhciB0eXBlcyA9IE9iamVjdC5rZXlzKHN0ZHMpLnNvcnQoZnVuY3Rpb24oeCwgeSl7XG4gICAgICByZXR1cm4gLXguY2hhckNvZGVBdCgwKSArIHkuY2hhckNvZGVBdCgwKTtcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSB3cml0ZSBzdHJlYW1zLlxuICAgIChmdW5jdGlvbiBjcmVhdGVXUyhwaW8pe1xuICAgICAgaWYocGlvLmxlbmd0aCAhPSAxKXtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgbGV0IGlvID0gcGlvWzBdO1xuXG4gICAgICAvLyBJZiBgc3RkYCBpcyBhIFN0cmVhbSB0eXBlLCB0cnkgbmV4dCBgc3RkYC5cbiAgICAgIC8vIGNvbXBhdGlibGUgd2l0aCBgcG0yIHJlbG9hZExvZ3NgXG4gICAgICBpZih0eXBlb2Ygc3Rkc1tpb10gPT0gJ29iamVjdCcgJiYgIWlzTmFOKHN0ZHNbaW9dLmZkKSl7XG4gICAgICAgIHJldHVybiBjcmVhdGVXUyh0eXBlcy5zcGxpY2UoMCwgMSkpO1xuICAgICAgfVxuXG4gICAgICBmbG93cy5wdXNoKGZ1bmN0aW9uKG5leHQpe1xuICAgICAgICB2YXIgZmlsZSA9IHN0ZHNbaW9dO1xuXG4gICAgICAgIC8vIGlmIGZpbGUgY29udGFpbnMgRVJSIG9yIC9kZXYvbnVsbCwgZG9udCB0cnkgdG8gY3JlYXRlIHN0cmVhbSBzaW5jZSBoZSBkb250IHdhbnQgbG9nc1xuICAgICAgICBpZiAoIWZpbGUgfHwgZmlsZS5pbmRleE9mKCdOVUxMJykgPiAtMSB8fCBmaWxlLmluZGV4T2YoJy9kZXYvbnVsbCcpID4gLTEpXG4gICAgICAgICAgcmV0dXJuIG5leHQoKTtcblxuICAgICAgICBzdGRzW2lvXSA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGZpbGUsIHtmbGFnczogJ2EnfSlcbiAgICAgICAgICAub25jZSgnZXJyb3InLCBuZXh0KVxuICAgICAgICAgIC5vbignb3BlbicsIGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICBzdGRzW2lvXS5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBuZXh0KTtcblxuICAgICAgICAgICAgc3Rkc1tpb10ub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIHN0ZHNbaW9dLl9maWxlID0gZmlsZTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGNyZWF0ZVdTKHR5cGVzLnNwbGljZSgwLCAxKSk7XG4gICAgfSkodHlwZXMuc3BsaWNlKDAsIDEpKTtcblxuICAgIHdhdGVyZmFsbChmbG93cywgY2FsbGJhY2spO1xuICB9LFxuXG4gIC8qKlxuICAgKiBGdW5jdGlvbiBwYXJzZSB0aGUgbW9kdWxlIG5hbWUgYW5kIHJldHVybnMgaXQgYXMgY2Fub25pYzpcbiAgICogLSBNYWtlcyB0aGUgbmFtZSBiYXNlZCBvbiBpbnN0YWxsYXRpb24gZmlsZW5hbWUuXG4gICAqIC0gUmVtb3ZlcyB0aGUgR2l0aHViIGF1dGhvciwgbW9kdWxlIHZlcnNpb24gYW5kIGdpdCBicmFuY2ggZnJvbSBvcmlnaW5hbCBuYW1lLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlX25hbWVcbiAgICogQHJldHVybnMge3N0cmluZ30gQ2Fub25pYyBtb2R1bGUgbmFtZSAod2l0aG91dCB0cmltZWQgcGFydHMpLlxuICAgKiBAZXhhbXBsZSBBbHdheXMgcmV0dXJucyAncG0yLXNsYWNrJyBmb3IgaW5wdXRzICdtYS16YWwvcG0yLXNsYWNrJywgJ21hLXphbC9wbTItc2xhY2sjb3duLWJyYW5jaCcsXG4gICAqICAgICAgICAgICdwbTItc2xhY2stMS4wLjAudGd6JyBvciAncG0yLXNsYWNrQDEuMC4wJy5cbiAgICovXG4gIGdldENhbm9uaWNNb2R1bGVOYW1lOiBmdW5jdGlvbihtb2R1bGVfbmFtZSkge1xuICAgIGlmICh0eXBlb2YgbW9kdWxlX25hbWUgIT09ICdzdHJpbmcnKSByZXR1cm4gbnVsbDtcbiAgICB2YXIgY2Fub25pY19tb2R1bGVfbmFtZSA9IG1vZHVsZV9uYW1lO1xuXG4gICAgLy8gUmV0dXJucyB0aGUgbW9kdWxlIG5hbWUgZnJvbSBhIC50Z3ogcGFja2FnZSBuYW1lIChvciB0aGUgb3JpZ2luYWwgbmFtZSBpZiBpdCBpcyBub3QgYSB2YWxpZCBwa2cpLlxuICAgIC8vIElucHV0OiBUaGUgcGFja2FnZSBuYW1lIChlLmcuIFwiZm9vLnRnelwiLCBcImZvby0xLjAuMC50Z3pcIiwgXCJmb2xkZXIvZm9vLnRnelwiKVxuICAgIC8vIE91dHB1dDogVGhlIG1vZHVsZSBuYW1lXG4gICAgaWYgKGNhbm9uaWNfbW9kdWxlX25hbWUubWF0Y2goL1xcLnRneigkfFxcPykvKSkge1xuICAgICAgaWYgKGNhbm9uaWNfbW9kdWxlX25hbWUubWF0Y2goL14oLitcXC8pPyhbXlxcL10rKVxcLnRneigkfFxcPykvKSkge1xuICAgICAgICBjYW5vbmljX21vZHVsZV9uYW1lID0gY2Fub25pY19tb2R1bGVfbmFtZS5tYXRjaCgvXiguK1xcLyk/KFteXFwvXSspXFwudGd6KCR8XFw/KS8pWzJdO1xuICAgICAgICBpZiAoY2Fub25pY19tb2R1bGVfbmFtZS5tYXRjaCgvXiguKyktWzAtOV0rXFwuWzAtOV0rXFwuWzAtOV0rKC1bYS16QS1aMC05X10rXFwuWzAtOV0rKT8kLykpIHtcbiAgICAgICAgICBjYW5vbmljX21vZHVsZV9uYW1lID0gY2Fub25pY19tb2R1bGVfbmFtZS5tYXRjaCgvXiguKyktWzAtOV0rXFwuWzAtOV0rXFwuWzAtOV0rKC1bYS16QS1aMC05X10rXFwuWzAtOV0rKT8kLylbMV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvL3BtMiBpbnN0YWxsIGdpdCtodHRwczovL2dpdGh1Yi5jb20vdXNlci9tb2R1bGVcbiAgICBpZihjYW5vbmljX21vZHVsZV9uYW1lLmluZGV4T2YoJ2dpdCsnKSAhPT0gLTEpIHtcbiAgICAgIGNhbm9uaWNfbW9kdWxlX25hbWUgPSBjYW5vbmljX21vZHVsZV9uYW1lLnNwbGl0KCcvJykucG9wKCk7XG4gICAgfVxuXG4gICAgLy9wbTIgaW5zdGFsbCBodHRwczovL2dpdGh1Yi5jb20vdXNlci9tb2R1bGVcbiAgICBpZihjYW5vbmljX21vZHVsZV9uYW1lLmluZGV4T2YoJ2h0dHAnKSAhPT0gLTEpIHtcbiAgICAgIHZhciB1cmkgPSB1cmwucGFyc2UoY2Fub25pY19tb2R1bGVfbmFtZSk7XG4gICAgICBjYW5vbmljX21vZHVsZV9uYW1lID0gdXJpLnBhdGhuYW1lLnNwbGl0KCcvJykucG9wKCk7XG4gICAgfVxuXG4gICAgLy9wbTIgaW5zdGFsbCBmaWxlOi8vL2hvbWUvdXNlci9tb2R1bGVcbiAgICBlbHNlIGlmKGNhbm9uaWNfbW9kdWxlX25hbWUuaW5kZXhPZignZmlsZTovLycpID09PSAwKSB7XG4gICAgICBjYW5vbmljX21vZHVsZV9uYW1lID0gY2Fub25pY19tb2R1bGVfbmFtZS5yZXBsYWNlKC9cXC8kLywgJycpLnNwbGl0KCcvJykucG9wKCk7XG4gICAgfVxuXG4gICAgLy9wbTIgaW5zdGFsbCB1c2VybmFtZS9tb2R1bGVcbiAgICBlbHNlIGlmKGNhbm9uaWNfbW9kdWxlX25hbWUuaW5kZXhPZignLycpICE9PSAtMSkge1xuICAgICAgaWYgKGNhbm9uaWNfbW9kdWxlX25hbWUuY2hhckF0KDApICE9PSBcIkBcIil7XG4gICAgICAgIGNhbm9uaWNfbW9kdWxlX25hbWUgPSBjYW5vbmljX21vZHVsZV9uYW1lLnNwbGl0KCcvJylbMV07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy9wbTIgaW5zdGFsbCBAc29tZXNjb3BlL21vZHVsZUAyLjEuMC1iZXRhXG4gICAgaWYoY2Fub25pY19tb2R1bGVfbmFtZS5sYXN0SW5kZXhPZignQCcpID4gMCkge1xuICAgICAgY2Fub25pY19tb2R1bGVfbmFtZSA9IGNhbm9uaWNfbW9kdWxlX25hbWUuc3Vic3RyKDAsY2Fub25pY19tb2R1bGVfbmFtZS5sYXN0SW5kZXhPZihcIkBcIikpO1xuICAgIH1cblxuICAgIC8vcG0yIGluc3RhbGwgbW9kdWxlI3NvbWUtYnJhbmNoXG4gICAgaWYoY2Fub25pY19tb2R1bGVfbmFtZS5pbmRleE9mKCcjJykgIT09IC0xKSB7XG4gICAgICBjYW5vbmljX21vZHVsZV9uYW1lID0gY2Fub25pY19tb2R1bGVfbmFtZS5zcGxpdCgnIycpWzBdO1xuICAgIH1cblxuICAgIGlmIChjYW5vbmljX21vZHVsZV9uYW1lLmluZGV4T2YoJy5naXQnKSAhPT0gLTEpIHtcbiAgICAgIGNhbm9uaWNfbW9kdWxlX25hbWUgPSBjYW5vbmljX21vZHVsZV9uYW1lLnJlcGxhY2UoJy5naXQnLCAnJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNhbm9uaWNfbW9kdWxlX25hbWU7XG4gIH0sXG5cbiAgY2hlY2tQYXRoSXNOdWxsOiBmdW5jdGlvbihwYXRoKSB7XG4gICAgcmV0dXJuIHBhdGggPT09ICdOVUxMJyB8fCBwYXRoID09PSAnL2Rldi9udWxsJyB8fCBwYXRoID09PSAnXFxcXFxcXFwuXFxcXE5VTCc7XG4gIH0sXG5cbiAgZ2VuZXJhdGVVVUlEOiBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHMgPSBbXTtcbiAgICB2YXIgaGV4RGlnaXRzID0gXCIwMTIzNDU2Nzg5YWJjZGVmXCI7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCAzNjsgaSsrKSB7XG4gICAgICBzW2ldID0gaGV4RGlnaXRzLnN1YnN0cihNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAweDEwKSwgMSk7XG4gICAgfVxuICAgIHNbMTRdID0gXCI0XCI7XG4gICAgc1sxOV0gPSBoZXhEaWdpdHMuc3Vic3RyKChzWzE5XSAmIDB4MykgfCAweDgsIDEpO1xuICAgIHNbOF0gPSBzWzEzXSA9IHNbMThdID0gc1syM10gPSBcIi1cIjtcbiAgICByZXR1cm4gcy5qb2luKFwiXCIpO1xuICB9XG5cbn07XG5cbmV4cG9ydCBkZWZhdWx0IFV0aWxpdHk7XG4iXX0=
/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
'use strict';
/**
 * @file Reload functions related
 * @author Alexandre Strzelewicz <as@unitech.io>
 * @project PM2
 */

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _constants = _interopRequireDefault(require("../../constants.js"));

var _Utility = _interopRequireDefault(require("../Utility.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/**
 * softReload will wait permission from process to exit
 * @method softReload
 * @param {} God
 * @param {} id
 * @param {} cb
 * @return Literal
 */
function softReload(God, id, cb) {
  var t_key = '_old_' + id; // Move old worker to tmp id

  God.clusters_db[t_key] = God.clusters_db[id];
  delete God.clusters_db[id];
  var old_worker = God.clusters_db[t_key]; // Deep copy

  var new_env = _Utility["default"].clone(old_worker.pm2_env); // Reset created_at and unstable_restarts


  God.resetState(new_env);
  new_env.restart_time += 1;
  old_worker.pm2_env.pm_id = t_key;
  old_worker.pm_id = t_key;
  God.executeApp(new_env, function (err, new_worker) {
    if (err) return cb(err);
    var timer = null;

    var onListen = function onListen() {
      clearTimeout(timer);
      softCleanDeleteProcess();
      console.log('-softReload- New worker listening');
    }; // Bind to know when the new process is up


    new_worker.once('listening', onListen);
    timer = setTimeout(function () {
      new_worker.removeListener('listening', onListen);
      softCleanDeleteProcess();
    }, new_env.listen_timeout || _constants["default"].GRACEFUL_LISTEN_TIMEOUT); // Remove old worker properly

    var softCleanDeleteProcess = function softCleanDeleteProcess() {
      var cleanUp = function cleanUp() {
        clearTimeout(timer);
        console.log('-softReload- Old worker disconnected');
        return God.deleteProcessId(t_key, cb);
      };

      old_worker.once('disconnect', cleanUp);

      try {
        if (old_worker.state != 'dead' && old_worker.state != 'disconnected') old_worker.send && old_worker.send('shutdown');else {
          clearTimeout(timer);
          console.error('Worker %d is already disconnected', old_worker.pm2_env.pm_id);
          return God.deleteProcessId(t_key, cb);
        }
      } catch (e) {
        clearTimeout(timer);
        console.error('Worker %d is already disconnected', old_worker.pm2_env.pm_id);
        return God.deleteProcessId(t_key, cb);
      }

      timer = setTimeout(function () {
        old_worker.removeListener('disconnect', cleanUp);
        return God.deleteProcessId(t_key, cb);
      }, _constants["default"].GRACEFUL_TIMEOUT);
      return false;
    };

    return false;
  });
  return false;
}

;
/**
 * hardReload will reload without waiting permission from process
 * @method hardReload
 * @param {} God
 * @param {} id
 * @param {} cb
 * @return Literal
 */

function hardReload(God, id, wait_msg, cb) {
  var t_key = '_old_' + id; // Move old worker to tmp id

  God.clusters_db[t_key] = God.clusters_db[id];
  delete God.clusters_db[id];
  var old_worker = God.clusters_db[t_key]; // Deep copy

  var new_env = _Utility["default"].clone(old_worker.pm2_env);

  new_env.restart_time += 1; // Reset created_at and unstable_restarts

  God.resetState(new_env);
  old_worker.pm2_env.pm_id = t_key;
  old_worker.pm_id = t_key;
  var timer = null;
  var readySignalSent = false;

  var onListen = function onListen() {
    clearTimeout(timer);
    readySignalSent = true;
    console.log('-reload- New worker listening');
    return God.deleteProcessId(t_key, cb);
  };

  var listener = function listener(packet) {
    if (packet.raw === 'ready' && packet.process.name === old_worker.pm2_env.name && packet.process.pm_id === id) {
      God.bus.removeListener('process:msg', listener);
      return onListen();
    }
  };

  if (wait_msg !== 'listening') {
    God.bus.on('process:msg', listener);
  }

  God.executeApp(new_env, function (err, new_worker) {
    if (err) return cb(err); // Bind to know when the new process is up

    if (wait_msg === 'listening') {
      new_worker.once('listening', onListen);
    }

    timer = setTimeout(function () {
      if (readySignalSent) {
        return;
      }

      if (wait_msg === 'listening') new_worker.removeListener(wait_msg, onListen);else God.bus.removeListener('process:msg', listener);
      return God.deleteProcessId(t_key, cb);
    }, new_env.listen_timeout || _constants["default"].GRACEFUL_LISTEN_TIMEOUT);
    return false;
  });
  return false;
}

;
/**
 * Description
 * @method exports
 * @param {} God
 * @return
 */

function _default(God) {
  /**
   * Reload
   * @method softReloadProcessId
   * @param {} id
   * @param {} cb
   * @return CallExpression
   */
  God.softReloadProcessId = function (opts, cb) {
    var id = opts.id;
    var env = opts.env || {};
    if (!(id in God.clusters_db)) return cb(new Error("pm_id ".concat(id, " not available in ").concat(id)));

    if (God.clusters_db[id].pm2_env.status == _constants["default"].ONLINE_STATUS && God.clusters_db[id].pm2_env.exec_mode == 'cluster_mode' && !God.clusters_db[id].pm2_env.wait_ready) {
      _Utility["default"].extend(God.clusters_db[id].pm2_env.env, opts.env);

      _Utility["default"].extendExtraConfig(God.clusters_db[id], opts);

      return softReload(God, id, cb);
    } else {
      console.log('Process %s in a stopped status, starting it', id);
      return God.restartProcessId(opts, cb);
    }
  };
  /**
   * Reload
   * @method reloadProcessId
   * @param {} id
   * @param {} cb
   * @return CallExpression
   */


  God.reloadProcessId = function (opts, cb) {
    var id = opts.id;
    var env = opts.env || {};
    if (!(id in God.clusters_db)) return cb(new Error('PM2 ID unknown'));

    if (God.clusters_db[id].pm2_env.status == _constants["default"].ONLINE_STATUS && God.clusters_db[id].pm2_env.exec_mode == 'cluster_mode') {
      _Utility["default"].extend(God.clusters_db[id].pm2_env.env, opts.env);

      _Utility["default"].extendExtraConfig(God.clusters_db[id], opts);

      var wait_msg = God.clusters_db[id].pm2_env.wait_ready ? 'ready' : 'listening';
      return hardReload(God, id, wait_msg, cb);
    } else {
      console.log('Process %s in a stopped status, starting it', id);
      return God.restartProcessId(opts, cb);
    }
  };
}

;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Hb2QvUmVsb2FkLnRzIl0sIm5hbWVzIjpbInNvZnRSZWxvYWQiLCJHb2QiLCJpZCIsImNiIiwidF9rZXkiLCJjbHVzdGVyc19kYiIsIm9sZF93b3JrZXIiLCJuZXdfZW52IiwiVXRpbGl0eSIsImNsb25lIiwicG0yX2VudiIsInJlc2V0U3RhdGUiLCJyZXN0YXJ0X3RpbWUiLCJwbV9pZCIsImV4ZWN1dGVBcHAiLCJlcnIiLCJuZXdfd29ya2VyIiwidGltZXIiLCJvbkxpc3RlbiIsImNsZWFyVGltZW91dCIsInNvZnRDbGVhbkRlbGV0ZVByb2Nlc3MiLCJjb25zb2xlIiwibG9nIiwib25jZSIsInNldFRpbWVvdXQiLCJyZW1vdmVMaXN0ZW5lciIsImxpc3Rlbl90aW1lb3V0IiwiY3N0IiwiR1JBQ0VGVUxfTElTVEVOX1RJTUVPVVQiLCJjbGVhblVwIiwiZGVsZXRlUHJvY2Vzc0lkIiwic3RhdGUiLCJzZW5kIiwiZXJyb3IiLCJlIiwiR1JBQ0VGVUxfVElNRU9VVCIsImhhcmRSZWxvYWQiLCJ3YWl0X21zZyIsInJlYWR5U2lnbmFsU2VudCIsImxpc3RlbmVyIiwicGFja2V0IiwicmF3IiwicHJvY2VzcyIsIm5hbWUiLCJidXMiLCJvbiIsInNvZnRSZWxvYWRQcm9jZXNzSWQiLCJvcHRzIiwiZW52IiwiRXJyb3IiLCJzdGF0dXMiLCJPTkxJTkVfU1RBVFVTIiwiZXhlY19tb2RlIiwid2FpdF9yZWFkeSIsImV4dGVuZCIsImV4dGVuZEV4dHJhQ29uZmlnIiwicmVzdGFydFByb2Nlc3NJZCIsInJlbG9hZFByb2Nlc3NJZCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0FBS0E7QUFFQTs7Ozs7Ozs7Ozs7QUFNQTs7QUFDQTs7OztBQUVBOzs7Ozs7OztBQVFBLFNBQVNBLFVBQVQsQ0FBb0JDLEdBQXBCLEVBQXlCQyxFQUF6QixFQUE2QkMsRUFBN0IsRUFBaUM7QUFDL0IsTUFBSUMsS0FBSyxHQUFHLFVBQVVGLEVBQXRCLENBRCtCLENBRy9COztBQUNB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QUFlckQsR0FBRyxDQUFDSSxXQUFKLENBQWdCSCxFQUFoQixFQUFvQlEsT0FBcEIsQ0FBNEJzQyxHQUEzQyxFQUFnREQsSUFBSSxDQUFDQyxHQUFyRDs7QUFDQXhDLDBCQUFRK0MsaUJBQVIsQ0FBMEJ0RCxHQUFHLENBQUNJLFdBQUosQ0FBZ0JILEVBQWhCLENBQTFCLEVBQStDNkMsSUFBL0M7O0FBRUEsVUFBSVYsUUFBUSxHQUFHcEMsR0FBRyxDQUFDSSxXQUFKLENBQWdCSCxFQUFoQixFQUFvQlEsT0FBcEIsQ0FBNEIyQyxVQUE1QixHQUF5QyxPQUF6QyxHQUFtRCxXQUFsRTtBQUNBLGFBQU9qQixVQUFVLENBQUNuQyxHQUFELEVBQU1DLEVBQU4sRUFBVW1DLFFBQVYsRUFBb0JsQyxFQUFwQixDQUFqQjtBQUNELEtBUkQsTUFTSztBQUNIa0IsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksNkNBQVosRUFBMkRwQixFQUEzRDtBQUNBLGFBQU9ELEdBQUcsQ0FBQ3VELGdCQUFKLENBQXFCVCxJQUFyQixFQUEyQjVDLEVBQTNCLENBQVA7QUFDRDtBQUNGLEdBcEJEO0FBc0JEOztBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgMjAxMyB0aGUgUE0yIHByb2plY3QgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgbGljZW5zZSB0aGF0XG4gKiBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS5cbiAqL1xuJ3VzZSBzdHJpY3QnO1xuXG4vKipcbiAqIEBmaWxlIFJlbG9hZCBmdW5jdGlvbnMgcmVsYXRlZFxuICogQGF1dGhvciBBbGV4YW5kcmUgU3RyemVsZXdpY3ogPGFzQHVuaXRlY2guaW8+XG4gKiBAcHJvamVjdCBQTTJcbiAqL1xuXG5pbXBvcnQgY3N0ICAgICAgICAgICBmcm9tICcuLi8uLi9jb25zdGFudHMuanMnO1xuaW1wb3J0IFV0aWxpdHkgICAgICAgZnJvbSAnLi4vVXRpbGl0eS5qcyc7XG5cbi8qKlxuICogc29mdFJlbG9hZCB3aWxsIHdhaXQgcGVybWlzc2lvbiBmcm9tIHByb2Nlc3MgdG8gZXhpdFxuICogQG1ldGhvZCBzb2Z0UmVsb2FkXG4gKiBAcGFyYW0ge30gR29kXG4gKiBAcGFyYW0ge30gaWRcbiAqIEBwYXJhbSB7fSBjYlxuICogQHJldHVybiBMaXRlcmFsXG4gKi9cbmZ1bmN0aW9uIHNvZnRSZWxvYWQoR29kLCBpZCwgY2IpIHtcbiAgdmFyIHRfa2V5ID0gJ19vbGRfJyArIGlkO1xuXG4gIC8vIE1vdmUgb2xkIHdvcmtlciB0byB0bXAgaWRcbiAgR29kLmNsdXN0ZXJzX2RiW3Rfa2V5XSA9IEdvZC5jbHVzdGVyc19kYltpZF07XG5cbiAgZGVsZXRlIEdvZC5jbHVzdGVyc19kYltpZF07XG5cbiAgdmFyIG9sZF93b3JrZXIgPSBHb2QuY2x1c3RlcnNfZGJbdF9rZXldO1xuXG4gIC8vIERlZXAgY29weVxuICB2YXIgbmV3X2VudiA9IFV0aWxpdHkuY2xvbmUob2xkX3dvcmtlci5wbTJfZW52KTtcblxuICAvLyBSZXNldCBjcmVhdGVkX2F0IGFuZCB1bnN0YWJsZV9yZXN0YXJ0c1xuICBHb2QucmVzZXRTdGF0ZShuZXdfZW52KTtcblxuICBuZXdfZW52LnJlc3RhcnRfdGltZSArPSAxO1xuXG4gIG9sZF93b3JrZXIucG0yX2Vudi5wbV9pZCA9IHRfa2V5O1xuICBvbGRfd29ya2VyLnBtX2lkID0gdF9rZXk7XG5cbiAgR29kLmV4ZWN1dGVBcHAobmV3X2VudiwgZnVuY3Rpb24oZXJyLCBuZXdfd29ya2VyKSB7XG4gICAgaWYgKGVycikgcmV0dXJuIGNiKGVycik7XG5cbiAgICB2YXIgdGltZXIgPSBudWxsO1xuXG4gICAgdmFyIG9uTGlzdGVuID0gZnVuY3Rpb24gKCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgIHNvZnRDbGVhbkRlbGV0ZVByb2Nlc3MoKTtcbiAgICAgIGNvbnNvbGUubG9nKCctc29mdFJlbG9hZC0gTmV3IHdvcmtlciBsaXN0ZW5pbmcnKTtcbiAgICB9O1xuXG4gICAgLy8gQmluZCB0byBrbm93IHdoZW4gdGhlIG5ldyBwcm9jZXNzIGlzIHVwXG4gICAgbmV3X3dvcmtlci5vbmNlKCdsaXN0ZW5pbmcnLCBvbkxpc3Rlbik7XG5cbiAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICBuZXdfd29ya2VyLnJlbW92ZUxpc3RlbmVyKCdsaXN0ZW5pbmcnLCBvbkxpc3Rlbik7XG4gICAgICBzb2Z0Q2xlYW5EZWxldGVQcm9jZXNzKCk7XG4gICAgfSwgbmV3X2Vudi5saXN0ZW5fdGltZW91dCB8fCBjc3QuR1JBQ0VGVUxfTElTVEVOX1RJTUVPVVQpO1xuXG4gICAgLy8gUmVtb3ZlIG9sZCB3b3JrZXIgcHJvcGVybHlcbiAgICB2YXIgc29mdENsZWFuRGVsZXRlUHJvY2VzcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIHZhciBjbGVhblVwID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICBjb25zb2xlLmxvZygnLXNvZnRSZWxvYWQtIE9sZCB3b3JrZXIgZGlzY29ubmVjdGVkJyk7XG4gICAgICAgIHJldHVybiBHb2QuZGVsZXRlUHJvY2Vzc0lkKHRfa2V5LCBjYik7XG4gICAgICB9O1xuXG4gICAgICBvbGRfd29ya2VyLm9uY2UoJ2Rpc2Nvbm5lY3QnLCBjbGVhblVwKTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgaWYgKG9sZF93b3JrZXIuc3RhdGUgIT0gJ2RlYWQnICYmIG9sZF93b3JrZXIuc3RhdGUgIT0gJ2Rpc2Nvbm5lY3RlZCcpXG4gICAgICAgICAgb2xkX3dvcmtlci5zZW5kICYmIG9sZF93b3JrZXIuc2VuZCgnc2h1dGRvd24nKTtcbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdXb3JrZXIgJWQgaXMgYWxyZWFkeSBkaXNjb25uZWN0ZWQnLCBvbGRfd29ya2VyLnBtMl9lbnYucG1faWQpO1xuICAgICAgICAgIHJldHVybiBHb2QuZGVsZXRlUHJvY2Vzc0lkKHRfa2V5LCBjYik7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICBjb25zb2xlLmVycm9yKCdXb3JrZXIgJWQgaXMgYWxyZWFkeSBkaXNjb25uZWN0ZWQnLCBvbGRfd29ya2VyLnBtMl9lbnYucG1faWQpO1xuICAgICAgICByZXR1cm4gR29kLmRlbGV0ZVByb2Nlc3NJZCh0X2tleSwgY2IpO1xuICAgICAgfVxuXG4gICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICBvbGRfd29ya2VyLnJlbW92ZUxpc3RlbmVyKCdkaXNjb25uZWN0JywgY2xlYW5VcCk7XG4gICAgICAgIHJldHVybiBHb2QuZGVsZXRlUHJvY2Vzc0lkKHRfa2V5LCBjYik7XG4gICAgICB9LCBjc3QuR1JBQ0VGVUxfVElNRU9VVCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0pO1xuICByZXR1cm4gZmFsc2U7XG59O1xuXG4vKipcbiAqIGhhcmRSZWxvYWQgd2lsbCByZWxvYWQgd2l0aG91dCB3YWl0aW5nIHBlcm1pc3Npb24gZnJvbSBwcm9jZXNzXG4gKiBAbWV0aG9kIGhhcmRSZWxvYWRcbiAqIEBwYXJhbSB7fSBHb2RcbiAqIEBwYXJhbSB7fSBpZFxuICogQHBhcmFtIHt9IGNiXG4gKiBAcmV0dXJuIExpdGVyYWxcbiAqL1xuZnVuY3Rpb24gaGFyZFJlbG9hZChHb2QsIGlkLCB3YWl0X21zZywgY2IpIHtcbiAgdmFyIHRfa2V5ID0gJ19vbGRfJyArIGlkO1xuXG4gIC8vIE1vdmUgb2xkIHdvcmtlciB0byB0bXAgaWRcbiAgR29kLmNsdXN0ZXJzX2RiW3Rfa2V5XSA9IEdvZC5jbHVzdGVyc19kYltpZF07XG4gIGRlbGV0ZSBHb2QuY2x1c3RlcnNfZGJbaWRdO1xuXG4gIHZhciBvbGRfd29ya2VyID0gR29kLmNsdXN0ZXJzX2RiW3Rfa2V5XTtcbiAgLy8gRGVlcCBjb3B5XG4gIHZhciBuZXdfZW52ID0gVXRpbGl0eS5jbG9uZShvbGRfd29ya2VyLnBtMl9lbnYpO1xuICBuZXdfZW52LnJlc3RhcnRfdGltZSArPSAxO1xuXG4gIC8vIFJlc2V0IGNyZWF0ZWRfYXQgYW5kIHVuc3RhYmxlX3Jlc3RhcnRzXG4gIEdvZC5yZXNldFN0YXRlKG5ld19lbnYpO1xuXG4gIG9sZF93b3JrZXIucG0yX2Vudi5wbV9pZCA9IHRfa2V5O1xuICBvbGRfd29ya2VyLnBtX2lkID0gdF9rZXk7XG4gIHZhciB0aW1lciA9IG51bGw7XG4gIHZhciByZWFkeVNpZ25hbFNlbnQgPSBmYWxzZTtcblxuICB2YXIgb25MaXN0ZW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICByZWFkeVNpZ25hbFNlbnQgPSB0cnVlO1xuICAgIGNvbnNvbGUubG9nKCctcmVsb2FkLSBOZXcgd29ya2VyIGxpc3RlbmluZycpO1xuICAgIHJldHVybiBHb2QuZGVsZXRlUHJvY2Vzc0lkKHRfa2V5LCBjYik7XG4gIH07XG5cbiAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24gKHBhY2tldCkge1xuICAgIGlmIChwYWNrZXQucmF3ID09PSAncmVhZHknICYmXG4gICAgICAgIHBhY2tldC5wcm9jZXNzLm5hbWUgPT09IG9sZF93b3JrZXIucG0yX2Vudi5uYW1lICYmXG4gICAgICAgIHBhY2tldC5wcm9jZXNzLnBtX2lkID09PSBpZCkge1xuICAgICAgR29kLmJ1cy5yZW1vdmVMaXN0ZW5lcigncHJvY2Vzczptc2cnLCBsaXN0ZW5lcik7XG4gICAgICByZXR1cm4gb25MaXN0ZW4oKTtcbiAgICB9XG4gIH07XG5cbiAgaWYgKHdhaXRfbXNnICE9PSAnbGlzdGVuaW5nJykge1xuICAgIEdvZC5idXMub24oJ3Byb2Nlc3M6bXNnJywgbGlzdGVuZXIpO1xuICB9XG5cbiAgR29kLmV4ZWN1dGVBcHAobmV3X2VudiwgZnVuY3Rpb24oZXJyLCBuZXdfd29ya2VyKSB7XG4gICAgaWYgKGVycikgcmV0dXJuIGNiKGVycik7XG5cbiAgICAvLyBCaW5kIHRvIGtub3cgd2hlbiB0aGUgbmV3IHByb2Nlc3MgaXMgdXBcbiAgICBpZiAod2FpdF9tc2cgPT09ICdsaXN0ZW5pbmcnKSB7XG4gICAgICBuZXdfd29ya2VyLm9uY2UoJ2xpc3RlbmluZycsIG9uTGlzdGVuKTtcbiAgICB9XG5cbiAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICBpZiAocmVhZHlTaWduYWxTZW50KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKHdhaXRfbXNnID09PSAnbGlzdGVuaW5nJylcbiAgICAgICAgbmV3X3dvcmtlci5yZW1vdmVMaXN0ZW5lcih3YWl0X21zZywgb25MaXN0ZW4pO1xuICAgICAgZWxzZVxuICAgICAgICBHb2QuYnVzLnJlbW92ZUxpc3RlbmVyKCdwcm9jZXNzOm1zZycsIGxpc3RlbmVyKTtcblxuICAgICAgcmV0dXJuIEdvZC5kZWxldGVQcm9jZXNzSWQodF9rZXksIGNiKTtcbiAgICB9LCBuZXdfZW52Lmxpc3Rlbl90aW1lb3V0IHx8IGNzdC5HUkFDRUZVTF9MSVNURU5fVElNRU9VVCk7XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH0pO1xuICByZXR1cm4gZmFsc2U7XG59O1xuXG4vKipcbiAqIERlc2NyaXB0aW9uXG4gKiBAbWV0aG9kIGV4cG9ydHNcbiAqIEBwYXJhbSB7fSBHb2RcbiAqIEByZXR1cm5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24oR29kKSB7XG5cbiAgLyoqXG4gICAqIFJlbG9hZFxuICAgKiBAbWV0aG9kIHNvZnRSZWxvYWRQcm9jZXNzSWRcbiAgICogQHBhcmFtIHt9IGlkXG4gICAqIEBwYXJhbSB7fSBjYlxuICAgKiBAcmV0dXJuIENhbGxFeHByZXNzaW9uXG4gICAqL1xuICBHb2Quc29mdFJlbG9hZFByb2Nlc3NJZCA9IGZ1bmN0aW9uKG9wdHMsIGNiKSB7XG4gICAgdmFyIGlkICA9IG9wdHMuaWQ7XG4gICAgdmFyIGVudiA9IG9wdHMuZW52IHx8IHt9O1xuXG4gICAgaWYgKCEoaWQgaW4gR29kLmNsdXN0ZXJzX2RiKSlcbiAgICAgIHJldHVybiBjYihuZXcgRXJyb3IoYHBtX2lkICR7aWR9IG5vdCBhdmFpbGFibGUgaW4gJHtpZH1gKSk7XG5cbiAgICBpZiAoR29kLmNsdXN0ZXJzX2RiW2lkXS5wbTJfZW52LnN0YXR1cyA9PSBjc3QuT05MSU5FX1NUQVRVUyAmJlxuICAgICAgICBHb2QuY2x1c3RlcnNfZGJbaWRdLnBtMl9lbnYuZXhlY19tb2RlID09ICdjbHVzdGVyX21vZGUnICYmXG4gICAgICAgICFHb2QuY2x1c3RlcnNfZGJbaWRdLnBtMl9lbnYud2FpdF9yZWFkeSkge1xuXG4gICAgICBVdGlsaXR5LmV4dGVuZChHb2QuY2x1c3RlcnNfZGJbaWRdLnBtMl9lbnYuZW52LCBvcHRzLmVudik7XG4gICAgICBVdGlsaXR5LmV4dGVuZEV4dHJhQ29uZmlnKEdvZC5jbHVzdGVyc19kYltpZF0sIG9wdHMpO1xuXG4gICAgICByZXR1cm4gc29mdFJlbG9hZChHb2QsIGlkLCBjYik7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coJ1Byb2Nlc3MgJXMgaW4gYSBzdG9wcGVkIHN0YXR1cywgc3RhcnRpbmcgaXQnLCBpZCk7XG4gICAgICByZXR1cm4gR29kLnJlc3RhcnRQcm9jZXNzSWQob3B0cywgY2IpO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogUmVsb2FkXG4gICAqIEBtZXRob2QgcmVsb2FkUHJvY2Vzc0lkXG4gICAqIEBwYXJhbSB7fSBpZFxuICAgKiBAcGFyYW0ge30gY2JcbiAgICogQHJldHVybiBDYWxsRXhwcmVzc2lvblxuICAgKi9cbiAgR29kLnJlbG9hZFByb2Nlc3NJZCA9IGZ1bmN0aW9uKG9wdHMsIGNiKSB7XG4gICAgdmFyIGlkICA9IG9wdHMuaWQ7XG4gICAgdmFyIGVudiA9IG9wdHMuZW52IHx8IHt9O1xuXG4gICAgaWYgKCEoaWQgaW4gR29kLmNsdXN0ZXJzX2RiKSlcbiAgICAgIHJldHVybiBjYihuZXcgRXJyb3IoJ1BNMiBJRCB1bmtub3duJykpO1xuXG4gICAgaWYgKEdvZC5jbHVzdGVyc19kYltpZF0ucG0yX2Vudi5zdGF0dXMgPT0gY3N0Lk9OTElORV9TVEFUVVMgJiZcbiAgICAgICAgR29kLmNsdXN0ZXJzX2RiW2lkXS5wbTJfZW52LmV4ZWNfbW9kZSA9PSAnY2x1c3Rlcl9tb2RlJykge1xuXG4gICAgICBVdGlsaXR5LmV4dGVuZChHb2QuY2x1c3RlcnNfZGJbaWRdLnBtMl9lbnYuZW52LCBvcHRzLmVudik7XG4gICAgICBVdGlsaXR5LmV4dGVuZEV4dHJhQ29uZmlnKEdvZC5jbHVzdGVyc19kYltpZF0sIG9wdHMpO1xuXG4gICAgICB2YXIgd2FpdF9tc2cgPSBHb2QuY2x1c3RlcnNfZGJbaWRdLnBtMl9lbnYud2FpdF9yZWFkeSA/ICdyZWFkeScgOiAnbGlzdGVuaW5nJztcbiAgICAgIHJldHVybiBoYXJkUmVsb2FkKEdvZCwgaWQsIHdhaXRfbXNnLCBjYik7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coJ1Byb2Nlc3MgJXMgaW4gYSBzdG9wcGVkIHN0YXR1cywgc3RhcnRpbmcgaXQnLCBpZCk7XG4gICAgICByZXR1cm4gR29kLnJlc3RhcnRQcm9jZXNzSWQob3B0cywgY2IpO1xuICAgIH1cbiAgfTtcblxufTtcbiJdfQ==
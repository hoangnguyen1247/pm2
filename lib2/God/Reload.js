/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
'use strict';
/**
 * @file Reload functions related
 * @author Alexandre Strzelewicz <as@unitech.io>
 * @project PM2
 */

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _constants = _interopRequireDefault(require("../../constants"));

var _Utility = _interopRequireDefault(require("../Utility"));

/**
 * softReload will wait permission from process to exit
 * @method softReload
 * @param {} God
 * @param {} id
 * @param {} cb
 * @return Literal
 */
function softReload(God, id, cb) {
  var t_key = '_old_' + id; // Move old worker to tmp id

  God.clusters_db[t_key] = God.clusters_db[id];
  delete God.clusters_db[id];
  var old_worker = God.clusters_db[t_key]; // Deep copy

  var new_env = _Utility["default"].clone(old_worker.pm2_env); // Reset created_at and unstable_restarts


  God.resetState(new_env);
  new_env.restart_time += 1;
  old_worker.pm2_env.pm_id = t_key;
  old_worker.pm_id = t_key;
  God.executeApp(new_env, function (err, new_worker) {
    if (err) return cb(err);
    var timer = null;

    var onListen = function onListen() {
      clearTimeout(timer);
      softCleanDeleteProcess();
      console.log('-softReload- New worker listening');
    }; // Bind to know when the new process is up


    new_worker.once('listening', onListen);
    timer = setTimeout(function () {
      new_worker.removeListener('listening', onListen);
      softCleanDeleteProcess();
    }, new_env.listen_timeout || _constants["default"].GRACEFUL_LISTEN_TIMEOUT); // Remove old worker properly

    var softCleanDeleteProcess = function softCleanDeleteProcess() {
      var cleanUp = function cleanUp() {
        clearTimeout(timer);
        console.log('-softReload- Old worker disconnected');
        return God.deleteProcessId(t_key, cb);
      };

      old_worker.once('disconnect', cleanUp);

      try {
        if (old_worker.state != 'dead' && old_worker.state != 'disconnected') old_worker.send && old_worker.send('shutdown');else {
          clearTimeout(timer);
          console.error('Worker %d is already disconnected', old_worker.pm2_env.pm_id);
          return God.deleteProcessId(t_key, cb);
        }
      } catch (e) {
        clearTimeout(timer);
        console.error('Worker %d is already disconnected', old_worker.pm2_env.pm_id);
        return God.deleteProcessId(t_key, cb);
      }

      timer = setTimeout(function () {
        old_worker.removeListener('disconnect', cleanUp);
        return God.deleteProcessId(t_key, cb);
      }, _constants["default"].GRACEFUL_TIMEOUT);
      return false;
    };

    return false;
  });
  return false;
}

;
/**
 * hardReload will reload without waiting permission from process
 * @method hardReload
 * @param {} God
 * @param {} id
 * @param {} cb
 * @return Literal
 */

function hardReload(God, id, wait_msg, cb) {
  var t_key = '_old_' + id; // Move old worker to tmp id

  God.clusters_db[t_key] = God.clusters_db[id];
  delete God.clusters_db[id];
  var old_worker = God.clusters_db[t_key]; // Deep copy

  var new_env = _Utility["default"].clone(old_worker.pm2_env);

  new_env.restart_time += 1; // Reset created_at and unstable_restarts

  God.resetState(new_env);
  old_worker.pm2_env.pm_id = t_key;
  old_worker.pm_id = t_key;
  var timer = null;
  var readySignalSent = false;

  var onListen = function onListen() {
    clearTimeout(timer);
    readySignalSent = true;
    console.log('-reload- New worker listening');
    return God.deleteProcessId(t_key, cb);
  };

  var listener = function listener(packet) {
    if (packet.raw === 'ready' && packet.process.name === old_worker.pm2_env.name && packet.process.pm_id === id) {
      God.bus.removeListener('process:msg', listener);
      return onListen();
    }
  };

  if (wait_msg !== 'listening') {
    God.bus.on('process:msg', listener);
  }

  God.executeApp(new_env, function (err, new_worker) {
    if (err) return cb(err); // Bind to know when the new process is up

    if (wait_msg === 'listening') {
      new_worker.once('listening', onListen);
    }

    timer = setTimeout(function () {
      if (readySignalSent) {
        return;
      }

      if (wait_msg === 'listening') new_worker.removeListener(wait_msg, onListen);else God.bus.removeListener('process:msg', listener);
      return God.deleteProcessId(t_key, cb);
    }, new_env.listen_timeout || _constants["default"].GRACEFUL_LISTEN_TIMEOUT);
    return false;
  });
  return false;
}

;
/**
 * Description
 * @method exports
 * @param {} God
 * @return
 */

function _default(God) {
  /**
   * Reload
   * @method softReloadProcessId
   * @param {} id
   * @param {} cb
   * @return CallExpression
   */
  God.softReloadProcessId = function (opts, cb) {
    var id = opts.id;
    var env = opts.env || {};
    if (!(id in God.clusters_db)) return cb(new Error("pm_id ".concat(id, " not available in ").concat(id)));

    if (God.clusters_db[id].pm2_env.status == _constants["default"].ONLINE_STATUS && God.clusters_db[id].pm2_env.exec_mode == 'cluster_mode' && !God.clusters_db[id].pm2_env.wait_ready) {
      _Utility["default"].extend(God.clusters_db[id].pm2_env.env, opts.env);

      _Utility["default"].extendExtraConfig(God.clusters_db[id], opts);

      return softReload(God, id, cb);
    } else {
      console.log('Process %s in a stopped status, starting it', id);
      return God.restartProcessId(opts, cb);
    }
  };
  /**
   * Reload
   * @method reloadProcessId
   * @param {} id
   * @param {} cb
   * @return CallExpression
   */


  God.reloadProcessId = function (opts, cb) {
    var id = opts.id;
    var env = opts.env || {};
    if (!(id in God.clusters_db)) return cb(new Error('PM2 ID unknown'));

    if (God.clusters_db[id].pm2_env.status == _constants["default"].ONLINE_STATUS && God.clusters_db[id].pm2_env.exec_mode == 'cluster_mode') {
      _Utility["default"].extend(God.clusters_db[id].pm2_env.env, opts.env);

      _Utility["default"].extendExtraConfig(God.clusters_db[id], opts);

      var wait_msg = God.clusters_db[id].pm2_env.wait_ready ? 'ready' : 'listening';
      return hardReload(God, id, wait_msg, cb);
    } else {
      console.log('Process %s in a stopped status, starting it', id);
      return God.restartProcessId(opts, cb);
    }
  };
}

;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Hb2QvUmVsb2FkLnRzIl0sIm5hbWVzIjpbInNvZnRSZWxvYWQiLCJHb2QiLCJpZCIsImNiIiwidF9rZXkiLCJjbHVzdGVyc19kYiIsIm9sZF93b3JrZXIiLCJuZXdfZW52IiwiVXRpbGl0eSIsImNsb25lIiwicG0yX2VudiIsInJlc2V0U3RhdGUiLCJyZXN0YXJ0X3RpbWUiLCJwbV9pZCIsImV4ZWN1dGVBcHAiLCJlcnIiLCJuZXdfd29ya2VyIiwidGltZXIiLCJvbkxpc3RlbiIsImNsZWFyVGltZW91dCIsInNvZnRDbGVhbkRlbGV0ZVByb2Nlc3MiLCJjb25zb2xlIiwibG9nIiwib25jZSIsInNldFRpbWVvdXQiLCJyZW1vdmVMaXN0ZW5lciIsImxpc3Rlbl90aW1lb3V0IiwiY3N0IiwiR1JBQ0VGVUxfTElTVEVOX1RJTUVPVVQiLCJjbGVhblVwIiwiZGVsZXRlUHJvY2Vzc0lkIiwic3RhdGUiLCJzZW5kIiwiZXJyb3IiLCJlIiwiR1JBQ0VGVUxfVElNRU9VVCIsImhhcmRSZWxvYWQiLCJ3YWl0X21zZyIsInJlYWR5U2lnbmFsU2VudCIsImxpc3RlbmVyIiwicGFja2V0IiwicmF3IiwicHJvY2VzcyIsIm5hbWUiLCJidXMiLCJvbiIsInNvZnRSZWxvYWRQcm9jZXNzSWQiLCJvcHRzIiwiZW52IiwiRXJyb3IiLCJzdGF0dXMiLCJPTkxJTkVfU1RBVFVTIiwiZXhlY19tb2RlIiwid2FpdF9yZWFkeSIsImV4dGVuZCIsImV4dGVuZEV4dHJhQ29uZmlnIiwicmVzdGFydFByb2Nlc3NJZCIsInJlbG9hZFByb2Nlc3NJZCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0FBS0E7QUFFQTs7Ozs7Ozs7Ozs7OztBQU1BOztBQUNBOztBQUVBOzs7Ozs7OztBQVFBLFNBQVNBLFVBQVQsQ0FBb0JDLEdBQXBCLEVBQXlCQyxFQUF6QixFQUE2QkMsRUFBN0IsRUFBaUM7QUFDL0IsTUFBSUMsS0FBSyxHQUFHLFVBQVVGLEVBQXRCLENBRCtCLENBRy9COztBQUNB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QVIsQ0FBZXJELEdBQUcsQ0FBQ0ksV0FBSixDQUFnQkgsRUFBaEIsRUFBb0JRLE9BQXBCLENBQTRCc0MsR0FBM0MsRUFBZ0RELElBQUksQ0FBQ0MsR0FBckQ7O0FBQ0F4QywwQkFBUStDLGlCQUFSLENBQTBCdEQsR0FBRyxDQUFDSSxXQUFKLENBQWdCSCxFQUFoQixDQUExQixFQUErQzZDLElBQS9DOztBQUVBLFVBQUlWLFFBQVEsR0FBR3BDLEdBQUcsQ0FBQ0ksV0FBSixDQUFnQkgsRUFBaEIsRUFBb0JRLE9BQXBCLENBQTRCMkMsVUFBNUIsR0FBeUMsT0FBekMsR0FBbUQsV0FBbEU7QUFDQSxhQUFPakIsVUFBVSxDQUFDbkMsR0FBRCxFQUFNQyxFQUFOLEVBQVVtQyxRQUFWLEVBQW9CbEMsRUFBcEIsQ0FBakI7QUFDRCxLQVJELE1BU0s7QUFDSGtCLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLDZDQUFaLEVBQTJEcEIsRUFBM0Q7QUFDQSxhQUFPRCxHQUFHLENBQUN1RCxnQkFBSixDQUFxQlQsSUFBckIsRUFBMkI1QyxFQUEzQixDQUFQO0FBQ0Q7QUFDRixHQXBCRDtBQXNCRDs7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMTMgdGhlIFBNMiBwcm9qZWN0IGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIGxpY2Vuc2UgdGhhdFxuICogY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuXG4gKi9cbid1c2Ugc3RyaWN0JztcblxuLyoqXG4gKiBAZmlsZSBSZWxvYWQgZnVuY3Rpb25zIHJlbGF0ZWRcbiAqIEBhdXRob3IgQWxleGFuZHJlIFN0cnplbGV3aWN6IDxhc0B1bml0ZWNoLmlvPlxuICogQHByb2plY3QgUE0yXG4gKi9cblxuaW1wb3J0IGNzdCBmcm9tICcuLi8uLi9jb25zdGFudHMnO1xuaW1wb3J0IFV0aWxpdHkgZnJvbSAnLi4vVXRpbGl0eSc7XG5cbi8qKlxuICogc29mdFJlbG9hZCB3aWxsIHdhaXQgcGVybWlzc2lvbiBmcm9tIHByb2Nlc3MgdG8gZXhpdFxuICogQG1ldGhvZCBzb2Z0UmVsb2FkXG4gKiBAcGFyYW0ge30gR29kXG4gKiBAcGFyYW0ge30gaWRcbiAqIEBwYXJhbSB7fSBjYlxuICogQHJldHVybiBMaXRlcmFsXG4gKi9cbmZ1bmN0aW9uIHNvZnRSZWxvYWQoR29kLCBpZCwgY2IpIHtcbiAgdmFyIHRfa2V5ID0gJ19vbGRfJyArIGlkO1xuXG4gIC8vIE1vdmUgb2xkIHdvcmtlciB0byB0bXAgaWRcbiAgR29kLmNsdXN0ZXJzX2RiW3Rfa2V5XSA9IEdvZC5jbHVzdGVyc19kYltpZF07XG5cbiAgZGVsZXRlIEdvZC5jbHVzdGVyc19kYltpZF07XG5cbiAgdmFyIG9sZF93b3JrZXIgPSBHb2QuY2x1c3RlcnNfZGJbdF9rZXldO1xuXG4gIC8vIERlZXAgY29weVxuICB2YXIgbmV3X2VudiA9IFV0aWxpdHkuY2xvbmUob2xkX3dvcmtlci5wbTJfZW52KTtcblxuICAvLyBSZXNldCBjcmVhdGVkX2F0IGFuZCB1bnN0YWJsZV9yZXN0YXJ0c1xuICBHb2QucmVzZXRTdGF0ZShuZXdfZW52KTtcblxuICBuZXdfZW52LnJlc3RhcnRfdGltZSArPSAxO1xuXG4gIG9sZF93b3JrZXIucG0yX2Vudi5wbV9pZCA9IHRfa2V5O1xuICBvbGRfd29ya2VyLnBtX2lkID0gdF9rZXk7XG5cbiAgR29kLmV4ZWN1dGVBcHAobmV3X2VudiwgZnVuY3Rpb24gKGVyciwgbmV3X3dvcmtlcikge1xuICAgIGlmIChlcnIpIHJldHVybiBjYihlcnIpO1xuXG4gICAgdmFyIHRpbWVyID0gbnVsbDtcblxuICAgIHZhciBvbkxpc3RlbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICBzb2Z0Q2xlYW5EZWxldGVQcm9jZXNzKCk7XG4gICAgICBjb25zb2xlLmxvZygnLXNvZnRSZWxvYWQtIE5ldyB3b3JrZXIgbGlzdGVuaW5nJyk7XG4gICAgfTtcblxuICAgIC8vIEJpbmQgdG8ga25vdyB3aGVuIHRoZSBuZXcgcHJvY2VzcyBpcyB1cFxuICAgIG5ld193b3JrZXIub25jZSgnbGlzdGVuaW5nJywgb25MaXN0ZW4pO1xuXG4gICAgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgIG5ld193b3JrZXIucmVtb3ZlTGlzdGVuZXIoJ2xpc3RlbmluZycsIG9uTGlzdGVuKTtcbiAgICAgIHNvZnRDbGVhbkRlbGV0ZVByb2Nlc3MoKTtcbiAgICB9LCBuZXdfZW52Lmxpc3Rlbl90aW1lb3V0IHx8IGNzdC5HUkFDRUZVTF9MSVNURU5fVElNRU9VVCk7XG5cbiAgICAvLyBSZW1vdmUgb2xkIHdvcmtlciBwcm9wZXJseVxuICAgIHZhciBzb2Z0Q2xlYW5EZWxldGVQcm9jZXNzID0gZnVuY3Rpb24gKCkge1xuICAgICAgdmFyIGNsZWFuVXAgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgIGNvbnNvbGUubG9nKCctc29mdFJlbG9hZC0gT2xkIHdvcmtlciBkaXNjb25uZWN0ZWQnKTtcbiAgICAgICAgcmV0dXJuIEdvZC5kZWxldGVQcm9jZXNzSWQodF9rZXksIGNiKTtcbiAgICAgIH07XG5cbiAgICAgIG9sZF93b3JrZXIub25jZSgnZGlzY29ubmVjdCcsIGNsZWFuVXApO1xuXG4gICAgICB0cnkge1xuICAgICAgICBpZiAob2xkX3dvcmtlci5zdGF0ZSAhPSAnZGVhZCcgJiYgb2xkX3dvcmtlci5zdGF0ZSAhPSAnZGlzY29ubmVjdGVkJylcbiAgICAgICAgICBvbGRfd29ya2VyLnNlbmQgJiYgb2xkX3dvcmtlci5zZW5kKCdzaHV0ZG93bicpO1xuICAgICAgICBlbHNlIHtcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1dvcmtlciAlZCBpcyBhbHJlYWR5IGRpc2Nvbm5lY3RlZCcsIG9sZF93b3JrZXIucG0yX2Vudi5wbV9pZCk7XG4gICAgICAgICAgcmV0dXJuIEdvZC5kZWxldGVQcm9jZXNzSWQodF9rZXksIGNiKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICBjb25zb2xlLmVycm9yKCdXb3JrZXIgJWQgaXMgYWxyZWFkeSBkaXNjb25uZWN0ZWQnLCBvbGRfd29ya2VyLnBtMl9lbnYucG1faWQpO1xuICAgICAgICByZXR1cm4gR29kLmRlbGV0ZVByb2Nlc3NJZCh0X2tleSwgY2IpO1xuICAgICAgfVxuXG4gICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICBvbGRfd29ya2VyLnJlbW92ZUxpc3RlbmVyKCdkaXNjb25uZWN0JywgY2xlYW5VcCk7XG4gICAgICAgIHJldHVybiBHb2QuZGVsZXRlUHJvY2Vzc0lkKHRfa2V5LCBjYik7XG4gICAgICB9LCBjc3QuR1JBQ0VGVUxfVElNRU9VVCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0pO1xuICByZXR1cm4gZmFsc2U7XG59O1xuXG4vKipcbiAqIGhhcmRSZWxvYWQgd2lsbCByZWxvYWQgd2l0aG91dCB3YWl0aW5nIHBlcm1pc3Npb24gZnJvbSBwcm9jZXNzXG4gKiBAbWV0aG9kIGhhcmRSZWxvYWRcbiAqIEBwYXJhbSB7fSBHb2RcbiAqIEBwYXJhbSB7fSBpZFxuICogQHBhcmFtIHt9IGNiXG4gKiBAcmV0dXJuIExpdGVyYWxcbiAqL1xuZnVuY3Rpb24gaGFyZFJlbG9hZChHb2QsIGlkLCB3YWl0X21zZywgY2IpIHtcbiAgdmFyIHRfa2V5ID0gJ19vbGRfJyArIGlkO1xuXG4gIC8vIE1vdmUgb2xkIHdvcmtlciB0byB0bXAgaWRcbiAgR29kLmNsdXN0ZXJzX2RiW3Rfa2V5XSA9IEdvZC5jbHVzdGVyc19kYltpZF07XG4gIGRlbGV0ZSBHb2QuY2x1c3RlcnNfZGJbaWRdO1xuXG4gIHZhciBvbGRfd29ya2VyID0gR29kLmNsdXN0ZXJzX2RiW3Rfa2V5XTtcbiAgLy8gRGVlcCBjb3B5XG4gIHZhciBuZXdfZW52ID0gVXRpbGl0eS5jbG9uZShvbGRfd29ya2VyLnBtMl9lbnYpO1xuICBuZXdfZW52LnJlc3RhcnRfdGltZSArPSAxO1xuXG4gIC8vIFJlc2V0IGNyZWF0ZWRfYXQgYW5kIHVuc3RhYmxlX3Jlc3RhcnRzXG4gIEdvZC5yZXNldFN0YXRlKG5ld19lbnYpO1xuXG4gIG9sZF93b3JrZXIucG0yX2Vudi5wbV9pZCA9IHRfa2V5O1xuICBvbGRfd29ya2VyLnBtX2lkID0gdF9rZXk7XG4gIHZhciB0aW1lciA9IG51bGw7XG4gIHZhciByZWFkeVNpZ25hbFNlbnQgPSBmYWxzZTtcblxuICB2YXIgb25MaXN0ZW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICByZWFkeVNpZ25hbFNlbnQgPSB0cnVlO1xuICAgIGNvbnNvbGUubG9nKCctcmVsb2FkLSBOZXcgd29ya2VyIGxpc3RlbmluZycpO1xuICAgIHJldHVybiBHb2QuZGVsZXRlUHJvY2Vzc0lkKHRfa2V5LCBjYik7XG4gIH07XG5cbiAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24gKHBhY2tldCkge1xuICAgIGlmIChwYWNrZXQucmF3ID09PSAncmVhZHknICYmXG4gICAgICBwYWNrZXQucHJvY2Vzcy5uYW1lID09PSBvbGRfd29ya2VyLnBtMl9lbnYubmFtZSAmJlxuICAgICAgcGFja2V0LnByb2Nlc3MucG1faWQgPT09IGlkKSB7XG4gICAgICBHb2QuYnVzLnJlbW92ZUxpc3RlbmVyKCdwcm9jZXNzOm1zZycsIGxpc3RlbmVyKTtcbiAgICAgIHJldHVybiBvbkxpc3RlbigpO1xuICAgIH1cbiAgfTtcblxuICBpZiAod2FpdF9tc2cgIT09ICdsaXN0ZW5pbmcnKSB7XG4gICAgR29kLmJ1cy5vbigncHJvY2Vzczptc2cnLCBsaXN0ZW5lcik7XG4gIH1cblxuICBHb2QuZXhlY3V0ZUFwcChuZXdfZW52LCBmdW5jdGlvbiAoZXJyLCBuZXdfd29ya2VyKSB7XG4gICAgaWYgKGVycikgcmV0dXJuIGNiKGVycik7XG5cbiAgICAvLyBCaW5kIHRvIGtub3cgd2hlbiB0aGUgbmV3IHByb2Nlc3MgaXMgdXBcbiAgICBpZiAod2FpdF9tc2cgPT09ICdsaXN0ZW5pbmcnKSB7XG4gICAgICBuZXdfd29ya2VyLm9uY2UoJ2xpc3RlbmluZycsIG9uTGlzdGVuKTtcbiAgICB9XG5cbiAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgaWYgKHJlYWR5U2lnbmFsU2VudCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmICh3YWl0X21zZyA9PT0gJ2xpc3RlbmluZycpXG4gICAgICAgIG5ld193b3JrZXIucmVtb3ZlTGlzdGVuZXIod2FpdF9tc2csIG9uTGlzdGVuKTtcbiAgICAgIGVsc2VcbiAgICAgICAgR29kLmJ1cy5yZW1vdmVMaXN0ZW5lcigncHJvY2Vzczptc2cnLCBsaXN0ZW5lcik7XG5cbiAgICAgIHJldHVybiBHb2QuZGVsZXRlUHJvY2Vzc0lkKHRfa2V5LCBjYik7XG4gICAgfSwgbmV3X2Vudi5saXN0ZW5fdGltZW91dCB8fCBjc3QuR1JBQ0VGVUxfTElTVEVOX1RJTUVPVVQpO1xuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9KTtcbiAgcmV0dXJuIGZhbHNlO1xufTtcblxuLyoqXG4gKiBEZXNjcmlwdGlvblxuICogQG1ldGhvZCBleHBvcnRzXG4gKiBAcGFyYW0ge30gR29kXG4gKiBAcmV0dXJuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChHb2QpIHtcblxuICAvKipcbiAgICogUmVsb2FkXG4gICAqIEBtZXRob2Qgc29mdFJlbG9hZFByb2Nlc3NJZFxuICAgKiBAcGFyYW0ge30gaWRcbiAgICogQHBhcmFtIHt9IGNiXG4gICAqIEByZXR1cm4gQ2FsbEV4cHJlc3Npb25cbiAgICovXG4gIEdvZC5zb2Z0UmVsb2FkUHJvY2Vzc0lkID0gZnVuY3Rpb24gKG9wdHMsIGNiKSB7XG4gICAgdmFyIGlkID0gb3B0cy5pZDtcbiAgICB2YXIgZW52ID0gb3B0cy5lbnYgfHwge307XG5cbiAgICBpZiAoIShpZCBpbiBHb2QuY2x1c3RlcnNfZGIpKVxuICAgICAgcmV0dXJuIGNiKG5ldyBFcnJvcihgcG1faWQgJHtpZH0gbm90IGF2YWlsYWJsZSBpbiAke2lkfWApKTtcblxuICAgIGlmIChHb2QuY2x1c3RlcnNfZGJbaWRdLnBtMl9lbnYuc3RhdHVzID09IGNzdC5PTkxJTkVfU1RBVFVTICYmXG4gICAgICBHb2QuY2x1c3RlcnNfZGJbaWRdLnBtMl9lbnYuZXhlY19tb2RlID09ICdjbHVzdGVyX21vZGUnICYmXG4gICAgICAhR29kLmNsdXN0ZXJzX2RiW2lkXS5wbTJfZW52LndhaXRfcmVhZHkpIHtcblxuICAgICAgVXRpbGl0eS5leHRlbmQoR29kLmNsdXN0ZXJzX2RiW2lkXS5wbTJfZW52LmVudiwgb3B0cy5lbnYpO1xuICAgICAgVXRpbGl0eS5leHRlbmRFeHRyYUNvbmZpZyhHb2QuY2x1c3RlcnNfZGJbaWRdLCBvcHRzKTtcblxuICAgICAgcmV0dXJuIHNvZnRSZWxvYWQoR29kLCBpZCwgY2IpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKCdQcm9jZXNzICVzIGluIGEgc3RvcHBlZCBzdGF0dXMsIHN0YXJ0aW5nIGl0JywgaWQpO1xuICAgICAgcmV0dXJuIEdvZC5yZXN0YXJ0UHJvY2Vzc0lkKG9wdHMsIGNiKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFJlbG9hZFxuICAgKiBAbWV0aG9kIHJlbG9hZFByb2Nlc3NJZFxuICAgKiBAcGFyYW0ge30gaWRcbiAgICogQHBhcmFtIHt9IGNiXG4gICAqIEByZXR1cm4gQ2FsbEV4cHJlc3Npb25cbiAgICovXG4gIEdvZC5yZWxvYWRQcm9jZXNzSWQgPSBmdW5jdGlvbiAob3B0cywgY2IpIHtcbiAgICB2YXIgaWQgPSBvcHRzLmlkO1xuICAgIHZhciBlbnYgPSBvcHRzLmVudiB8fCB7fTtcblxuICAgIGlmICghKGlkIGluIEdvZC5jbHVzdGVyc19kYikpXG4gICAgICByZXR1cm4gY2IobmV3IEVycm9yKCdQTTIgSUQgdW5rbm93bicpKTtcblxuICAgIGlmIChHb2QuY2x1c3RlcnNfZGJbaWRdLnBtMl9lbnYuc3RhdHVzID09IGNzdC5PTkxJTkVfU1RBVFVTICYmXG4gICAgICBHb2QuY2x1c3RlcnNfZGJbaWRdLnBtMl9lbnYuZXhlY19tb2RlID09ICdjbHVzdGVyX21vZGUnKSB7XG5cbiAgICAgIFV0aWxpdHkuZXh0ZW5kKEdvZC5jbHVzdGVyc19kYltpZF0ucG0yX2Vudi5lbnYsIG9wdHMuZW52KTtcbiAgICAgIFV0aWxpdHkuZXh0ZW5kRXh0cmFDb25maWcoR29kLmNsdXN0ZXJzX2RiW2lkXSwgb3B0cyk7XG5cbiAgICAgIHZhciB3YWl0X21zZyA9IEdvZC5jbHVzdGVyc19kYltpZF0ucG0yX2Vudi53YWl0X3JlYWR5ID8gJ3JlYWR5JyA6ICdsaXN0ZW5pbmcnO1xuICAgICAgcmV0dXJuIGhhcmRSZWxvYWQoR29kLCBpZCwgd2FpdF9tc2csIGNiKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZygnUHJvY2VzcyAlcyBpbiBhIHN0b3BwZWQgc3RhdHVzLCBzdGFydGluZyBpdCcsIGlkKTtcbiAgICAgIHJldHVybiBHb2QucmVzdGFydFByb2Nlc3NJZChvcHRzLCBjYik7XG4gICAgfVxuICB9O1xuXG59O1xuIl19
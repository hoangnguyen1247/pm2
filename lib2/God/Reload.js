/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
'use strict';
/**
 * @file Reload functions related
 * @author Alexandre Strzelewicz <as@unitech.io>
 * @project PM2
 */

var _constants = _interopRequireDefault(require("../../constants.js"));

var _Utility = _interopRequireDefault(require("../Utility.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/**
 * softReload will wait permission from process to exit
 * @method softReload
 * @param {} God
 * @param {} id
 * @param {} cb
 * @return Literal
 */
function softReload(God, id, cb) {
  var t_key = '_old_' + id; // Move old worker to tmp id

  God.clusters_db[t_key] = God.clusters_db[id];
  delete God.clusters_db[id];
  var old_worker = God.clusters_db[t_key]; // Deep copy

  var new_env = _Utility["default"].clone(old_worker.pm2_env); // Reset created_at and unstable_restarts


  God.resetState(new_env);
  new_env.restart_time += 1;
  old_worker.pm2_env.pm_id = t_key;
  old_worker.pm_id = t_key;
  God.executeApp(new_env, function (err, new_worker) {
    if (err) return cb(err);
    var timer = null;

    var onListen = function onListen() {
      clearTimeout(timer);
      softCleanDeleteProcess();
      console.log('-softReload- New worker listening');
    }; // Bind to know when the new process is up


    new_worker.once('listening', onListen);
    timer = setTimeout(function () {
      new_worker.removeListener('listening', onListen);
      softCleanDeleteProcess();
    }, new_env.listen_timeout || _constants["default"].GRACEFUL_LISTEN_TIMEOUT); // Remove old worker properly

    var softCleanDeleteProcess = function softCleanDeleteProcess() {
      var cleanUp = function cleanUp() {
        clearTimeout(timer);
        console.log('-softReload- Old worker disconnected');
        return God.deleteProcessId(t_key, cb);
      };

      old_worker.once('disconnect', cleanUp);

      try {
        if (old_worker.state != 'dead' && old_worker.state != 'disconnected') old_worker.send && old_worker.send('shutdown');else {
          clearTimeout(timer);
          console.error('Worker %d is already disconnected', old_worker.pm2_env.pm_id);
          return God.deleteProcessId(t_key, cb);
        }
      } catch (e) {
        clearTimeout(timer);
        console.error('Worker %d is already disconnected', old_worker.pm2_env.pm_id);
        return God.deleteProcessId(t_key, cb);
      }

      timer = setTimeout(function () {
        old_worker.removeListener('disconnect', cleanUp);
        return God.deleteProcessId(t_key, cb);
      }, _constants["default"].GRACEFUL_TIMEOUT);
      return false;
    };

    return false;
  });
  return false;
}

;
/**
 * hardReload will reload without waiting permission from process
 * @method hardReload
 * @param {} God
 * @param {} id
 * @param {} cb
 * @return Literal
 */

function hardReload(God, id, wait_msg, cb) {
  var t_key = '_old_' + id; // Move old worker to tmp id

  God.clusters_db[t_key] = God.clusters_db[id];
  delete God.clusters_db[id];
  var old_worker = God.clusters_db[t_key]; // Deep copy

  var new_env = _Utility["default"].clone(old_worker.pm2_env);

  new_env.restart_time += 1; // Reset created_at and unstable_restarts

  God.resetState(new_env);
  old_worker.pm2_env.pm_id = t_key;
  old_worker.pm_id = t_key;
  var timer = null;
  var readySignalSent = false;

  var onListen = function onListen() {
    clearTimeout(timer);
    readySignalSent = true;
    console.log('-reload- New worker listening');
    return God.deleteProcessId(t_key, cb);
  };

  var listener = function listener(packet) {
    if (packet.raw === 'ready' && packet.process.name === old_worker.pm2_env.name && packet.process.pm_id === id) {
      God.bus.removeListener('process:msg', listener);
      return onListen();
    }
  };

  if (wait_msg !== 'listening') {
    God.bus.on('process:msg', listener);
  }

  God.executeApp(new_env, function (err, new_worker) {
    if (err) return cb(err); // Bind to know when the new process is up

    if (wait_msg === 'listening') {
      new_worker.once('listening', onListen);
    }

    timer = setTimeout(function () {
      if (readySignalSent) {
        return;
      }

      if (wait_msg === 'listening') new_worker.removeListener(wait_msg, onListen);else God.bus.removeListener('process:msg', listener);
      return God.deleteProcessId(t_key, cb);
    }, new_env.listen_timeout || _constants["default"].GRACEFUL_LISTEN_TIMEOUT);
    return false;
  });
  return false;
}

;
/**
 * Description
 * @method exports
 * @param {} God
 * @return
 */

module.exports = function (God) {
  /**
   * Reload
   * @method softReloadProcessId
   * @param {} id
   * @param {} cb
   * @return CallExpression
   */
  God.softReloadProcessId = function (opts, cb) {
    var id = opts.id;
    var env = opts.env || {};
    if (!(id in God.clusters_db)) return cb(new Error("pm_id ".concat(id, " not available in ").concat(id)));

    if (God.clusters_db[id].pm2_env.status == _constants["default"].ONLINE_STATUS && God.clusters_db[id].pm2_env.exec_mode == 'cluster_mode' && !God.clusters_db[id].pm2_env.wait_ready) {
      _Utility["default"].extend(God.clusters_db[id].pm2_env.env, opts.env);

      _Utility["default"].extendExtraConfig(God.clusters_db[id], opts);

      return softReload(God, id, cb);
    } else {
      console.log('Process %s in a stopped status, starting it', id);
      return God.restartProcessId(opts, cb);
    }
  };
  /**
   * Reload
   * @method reloadProcessId
   * @param {} id
   * @param {} cb
   * @return CallExpression
   */


  God.reloadProcessId = function (opts, cb) {
    var id = opts.id;
    var env = opts.env || {};
    if (!(id in God.clusters_db)) return cb(new Error('PM2 ID unknown'));

    if (God.clusters_db[id].pm2_env.status == _constants["default"].ONLINE_STATUS && God.clusters_db[id].pm2_env.exec_mode == 'cluster_mode') {
      _Utility["default"].extend(God.clusters_db[id].pm2_env.env, opts.env);

      _Utility["default"].extendExtraConfig(God.clusters_db[id], opts);

      var wait_msg = God.clusters_db[id].pm2_env.wait_ready ? 'ready' : 'listening';
      return hardReload(God, id, wait_msg, cb);
    } else {
      console.log('Process %s in a stopped status, starting it', id);
      return God.restartProcessId(opts, cb);
    }
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Hb2QvUmVsb2FkLnRzIl0sIm5hbWVzIjpbInNvZnRSZWxvYWQiLCJHb2QiLCJpZCIsImNiIiwidF9rZXkiLCJjbHVzdGVyc19kYiIsIm9sZF93b3JrZXIiLCJuZXdfZW52IiwiVXRpbGl0eSIsImNsb25lIiwicG0yX2VudiIsInJlc2V0U3RhdGUiLCJyZXN0YXJ0X3RpbWUiLCJwbV9pZCIsImV4ZWN1dGVBcHAiLCJlcnIiLCJuZXdfd29ya2VyIiwidGltZXIiLCJvbkxpc3RlbiIsImNsZWFyVGltZW91dCIsInNvZnRDbGVhbkRlbGV0ZVByb2Nlc3MiLCJjb25zb2xlIiwibG9nIiwib25jZSIsInNldFRpbWVvdXQiLCJyZW1vdmVMaXN0ZW5lciIsImxpc3Rlbl90aW1lb3V0IiwiY3N0IiwiR1JBQ0VGVUxfTElTVEVOX1RJTUVPVVQiLCJjbGVhblVwIiwiZGVsZXRlUHJvY2Vzc0lkIiwic3RhdGUiLCJzZW5kIiwiZXJyb3IiLCJlIiwiR1JBQ0VGVUxfVElNRU9VVCIsImhhcmRSZWxvYWQiLCJ3YWl0X21zZyIsInJlYWR5U2lnbmFsU2VudCIsImxpc3RlbmVyIiwicGFja2V0IiwicmF3IiwicHJvY2VzcyIsIm5hbWUiLCJidXMiLCJvbiIsIm1vZHVsZSIsImV4cG9ydHMiLCJzb2Z0UmVsb2FkUHJvY2Vzc0lkIiwib3B0cyIsImVudiIsIkVycm9yIiwic3RhdHVzIiwiT05MSU5FX1NUQVRVUyIsImV4ZWNfbW9kZSIsIndhaXRfcmVhZHkiLCJleHRlbmQiLCJleHRlbmRFeHRyYUNvbmZpZyIsInJlc3RhcnRQcm9jZXNzSWQiLCJyZWxvYWRQcm9jZXNzSWQiXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQUtBO0FBRUE7Ozs7OztBQU1BOztBQUNBOzs7O0FBRUE7Ozs7Ozs7O0FBUUEsU0FBU0EsVUFBVCxDQUFvQkMsR0FBcEIsRUFBeUJDLEVBQXpCLEVBQTZCQyxFQUE3QixFQUFpQztBQUMvQixNQUFJQyxLQUFLLEdBQUcsVUFBVUYsRUFBdEIsQ0FE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eUMsY0FEN0MsRUFDNkQ7QUFFM0Q5QywwQkFBUWdELE1BQVIsQ0FBZXZELEdBQUcsQ0FBQ0ksV0FBSixDQUFnQkgsRUFBaEIsRUFBb0JRLE9BQXBCLENBQTRCd0MsR0FBM0MsRUFBZ0RELElBQUksQ0FBQ0MsR0FBckQ7O0FBQ0ExQywwQkFBUWlELGlCQUFSLENBQTBCeEQsR0FBRyxDQUFDSSxXQUFKLENBQWdCSCxFQUFoQixDQUExQixFQUErQytDLElBQS9DOztBQUVBLFVBQUlaLFFBQVEsR0FBR3BDLEdBQUcsQ0FBQ0ksV0FBSixDQUFnQkgsRUFBaEIsRUFBb0JRLE9BQXBCLENBQTRCNkMsVUFBNUIsR0FBeUMsT0FBekMsR0FBbUQsV0FBbEU7QUFDQSxhQUFPbkIsVUFBVSxDQUFDbkMsR0FBRCxFQUFNQyxFQUFOLEVBQVVtQyxRQUFWLEVBQW9CbEMsRUFBcEIsQ0FBakI7QUFDRCxLQVJELE1BU0s7QUFDSGtCLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLDZDQUFaLEVBQTJEcEIsRUFBM0Q7QUFDQSxhQUFPRCxHQUFHLENBQUN5RCxnQkFBSixDQUFxQlQsSUFBckIsRUFBMkI5QyxFQUEzQixDQUFQO0FBQ0Q7QUFDRixHQXBCRDtBQXNCRCxDQTVERCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgMjAxMyB0aGUgUE0yIHByb2plY3QgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBsaWNlbnNlIHRoYXRcclxuICogY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuXHJcbiAqL1xyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4vKipcclxuICogQGZpbGUgUmVsb2FkIGZ1bmN0aW9ucyByZWxhdGVkXHJcbiAqIEBhdXRob3IgQWxleGFuZHJlIFN0cnplbGV3aWN6IDxhc0B1bml0ZWNoLmlvPlxyXG4gKiBAcHJvamVjdCBQTTJcclxuICovXHJcblxyXG5pbXBvcnQgY3N0ICAgICAgICAgICBmcm9tICcuLi8uLi9jb25zdGFudHMuanMnO1xyXG5pbXBvcnQgVXRpbGl0eSAgICAgICBmcm9tICcuLi9VdGlsaXR5LmpzJztcclxuXHJcbi8qKlxyXG4gKiBzb2Z0UmVsb2FkIHdpbGwgd2FpdCBwZXJtaXNzaW9uIGZyb20gcHJvY2VzcyB0byBleGl0XHJcbiAqIEBtZXRob2Qgc29mdFJlbG9hZFxyXG4gKiBAcGFyYW0ge30gR29kXHJcbiAqIEBwYXJhbSB7fSBpZFxyXG4gKiBAcGFyYW0ge30gY2JcclxuICogQHJldHVybiBMaXRlcmFsXHJcbiAqL1xyXG5mdW5jdGlvbiBzb2Z0UmVsb2FkKEdvZCwgaWQsIGNiKSB7XHJcbiAgdmFyIHRfa2V5ID0gJ19vbGRfJyArIGlkO1xyXG5cclxuICAvLyBNb3ZlIG9sZCB3b3JrZXIgdG8gdG1wIGlkXHJcbiAgR29kLmNsdXN0ZXJzX2RiW3Rfa2V5XSA9IEdvZC5jbHVzdGVyc19kYltpZF07XHJcblxyXG4gIGRlbGV0ZSBHb2QuY2x1c3RlcnNfZGJbaWRdO1xyXG5cclxuICB2YXIgb2xkX3dvcmtlciA9IEdvZC5jbHVzdGVyc19kYlt0X2tleV07XHJcblxyXG4gIC8vIERlZXAgY29weVxyXG4gIHZhciBuZXdfZW52ID0gVXRpbGl0eS5jbG9uZShvbGRfd29ya2VyLnBtMl9lbnYpO1xyXG5cclxuICAvLyBSZXNldCBjcmVhdGVkX2F0IGFuZCB1bnN0YWJsZV9yZXN0YXJ0c1xyXG4gIEdvZC5yZXNldFN0YXRlKG5ld19lbnYpO1xyXG5cclxuICBuZXdfZW52LnJlc3RhcnRfdGltZSArPSAxO1xyXG5cclxuICBvbGRfd29ya2VyLnBtMl9lbnYucG1faWQgPSB0X2tleTtcclxuICBvbGRfd29ya2VyLnBtX2lkID0gdF9rZXk7XHJcblxyXG4gIEdvZC5leGVjdXRlQXBwKG5ld19lbnYsIGZ1bmN0aW9uKGVyciwgbmV3X3dvcmtlcikge1xyXG4gICAgaWYgKGVycikgcmV0dXJuIGNiKGVycik7XHJcblxyXG4gICAgdmFyIHRpbWVyID0gbnVsbDtcclxuXHJcbiAgICB2YXIgb25MaXN0ZW4gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XHJcbiAgICAgIHNvZnRDbGVhbkRlbGV0ZVByb2Nlc3MoKTtcclxuICAgICAgY29uc29sZS5sb2coJy1zb2Z0UmVsb2FkLSBOZXcgd29ya2VyIGxpc3RlbmluZycpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBCaW5kIHRvIGtub3cgd2hlbiB0aGUgbmV3IHByb2Nlc3MgaXMgdXBcclxuICAgIG5ld193b3JrZXIub25jZSgnbGlzdGVuaW5nJywgb25MaXN0ZW4pO1xyXG5cclxuICAgIHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHtcclxuICAgICAgbmV3X3dvcmtlci5yZW1vdmVMaXN0ZW5lcignbGlzdGVuaW5nJywgb25MaXN0ZW4pO1xyXG4gICAgICBzb2Z0Q2xlYW5EZWxldGVQcm9jZXNzKCk7XHJcbiAgICB9LCBuZXdfZW52Lmxpc3Rlbl90aW1lb3V0IHx8IGNzdC5HUkFDRUZVTF9MSVNURU5fVElNRU9VVCk7XHJcblxyXG4gICAgLy8gUmVtb3ZlIG9sZCB3b3JrZXIgcHJvcGVybHlcclxuICAgIHZhciBzb2Z0Q2xlYW5EZWxldGVQcm9jZXNzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICB2YXIgY2xlYW5VcCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCctc29mdFJlbG9hZC0gT2xkIHdvcmtlciBkaXNjb25uZWN0ZWQnKTtcclxuICAgICAgICByZXR1cm4gR29kLmRlbGV0ZVByb2Nlc3NJZCh0X2tleSwgY2IpO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgb2xkX3dvcmtlci5vbmNlKCdkaXNjb25uZWN0JywgY2xlYW5VcCk7XHJcblxyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGlmIChvbGRfd29ya2VyLnN0YXRlICE9ICdkZWFkJyAmJiBvbGRfd29ya2VyLnN0YXRlICE9ICdkaXNjb25uZWN0ZWQnKVxyXG4gICAgICAgICAgb2xkX3dvcmtlci5zZW5kICYmIG9sZF93b3JrZXIuc2VuZCgnc2h1dGRvd24nKTtcclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdXb3JrZXIgJWQgaXMgYWxyZWFkeSBkaXNjb25uZWN0ZWQnLCBvbGRfd29ya2VyLnBtMl9lbnYucG1faWQpO1xyXG4gICAgICAgICAgcmV0dXJuIEdvZC5kZWxldGVQcm9jZXNzSWQodF9rZXksIGNiKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gY2F0Y2goZSkge1xyXG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcignV29ya2VyICVkIGlzIGFscmVhZHkgZGlzY29ubmVjdGVkJywgb2xkX3dvcmtlci5wbTJfZW52LnBtX2lkKTtcclxuICAgICAgICByZXR1cm4gR29kLmRlbGV0ZVByb2Nlc3NJZCh0X2tleSwgY2IpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIG9sZF93b3JrZXIucmVtb3ZlTGlzdGVuZXIoJ2Rpc2Nvbm5lY3QnLCBjbGVhblVwKTtcclxuICAgICAgICByZXR1cm4gR29kLmRlbGV0ZVByb2Nlc3NJZCh0X2tleSwgY2IpO1xyXG4gICAgICB9LCBjc3QuR1JBQ0VGVUxfVElNRU9VVCk7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfSk7XHJcbiAgcmV0dXJuIGZhbHNlO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIGhhcmRSZWxvYWQgd2lsbCByZWxvYWQgd2l0aG91dCB3YWl0aW5nIHBlcm1pc3Npb24gZnJvbSBwcm9jZXNzXHJcbiAqIEBtZXRob2QgaGFyZFJlbG9hZFxyXG4gKiBAcGFyYW0ge30gR29kXHJcbiAqIEBwYXJhbSB7fSBpZFxyXG4gKiBAcGFyYW0ge30gY2JcclxuICogQHJldHVybiBMaXRlcmFsXHJcbiAqL1xyXG5mdW5jdGlvbiBoYXJkUmVsb2FkKEdvZCwgaWQsIHdhaXRfbXNnLCBjYikge1xyXG4gIHZhciB0X2tleSA9ICdfb2xkXycgKyBpZDtcclxuXHJcbiAgLy8gTW92ZSBvbGQgd29ya2VyIHRvIHRtcCBpZFxyXG4gIEdvZC5jbHVzdGVyc19kYlt0X2tleV0gPSBHb2QuY2x1c3RlcnNfZGJbaWRdO1xyXG4gIGRlbGV0ZSBHb2QuY2x1c3RlcnNfZGJbaWRdO1xyXG5cclxuICB2YXIgb2xkX3dvcmtlciA9IEdvZC5jbHVzdGVyc19kYlt0X2tleV07XHJcbiAgLy8gRGVlcCBjb3B5XHJcbiAgdmFyIG5ld19lbnYgPSBVdGlsaXR5LmNsb25lKG9sZF93b3JrZXIucG0yX2Vudik7XHJcbiAgbmV3X2Vudi5yZXN0YXJ0X3RpbWUgKz0gMTtcclxuXHJcbiAgLy8gUmVzZXQgY3JlYXRlZF9hdCBhbmQgdW5zdGFibGVfcmVzdGFydHNcclxuICBHb2QucmVzZXRTdGF0ZShuZXdfZW52KTtcclxuXHJcbiAgb2xkX3dvcmtlci5wbTJfZW52LnBtX2lkID0gdF9rZXk7XHJcbiAgb2xkX3dvcmtlci5wbV9pZCA9IHRfa2V5O1xyXG4gIHZhciB0aW1lciA9IG51bGw7XHJcbiAgdmFyIHJlYWR5U2lnbmFsU2VudCA9IGZhbHNlO1xyXG5cclxuICB2YXIgb25MaXN0ZW4gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBjbGVhclRpbWVvdXQodGltZXIpO1xyXG4gICAgcmVhZHlTaWduYWxTZW50ID0gdHJ1ZTtcclxuICAgIGNvbnNvbGUubG9nKCctcmVsb2FkLSBOZXcgd29ya2VyIGxpc3RlbmluZycpO1xyXG4gICAgcmV0dXJuIEdvZC5kZWxldGVQcm9jZXNzSWQodF9rZXksIGNiKTtcclxuICB9O1xyXG5cclxuICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbiAocGFja2V0KSB7XHJcbiAgICBpZiAocGFja2V0LnJhdyA9PT0gJ3JlYWR5JyAmJlxyXG4gICAgICAgIHBhY2tldC5wcm9jZXNzLm5hbWUgPT09IG9sZF93b3JrZXIucG0yX2Vudi5uYW1lICYmXHJcbiAgICAgICAgcGFja2V0LnByb2Nlc3MucG1faWQgPT09IGlkKSB7XHJcbiAgICAgIEdvZC5idXMucmVtb3ZlTGlzdGVuZXIoJ3Byb2Nlc3M6bXNnJywgbGlzdGVuZXIpO1xyXG4gICAgICByZXR1cm4gb25MaXN0ZW4oKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBpZiAod2FpdF9tc2cgIT09ICdsaXN0ZW5pbmcnKSB7XHJcbiAgICBHb2QuYnVzLm9uKCdwcm9jZXNzOm1zZycsIGxpc3RlbmVyKTtcclxuICB9XHJcblxyXG4gIEdvZC5leGVjdXRlQXBwKG5ld19lbnYsIGZ1bmN0aW9uKGVyciwgbmV3X3dvcmtlcikge1xyXG4gICAgaWYgKGVycikgcmV0dXJuIGNiKGVycik7XHJcblxyXG4gICAgLy8gQmluZCB0byBrbm93IHdoZW4gdGhlIG5ldyBwcm9jZXNzIGlzIHVwXHJcbiAgICBpZiAod2FpdF9tc2cgPT09ICdsaXN0ZW5pbmcnKSB7XHJcbiAgICAgIG5ld193b3JrZXIub25jZSgnbGlzdGVuaW5nJywgb25MaXN0ZW4pO1xyXG4gICAgfVxyXG5cclxuICAgIHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHtcclxuICAgICAgaWYgKHJlYWR5U2lnbmFsU2VudCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHdhaXRfbXNnID09PSAnbGlzdGVuaW5nJylcclxuICAgICAgICBuZXdfd29ya2VyLnJlbW92ZUxpc3RlbmVyKHdhaXRfbXNnLCBvbkxpc3Rlbik7XHJcbiAgICAgIGVsc2VcclxuICAgICAgICBHb2QuYnVzLnJlbW92ZUxpc3RlbmVyKCdwcm9jZXNzOm1zZycsIGxpc3RlbmVyKTtcclxuXHJcbiAgICAgIHJldHVybiBHb2QuZGVsZXRlUHJvY2Vzc0lkKHRfa2V5LCBjYik7XHJcbiAgICB9LCBuZXdfZW52Lmxpc3Rlbl90aW1lb3V0IHx8IGNzdC5HUkFDRUZVTF9MSVNURU5fVElNRU9VVCk7XHJcblxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0pO1xyXG4gIHJldHVybiBmYWxzZTtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBEZXNjcmlwdGlvblxyXG4gKiBAbWV0aG9kIGV4cG9ydHNcclxuICogQHBhcmFtIHt9IEdvZFxyXG4gKiBAcmV0dXJuXHJcbiAqL1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKEdvZCkge1xyXG5cclxuICAvKipcclxuICAgKiBSZWxvYWRcclxuICAgKiBAbWV0aG9kIHNvZnRSZWxvYWRQcm9jZXNzSWRcclxuICAgKiBAcGFyYW0ge30gaWRcclxuICAgKiBAcGFyYW0ge30gY2JcclxuICAgKiBAcmV0dXJuIENhbGxFeHByZXNzaW9uXHJcbiAgICovXHJcbiAgR29kLnNvZnRSZWxvYWRQcm9jZXNzSWQgPSBmdW5jdGlvbihvcHRzLCBjYikge1xyXG4gICAgdmFyIGlkICA9IG9wdHMuaWQ7XHJcbiAgICB2YXIgZW52ID0gb3B0cy5lbnYgfHwge307XHJcblxyXG4gICAgaWYgKCEoaWQgaW4gR29kLmNsdXN0ZXJzX2RiKSlcclxuICAgICAgcmV0dXJuIGNiKG5ldyBFcnJvcihgcG1faWQgJHtpZH0gbm90IGF2YWlsYWJsZSBpbiAke2lkfWApKTtcclxuXHJcbiAgICBpZiAoR29kLmNsdXN0ZXJzX2RiW2lkXS5wbTJfZW52LnN0YXR1cyA9PSBjc3QuT05MSU5FX1NUQVRVUyAmJlxyXG4gICAgICAgIEdvZC5jbHVzdGVyc19kYltpZF0ucG0yX2Vudi5leGVjX21vZGUgPT0gJ2NsdXN0ZXJfbW9kZScgJiZcclxuICAgICAgICAhR29kLmNsdXN0ZXJzX2RiW2lkXS5wbTJfZW52LndhaXRfcmVhZHkpIHtcclxuXHJcbiAgICAgIFV0aWxpdHkuZXh0ZW5kKEdvZC5jbHVzdGVyc19kYltpZF0ucG0yX2Vudi5lbnYsIG9wdHMuZW52KTtcclxuICAgICAgVXRpbGl0eS5leHRlbmRFeHRyYUNvbmZpZyhHb2QuY2x1c3RlcnNfZGJbaWRdLCBvcHRzKTtcclxuXHJcbiAgICAgIHJldHVybiBzb2Z0UmVsb2FkKEdvZCwgaWQsIGNiKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICBjb25zb2xlLmxvZygnUHJvY2VzcyAlcyBpbiBhIHN0b3BwZWQgc3RhdHVzLCBzdGFydGluZyBpdCcsIGlkKTtcclxuICAgICAgcmV0dXJuIEdvZC5yZXN0YXJ0UHJvY2Vzc0lkKG9wdHMsIGNiKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICAvKipcclxuICAgKiBSZWxvYWRcclxuICAgKiBAbWV0aG9kIHJlbG9hZFByb2Nlc3NJZFxyXG4gICAqIEBwYXJhbSB7fSBpZFxyXG4gICAqIEBwYXJhbSB7fSBjYlxyXG4gICAqIEByZXR1cm4gQ2FsbEV4cHJlc3Npb25cclxuICAgKi9cclxuICBHb2QucmVsb2FkUHJvY2Vzc0lkID0gZnVuY3Rpb24ob3B0cywgY2IpIHtcclxuICAgIHZhciBpZCAgPSBvcHRzLmlkO1xyXG4gICAgdmFyIGVudiA9IG9wdHMuZW52IHx8IHt9O1xyXG5cclxuICAgIGlmICghKGlkIGluIEdvZC5jbHVzdGVyc19kYikpXHJcbiAgICAgIHJldHVybiBjYihuZXcgRXJyb3IoJ1BNMiBJRCB1bmtub3duJykpO1xyXG5cclxuICAgIGlmIChHb2QuY2x1c3RlcnNfZGJbaWRdLnBtMl9lbnYuc3RhdHVzID09IGNzdC5PTkxJTkVfU1RBVFVTICYmXHJcbiAgICAgICAgR29kLmNsdXN0ZXJzX2RiW2lkXS5wbTJfZW52LmV4ZWNfbW9kZSA9PSAnY2x1c3Rlcl9tb2RlJykge1xyXG5cclxuICAgICAgVXRpbGl0eS5leHRlbmQoR29kLmNsdXN0ZXJzX2RiW2lkXS5wbTJfZW52LmVudiwgb3B0cy5lbnYpO1xyXG4gICAgICBVdGlsaXR5LmV4dGVuZEV4dHJhQ29uZmlnKEdvZC5jbHVzdGVyc19kYltpZF0sIG9wdHMpO1xyXG5cclxuICAgICAgdmFyIHdhaXRfbXNnID0gR29kLmNsdXN0ZXJzX2RiW2lkXS5wbTJfZW52LndhaXRfcmVhZHkgPyAncmVhZHknIDogJ2xpc3RlbmluZyc7XHJcbiAgICAgIHJldHVybiBoYXJkUmVsb2FkKEdvZCwgaWQsIHdhaXRfbXNnLCBjYik7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgY29uc29sZS5sb2coJ1Byb2Nlc3MgJXMgaW4gYSBzdG9wcGVkIHN0YXR1cywgc3RhcnRpbmcgaXQnLCBpZCk7XHJcbiAgICAgIHJldHVybiBHb2QucmVzdGFydFByb2Nlc3NJZChvcHRzLCBjYik7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbn07XHJcbiJdfQ==
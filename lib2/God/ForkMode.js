/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
'use strict';
/**
 * @file Fork execution related functions
 * @author Alexandre Strzelewicz <as@unitech.io>
 * @project PM2
 */

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = ForkMode;

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _debug = _interopRequireDefault(require("debug"));

var _fs = _interopRequireDefault(require("fs"));

var _Utility = _interopRequireDefault(require("../Utility"));

var _path = _interopRequireDefault(require("path"));

var _dayjs = _interopRequireDefault(require("dayjs"));

var _semver = _interopRequireDefault(require("semver"));

var log = (0, _debug["default"])('pm2:fork_mode');
/**
 * Description
 * @method exports
 * @param {} God
 * @return
 */

function ForkMode(God) {
  /**
   * For all apps - FORK MODE
   * fork the app
   * @method forkMode
   * @param {} pm2_env
   * @param {} cb
   * @return
   */
  God.forkMode = function forkMode(pm2_env, cb) {
    var command = '';
    var args = [];
    console.log("App [".concat(pm2_env.name, ":").concat(pm2_env.pm_id, "] starting in -fork mode-"));

    var spawn = require('child_process').spawn;

    var interpreter = pm2_env.exec_interpreter || 'node';
    var pidFile = pm2_env.pm_pid_path;

    if (interpreter !== 'none') {
      command = interpreter;

      if (pm2_env.node_args && Array.isArray(pm2_env.node_args)) {
        args = args.concat(pm2_env.node_args);
      } // Deprecated - to remove at some point


      if (process.env.PM2_NODE_OPTIONS) {
        args = args.concat(process.env.PM2_NODE_OPTIONS.split(' '));
      }

      if (interpreter === 'node' || RegExp('node$').test(interpreter)) {
        if (_semver["default"].lt(process.version, '10.0.0')) {
          args.push(_path["default"].resolve(_path["default"].dirname(module.filename), '..', 'ProcessContainerForkLegacy.js'));
        } else {
          args.push(_path["default"].resolve(_path["default"].dirname(module.filename), '..', 'ProcessContainerFork.js'));
        }
      } else args.push(pm2_env.pm_exec_path);
    } else {
      command = pm2_env.pm_exec_path;
      args = [];
    }

    if (pm2_env.args) {
      args = args.concat(pm2_env.args);
    } // piping stream o file


    var stds = {
      out: pm2_env.pm_out_log_path,
      err: pm2_env.pm_err_log_path
    }; // entire log std if necessary.

    if ('pm_log_path' in pm2_env) {
      stds.std = pm2_env.pm_log_path;
    }

    log("stds: %j", stds);

    _Utility["default"].startLogging(stds, function (err, result) {
      if (err) {
        God.logAndGenerateError(err);
        return cb(err);
      }

      ;

      try {
        var options = {
          env: pm2_env,
          detached: true,
          cwd: pm2_env.pm_cwd || process.cwd(),
          stdio: ['pipe', 'pipe', 'pipe', 'ipc'] //Same as fork() in node core

        };

        if (typeof pm2_env.windowsHide === "boolean") {
          options.windowsHide = pm2_env.windowsHide;
        } else {
          options.windowsHide = true;
        }

        if (pm2_env.uid) {
          options.uid = pm2_env.uid;
        }

        if (pm2_env.gid) {
          options.gid = pm2_env.gid;
        }

        var cspr = spawn(command, args, options);
      } catch (e) {
        God.logAndGenerateError(e);
        return cb(e);
      }

      if (!cspr || !cspr.stderr || !cspr.stdout) {
        var fatalError = new Error('Process could not be forked properly, check your system health');
        God.logAndGenerateError(fatalError);
        return cb(fatalError);
      }

      cspr.process = {};
      cspr.process.pid = cspr.pid;
      cspr.pm2_env = pm2_env;

      function transformLogToJson(pm2_env, type, data) {
        return JSON.stringify({
          message: data.toString(),
          timestamp: pm2_env.log_date_format ? (0, _dayjs["default"])().format(pm2_env.log_date_format) : new Date().toISOString(),
          type: type,
          process_id: cspr.pm2_env.pm_id,
          app_name: cspr.pm2_env.name
        }) + '\n';
      }

      function prefixLogWithDate(pm2_env, data) {
        var log_data = [];
        log_data = data.toString().split('\n');
        if (log_data.length > 1) log_data.pop();
        log_data = log_data.map(function (line) {
          return "".concat((0, _dayjs["default"])().format(pm2_env.log_date_format), ": ").concat(line, "\n");
        });
        return log_data.join('');
      }

      cspr.stderr.on('data', function forkErrData(data) {
        var log_data = null; // via --out /dev/null --err /dev/null

        if (pm2_env.disable_logs === true) return false;
        if (pm2_env.log_type && pm2_env.log_type === 'json') log_data = transformLogToJson(pm2_env, 'err', data);else if (pm2_env.log_date_format) log_data = prefixLogWithDate(pm2_env, data);else log_data = data.toString();
        God.bus.emit('log:err', {
          process: {
            pm_id: cspr.pm2_env.pm_id,
            name: cspr.pm2_env.name,
            rev: cspr.pm2_env.versioning && cspr.pm2_env.versioning.revision ? cspr.pm2_env.versioning.revision : null,
            namespace: cspr.pm2_env.namespace
          },
          at: _Utility["default"].getDate(),
          data: log_data
        });

        if (_Utility["default"].checkPathIsNull(pm2_env.pm_err_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) {
          return false;
        }

        stds.std && stds.std.write && stds.std.write(log_data);
        stds.err && stds.err.write && stds.err.write(log_data);
      });
      cspr.stdout.on('data', function forkOutData(data) {
        var log_data = null;
        if (pm2_env.disable_logs === true) return false;
        if (pm2_env.log_type && pm2_env.log_type === 'json') log_data = transformLogToJson(pm2_env, 'out', data);else if (pm2_env.log_date_format) log_data = prefixLogWithDate(pm2_env, data);else log_data = data.toString();
        God.bus.emit('log:out', {
          process: {
            pm_id: cspr.pm2_env.pm_id,
            name: cspr.pm2_env.name,
            rev: cspr.pm2_env.versioning && cspr.pm2_env.versioning.revision ? cspr.pm2_env.versioning.revision : null,
            namespace: cspr.pm2_env.namespace
          },
          at: _Utility["default"].getDate(),
          data: log_data
        });
        if (_Utility["default"].checkPathIsNull(pm2_env.pm_out_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) return false;
        stds.std && stds.std.write && stds.std.write(log_data);
        stds.out && stds.out.write && stds.out.write(log_data);
      });
      /**
       * Broadcast message to God
       */

      cspr.on('message', function forkMessage(msg) {
        /*********************************
         * If you edit this function
         * Do the same in ClusterMode.js !
         *********************************/
        if (msg.data && msg.type) {
          process.nextTick(function () {
            return God.bus.emit(msg.type ? msg.type : 'process:msg', {
              at: _Utility["default"].getDate(),
              data: msg.data,
              process: {
                pm_id: cspr.pm2_env.pm_id,
                name: cspr.pm2_env.name,
                versioning: cspr.pm2_env.versioning,
                namespace: cspr.pm2_env.namespace
              }
            });
          });
        } else {
          if ((0, _typeof2["default"])(msg) == 'object' && 'node_version' in msg) {
            cspr.pm2_env.node_version = msg.node_version;
            return false;
          } else if ((0, _typeof2["default"])(msg) == 'object' && 'cron_restart' in msg) {
            // cron onTick is invoked in the process
            return God.restartProcessId({
              id: cspr.pm2_env.pm_id
            }, function () {
              console.log('Application %s has been restarted via CRON', cspr.pm2_env.name);
            });
          }

          return God.bus.emit('process:msg', {
            at: _Utility["default"].getDate(),
            raw: msg,
            process: {
              pm_id: cspr.pm2_env.pm_id,
              name: cspr.pm2_env.name,
              namespace: cspr.pm2_env.namespace
            }
          });
        }
      });

      try {
        var pid = cspr.pid;
        if (typeof pid !== 'undefined') _fs["default"].writeFileSync(pidFile, pid.toString());
      } catch (e) {
        console.error(e.stack || e);
      }

      cspr.once('exit', function forkClose(status) {
        try {
          for (var k in stds) {
            if (stds[k] && stds[k].destroy) stds[k].destroy();else if (stds[k] && stds[k].end) stds[k].end();else if (stds[k] && stds[k].close) stds[k].close();
            stds[k] = stds[k]._file;
          }
        } catch (e) {
          God.logAndGenerateError(e);
        }
      });

      cspr._reloadLogs = function (cb) {
        try {
          for (var k in stds) {
            if (stds[k] && stds[k].destroy) stds[k].destroy();else if (stds[k] && stds[k].end) stds[k].end();else if (stds[k] && stds[k].close) stds[k].close();
            stds[k] = stds[k]._file;
          }
        } catch (e) {
          God.logAndGenerateError(e);
        } //cspr.removeAllListeners();


        _Utility["default"].startLogging(stds, cb);
      };

      cspr.unref();
      return cb(null, cspr);
    });
  };
}

;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Hb2QvRm9ya01vZGUudHMiXSwibmFtZXMiOlsibG9nIiwiRm9ya01vZGUiLCJHb2QiLCJmb3JrTW9kZSIsInBtMl9lbnYiLCJjYiIsImNvbW1hbmQiLCJhcmdzIiwiY29uc29sZSIsIm5hbWUiLCJwbV9pZCIsInNwYXduIiwicmVxdWlyZSIsImludGVycHJldGVyIiwiZXhlY19pbnRlcnByZXRlciIsInBpZEZpbGUiLCJwbV9waWRfcGF0aCIsIm5vZGVfYXJncyIsIkFycmF5IiwiaXNBcnJheSIsImNvbmNhdCIsInByb2Nlc3MiLCJlbnYiLCJQTTJfTk9ERV9PUFRJT05TIiwic3BsaXQiLCJSZWdFeHAiLCJ0ZXN0Iiwic2VtdmVyIiwibHQiLCJ2ZXJzaW9uIiwicHVzaCIsInBhdGgiLCJyZXNvbHZlIiwiZGlybmFtZSIsIm1vZHVsZSIsImZpbGVuYW1lIiwicG1fZXhlY19wYXRoIiwic3RkcyIsIm91dCIsInBtX291dF9sb2dfcGF0aCIsImVyciIsInBtX2Vycl9sb2dfcGF0aCIsInN0ZCIsInBtX2xvZ19wYXRoIiwiVXRpbGl0eSIsInN0YXJ0TG9nZ2luZyIsInJlc3VsdCIsImxvZ0FuZEdlbmVyYXRlRXJyb3IiLCJvcHRpb25zIiwiZGV0YWNoZWQiLCJjd2QiLCJwbV9jd2QiLCJzdGRpbyIsIndpbmRvd3NIaWRlIiwidWlkIiwiZ2lkIiwiY3NwciIsImUiLCJzdGRlcnIiLCJzdGRvdXQiLCJmYXRhbEVycm9yIiwiRXJyb3IiLCJwaWQiLCJ0cmFuc2Zvcm1Mb2dUb0pzb24iLCJ0eXBlIiwiZGF0YSIsIkpTT04iLCJzdHJpbmdpZnkiLCJtZXNzYWdlIiwidG9TdHJpbmciLCJ0aW1lc3RhbXAiLCJsb2dfZGF0ZV9mb3JtYXQiLCJmb3JtYXQiLCJEYXRlIiwidG9JU09TdHJpbmciLCJwcm9jZXNzX2lkIiwiYXBwX25hbWUiLCJwcmVmaXhMb2dXaXRoRGF0ZSIsImxvZ19kYXRhIiwibGVuZ3RoIiwicG9wIiwibWFwIiwibGluZSIsImpvaW4iLCJvbiIsImZvcmtFcnJEYXRhIiwiZGlzYWJsZV9sb2dzIiwibG9nX3R5cGUiLCJidXMiLCJlbWl0IiwicmV2IiwidmVyc2lvbmluZyIsInJldmlzaW9uIiwibmFtZXNwYWNlIiwiYXQiLCJnZXREYXRlIiwiY2hlY2tQYXRoSXNOdWxsIiwid3JpdGUiLCJmb3JrT3V0RGF0YSIsImZvcmtNZXNzYWdlIiwibXNnIiwibmV4dFRpY2siLCJub2RlX3ZlcnNpb24iLCJyZXN0YXJ0UHJvY2Vzc0lkIiwiaWQiLCJyYXciLCJmcyIsIndyaXRlRmlsZVN5bmMiLCJlcnJvciIsInN0YWNrIiwib25jZSIsImZvcmtDbG9zZSIsInN0YXR1cyIsImsiLCJkZXN0cm95IiwiZW5kIiwiY2xvc2UiLCJfZmlsZSIsIl9yZWxvYWRMb2dzIiwidW5yZWYiXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQUtBO0FBRUE7Ozs7Ozs7Ozs7Ozs7OztBQUtBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQU1BLEdBQUcsR0FBRyx1QkFBWSxlQUFaLENBQVo7QUFDQTs7Ozs7OztBQU1lLFNBQVNDLFFBQVQsQ0FBa0JDLEdBQWxCLEVBQXVCO0FBQ3BDOzs7Ozs7OztBQVFBQSxFQUFBQSxHQUFHLENBQUNDLFFBQUosR0FBZSxTQUFTQSxRQUFULENBQWtCQyxPQUFsQixFQUEyQkMsRUFBM0IsRUFBK0I7QUFDNUMsUUFBSUMsT0FBTyxHQUFHLEVBQWQ7QUFDQSxRQUFJQyxJQUFJLEdBQUcsRUFBWDtBQUVBQyxJQUFBQSxPQUFPLENBQUNSLEdBQVIsZ0JBQW9CSSxPQUFPLENBQUNLLElBQTVCLGNBQW9DTCxPQUFPLENBQUNNLEtBQTVDOztBQUNBLFFBQUlDLEtBQUssR0FBR0MsT0FBTyxDQUFDLGVBQUQsQ0FBUCxDQUF5QkQsS0FBckM7O0FBRUEsUUFBSUUsV0FBVyxHQUFHVCxPQUFPLENBQUNVLGdCQUFSLElBQTRCLE1BQTlDO0FBQ0EsUUFBSUMsT0FBTyxHQUFHWCxPQUFPLENBQUNZLFdBQXRCOztBQUVBLFFBQUlILFdB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LEtBQVI7QUFDbkMvRSxZQUFBQSxJQUFJLENBQUM0RSxDQUFELENBQUosR0FBVTVFLElBQUksQ0FBQzRFLENBQUQsQ0FBSixDQUFRSSxLQUFsQjtBQUNEO0FBQ0YsU0FQRCxDQU9FLE9BQU81RCxDQUFQLEVBQVU7QUFBRXZELFVBQUFBLEdBQUcsQ0FBQzZDLG1CQUFKLENBQXdCVSxDQUF4QjtBQUE2QixTQVJaLENBUy9COzs7QUFDQWIsNEJBQVFDLFlBQVIsQ0FBcUJSLElBQXJCLEVBQTJCaEMsRUFBM0I7QUFDRCxPQVhEOztBQWFBbUQsTUFBQUEsSUFBSSxDQUFDK0QsS0FBTDtBQUVBLGFBQU9sSCxFQUFFLENBQUMsSUFBRCxFQUFPbUQsSUFBUCxDQUFUO0FBQ0QsS0FuTkQ7QUFxTkQsR0E1UUQ7QUE2UUQ7O0FBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAyMDEzIHRoZSBQTTIgcHJvamVjdCBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBsaWNlbnNlIHRoYXRcbiAqIGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLlxuICovXG4ndXNlIHN0cmljdCc7XG5cbi8qKlxuICogQGZpbGUgRm9yayBleGVjdXRpb24gcmVsYXRlZCBmdW5jdGlvbnNcbiAqIEBhdXRob3IgQWxleGFuZHJlIFN0cnplbGV3aWN6IDxhc0B1bml0ZWNoLmlvPlxuICogQHByb2plY3QgUE0yXG4gKi9cbmltcG9ydCBkZWJ1Z0xvZ2dlciBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IFV0aWxpdHkgZnJvbSAnLi4vVXRpbGl0eSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBkYXlqcyBmcm9tICdkYXlqcyc7XG5pbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5cbmNvbnN0IGxvZyA9IGRlYnVnTG9nZ2VyKCdwbTI6Zm9ya19tb2RlJyk7XG4vKipcbiAqIERlc2NyaXB0aW9uXG4gKiBAbWV0aG9kIGV4cG9ydHNcbiAqIEBwYXJhbSB7fSBHb2RcbiAqIEByZXR1cm5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gRm9ya01vZGUoR29kKSB7XG4gIC8qKlxuICAgKiBGb3IgYWxsIGFwcHMgLSBGT1JLIE1PREVcbiAgICogZm9yayB0aGUgYXBwXG4gICAqIEBtZXRob2QgZm9ya01vZGVcbiAgICogQHBhcmFtIHt9IHBtMl9lbnZcbiAgICogQHBhcmFtIHt9IGNiXG4gICAqIEByZXR1cm5cbiAgICovXG4gIEdvZC5mb3JrTW9kZSA9IGZ1bmN0aW9uIGZvcmtNb2RlKHBtMl9lbnYsIGNiKSB7XG4gICAgdmFyIGNvbW1hbmQgPSAnJztcbiAgICB2YXIgYXJncyA9IFtdO1xuXG4gICAgY29uc29sZS5sb2coYEFwcCBbJHtwbTJfZW52Lm5hbWV9OiR7cG0yX2Vudi5wbV9pZH1dIHN0YXJ0aW5nIGluIC1mb3JrIG1vZGUtYClcbiAgICB2YXIgc3Bhd24gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuc3Bhd247XG5cbiAgICB2YXIgaW50ZXJwcmV0ZXIgPSBwbTJfZW52LmV4ZWNfaW50ZXJwcmV0ZXIgfHwgJ25vZGUnO1xuICAgIHZhciBwaWRGaWxlID0gcG0yX2Vudi5wbV9waWRfcGF0aDtcblxuICAgIGlmIChpbnRlcnByZXRlciAhPT0gJ25vbmUnKSB7XG4gICAgICBjb21tYW5kID0gaW50ZXJwcmV0ZXI7XG5cbiAgICAgIGlmIChwbTJfZW52Lm5vZGVfYXJncyAmJiBBcnJheS5pc0FycmF5KHBtMl9lbnYubm9kZV9hcmdzKSkge1xuICAgICAgICBhcmdzID0gYXJncy5jb25jYXQocG0yX2Vudi5ub2RlX2FyZ3MpO1xuICAgICAgfVxuXG4gICAgICAvLyBEZXByZWNhdGVkIC0gdG8gcmVtb3ZlIGF0IHNvbWUgcG9pbnRcbiAgICAgIGlmIChwcm9jZXNzLmVudi5QTTJfTk9ERV9PUFRJT05TKSB7XG4gICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChwcm9jZXNzLmVudi5QTTJfTk9ERV9PUFRJT05TLnNwbGl0KCcgJykpO1xuICAgICAgfVxuXG4gICAgICBpZiAoaW50ZXJwcmV0ZXIgPT09ICdub2RlJyB8fCBSZWdFeHAoJ25vZGUkJykudGVzdChpbnRlcnByZXRlcikpIHtcbiAgICAgICAgaWYgKHNlbXZlci5sdChwcm9jZXNzLnZlcnNpb24sICcxMC4wLjAnKSkge1xuICAgICAgICAgIGFyZ3MucHVzaChwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKG1vZHVsZS5maWxlbmFtZSksICcuLicsICdQcm9jZXNzQ29udGFpbmVyRm9ya0xlZ2FjeS5qcycpKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICBhcmdzLnB1c2gocGF0aC5yZXNvbHZlKHBhdGguZGlybmFtZShtb2R1bGUuZmlsZW5hbWUpLCAnLi4nLCAnUHJvY2Vzc0NvbnRhaW5lckZvcmsuanMnKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2VcbiAgICAgICAgYXJncy5wdXNoKHBtMl9lbnYucG1fZXhlY19wYXRoKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBjb21tYW5kID0gcG0yX2Vudi5wbV9leGVjX3BhdGg7XG4gICAgICBhcmdzID0gW107XG4gICAgfVxuXG4gICAgaWYgKHBtMl9lbnYuYXJncykge1xuICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KHBtMl9lbnYuYXJncyk7XG4gICAgfVxuXG4gICAgLy8gcGlwaW5nIHN0cmVhbSBvIGZpbGVcbiAgICB2YXIgc3RkczogYW55ID0ge1xuICAgICAgb3V0OiBwbTJfZW52LnBtX291dF9sb2dfcGF0aCxcbiAgICAgIGVycjogcG0yX2Vudi5wbV9lcnJfbG9nX3BhdGhcbiAgICB9O1xuXG4gICAgLy8gZW50aXJlIGxvZyBzdGQgaWYgbmVjZXNzYXJ5LlxuICAgIGlmICgncG1fbG9nX3BhdGgnIGluIHBtMl9lbnYpIHtcbiAgICAgIHN0ZHMuc3RkID0gcG0yX2Vudi5wbV9sb2dfcGF0aDtcbiAgICB9XG5cbiAgICBsb2coXCJzdGRzOiAlalwiLCBzdGRzKTtcblxuICAgIFV0aWxpdHkuc3RhcnRMb2dnaW5nKHN0ZHMsIGZ1bmN0aW9uIChlcnIsIHJlc3VsdCkge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBHb2QubG9nQW5kR2VuZXJhdGVFcnJvcihlcnIpO1xuICAgICAgICByZXR1cm4gY2IoZXJyKTtcbiAgICAgIH07XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIHZhciBvcHRpb25zOiBhbnkgPSB7XG4gICAgICAgICAgZW52OiBwbTJfZW52LFxuICAgICAgICAgIGRldGFjaGVkOiB0cnVlLFxuICAgICAgICAgIGN3ZDogcG0yX2Vudi5wbV9jd2QgfHwgcHJvY2Vzcy5jd2QoKSxcbiAgICAgICAgICBzdGRpbzogWydwaXBlJywgJ3BpcGUnLCAncGlwZScsICdpcGMnXSAvL1NhbWUgYXMgZm9yaygpIGluIG5vZGUgY29yZVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHR5cGVvZiAocG0yX2Vudi53aW5kb3dzSGlkZSkgPT09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgICAgb3B0aW9ucy53aW5kb3dzSGlkZSA9IHBtMl9lbnYud2luZG93c0hpZGU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3B0aW9ucy53aW5kb3dzSGlkZSA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocG0yX2Vudi51aWQpIHtcbiAgICAgICAgICBvcHRpb25zLnVpZCA9IHBtMl9lbnYudWlkXG4gICAgICAgIH1cblxuICAgICAgICBpZiAocG0yX2Vudi5naWQpIHtcbiAgICAgICAgICBvcHRpb25zLmdpZCA9IHBtMl9lbnYuZ2lkXG4gICAgICAgIH1cblxuICAgICAgICB2YXIgY3NwciA9IHNwYXduKGNvbW1hbmQsIGFyZ3MsIG9wdGlvbnMpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBHb2QubG9nQW5kR2VuZXJhdGVFcnJvcihlKTtcbiAgICAgICAgcmV0dXJuIGNiKGUpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWNzcHIgfHwgIWNzcHIuc3RkZXJyIHx8ICFjc3ByLnN0ZG91dCkge1xuICAgICAgICB2YXIgZmF0YWxFcnJvciA9IG5ldyBFcnJvcignUHJvY2VzcyBjb3VsZCBub3QgYmUgZm9ya2VkIHByb3Blcmx5LCBjaGVjayB5b3VyIHN5c3RlbSBoZWFsdGgnKVxuICAgICAgICBHb2QubG9nQW5kR2VuZXJhdGVFcnJvcihmYXRhbEVycm9yKTtcbiAgICAgICAgcmV0dXJuIGNiKGZhdGFsRXJyb3IpO1xuICAgICAgfVxuXG4gICAgICBjc3ByLnByb2Nlc3MgPSB7fTtcbiAgICAgIGNzcHIucHJvY2Vzcy5waWQgPSBjc3ByLnBpZDtcbiAgICAgIGNzcHIucG0yX2VudiA9IHBtMl9lbnY7XG5cbiAgICAgIGZ1bmN0aW9uIHRyYW5zZm9ybUxvZ1RvSnNvbihwbTJfZW52LCB0eXBlLCBkYXRhKSB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgbWVzc2FnZTogZGF0YS50b1N0cmluZygpLFxuICAgICAgICAgIHRpbWVzdGFtcDogcG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQgPyBkYXlqcygpLmZvcm1hdChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCkgOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgdHlwZTogdHlwZSxcbiAgICAgICAgICBwcm9jZXNzX2lkOiBjc3ByLnBtMl9lbnYucG1faWQsXG4gICAgICAgICAgYXBwX25hbWU6IGNzcHIucG0yX2Vudi5uYW1lXG4gICAgICAgIH0pICsgJ1xcbidcbiAgICAgIH1cblxuICAgICAgZnVuY3Rpb24gcHJlZml4TG9nV2l0aERhdGUocG0yX2VudiwgZGF0YSkge1xuICAgICAgICB2YXIgbG9nX2RhdGE6IGFueVtdID0gW11cbiAgICAgICAgbG9nX2RhdGEgPSBkYXRhLnRvU3RyaW5nKCkuc3BsaXQoJ1xcbicpXG4gICAgICAgIGlmIChsb2dfZGF0YS5sZW5ndGggPiAxKVxuICAgICAgICAgIGxvZ19kYXRhLnBvcCgpXG4gICAgICAgIGxvZ19kYXRhID0gbG9nX2RhdGEubWFwKGxpbmUgPT4gYCR7ZGF5anMoKS5mb3JtYXQocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQpfTogJHtsaW5lfVxcbmApXG4gICAgICAgIHJldHVybiBsb2dfZGF0YS5qb2luKCcnKVxuICAgICAgfVxuXG4gICAgICBjc3ByLnN0ZGVyci5vbignZGF0YScsIGZ1bmN0aW9uIGZvcmtFcnJEYXRhKGRhdGEpIHtcbiAgICAgICAgdmFyIGxvZ19kYXRhID0gbnVsbDtcblxuICAgICAgICAvLyB2aWEgLS1vdXQgL2Rldi9udWxsIC0tZXJyIC9kZXYvbnVsbFxuICAgICAgICBpZiAocG0yX2Vudi5kaXNhYmxlX2xvZ3MgPT09IHRydWUpIHJldHVybiBmYWxzZTtcblxuICAgICAgICBpZiAocG0yX2Vudi5sb2dfdHlwZSAmJiBwbTJfZW52LmxvZ190eXBlID09PSAnanNvbicpXG4gICAgICAgICAgbG9nX2RhdGEgPSB0cmFuc2Zvcm1Mb2dUb0pzb24ocG0yX2VudiwgJ2VycicsIGRhdGEpXG4gICAgICAgIGVsc2UgaWYgKHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0KVxuICAgICAgICAgIGxvZ19kYXRhID0gcHJlZml4TG9nV2l0aERhdGUocG0yX2VudiwgZGF0YSlcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGxvZ19kYXRhID0gZGF0YS50b1N0cmluZygpO1xuXG4gICAgICAgIEdvZC5idXMuZW1pdCgnbG9nOmVycicsIHtcbiAgICAgICAgICBwcm9jZXNzOiB7XG4gICAgICAgICAgICBwbV9pZDogY3Nwci5wbTJfZW52LnBtX2lkLFxuICAgICAgICAgICAgbmFtZTogY3Nwci5wbTJfZW52Lm5hbWUsXG4gICAgICAgICAgICByZXY6IChjc3ByLnBtMl9lbnYudmVyc2lvbmluZyAmJiBjc3ByLnBtMl9lbnYudmVyc2lvbmluZy5yZXZpc2lvbikgPyBjc3ByLnBtMl9lbnYudmVyc2lvbmluZy5yZXZpc2lvbiA6IG51bGwsXG4gICAgICAgICAgICBuYW1lc3BhY2U6IGNzcHIucG0yX2Vudi5uYW1lc3BhY2VcbiAgICAgICAgICB9LFxuICAgICAgICAgIGF0OiBVdGlsaXR5LmdldERhdGUoKSxcbiAgICAgICAgICBkYXRhOiBsb2dfZGF0YVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoVXRpbGl0eS5jaGVja1BhdGhJc051bGwocG0yX2Vudi5wbV9lcnJfbG9nX3BhdGgpICYmXG4gICAgICAgICAgKCFwbTJfZW52LnBtX2xvZ19wYXRoIHx8IFV0aWxpdHkuY2hlY2tQYXRoSXNOdWxsKHBtMl9lbnYucG1fbG9nX3BhdGgpKSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN0ZHMuc3RkICYmIHN0ZHMuc3RkLndyaXRlICYmIHN0ZHMuc3RkLndyaXRlKGxvZ19kYXRhKTtcbiAgICAgICAgc3Rkcy5lcnIgJiYgc3Rkcy5lcnIud3JpdGUgJiYgc3Rkcy5lcnIud3JpdGUobG9nX2RhdGEpO1xuICAgICAgfSk7XG5cbiAgICAgIGNzcHIuc3Rkb3V0Lm9uKCdkYXRhJywgZnVuY3Rpb24gZm9ya091dERhdGEoZGF0YSkge1xuICAgICAgICB2YXIgbG9nX2RhdGEgPSBudWxsO1xuXG4gICAgICAgIGlmIChwbTJfZW52LmRpc2FibGVfbG9ncyA9PT0gdHJ1ZSlcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgaWYgKHBtMl9lbnYubG9nX3R5cGUgJiYgcG0yX2Vudi5sb2dfdHlwZSA9PT0gJ2pzb24nKVxuICAgICAgICAgIGxvZ19kYXRhID0gdHJhbnNmb3JtTG9nVG9Kc29uKHBtMl9lbnYsICdvdXQnLCBkYXRhKVxuICAgICAgICBlbHNlIGlmIChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdClcbiAgICAgICAgICBsb2dfZGF0YSA9IHByZWZpeExvZ1dpdGhEYXRlKHBtMl9lbnYsIGRhdGEpXG4gICAgICAgIGVsc2VcbiAgICAgICAgICBsb2dfZGF0YSA9IGRhdGEudG9TdHJpbmcoKVxuXG4gICAgICAgIEdvZC5idXMuZW1pdCgnbG9nOm91dCcsIHtcbiAgICAgICAgICBwcm9jZXNzOiB7XG4gICAgICAgICAgICBwbV9pZDogY3Nwci5wbTJfZW52LnBtX2lkLFxuICAgICAgICAgICAgbmFtZTogY3Nwci5wbTJfZW52Lm5hbWUsXG4gICAgICAgICAgICByZXY6IChjc3ByLnBtMl9lbnYudmVyc2lvbmluZyAmJiBjc3ByLnBtMl9lbnYudmVyc2lvbmluZy5yZXZpc2lvbikgPyBjc3ByLnBtMl9lbnYudmVyc2lvbmluZy5yZXZpc2lvbiA6IG51bGwsXG4gICAgICAgICAgICBuYW1lc3BhY2U6IGNzcHIucG0yX2Vudi5uYW1lc3BhY2VcbiAgICAgICAgICB9LFxuICAgICAgICAgIGF0OiBVdGlsaXR5LmdldERhdGUoKSxcbiAgICAgICAgICBkYXRhOiBsb2dfZGF0YVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoVXRpbGl0eS5jaGVja1BhdGhJc051bGwocG0yX2Vudi5wbV9vdXRfbG9nX3BhdGgpICYmXG4gICAgICAgICAgKCFwbTJfZW52LnBtX2xvZ19wYXRoIHx8IFV0aWxpdHkuY2hlY2tQYXRoSXNOdWxsKHBtMl9lbnYucG1fbG9nX3BhdGgpKSlcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgc3Rkcy5zdGQgJiYgc3Rkcy5zdGQud3JpdGUgJiYgc3Rkcy5zdGQud3JpdGUobG9nX2RhdGEpO1xuICAgICAgICBzdGRzLm91dCAmJiBzdGRzLm91dC53cml0ZSAmJiBzdGRzLm91dC53cml0ZShsb2dfZGF0YSk7XG4gICAgICB9KTtcblxuICAgICAgLyoqXG4gICAgICAgKiBCcm9hZGNhc3QgbWVzc2FnZSB0byBHb2RcbiAgICAgICAqL1xuICAgICAgY3Nwci5vbignbWVzc2FnZScsIGZ1bmN0aW9uIGZvcmtNZXNzYWdlKG1zZykge1xuICAgICAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXG4gICAgICAgICAqIElmIHlvdSBlZGl0IHRoaXMgZnVuY3Rpb25cbiAgICAgICAgICogRG8gdGhlIHNhbWUgaW4gQ2x1c3Rlck1vZGUuanMgIVxuICAgICAgICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xuICAgICAgICBpZiAobXNnLmRhdGEgJiYgbXNnLnR5cGUpIHtcbiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBHb2QuYnVzLmVtaXQobXNnLnR5cGUgPyBtc2cudHlwZSA6ICdwcm9jZXNzOm1zZycsIHtcbiAgICAgICAgICAgICAgYXQ6IFV0aWxpdHkuZ2V0RGF0ZSgpLFxuICAgICAgICAgICAgICBkYXRhOiBtc2cuZGF0YSxcbiAgICAgICAgICAgICAgcHJvY2Vzczoge1xuICAgICAgICAgICAgICAgIHBtX2lkOiBjc3ByLnBtMl9lbnYucG1faWQsXG4gICAgICAgICAgICAgICAgbmFtZTogY3Nwci5wbTJfZW52Lm5hbWUsXG4gICAgICAgICAgICAgICAgdmVyc2lvbmluZzogY3Nwci5wbTJfZW52LnZlcnNpb25pbmcsXG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlOiBjc3ByLnBtMl9lbnYubmFtZXNwYWNlXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuXG4gICAgICAgICAgaWYgKHR5cGVvZiBtc2cgPT0gJ29iamVjdCcgJiYgJ25vZGVfdmVyc2lvbicgaW4gbXNnKSB7XG4gICAgICAgICAgICBjc3ByLnBtMl9lbnYubm9kZV92ZXJzaW9uID0gbXNnLm5vZGVfdmVyc2lvbjtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBtc2cgPT0gJ29iamVjdCcgJiYgJ2Nyb25fcmVzdGFydCcgaW4gbXNnKSB7XG4gICAgICAgICAgICAvLyBjcm9uIG9uVGljayBpcyBpbnZva2VkIGluIHRoZSBwcm9jZXNzXG4gICAgICAgICAgICByZXR1cm4gR29kLnJlc3RhcnRQcm9jZXNzSWQoe1xuICAgICAgICAgICAgICBpZDogY3Nwci5wbTJfZW52LnBtX2lkXG4gICAgICAgICAgICB9LCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdBcHBsaWNhdGlvbiAlcyBoYXMgYmVlbiByZXN0YXJ0ZWQgdmlhIENST04nLCBjc3ByLnBtMl9lbnYubmFtZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gR29kLmJ1cy5lbWl0KCdwcm9jZXNzOm1zZycsIHtcbiAgICAgICAgICAgIGF0OiBVdGlsaXR5LmdldERhdGUoKSxcbiAgICAgICAgICAgIHJhdzogbXNnLFxuICAgICAgICAgICAgcHJvY2Vzczoge1xuICAgICAgICAgICAgICBwbV9pZDogY3Nwci5wbTJfZW52LnBtX2lkLFxuICAgICAgICAgICAgICBuYW1lOiBjc3ByLnBtMl9lbnYubmFtZSxcbiAgICAgICAgICAgICAgbmFtZXNwYWNlOiBjc3ByLnBtMl9lbnYubmFtZXNwYWNlXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICB0cnkge1xuICAgICAgICB2YXIgcGlkID0gY3Nwci5waWRcbiAgICAgICAgaWYgKHR5cGVvZiAocGlkKSAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhwaWRGaWxlLCBwaWQudG9TdHJpbmcoKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZS5zdGFjayB8fCBlKTtcbiAgICAgIH1cblxuICAgICAgY3Nwci5vbmNlKCdleGl0JywgZnVuY3Rpb24gZm9ya0Nsb3NlKHN0YXR1cykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGZvciAodmFyIGsgaW4gc3Rkcykge1xuICAgICAgICAgICAgaWYgKHN0ZHNba10gJiYgc3Rkc1trXS5kZXN0cm95KSBzdGRzW2tdLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIGVsc2UgaWYgKHN0ZHNba10gJiYgc3Rkc1trXS5lbmQpIHN0ZHNba10uZW5kKCk7XG4gICAgICAgICAgICBlbHNlIGlmIChzdGRzW2tdICYmIHN0ZHNba10uY2xvc2UpIHN0ZHNba10uY2xvc2UoKTtcbiAgICAgICAgICAgIHN0ZHNba10gPSBzdGRzW2tdLl9maWxlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkgeyBHb2QubG9nQW5kR2VuZXJhdGVFcnJvcihlKTsgfVxuICAgICAgfSk7XG5cbiAgICAgIGNzcHIuX3JlbG9hZExvZ3MgPSBmdW5jdGlvbiAoY2IpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBmb3IgKHZhciBrIGluIHN0ZHMpIHtcbiAgICAgICAgICAgIGlmIChzdGRzW2tdICYmIHN0ZHNba10uZGVzdHJveSkgc3Rkc1trXS5kZXN0cm95KCk7XG4gICAgICAgICAgICBlbHNlIGlmIChzdGRzW2tdICYmIHN0ZHNba10uZW5kKSBzdGRzW2tdLmVuZCgpO1xuICAgICAgICAgICAgZWxzZSBpZiAoc3Rkc1trXSAmJiBzdGRzW2tdLmNsb3NlKSBzdGRzW2tdLmNsb3NlKCk7XG4gICAgICAgICAgICBzdGRzW2tdID0gc3Rkc1trXS5fZmlsZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGUpIHsgR29kLmxvZ0FuZEdlbmVyYXRlRXJyb3IoZSk7IH1cbiAgICAgICAgLy9jc3ByLnJlbW92ZUFsbExpc3RlbmVycygpO1xuICAgICAgICBVdGlsaXR5LnN0YXJ0TG9nZ2luZyhzdGRzLCBjYik7XG4gICAgICB9O1xuXG4gICAgICBjc3ByLnVucmVmKCk7XG5cbiAgICAgIHJldHVybiBjYihudWxsLCBjc3ByKTtcbiAgICB9KTtcblxuICB9O1xufTtcbiJdfQ==
/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
'use strict';
/**
 * @file Fork execution related functions
 * @author Alexandre Strzelewicz <as@unitech.io>
 * @project PM2
 */

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = ForkMode;

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _debug = _interopRequireDefault(require("debug"));

var _fs = _interopRequireDefault(require("fs"));

var _Utility = _interopRequireDefault(require("../Utility.js"));

var _path = _interopRequireDefault(require("path"));

var _dayjs = _interopRequireDefault(require("dayjs"));

var _semver = _interopRequireDefault(require("semver"));

var log = (0, _debug["default"])('pm2:fork_mode');
/**
 * Description
 * @method exports
 * @param {} God
 * @return
 */

function ForkMode(God) {
  /**
   * For all apps - FORK MODE
   * fork the app
   * @method forkMode
   * @param {} pm2_env
   * @param {} cb
   * @return
   */
  God.forkMode = function forkMode(pm2_env, cb) {
    var command = '';
    var args = [];
    console.log("App [".concat(pm2_env.name, ":").concat(pm2_env.pm_id, "] starting in -fork mode-"));

    var spawn = require('child_process').spawn;

    var interpreter = pm2_env.exec_interpreter || 'node';
    var pidFile = pm2_env.pm_pid_path;

    if (interpreter !== 'none') {
      command = interpreter;

      if (pm2_env.node_args && Array.isArray(pm2_env.node_args)) {
        args = args.concat(pm2_env.node_args);
      } // Deprecated - to remove at some point


      if (process.env.PM2_NODE_OPTIONS) {
        args = args.concat(process.env.PM2_NODE_OPTIONS.split(' '));
      }

      if (interpreter === 'node' || RegExp('node$').test(interpreter)) {
        if (_semver["default"].lt(process.version, '10.0.0')) {
          args.push(_path["default"].resolve(_path["default"].dirname(module.filename), '..', 'ProcessContainerForkLegacy.js'));
        } else {
          args.push(_path["default"].resolve(_path["default"].dirname(module.filename), '..', 'ProcessContainerFork.js'));
        }
      } else args.push(pm2_env.pm_exec_path);
    } else {
      command = pm2_env.pm_exec_path;
      args = [];
    }

    if (pm2_env.args) {
      args = args.concat(pm2_env.args);
    } // piping stream o file


    var stds = {
      out: pm2_env.pm_out_log_path,
      err: pm2_env.pm_err_log_path
    }; // entire log std if necessary.

    if ('pm_log_path' in pm2_env) {
      stds.std = pm2_env.pm_log_path;
    }

    log("stds: %j", stds);

    _Utility["default"].startLogging(stds, function (err, result) {
      if (err) {
        God.logAndGenerateError(err);
        return cb(err);
      }

      ;

      try {
        var options = {
          env: pm2_env,
          detached: true,
          cwd: pm2_env.pm_cwd || process.cwd(),
          stdio: ['pipe', 'pipe', 'pipe', 'ipc'] //Same as fork() in node core

        };

        if (typeof pm2_env.windowsHide === "boolean") {
          options.windowsHide = pm2_env.windowsHide;
        } else {
          options.windowsHide = true;
        }

        if (pm2_env.uid) {
          options.uid = pm2_env.uid;
        }

        if (pm2_env.gid) {
          options.gid = pm2_env.gid;
        }

        var cspr = spawn(command, args, options);
      } catch (e) {
        God.logAndGenerateError(e);
        return cb(e);
      }

      if (!cspr || !cspr.stderr || !cspr.stdout) {
        var fatalError = new Error('Process could not be forked properly, check your system health');
        God.logAndGenerateError(fatalError);
        return cb(fatalError);
      }

      cspr.process = {};
      cspr.process.pid = cspr.pid;
      cspr.pm2_env = pm2_env;

      function transformLogToJson(pm2_env, type, data) {
        return JSON.stringify({
          message: data.toString(),
          timestamp: pm2_env.log_date_format ? (0, _dayjs["default"])().format(pm2_env.log_date_format) : new Date().toISOString(),
          type: type,
          process_id: cspr.pm2_env.pm_id,
          app_name: cspr.pm2_env.name
        }) + '\n';
      }

      function prefixLogWithDate(pm2_env, data) {
        var log_data = [];
        log_data = data.toString().split('\n');
        if (log_data.length > 1) log_data.pop();
        log_data = log_data.map(function (line) {
          return "".concat((0, _dayjs["default"])().format(pm2_env.log_date_format), ": ").concat(line, "\n");
        });
        return log_data.join('');
      }

      cspr.stderr.on('data', function forkErrData(data) {
        var log_data = null; // via --out /dev/null --err /dev/null

        if (pm2_env.disable_logs === true) return false;
        if (pm2_env.log_type && pm2_env.log_type === 'json') log_data = transformLogToJson(pm2_env, 'err', data);else if (pm2_env.log_date_format) log_data = prefixLogWithDate(pm2_env, data);else log_data = data.toString();
        God.bus.emit('log:err', {
          process: {
            pm_id: cspr.pm2_env.pm_id,
            name: cspr.pm2_env.name,
            rev: cspr.pm2_env.versioning && cspr.pm2_env.versioning.revision ? cspr.pm2_env.versioning.revision : null,
            namespace: cspr.pm2_env.namespace
          },
          at: _Utility["default"].getDate(),
          data: log_data
        });

        if (_Utility["default"].checkPathIsNull(pm2_env.pm_err_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) {
          return false;
        }

        stds.std && stds.std.write && stds.std.write(log_data);
        stds.err && stds.err.write && stds.err.write(log_data);
      });
      cspr.stdout.on('data', function forkOutData(data) {
        var log_data = null;
        if (pm2_env.disable_logs === true) return false;
        if (pm2_env.log_type && pm2_env.log_type === 'json') log_data = transformLogToJson(pm2_env, 'out', data);else if (pm2_env.log_date_format) log_data = prefixLogWithDate(pm2_env, data);else log_data = data.toString();
        God.bus.emit('log:out', {
          process: {
            pm_id: cspr.pm2_env.pm_id,
            name: cspr.pm2_env.name,
            rev: cspr.pm2_env.versioning && cspr.pm2_env.versioning.revision ? cspr.pm2_env.versioning.revision : null,
            namespace: cspr.pm2_env.namespace
          },
          at: _Utility["default"].getDate(),
          data: log_data
        });
        if (_Utility["default"].checkPathIsNull(pm2_env.pm_out_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) return false;
        stds.std && stds.std.write && stds.std.write(log_data);
        stds.out && stds.out.write && stds.out.write(log_data);
      });
      /**
       * Broadcast message to God
       */

      cspr.on('message', function forkMessage(msg) {
        /*********************************
         * If you edit this function
         * Do the same in ClusterMode.js !
         *********************************/
        if (msg.data && msg.type) {
          process.nextTick(function () {
            return God.bus.emit(msg.type ? msg.type : 'process:msg', {
              at: _Utility["default"].getDate(),
              data: msg.data,
              process: {
                pm_id: cspr.pm2_env.pm_id,
                name: cspr.pm2_env.name,
                versioning: cspr.pm2_env.versioning,
                namespace: cspr.pm2_env.namespace
              }
            });
          });
        } else {
          if ((0, _typeof2["default"])(msg) == 'object' && 'node_version' in msg) {
            cspr.pm2_env.node_version = msg.node_version;
            return false;
          } else if ((0, _typeof2["default"])(msg) == 'object' && 'cron_restart' in msg) {
            // cron onTick is invoked in the process
            return God.restartProcessId({
              id: cspr.pm2_env.pm_id
            }, function () {
              console.log('Application %s has been restarted via CRON', cspr.pm2_env.name);
            });
          }

          return God.bus.emit('process:msg', {
            at: _Utility["default"].getDate(),
            raw: msg,
            process: {
              pm_id: cspr.pm2_env.pm_id,
              name: cspr.pm2_env.name,
              namespace: cspr.pm2_env.namespace
            }
          });
        }
      });

      try {
        var pid = cspr.pid;
        if (typeof pid !== 'undefined') _fs["default"].writeFileSync(pidFile, pid.toString());
      } catch (e) {
        console.error(e.stack || e);
      }

      cspr.once('exit', function forkClose(status) {
        try {
          for (var k in stds) {
            if (stds[k] && stds[k].destroy) stds[k].destroy();else if (stds[k] && stds[k].end) stds[k].end();else if (stds[k] && stds[k].close) stds[k].close();
            stds[k] = stds[k]._file;
          }
        } catch (e) {
          God.logAndGenerateError(e);
        }
      });

      cspr._reloadLogs = function (cb) {
        try {
          for (var k in stds) {
            if (stds[k] && stds[k].destroy) stds[k].destroy();else if (stds[k] && stds[k].end) stds[k].end();else if (stds[k] && stds[k].close) stds[k].close();
            stds[k] = stds[k]._file;
          }
        } catch (e) {
          God.logAndGenerateError(e);
        } //cspr.removeAllListeners();


        _Utility["default"].startLogging(stds, cb);
      };

      cspr.unref();
      return cb(null, cspr);
    });
  };
}

;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Hb2QvRm9ya01vZGUudHMiXSwibmFtZXMiOlsibG9nIiwiRm9ya01vZGUiLCJHb2QiLCJmb3JrTW9kZSIsInBtMl9lbnYiLCJjYiIsImNvbW1hbmQiLCJhcmdzIiwiY29uc29sZSIsIm5hbWUiLCJwbV9pZCIsInNwYXduIiwicmVxdWlyZSIsImludGVycHJldGVyIiwiZXhlY19pbnRlcnByZXRlciIsInBpZEZpbGUiLCJwbV9waWRfcGF0aCIsIm5vZGVfYXJncyIsIkFycmF5IiwiaXNBcnJheSIsImNvbmNhdCIsInByb2Nlc3MiLCJlbnYiLCJQTTJfTk9ERV9PUFRJT05TIiwic3BsaXQiLCJSZWdFeHAiLCJ0ZXN0Iiwic2VtdmVyIiwibHQiLCJ2ZXJzaW9uIiwicHVzaCIsInBhdGgiLCJyZXNvbHZlIiwiZGlybmFtZSIsIm1vZHVsZSIsImZpbGVuYW1lIiwicG1fZXhlY19wYXRoIiwic3RkcyIsIm91dCIsInBtX291dF9sb2dfcGF0aCIsImVyciIsInBtX2Vycl9sb2dfcGF0aCIsInN0ZCIsInBtX2xvZ19wYXRoIiwiVXRpbGl0eSIsInN0YXJ0TG9nZ2luZyIsInJlc3VsdCIsImxvZ0FuZEdlbmVyYXRlRXJyb3IiLCJvcHRpb25zIiwiZGV0YWNoZWQiLCJjd2QiLCJwbV9jd2QiLCJzdGRpbyIsIndpbmRvd3NIaWRlIiwidWlkIiwiZ2lkIiwiY3NwciIsImUiLCJzdGRlcnIiLCJzdGRvdXQiLCJmYXRhbEVycm9yIiwiRXJyb3IiLCJwaWQiLCJ0cmFuc2Zvcm1Mb2dUb0pzb24iLCJ0eXBlIiwiZGF0YSIsIkpTT04iLCJzdHJpbmdpZnkiLCJtZXNzYWdlIiwidG9TdHJpbmciLCJ0aW1lc3RhbXAiLCJsb2dfZGF0ZV9mb3JtYXQiLCJmb3JtYXQiLCJEYXRlIiwidG9JU09TdHJpbmciLCJwcm9jZXNzX2lkIiwiYXBwX25hbWUiLCJwcmVmaXhMb2dXaXRoRGF0ZSIsImxvZ19kYXRhIiwibGVuZ3RoIiwicG9wIiwibWFwIiwibGluZSIsImpvaW4iLCJvbiIsImZvcmtFcnJEYXRhIiwiZGlzYWJsZV9sb2dzIiwibG9nX3R5cGUiLCJidXMiLCJlbWl0IiwicmV2IiwidmVyc2lvbmluZyIsInJldmlzaW9uIiwibmFtZXNwYWNlIiwiYXQiLCJnZXREYXRlIiwiY2hlY2tQYXRoSXNOdWxsIiwid3JpdGUiLCJmb3JrT3V0RGF0YSIsImZvcmtNZXNzYWdlIiwibXNnIiwibmV4dFRpY2siLCJub2RlX3ZlcnNpb24iLCJyZXN0YXJ0UHJvY2Vzc0lkIiwiaWQiLCJyYXciLCJmcyIsIndyaXRlRmlsZVN5bmMiLCJlcnJvciIsInN0YWNrIiwib25jZSIsImZvcmtDbG9zZSIsInN0YXR1cyIsImsiLCJkZXN0cm95IiwiZW5kIiwiY2xvc2UiLCJfZmlsZSIsIl9yZWxvYWRMb2dzIiwidW5yZWYiXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQUtBO0FBRUE7Ozs7Ozs7Ozs7Ozs7OztBQUtBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQU1BLEdBQUcsR0FBRyx1QkFBWSxlQUFaLENBQVo7QUFDQTs7Ozs7OztBQU1lLFNBQVNDLFFBQVQsQ0FBa0JDLEdBQWxCLEVBQXVCO0FBQ3BDOzs7Ozs7OztBQVFBQSxFQUFBQSxHQUFHLENBQUNDLFFBQUosR0FBZSxTQUFTQSxRQUFULENBQWtCQyxPQUFsQixFQUEyQkMsRUFBM0IsRUFBK0I7QUFDNUMsUUFBSUMsT0FBTyxHQUFHLEVBQWQ7QUFDQSxRQUFJQyxJQUFJLEdBQU0sRUFBZDtBQUVBQyxJQUFBQSxPQUFPLENBQUNSLEdBQVIsZ0JBQW9CSSxPQUFPLENBQUNLLElBQTVCLGNBQW9DTCxPQUFPLENBQUNNLEtBQTVDOztBQUNBLFFBQUlDLEtBQUssR0FBR0MsT0FBTyxDQUFDLGVBQUQsQ0FBUCxDQUF5QkQsS0FBckM7O0FBRUEsUUFBSUUsV0FBVyxHQUFHVCxPQUFPLENBQUNVLGdCQUFSLElBQTRCLE1BQTlDO0FBQ0EsUUFBSUMsT0FBTyxHQUFPWCxPQUFPLENBQUNZLFdBQTFCOztBQUVBLFFBQUlILFdB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Q0FBUUcsS0FBUjtBQUNuQy9FLFlBQUFBLElBQUksQ0FBQzRFLENBQUQsQ0FBSixHQUFVNUUsSUFBSSxDQUFDNEUsQ0FBRCxDQUFKLENBQVFJLEtBQWxCO0FBQ0Q7QUFDRixTQVBELENBT0UsT0FBTTVELENBQU4sRUFBUztBQUFFdkQsVUFBQUEsR0FBRyxDQUFDNkMsbUJBQUosQ0FBd0JVLENBQXhCO0FBQTRCLFNBUlgsQ0FTOUI7OztBQUNBYiw0QkFBUUMsWUFBUixDQUFxQlIsSUFBckIsRUFBMkJoQyxFQUEzQjtBQUNELE9BWEQ7O0FBYUFtRCxNQUFBQSxJQUFJLENBQUMrRCxLQUFMO0FBRUEsYUFBT2xILEVBQUUsQ0FBQyxJQUFELEVBQU9tRCxJQUFQLENBQVQ7QUFDRCxLQW5ORDtBQXFORCxHQTVRRDtBQTZRRDs7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMTMgdGhlIFBNMiBwcm9qZWN0IGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIGxpY2Vuc2UgdGhhdFxuICogY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuXG4gKi9cbid1c2Ugc3RyaWN0JztcblxuLyoqXG4gKiBAZmlsZSBGb3JrIGV4ZWN1dGlvbiByZWxhdGVkIGZ1bmN0aW9uc1xuICogQGF1dGhvciBBbGV4YW5kcmUgU3RyemVsZXdpY3ogPGFzQHVuaXRlY2guaW8+XG4gKiBAcHJvamVjdCBQTTJcbiAqL1xuaW1wb3J0IGRlYnVnTG9nZ2VyICAgICAgICAgICBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZnMgICAgICAgICAgICBmcm9tICdmcyc7XG5pbXBvcnQgVXRpbGl0eSAgICAgICBmcm9tICcuLi9VdGlsaXR5LmpzJztcbmltcG9ydCBwYXRoICAgICAgICAgIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGRheWpzICAgICAgICAgZnJvbSAnZGF5anMnO1xuaW1wb3J0IHNlbXZlciAgZnJvbSAnc2VtdmVyJztcblxuY29uc3QgbG9nID0gZGVidWdMb2dnZXIoJ3BtMjpmb3JrX21vZGUnKTtcbi8qKlxuICogRGVzY3JpcHRpb25cbiAqIEBtZXRob2QgZXhwb3J0c1xuICogQHBhcmFtIHt9IEdvZFxuICogQHJldHVyblxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBGb3JrTW9kZShHb2QpIHtcbiAgLyoqXG4gICAqIEZvciBhbGwgYXBwcyAtIEZPUksgTU9ERVxuICAgKiBmb3JrIHRoZSBhcHBcbiAgICogQG1ldGhvZCBmb3JrTW9kZVxuICAgKiBAcGFyYW0ge30gcG0yX2VudlxuICAgKiBAcGFyYW0ge30gY2JcbiAgICogQHJldHVyblxuICAgKi9cbiAgR29kLmZvcmtNb2RlID0gZnVuY3Rpb24gZm9ya01vZGUocG0yX2VudiwgY2IpIHtcbiAgICB2YXIgY29tbWFuZCA9ICcnO1xuICAgIHZhciBhcmdzICAgID0gW107XG5cbiAgICBjb25zb2xlLmxvZyhgQXBwIFske3BtMl9lbnYubmFtZX06JHtwbTJfZW52LnBtX2lkfV0gc3RhcnRpbmcgaW4gLWZvcmsgbW9kZS1gKVxuICAgIHZhciBzcGF3biA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKS5zcGF3bjtcblxuICAgIHZhciBpbnRlcnByZXRlciA9IHBtMl9lbnYuZXhlY19pbnRlcnByZXRlciB8fCAnbm9kZSc7XG4gICAgdmFyIHBpZEZpbGUgICAgID0gcG0yX2Vudi5wbV9waWRfcGF0aDtcblxuICAgIGlmIChpbnRlcnByZXRlciAhPT0gJ25vbmUnKSB7XG4gICAgICBjb21tYW5kID0gaW50ZXJwcmV0ZXI7XG5cbiAgICAgIGlmIChwbTJfZW52Lm5vZGVfYXJncyAmJiBBcnJheS5pc0FycmF5KHBtMl9lbnYubm9kZV9hcmdzKSkge1xuICAgICAgICBhcmdzID0gYXJncy5jb25jYXQocG0yX2Vudi5ub2RlX2FyZ3MpO1xuICAgICAgfVxuXG4gICAgICAvLyBEZXByZWNhdGVkIC0gdG8gcmVtb3ZlIGF0IHNvbWUgcG9pbnRcbiAgICAgIGlmIChwcm9jZXNzLmVudi5QTTJfTk9ERV9PUFRJT05TKSB7XG4gICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChwcm9jZXNzLmVudi5QTTJfTk9ERV9PUFRJT05TLnNwbGl0KCcgJykpO1xuICAgICAgfVxuXG4gICAgICBpZiAoaW50ZXJwcmV0ZXIgPT09ICdub2RlJyB8fCBSZWdFeHAoJ25vZGUkJykudGVzdChpbnRlcnByZXRlcikpIHtcbiAgICAgICAgaWYgKHNlbXZlci5sdChwcm9jZXNzLnZlcnNpb24sICcxMC4wLjAnKSkge1xuICAgICAgICAgIGFyZ3MucHVzaChwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKG1vZHVsZS5maWxlbmFtZSksICcuLicsICdQcm9jZXNzQ29udGFpbmVyRm9ya0xlZ2FjeS5qcycpKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICBhcmdzLnB1c2gocGF0aC5yZXNvbHZlKHBhdGguZGlybmFtZShtb2R1bGUuZmlsZW5hbWUpLCAnLi4nLCAnUHJvY2Vzc0NvbnRhaW5lckZvcmsuanMnKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2VcbiAgICAgICAgYXJncy5wdXNoKHBtMl9lbnYucG1fZXhlY19wYXRoKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBjb21tYW5kID0gcG0yX2Vudi5wbV9leGVjX3BhdGg7XG4gICAgICBhcmdzID0gWyBdO1xuICAgIH1cblxuICAgIGlmIChwbTJfZW52LmFyZ3MpIHtcbiAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChwbTJfZW52LmFyZ3MpO1xuICAgIH1cblxuICAgIC8vIHBpcGluZyBzdHJlYW0gbyBmaWxlXG4gICAgdmFyIHN0ZHM6IGFueSA9IHtcbiAgICAgIG91dDogcG0yX2Vudi5wbV9vdXRfbG9nX3BhdGgsXG4gICAgICBlcnI6IHBtMl9lbnYucG1fZXJyX2xvZ19wYXRoXG4gICAgfTtcblxuICAgIC8vIGVudGlyZSBsb2cgc3RkIGlmIG5lY2Vzc2FyeS5cbiAgICBpZiAoJ3BtX2xvZ19wYXRoJyBpbiBwbTJfZW52KXtcbiAgICAgIHN0ZHMuc3RkID0gcG0yX2Vudi5wbV9sb2dfcGF0aDtcbiAgICB9XG5cbiAgICBsb2coXCJzdGRzOiAlalwiLCBzdGRzKTtcblxuICAgIFV0aWxpdHkuc3RhcnRMb2dnaW5nKHN0ZHMsIGZ1bmN0aW9uKGVyciwgcmVzdWx0KSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIEdvZC5sb2dBbmRHZW5lcmF0ZUVycm9yKGVycik7XG4gICAgICAgIHJldHVybiBjYihlcnIpO1xuICAgICAgfTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgdmFyIG9wdGlvbnM6IGFueSA9IHtcbiAgICAgICAgICBlbnYgICAgICA6IHBtMl9lbnYsXG4gICAgICAgICAgZGV0YWNoZWQgOiB0cnVlLFxuICAgICAgICAgIGN3ZCAgICAgIDogcG0yX2Vudi5wbV9jd2QgfHwgcHJvY2Vzcy5jd2QoKSxcbiAgICAgICAgICBzdGRpbyAgICA6IFsncGlwZScsICdwaXBlJywgJ3BpcGUnLCAnaXBjJ10gLy9TYW1lIGFzIGZvcmsoKSBpbiBub2RlIGNvcmVcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2YocG0yX2Vudi53aW5kb3dzSGlkZSkgPT09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgICAgb3B0aW9ucy53aW5kb3dzSGlkZSA9IHBtMl9lbnYud2luZG93c0hpZGU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3B0aW9ucy53aW5kb3dzSGlkZSA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocG0yX2Vudi51aWQpIHtcbiAgICAgICAgICBvcHRpb25zLnVpZCA9IHBtMl9lbnYudWlkXG4gICAgICAgIH1cblxuICAgICAgICBpZiAocG0yX2Vudi5naWQpIHtcbiAgICAgICAgICBvcHRpb25zLmdpZCA9IHBtMl9lbnYuZ2lkXG4gICAgICAgIH1cblxuICAgICAgICB2YXIgY3NwciA9IHNwYXduKGNvbW1hbmQsIGFyZ3MsIG9wdGlvbnMpO1xuICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgIEdvZC5sb2dBbmRHZW5lcmF0ZUVycm9yKGUpO1xuICAgICAgICByZXR1cm4gY2IoZSk7XG4gICAgICB9XG5cbiAgICAgIGlmICghY3NwciB8fCAhY3Nwci5zdGRlcnIgfHwgIWNzcHIuc3Rkb3V0KSB7XG4gICAgICAgIHZhciBmYXRhbEVycm9yID0gbmV3IEVycm9yKCdQcm9jZXNzIGNvdWxkIG5vdCBiZSBmb3JrZWQgcHJvcGVybHksIGNoZWNrIHlvdXIgc3lzdGVtIGhlYWx0aCcpXG4gICAgICAgIEdvZC5sb2dBbmRHZW5lcmF0ZUVycm9yKGZhdGFsRXJyb3IpO1xuICAgICAgICByZXR1cm4gY2IoZmF0YWxFcnJvcik7XG4gICAgICB9XG5cbiAgICAgIGNzcHIucHJvY2VzcyA9IHt9O1xuICAgICAgY3Nwci5wcm9jZXNzLnBpZCA9IGNzcHIucGlkO1xuICAgICAgY3Nwci5wbTJfZW52ID0gcG0yX2VudjtcblxuICAgICAgZnVuY3Rpb24gdHJhbnNmb3JtTG9nVG9Kc29uKHBtMl9lbnYsIHR5cGUsIGRhdGEpIHtcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBtZXNzYWdlIDogZGF0YS50b1N0cmluZygpLFxuICAgICAgICAgIHRpbWVzdGFtcCA6IHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0ID8gZGF5anMoKS5mb3JtYXQocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQpIDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIHR5cGUgOiB0eXBlLFxuICAgICAgICAgIHByb2Nlc3NfaWQgOiBjc3ByLnBtMl9lbnYucG1faWQsXG4gICAgICAgICAgYXBwX25hbWUgOiBjc3ByLnBtMl9lbnYubmFtZVxuICAgICAgICB9KSArICdcXG4nXG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIHByZWZpeExvZ1dpdGhEYXRlKHBtMl9lbnYsIGRhdGEpIHtcbiAgICAgICAgdmFyIGxvZ19kYXRhOiBhbnlbXSA9IFtdXG4gICAgICAgIGxvZ19kYXRhID0gZGF0YS50b1N0cmluZygpLnNwbGl0KCdcXG4nKVxuICAgICAgICBpZiAobG9nX2RhdGEubGVuZ3RoID4gMSlcbiAgICAgICAgICBsb2dfZGF0YS5wb3AoKVxuICAgICAgICBsb2dfZGF0YSA9IGxvZ19kYXRhLm1hcChsaW5lID0+IGAke2RheWpzKCkuZm9ybWF0KHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0KX06ICR7bGluZX1cXG5gKVxuICAgICAgICByZXR1cm4gbG9nX2RhdGEuam9pbignJylcbiAgICAgIH1cblxuICAgICAgY3Nwci5zdGRlcnIub24oJ2RhdGEnLCBmdW5jdGlvbiBmb3JrRXJyRGF0YShkYXRhKSB7XG4gICAgICAgIHZhciBsb2dfZGF0YSA9IG51bGw7XG5cbiAgICAgICAgLy8gdmlhIC0tb3V0IC9kZXYvbnVsbCAtLWVyciAvZGV2L251bGxcbiAgICAgICAgaWYgKHBtMl9lbnYuZGlzYWJsZV9sb2dzID09PSB0cnVlKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgaWYgKHBtMl9lbnYubG9nX3R5cGUgJiYgcG0yX2Vudi5sb2dfdHlwZSA9PT0gJ2pzb24nKVxuICAgICAgICAgIGxvZ19kYXRhID0gdHJhbnNmb3JtTG9nVG9Kc29uKHBtMl9lbnYsICdlcnInLCBkYXRhKVxuICAgICAgICBlbHNlIGlmIChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdClcbiAgICAgICAgICBsb2dfZGF0YSA9IHByZWZpeExvZ1dpdGhEYXRlKHBtMl9lbnYsIGRhdGEpXG4gICAgICAgIGVsc2VcbiAgICAgICAgICBsb2dfZGF0YSA9IGRhdGEudG9TdHJpbmcoKTtcblxuICAgICAgICBHb2QuYnVzLmVtaXQoJ2xvZzplcnInLCB7XG4gICAgICAgICAgcHJvY2VzcyA6IHtcbiAgICAgICAgICAgIHBtX2lkICAgICAgOiBjc3ByLnBtMl9lbnYucG1faWQsXG4gICAgICAgICAgICBuYW1lICAgICAgIDogY3Nwci5wbTJfZW52Lm5hbWUsXG4gICAgICAgICAgICByZXYgICAgICAgIDogKGNzcHIucG0yX2Vudi52ZXJzaW9uaW5nICYmIGNzcHIucG0yX2Vudi52ZXJzaW9uaW5nLnJldmlzaW9uKSA/IGNzcHIucG0yX2Vudi52ZXJzaW9uaW5nLnJldmlzaW9uIDogbnVsbCxcbiAgICAgICAgICAgIG5hbWVzcGFjZSAgOiBjc3ByLnBtMl9lbnYubmFtZXNwYWNlXG4gICAgICAgICAgfSxcbiAgICAgICAgICBhdCAgOiBVdGlsaXR5LmdldERhdGUoKSxcbiAgICAgICAgICBkYXRhIDogbG9nX2RhdGFcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKFV0aWxpdHkuY2hlY2tQYXRoSXNOdWxsKHBtMl9lbnYucG1fZXJyX2xvZ19wYXRoKSAmJlxuICAgICAgICAgICghcG0yX2Vudi5wbV9sb2dfcGF0aCB8fCBVdGlsaXR5LmNoZWNrUGF0aElzTnVsbChwbTJfZW52LnBtX2xvZ19wYXRoKSkpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBzdGRzLnN0ZCAmJiBzdGRzLnN0ZC53cml0ZSAmJiBzdGRzLnN0ZC53cml0ZShsb2dfZGF0YSk7XG4gICAgICAgIHN0ZHMuZXJyICYmIHN0ZHMuZXJyLndyaXRlICYmIHN0ZHMuZXJyLndyaXRlKGxvZ19kYXRhKTtcbiAgICAgIH0pO1xuXG4gICAgICBjc3ByLnN0ZG91dC5vbignZGF0YScsIGZ1bmN0aW9uIGZvcmtPdXREYXRhKGRhdGEpIHtcbiAgICAgICAgdmFyIGxvZ19kYXRhID0gbnVsbDtcblxuICAgICAgICBpZiAocG0yX2Vudi5kaXNhYmxlX2xvZ3MgPT09IHRydWUpXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIGlmIChwbTJfZW52LmxvZ190eXBlICYmIHBtMl9lbnYubG9nX3R5cGUgPT09ICdqc29uJylcbiAgICAgICAgICBsb2dfZGF0YSA9IHRyYW5zZm9ybUxvZ1RvSnNvbihwbTJfZW52LCAnb3V0JywgZGF0YSlcbiAgICAgICAgZWxzZSBpZiAocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQpXG4gICAgICAgICAgbG9nX2RhdGEgPSBwcmVmaXhMb2dXaXRoRGF0ZShwbTJfZW52LCBkYXRhKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgbG9nX2RhdGEgPSBkYXRhLnRvU3RyaW5nKClcblxuICAgICAgICBHb2QuYnVzLmVtaXQoJ2xvZzpvdXQnLCB7XG4gICAgICAgICAgcHJvY2VzcyA6IHtcbiAgICAgICAgICAgIHBtX2lkICAgICAgOiBjc3ByLnBtMl9lbnYucG1faWQsXG4gICAgICAgICAgICBuYW1lICAgICAgIDogY3Nwci5wbTJfZW52Lm5hbWUsXG4gICAgICAgICAgICByZXYgICAgICAgIDogKGNzcHIucG0yX2Vudi52ZXJzaW9uaW5nICYmIGNzcHIucG0yX2Vudi52ZXJzaW9uaW5nLnJldmlzaW9uKSA/IGNzcHIucG0yX2Vudi52ZXJzaW9uaW5nLnJldmlzaW9uIDogbnVsbCxcbiAgICAgICAgICAgIG5hbWVzcGFjZSAgOiBjc3ByLnBtMl9lbnYubmFtZXNwYWNlXG4gICAgICAgICAgfSxcbiAgICAgICAgICBhdCAgOiBVdGlsaXR5LmdldERhdGUoKSxcbiAgICAgICAgICBkYXRhIDogbG9nX2RhdGFcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKFV0aWxpdHkuY2hlY2tQYXRoSXNOdWxsKHBtMl9lbnYucG1fb3V0X2xvZ19wYXRoKSAmJlxuICAgICAgICAgICghcG0yX2Vudi5wbV9sb2dfcGF0aCB8fCBVdGlsaXR5LmNoZWNrUGF0aElzTnVsbChwbTJfZW52LnBtX2xvZ19wYXRoKSkpXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIHN0ZHMuc3RkICYmIHN0ZHMuc3RkLndyaXRlICYmIHN0ZHMuc3RkLndyaXRlKGxvZ19kYXRhKTtcbiAgICAgICAgc3Rkcy5vdXQgJiYgc3Rkcy5vdXQud3JpdGUgJiYgc3Rkcy5vdXQud3JpdGUobG9nX2RhdGEpO1xuICAgICAgfSk7XG5cbiAgICAgIC8qKlxuICAgICAgICogQnJvYWRjYXN0IG1lc3NhZ2UgdG8gR29kXG4gICAgICAgKi9cbiAgICAgIGNzcHIub24oJ21lc3NhZ2UnLCBmdW5jdGlvbiBmb3JrTWVzc2FnZShtc2cpIHtcbiAgICAgICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICAgICAgICAgKiBJZiB5b3UgZWRpdCB0aGlzIGZ1bmN0aW9uXG4gICAgICAgICAqIERvIHRoZSBzYW1lIGluIENsdXN0ZXJNb2RlLmpzICFcbiAgICAgICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cbiAgICAgICAgaWYgKG1zZy5kYXRhICYmIG1zZy50eXBlKSB7XG4gICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldHVybiBHb2QuYnVzLmVtaXQobXNnLnR5cGUgPyBtc2cudHlwZSA6ICdwcm9jZXNzOm1zZycsIHtcbiAgICAgICAgICAgICAgYXQgICAgICA6IFV0aWxpdHkuZ2V0RGF0ZSgpLFxuICAgICAgICAgICAgICBkYXRhICAgIDogbXNnLmRhdGEsXG4gICAgICAgICAgICAgIHByb2Nlc3MgOiB7XG4gICAgICAgICAgICAgICAgcG1faWQgICAgICA6IGNzcHIucG0yX2Vudi5wbV9pZCxcbiAgICAgICAgICAgICAgICBuYW1lICAgICAgIDogY3Nwci5wbTJfZW52Lm5hbWUsXG4gICAgICAgICAgICAgICAgdmVyc2lvbmluZyA6IGNzcHIucG0yX2Vudi52ZXJzaW9uaW5nLFxuICAgICAgICAgICAgICAgIG5hbWVzcGFjZSAgOiBjc3ByLnBtMl9lbnYubmFtZXNwYWNlXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuXG4gICAgICAgICAgaWYgKHR5cGVvZiBtc2cgPT0gJ29iamVjdCcgJiYgJ25vZGVfdmVyc2lvbicgaW4gbXNnKSB7XG4gICAgICAgICAgICBjc3ByLnBtMl9lbnYubm9kZV92ZXJzaW9uID0gbXNnLm5vZGVfdmVyc2lvbjtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBtc2cgPT0gJ29iamVjdCcgJiYgJ2Nyb25fcmVzdGFydCcgaW4gbXNnKSB7XG4gICAgICAgICAgICAvLyBjcm9uIG9uVGljayBpcyBpbnZva2VkIGluIHRoZSBwcm9jZXNzXG4gICAgICAgICAgICByZXR1cm4gR29kLnJlc3RhcnRQcm9jZXNzSWQoe1xuICAgICAgICAgICAgICBpZCA6IGNzcHIucG0yX2Vudi5wbV9pZFxuICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdBcHBsaWNhdGlvbiAlcyBoYXMgYmVlbiByZXN0YXJ0ZWQgdmlhIENST04nLCBjc3ByLnBtMl9lbnYubmFtZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gR29kLmJ1cy5lbWl0KCdwcm9jZXNzOm1zZycsIHtcbiAgICAgICAgICAgIGF0ICAgICAgOiBVdGlsaXR5LmdldERhdGUoKSxcbiAgICAgICAgICAgIHJhdyAgICAgOiBtc2csXG4gICAgICAgICAgICBwcm9jZXNzIDogIHtcbiAgICAgICAgICAgICAgcG1faWQgICAgICA6IGNzcHIucG0yX2Vudi5wbV9pZCxcbiAgICAgICAgICAgICAgbmFtZSAgICAgICA6IGNzcHIucG0yX2Vudi5uYW1lLFxuICAgICAgICAgICAgICBuYW1lc3BhY2UgIDogY3Nwci5wbTJfZW52Lm5hbWVzcGFjZVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgdmFyIHBpZCA9IGNzcHIucGlkXG4gICAgICAgIGlmICh0eXBlb2YocGlkKSAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhwaWRGaWxlLCBwaWQudG9TdHJpbmcoKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZS5zdGFjayB8fCBlKTtcbiAgICAgIH1cblxuICAgICAgY3Nwci5vbmNlKCdleGl0JywgZnVuY3Rpb24gZm9ya0Nsb3NlKHN0YXR1cykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGZvcih2YXIgayBpbiBzdGRzKXtcbiAgICAgICAgICAgIGlmIChzdGRzW2tdICYmIHN0ZHNba10uZGVzdHJveSkgc3Rkc1trXS5kZXN0cm95KCk7XG4gICAgICAgICAgICBlbHNlIGlmIChzdGRzW2tdICYmIHN0ZHNba10uZW5kKSBzdGRzW2tdLmVuZCgpO1xuICAgICAgICAgICAgZWxzZSBpZiAoc3Rkc1trXSAmJiBzdGRzW2tdLmNsb3NlKSBzdGRzW2tdLmNsb3NlKCk7XG4gICAgICAgICAgICBzdGRzW2tdID0gc3Rkc1trXS5fZmlsZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2goZSkgeyBHb2QubG9nQW5kR2VuZXJhdGVFcnJvcihlKTt9XG4gICAgICB9KTtcblxuICAgICAgY3Nwci5fcmVsb2FkTG9ncyA9IGZ1bmN0aW9uKGNiKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgZm9yICh2YXIgayBpbiBzdGRzKXtcbiAgICAgICAgICAgIGlmIChzdGRzW2tdICYmIHN0ZHNba10uZGVzdHJveSkgc3Rkc1trXS5kZXN0cm95KCk7XG4gICAgICAgICAgICBlbHNlIGlmIChzdGRzW2tdICYmIHN0ZHNba10uZW5kKSBzdGRzW2tdLmVuZCgpO1xuICAgICAgICAgICAgZWxzZSBpZiAoc3Rkc1trXSAmJiBzdGRzW2tdLmNsb3NlKSBzdGRzW2tdLmNsb3NlKCk7XG4gICAgICAgICAgICBzdGRzW2tdID0gc3Rkc1trXS5fZmlsZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2goZSkgeyBHb2QubG9nQW5kR2VuZXJhdGVFcnJvcihlKTt9XG4gICAgICAgIC8vY3Nwci5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcbiAgICAgICAgVXRpbGl0eS5zdGFydExvZ2dpbmcoc3RkcywgY2IpO1xuICAgICAgfTtcblxuICAgICAgY3Nwci51bnJlZigpO1xuXG4gICAgICByZXR1cm4gY2IobnVsbCwgY3Nwcik7XG4gICAgfSk7XG5cbiAgfTtcbn07XG4iXX0=
/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
'use strict';
/**
 * @file Fork execution related functions
 * @author Alexandre Strzelewicz <as@unitech.io>
 * @project PM2
 */

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = ForkMode;

var _debug = _interopRequireDefault(require("debug"));

var _fs = _interopRequireDefault(require("fs"));

var _Utility = _interopRequireDefault(require("../Utility.js"));

var _path = _interopRequireDefault(require("path"));

var _dayjs = _interopRequireDefault(require("dayjs"));

var _semver = _interopRequireDefault(require("semver"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

var log = (0, _debug["default"])('pm2:fork_mode');
/**
 * Description
 * @method exports
 * @param {} God
 * @return
 */

function ForkMode(God) {
  /**
   * For all apps - FORK MODE
   * fork the app
   * @method forkMode
   * @param {} pm2_env
   * @param {} cb
   * @return
   */
  God.forkMode = function forkMode(pm2_env, cb) {
    var command = '';
    var args = [];
    console.log("App [".concat(pm2_env.name, ":").concat(pm2_env.pm_id, "] starting in -fork mode-"));

    var spawn = require('child_process').spawn;

    var interpreter = pm2_env.exec_interpreter || 'node';
    var pidFile = pm2_env.pm_pid_path;

    if (interpreter !== 'none') {
      command = interpreter;

      if (pm2_env.node_args && Array.isArray(pm2_env.node_args)) {
        args = args.concat(pm2_env.node_args);
      } // Deprecated - to remove at some point


      if (process.env.PM2_NODE_OPTIONS) {
        args = args.concat(process.env.PM2_NODE_OPTIONS.split(' '));
      }

      if (interpreter === 'node' || RegExp('node$').test(interpreter)) {
        if (_semver["default"].lt(process.version, '10.0.0')) {
          args.push(_path["default"].resolve(_path["default"].dirname(module.filename), '..', 'ProcessContainerForkLegacy.js'));
        } else {
          args.push(_path["default"].resolve(_path["default"].dirname(module.filename), '..', 'ProcessContainerFork.js'));
        }
      } else args.push(pm2_env.pm_exec_path);
    } else {
      command = pm2_env.pm_exec_path;
      args = [];
    }

    if (pm2_env.args) {
      args = args.concat(pm2_env.args);
    } // piping stream o file


    var stds = {
      out: pm2_env.pm_out_log_path,
      err: pm2_env.pm_err_log_path
    }; // entire log std if necessary.

    if ('pm_log_path' in pm2_env) {
      stds.std = pm2_env.pm_log_path;
    }

    log("stds: %j", stds);

    _Utility["default"].startLogging(stds, function (err, result) {
      if (err) {
        God.logAndGenerateError(err);
        return cb(err);
      }

      ;

      try {
        var options = {
          env: pm2_env,
          detached: true,
          cwd: pm2_env.pm_cwd || process.cwd(),
          stdio: ['pipe', 'pipe', 'pipe', 'ipc'] //Same as fork() in node core

        };

        if (typeof pm2_env.windowsHide === "boolean") {
          options.windowsHide = pm2_env.windowsHide;
        } else {
          options.windowsHide = true;
        }

        if (pm2_env.uid) {
          options.uid = pm2_env.uid;
        }

        if (pm2_env.gid) {
          options.gid = pm2_env.gid;
        }

        var cspr = spawn(command, args, options);
      } catch (e) {
        God.logAndGenerateError(e);
        return cb(e);
      }

      if (!cspr || !cspr.stderr || !cspr.stdout) {
        var fatalError = new Error('Process could not be forked properly, check your system health');
        God.logAndGenerateError(fatalError);
        return cb(fatalError);
      }

      cspr.process = {};
      cspr.process.pid = cspr.pid;
      cspr.pm2_env = pm2_env;

      function transformLogToJson(pm2_env, type, data) {
        return JSON.stringify({
          message: data.toString(),
          timestamp: pm2_env.log_date_format ? (0, _dayjs["default"])().format(pm2_env.log_date_format) : new Date().toISOString(),
          type: type,
          process_id: cspr.pm2_env.pm_id,
          app_name: cspr.pm2_env.name
        }) + '\n';
      }

      function prefixLogWithDate(pm2_env, data) {
        var log_data = [];
        log_data = data.toString().split('\n');
        if (log_data.length > 1) log_data.pop();
        log_data = log_data.map(function (line) {
          return "".concat((0, _dayjs["default"])().format(pm2_env.log_date_format), ": ").concat(line, "\n");
        });
        return log_data.join('');
      }

      cspr.stderr.on('data', function forkErrData(data) {
        var log_data = null; // via --out /dev/null --err /dev/null

        if (pm2_env.disable_logs === true) return false;
        if (pm2_env.log_type && pm2_env.log_type === 'json') log_data = transformLogToJson(pm2_env, 'err', data);else if (pm2_env.log_date_format) log_data = prefixLogWithDate(pm2_env, data);else log_data = data.toString();
        God.bus.emit('log:err', {
          process: {
            pm_id: cspr.pm2_env.pm_id,
            name: cspr.pm2_env.name,
            rev: cspr.pm2_env.versioning && cspr.pm2_env.versioning.revision ? cspr.pm2_env.versioning.revision : null,
            namespace: cspr.pm2_env.namespace
          },
          at: _Utility["default"].getDate(),
          data: log_data
        });

        if (_Utility["default"].checkPathIsNull(pm2_env.pm_err_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) {
          return false;
        }

        stds.std && stds.std.write && stds.std.write(log_data);
        stds.err && stds.err.write && stds.err.write(log_data);
      });
      cspr.stdout.on('data', function forkOutData(data) {
        var log_data = null;
        if (pm2_env.disable_logs === true) return false;
        if (pm2_env.log_type && pm2_env.log_type === 'json') log_data = transformLogToJson(pm2_env, 'out', data);else if (pm2_env.log_date_format) log_data = prefixLogWithDate(pm2_env, data);else log_data = data.toString();
        God.bus.emit('log:out', {
          process: {
            pm_id: cspr.pm2_env.pm_id,
            name: cspr.pm2_env.name,
            rev: cspr.pm2_env.versioning && cspr.pm2_env.versioning.revision ? cspr.pm2_env.versioning.revision : null,
            namespace: cspr.pm2_env.namespace
          },
          at: _Utility["default"].getDate(),
          data: log_data
        });
        if (_Utility["default"].checkPathIsNull(pm2_env.pm_out_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) return false;
        stds.std && stds.std.write && stds.std.write(log_data);
        stds.out && stds.out.write && stds.out.write(log_data);
      });
      /**
       * Broadcast message to God
       */

      cspr.on('message', function forkMessage(msg) {
        /*********************************
         * If you edit this function
         * Do the same in ClusterMode.js !
         *********************************/
        if (msg.data && msg.type) {
          process.nextTick(function () {
            return God.bus.emit(msg.type ? msg.type : 'process:msg', {
              at: _Utility["default"].getDate(),
              data: msg.data,
              process: {
                pm_id: cspr.pm2_env.pm_id,
                name: cspr.pm2_env.name,
                versioning: cspr.pm2_env.versioning,
                namespace: cspr.pm2_env.namespace
              }
            });
          });
        } else {
          if (_typeof(msg) == 'object' && 'node_version' in msg) {
            cspr.pm2_env.node_version = msg.node_version;
            return false;
          } else if (_typeof(msg) == 'object' && 'cron_restart' in msg) {
            // cron onTick is invoked in the process
            return God.restartProcessId({
              id: cspr.pm2_env.pm_id
            }, function () {
              console.log('Application %s has been restarted via CRON', cspr.pm2_env.name);
            });
          }

          return God.bus.emit('process:msg', {
            at: _Utility["default"].getDate(),
            raw: msg,
            process: {
              pm_id: cspr.pm2_env.pm_id,
              name: cspr.pm2_env.name,
              namespace: cspr.pm2_env.namespace
            }
          });
        }
      });

      try {
        var pid = cspr.pid;
        if (typeof pid !== 'undefined') _fs["default"].writeFileSync(pidFile, pid.toString());
      } catch (e) {
        console.error(e.stack || e);
      }

      cspr.once('exit', function forkClose(status) {
        try {
          for (var k in stds) {
            if (stds[k] && stds[k].destroy) stds[k].destroy();else if (stds[k] && stds[k].end) stds[k].end();else if (stds[k] && stds[k].close) stds[k].close();
            stds[k] = stds[k]._file;
          }
        } catch (e) {
          God.logAndGenerateError(e);
        }
      });

      cspr._reloadLogs = function (cb) {
        try {
          for (var k in stds) {
            if (stds[k] && stds[k].destroy) stds[k].destroy();else if (stds[k] && stds[k].end) stds[k].end();else if (stds[k] && stds[k].close) stds[k].close();
            stds[k] = stds[k]._file;
          }
        } catch (e) {
          God.logAndGenerateError(e);
        } //cspr.removeAllListeners();


        _Utility["default"].startLogging(stds, cb);
      };

      cspr.unref();
      return cb(null, cspr);
    });
  };
}

;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Hb2QvRm9ya01vZGUudHMiXSwibmFtZXMiOlsibG9nIiwiRm9ya01vZGUiLCJHb2QiLCJmb3JrTW9kZSIsInBtMl9lbnYiLCJjYiIsImNvbW1hbmQiLCJhcmdzIiwiY29uc29sZSIsIm5hbWUiLCJwbV9pZCIsInNwYXduIiwicmVxdWlyZSIsImludGVycHJldGVyIiwiZXhlY19pbnRlcnByZXRlciIsInBpZEZpbGUiLCJwbV9waWRfcGF0aCIsIm5vZGVfYXJncyIsIkFycmF5IiwiaXNBcnJheSIsImNvbmNhdCIsInByb2Nlc3MiLCJlbnYiLCJQTTJfTk9ERV9PUFRJT05TIiwic3BsaXQiLCJSZWdFeHAiLCJ0ZXN0Iiwic2VtdmVyIiwibHQiLCJ2ZXJzaW9uIiwicHVzaCIsInBhdGgiLCJyZXNvbHZlIiwiZGlybmFtZSIsIm1vZHVsZSIsImZpbGVuYW1lIiwicG1fZXhlY19wYXRoIiwic3RkcyIsIm91dCIsInBtX291dF9sb2dfcGF0aCIsImVyciIsInBtX2Vycl9sb2dfcGF0aCIsInN0ZCIsInBtX2xvZ19wYXRoIiwiVXRpbGl0eSIsInN0YXJ0TG9nZ2luZyIsInJlc3VsdCIsImxvZ0FuZEdlbmVyYXRlRXJyb3IiLCJvcHRpb25zIiwiZGV0YWNoZWQiLCJjd2QiLCJwbV9jd2QiLCJzdGRpbyIsIndpbmRvd3NIaWRlIiwidWlkIiwiZ2lkIiwiY3NwciIsImUiLCJzdGRlcnIiLCJzdGRvdXQiLCJmYXRhbEVycm9yIiwiRXJyb3IiLCJwaWQiLCJ0cmFuc2Zvcm1Mb2dUb0pzb24iLCJ0eXBlIiwiZGF0YSIsIkpTT04iLCJzdHJpbmdpZnkiLCJtZXNzYWdlIiwidG9TdHJpbmciLCJ0aW1lc3RhbXAiLCJsb2dfZGF0ZV9mb3JtYXQiLCJmb3JtYXQiLCJEYXRlIiwidG9JU09TdHJpbmciLCJwcm9jZXNzX2lkIiwiYXBwX25hbWUiLCJwcmVmaXhMb2dXaXRoRGF0ZSIsImxvZ19kYXRhIiwibGVuZ3RoIiwicG9wIiwibWFwIiwibGluZSIsImpvaW4iLCJvbiIsImZvcmtFcnJEYXRhIiwiZGlzYWJsZV9sb2dzIiwibG9nX3R5cGUiLCJidXMiLCJlbWl0IiwicmV2IiwidmVyc2lvbmluZyIsInJldmlzaW9uIiwibmFtZXNwYWNlIiwiYXQiLCJnZXREYXRlIiwiY2hlY2tQYXRoSXNOdWxsIiwid3JpdGUiLCJmb3JrT3V0RGF0YSIsImZvcmtNZXNzYWdlIiwibXNnIiwibmV4dFRpY2siLCJub2RlX3ZlcnNpb24iLCJyZXN0YXJ0UHJvY2Vzc0lkIiwiaWQiLCJyYXciLCJmcyIsIndyaXRlRmlsZVN5bmMiLCJlcnJvciIsInN0YWNrIiwib25jZSIsImZvcmtDbG9zZSIsInN0YXR1cyIsImsiLCJkZXN0cm95IiwiZW5kIiwiY2xvc2UiLCJfZmlsZSIsIl9yZWxvYWRMb2dzIiwidW5yZWYiXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQUtBO0FBRUE7Ozs7Ozs7Ozs7O0FBS0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBLElBQU1BLEdBQUcsR0FBRyx1QkFBWSxlQUFaLENBQVo7QUFDQTs7Ozs7OztBQU1lLFNBQVNDLFFBQVQsQ0FBa0JDLEdBQWxCLEVBQXVCO0FBQ3BDOzs7Ozs7OztBQVFBQSxFQUFBQSxHQUFHLENBQUNDLFFBQUosR0FBZSxTQUFTQSxRQUFULENBQWtCQyxPQUFsQixFQUEyQkMsRUFBM0IsRUFBK0I7QUFDNUMsUUFBSUMsT0FBTyxHQUFHLEVBQWQ7QUFDQSxRQUFJQyxJQUFJLEdBQU0sRUFBZDtBQUVBQyxJQUFBQSxPQUFPLENBQUNSLEdBQVIsZ0JBQW9CSSxPQUFPLENBQUNLLElBQTVCLGNBQW9DTCxPQUFPLENBQUNNLEtBQTVDOztBQUNBLFFBQUlDLEtBQUssR0FBR0MsT0FBTyxDQUFDLGVBQUQsQ0FBUCxDQUF5QkQsS0FBckM7O0FBRUEsUUFBSUUsV0FBVyxHQUFHVCxPQUFPLENBQUNVLGdCQUFSLElBQTRCLE1BQTlDO0FBQ0EsUUFBSUMsT0FBTyxHQUFPWCxPQUFPLENBQUNZLFdBQTFCOztBQUVBLFFBQUlILFdB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QVFHLEtBQVI7QUFDbkMvRSxZQUFBQSxJQUFJLENBQUM0RSxDQUFELENBQUosR0FBVTVFLElBQUksQ0FBQzRFLENBQUQsQ0FBSixDQUFRSSxLQUFsQjtBQUNEO0FBQ0YsU0FQRCxDQU9FLE9BQU01RCxDQUFOLEVBQVM7QUFBRXZELFVBQUFBLEdBQUcsQ0FBQzZDLG1CQUFKLENBQXdCVSxDQUF4QjtBQUE0QixTQVJYLENBUzlCOzs7QUFDQWIsNEJBQVFDLFlBQVIsQ0FBcUJSLElBQXJCLEVBQTJCaEMsRUFBM0I7QUFDRCxPQVhEOztBQWFBbUQsTUFBQUEsSUFBSSxDQUFDK0QsS0FBTDtBQUVBLGFBQU9sSCxFQUFFLENBQUMsSUFBRCxFQUFPbUQsSUFBUCxDQUFUO0FBQ0QsS0FuTkQ7QUFxTkQsR0E1UUQ7QUE2UUQ7O0FBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAyMDEzIHRoZSBQTTIgcHJvamVjdCBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBsaWNlbnNlIHRoYXRcbiAqIGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLlxuICovXG4ndXNlIHN0cmljdCc7XG5cbi8qKlxuICogQGZpbGUgRm9yayBleGVjdXRpb24gcmVsYXRlZCBmdW5jdGlvbnNcbiAqIEBhdXRob3IgQWxleGFuZHJlIFN0cnplbGV3aWN6IDxhc0B1bml0ZWNoLmlvPlxuICogQHByb2plY3QgUE0yXG4gKi9cbmltcG9ydCBkZWJ1Z0xvZ2dlciAgICAgICAgICAgZnJvbSAnZGVidWcnO1xuaW1wb3J0IGZzICAgICAgICAgICAgZnJvbSAnZnMnO1xuaW1wb3J0IFV0aWxpdHkgICAgICAgZnJvbSAnLi4vVXRpbGl0eS5qcyc7XG5pbXBvcnQgcGF0aCAgICAgICAgICBmcm9tICdwYXRoJztcbmltcG9ydCBkYXlqcyAgICAgICAgIGZyb20gJ2RheWpzJztcbmltcG9ydCBzZW12ZXIgIGZyb20gJ3NlbXZlcic7XG5cbmNvbnN0IGxvZyA9IGRlYnVnTG9nZ2VyKCdwbTI6Zm9ya19tb2RlJyk7XG4vKipcbiAqIERlc2NyaXB0aW9uXG4gKiBAbWV0aG9kIGV4cG9ydHNcbiAqIEBwYXJhbSB7fSBHb2RcbiAqIEByZXR1cm5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gRm9ya01vZGUoR29kKSB7XG4gIC8qKlxuICAgKiBGb3IgYWxsIGFwcHMgLSBGT1JLIE1PREVcbiAgICogZm9yayB0aGUgYXBwXG4gICAqIEBtZXRob2QgZm9ya01vZGVcbiAgICogQHBhcmFtIHt9IHBtMl9lbnZcbiAgICogQHBhcmFtIHt9IGNiXG4gICAqIEByZXR1cm5cbiAgICovXG4gIEdvZC5mb3JrTW9kZSA9IGZ1bmN0aW9uIGZvcmtNb2RlKHBtMl9lbnYsIGNiKSB7XG4gICAgdmFyIGNvbW1hbmQgPSAnJztcbiAgICB2YXIgYXJncyAgICA9IFtdO1xuXG4gICAgY29uc29sZS5sb2coYEFwcCBbJHtwbTJfZW52Lm5hbWV9OiR7cG0yX2Vudi5wbV9pZH1dIHN0YXJ0aW5nIGluIC1mb3JrIG1vZGUtYClcbiAgICB2YXIgc3Bhd24gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuc3Bhd247XG5cbiAgICB2YXIgaW50ZXJwcmV0ZXIgPSBwbTJfZW52LmV4ZWNfaW50ZXJwcmV0ZXIgfHwgJ25vZGUnO1xuICAgIHZhciBwaWRGaWxlICAgICA9IHBtMl9lbnYucG1fcGlkX3BhdGg7XG5cbiAgICBpZiAoaW50ZXJwcmV0ZXIgIT09ICdub25lJykge1xuICAgICAgY29tbWFuZCA9IGludGVycHJldGVyO1xuXG4gICAgICBpZiAocG0yX2Vudi5ub2RlX2FyZ3MgJiYgQXJyYXkuaXNBcnJheShwbTJfZW52Lm5vZGVfYXJncykpIHtcbiAgICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KHBtMl9lbnYubm9kZV9hcmdzKTtcbiAgICAgIH1cblxuICAgICAgLy8gRGVwcmVjYXRlZCAtIHRvIHJlbW92ZSBhdCBzb21lIHBvaW50XG4gICAgICBpZiAocHJvY2Vzcy5lbnYuUE0yX05PREVfT1BUSU9OUykge1xuICAgICAgICBhcmdzID0gYXJncy5jb25jYXQocHJvY2Vzcy5lbnYuUE0yX05PREVfT1BUSU9OUy5zcGxpdCgnICcpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGludGVycHJldGVyID09PSAnbm9kZScgfHwgUmVnRXhwKCdub2RlJCcpLnRlc3QoaW50ZXJwcmV0ZXIpKSB7XG4gICAgICAgIGlmIChzZW12ZXIubHQocHJvY2Vzcy52ZXJzaW9uLCAnMTAuMC4wJykpIHtcbiAgICAgICAgICBhcmdzLnB1c2gocGF0aC5yZXNvbHZlKHBhdGguZGlybmFtZShtb2R1bGUuZmlsZW5hbWUpLCAnLi4nLCAnUHJvY2Vzc0NvbnRhaW5lckZvcmtMZWdhY3kuanMnKSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgYXJncy5wdXNoKHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUobW9kdWxlLmZpbGVuYW1lKSwgJy4uJywgJ1Byb2Nlc3NDb250YWluZXJGb3JrLmpzJykpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBlbHNlXG4gICAgICAgIGFyZ3MucHVzaChwbTJfZW52LnBtX2V4ZWNfcGF0aCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgY29tbWFuZCA9IHBtMl9lbnYucG1fZXhlY19wYXRoO1xuICAgICAgYXJncyA9IFsgXTtcbiAgICB9XG5cbiAgICBpZiAocG0yX2Vudi5hcmdzKSB7XG4gICAgICBhcmdzID0gYXJncy5jb25jYXQocG0yX2Vudi5hcmdzKTtcbiAgICB9XG5cbiAgICAvLyBwaXBpbmcgc3RyZWFtIG8gZmlsZVxuICAgIHZhciBzdGRzOiBhbnkgPSB7XG4gICAgICBvdXQ6IHBtMl9lbnYucG1fb3V0X2xvZ19wYXRoLFxuICAgICAgZXJyOiBwbTJfZW52LnBtX2Vycl9sb2dfcGF0aFxuICAgIH07XG5cbiAgICAvLyBlbnRpcmUgbG9nIHN0ZCBpZiBuZWNlc3NhcnkuXG4gICAgaWYgKCdwbV9sb2dfcGF0aCcgaW4gcG0yX2Vudil7XG4gICAgICBzdGRzLnN0ZCA9IHBtMl9lbnYucG1fbG9nX3BhdGg7XG4gICAgfVxuXG4gICAgbG9nKFwic3RkczogJWpcIiwgc3Rkcyk7XG5cbiAgICBVdGlsaXR5LnN0YXJ0TG9nZ2luZyhzdGRzLCBmdW5jdGlvbihlcnIsIHJlc3VsdCkge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBHb2QubG9nQW5kR2VuZXJhdGVFcnJvcihlcnIpO1xuICAgICAgICByZXR1cm4gY2IoZXJyKTtcbiAgICAgIH07XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIHZhciBvcHRpb25zOiBhbnkgPSB7XG4gICAgICAgICAgZW52ICAgICAgOiBwbTJfZW52LFxuICAgICAgICAgIGRldGFjaGVkIDogdHJ1ZSxcbiAgICAgICAgICBjd2QgICAgICA6IHBtMl9lbnYucG1fY3dkIHx8IHByb2Nlc3MuY3dkKCksXG4gICAgICAgICAgc3RkaW8gICAgOiBbJ3BpcGUnLCAncGlwZScsICdwaXBlJywgJ2lwYyddIC8vU2FtZSBhcyBmb3JrKCkgaW4gbm9kZSBjb3JlXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mKHBtMl9lbnYud2luZG93c0hpZGUpID09PSBcImJvb2xlYW5cIikge1xuICAgICAgICAgIG9wdGlvbnMud2luZG93c0hpZGUgPSBwbTJfZW52LndpbmRvd3NIaWRlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG9wdGlvbnMud2luZG93c0hpZGUgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBtMl9lbnYudWlkKSB7XG4gICAgICAgICAgb3B0aW9ucy51aWQgPSBwbTJfZW52LnVpZFxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBtMl9lbnYuZ2lkKSB7XG4gICAgICAgICAgb3B0aW9ucy5naWQgPSBwbTJfZW52LmdpZFxuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGNzcHIgPSBzcGF3bihjb21tYW5kLCBhcmdzLCBvcHRpb25zKTtcbiAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBHb2QubG9nQW5kR2VuZXJhdGVFcnJvcihlKTtcbiAgICAgICAgcmV0dXJuIGNiKGUpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWNzcHIgfHwgIWNzcHIuc3RkZXJyIHx8ICFjc3ByLnN0ZG91dCkge1xuICAgICAgICB2YXIgZmF0YWxFcnJvciA9IG5ldyBFcnJvcignUHJvY2VzcyBjb3VsZCBub3QgYmUgZm9ya2VkIHByb3Blcmx5LCBjaGVjayB5b3VyIHN5c3RlbSBoZWFsdGgnKVxuICAgICAgICBHb2QubG9nQW5kR2VuZXJhdGVFcnJvcihmYXRhbEVycm9yKTtcbiAgICAgICAgcmV0dXJuIGNiKGZhdGFsRXJyb3IpO1xuICAgICAgfVxuXG4gICAgICBjc3ByLnByb2Nlc3MgPSB7fTtcbiAgICAgIGNzcHIucHJvY2Vzcy5waWQgPSBjc3ByLnBpZDtcbiAgICAgIGNzcHIucG0yX2VudiA9IHBtMl9lbnY7XG5cbiAgICAgIGZ1bmN0aW9uIHRyYW5zZm9ybUxvZ1RvSnNvbihwbTJfZW52LCB0eXBlLCBkYXRhKSB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgbWVzc2FnZSA6IGRhdGEudG9TdHJpbmcoKSxcbiAgICAgICAgICB0aW1lc3RhbXAgOiBwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCA/IGRheWpzKCkuZm9ybWF0KHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0KSA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICB0eXBlIDogdHlwZSxcbiAgICAgICAgICBwcm9jZXNzX2lkIDogY3Nwci5wbTJfZW52LnBtX2lkLFxuICAgICAgICAgIGFwcF9uYW1lIDogY3Nwci5wbTJfZW52Lm5hbWVcbiAgICAgICAgfSkgKyAnXFxuJ1xuICAgICAgfVxuXG4gICAgICBmdW5jdGlvbiBwcmVmaXhMb2dXaXRoRGF0ZShwbTJfZW52LCBkYXRhKSB7XG4gICAgICAgIHZhciBsb2dfZGF0YTogYW55W10gPSBbXVxuICAgICAgICBsb2dfZGF0YSA9IGRhdGEudG9TdHJpbmcoKS5zcGxpdCgnXFxuJylcbiAgICAgICAgaWYgKGxvZ19kYXRhLmxlbmd0aCA+IDEpXG4gICAgICAgICAgbG9nX2RhdGEucG9wKClcbiAgICAgICAgbG9nX2RhdGEgPSBsb2dfZGF0YS5tYXAobGluZSA9PiBgJHtkYXlqcygpLmZvcm1hdChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCl9OiAke2xpbmV9XFxuYClcbiAgICAgICAgcmV0dXJuIGxvZ19kYXRhLmpvaW4oJycpXG4gICAgICB9XG5cbiAgICAgIGNzcHIuc3RkZXJyLm9uKCdkYXRhJywgZnVuY3Rpb24gZm9ya0VyckRhdGEoZGF0YSkge1xuICAgICAgICB2YXIgbG9nX2RhdGEgPSBudWxsO1xuXG4gICAgICAgIC8vIHZpYSAtLW91dCAvZGV2L251bGwgLS1lcnIgL2Rldi9udWxsXG4gICAgICAgIGlmIChwbTJfZW52LmRpc2FibGVfbG9ncyA9PT0gdHJ1ZSkgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIGlmIChwbTJfZW52LmxvZ190eXBlICYmIHBtMl9lbnYubG9nX3R5cGUgPT09ICdqc29uJylcbiAgICAgICAgICBsb2dfZGF0YSA9IHRyYW5zZm9ybUxvZ1RvSnNvbihwbTJfZW52LCAnZXJyJywgZGF0YSlcbiAgICAgICAgZWxzZSBpZiAocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQpXG4gICAgICAgICAgbG9nX2RhdGEgPSBwcmVmaXhMb2dXaXRoRGF0ZShwbTJfZW52LCBkYXRhKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgbG9nX2RhdGEgPSBkYXRhLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgR29kLmJ1cy5lbWl0KCdsb2c6ZXJyJywge1xuICAgICAgICAgIHByb2Nlc3MgOiB7XG4gICAgICAgICAgICBwbV9pZCAgICAgIDogY3Nwci5wbTJfZW52LnBtX2lkLFxuICAgICAgICAgICAgbmFtZSAgICAgICA6IGNzcHIucG0yX2Vudi5uYW1lLFxuICAgICAgICAgICAgcmV2ICAgICAgICA6IChjc3ByLnBtMl9lbnYudmVyc2lvbmluZyAmJiBjc3ByLnBtMl9lbnYudmVyc2lvbmluZy5yZXZpc2lvbikgPyBjc3ByLnBtMl9lbnYudmVyc2lvbmluZy5yZXZpc2lvbiA6IG51bGwsXG4gICAgICAgICAgICBuYW1lc3BhY2UgIDogY3Nwci5wbTJfZW52Lm5hbWVzcGFjZVxuICAgICAgICAgIH0sXG4gICAgICAgICAgYXQgIDogVXRpbGl0eS5nZXREYXRlKCksXG4gICAgICAgICAgZGF0YSA6IGxvZ19kYXRhXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChVdGlsaXR5LmNoZWNrUGF0aElzTnVsbChwbTJfZW52LnBtX2Vycl9sb2dfcGF0aCkgJiZcbiAgICAgICAgICAoIXBtMl9lbnYucG1fbG9nX3BhdGggfHwgVXRpbGl0eS5jaGVja1BhdGhJc051bGwocG0yX2Vudi5wbV9sb2dfcGF0aCkpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgc3Rkcy5zdGQgJiYgc3Rkcy5zdGQud3JpdGUgJiYgc3Rkcy5zdGQud3JpdGUobG9nX2RhdGEpO1xuICAgICAgICBzdGRzLmVyciAmJiBzdGRzLmVyci53cml0ZSAmJiBzdGRzLmVyci53cml0ZShsb2dfZGF0YSk7XG4gICAgICB9KTtcblxuICAgICAgY3Nwci5zdGRvdXQub24oJ2RhdGEnLCBmdW5jdGlvbiBmb3JrT3V0RGF0YShkYXRhKSB7XG4gICAgICAgIHZhciBsb2dfZGF0YSA9IG51bGw7XG5cbiAgICAgICAgaWYgKHBtMl9lbnYuZGlzYWJsZV9sb2dzID09PSB0cnVlKVxuICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICBpZiAocG0yX2Vudi5sb2dfdHlwZSAmJiBwbTJfZW52LmxvZ190eXBlID09PSAnanNvbicpXG4gICAgICAgICAgbG9nX2RhdGEgPSB0cmFuc2Zvcm1Mb2dUb0pzb24ocG0yX2VudiwgJ291dCcsIGRhdGEpXG4gICAgICAgIGVsc2UgaWYgKHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0KVxuICAgICAgICAgIGxvZ19kYXRhID0gcHJlZml4TG9nV2l0aERhdGUocG0yX2VudiwgZGF0YSlcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGxvZ19kYXRhID0gZGF0YS50b1N0cmluZygpXG5cbiAgICAgICAgR29kLmJ1cy5lbWl0KCdsb2c6b3V0Jywge1xuICAgICAgICAgIHByb2Nlc3MgOiB7XG4gICAgICAgICAgICBwbV9pZCAgICAgIDogY3Nwci5wbTJfZW52LnBtX2lkLFxuICAgICAgICAgICAgbmFtZSAgICAgICA6IGNzcHIucG0yX2Vudi5uYW1lLFxuICAgICAgICAgICAgcmV2ICAgICAgICA6IChjc3ByLnBtMl9lbnYudmVyc2lvbmluZyAmJiBjc3ByLnBtMl9lbnYudmVyc2lvbmluZy5yZXZpc2lvbikgPyBjc3ByLnBtMl9lbnYudmVyc2lvbmluZy5yZXZpc2lvbiA6IG51bGwsXG4gICAgICAgICAgICBuYW1lc3BhY2UgIDogY3Nwci5wbTJfZW52Lm5hbWVzcGFjZVxuICAgICAgICAgIH0sXG4gICAgICAgICAgYXQgIDogVXRpbGl0eS5nZXREYXRlKCksXG4gICAgICAgICAgZGF0YSA6IGxvZ19kYXRhXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChVdGlsaXR5LmNoZWNrUGF0aElzTnVsbChwbTJfZW52LnBtX291dF9sb2dfcGF0aCkgJiZcbiAgICAgICAgICAoIXBtMl9lbnYucG1fbG9nX3BhdGggfHwgVXRpbGl0eS5jaGVja1BhdGhJc051bGwocG0yX2Vudi5wbV9sb2dfcGF0aCkpKVxuICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICBzdGRzLnN0ZCAmJiBzdGRzLnN0ZC53cml0ZSAmJiBzdGRzLnN0ZC53cml0ZShsb2dfZGF0YSk7XG4gICAgICAgIHN0ZHMub3V0ICYmIHN0ZHMub3V0LndyaXRlICYmIHN0ZHMub3V0LndyaXRlKGxvZ19kYXRhKTtcbiAgICAgIH0pO1xuXG4gICAgICAvKipcbiAgICAgICAqIEJyb2FkY2FzdCBtZXNzYWdlIHRvIEdvZFxuICAgICAgICovXG4gICAgICBjc3ByLm9uKCdtZXNzYWdlJywgZnVuY3Rpb24gZm9ya01lc3NhZ2UobXNnKSB7XG4gICAgICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAgICAgICAgICogSWYgeW91IGVkaXQgdGhpcyBmdW5jdGlvblxuICAgICAgICAgKiBEbyB0aGUgc2FtZSBpbiBDbHVzdGVyTW9kZS5qcyAhXG4gICAgICAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG4gICAgICAgIGlmIChtc2cuZGF0YSAmJiBtc2cudHlwZSkge1xuICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICByZXR1cm4gR29kLmJ1cy5lbWl0KG1zZy50eXBlID8gbXNnLnR5cGUgOiAncHJvY2Vzczptc2cnLCB7XG4gICAgICAgICAgICAgIGF0ICAgICAgOiBVdGlsaXR5LmdldERhdGUoKSxcbiAgICAgICAgICAgICAgZGF0YSAgICA6IG1zZy5kYXRhLFxuICAgICAgICAgICAgICBwcm9jZXNzIDoge1xuICAgICAgICAgICAgICAgIHBtX2lkICAgICAgOiBjc3ByLnBtMl9lbnYucG1faWQsXG4gICAgICAgICAgICAgICAgbmFtZSAgICAgICA6IGNzcHIucG0yX2Vudi5uYW1lLFxuICAgICAgICAgICAgICAgIHZlcnNpb25pbmcgOiBjc3ByLnBtMl9lbnYudmVyc2lvbmluZyxcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2UgIDogY3Nwci5wbTJfZW52Lm5hbWVzcGFjZVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcblxuICAgICAgICAgIGlmICh0eXBlb2YgbXNnID09ICdvYmplY3QnICYmICdub2RlX3ZlcnNpb24nIGluIG1zZykge1xuICAgICAgICAgICAgY3Nwci5wbTJfZW52Lm5vZGVfdmVyc2lvbiA9IG1zZy5ub2RlX3ZlcnNpb247XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbXNnID09ICdvYmplY3QnICYmICdjcm9uX3Jlc3RhcnQnIGluIG1zZykge1xuICAgICAgICAgICAgLy8gY3JvbiBvblRpY2sgaXMgaW52b2tlZCBpbiB0aGUgcHJvY2Vzc1xuICAgICAgICAgICAgcmV0dXJuIEdvZC5yZXN0YXJ0UHJvY2Vzc0lkKHtcbiAgICAgICAgICAgICAgaWQgOiBjc3ByLnBtMl9lbnYucG1faWRcbiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQXBwbGljYXRpb24gJXMgaGFzIGJlZW4gcmVzdGFydGVkIHZpYSBDUk9OJywgY3Nwci5wbTJfZW52Lm5hbWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIEdvZC5idXMuZW1pdCgncHJvY2Vzczptc2cnLCB7XG4gICAgICAgICAgICBhdCAgICAgIDogVXRpbGl0eS5nZXREYXRlKCksXG4gICAgICAgICAgICByYXcgICAgIDogbXNnLFxuICAgICAgICAgICAgcHJvY2VzcyA6ICB7XG4gICAgICAgICAgICAgIHBtX2lkICAgICAgOiBjc3ByLnBtMl9lbnYucG1faWQsXG4gICAgICAgICAgICAgIG5hbWUgICAgICAgOiBjc3ByLnBtMl9lbnYubmFtZSxcbiAgICAgICAgICAgICAgbmFtZXNwYWNlICA6IGNzcHIucG0yX2Vudi5uYW1lc3BhY2VcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIHZhciBwaWQgPSBjc3ByLnBpZFxuICAgICAgICBpZiAodHlwZW9mKHBpZCkgIT09ICd1bmRlZmluZWQnKVxuICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMocGlkRmlsZSwgcGlkLnRvU3RyaW5nKCkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGUuc3RhY2sgfHwgZSk7XG4gICAgICB9XG5cbiAgICAgIGNzcHIub25jZSgnZXhpdCcsIGZ1bmN0aW9uIGZvcmtDbG9zZShzdGF0dXMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBmb3IodmFyIGsgaW4gc3Rkcyl7XG4gICAgICAgICAgICBpZiAoc3Rkc1trXSAmJiBzdGRzW2tdLmRlc3Ryb3kpIHN0ZHNba10uZGVzdHJveSgpO1xuICAgICAgICAgICAgZWxzZSBpZiAoc3Rkc1trXSAmJiBzdGRzW2tdLmVuZCkgc3Rkc1trXS5lbmQoKTtcbiAgICAgICAgICAgIGVsc2UgaWYgKHN0ZHNba10gJiYgc3Rkc1trXS5jbG9zZSkgc3Rkc1trXS5jbG9zZSgpO1xuICAgICAgICAgICAgc3Rkc1trXSA9IHN0ZHNba10uX2ZpbGU7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoKGUpIHsgR29kLmxvZ0FuZEdlbmVyYXRlRXJyb3IoZSk7fVxuICAgICAgfSk7XG5cbiAgICAgIGNzcHIuX3JlbG9hZExvZ3MgPSBmdW5jdGlvbihjYikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGZvciAodmFyIGsgaW4gc3Rkcyl7XG4gICAgICAgICAgICBpZiAoc3Rkc1trXSAmJiBzdGRzW2tdLmRlc3Ryb3kpIHN0ZHNba10uZGVzdHJveSgpO1xuICAgICAgICAgICAgZWxzZSBpZiAoc3Rkc1trXSAmJiBzdGRzW2tdLmVuZCkgc3Rkc1trXS5lbmQoKTtcbiAgICAgICAgICAgIGVsc2UgaWYgKHN0ZHNba10gJiYgc3Rkc1trXS5jbG9zZSkgc3Rkc1trXS5jbG9zZSgpO1xuICAgICAgICAgICAgc3Rkc1trXSA9IHN0ZHNba10uX2ZpbGU7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoKGUpIHsgR29kLmxvZ0FuZEdlbmVyYXRlRXJyb3IoZSk7fVxuICAgICAgICAvL2NzcHIucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XG4gICAgICAgIFV0aWxpdHkuc3RhcnRMb2dnaW5nKHN0ZHMsIGNiKTtcbiAgICAgIH07XG5cbiAgICAgIGNzcHIudW5yZWYoKTtcblxuICAgICAgcmV0dXJuIGNiKG51bGwsIGNzcHIpO1xuICAgIH0pO1xuXG4gIH07XG59O1xuIl19
/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
'use strict';
/**
 * @file Utilities for PM2
 * @author Alexandre Strzelewicz <as@unitech.io>
 * @project PM2
 */

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _path = _interopRequireDefault(require("path"));

var _TreeKill = _interopRequireDefault(require("../TreeKill"));

var _constants = _interopRequireDefault(require("../../constants.js"));

/**
 * Description
 * @method exports
 * @param {} God
 * @return
 */
function _default(God) {
  /**
   * Description
   * @method logAndGenerateError
   * @param {} err
   * @return NewExpression
   */
  God.logAndGenerateError = function (err) {
    // Is an Error object
    if (err instanceof Error) {
      console.trace(err);
      return err;
    } // Is a JSON or simple string


    console.error(err);
    return new Error(err);
  };
  /**
   * Utility functions
   * @method getProcesses
   * @return MemberExpression
   */


  God.getProcesses = function () {
    return God.clusters_db;
  };

  God.getFormatedProcess = function getFormatedProcesses(id) {
    if (God.clusters_db[id]) return {
      pid: God.clusters_db[id].process.pid,
      name: God.clusters_db[id].pm2_env.name,
      pm2_env: God.clusters_db[id].pm2_env,
      pm_id: God.clusters_db[id].pm2_env.pm_id
    };
    return {};
  };
  /**
   * Get formated processes
   * @method getFormatedProcesses
   * @return {Array} formated processes
   */


  God.getFormatedProcesses = function getFormatedProcesses() {
    var keys = Object.keys(God.clusters_db);
    var arr = new Array();
    var kl = keys.length;

    for (var i = 0; i < kl; i++) {
      var key = keys[i];
      if (!God.clusters_db[key]) continue; // Avoid _old type pm_ids

      if (isNaN(God.clusters_db[key].pm2_env.pm_id)) continue;
      arr.push({
        pid: God.clusters_db[key].process.pid,
        name: God.clusters_db[key].pm2_env.name,
        pm2_env: God.clusters_db[key].pm2_env,
        pm_id: God.clusters_db[key].pm2_env.pm_id
      });
    }

    return arr;
  };
  /**
   * Description
   * @method findProcessById
   * @param {} id
   * @return ConditionalExpression
   */


  God.findProcessById = function findProcessById(id) {
    return God.clusters_db[id] ? God.clusters_db[id] : null;
  };
  /**
   * Description
   * @method findByName
   * @param {} name
   * @return arr
   */


  God.findByName = function (name) {
    var db = God.clusters_db;
    var arr = [];

    if (name == 'all') {
      for (var key in db) {
        // Avoid _old_proc process style
        if (typeof God.clusters_db[key].pm2_env.pm_id === 'number') arr.push(db[key]);
      }

      return arr;
    }

    for (var key in db) {
      if (God.clusters_db[key].pm2_env.name == name || God.clusters_db[key].pm2_env.pm_exec_path == _path["default"].resolve(name)) {
        arr.push(db[key]);
      }
    }

    return arr;
  };
  /**
   * Check if a process is alive in system processes
   * Return TRUE if process online
   * @method checkProcess
   * @param {} pid
   * @return
   */


  God.checkProcess = function (pid) {
    if (!pid) return false;

    try {
      // Sending 0 signal do not kill the process
      process.kill(pid, 0);
      return true;
    } catch (err) {
      return false;
    }
  };
  /**
   * Description
   * @method processIsDead
   * @param {} pid
   * @param {} cb
   * @return Literal
   */


  God.processIsDead = function (pid, pm2_env, cb, sigkill) {
    if (!pid) return cb({
      type: 'param:missing',
      msg: 'no pid passed'
    });
    var timeout = null;
    var kill_timeout = pm2_env && pm2_env.kill_timeout ? pm2_env.kill_timeout : _constants["default"].KILL_TIMEOUT;
    var mode = pm2_env.exec_mode;
    var timer = setInterval(function () {
      if (God.checkProcess(pid) === false) {
        console.log('pid=%d msg=process killed', pid);
        clearTimeout(timeout);
        clearInterval(timer);
        return cb(null, true);
      }

      console.log('pid=%d msg=failed to kill - retrying in %dms', pid, pm2_env.kill_retry_time);
      return false;
    }, pm2_env.kill_retry_time);
    timeout = setTimeout(function () {
      clearInterval(timer);

      if (sigkill) {
        console.log('Process with pid %d could not be killed', pid);
        return cb({
          type: 'timeout',
          msg: 'timeout'
        });
      } else {
        console.log('Process with pid %d still alive after %sms, sending it SIGKILL now...', pid, kill_timeout);

        if (pm2_env.treekill !== true) {
          try {
            process.kill(parseInt(pid), 'SIGKILL');
          } catch (e) {
            console.error('[SimpleKill][SIGKILL] %s pid can not be killed', pid, e.stack, e.message);
          }

          return God.processIsDead(pid, pm2_env, cb, true);
        } else {
          (0, _TreeKill["default"])(parseInt(pid), 'SIGKILL', function (err) {
            return God.processIsDead(pid, pm2_env, cb, true);
          });
        }
      }
    }, kill_timeout);
    return false;
  };
  /**
   * Description
   * @method killProcess
   * @param int pid
   * @param Object pm2_env
   * @param function cb
   * @return CallExpression
   */


  God.killProcess = function (pid, pm2_env, cb) {
    if (!pid) return cb({
      msg: 'no pid passed or null'
    });

    if (typeof pm2_env.pm_id === 'number' && (_constants["default"].KILL_USE_MESSAGE || pm2_env.shutdown_with_message == true)) {
      var proc = God.clusters_db[pm2_env.pm_id];

      if (proc && proc.send) {
        try {
          proc.send('shutdown');
        } catch (e) {
          console.error("[AppKill] Cannot send \"shutdown\" message to ".concat(pid));
          console.error(e.stack, e.message);
        }

        return God.processIsDead(pid, pm2_env, cb);
      } else {
        console.log("[AppKill] ".concat(pid, " pid cannot be notified with send()"));
      }
    }

    if (pm2_env.treekill !== true) {
      try {
        process.kill(parseInt(pid), _constants["default"].KILL_SIGNAL);
      } catch (e) {
        console.error('[SimpleKill] %s pid can not be killed', pid, e.stack, e.message);
      }

      return God.processIsDead(pid, pm2_env, cb);
    } else {
      (0, _TreeKill["default"])(parseInt(pid), _constants["default"].KILL_SIGNAL, function (err) {
        return God.processIsDead(pid, pm2_env, cb);
      });
    }
  };
  /**
   * Description
   * @method getNewId
   * @return UpdateExpression
   */


  God.getNewId = function () {
    return God.next_id++;
  };
  /**
   * When a process is restarted or reloaded reset fields
   * to monitor unstable starts
   * @method resetState
   * @param {} pm2_env
   * @return
   */


  God.resetState = function (pm2_env) {
    pm2_env.created_at = Date.now();
    pm2_env.unstable_restarts = 0;
    pm2_env.prev_restart_delay = 0;
  };
}

;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Hb2QvTWV0aG9kcy50cyJdLCJuYW1lcyI6WyJHb2QiLCJsb2dBbmRHZW5lcmF0ZUVycm9yIiwiZXJyIiwiRXJyb3IiLCJjb25zb2xlIiwidHJhY2UiLCJlcnJvciIsImdldFByb2Nlc3NlcyIsImNsdXN0ZXJzX2RiIiwiZ2V0Rm9ybWF0ZWRQcm9jZXNzIiwiZ2V0Rm9ybWF0ZWRQcm9jZXNzZXMiLCJpZCIsInBpZCIsInByb2Nlc3MiLCJuYW1lIiwicG0yX2VudiIsInBtX2lkIiwia2V5cyIsIk9iamVjdCIsImFyciIsIkFycmF5Iiwia2wiLCJsZW5ndGgiLCJpIiwia2V5IiwiaXNOYU4iLCJwdXNoIiwiZmluZFByb2Nlc3NCeUlkIiwiZmluZEJ5TmFtZSIsImRiIiwicG1fZXhlY19wYXRoIiwicCIsInJlc29sdmUiLCJjaGVja1Byb2Nlc3MiLCJraWxsIiwicHJvY2Vzc0lzRGVhZCIsImNiIiwic2lna2lsbCIsInR5cGUiLCJtc2ciLCJ0aW1lb3V0Iiwia2lsbF90aW1lb3V0IiwiY3N0IiwiS0lMTF9USU1FT1VUIiwibW9kZSIsImV4ZWNfbW9kZSIsInRpbWVyIiwic2V0SW50ZXJ2YWwiLCJsb2ciLCJjbGVhclRpbWVvdXQiLCJjbGVhckludGVydmFsIiwia2lsbF9yZXRyeV90aW1lIiwic2V0VGltZW91dCIsInRyZWVraWxsIiwicGFyc2VJbnQiLCJlIiwic3RhY2siLCJtZXNzYWdlIiwia2lsbFByb2Nlc3MiLCJLSUxMX1VTRV9NRVNTQUdFIiwic2h1dGRvd25fd2l0aF9tZXNzYWdlIiwicHJvYyIsInNlbmQiLCJLSUxMX1NJR05BTCIsImdldE5ld0lkIiwibmV4dF9pZCIsInJlc2V0U3RhdGUiLCJjcmVhdGVkX2F0IiwiRGF0ZSIsIm5vdyIsInVuc3RhYmxlX3Jlc3RhcnRzIiwicHJldl9yZXN0YXJ0X2RlbGF5Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7QUFLQTtBQUVBOzs7Ozs7Ozs7Ozs7O0FBS0E7O0FBQ0E7O0FBQ0E7O0FBRUE7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QVEsQ0FBQzFDLEdBQUQsQ0FBckIsRUFBNEI4QixzQkFBSXFCLFdBQWhDO0FBQ0QsT0FGRCxDQUVFLE9BQU1SLENBQU4sRUFBUztBQUNUbkQsUUFBQUEsT0FBTyxDQUFDRSxLQUFSLENBQWMsdUNBQWQsRUFBdURNLEdBQXZELEVBQTREMkMsQ0FBQyxDQUFDQyxLQUE5RCxFQUFxRUQsQ0FBQyxDQUFDRSxPQUF2RTtBQUNEOztBQUNELGFBQU96RCxHQUFHLENBQUNtQyxhQUFKLENBQWtCdkIsR0FBbEIsRUFBdUJHLE9BQXZCLEVBQWdDcUIsRUFBaEMsQ0FBUDtBQUNELEtBUEQsTUFRSztBQUNILGdDQUFTa0IsUUFBUSxDQUFDMUMsR0FBRCxDQUFqQixFQUF3QjhCLHNCQUFJcUIsV0FBNUIsRUFBeUMsVUFBUzdELEdBQVQsRUFBYztBQUNyRCxlQUFPRixHQUFHLENBQUNtQyxhQUFKLENBQWtCdkIsR0FBbEIsRUFBdUJHLE9BQXZCLEVBQWdDcUIsRUFBaEMsQ0FBUDtBQUNELE9BRkQ7QUFHRDtBQUNGLEdBbENEO0FBb0NBOzs7Ozs7O0FBS0FwQyxFQUFBQSxHQUFHLENBQUNnRSxRQUFKLEdBQWUsWUFBVztBQUN4QixXQUFPaEUsR0FBRyxDQUFDaUUsT0FBSixFQUFQO0FBQ0QsR0FGRDtBQUlBOzs7Ozs7Ozs7QUFPQWpFLEVBQUFBLEdBQUcsQ0FBQ2tFLFVBQUosR0FBaUIsVUFBU25ELE9BQVQsRUFBa0I7QUFDakNBLElBQUFBLE9BQU8sQ0FBQ29ELFVBQVIsR0FBcUJDLElBQUksQ0FBQ0MsR0FBTCxFQUFyQjtBQUNBdEQsSUFBQUEsT0FBTyxDQUFDdUQsaUJBQVIsR0FBNEIsQ0FBNUI7QUFDQXZELElBQUFBLE9BQU8sQ0FBQ3dELGtCQUFSLEdBQTZCLENBQTdCO0FBQ0QsR0FKRDtBQU1EOztBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgMjAxMyB0aGUgUE0yIHByb2plY3QgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgbGljZW5zZSB0aGF0XG4gKiBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS5cbiAqL1xuJ3VzZSBzdHJpY3QnO1xuXG4vKipcbiAqIEBmaWxlIFV0aWxpdGllcyBmb3IgUE0yXG4gKiBAYXV0aG9yIEFsZXhhbmRyZSBTdHJ6ZWxld2ljeiA8YXNAdW5pdGVjaC5pbz5cbiAqIEBwcm9qZWN0IFBNMlxuICovXG5pbXBvcnQgcCAgICAgICAgICAgICBmcm9tICdwYXRoJztcbmltcG9ydCB0cmVla2lsbCAgICAgIGZyb20gJy4uL1RyZWVLaWxsJztcbmltcG9ydCBjc3QgICAgICAgICAgIGZyb20gJy4uLy4uL2NvbnN0YW50cy5qcyc7XG5cbi8qKlxuICogRGVzY3JpcHRpb25cbiAqIEBtZXRob2QgZXhwb3J0c1xuICogQHBhcmFtIHt9IEdvZFxuICogQHJldHVyblxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbihHb2QpIHtcblxuICAvKipcbiAgICogRGVzY3JpcHRpb25cbiAgICogQG1ldGhvZCBsb2dBbmRHZW5lcmF0ZUVycm9yXG4gICAqIEBwYXJhbSB7fSBlcnJcbiAgICogQHJldHVybiBOZXdFeHByZXNzaW9uXG4gICAqL1xuICBHb2QubG9nQW5kR2VuZXJhdGVFcnJvciA9IGZ1bmN0aW9uKGVycikge1xuICAgIC8vIElzIGFuIEVycm9yIG9iamVjdFxuICAgIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgY29uc29sZS50cmFjZShlcnIpO1xuICAgICAgcmV0dXJuIGVycjtcbiAgICB9XG4gICAgLy8gSXMgYSBKU09OIG9yIHNpbXBsZSBzdHJpbmdcbiAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgcmV0dXJuIG5ldyBFcnJvcihlcnIpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBVdGlsaXR5IGZ1bmN0aW9uc1xuICAgKiBAbWV0aG9kIGdldFByb2Nlc3Nlc1xuICAgKiBAcmV0dXJuIE1lbWJlckV4cHJlc3Npb25cbiAgICovXG4gIEdvZC5nZXRQcm9jZXNzZXMgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gR29kLmNsdXN0ZXJzX2RiO1xuICB9O1xuXG4gIEdvZC5nZXRGb3JtYXRlZFByb2Nlc3MgPSBmdW5jdGlvbiBnZXRGb3JtYXRlZFByb2Nlc3NlcyhpZCkge1xuICAgIGlmIChHb2QuY2x1c3RlcnNfZGJbaWRdKVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGlkICAgICA6IEdvZC5jbHVzdGVyc19kYltpZF0ucHJvY2Vzcy5waWQsXG4gICAgICAgIG5hbWUgICAgOiBHb2QuY2x1c3RlcnNfZGJbaWRdLnBtMl9lbnYubmFtZSxcbiAgICAgICAgcG0yX2VudiA6IEdvZC5jbHVzdGVyc19kYltpZF0ucG0yX2VudixcbiAgICAgICAgcG1faWQgICA6IEdvZC5jbHVzdGVyc19kYltpZF0ucG0yX2Vudi5wbV9pZFxuICAgICAgfTtcbiAgICByZXR1cm4ge307XG4gIH07XG5cbiAgLyoqXG4gICAqIEdldCBmb3JtYXRlZCBwcm9jZXNzZXNcbiAgICogQG1ldGhvZCBnZXRGb3JtYXRlZFByb2Nlc3Nlc1xuICAgKiBAcmV0dXJuIHtBcnJheX0gZm9ybWF0ZWQgcHJvY2Vzc2VzXG4gICAqL1xuICBHb2QuZ2V0Rm9ybWF0ZWRQcm9jZXNzZXMgPSBmdW5jdGlvbiBnZXRGb3JtYXRlZFByb2Nlc3NlcygpIHtcbiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKEdvZC5jbHVzdGVyc19kYik7XG4gICAgdmFyIGFyciAgPSBuZXcgQXJyYXkoKTtcbiAgICB2YXIga2wgICA9IGtleXMubGVuZ3RoO1xuXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrbDsgaSsrKSB7XG4gICAgICB2YXIga2V5ID0ga2V5c1tpXTtcblxuICAgICAgaWYgKCFHb2QuY2x1c3RlcnNfZGJba2V5XSkgY29udGludWU7XG4gICAgICAvLyBBdm9pZCBfb2xkIHR5cGUgcG1faWRzXG4gICAgICBpZiAoaXNOYU4oR29kLmNsdXN0ZXJzX2RiW2tleV0ucG0yX2Vudi5wbV9pZCkpIGNvbnRpbnVlO1xuXG4gICAgICBhcnIucHVzaCh7XG4gICAgICAgIHBpZCAgICAgOiBHb2QuY2x1c3RlcnNfZGJba2V5XS5wcm9jZXNzLnBpZCxcbiAgICAgICAgbmFtZSAgICA6IEdvZC5jbHVzdGVyc19kYltrZXldLnBtMl9lbnYubmFtZSxcbiAgICAgICAgcG0yX2VudiA6IEdvZC5jbHVzdGVyc19kYltrZXldLnBtMl9lbnYsXG4gICAgICAgIHBtX2lkICAgOiBHb2QuY2x1c3RlcnNfZGJba2V5XS5wbTJfZW52LnBtX2lkXG4gICAgICB9KVxuICAgIH1cbiAgICByZXR1cm4gYXJyO1xuICB9O1xuXG4gIC8qKlxuICAgKiBEZXNjcmlwdGlvblxuICAgKiBAbWV0aG9kIGZpbmRQcm9jZXNzQnlJZFxuICAgKiBAcGFyYW0ge30gaWRcbiAgICogQHJldHVybiBDb25kaXRpb25hbEV4cHJlc3Npb25cbiAgICovXG4gIEdvZC5maW5kUHJvY2Vzc0J5SWQgPSBmdW5jdGlvbiBmaW5kUHJvY2Vzc0J5SWQoaWQpIHtcbiAgICByZXR1cm4gR29kLmNsdXN0ZXJzX2RiW2lkXSA/IEdvZC5jbHVzdGVyc19kYltpZF0gOiBudWxsO1xuICB9O1xuXG4gIC8qKlxuICAgKiBEZXNjcmlwdGlvblxuICAgKiBAbWV0aG9kIGZpbmRCeU5hbWVcbiAgICogQHBhcmFtIHt9IG5hbWVcbiAgICogQHJldHVybiBhcnJcbiAgICovXG4gIEdvZC5maW5kQnlOYW1lID0gZnVuY3Rpb24obmFtZSkge1xuICAgIHZhciBkYiA9IEdvZC5jbHVzdGVyc19kYjtcbiAgICB2YXIgYXJyID0gW107XG5cbiAgICBpZiAobmFtZSA9PSAnYWxsJykge1xuICAgICAgZm9yICh2YXIga2V5IGluIGRiKSB7XG4gICAgICAgIC8vIEF2b2lkIF9vbGRfcHJvYyBwcm9jZXNzIHN0eWxlXG4gICAgICAgIGlmICh0eXBlb2YoR29kLmNsdXN0ZXJzX2RiW2tleV0ucG0yX2Vudi5wbV9pZCkgPT09ICdudW1iZXInKVxuICAgICAgICAgIGFyci5wdXNoKGRiW2tleV0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFycjtcbiAgICB9XG5cbiAgICBmb3IgKHZhciBrZXkgaW4gZGIpIHtcbiAgICAgIGlmIChHb2QuY2x1c3RlcnNfZGJba2V5XS5wbTJfZW52Lm5hbWUgPT0gbmFtZSB8fFxuICAgICAgICAgIEdvZC5jbHVzdGVyc19kYltrZXldLnBtMl9lbnYucG1fZXhlY19wYXRoID09IHAucmVzb2x2ZShuYW1lKSkge1xuICAgICAgICBhcnIucHVzaChkYltrZXldKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGFycjtcbiAgfTtcblxuICAvKipcbiAgICogQ2hlY2sgaWYgYSBwcm9jZXNzIGlzIGFsaXZlIGluIHN5c3RlbSBwcm9jZXNzZXNcbiAgICogUmV0dXJuIFRSVUUgaWYgcHJvY2VzcyBvbmxpbmVcbiAgICogQG1ldGhvZCBjaGVja1Byb2Nlc3NcbiAgICogQHBhcmFtIHt9IHBpZFxuICAgKiBAcmV0dXJuXG4gICAqL1xuICBHb2QuY2hlY2tQcm9jZXNzID0gZnVuY3Rpb24ocGlkKSB7XG4gICAgaWYgKCFwaWQpIHJldHVybiBmYWxzZTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBTZW5kaW5nIDAgc2lnbmFsIGRvIG5vdCBraWxsIHRoZSBwcm9jZXNzXG4gICAgICBwcm9jZXNzLmtpbGwocGlkLCAwKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBEZXNjcmlwdGlvblxuICAgKiBAbWV0aG9kIHByb2Nlc3NJc0RlYWRcbiAgICogQHBhcmFtIHt9IHBpZFxuICAgKiBAcGFyYW0ge30gY2JcbiAgICogQHJldHVybiBMaXRlcmFsXG4gICAqL1xuICBHb2QucHJvY2Vzc0lzRGVhZCA9IGZ1bmN0aW9uKHBpZCwgcG0yX2VudiwgY2IsIHNpZ2tpbGwpIHtcbiAgICBpZiAoIXBpZCkgcmV0dXJuIGNiKHt0eXBlIDogJ3BhcmFtOm1pc3NpbmcnLCBtc2cgOiAnbm8gcGlkIHBhc3NlZCd9KTtcblxuICAgIHZhciB0aW1lb3V0ICAgICAgPSBudWxsO1xuICAgIHZhciBraWxsX3RpbWVvdXQgPSAocG0yX2VudiAmJiBwbTJfZW52LmtpbGxfdGltZW91dCkgPyBwbTJfZW52LmtpbGxfdGltZW91dCA6IGNzdC5LSUxMX1RJTUVPVVQ7XG4gICAgdmFyIG1vZGUgICAgICAgICA9IHBtMl9lbnYuZXhlY19tb2RlO1xuXG4gICAgdmFyIHRpbWVyID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoR29kLmNoZWNrUHJvY2VzcyhwaWQpID09PSBmYWxzZSkge1xuICAgICAgICBjb25zb2xlLmxvZygncGlkPSVkIG1zZz1wcm9jZXNzIGtpbGxlZCcsIHBpZCk7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcik7XG4gICAgICAgIHJldHVybiBjYihudWxsLCB0cnVlKTtcbiAgICAgIH1cbiAgICAgIGNvbnNvbGUubG9nKCdwaWQ9JWQgbXNnPWZhaWxlZCB0byBraWxsIC0gcmV0cnlpbmcgaW4gJWRtcycsIHBpZCwgcG0yX2Vudi5raWxsX3JldHJ5X3RpbWUpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0sIHBtMl9lbnYua2lsbF9yZXRyeV90aW1lKTtcblxuICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcik7XG4gICAgICBpZiAoc2lna2lsbCkge1xuICAgICAgICBjb25zb2xlLmxvZygnUHJvY2VzcyB3aXRoIHBpZCAlZCBjb3VsZCBub3QgYmUga2lsbGVkJywgcGlkKTtcbiAgICAgICAgcmV0dXJuIGNiKHt0eXBlIDogJ3RpbWVvdXQnLCBtc2cgOiAndGltZW91dCd9KTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygnUHJvY2VzcyB3aXRoIHBpZCAlZCBzdGlsbCBhbGl2ZSBhZnRlciAlc21zLCBzZW5kaW5nIGl0IFNJR0tJTEwgbm93Li4uJywgcGlkLCBraWxsX3RpbWVvdXQpO1xuXG4gICAgICAgIGlmIChwbTJfZW52LnRyZWVraWxsICE9PSB0cnVlKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHByb2Nlc3Mua2lsbChwYXJzZUludChwaWQpLCAnU0lHS0lMTCcpO1xuICAgICAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignW1NpbXBsZUtpbGxdW1NJR0tJTExdICVzIHBpZCBjYW4gbm90IGJlIGtpbGxlZCcsIHBpZCwgZS5zdGFjaywgZS5tZXNzYWdlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIEdvZC5wcm9jZXNzSXNEZWFkKHBpZCwgcG0yX2VudiwgY2IsIHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIHRyZWVraWxsKHBhcnNlSW50KHBpZCksICdTSUdLSUxMJywgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gR29kLnByb2Nlc3NJc0RlYWQocGlkLCBwbTJfZW52LCBjYiwgdHJ1ZSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LCBraWxsX3RpbWVvdXQpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcblxuICAvKipcbiAgICogRGVzY3JpcHRpb25cbiAgICogQG1ldGhvZCBraWxsUHJvY2Vzc1xuICAgKiBAcGFyYW0gaW50IHBpZFxuICAgKiBAcGFyYW0gT2JqZWN0IHBtMl9lbnZcbiAgICogQHBhcmFtIGZ1bmN0aW9uIGNiXG4gICAqIEByZXR1cm4gQ2FsbEV4cHJlc3Npb25cbiAgICovXG4gIEdvZC5raWxsUHJvY2VzcyA9IGZ1bmN0aW9uKHBpZCwgcG0yX2VudiwgY2IpIHtcbiAgICBpZiAoIXBpZCkgcmV0dXJuIGNiKHttc2cgOiAnbm8gcGlkIHBhc3NlZCBvciBudWxsJ30pO1xuXG4gICAgaWYgKHR5cGVvZihwbTJfZW52LnBtX2lkKSA9PT0gJ251bWJlcicgJiZcbiAgICAgICAgKGNzdC5LSUxMX1VTRV9NRVNTQUdFIHx8IHBtMl9lbnYuc2h1dGRvd25fd2l0aF9tZXNzYWdlID09IHRydWUpKSB7XG4gICAgICB2YXIgcHJvYyA9IEdvZC5jbHVzdGVyc19kYltwbTJfZW52LnBtX2lkXTtcblxuICAgICAgaWYgKHByb2MgJiYgcHJvYy5zZW5kKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgcHJvYy5zZW5kKCdzaHV0ZG93bicpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihgW0FwcEtpbGxdIENhbm5vdCBzZW5kIFwic2h1dGRvd25cIiBtZXNzYWdlIHRvICR7cGlkfWApXG4gICAgICAgICAgY29uc29sZS5lcnJvcihlLnN0YWNrLCBlLm1lc3NhZ2UpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIEdvZC5wcm9jZXNzSXNEZWFkKHBpZCwgcG0yX2VudiwgY2IpO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBbQXBwS2lsbF0gJHtwaWR9IHBpZCBjYW5ub3QgYmUgbm90aWZpZWQgd2l0aCBzZW5kKClgKVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChwbTJfZW52LnRyZWVraWxsICE9PSB0cnVlKSB7XG4gICAgICB0cnkge1xuICAgICAgICBwcm9jZXNzLmtpbGwocGFyc2VJbnQocGlkKSwgY3N0LktJTExfU0lHTkFMKTtcbiAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdbU2ltcGxlS2lsbF0gJXMgcGlkIGNhbiBub3QgYmUga2lsbGVkJywgcGlkLCBlLnN0YWNrLCBlLm1lc3NhZ2UpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIEdvZC5wcm9jZXNzSXNEZWFkKHBpZCwgcG0yX2VudiwgY2IpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHRyZWVraWxsKHBhcnNlSW50KHBpZCksIGNzdC5LSUxMX1NJR05BTCwgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIHJldHVybiBHb2QucHJvY2Vzc0lzRGVhZChwaWQsIHBtMl9lbnYsIGNiKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogRGVzY3JpcHRpb25cbiAgICogQG1ldGhvZCBnZXROZXdJZFxuICAgKiBAcmV0dXJuIFVwZGF0ZUV4cHJlc3Npb25cbiAgICovXG4gIEdvZC5nZXROZXdJZCA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBHb2QubmV4dF9pZCsrO1xuICB9O1xuXG4gIC8qKlxuICAgKiBXaGVuIGEgcHJvY2VzcyBpcyByZXN0YXJ0ZWQgb3IgcmVsb2FkZWQgcmVzZXQgZmllbGRzXG4gICAqIHRvIG1vbml0b3IgdW5zdGFibGUgc3RhcnRzXG4gICAqIEBtZXRob2QgcmVzZXRTdGF0ZVxuICAgKiBAcGFyYW0ge30gcG0yX2VudlxuICAgKiBAcmV0dXJuXG4gICAqL1xuICBHb2QucmVzZXRTdGF0ZSA9IGZ1bmN0aW9uKHBtMl9lbnYpIHtcbiAgICBwbTJfZW52LmNyZWF0ZWRfYXQgPSBEYXRlLm5vdygpO1xuICAgIHBtMl9lbnYudW5zdGFibGVfcmVzdGFydHMgPSAwO1xuICAgIHBtMl9lbnYucHJldl9yZXN0YXJ0X2RlbGF5ID0gMDtcbiAgfTtcblxufTtcbiJdfQ==
"use strict";

var _commander = _interopRequireDefault(require("commander"));

var _API = _interopRequireDefault(require("../API"));

var _Log = _interopRequireDefault(require("../API/Log"));

var _constants = _interopRequireDefault(require("../../constants.js"));

var _package = _interopRequireDefault(require("../../package.json"));

var _path = _interopRequireDefault(require("path"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var pm2; // Do not print banner

process.env.PM2_DISCRETE_MODE = "true";

_commander["default"].version(_package["default"].version).description('pm2-runtime is an automatic pmx injection that runs in simulated no-daemon environment').option('--auto-manage', 'keep application online after command exit').option('--fast-boot', 'boot app faster by keeping pm2 runtime online in background (effective at second exit/start)').option('--web [port]', 'launch process web api on [port] default to 9615').option('--secret [key]', 'PM2 plus secret key').option('--public [key]', 'PM2 plus public key').option('--machine-name [name]', 'PM2 plus machine name').option('--env [name]', 'select env_[name] env variables in process config file').option('--watch', 'Watch and Restart').option('-i --instances <number>', 'launch [number] instances with load-balancer').usage('pm2-runtime app.js');

_commander["default"].command('*').action(function (cmd) {
  pm2 = new _API["default"]({
    pm2_home: _path["default"].join(process.env.HOME, '.pm3'),
    secret_key: _constants["default"].SECRET_KEY || _commander["default"].secret,
    public_key: _constants["default"].PUBLIC_KEY || _commander["default"]["public"],
    machine_name: _constants["default"].MACHINE_NAME || _commander["default"].machineName
  });
  pm2.connect(function () {
    if (_commander["default"].web) {
      var port = _commander["default"].web === true ? _constants["default"].WEB_PORT : _commander["default"].web;
      pm2.web(port);
    }

    pm2.start(cmd, _commander["default"], function (err, obj) {
      if (process.env.PM2_RUNTIME_DEBUG) {
        return pm2.disconnect(function () {});
      }

      if (err) {
        console.error(err);
        return process.exit(1);
      }

      var pm_id = obj[0].pm2_env.pm_id;

      if (_commander["default"].instances == undefined) {
        return pm2.attach(pm_id, function () {
          exitPM2();
        });
      }

      if (_commander["default"].json === true) _Log["default"].jsonStream(pm2.Client, pm_id);else if (_commander["default"].format === true) _Log["default"].formatStream(pm2.Client, pm_id, false, 'YYYY-MM-DD-HH:mm:ssZZ');else _Log["default"].stream(pm2.Client, 'all', true);
    });
  });
});

if (process.argv.length == 2) {
  _commander["default"].outputHelp();

  process.exit(1);
}

process.on('SIGINT', function () {
  exitPM2();
});
process.on('SIGTERM', function () {
  exitPM2();
});

_commander["default"].parse(process.argv);

function exitPM2() {
  console.log('Exited at %s', new Date());
  if (_commander["default"].autoManage) return process.exit(0);

  if (_commander["default"].fastBoot) {
    return pm2["delete"]('all', function () {
      process.exit(0);
    });
  }

  pm2.kill(function () {
    process.exit(0);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9iaW5hcmllcy9SdW50aW1lLnRzIl0sIm5hbWVzIjpbInBtMiIsInByb2Nlc3MiLCJlbnYiLCJQTTJfRElTQ1JFVEVfTU9ERSIsImNvbW1hbmRlciIsInZlcnNpb24iLCJwa2ciLCJkZXNjcmlwdGlvbiIsIm9wdGlvbiIsInVzYWdlIiwiY29tbWFuZCIsImFjdGlvbiIsImNtZCIsIlBNMiIsInBtMl9ob21lIiwicGF0aCIsImpvaW4iLCJIT01FIiwic2VjcmV0X2tleSIsImNzdCIsIlNFQ1JFVF9LRVkiLCJzZWNyZXQiLCJwdWJsaWNfa2V5IiwiUFVCTElDX0tFWSIsIm1hY2hpbmVfbmFtZSIsIk1BQ0hJTkVfTkFNRSIsIm1hY2hpbmVOYW1lIiwiY29ubmVjdCIsIndlYiIsInBvcnQiLCJXRUJfUE9SVCIsInN0YXJ0IiwiZXJyIiwib2JqIiwiUE0yX1JVTlRJTUVfREVCVUciLCJkaXNjb25uZWN0IiwiY29uc29sZSIsImVycm9yIiwiZXhpdCIsInBtX2lkIiwicG0yX2VudiIsImluc3RhbmNlcyIsInVuZGVmaW5lZCIsImF0dGFjaCIsImV4aXRQTTIiLCJqc29uIiwiTG9nIiwianNvblN0cmVhbSIsIkNsaWVudCIsImZvcm1hdCIsImZvcm1hdFN0cmVhbSIsInN0cmVhbSIsImFyZ3YiLCJsZW5ndGgiLCJvdXRwdXRIZWxwIiwib24iLCJwYXJzZSIsImxvZyIsIkRhdGUiLCJhdXRvTWFuYWdlIiwiZmFzdEJvb3QiLCJraWxsIl0sIm1hcHBpbmdzIjoiOztBQUFBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsSUFBSUEsR0FBSixDLENBRUE7O0FBQ0FDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxpQkFBWixHQUFnQyxNQUFoQzs7QUFFQUMsc0JBQVVDLE9BQVYsQ0FBa0JDLG9CQUFJRCxPQUF0QixFQUNHRSxXQURILENBQ2Usd0ZBRGYsRUFFR0MsTUFGSCxDQUVVLGVBRlYsRUFFMkIsNENBRjNCLEVBR0dBLE1BSEgsQ0FH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QVIsQ0FBYSxDQUFiO0FBQ0Q7O0FBRURyQyxPQUFPLENBQUNzRCxFQUFSLENBQVcsUUFBWCxFQUFxQixZQUFZO0FBQy9CWCxFQUFBQSxPQUFPO0FBQ1IsQ0FGRDtBQUlBM0MsT0FBTyxDQUFDc0QsRUFBUixDQUFXLFNBQVgsRUFBc0IsWUFBWTtBQUNoQ1gsRUFBQUEsT0FBTztBQUNSLENBRkQ7O0FBSUF4QyxzQkFBVW9ELEtBQVYsQ0FBZ0J2RCxPQUFPLENBQUNtRCxJQUF4Qjs7QUFFQSxTQUFTUixPQUFULEdBQW1CO0FBQ2pCUixFQUFBQSxPQUFPLENBQUNxQixHQUFSLENBQVksY0FBWixFQUE0QixJQUFJQyxJQUFKLEVBQTVCO0FBQ0EsTUFBSXRELHNCQUFVdUQsVUFBZCxFQUNFLE9BQU8xRCxPQUFPLENBQUNxQyxJQUFSLENBQWEsQ0FBYixDQUFQOztBQUVGLE1BQUlsQyxzQkFBVXdELFFBQWQsRUFBd0I7QUFDdEIsV0FBTzVELEdBQUcsVUFBSCxDQUFXLEtBQVgsRUFBa0IsWUFBWTtBQUNuQ0MsTUFBQUEsT0FBTyxDQUFDcUMsSUFBUixDQUFhLENBQWI7QUFDRCxLQUZNLENBQVA7QUFHRDs7QUFDRHRDLEVBQUFBLEdBQUcsQ0FBQzZELElBQUosQ0FBUyxZQUFZO0FBQ25CNUQsSUFBQUEsT0FBTyxDQUFDcUMsSUFBUixDQUFhLENBQWI7QUFDRCxHQUZEO0FBR0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY29tbWFuZGVyIGZyb20gJ2NvbW1hbmRlcic7XG5cbmltcG9ydCBQTTIgZnJvbSAnLi4vQVBJJztcbmltcG9ydCBMb2cgZnJvbSAnLi4vQVBJL0xvZyc7XG5pbXBvcnQgY3N0IGZyb20gJy4uLy4uL2NvbnN0YW50cy5qcyc7XG5pbXBvcnQgcGtnIGZyb20gJy4uLy4uL3BhY2thZ2UuanNvbic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxudmFyIHBtMjtcblxuLy8gRG8gbm90IHByaW50IGJhbm5lclxucHJvY2Vzcy5lbnYuUE0yX0RJU0NSRVRFX01PREUgPSBcInRydWVcIjtcblxuY29tbWFuZGVyLnZlcnNpb24ocGtnLnZlcnNpb24pXG4gIC5kZXNjcmlwdGlvbigncG0yLXJ1bnRpbWUgaXMgYW4gYXV0b21hdGljIHBteCBpbmplY3Rpb24gdGhhdCBydW5zIGluIHNpbXVsYXRlZCBuby1kYWVtb24gZW52aXJvbm1lbnQnKVxuICAub3B0aW9uKCctLWF1dG8tbWFuYWdlJywgJ2tlZXAgYXBwbGljYXRpb24gb25saW5lIGFmdGVyIGNvbW1hbmQgZXhpdCcpXG4gIC5vcHRpb24oJy0tZmFzdC1ib290JywgJ2Jvb3QgYXBwIGZhc3RlciBieSBrZWVwaW5nIHBtMiBydW50aW1lIG9ubGluZSBpbiBiYWNrZ3JvdW5kIChlZmZlY3RpdmUgYXQgc2Vjb25kIGV4aXQvc3RhcnQpJylcbiAgLm9wdGlvbignLS13ZWIgW3BvcnRdJywgJ2xhdW5jaCBwcm9jZXNzIHdlYiBhcGkgb24gW3BvcnRdIGRlZmF1bHQgdG8gOTYxNScpXG4gIC5vcHRpb24oJy0tc2VjcmV0IFtrZXldJywgJ1BNMiBwbHVzIHNlY3JldCBrZXknKVxuICAub3B0aW9uKCctLXB1YmxpYyBba2V5XScsICdQTTIgcGx1cyBwdWJsaWMga2V5JylcbiAgLm9wdGlvbignLS1tYWNoaW5lLW5hbWUgW25hbWVdJywgJ1BNMiBwbHVzIG1hY2hpbmUgbmFtZScpXG4gIC5vcHRpb24oJy0tZW52IFtuYW1lXScsICdzZWxlY3QgZW52X1tuYW1lXSBlbnYgdmFyaWFibGVzIGluIHByb2Nlc3MgY29uZmlnIGZpbGUnKVxuICAub3B0aW9uKCctLXdhdGNoJywgJ1dhdGNoIGFuZCBSZXN0YXJ0JylcbiAgLm9wdGlvbignLWkgLS1pbnN0YW5jZXMgPG51bWJlcj4nLCAnbGF1bmNoIFtudW1iZXJdIGluc3RhbmNlcyB3aXRoIGxvYWQtYmFsYW5jZXInKVxuICAudXNhZ2UoJ3BtMi1ydW50aW1lIGFwcC5qcycpO1xuXG5jb21tYW5kZXIuY29tbWFuZCgnKicpXG4gIC5hY3Rpb24oZnVuY3Rpb24gKGNtZCkge1xuICAgIHBtMiA9IG5ldyBQTTIoe1xuICAgICAgcG0yX2hvbWU6IHBhdGguam9pbihwcm9jZXNzLmVudi5IT01FLCAnLnBtMycpLFxuICAgICAgc2VjcmV0X2tleTogY3N0LlNFQ1JFVF9LRVkgfHwgY29tbWFuZGVyLnNlY3JldCxcbiAgICAgIHB1YmxpY19rZXk6IGNzdC5QVUJMSUNfS0VZIHx8IGNvbW1hbmRlci5wdWJsaWMsXG4gICAgICBtYWNoaW5lX25hbWU6IGNzdC5NQUNISU5FX05BTUUgfHwgY29tbWFuZGVyLm1hY2hpbmVOYW1lXG4gICAgfSk7XG5cbiAgICBwbTIuY29ubmVjdChmdW5jdGlvbiAoKSB7XG4gICAgICBpZiAoY29tbWFuZGVyLndlYikge1xuICAgICAgICB2YXIgcG9ydCA9IGNvbW1hbmRlci53ZWIgPT09IHRydWUgPyBjc3QuV0VCX1BPUlQgOiBjb21tYW5kZXIud2ViO1xuICAgICAgICBwbTIud2ViKHBvcnQpO1xuICAgICAgfVxuXG4gICAgICBwbTIuc3RhcnQoY21kLCBjb21tYW5kZXIsIGZ1bmN0aW9uIChlcnIsIG9iaikge1xuICAgICAgICBpZiAocHJvY2Vzcy5lbnYuUE0yX1JVTlRJTUVfREVCVUcpIHtcbiAgICAgICAgICByZXR1cm4gcG0yLmRpc2Nvbm5lY3QoZnVuY3Rpb24gKCkgeyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgICAgcmV0dXJuIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBwbV9pZCA9IG9ialswXS5wbTJfZW52LnBtX2lkO1xuXG4gICAgICAgIGlmIChjb21tYW5kZXIuaW5zdGFuY2VzID09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJldHVybiBwbTIuYXR0YWNoKHBtX2lkLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBleGl0UE0yKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29tbWFuZGVyLmpzb24gPT09IHRydWUpXG4gICAgICAgICAgTG9nLmpzb25TdHJlYW0ocG0yLkNsaWVudCwgcG1faWQpO1xuICAgICAgICBlbHNlIGlmIChjb21tYW5kZXIuZm9ybWF0ID09PSB0cnVlKVxuICAgICAgICAgIExvZy5mb3JtYXRTdHJlYW0ocG0yLkNsaWVudCwgcG1faWQsIGZhbHNlLCAnWVlZWS1NTS1ERC1ISDptbTpzc1paJyk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICBMb2cuc3RyZWFtKHBtMi5DbGllbnQsICdhbGwnLCB0cnVlKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuaWYgKHByb2Nlc3MuYXJndi5sZW5ndGggPT0gMikge1xuICBjb21tYW5kZXIub3V0cHV0SGVscCgpO1xuICBwcm9jZXNzLmV4aXQoMSk7XG59XG5cbnByb2Nlc3Mub24oJ1NJR0lOVCcsIGZ1bmN0aW9uICgpIHtcbiAgZXhpdFBNMigpO1xufSk7XG5cbnByb2Nlc3Mub24oJ1NJR1RFUk0nLCBmdW5jdGlvbiAoKSB7XG4gIGV4aXRQTTIoKTtcbn0pO1xuXG5jb21tYW5kZXIucGFyc2UocHJvY2Vzcy5hcmd2KTtcblxuZnVuY3Rpb24gZXhpdFBNMigpIHtcbiAgY29uc29sZS5sb2coJ0V4aXRlZCBhdCAlcycsIG5ldyBEYXRlKCkpO1xuICBpZiAoY29tbWFuZGVyLmF1dG9NYW5hZ2UpXG4gICAgcmV0dXJuIHByb2Nlc3MuZXhpdCgwKTtcblxuICBpZiAoY29tbWFuZGVyLmZhc3RCb290KSB7XG4gICAgcmV0dXJuIHBtMi5kZWxldGUoJ2FsbCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICB9KTtcbiAgfVxuICBwbTIua2lsbChmdW5jdGlvbiAoKSB7XG4gICAgcHJvY2Vzcy5leGl0KDApO1xuICB9KTtcbn1cbiJdfQ==
'use strict';

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _commander = _interopRequireDefault(require("commander"));

var _API = _interopRequireDefault(require("../API"));

var _Log = _interopRequireDefault(require("../API/Log"));

var _constants = _interopRequireDefault(require("../../constants"));

var _package = _interopRequireDefault(require("../../package.json"));

var _chalk = _interopRequireDefault(require("chalk"));

var _path = _interopRequireDefault(require("path"));

var fmt = _interopRequireWildcard(require("../tools/fmt"));

var _child_process = require("child_process");

var _os = _interopRequireDefault(require("os"));

process.env.PM2_NO_INTERACTION = 'true'; // Do not print banner

process.env.PM2_DISCRETE_MODE = "true";

_commander["default"].version(_package["default"].version).description('pm2-dev monitor for any file changes and automatically restart it').option('--raw', 'raw log output').option('--timestamp', 'print timestamp').option('--node-args <node_args>', 'space delimited arguments to pass to node in cluster mode - e.g. --node-args="--debug=7001 --trace-deprecation"').option('--ignore [files]', 'files to ignore while watching').option('--post-exec [cmd]', 'execute extra command after change detected').option('--silent-exec', 'do not output result of post command', false).option('--test-mode', 'debug mode for test suit').option('--interpreter <interpreter>', 'the interpreter pm2 should use for executing app (bash, python...)').option('--env [name]', 'select env_[name] env variables in process config file').option('--auto-exit', 'exit if all processes are errored/stopped or 0 apps launched').usage('pm2-dev app.js');

var pm2 = new _API["default"]({
  pm2_home: _path["default"].join(_os["default"].homedir ? _os["default"].homedir() : process.env.HOME || process.env.HOMEPATH || process.env.USERPROFILE, '.pm2-dev')
});
pm2.connect(function () {
  _commander["default"].parse(process.argv);
});

function postExecCmd(command, cb) {
  var exec_cmd = (0, _child_process.exec)(command);

  if (_commander["default"].silentExec !== true) {
    exec_cmd.stdout.on('data', function (data) {
      process.stdout.write(data);
    });
    exec_cmd.stderr.on('data', function (data) {
      process.stderr.write(data);
    });
  }

  exec_cmd.on('close', function done() {
    if (cb) cb(null);
  });
  exec_cmd.on('error', function (err) {
    console.error(err.stack || err);
  });
}

;

function run(cmd, opts) {
  var timestamp = opts.timestamp;
  opts.watch = true;
  opts.autorestart = true;
  opts.restart_delay = 1000;
  if (opts.autoExit) autoExit();

  if (opts.ignore) {
    opts.ignore_watch = opts.ignore.split(',');
    opts.ignore_watch.push('node_modules');
  }

  if (timestamp === true) timestamp = 'YYYY-MM-DD-HH:mm:ss';
  pm2.start(cmd, opts, function (err, procs) {
    if (err) {
      console.error(err);
      pm2.destroy(function () {
        process.exit(0);
      });
      return false;
    }

    if (opts.testMode) {
      return pm2.disconnect(function () {});
    }

    fmt.sep();
    fmt.title('PM2 development mode');
    fmt.field('Apps started', procs.map(function (p) {
      return p.pm2_env.name;
    }));
    fmt.field('Processes started', _chalk["default"].bold(procs.length));
    fmt.field('Watch and Restart', _chalk["default"].green('Enabled'));
    fmt.field('Ignored folder', opts.ignore_watch || 'node_modules');
    if (opts.postExec) fmt.field('Post restart cmd', opts.postExec);
    fmt.sep();
    setTimeout(function () {
      pm2.Client.launchBus(function (err, bus) {
        bus.on('process:event', function (packet) {
          if (packet.event == 'online') {
            if (opts.postExec) postExecCmd(opts.postExec);
          }
        });
      });
    }, 1000);

    _Log["default"].devStream(pm2.Client, 'all', opts.raw, timestamp, false);

    process.on('SIGINT', function () {
      console.log('>>>>> [PM2 DEV] Stopping current development session');
      pm2["delete"]('all', function () {
        pm2.destroy(function () {
          process.exit(0);
        });
      });
    });
  });
}

_commander["default"].command('*').action(function (cmd, opts) {
  run(cmd, _commander["default"]);
});

_commander["default"].command('start <file|json_file>').description('start target config file/script in development mode').action(function (cmd, opts) {
  run(cmd, _commander["default"]);
});

function exitPM2() {
  if (pm2 && pm2.connected == true) {
    console.log(_chalk["default"].green.bold('>>> Exiting PM2'));
    pm2.kill(function () {
      process.exit(0);
    });
  } else process.exit(0);
}

function autoExit(_final) {
  setTimeout(function () {
    pm2.list(function (err, apps) {
      if (err) console.error(err.stack || err);
      var online_count = 0;
      apps.forEach(function (app) {
        if (app.pm2_env.status == _constants["default"].ONLINE_STATUS || app.pm2_env.status == _constants["default"].LAUNCHING_STATUS) online_count++;
      });

      if (online_count == 0) {
        console.log('0 application online, exiting');
        if (_final == true) process.exit(1);else autoExit(true);
        return false;
      }

      autoExit(false);
    });
  }, 3000);
}

if (process.argv.length == 2) {
  _commander["default"].outputHelp();

  exitPM2();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9iaW5hcmllcy9EZXZDTEkudHMiXSwibmFtZXMiOlsicHJvY2VzcyIsImVudiIsIlBNMl9OT19JTlRFUkFDVElPTiIsIlBNMl9ESVNDUkVURV9NT0RFIiwiY29tbWFuZGVyIiwidmVyc2lvbiIsInBrZyIsImRlc2NyaXB0aW9uIiwib3B0aW9uIiwidXNhZ2UiLCJwbTIiLCJQTTIiLCJwbTJfaG9tZSIsInBhdGgiLCJqb2luIiwib3MiLCJob21lZGlyIiwiSE9NRSIsIkhPTUVQQVRIIiwiVVNFUlBST0ZJTEUiLCJjb25uZWN0IiwicGFyc2UiLCJhcmd2IiwicG9zdEV4ZWNDbWQiLCJjb21tYW5kIiwiY2IiLCJleGVjX2NtZCIsInNpbGVudEV4ZWMiLCJzdGRvdXQiLCJvbiIsImRhdGEiLCJ3cml0ZSIsInN0ZGVyciIsImRvbmUiLCJlcnIiLCJjb25zb2xlIiwiZXJyb3IiLCJzdGFjayIsInJ1biIsImNtZCIsIm9wdHMiLCJ0aW1lc3RhbXAiLCJ3YXRjaCIsImF1dG9yZXN0YXJ0IiwicmVzdGFydF9kZWxheSIsImF1dG9FeGl0IiwiaWdub3JlIiwiaWdub3JlX3dhdGNoIiwic3BsaXQiLCJwdXNoIiwic3RhcnQiLCJwcm9jcyIsImRlc3Ryb3kiLCJleGl0IiwidGVzdE1vZGUiLCJkaXNjb25uZWN0IiwiZm10Iiwic2VwIiwidGl0bGUiLCJmaWVsZCIsIm1hcCIsInAiLCJwbTJfZW52IiwibmFtZSIsImNoYWxrIiwiYm9sZCIsImxlbmd0aCIsImdyZWVuIiwicG9zdEV4ZWMiLCJzZXRUaW1lb3V0IiwiQ2xpZW50IiwibGF1bmNoQnVzIiwiYnVzIiwicGFja2V0IiwiZXZlbnQiLCJMb2ciLCJkZXZTdHJlYW0iLCJyYXciLCJsb2ciLCJhY3Rpb24iLCJleGl0UE0yIiwiY29ubmVjdGVkIiwia2lsbCIsImZpbmFsIiwibGlzdCIsImFwcHMiLCJvbmxpbmVfY291bnQiLCJmb3JFYWNoIiwiYXBwIiwic3RhdHVzIiwiY3N0IiwiT05MSU5FX1NUQVRV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LEdBQUosRUFBU0MsT0FBTyxDQUFDQyxLQUFSLENBQWNGLEdBQUcsQ0FBQ0csS0FBSixJQUFhSCxHQUEzQjtBQUVULFVBQUlvRCxZQUFZLEdBQUcsQ0FBbkI7QUFFQUQsTUFBQUEsSUFBSSxDQUFDRSxPQUFMLENBQWEsVUFBU0MsR0FBVCxFQUFjO0FBQ3pCLFlBQUlBLEdBQUcsQ0FBQzFCLE9BQUosQ0FBWTJCLE1BQVosSUFBc0JDLHNCQUFJQyxhQUExQixJQUNBSCxHQUFHLENBQUMxQixPQUFKLENBQVkyQixNQUFaLElBQXNCQyxzQkFBSUUsZ0JBRDlCLEVBRUVOLFlBQVk7QUFDZixPQUpEOztBQU1BLFVBQUlBLFlBQVksSUFBSSxDQUFwQixFQUF1QjtBQUNyQm5ELFFBQUFBLE9BQU8sQ0FBQzJDLEdBQVIsQ0FBWSwrQkFBWjtBQUNBLFlBQUlLLE1BQUssSUFBSSxJQUFiLEVBQ0VuRixPQUFPLENBQUNxRCxJQUFSLENBQWEsQ0FBYixFQURGLEtBR0VSLFFBQVEsQ0FBQyxJQUFELENBQVI7QUFDRixlQUFPLEtBQVA7QUFDRDs7QUFDREEsTUFBQUEsUUFBUSxDQUFDLEtBQUQsQ0FBUjtBQUNELEtBcEJEO0FBcUJELEdBdEJTLEVBc0JQLElBdEJPLENBQVY7QUF1QkQ7O0FBRUQsSUFBSTdDLE9BQU8sQ0FBQ3NCLElBQVIsQ0FBYTRDLE1BQWIsSUFBdUIsQ0FBM0IsRUFBOEI7QUFDNUI5RCx3QkFBVXlGLFVBQVY7O0FBQ0FiLEVBQUFBLE9BQU87QUFDUiIsInNvdXJjZXNDb250ZW50IjpbIlxuJ3VzZSBzdHJpY3QnO1xuXG5wcm9jZXNzLmVudi5QTTJfTk9fSU5URVJBQ1RJT04gPSAndHJ1ZSc7XG4vLyBEbyBub3QgcHJpbnQgYmFubmVyXG5wcm9jZXNzLmVudi5QTTJfRElTQ1JFVEVfTU9ERSA9IFwidHJ1ZVwiO1xuXG5pbXBvcnQgY29tbWFuZGVyIGZyb20gJ2NvbW1hbmRlcic7XG5cbmltcG9ydCBQTTIgICAgICAgZnJvbSAnLi4vQVBJJztcbmltcG9ydCBMb2cgICAgICAgZnJvbSAnLi4vQVBJL0xvZyc7XG5pbXBvcnQgY3N0ICAgICAgIGZyb20gJy4uLy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgcGtnICAgICAgIGZyb20gJy4uLy4uL3BhY2thZ2UuanNvbic7XG5pbXBvcnQgY2hhbGsgICAgIGZyb20gJ2NoYWxrJztcbmltcG9ydCBwYXRoICAgICAgZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBmbXQgICAgICAgZnJvbSAnLi4vdG9vbHMvZm10JztcbmltcG9ydCB7IGV4ZWMgfSAgICAgIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IG9zICAgICAgICBmcm9tICdvcyc7XG5cbmNvbW1hbmRlci52ZXJzaW9uKHBrZy52ZXJzaW9uKVxuICAuZGVzY3JpcHRpb24oJ3BtMi1kZXYgbW9uaXRvciBmb3IgYW55IGZpbGUgY2hhbmdlcyBhbmQgYXV0b21hdGljYWxseSByZXN0YXJ0IGl0JylcbiAgLm9wdGlvbignLS1yYXcnLCAncmF3IGxvZyBvdXRwdXQnKVxuICAub3B0aW9uKCctLXRpbWVzdGFtcCcsICdwcmludCB0aW1lc3RhbXAnKVxuICAub3B0aW9uKCctLW5vZGUtYXJncyA8bm9kZV9hcmdzPicsICdzcGFjZSBkZWxpbWl0ZWQgYXJndW1lbnRzIHRvIHBhc3MgdG8gbm9kZSBpbiBjbHVzdGVyIG1vZGUgLSBlLmcuIC0tbm9kZS1hcmdzPVwiLS1kZWJ1Zz03MDAxIC0tdHJhY2UtZGVwcmVjYXRpb25cIicpXG4gIC5vcHRpb24oJy0taWdub3JlIFtmaWxlc10nLCAnZmlsZXMgdG8gaWdub3JlIHdoaWxlIHdhdGNoaW5nJylcbiAgLm9wdGlvbignLS1wb3N0LWV4ZWMgW2NtZF0nLCAnZXhlY3V0ZSBleHRyYSBjb21tYW5kIGFmdGVyIGNoYW5nZSBkZXRlY3RlZCcpXG4gIC5vcHRpb24oJy0tc2lsZW50LWV4ZWMnLCAnZG8gbm90IG91dHB1dCByZXN1bHQgb2YgcG9zdCBjb21tYW5kJywgZmFsc2UpXG4gIC5vcHRpb24oJy0tdGVzdC1tb2RlJywgJ2RlYnVnIG1vZGUgZm9yIHRlc3Qgc3VpdCcpXG4gIC5vcHRpb24oJy0taW50ZXJwcmV0ZXIgPGludGVycHJldGVyPicsICd0aGUgaW50ZXJwcmV0ZXIgcG0yIHNob3VsZCB1c2UgZm9yIGV4ZWN1dGluZyBhcHAgKGJhc2gsIHB5dGhvbi4uLiknKVxuICAub3B0aW9uKCctLWVudiBbbmFtZV0nLCAnc2VsZWN0IGVudl9bbmFtZV0gZW52IHZhcmlhYmxlcyBpbiBwcm9jZXNzIGNvbmZpZyBmaWxlJylcbiAgLm9wdGlvbignLS1hdXRvLWV4aXQnLCAnZXhpdCBpZiBhbGwgcHJvY2Vzc2VzIGFyZSBlcnJvcmVkL3N0b3BwZWQgb3IgMCBhcHBzIGxhdW5jaGVkJylcbiAgLnVzYWdlKCdwbTItZGV2IGFwcC5qcycpO1xuXG52YXIgcG0yOiBhbnkgPSBuZXcgUE0yKHtcbiAgcG0yX2hvbWUgOiBwYXRoLmpvaW4ob3MuaG9tZWRpciA/IG9zLmhvbWVkaXIoKSA6IChwcm9jZXNzLmVudi5IT01FIHx8IHByb2Nlc3MuZW52LkhPTUVQQVRIIHx8IHByb2Nlc3MuZW52LlVTRVJQUk9GSUxFKSwgJy5wbTItZGV2Jylcbn0pO1xuXG5wbTIuY29ubmVjdChmdW5jdGlvbigpIHtcbiAgY29tbWFuZGVyLnBhcnNlKHByb2Nlc3MuYXJndik7XG59KTtcblxuZnVuY3Rpb24gcG9zdEV4ZWNDbWQoY29tbWFuZCwgY2I/KSB7XG4gIHZhciBleGVjX2NtZCA9IGV4ZWMoY29tbWFuZCk7XG5cbiAgaWYgKGNvbW1hbmRlci5zaWxlbnRFeGVjICE9PSB0cnVlKSB7XG4gICAgZXhlY19jbWQuc3Rkb3V0Lm9uKCdkYXRhJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoZGF0YSk7XG4gICAgfSk7XG5cbiAgICBleGVjX2NtZC5zdGRlcnIub24oJ2RhdGEnLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgICBwcm9jZXNzLnN0ZGVyci53cml0ZShkYXRhKTtcbiAgICB9KTtcbiAgfVxuXG4gIGV4ZWNfY21kLm9uKCdjbG9zZScsIGZ1bmN0aW9uIGRvbmUoKSB7XG4gICAgaWYgKGNiKSBjYihudWxsKTtcbiAgfSk7XG5cbiAgZXhlY19jbWQub24oJ2Vycm9yJywgZnVuY3Rpb24gKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyLnN0YWNrIHx8IGVycik7XG4gIH0pO1xufTtcblxuZnVuY3Rpb24gcnVuKGNtZCwgb3B0cykge1xuICB2YXIgdGltZXN0YW1wID0gb3B0cy50aW1lc3RhbXA7XG5cbiAgb3B0cy53YXRjaCA9IHRydWU7XG4gIG9wdHMuYXV0b3Jlc3RhcnQgPSB0cnVlO1xuICBvcHRzLnJlc3RhcnRfZGVsYXkgPSAxMDAwXG4gIGlmIChvcHRzLmF1dG9FeGl0KVxuICAgIGF1dG9FeGl0KCk7XG5cbiAgaWYgKG9wdHMuaWdub3JlKSB7XG4gICAgb3B0cy5pZ25vcmVfd2F0Y2ggPSBvcHRzLmlnbm9yZS5zcGxpdCgnLCcpXG4gICAgb3B0cy5pZ25vcmVfd2F0Y2gucHVzaCgnbm9kZV9tb2R1bGVzJyk7XG4gIH1cblxuICBpZiAodGltZXN0YW1wID09PSB0cnVlKVxuICAgIHRpbWVzdGFtcCA9ICdZWVlZLU1NLURELUhIOm1tOnNzJztcblxuICBwbTIuc3RhcnQoY21kLCBvcHRzLCBmdW5jdGlvbihlcnIsIHByb2NzKSB7XG5cbiAgICBpZiAoZXJyKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICBwbTIuZGVzdHJveShmdW5jdGlvbigpIHtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKG9wdHMudGVzdE1vZGUpIHtcbiAgICAgIHJldHVybiBwbTIuZGlzY29ubmVjdChmdW5jdGlvbigpIHtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGZtdC5zZXAoKTtcbiAgICBmbXQudGl0bGUoJ1BNMiBkZXZlbG9wbWVudCBtb2RlJyk7XG4gICAgZm10LmZpZWxkKCdBcHBzIHN0YXJ0ZWQnLCBwcm9jcy5tYXAoZnVuY3Rpb24ocCkgeyByZXR1cm4gcC5wbTJfZW52Lm5hbWUgfSApKTtcbiAgICBmbXQuZmllbGQoJ1Byb2Nlc3NlcyBzdGFydGVkJywgY2hhbGsuYm9sZChwcm9jcy5sZW5ndGgpKTtcbiAgICBmbXQuZmllbGQoJ1dhdGNoIGFuZCBSZXN0YXJ0JywgY2hhbGsuZ3JlZW4oJ0VuYWJsZWQnKSk7XG4gICAgZm10LmZpZWxkKCdJZ25vcmVkIGZvbGRlcicsIG9wdHMuaWdub3JlX3dhdGNoIHx8ICdub2RlX21vZHVsZXMnKTtcbiAgICBpZiAob3B0cy5wb3N0RXhlYylcbiAgICAgIGZtdC5maWVsZCgnUG9zdCByZXN0YXJ0IGNtZCcsIG9wdHMucG9zdEV4ZWMpO1xuICAgIGZtdC5zZXAoKTtcblxuICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICBwbTIuQ2xpZW50LmxhdW5jaEJ1cyhmdW5jdGlvbihlcnIsIGJ1cykge1xuICAgICAgICBidXMub24oJ3Byb2Nlc3M6ZXZlbnQnLCBmdW5jdGlvbihwYWNrZXQpIHtcbiAgICAgICAgICBpZiAocGFja2V0LmV2ZW50ID09ICdvbmxpbmUnKSB7XG4gICAgICAgICAgICBpZiAob3B0cy5wb3N0RXhlYylcbiAgICAgICAgICAgICAgcG9zdEV4ZWNDbWQob3B0cy5wb3N0RXhlYyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0sIDEwMDApO1xuXG4gICAgTG9nLmRldlN0cmVhbShwbTIuQ2xpZW50LCAnYWxsJywgb3B0cy5yYXcsIHRpbWVzdGFtcCwgZmFsc2UpO1xuXG4gICAgcHJvY2Vzcy5vbignU0lHSU5UJywgZnVuY3Rpb24oKSB7XG4gICAgICBjb25zb2xlLmxvZygnPj4+Pj4gW1BNMiBERVZdIFN0b3BwaW5nIGN1cnJlbnQgZGV2ZWxvcG1lbnQgc2Vzc2lvbicpO1xuICAgICAgcG0yLmRlbGV0ZSgnYWxsJywgZnVuY3Rpb24oKSB7XG4gICAgICAgIHBtMi5kZXN0cm95KGZ1bmN0aW9uKCkge1xuICAgICAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICB9KTtcbn1cblxuY29tbWFuZGVyLmNvbW1hbmQoJyonKVxuICAuYWN0aW9uKGZ1bmN0aW9uKGNtZCwgb3B0cyl7XG4gICAgcnVuKGNtZCwgY29tbWFuZGVyKTtcbiAgfSk7XG5cbmNvbW1hbmRlci5jb21tYW5kKCdzdGFydCA8ZmlsZXxqc29uX2ZpbGU+JylcbiAgLmRlc2NyaXB0aW9uKCdzdGFydCB0YXJnZXQgY29uZmlnIGZpbGUvc2NyaXB0IGluIGRldmVsb3BtZW50IG1vZGUnKVxuICAuYWN0aW9uKGZ1bmN0aW9uKGNtZCwgb3B0cykge1xuICAgIHJ1bihjbWQsIGNvbW1hbmRlcik7XG4gIH0pO1xuXG5mdW5jdGlvbiBleGl0UE0yKCkge1xuICBpZiAocG0yICYmIHBtMi5jb25uZWN0ZWQgPT0gdHJ1ZSkge1xuICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZWVuLmJvbGQoJz4+PiBFeGl0aW5nIFBNMicpKTtcbiAgICBwbTIua2lsbChmdW5jdGlvbigpIHtcbiAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICB9KTtcbiAgfVxuICBlbHNlXG4gICAgcHJvY2Vzcy5leGl0KDApO1xufVxuXG5mdW5jdGlvbiBhdXRvRXhpdChmaW5hbD8pIHtcbiAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICBwbTIubGlzdChmdW5jdGlvbihlcnIsIGFwcHMpIHtcbiAgICAgIGlmIChlcnIpIGNvbnNvbGUuZXJyb3IoZXJyLnN0YWNrIHx8IGVycik7XG5cbiAgICAgIHZhciBvbmxpbmVfY291bnQgPSAwO1xuXG4gICAgICBhcHBzLmZvckVhY2goZnVuY3Rpb24oYXBwKSB7XG4gICAgICAgIGlmIChhcHAucG0yX2Vudi5zdGF0dXMgPT0gY3N0Lk9OTElORV9TVEFUVVMgfHxcbiAgICAgICAgICAgIGFwcC5wbTJfZW52LnN0YXR1cyA9PSBjc3QuTEFVTkNISU5HX1NUQVRVUylcbiAgICAgICAgICBvbmxpbmVfY291bnQrKztcbiAgICAgIH0pO1xuXG4gICAgICBpZiAob25saW5lX2NvdW50ID09IDApIHtcbiAgICAgICAgY29uc29sZS5sb2coJzAgYXBwbGljYXRpb24gb25saW5lLCBleGl0aW5nJyk7XG4gICAgICAgIGlmIChmaW5hbCA9PSB0cnVlKVxuICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGF1dG9FeGl0KHRydWUpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBhdXRvRXhpdChmYWxzZSk7XG4gICAgfSk7XG4gIH0sIDMwMDApO1xufVxuXG5pZiAocHJvY2Vzcy5hcmd2Lmxlbmd0aCA9PSAyKSB7XG4gIGNvbW1hbmRlci5vdXRwdXRIZWxwKCk7XG4gIGV4aXRQTTIoKTtcbn1cbiJdfQ==
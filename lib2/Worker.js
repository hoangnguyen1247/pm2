"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _vizion = _interopRequireDefault(require("vizion"));

var _constants = _interopRequireDefault(require("../constants.js"));

var _eachLimit = _interopRequireDefault(require("async/eachLimit"));

var _debug = _interopRequireDefault(require("debug"));

var _domain = _interopRequireDefault(require("domain"));

var _cron = require("cron");

var _VersionCheck = _interopRequireDefault(require("./VersionCheck"));

var _package = _interopRequireDefault(require("../package.json"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

var debug = (0, _debug["default"])('pm2:worker');

function _default(God) {
  var timer = null;
  God.CronJobs = new Map();
  God.Worker = {};
  God.Worker.is_running = false;

  God.getCronID = function (pm_id) {
    return "cron-".concat(pm_id);
  };

  God.registerCron = function (pm2_env) {
    if (!pm2_env || pm2_env.pm_id === undefined || !pm2_env.cron_restart || God.CronJobs.has(God.getCronID(pm2_env.pm_id))) return;
    console.log('[PM2][WORKER] Registering a cron job on:', pm2_env.pm_id);
    var job = new _cron.CronJob({
      cronTime: pm2_env.cron_restart,
      onTick: function onTick() {
        God.softReloadProcessId({
          id: pm2_env.pm_id
        }, function (err, data) {
          if (err) console.error(err.stack || err);
          return;
        });
      },
      start: false
    });
    job.start();
    God.CronJobs.set(God.getCronID(pm2_env.pm_id), job);
  };
  /**
   * Deletes the cron job on deletion of process
   */


  God.deleteCron = function (id) {
    if (typeof id !== 'undefined' && God.CronJobs.has(God.getCronID(id)) === false) return;
    console.log('[PM2] Deregistering a cron job on:', id);
    var job = God.CronJobs.get(God.getCronID(id));
    job.stop();
    God.CronJobs["delete"](God.getCronID(id));
  };

  var _getProcessById = function _getProcessById(pm_id) {
    var proc = God.clusters_db[pm_id];
    return proc ? proc : null;
  };

  var maxMemoryRestart = function maxMemoryRestart(proc_key, cb) {
    var proc = _getProcessById(proc_key.pm2_env.pm_id);

    if (!(proc && proc.pm2_env && proc_key.monit)) return cb();

    if (proc_key.monit.memory !== undefined && proc.pm2_env.max_memory_restart !== undefined && proc.pm2_env.max_memory_restart < proc_key.monit.memory && proc.pm2_env.axm_options && proc.pm2_env.axm_options.pid === undefined) {
      console.log('[PM2][WORKER] Process %s restarted because it exceeds --max-memory-restart value (current_memory=%s max_memory_limit=%s [octets])', proc.pm2_env.pm_id, proc_key.monit.memory, proc.pm2_env.max_memory_restart);
      God.softReloadProcessId({
        id: proc.pm2_env.pm_id
      }, function (err, data) {
        if (err) console.error(err.stack || err);
        return cb();
      });
    } else {
      return cb();
    }
  }; // Deprecated


  var versioningRefresh = function versioningRefresh(proc_key, cb) {
    var proc = _getProcessById(proc_key.pm2_env.pm_id);

    if (!(proc && proc.pm2_env && proc.pm2_env.vizion !== false && proc.pm2_env.vizion != "false" && proc.pm2_env.versioning && proc.pm2_env.versioning.repo_path)) {
      return cb();
    }

    if (proc.pm2_env.vizion_running === true) {
      debug('Vizion is already running for proc id: %d, skipping this round', proc.pm2_env.pm_id);
      return cb();
    }

    proc.pm2_env.vizion_running = true;
    var repo_path = proc.pm2_env.versioning.repo_path;

    _vizion["default"].analyze({
      folder: proc.pm2_env.versioning.repo_path
    }, function (err, meta) {
      if (err != null) return cb();
      proc = _getProcessById(proc_key.pm2_env.pm_id);

      if (!(proc && proc.pm2_env && proc.pm2_env.versioning && proc.pm2_env.versioning.repo_path)) {
        console.error('Proc not defined anymore or versioning unknown');
        return cb();
      }

      proc.pm2_env.vizion_running = false;
      meta.repo_path = repo_path;
      proc.pm2_env.versioning = meta;
      debug('[PM2][WORKER] %s parsed for versioning', proc.pm2_env.name);
      return cb();
    });
  };

  var tasks = function tasks() {
    if (God.Worker.is_running === true) {
      debug('[PM2][WORKER] Worker is already running, skipping this round');
      return false;
    }

    God.Worker.is_running = true;
    God.getMonitorData(null, function (err, data) {
      if (err || !data || _typeof(data) !== 'object') {
        God.Worker.is_running = false;
        return console.error(err);
      }

      (0, _eachLimit["default"])(data, 1, function (proc, next) {
        if (!proc || !proc.pm2_env || proc.pm2_env.pm_id === undefined) return next();
        debug('[PM2][WORKER] Processing proc id:', proc.pm2_env.pm_id); // Reset restart delay if application has an uptime of more > 30secs

        if (proc.pm2_env.exp_backoff_restart_delay !== undefined && proc.pm2_env.prev_restart_delay && proc.pm2_env.prev_restart_delay > 0) {
          var app_uptime = Date.now() - proc.pm2_env.pm_uptime;

          if (app_uptime > _constants["default"].EXP_BACKOFF_RESET_TIMER) {
            var ref_proc = _getProcessById(proc.pm2_env.pm_id);

            ref_proc.pm2_env.prev_restart_delay = 0;
            console.log("[PM2][WORKER] Reset the restart delay, as app ".concat(proc.name, " has been up for more than ").concat(_constants["default"].EXP_BACKOFF_RESET_TIMER, "ms"));
          }
        } // Check if application has reached memory threshold


        maxMemoryRestart(proc, function () {
          return next();
        });
      }, function (err) {
        God.Worker.is_running = false;
        debug('[PM2][WORKER] My job here is done, next job in %d seconds', parseInt(_constants["default"].WORKER_INTERVAL / 1000 + ""));
      });
    });
  };

  var wrappedTasks = function wrappedTasks() {
    var d = _domain["default"].create();

    d.once('error', function (err) {
      console.error('[PM2][WORKER] Error caught by domain:\n' + (err.stack || err));
      God.Worker.is_running = false;
    });
    d.run(function () {
      tasks();
    });
  };

  God.Worker.start = function () {
    timer = setInterval(wrappedTasks, _constants["default"].WORKER_INTERVAL);
    setInterval(function () {
      (0, _VersionCheck["default"])({
        state: 'check',
        version: _package["default"].version
      });
    }, 1000 * 60 * 60 * 24);
  };

  God.Worker.stop = function () {
    if (timer !== null) clearInterval(timer);
  };
}

;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Xb3JrZXIudHMiXSwibmFtZXMiOlsiZGVidWciLCJHb2QiLCJ0aW1lciIsIkNyb25Kb2JzIiwiTWFwIiwiV29ya2VyIiwiaXNfcnVubmluZyIsImdldENyb25JRCIsInBtX2lkIiwicmVnaXN0ZXJDcm9uIiwicG0yX2VudiIsInVuZGVmaW5lZCIsImNyb25fcmVzdGFydCIsImhhcyIsImNvbnNvbGUiLCJsb2ciLCJqb2IiLCJDcm9uSm9iIiwiY3JvblRpbWUiLCJvblRpY2siLCJzb2Z0UmVsb2FkUHJvY2Vzc0lkIiwiaWQiLCJlcnIiLCJkYXRhIiwiZXJyb3IiLCJzdGFjayIsInN0YXJ0Iiwic2V0IiwiZGVsZXRlQ3JvbiIsImdldCIsInN0b3AiLCJfZ2V0UHJvY2Vzc0J5SWQiLCJwcm9jIiwiY2x1c3RlcnNfZGIiLCJtYXhNZW1vcnlSZXN0YXJ0IiwicHJvY19rZXkiLCJjYiIsIm1vbml0IiwibWVtb3J5IiwibWF4X21lbW9yeV9yZXN0YXJ0IiwiYXhtX29wdGlvbnMiLCJwaWQiLCJ2ZXJzaW9uaW5nUmVmcmVzaCIsInZpemlvbiIsInZlcnNpb25pbmciLCJyZXBvX3BhdGgiLCJ2aXppb25fcnVubmluZyIsImFuYWx5emUiLCJmb2xkZXIiLCJtZXRhIiwibmFtZSIsInRhc2tzIiwiZ2V0TW9uaXRvckRhdGEiLCJuZXh0IiwiZXhwX2JhY2tvZmZfcmVzdGFydF9kZWxheSIsInByZXZfcmVzdGFydF9kZWxheSIsImFwcF91cHRpbWUiLCJEYXRlIiwibm93IiwicG1fdXB0aW1lIiwiY3N0IiwiRVhQX0JBQ0tPRkZfUkVTRVRfVElNRVIiLCJyZWZfcHJvYyIsInBhcnNlSW50IiwiV09SS0VSX0lOVEVSVkFMIiwid3JhcHBlZFRhc2tzIiwiZCIsImRvbWFpbiIsImNyZWF0ZSIsIm9uY2UiLCJydW4iLCJzZXRJbnRlcnZhbCIsInN0YXRlIiwidmVyc2lvbiIsInBrZyIsImNsZWFySW50ZXJ2YWwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFLQTs7QUFD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QUFKLENBQVd5QixJQUFYLEdBQWtCLFlBQVk7QUFDNUIsUUFBSTVCLEtBQUssS0FBSyxJQUFkLEVBQ0V5RSxhQUFhLENBQUN6RSxLQUFELENBQWI7QUFDSCxHQUhEO0FBSUQ7O0FBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29weXJpZ2h0IDIwMTMgdGhlIFBNMiBwcm9qZWN0IGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgbGljZW5zZSB0aGF0XHJcbiAqIGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLlxyXG4gKi9cclxuaW1wb3J0IHZpemlvbiBmcm9tICd2aXppb24nO1xyXG5pbXBvcnQgY3N0IGZyb20gJy4uL2NvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBlYWNoTGltaXQgZnJvbSAnYXN5bmMvZWFjaExpbWl0JztcclxuaW1wb3J0IGRlYnVnTG9nZ2VyIGZyb20gJ2RlYnVnJztcclxuaW1wb3J0IGRvbWFpbiBmcm9tICdkb21haW4nO1xyXG5pbXBvcnQgeyBDcm9uSm9iIH0gZnJvbSAnY3Jvbic7XHJcbmltcG9ydCB2Q2hlY2sgZnJvbSAnLi9WZXJzaW9uQ2hlY2snO1xyXG5pbXBvcnQgcGtnIGZyb20gJy4uL3BhY2thZ2UuanNvbic7XHJcblxyXG52YXIgZGVidWcgPSBkZWJ1Z0xvZ2dlcigncG0yOndvcmtlcicpO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKEdvZCkge1xyXG4gIHZhciB0aW1lciA9IG51bGw7XHJcblxyXG4gIEdvZC5Dcm9uSm9icyA9IG5ldyBNYXAoKTtcclxuICBHb2QuV29ya2VyID0ge307XHJcbiAgR29kLldvcmtlci5pc19ydW5uaW5nID0gZmFsc2U7XHJcblxyXG4gIEdvZC5nZXRDcm9uSUQgPSBmdW5jdGlvbiAocG1faWQpIHtcclxuICAgIHJldHVybiBgY3Jvbi0ke3BtX2lkfWBcclxuICB9XHJcblxyXG4gIEdvZC5yZWdpc3RlckNyb24gPSBmdW5jdGlvbiAocG0yX2Vudikge1xyXG4gICAgaWYgKCFwbTJfZW52IHx8XHJcbiAgICAgIHBtMl9lbnYucG1faWQgPT09IHVuZGVmaW5lZCB8fFxyXG4gICAgICAhcG0yX2Vudi5jcm9uX3Jlc3RhcnQgfHxcclxuICAgICAgR29kLkNyb25Kb2JzLmhhcyhHb2QuZ2V0Q3JvbklEKHBtMl9lbnYucG1faWQpKSlcclxuICAgICAgcmV0dXJuO1xyXG5cclxuICAgIGNvbnNvbGUubG9nKCdbUE0yXVtXT1JLRVJdIFJlZ2lzdGVyaW5nIGEgY3JvbiBqb2Igb246JywgcG0yX2Vudi5wbV9pZCk7XHJcblxyXG4gICAgdmFyIGpvYiA9IG5ldyBDcm9uSm9iKHtcclxuICAgICAgY3JvblRpbWU6IHBtMl9lbnYuY3Jvbl9yZXN0YXJ0LFxyXG4gICAgICBvblRpY2s6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBHb2Quc29mdFJlbG9hZFByb2Nlc3NJZCh7IGlkOiBwbTJfZW52LnBtX2lkIH0sIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHtcclxuICAgICAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLnN0YWNrIHx8IGVycik7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHN0YXJ0OiBmYWxzZVxyXG4gICAgfSk7XHJcblxyXG4gICAgam9iLnN0YXJ0KCk7XHJcbiAgICBHb2QuQ3JvbkpvYnMuc2V0KEdvZC5nZXRDcm9uSUQocG0yX2Vudi5wbV9pZCksIGpvYik7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogRGVsZXRlcyB0aGUgY3JvbiBqb2Igb24gZGVsZXRpb24gb2YgcHJvY2Vzc1xyXG4gICAqL1xyXG4gIEdvZC5kZWxldGVDcm9uID0gZnVuY3Rpb24gKGlkKSB7XHJcbiAgICBpZiAodHlwZW9mIChpZCkgIT09ICd1bmRlZmluZWQnICYmIEdvZC5Dcm9uSm9icy5oYXMoR29kLmdldENyb25JRChpZCkpID09PSBmYWxzZSlcclxuICAgICAgcmV0dXJuO1xyXG4gICAgY29uc29sZS5sb2coJ1tQTTJdIERlcmVnaXN0ZXJpbmcgYSBjcm9uIGpvYiBvbjonLCBpZCk7XHJcbiAgICB2YXIgam9iID0gR29kLkNyb25Kb2JzLmdldChHb2QuZ2V0Q3JvbklEKGlkKSk7XHJcbiAgICBqb2Iuc3RvcCgpO1xyXG4gICAgR29kLkNyb25Kb2JzLmRlbGV0ZShHb2QuZ2V0Q3JvbklEKGlkKSk7XHJcbiAgfTtcclxuXHJcbiAgdmFyIF9nZXRQcm9jZXNzQnlJZCA9IGZ1bmN0aW9uIChwbV9pZCkge1xyXG4gICAgdmFyIHByb2MgPSBHb2QuY2x1c3RlcnNfZGJbcG1faWRdO1xyXG4gICAgcmV0dXJuIHByb2MgPyBwcm9jIDogbnVsbDtcclxuICB9O1xyXG5cclxuXHJcbiAgdmFyIG1heE1lbW9yeVJlc3RhcnQgPSBmdW5jdGlvbiAocHJvY19rZXksIGNiKSB7XHJcbiAgICB2YXIgcHJvYyA9IF9nZXRQcm9jZXNzQnlJZChwcm9jX2tleS5wbTJfZW52LnBtX2lkKTtcclxuXHJcbiAgICBpZiAoIShwcm9jICYmXHJcbiAgICAgIHByb2MucG0yX2VudiAmJlxyXG4gICAgICBwcm9jX2tleS5tb25pdCkpXHJcbiAgICAgIHJldHVybiBjYigpO1xyXG5cclxuICAgIGlmIChwcm9jX2tleS5tb25pdC5tZW1vcnkgIT09IHVuZGVmaW5lZCAmJlxyXG4gICAgICBwcm9jLnBtMl9lbnYubWF4X21lbW9yeV9yZXN0YXJ0ICE9PSB1bmRlZmluZWQgJiZcclxuICAgICAgcHJvYy5wbTJfZW52Lm1heF9tZW1vcnlfcmVzdGFydCA8IHByb2Nfa2V5Lm1vbml0Lm1lbW9yeSAmJlxyXG4gICAgICBwcm9jLnBtMl9lbnYuYXhtX29wdGlvbnMgJiZcclxuICAgICAgcHJvYy5wbTJfZW52LmF4bV9vcHRpb25zLnBpZCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdbUE0yXVtXT1JLRVJdIFByb2Nlc3MgJXMgcmVzdGFydGVkIGJlY2F1c2UgaXQgZXhjZWVkcyAtLW1heC1tZW1vcnktcmVzdGFydCB2YWx1ZSAoY3VycmVudF9tZW1vcnk9JXMgbWF4X21lbW9yeV9saW1pdD0lcyBbb2N0ZXRzXSknLCBwcm9jLnBtMl9lbnYucG1faWQsIHByb2Nfa2V5Lm1vbml0Lm1lbW9yeSwgcHJvYy5wbTJfZW52Lm1heF9tZW1vcnlfcmVzdGFydCk7XHJcbiAgICAgIEdvZC5zb2Z0UmVsb2FkUHJvY2Vzc0lkKHtcclxuICAgICAgICBpZDogcHJvYy5wbTJfZW52LnBtX2lkXHJcbiAgICAgIH0sIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHtcclxuICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgY29uc29sZS5lcnJvcihlcnIuc3RhY2sgfHwgZXJyKTtcclxuICAgICAgICByZXR1cm4gY2IoKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgcmV0dXJuIGNiKCk7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgLy8gRGVwcmVjYXRlZFxyXG4gIHZhciB2ZXJzaW9uaW5nUmVmcmVzaCA9IGZ1bmN0aW9uIChwcm9jX2tleSwgY2IpIHtcclxuICAgIHZhciBwcm9jID0gX2dldFByb2Nlc3NCeUlkKHByb2Nfa2V5LnBtMl9lbnYucG1faWQpO1xyXG4gICAgaWYgKCEocHJvYyAmJlxyXG4gICAgICBwcm9jLnBtMl9lbnYgJiZcclxuICAgICAgKHByb2MucG0yX2Vudi52aXppb24gIT09IGZhbHNlICYmIHByb2MucG0yX2Vudi52aXppb24gIT0gXCJmYWxzZVwiKSAmJlxyXG4gICAgICBwcm9jLnBtMl9lbnYudmVyc2lvbmluZyAmJlxyXG4gICAgICBwcm9jLnBtMl9lbnYudmVyc2lvbmluZy5yZXBvX3BhdGgpKSB7XHJcbiAgICAgIHJldHVybiBjYigpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChwcm9jLnBtMl9lbnYudml6aW9uX3J1bm5pbmcgPT09IHRydWUpIHtcclxuICAgICAgZGVidWcoJ1ZpemlvbiBpcyBhbHJlYWR5IHJ1bm5pbmcgZm9yIHByb2MgaWQ6ICVkLCBza2lwcGluZyB0aGlzIHJvdW5kJywgcHJvYy5wbTJfZW52LnBtX2lkKTtcclxuICAgICAgcmV0dXJuIGNiKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvYy5wbTJfZW52LnZpemlvbl9ydW5uaW5nID0gdHJ1ZTtcclxuICAgIHZhciByZXBvX3BhdGggPSBwcm9jLnBtMl9lbnYudmVyc2lvbmluZy5yZXBvX3BhdGg7XHJcblxyXG4gICAgdml6aW9uLmFuYWx5emUoe1xyXG4gICAgICBmb2xkZXI6IHByb2MucG0yX2Vudi52ZXJzaW9uaW5nLnJlcG9fcGF0aFxyXG4gICAgfSxcclxuICAgICAgZnVuY3Rpb24gKGVyciwgbWV0YSkge1xyXG4gICAgICAgIGlmIChlcnIgIT0gbnVsbClcclxuICAgICAgICAgIHJldHVybiBjYigpO1xyXG5cclxuICAgICAgICBwcm9jID0gX2dldFByb2Nlc3NCeUlkKHByb2Nfa2V5LnBtMl9lbnYucG1faWQpO1xyXG5cclxuICAgICAgICBpZiAoIShwcm9jICYmXHJcbiAgICAgICAgICBwcm9jLnBtMl9lbnYgJiZcclxuICAgICAgICAgIHByb2MucG0yX2Vudi52ZXJzaW9uaW5nICYmXHJcbiAgICAgICAgICBwcm9jLnBtMl9lbnYudmVyc2lvbmluZy5yZXBvX3BhdGgpKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdQcm9jIG5vdCBkZWZpbmVkIGFueW1vcmUgb3IgdmVyc2lvbmluZyB1bmtub3duJyk7XHJcbiAgICAgICAgICByZXR1cm4gY2IoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHByb2MucG0yX2Vudi52aXppb25fcnVubmluZyA9IGZhbHNlO1xyXG4gICAgICAgIG1ldGEucmVwb19wYXRoID0gcmVwb19wYXRoO1xyXG4gICAgICAgIHByb2MucG0yX2Vudi52ZXJzaW9uaW5nID0gbWV0YTtcclxuICAgICAgICBkZWJ1ZygnW1BNMl1bV09SS0VSXSAlcyBwYXJzZWQgZm9yIHZlcnNpb25pbmcnLCBwcm9jLnBtMl9lbnYubmFtZSk7XHJcbiAgICAgICAgcmV0dXJuIGNiKCk7XHJcbiAgICAgIH0pO1xyXG4gIH07XHJcblxyXG4gIHZhciB0YXNrcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGlmIChHb2QuV29ya2VyLmlzX3J1bm5pbmcgPT09IHRydWUpIHtcclxuICAgICAgZGVidWcoJ1tQTTJdW1dPUktFUl0gV29ya2VyIGlzIGFscmVhZHkgcnVubmluZywgc2tpcHBpbmcgdGhpcyByb3VuZCcpO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBHb2QuV29ya2VyLmlzX3J1bm5pbmcgPSB0cnVlO1xyXG5cclxuICAgIEdvZC5nZXRNb25pdG9yRGF0YShudWxsLCBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7XHJcbiAgICAgIGlmIChlcnIgfHwgIWRhdGEgfHwgdHlwZW9mIChkYXRhKSAhPT0gJ29iamVjdCcpIHtcclxuICAgICAgICBHb2QuV29ya2VyLmlzX3J1bm5pbmcgPSBmYWxzZTtcclxuICAgICAgICByZXR1cm4gY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBlYWNoTGltaXQoZGF0YSwgMSwgZnVuY3Rpb24gKHByb2MsIG5leHQpIHtcclxuICAgICAgICBpZiAoIXByb2MgfHwgIXByb2MucG0yX2VudiB8fCBwcm9jLnBtMl9lbnYucG1faWQgPT09IHVuZGVmaW5lZClcclxuICAgICAgICAgIHJldHVybiBuZXh0KCk7XHJcblxyXG4gICAgICAgIGRlYnVnKCdbUE0yXVtXT1JLRVJdIFByb2Nlc3NpbmcgcHJvYyBpZDonLCBwcm9jLnBtMl9lbnYucG1faWQpO1xyXG5cclxuICAgICAgICAvLyBSZXNldCByZXN0YXJ0IGRlbGF5IGlmIGFwcGxpY2F0aW9uIGhhcyBhbiB1cHRpbWUgb2YgbW9yZSA+IDMwc2Vjc1xyXG4gICAgICAgIGlmIChwcm9jLnBtMl9lbnYuZXhwX2JhY2tvZmZfcmVzdGFydF9kZWxheSAhPT0gdW5kZWZpbmVkICYmXHJcbiAgICAgICAgICBwcm9jLnBtMl9lbnYucHJldl9yZXN0YXJ0X2RlbGF5ICYmIHByb2MucG0yX2Vudi5wcmV2X3Jlc3RhcnRfZGVsYXkgPiAwKSB7XHJcbiAgICAgICAgICB2YXIgYXBwX3VwdGltZSA9IERhdGUubm93KCkgLSBwcm9jLnBtMl9lbnYucG1fdXB0aW1lXHJcbiAgICAgICAgICBpZiAoYXBwX3VwdGltZSA+IGNzdC5FWFBfQkFDS09GRl9SRVNFVF9USU1FUikge1xyXG4gICAgICAgICAgICB2YXIgcmVmX3Byb2MgPSBfZ2V0UHJvY2Vzc0J5SWQocHJvYy5wbTJfZW52LnBtX2lkKTtcclxuICAgICAgICAgICAgcmVmX3Byb2MucG0yX2Vudi5wcmV2X3Jlc3RhcnRfZGVsYXkgPSAwXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbUE0yXVtXT1JLRVJdIFJlc2V0IHRoZSByZXN0YXJ0IGRlbGF5LCBhcyBhcHAgJHtwcm9jLm5hbWV9IGhhcyBiZWVuIHVwIGZvciBtb3JlIHRoYW4gJHtjc3QuRVhQX0JBQ0tPRkZfUkVTRVRfVElNRVJ9bXNgKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgYXBwbGljYXRpb24gaGFzIHJlYWNoZWQgbWVtb3J5IHRocmVzaG9sZFxyXG4gICAgICAgIG1heE1lbW9yeVJlc3RhcnQocHJvYywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgcmV0dXJuIG5leHQoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSwgZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgIEdvZC5Xb3JrZXIuaXNfcnVubmluZyA9IGZhbHNlO1xyXG4gICAgICAgIGRlYnVnKCdbUE0yXVtXT1JLRVJdIE15IGpvYiBoZXJlIGlzIGRvbmUsIG5leHQgam9iIGluICVkIHNlY29uZHMnLCBwYXJzZUludCgoY3N0LldPUktFUl9JTlRFUlZBTCAvIDEwMDApICsgXCJcIikpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG4gIHZhciB3cmFwcGVkVGFza3MgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZCA9IGRvbWFpbi5jcmVhdGUoKTtcclxuXHJcbiAgICBkLm9uY2UoJ2Vycm9yJywgZnVuY3Rpb24gKGVycikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdbUE0yXVtXT1JLRVJdIEVycm9yIGNhdWdodCBieSBkb21haW46XFxuJyArIChlcnIuc3RhY2sgfHwgZXJyKSk7XHJcbiAgICAgIEdvZC5Xb3JrZXIuaXNfcnVubmluZyA9IGZhbHNlO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZC5ydW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICB0YXNrcygpO1xyXG4gICAgfSk7XHJcbiAgfTtcclxuXHJcblxyXG4gIEdvZC5Xb3JrZXIuc3RhcnQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB0aW1lciA9IHNldEludGVydmFsKHdyYXBwZWRUYXNrcywgY3N0LldPUktFUl9JTlRFUlZBTCk7XHJcblxyXG4gICAgc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICB2Q2hlY2soe1xyXG4gICAgICAgIHN0YXRlOiAnY2hlY2snLFxyXG4gICAgICAgIHZlcnNpb246IHBrZy52ZXJzaW9uXHJcbiAgICAgIH0pXHJcbiAgICB9LCAxMDAwICogNjAgKiA2MCAqIDI0KVxyXG4gIH07XHJcblxyXG4gIEdvZC5Xb3JrZXIuc3RvcCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGlmICh0aW1lciAhPT0gbnVsbClcclxuICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcik7XHJcbiAgfTtcclxufTtcclxuIl19
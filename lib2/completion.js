"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.log = exports.parseTasks = exports.parseOut = exports.isComplete = exports.complete = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
//  hacked from node-tabtab 0.0.4 https://github.com/mklabs/node-tabtab.git
//  Itself based on npm completion by @isaac
var complete = function complete(name, completer, cb) {
  // cb not there, assume callback is completer and
  // the completer is the executable itself
  if (!cb) {
    cb = completer;
    completer = name;
  }

  var env = parseEnv(); // if not a complete command, return here.

  if (!env.complete) return cb(); // if install cmd, add complete script to either ~/.bashrc or ~/.zshrc

  if (env.install) return install(name, completer, function (err, state) {
    console.log(state || err.message);
    if (err) return cb(err);
    cb(null, null, state);
  }); // if install cmd, add complete script to either ~/.bashrc or ~/.zshrc

  if (env.uninstall) return uninstall(name, completer, function (err, state) {
    console.log(state || err.message);
    if (err) return cb(err);
    cb(null, null, state);
  }); // if the COMP_* are not in the env, then dump the install script.

  if (!env.words || !env.point || !env.line) return script(name, completer, function (err, content) {
    if (err) return cb(err);
    process.stdout.write(content, function (n) {
      cb(null, null, content);
    });
    process.stdout.on("error", function (er) {
      // Darwin is a real dick sometimes.
      //
      // This is necessary because the "source" or "." program in
      // bash on OS X closes its file argument before reading
      // from it, meaning that you get exactly 1 write, which will
      // work most of the time, and will always raise an EPIPE.
      //
      // Really, one should not be tossing away EPIPE errors, or any
      // errors, so casually.  But, without this, `. <(npm completion)`
      // can never ever work on OS X.
      //      -- isaacs
      // https://github.com/isaacs/npm/blob/master/lib/completion.js#L162
      if (er.errno === "EPIPE") er = null;
      cb(er, null, content);
    });
    cb(null, null, content);
  });
  var partial = env.line.substr(0, env.point),
      last = env.line.split(' ').slice(-1).join(''),
      lastPartial = partial.split(' ').slice(-1).join(''),
      prev = env.line.split(' ').slice(0, -1).slice(-1)[0];
  cb(null, {
    line: env.line,
    words: env.words,
    point: env.point,
    partial: partial,
    last: last,
    prev: prev,
    lastPartial: lastPartial
  });
}; // simple helper function to know if the script is run
// in the context of a completion command. Also mapping the
// special `<pkgname> completion` cmd.


exports.complete = complete;

var isComplete = function isComplete() {
  var env = parseEnv();
  return env.complete || env.words && env.point && env.line;
};

exports.isComplete = isComplete;

var parseOut = function parseOut(str) {
  var shorts = str.match(/\s-\w+/g);
  var longs = str.match(/\s--\w+/g);
  return {
    shorts: shorts.map(trim).map(cleanPrefix),
    longs: longs.map(trim).map(cleanPrefix)
  };
}; // specific to cake case


exports.parseOut = parseOut;

var parseTasks = function parseTasks(str, prefix, reg) {
  var tasks = str.match(reg || new RegExp('^' + prefix + '\\s[^#]+', 'gm')) || [];
  return tasks.map(trim).map(function (s) {
    return s.replace(prefix + ' ', '');
  });
};

exports.parseTasks = parseTasks;

var log = function log(arr, o, prefix) {
  prefix = prefix || '';
  arr = Array.isArray(arr) ? arr : [arr];
  arr.filter(abbrev(o)).forEach(function (v) {
    console.log(prefix + v);
  });
};

exports.log = log;

function trim(s) {
  return s.trim();
}

function cleanPrefix(s) {
  return s.replace(/-/g, '');
}

function abbrev(o) {
  return function (it) {
    return new RegExp('^' + o.last.replace(/^--?/g, '')).test(it);
  };
} // output the completion.sh script to the console for install instructions.
// This is actually a 'template' where the package name is used to setup
// the completion on the right command, and properly name the bash/zsh functions.


function script(name, completer, cb) {
  var p = _path["default"].join(__dirname, 'completion.sh');

  _fs["default"].readFile(p, 'utf8', function (er, d) {
    if (er) return cb(er);
    cb(null, d);
  });
}

function install(name, completer, cb) {
  var markerIn = '###-begin-' + name + '-completion-###',
      markerOut = '###-end-' + name + '-completion-###';
  var rc, scriptOutput;
  readRc(completer, function (err, file) {
    if (err) return cb(err);
    var part = file.split(markerIn)[1];

    if (part) {
      return cb(null, ' ✗ ' + completer + ' tab-completion has been already installed. Do nothing.');
    }

    rc = file;
    next();
  });
  script(name, completer, function (err, file) {
    scriptOutput = file;
    next();
  });

  function next() {
    if (!rc || !scriptOutput) return;
    writeRc(rc + scriptOutput, function (err) {
      if (err) return cb(err);
      return cb(null, ' ✓ ' + completer + ' tab-completion installed.');
    });
  }
}

function uninstall(name, completer, cb) {
  var markerIn = '\n\n###-begin-' + name + '-completion-###',
      markerOut = '###-end-' + name + '-completion-###\n';
  readRc(completer, function (err, file) {
    if (err) return cb(err);
    var part = file.split(markerIn)[1];

    if (!part) {
      return cb(null, ' ✗ ' + completer + ' tab-completion has been already uninstalled. Do nothing.');
    }

    part = markerIn + part.split(markerOut)[0] + markerOut;
    writeRc(file.replace(part, ''), function (err) {
      if (err) return cb(err);
      return cb(null, ' ✓ ' + completer + ' tab-completion uninstalled.');
    });
  });
}

function readRc(completer, cb) {
  var file = '.' + process.env.SHELL.match(/\/bin\/(\w+)/)[1] + 'rc',
      filepath = _path["default"].join(process.env.HOME, file);

  _fs["default"].lstat(filepath, function (err, stats) {
    if (err) return cb(new Error("No " + file + " file. You'll have to run instead: " + completer + " completion >> ~/" + file));

    _fs["default"].readFile(filepath, 'utf8', cb);
  });
}

function writeRc(content, cb) {
  var file = '.' + process.env.SHELL.match(/\/bin\/(\w+)/)[1] + 'rc',
      filepath = _path["default"].join(process.env.HOME, file);

  _fs["default"].lstat(filepath, function (err, stats) {
    if (err) return cb(new Error("No " + file + " file. You'll have to run instead: " + content + " completion >> ~/" + file));

    _fs["default"].writeFile(filepath, content, cb);
  });
}

function installed(marker, completer, cb) {
  readRc(completer, function (err, file) {
    if (err) return cb(err);
    var installed = file.match(marker);
    return cb(!!installed);
  });
}

function parseEnv() {
  var args = process.argv.slice(2),
      complete = args[0] === 'completion';
  return {
    args: args,
    complete: complete,
    install: complete && args[1] === 'install',
    uninstall: complete && args[1] === 'uninstall',
    words: +process.env.COMP_CWORD,
    point: +process.env.COMP_POINT,
    line: process.env.COMP_LINE
  };
}

;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21wbGV0aW9uLnRzIl0sIm5hbWVzIjpbImNvbXBsZXRlIiwibmFtZSIsImNvbXBsZXRlciIsImNiIiwiZW52IiwicGFyc2VFbnYiLCJpbnN0YWxsIiwiZXJyIiwic3RhdGUiLCJjb25zb2xlIiwibG9nIiwibWVzc2FnZSIsInVuaW5zdGFsbCIsIndvcmRzIiwicG9pbnQiLCJsaW5lIiwic2NyaXB0IiwiY29udGVudCIsInByb2Nlc3MiLCJzdGRvdXQiLCJ3cml0ZSIsIm4iLCJvbiIsImVyIiwiZXJybm8iLCJwYXJ0aWFsIiwic3Vic3RyIiwibGFzdCIsInNwbGl0Iiwic2xpY2UiLCJqb2luIiwibGFzdFBhcnRpYWwiLCJwcmV2IiwiaXNDb21wbGV0ZSIsInBhcnNlT3V0Iiwic3RyIiwic2hvcnRzIiwibWF0Y2giLCJsb25ncyIsIm1hcCIsInRyaW0iLCJjbGVhblByZWZpeCIsInBhcnNlVGFza3MiLCJwcmVmaXgiLCJyZWciLCJ0YXNrcyIsIlJlZ0V4cCIsInMiLCJyZXBsYWNlIiwiYXJyIiwibyIsIkFycmF5IiwiaXNBcnJheSIsImZpbHRlciIsImFiYnJldiIsImZvckVhY2giLCJ2IiwiaXQiLCJ0ZXN0IiwicCIsInB0aCIsIl9fZGlybmFtZSIsImZzIiwicmVhZEZpbGUiLCJkIiwibWFya2VySW4iLCJtYXJrZXJPdXQiLCJyYyIsInNjcmlwdE91dHB1dCIsInJlYWRSYyIsImZpbGUiLCJwYXJ0IiwibmV4dCIsIndyaXRlUmMiLCJTSEVMTCIsImZpbGVwYXRoIiwiSE9NRSIsImxzdGF0Iiwic3RhdHMiLCJFcnJvciIsIndyaXRlRmlsZSIsImluc3RhbGxlZCIsIm1hcmtlciIsImFyZ3MiLCJhcmd2IiwiQ09NUF9DV09SRCIsIkNPTVBfUE9JTlQiLCJDT01QX0xJTkUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUtBOztBQUNBOztBQU5BOzs7OztBQVFBO0FBQ0E7QUFFTyxJQUFNQSxRQUFRLEdBQUcsU0FBU0EsUUFBVCxDQUFrQkMsSUFBbEIsRUFBd0JDLFNBQXhCLEVBQW1DQyxFQUFuQyxFQUF3QztBQUU5RDtBQUNBO0FBQ0EsTUFBRyxDQUFDQSxFQUFKLEVBQVE7QUFDTkEsSUFBQUEsRUFBRSxHQUFHRCxTQUFMO0FBQ0FBLElBQUFBLFNBQVMsR0FBR0QsSUFBWjtBQUNEOztBQUVELE1BQUlHLEdBQUcsR0FBR0MsUUFBUSxFQUFsQixDQVQ4RCxDQVc5RDs7QUFDQSxNQUFHLENBQUNELEdBQUcsQ0FBQ0osUUFBUixFQUFrQixPQUFPRyxFQUFFLEVBQVQsQ0FaNEMsQ0FjOUQ7O0FBQ0EsTUFBR0MsR0FBRyxDQUFDRSxPQUFQLEVBQWdCLE9BQU9BLE9BQU8sQ0FBQ0wsSUFBRCxFQUFPQyxTQUFQLEVBQWtCLFVBQVNLLEdBQVQsRUFBY0MsS0FBZCxFQUFxQjtBQUNuRUMsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlGLEtBQUssSUFBSUQsR0FBRyxDQUFDSSxPQUF6QjtBQUNBLFFBQUdKLEdBQUgsRUFBUSxPQUFPSixFQUFFLENBQUNJLEdBQUQsQ0FBVDtBQUNSSixJQUFBQSxFQUFFLENBQUMsSUFBRCxFQUFPLElBQVAsRUFBYUssS0FBYixDQUFGO0FBQ0QsR0FKNkIsQ0FBZCxDQWY4QyxDQXFCOUQ7O0FBQ0EsTUFBR0osR0FBRyxDQUFDUSxTQUFQLEVBQWtCLE9BQU9BLFNBQVMsQ0FBQ1gsSUFBRCxFQUFPQyxTQUFQLEVBQWtCLFVBQVNLLEdBQVQsRUFBY0MsS0FBZCxFQUFxQjtBQUN2RUMsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlGLEtBQUssSUFBSUQsR0FBRyxDQUFDSSxPQUF6QjtBQUNBLFFBQUdKLEdBQUgsRUFBUSxPQUFPSixFQUFFLENBQUNJLEdBQUQsQ0FBVDtBQUNSSixJQUFBQSxFQUFFLENBQUMsSUFBRCxFQUFPLElBQVAsRUFBYUssS0FBYixDQUFGO0FBQ0QsR0FKaUMsQ0FBaEIsQ0F0QjRDLENBNEI5RDs7QUFDQSxNQUFHLENBQUNKLEdBQUcsQ0FBQ1MsS0FBTCxJQUFjLENBQUNULEdBQUcsQ0FBQ1UsS0FBbkIsSUFBNEIsQ0FBQ1YsR0FBRyxDQUFDVyxJQUFwQyxFQUEwQyxPQUFPQyxNQUFNLENBQUNmLElBQUQsRUFBT0MsU0FBUCxFQUFrQixVQUFTSyxHQUFULEVBQWNVLE9BQWQsRUFBdUI7QUFDOUYsUUFBR1YsR0FBSCxFQUFRLE9BQU9KLEVBQUUsQ0FBQ0ksR0FBRCxDQUFUO0FBQ1JXLElBQUFBLE9BQU8sQ0FBQ0MsTUFBUixDQUFlQyxLQUFmLENBQXFCSCxPQUFyQixFQUE4QixVQUFVSSxDQUFWLEVBQWE7QUFBRWxCLE1BQUFBLEVBQUUsQ0FBQyxJQUFELEVBQU8sSUFBUCxFQUFhYyxPQUFiLENBQUY7QUFBMEIsS0FBdkU7QUFDQUMsSUFBQUEsT0FBTyxDQUFDQyxNQUFSLENBQWVHLEVBQWYsQ0FBa0IsT0FBbEIsRUFBMkIsVUFBVUMsRUFBVixFQUFjO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQUlBLEVBQUUsQ0FBQ0MsS0FBSCxLQUFhLE9BQWpCLEVBQTBCRCxFQUFFLEdBQUcsSUFBTDtBQUMxQnBCLE1BQUFBLEVBQUUsQ0FBQ29CLEVBQUQsRUFBSyxJQUFMLEVBQVdOLE9BQVgsQ0FBRjtBQUNELEtBZkQ7QUFnQkFkLElBQUFBLEVBQUUsQ0FBQyxJQUFELEVBQU8sSUFBUCxFQUFhYyxPQUFiLENBQUY7QUFDRCxHQXBCc0QsQ0FBYjtBQXNCMUMsTUFBSVEsT0FBTyxHQUFHckIsR0FBRyxDQUFDVyxJQUFKLENBQVNXLE1BQVQsQ0FBZ0IsQ0FBaEIsRUFBbUJ0QixHQUFHLENBQUNVLEtBQXZCLENBQWQ7QUFBQSxNQUNBYSxJQUFJLEdBQUd2QixHQUFHLENBQUNXLElBQUosQ0FBU2EsS0FBVCxDQUFlLEdBQWYsRUFBb0JDLEtBQXBCLENBQTBCLENBQUMsQ0FBM0IsRUFBOEJDLElBQTlCLENBQW1DLEVBQW5DLENBRFA7QUFBQSxNQUVBQyxXQUFXLEdBQUdOLE9BQU8sQ0FBQ0csS0FBUixDQUFjLEdBQWQsRUFBbUJDLEtBQW5CLENBQXlCLENBQUMsQ0FBMUIsRUFBNkJDLElBQTdCLENBQWtDLEVBQWxDLENBRmQ7QUFBQSxNQUdBRSxJQUFJLEdBQUc1QixHQUFHLENBQUNXLElBQUosQ0FBU2EsS0FBVCxDQUFlLEdBQWYsRUFBb0JDLEtBQXBCLENBQTBCLENBQTFCLEVBQTZCLENBQUMsQ0FBOUIsRUFBaUNBLEtBQWpDLENBQXVDLENBQUMsQ0FBeEMsRUFBMkMsQ0FBM0MsQ0FIUDtBQUtBMUIsRUFBQUEsRUFBRSxDQUFDLElBQUQsRUFBTztBQUNQWSxJQUFBQSxJQUFJLEVBQUVYLEdBQUcsQ0FBQ1csSUFESDtBQUVQRixJQUFBQSxLQUFLLEVBQUVULEdBQUcsQ0FBQ1MsS0FGSjtBQUdQQyxJQUFBQSxLQUFLLEVBQUVWLEdBQUcsQ0FBQ1UsS0FISjtBQUlQVyxJQUFBQSxPQUFPLEVBQUVBLE9BSkY7QUFLUEUsSUFBQUEsSUFBSSxFQUFFQSxJQUxDO0FBTVBLLElBQUFBLElBQUksRUFBRUEsSUFOQztBQU9QRCxJQUFBQSxXQUFXLEVBQUVBO0FBUE4sR0FBUCxDQUFGO0FBU0QsQ0FqRU0sQyxDQW1FUDtBQUNBO0FBQ0E7Ozs7O0FBQ08sSUFBTUUsVUFBVSxHQUFHLFNBQVNBLFVBQVQsR0FBc0I7QUFDOUMsTUFBSTdCLEdBQUcsR0FBR0MsUUFBUSxFQUFsQjtBQUNBLFNBQU9ELEdBQUcsQ0FBQ0osUUFBSixJQUFpQkksR0FBRyxDQUFDUyxLQUFKLElBQWFULEdBQUcsQ0FBQ1UsS0FBakIsSUFBMEJWLEdBQUcsQ0FBQ1csSUFBdEQ7QUFDRCxDQUhNOzs7O0FBS0EsSUFBTW1CLFFBQVEsR0FBRyxTQUFTQSxRQUFULENBQWtCQyxHQUFsQixFQUF1QjtBQUM3QyxNQUFJQyxNQUFNLEdBQUdELEdBQUcsQ0FBQ0UsS0FBSixDQUFVLFNBQVYsQ0FBYjtBQUNBLE1BQUlDLEtBQUssR0FBR0gsR0FBRyxDQUFDRSxLQUFKLENBQVUsVUFBVixDQUFaO0FBRUEsU0FBTztBQUNMRCxJQUFBQSxNQUFNLEVBQUVBLE1BQU0sQ0FBQ0csR0FBUCxDQUFXQyxJQUFYLEVBQWlCRCxHQUFqQixDQUFxQkUsV0FBckIsQ0FESDtBQUVMSCxJQUFBQSxLQUFLLEVBQUVBLEtBQUssQ0FBQ0MsR0FBTixDQUFVQyxJQUFWLEVBQWdCRCxHQUFoQixDQUFvQkUsV0FBcEI7QUFGRixHQUFQO0FBSUQsQ0FSTSxDLENBVVA7Ozs7O0FBQ08sSUFBTUMsVUFBVSxHQUFHLFNBQWJBLFVBQWEsQ0FBU1AsR0FBVCxFQUFjUSxNQUFkLEVBQXNCQyxHQUF0QixFQUEyQjtBQUNuRCxNQUFJQyxLQUFLLEdBQUdWLEdBQUcsQ0FBQ0UsS0FBSixDQUFVTyxHQUFHLElBQUksSUFBSUUsTUFBSixDQUFXLE1BQU1ILE1BQU4sR0FBZSxVQUExQixFQUFzQyxJQUF0QyxDQUFqQixLQUFpRSxFQUE3RTtBQUNBLFNBQU9FLEtBQUssQ0FBQ04sR0FBTixDQUFVQyxJQUFWLEVBQWdCRCxHQUFoQixDQUFvQixVQUFTUSxDQUFULEVBQVk7QUFDckMsV0FBT0EsQ0FBQyxDQUFDQyxPQUFGLENBQVVMLE1BQU0sR0FBRyxHQUFuQixFQUF3QixFQUF4QixDQUFQO0FBQ0QsR0FGTSxDQUFQO0FBR0QsQ0FMTTs7OztBQU9BLElBQU1qQyxHQUFHLEdBQUcsU0FBU0EsR0FBVCxDQUFhdUMsR0FBYixFQUFrQkMsQ0FBbEIsRUFBcUJQLE1BQXJCLEVBQThCO0FBQy9DQSxFQUFBQSxNQUFNLEdBQUdBLE1BQU0sSUFBSSxFQUFuQjtBQUNBTSxFQUFBQSxHQUFHLEdBQUdFLEtBQUssQ0FBQ0MsT0FBTixDQUFjSCxHQUFkLElBQXFCQSxHQUFyQixHQUEyQixDQUFDQSxHQUFELENBQWpDO0FBQ0FBLEVBQUFBLEdBQUcsQ0FBQ0ksTUFBSixDQUFXQyxNQUFNLENBQUNKLENBQUQsQ0FBakIsRUFBc0JLLE9BQXRCLENBQThCLFVBQVNDLENBQVQsRUFBWTtBQUN4Qy9DLElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZaUMsTUFBTSxHQUFHYSxDQUFyQjtBQUNELEdBRkQ7QUFHRCxDQU5NOzs7O0FBUVAsU0FBU2hCLElBQVQsQ0FBZU8sQ0FBZixFQUFrQjtBQUNoQixTQUFPQSxDQUFDLENBQUNQLElBQUYsRUFBUDtBQUNEOztBQUVELFNBQVNDLFdBQVQsQ0FBcUJNLENBQXJCLEVBQXdCO0FBQ3RCLFNBQU9BLENBQUMsQ0FBQ0MsT0FBRixDQUFVLElBQVYsRUFBZ0IsRUFBaEIsQ0FBUDtBQUNEOztBQUVELFNBQVNNLE1BQVQsQ0FBZ0JKLENBQWhCLEVBQW1CO0FBQUUsU0FBTyxVQUFTTyxFQUFULEVBQWE7QUFDdkMsV0FBTyxJQUFJWCxNQUFKLENBQVcsTUFBTUksQ0FBQyxDQUFDdkIsSUFBRixDQUFPcUIsT0FBUCxDQUFlLE9BQWYsRUFBd0IsRUFBeEIsQ0FBakIsRUFBOENVLElBQTlDLENBQW1ERCxFQUFuRCxDQUFQO0FBQ0QsR0FGb0I7QUFFbkIsQyxDQUVGO0FBQ0E7QUFDQTs7O0FBQ0EsU0FBU3pDLE1BQVQsQ0FBZ0JmLElBQWhCLEVBQXNCQyxTQUF0QixFQUFpQ0MsRUFBakMsRUFBcUM7QUFDbkMsTUFBSXdELENBQUMsR0FBR0MsaUJBQUk5QixJQUFKLENBQVMrQixTQUFULEVBQW9CLGVBQXBCLENBQVI7O0FBRUFDLGlCQUFHQyxRQUFILENBQVlKLENBQVosRUFBZSxNQUFmLEVBQXVCLFVBQVVwQyxFQUFWLEVBQWN5QyxDQUFkLEVBQWlCO0FBQ3RDLFFBQUl6QyxFQUFKLEVBQVEsT0FBT3BCLEVBQUUsQ0FBQ29CLEVBQUQsQ0FBVDtBQUNScEIsSUFBQUEsRUFBRSxDQUFDLElBQUQsRUFBTzZELENBQVAsQ0FBRjtBQUNELEdBSEQ7QUFJRDs7QUFFRCxTQUFTMUQsT0FBVCxDQUFpQkwsSUFBakIsRUFBdUJDLFNBQXZCLEVBQWtDQyxFQUFsQyxFQUFzQztBQUNwQyxNQUFJOEQsUUFBUSxHQUFHLGVBQWVoRSxJQUFmLEdBQXNCLGlCQUFyQztBQUFBLE1BQ0VpRSxTQUFTLEdBQUcsYUFBYWpFLElBQWIsR0FBb0IsaUJBRGxDO0FBR0EsTUFBSWtFLEVBQUosRUFBUUMsWUFBUjtBQUVBQyxFQUFBQSxNQUFNLENBQUNuRSxTQUFELEVBQVksVUFBU0ssR0FBVCxFQUFjK0QsSUFBZCxFQUFvQjtBQUNwQyxRQUFHL0QsR0FBSCxFQUFRLE9BQU9KLEVBQUUsQ0FBQ0ksR0FBRCxDQUFUO0FBRVIsUUFBSWdFLElBQUksR0FBR0QsSUFBSSxDQUFDMUMsS0FBTCxDQUFXcUMsUUFBWCxFQUFxQixDQUFyQixDQUFYOztBQUNBLFFBQUdNLElBQUgsRUFBUztBQUNQLGFBQU9wRSxFQUFFLENBQUMsSUFBRCxFQUFPLFFBQVFELFNBQVIsR0FBb0IseURBQTNCLENBQVQ7QUFDRDs7QUFFRGlFLElBQUFBLEVBQUUsR0FBR0csSUFBTDtBQUNBRSxJQUFBQSxJQUFJO0FBQ0wsR0FWSyxDQUFOO0FBWUF4RCxFQUFBQSxNQUFNLENBQUNmLElBQUQsRUFBT0MsU0FBUCxFQUFrQixVQUFTSyxHQUFULEVBQWMrRCxJQUFkLEVBQW9CO0FBQzFDRixJQUFBQSxZQUFZLEdBQUdFLElBQWY7QUFDQUUsSUFBQUEsSUFBSTtBQUNMLEdBSEssQ0FBTjs7QUFLQSxXQUFTQSxJQUFULEdBQWdCO0FBQ2QsUUFBRyxDQUFDTCxFQUFELElBQU8sQ0FBQ0MsWUFBWCxFQUF5QjtBQUV6QkssSUFBQUEsT0FBTyxDQUFDTixFQUFFLEdBQUdDLFlBQU4sRUFBb0IsVUFBUzdELEdBQVQsRUFBYztBQUN2QyxVQUFHQSxHQUFILEVBQVEsT0FBT0osRUFBRSxDQUFDSSxHQUFELENBQVQ7QUFDUixhQUFPSixFQUFFLENBQUMsSUFBRCxFQUFPLFFBQVFELFNBQVIsR0FBb0IsNEJBQTNCLENBQVQ7QUFDRCxLQUhNLENBQVA7QUFJRDtBQUNGOztBQUVELFNBQVNVLFNBQVQsQ0FBbUJYLElBQW5CLEVBQXlCQyxTQUF6QixFQUFvQ0MsRUFBcEMsRUFBd0M7QUFDdEMsTUFBSThELFFBQVEsR0FBRyxtQkFBbUJoRSxJQUFuQixHQUEwQixpQkFBekM7QUFBQSxNQUNFaUUsU0FBUyxHQUFHLGFBQWFqRSxJQUFiLEdBQW9CLG1CQURsQztBQUdBb0UsRUFBQUEsTUFBTSxDQUFDbkUsU0FBRCxFQUFZLFVBQVNLLEdBQVQsRUFBYytELElBQWQsRUFBb0I7QUFDcEMsUUFBRy9ELEdBQUgsRUFBUSxPQUFPSixFQUFFLENBQUNJLEdBQUQsQ0FBVDtBQUVSLFFBQUlnRSxJQUFJLEdBQUdELElBQUksQ0FBQzFDLEtBQUwsQ0FBV3FDLFFBQVgsRUFBcUIsQ0FBckIsQ0FBWDs7QUFDQSxRQUFHLENBQUNNLElBQUosRUFBVTtBQUNSLGFBQU9wRSxFQUFFLENBQUMsSUFBRCxFQUFPLFFBQVFELFNBQVIsR0FBb0IsMkRBQTNCLENBQVQ7QUFDRDs7QUFFRHFFLElBQUFBLElBQUksR0FBR04sUUFBUSxHQUFHTSxJQUFJLENBQUMzQyxLQUFMLENBQVdzQyxTQUFYLEVBQXNCLENBQXRCLENBQVgsR0FBc0NBLFNBQTdDO0FBQ0FPLElBQUFBLE9BQU8sQ0FBQ0gsSUFBSSxDQUFDdEIsT0FBTCxDQUFhdUIsSUFBYixFQUFtQixFQUFuQixDQUFELEVBQXlCLFVBQVNoRSxHQUFULEVBQWM7QUFDNUMsVUFBR0EsR0FBSCxFQUFRLE9BQU9KLEVBQUUsQ0FBQ0ksR0FBRCxDQUFUO0FBQ1IsYUFBT0osRUFBRSxDQUFDLElBQUQsRUFBTyxRQUFRRCxTQUFSLEdBQW9CLDhCQUEzQixDQUFUO0FBQ0QsS0FITSxDQUFQO0FBSUQsR0FiSyxDQUFOO0FBY0Q7O0FBRUQsU0FBU21FLE1BQVQsQ0FBZ0JuRSxTQUFoQixFQUEyQkMsRUFBM0IsRUFBK0I7QUFDN0IsTUFBSW1FLElBQUksR0FBRyxNQUFNcEQsT0FBTyxDQUFDZCxHQUFSLENBQVlzRSxLQUFaLENBQWtCckMsS0FBbEIsQ0FBd0IsY0FBeEIsRUFBd0MsQ0FBeEMsQ0FBTixHQUFtRCxJQUE5RDtBQUFBLE1BQ0FzQyxRQUFRLEdBQUdmLGlCQUFJOUIsSUFBSixDQUFTWixPQUFPLENBQUNkLEdBQVIsQ0FBWXdFLElBQXJCLEVBQTJCTixJQUEzQixDQURYOztBQUVBUixpQkFBR2UsS0FBSCxDQUFTRixRQUFULEVBQW1CLFVBQVVwRSxHQUFWLEVBQWV1RSxLQUFmLEVBQXNCO0FBQ3ZDLFFBQUd2RSxHQUFILEVBQVEsT0FBT0osRUFBRSxDQUFDLElBQUk0RSxLQUFKLENBQVUsUUFBUVQsSUFBUixHQUFlLHFDQUFmLEdBQXVEcEUsU0FBdkQsR0FBbUUsbUJBQW5FLEdBQXlGb0UsSUFBbkcsQ0FBRCxDQUFUOztBQUNSUixtQkFBR0MsUUFBSCxDQUFZWSxRQUFaLEVBQXNCLE1BQXRCLEVBQThCeEUsRUFBOUI7QUFDRCxHQUhEO0FBSUQ7O0FBRUQsU0FBU3NFLE9BQVQsQ0FBaUJ4RCxPQUFqQixFQUEwQmQsRUFBMUIsRUFBOEI7QUFDNUIsTUFBSW1FLElBQUksR0FBRyxNQUFNcEQsT0FBTyxDQUFDZCxHQUFSLENBQVlzRSxLQUFaLENBQWtCckMsS0FBbEIsQ0FBd0IsY0FBeEIsRUFBd0MsQ0FBeEMsQ0FBTixHQUFtRCxJQUE5RDtBQUFBLE1BQ0FzQyxRQUFRLEdBQUdmLGlCQUFJOUIsSUFBSixDQUFTWixPQUFPLENBQUNkLEdBQVIsQ0FBWXdFLElBQXJCLEVBQTJCTixJQUEzQixDQURYOztBQUVBUixpQkFBR2UsS0FBSCxDQUFTRixRQUFULEVBQW1CLFVBQVVwRSxHQUFWLEVBQWV1RSxLQUFmLEVBQXNCO0FBQ3ZDLFFBQUd2RSxHQUFILEVBQVEsT0FBT0osRUFBRSxDQUFDLElBQUk0RSxLQUFKLENBQVUsUUFBUVQsSUFBUixHQUFlLHFDQUFmLEdBQXVEckQsT0FBdkQsR0FBaUUsbUJBQWpFLEdBQXVGcUQsSUFBakcsQ0FBRCxDQUFUOztBQUNSUixtQkFBR2tCLFNBQUgsQ0FBYUwsUUFBYixFQUF1QjFELE9BQXZCLEVBQWdDZCxFQUFoQztBQUNELEdBSEQ7QUFJRDs7QUFFRCxTQUFTOEUsU0FBVCxDQUFvQkMsTUFBcEIsRUFBNEJoRixTQUE1QixFQUF1Q0MsRUFBdkMsRUFBMkM7QUFDekNrRSxFQUFBQSxNQUFNLENBQUNuRSxTQUFELEVBQVksVUFBU0ssR0FBVCxFQUFjK0QsSUFBZCxFQUFvQjtBQUNwQyxRQUFHL0QsR0FBSCxFQUFRLE9BQU9KLEVBQUUsQ0FBQ0ksR0FBRCxDQUFUO0FBQ1IsUUFBSTBFLFNBQVMsR0FBR1gsSUFBSSxDQUFDakMsS0FBTCxDQUFXNkMsTUFBWCxDQUFoQjtBQUNBLFdBQU8vRSxFQUFFLENBQUMsQ0FBQyxDQUFDOEUsU0FBSCxDQUFUO0FBQ0QsR0FKSyxDQUFOO0FBS0Q7O0FBRUQsU0FBUzVFLFFBQVQsR0FBb0I7QUFDbEIsTUFBSThFLElBQUksR0FBR2pFLE9BQU8sQ0FBQ2tFLElBQVIsQ0FBYXZELEtBQWIsQ0FBbUIsQ0FBbkIsQ0FBWDtBQUFBLE1BQ0E3QixRQUFRLEdBQUdtRixJQUFJLENBQUMsQ0FBRCxDQUFKLEtBQVksWUFEdkI7QUFHQSxTQUFPO0FBQ0xBLElBQUFBLElBQUksRUFBRUEsSUFERDtBQUVMbkYsSUFBQUEsUUFBUSxFQUFFQSxRQUZMO0FBR0xNLElBQUFBLE9BQU8sRUFBRU4sUUFBUSxJQUFJbUYsSUFBSSxDQUFDLENBQUQsQ0FBSixLQUFZLFNBSDVCO0FBSUx2RSxJQUFBQSxTQUFTLEVBQUVaLFFBQVEsSUFBSW1GLElBQUksQ0FBQyxDQUFELENBQUosS0FBWSxXQUo5QjtBQUtMdEUsSUFBQUEsS0FBSyxFQUFFLENBQUNLLE9BQU8sQ0FBQ2QsR0FBUixDQUFZaUYsVUFMZjtBQU1MdkUsSUFBQUEsS0FBSyxFQUFFLENBQUNJLE9BQU8sQ0FBQ2QsR0FBUixDQUFZa0YsVUFOZjtBQU9MdkUsSUFBQUEsSUFBSSxFQUFFRyxPQUFPLENBQUNkLEdBQVIsQ0FBWW1GO0FBUGIsR0FBUDtBQVNEOztBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgMjAxMyB0aGUgUE0yIHByb2plY3QgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgbGljZW5zZSB0aGF0XG4gKiBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS5cbiAqL1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwdGggZnJvbSAncGF0aCc7XG5cbi8vICBoYWNrZWQgZnJvbSBub2RlLXRhYnRhYiAwLjAuNCBodHRwczovL2dpdGh1Yi5jb20vbWtsYWJzL25vZGUtdGFidGFiLmdpdFxuLy8gIEl0c2VsZiBiYXNlZCBvbiBucG0gY29tcGxldGlvbiBieSBAaXNhYWNcblxuZXhwb3J0IGNvbnN0IGNvbXBsZXRlID0gZnVuY3Rpb24gY29tcGxldGUobmFtZSwgY29tcGxldGVyLCBjYj8pIHtcblxuICAvLyBjYiBub3QgdGhlcmUsIGFzc3VtZSBjYWxsYmFjayBpcyBjb21wbGV0ZXIgYW5kXG4gIC8vIHRoZSBjb21wbGV0ZXIgaXMgdGhlIGV4ZWN1dGFibGUgaXRzZWxmXG4gIGlmKCFjYikge1xuICAgIGNiID0gY29tcGxldGVyO1xuICAgIGNvbXBsZXRlciA9IG5hbWU7XG4gIH1cblxuICB2YXIgZW52ID0gcGFyc2VFbnYoKTtcblxuICAvLyBpZiBub3QgYSBjb21wbGV0ZSBjb21tYW5kLCByZXR1cm4gaGVyZS5cbiAgaWYoIWVudi5jb21wbGV0ZSkgcmV0dXJuIGNiKCk7XG5cbiAgLy8gaWYgaW5zdGFsbCBjbWQsIGFkZCBjb21wbGV0ZSBzY3JpcHQgdG8gZWl0aGVyIH4vLmJhc2hyYyBvciB+Ly56c2hyY1xuICBpZihlbnYuaW5zdGFsbCkgcmV0dXJuIGluc3RhbGwobmFtZSwgY29tcGxldGVyLCBmdW5jdGlvbihlcnIsIHN0YXRlKcKge1xuICAgIGNvbnNvbGUubG9nKHN0YXRlIHx8IGVyci5tZXNzYWdlKTtcbiAgICBpZihlcnIpIHJldHVybiBjYihlcnIpO1xuICAgIGNiKG51bGwsIG51bGwsIHN0YXRlKTtcbiAgfSk7XG5cbiAgLy8gaWYgaW5zdGFsbCBjbWQsIGFkZCBjb21wbGV0ZSBzY3JpcHQgdG8gZWl0aGVyIH4vLmJhc2hyYyBvciB+Ly56c2hyY1xuICBpZihlbnYudW5pbnN0YWxsKSByZXR1cm4gdW5pbnN0YWxsKG5hbWUsIGNvbXBsZXRlciwgZnVuY3Rpb24oZXJyLCBzdGF0ZSkge1xuICAgIGNvbnNvbGUubG9nKHN0YXRlIHx8IGVyci5tZXNzYWdlKTtcbiAgICBpZihlcnIpIHJldHVybiBjYihlcnIpO1xuICAgIGNiKG51bGwsIG51bGwsIHN0YXRlKTtcbiAgfSk7XG5cbiAgLy8gaWYgdGhlIENPTVBfKiBhcmUgbm90IGluIHRoZSBlbnYsIHRoZW4gZHVtcCB0aGUgaW5zdGFsbCBzY3JpcHQuXG4gIGlmKCFlbnYud29yZHMgfHwgIWVudi5wb2ludCB8fCAhZW52LmxpbmUpIHJldHVybiBzY3JpcHQobmFtZSwgY29tcGxldGVyLCBmdW5jdGlvbihlcnIsIGNvbnRlbnQpIHtcbiAgICBpZihlcnIpIHJldHVybiBjYihlcnIpO1xuICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGNvbnRlbnQsIGZ1bmN0aW9uIChuKSB7IGNiKG51bGwsIG51bGwsIGNvbnRlbnQpOyB9KTtcbiAgICBwcm9jZXNzLnN0ZG91dC5vbihcImVycm9yXCIsIGZ1bmN0aW9uIChlcikge1xuICAgICAgLy8gRGFyd2luIGlzIGEgcmVhbCBkaWNrIHNvbWV0aW1lcy5cbiAgICAgIC8vXG4gICAgICAvLyBUaGlzIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIHRoZSBcInNvdXJjZVwiIG9yIFwiLlwiIHByb2dyYW0gaW5cbiAgICAgIC8vIGJhc2ggb24gT1MgWCBjbG9zZXMgaXRzIGZpbGUgYXJndW1lbnQgYmVmb3JlIHJlYWRpbmdcbiAgICAgIC8vIGZyb20gaXQsIG1lYW5pbmcgdGhhdCB5b3UgZ2V0IGV4YWN0bHkgMSB3cml0ZSwgd2hpY2ggd2lsbFxuICAgICAgLy8gd29yayBtb3N0IG9mIHRoZSB0aW1lLCBhbmQgd2lsbCBhbHdheXMgcmFpc2UgYW4gRVBJUEUuXG4gICAgICAvL1xuICAgICAgLy8gUmVhbGx5LCBvbmUgc2hvdWxkIG5vdCBiZSB0b3NzaW5nIGF3YXkgRVBJUEUgZXJyb3JzLCBvciBhbnlcbiAgICAgIC8vIGVycm9ycywgc28gY2FzdWFsbHkuICBCdXQsIHdpdGhvdXQgdGhpcywgYC4gPChucG0gY29tcGxldGlvbilgXG4gICAgICAvLyBjYW4gbmV2ZXIgZXZlciB3b3JrIG9uIE9TIFguXG4gICAgICAvLyAgICAgIC0tIGlzYWFjc1xuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2lzYWFjcy9ucG0vYmxvYi9tYXN0ZXIvbGliL2NvbXBsZXRpb24uanMjTDE2MlxuICAgICAgaWYgKGVyLmVycm5vID09PSBcIkVQSVBFXCIpIGVyID0gbnVsbFxuICAgICAgY2IoZXIsIG51bGwsIGNvbnRlbnQpO1xuICAgIH0pO1xuICAgIGNiKG51bGwsIG51bGwsIGNvbnRlbnQpO1xuICB9KTtcblxuICB2YXIgcGFydGlhbCA9IGVudi5saW5lLnN1YnN0cigwLCBlbnYucG9pbnQpLFxuICBsYXN0ID0gZW52LmxpbmUuc3BsaXQoJyAnKS5zbGljZSgtMSkuam9pbignJyksXG4gIGxhc3RQYXJ0aWFsID0gcGFydGlhbC5zcGxpdCgnICcpLnNsaWNlKC0xKS5qb2luKCcnKSxcbiAgcHJldiA9IGVudi5saW5lLnNwbGl0KCcgJykuc2xpY2UoMCwgLTEpLnNsaWNlKC0xKVswXTtcblxuICBjYihudWxsLCB7XG4gICAgbGluZTogZW52LmxpbmUsXG4gICAgd29yZHM6IGVudi53b3JkcyxcbiAgICBwb2ludDogZW52LnBvaW50LFxuICAgIHBhcnRpYWw6IHBhcnRpYWwsXG4gICAgbGFzdDogbGFzdCxcbiAgICBwcmV2OiBwcmV2LFxuICAgIGxhc3RQYXJ0aWFsOiBsYXN0UGFydGlhbFxuICB9KTtcbn07XG5cbi8vIHNpbXBsZSBoZWxwZXIgZnVuY3Rpb24gdG8ga25vdyBpZiB0aGUgc2NyaXB0IGlzIHJ1blxuLy8gaW4gdGhlIGNvbnRleHQgb2YgYSBjb21wbGV0aW9uIGNvbW1hbmQuIEFsc28gbWFwcGluZyB0aGVcbi8vIHNwZWNpYWwgYDxwa2duYW1lPiBjb21wbGV0aW9uYCBjbWQuXG5leHBvcnQgY29uc3QgaXNDb21wbGV0ZSA9IGZ1bmN0aW9uIGlzQ29tcGxldGUoKSB7XG4gIHZhciBlbnYgPSBwYXJzZUVudigpO1xuICByZXR1cm4gZW52LmNvbXBsZXRlIHx8IChlbnYud29yZHMgJiYgZW52LnBvaW50ICYmIGVudi5saW5lKTtcbn07XG5cbmV4cG9ydCBjb25zdCBwYXJzZU91dCA9IGZ1bmN0aW9uIHBhcnNlT3V0KHN0cikge1xuICB2YXIgc2hvcnRzID0gc3RyLm1hdGNoKC9cXHMtXFx3Ky9nKTtcbiAgdmFyIGxvbmdzID0gc3RyLm1hdGNoKC9cXHMtLVxcdysvZyk7XG5cbiAgcmV0dXJuIHtcbiAgICBzaG9ydHM6IHNob3J0cy5tYXAodHJpbSkubWFwKGNsZWFuUHJlZml4KSxcbiAgICBsb25nczogbG9uZ3MubWFwKHRyaW0pLm1hcChjbGVhblByZWZpeClcbiAgfTtcbn07XG5cbi8vIHNwZWNpZmljIHRvIGNha2UgY2FzZVxuZXhwb3J0IGNvbnN0IHBhcnNlVGFza3MgPSBmdW5jdGlvbihzdHIsIHByZWZpeCwgcmVnKSB7XG4gIHZhciB0YXNrcyA9IHN0ci5tYXRjaChyZWcgfHwgbmV3IFJlZ0V4cCgnXicgKyBwcmVmaXggKyAnXFxcXHNbXiNdKycsICdnbScpKSB8fCBbXTtcbiAgcmV0dXJuIHRhc2tzLm1hcCh0cmltKS5tYXAoZnVuY3Rpb24ocykge1xuICAgIHJldHVybiBzLnJlcGxhY2UocHJlZml4ICsgJyAnLCAnJyk7XG4gIH0pO1xufTtcblxuZXhwb3J0IGNvbnN0IGxvZyA9IGZ1bmN0aW9uIGxvZyhhcnIsIG8sIHByZWZpeD8pIHtcbiAgcHJlZml4ID0gcHJlZml4IHx8ICcnO1xuICBhcnIgPSBBcnJheS5pc0FycmF5KGFycikgPyBhcnIgOiBbYXJyXTtcbiAgYXJyLmZpbHRlcihhYmJyZXYobykpLmZvckVhY2goZnVuY3Rpb24odikge1xuICAgIGNvbnNvbGUubG9nKHByZWZpeCArIHYpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gdHJpbSAocykge1xuICByZXR1cm4gcy50cmltKCk7XG59XG5cbmZ1bmN0aW9uIGNsZWFuUHJlZml4KHMpIHtcbiAgcmV0dXJuIHMucmVwbGFjZSgvLS9nLCAnJyk7XG59XG5cbmZ1bmN0aW9uIGFiYnJldihvKSB7IHJldHVybiBmdW5jdGlvbihpdCkge1xuICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyBvLmxhc3QucmVwbGFjZSgvXi0tPy9nLCAnJykpLnRlc3QoaXQpO1xufX1cblxuLy8gb3V0cHV0IHRoZSBjb21wbGV0aW9uLnNoIHNjcmlwdCB0byB0aGUgY29uc29sZSBmb3IgaW5zdGFsbCBpbnN0cnVjdGlvbnMuXG4vLyBUaGlzIGlzIGFjdHVhbGx5IGEgJ3RlbXBsYXRlJyB3aGVyZSB0aGUgcGFja2FnZSBuYW1lIGlzIHVzZWQgdG8gc2V0dXBcbi8vIHRoZSBjb21wbGV0aW9uIG9uIHRoZSByaWdodCBjb21tYW5kLCBhbmQgcHJvcGVybHkgbmFtZSB0aGUgYmFzaC96c2ggZnVuY3Rpb25zLlxuZnVuY3Rpb24gc2NyaXB0KG5hbWUsIGNvbXBsZXRlciwgY2IpIHtcbiAgdmFyIHAgPSBwdGguam9pbihfX2Rpcm5hbWUsICdjb21wbGV0aW9uLnNoJyk7XG5cbiAgZnMucmVhZEZpbGUocCwgJ3V0ZjgnLCBmdW5jdGlvbiAoZXIsIGQpIHtcbiAgICBpZiAoZXIpIHJldHVybiBjYihlcik7XG4gICAgY2IobnVsbCwgZCk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBpbnN0YWxsKG5hbWUsIGNvbXBsZXRlciwgY2IpIHtcbiAgdmFyIG1hcmtlckluID0gJyMjIy1iZWdpbi0nICsgbmFtZSArICctY29tcGxldGlvbi0jIyMnLFxuICAgIG1hcmtlck91dCA9ICcjIyMtZW5kLScgKyBuYW1lICsgJy1jb21wbGV0aW9uLSMjIyc7XG5cbiAgdmFyIHJjLCBzY3JpcHRPdXRwdXQ7XG5cbiAgcmVhZFJjKGNvbXBsZXRlciwgZnVuY3Rpb24oZXJyLCBmaWxlKSB7XG4gICAgaWYoZXJyKSByZXR1cm4gY2IoZXJyKTtcblxuICAgIHZhciBwYXJ0ID0gZmlsZS5zcGxpdChtYXJrZXJJbilbMV07XG4gICAgaWYocGFydCkge1xuICAgICAgcmV0dXJuIGNiKG51bGwsICcg4pyXICcgKyBjb21wbGV0ZXIgKyAnIHRhYi1jb21wbGV0aW9uIGhhcyBiZWVuIGFscmVhZHkgaW5zdGFsbGVkLiBEbyBub3RoaW5nLicpO1xuICAgIH1cblxuICAgIHJjID0gZmlsZTtcbiAgICBuZXh0KCk7XG4gIH0pO1xuXG4gIHNjcmlwdChuYW1lLCBjb21wbGV0ZXIsIGZ1bmN0aW9uKGVyciwgZmlsZSkge1xuICAgIHNjcmlwdE91dHB1dCA9IGZpbGU7XG4gICAgbmV4dCgpO1xuICB9KTtcblxuICBmdW5jdGlvbiBuZXh0KCkge1xuICAgIGlmKCFyYyB8fCAhc2NyaXB0T3V0cHV0KSByZXR1cm47XG5cbiAgICB3cml0ZVJjKHJjICsgc2NyaXB0T3V0cHV0LCBmdW5jdGlvbihlcnIpIHtcbiAgICAgIGlmKGVycikgcmV0dXJuIGNiKGVycik7XG4gICAgICByZXR1cm4gY2IobnVsbCwgJyDinJMgJyArIGNvbXBsZXRlciArICcgdGFiLWNvbXBsZXRpb24gaW5zdGFsbGVkLicpO1xuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIHVuaW5zdGFsbChuYW1lLCBjb21wbGV0ZXIsIGNiKSB7XG4gIHZhciBtYXJrZXJJbiA9ICdcXG5cXG4jIyMtYmVnaW4tJyArIG5hbWUgKyAnLWNvbXBsZXRpb24tIyMjJyxcbiAgICBtYXJrZXJPdXQgPSAnIyMjLWVuZC0nICsgbmFtZSArICctY29tcGxldGlvbi0jIyNcXG4nO1xuXG4gIHJlYWRSYyhjb21wbGV0ZXIsIGZ1bmN0aW9uKGVyciwgZmlsZSkge1xuICAgIGlmKGVycikgcmV0dXJuIGNiKGVycik7XG5cbiAgICB2YXIgcGFydCA9IGZpbGUuc3BsaXQobWFya2VySW4pWzFdO1xuICAgIGlmKCFwYXJ0KSB7XG4gICAgICByZXR1cm4gY2IobnVsbCwgJyDinJcgJyArIGNvbXBsZXRlciArICcgdGFiLWNvbXBsZXRpb24gaGFzIGJlZW4gYWxyZWFkeSB1bmluc3RhbGxlZC4gRG8gbm90aGluZy4nKTtcbiAgICB9XG5cbiAgICBwYXJ0ID0gbWFya2VySW4gKyBwYXJ0LnNwbGl0KG1hcmtlck91dClbMF0gKyBtYXJrZXJPdXQ7XG4gICAgd3JpdGVSYyhmaWxlLnJlcGxhY2UocGFydCwgJycpLCBmdW5jdGlvbihlcnIpIHtcbiAgICAgIGlmKGVycikgcmV0dXJuIGNiKGVycik7XG4gICAgICByZXR1cm4gY2IobnVsbCwgJyDinJMgJyArIGNvbXBsZXRlciArICcgdGFiLWNvbXBsZXRpb24gdW5pbnN0YWxsZWQuJyk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZWFkUmMoY29tcGxldGVyLCBjYikge1xuICB2YXIgZmlsZSA9ICcuJyArIHByb2Nlc3MuZW52LlNIRUxMLm1hdGNoKC9cXC9iaW5cXC8oXFx3KykvKVsxXSArICdyYycsXG4gIGZpbGVwYXRoID0gcHRoLmpvaW4ocHJvY2Vzcy5lbnYuSE9NRSwgZmlsZSk7XG4gIGZzLmxzdGF0KGZpbGVwYXRoLCBmdW5jdGlvbiAoZXJyLCBzdGF0cykge1xuICAgIGlmKGVycikgcmV0dXJuIGNiKG5ldyBFcnJvcihcIk5vIFwiICsgZmlsZSArIFwiIGZpbGUuIFlvdSdsbCBoYXZlIHRvIHJ1biBpbnN0ZWFkOiBcIiArIGNvbXBsZXRlciArIFwiIGNvbXBsZXRpb24gPj4gfi9cIiArIGZpbGUpKTtcbiAgICBmcy5yZWFkRmlsZShmaWxlcGF0aCwgJ3V0ZjgnLCBjYik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiB3cml0ZVJjKGNvbnRlbnQsIGNiKSB7XG4gIHZhciBmaWxlID0gJy4nICsgcHJvY2Vzcy5lbnYuU0hFTEwubWF0Y2goL1xcL2JpblxcLyhcXHcrKS8pWzFdICsgJ3JjJyxcbiAgZmlsZXBhdGggPSBwdGguam9pbihwcm9jZXNzLmVudi5IT01FLCBmaWxlKTtcbiAgZnMubHN0YXQoZmlsZXBhdGgsIGZ1bmN0aW9uIChlcnIsIHN0YXRzKSB7XG4gICAgaWYoZXJyKSByZXR1cm4gY2IobmV3IEVycm9yKFwiTm8gXCIgKyBmaWxlICsgXCIgZmlsZS4gWW91J2xsIGhhdmUgdG8gcnVuIGluc3RlYWQ6IFwiICsgY29udGVudCArIFwiIGNvbXBsZXRpb24gPj4gfi9cIiArIGZpbGUpKTtcbiAgICBmcy53cml0ZUZpbGUoZmlsZXBhdGgsIGNvbnRlbnQsIGNiKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGluc3RhbGxlZCAobWFya2VyLCBjb21wbGV0ZXIsIGNiKSB7XG4gIHJlYWRSYyhjb21wbGV0ZXIsIGZ1bmN0aW9uKGVyciwgZmlsZSkge1xuICAgIGlmKGVycikgcmV0dXJuIGNiKGVycik7XG4gICAgdmFyIGluc3RhbGxlZCA9IGZpbGUubWF0Y2gobWFya2VyKTtcbiAgICByZXR1cm4gY2IoISFpbnN0YWxsZWQpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcGFyc2VFbnYoKSB7XG4gIHZhciBhcmdzID0gcHJvY2Vzcy5hcmd2LnNsaWNlKDIpLFxuICBjb21wbGV0ZSA9IGFyZ3NbMF0gPT09ICdjb21wbGV0aW9uJztcblxuICByZXR1cm4ge1xuICAgIGFyZ3M6IGFyZ3MsXG4gICAgY29tcGxldGU6IGNvbXBsZXRlLFxuICAgIGluc3RhbGw6IGNvbXBsZXRlICYmIGFyZ3NbMV0gPT09ICdpbnN0YWxsJyxcbiAgICB1bmluc3RhbGw6IGNvbXBsZXRlICYmIGFyZ3NbMV0gPT09ICd1bmluc3RhbGwnLFxuICAgIHdvcmRzOiArcHJvY2Vzcy5lbnYuQ09NUF9DV09SRCxcbiAgICBwb2ludDogK3Byb2Nlc3MuZW52LkNPTVBfUE9JTlQsXG4gICAgbGluZTogcHJvY2Vzcy5lbnYuQ09NUF9MSU5FXG4gIH1cbn07XG4iXX0=
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _fs = _interopRequireDefault(require("fs"));

var _Common = _interopRequireDefault(require("./Common"));

var _eachSeries = _interopRequireDefault(require("async/eachSeries"));

var _constants = _interopRequireDefault(require("../constants.js"));

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */
var Configuration = {};

function splitKey(key) {
  var values = [key];
  if (key.indexOf('.') > -1) values = key.match(/(?:[^."]+|"[^"]*")+/g).map(function (dt) {
    return dt.replace(/"/g, '');
  });else if (key.indexOf(':') > -1) values = key.match(/(?:[^:"]+|"[^"]*")+/g).map(function (dt) {
    return dt.replace(/"/g, '');
  });
  return values;
}

function serializeConfiguration(json_conf) {
  return JSON.stringify(json_conf, null, 4);
}

Configuration.set = function (key, value, cb) {
  _fs["default"].readFile(_constants["default"].PM2_MODULE_CONF_FILE, "utf8", function (err, data) {
    if (err) return cb(err);
    var json_conf = JSON.parse(data);
    var values = splitKey(key);

    if (values.length > 0) {
      var levels = values;
      var tmp = json_conf;
      levels.forEach(function (key, index) {
        if (index == levels.length - 1) tmp[key] = value;else if (!tmp[key]) {
          tmp[key] = {};
          tmp = tmp[key];
        } else {
          if ((0, _typeof2["default"])(tmp[key]) != 'object') tmp[key] = {};
          tmp = tmp[key];
        }
      });
    } else {
      if (json_conf[key] && typeof json_conf[key] === 'string') _Common["default"].printOut(_constants["default"].PREFIX_MSG + 'Replacing current value key %s by %s', key, value);
      json_conf[key] = value;
    }

    _fs["default"].writeFile(_constants["default"].PM2_MODULE_CONF_FILE, serializeConfiguration(json_conf), function (err) {
      if (err) return cb(err);
      return cb(null, json_conf);
    });

    return false;
  });
};

Configuration.unset = function (key, cb) {
  _fs["default"].readFile(_constants["default"].PM2_MODULE_CONF_FILE, "utf8", function (err, data) {
    if (err) return cb(err);
    var json_conf = JSON.parse(data);
    var values = splitKey(key);

    if (values.length > 0) {
      var levels = values;
      var tmp = json_conf;
      levels.forEach(function (key, index) {
        if (index == levels.length - 1) delete tmp[key];else if (!tmp[key]) {
          tmp[key] = {};
          tmp = tmp[key];
        } else {
          if ((0, _typeof2["default"])(tmp[key]) != 'object') tmp[key] = {};
          tmp = tmp[key];
        }
      });
    } else delete json_conf[key];

    if (err) return cb(err);
    if (key === 'all') json_conf = {};

    _fs["default"].writeFile(_constants["default"].PM2_MODULE_CONF_FILE, serializeConfiguration(json_conf), function (err) {
      if (err) return cb(err);
      return cb(null, json_conf);
    });

    return false;
  });
};

Configuration.setSyncIfNotExist = function (key, value) {
  try {
    var conf = JSON.parse(_fs["default"].readFileSync(_constants["default"].PM2_MODULE_CONF_FILE, "utf8"));
  } catch (e) {
    return null;
  }

  var values = splitKey(key);
  var exists = false;

  if (values.length > 1 && conf && conf[values[0]]) {
    exists = Object.keys(conf[values[0]]).some(function (key) {
      if (key == values[1]) return true;
      return false;
    });
  }

  if (exists === false) return Configuration.setSync(key, value);
  return null;
};

Configuration.setSync = function (key, value) {
  try {
    var data = _fs["default"].readFileSync(_constants["default"].PM2_MODULE_CONF_FILE, "utf8");
  } catch (e) {
    return null;
  }

  var json_conf = JSON.parse(data);
  var values = splitKey(key);

  if (values.length > 0) {
    var levels = values;
    var tmp = json_conf;
    levels.forEach(function (key, index) {
      if (index == levels.length - 1) tmp[key] = value;else if (!tmp[key]) {
        tmp[key] = {};
        tmp = tmp[key];
      } else {
        if ((0, _typeof2["default"])(tmp[key]) != 'object') tmp[key] = {};
        tmp = tmp[key];
      }
    });
  } else {
    if (json_conf[key] && typeof json_conf[key] === 'string') _Common["default"].printOut(_constants["default"].PREFIX_MSG + 'Replacing current value key %s by %s', key, value);
    json_conf[key] = value;
  }

  if (key === 'all') json_conf = {};

  try {
    _fs["default"].writeFileSync(_constants["default"].PM2_MODULE_CONF_FILE, serializeConfiguration(json_conf));

    return json_conf;
  } catch (e) {
    console.error(e.message);
    return null;
  }
};

Configuration.unsetSync = function (key) {
  try {
    var data = _fs["default"].readFileSync(_constants["default"].PM2_MODULE_CONF_FILE, "utf8");
  } catch (e) {
    return null;
  }

  var json_conf = JSON.parse(data);
  var values = splitKey(key);

  if (values.length > 0) {
    var levels = values;
    var tmp = json_conf;
    levels.forEach(function (key, index) {
      if (index == levels.length - 1) delete tmp[key];else if (!tmp[key]) {
        tmp[key] = {};
        tmp = tmp[key];
      } else {
        if ((0, _typeof2["default"])(tmp[key]) != 'object') tmp[key] = {};
        tmp = tmp[key];
      }
    });
  } else delete json_conf[key];

  if (key === 'all') json_conf = {};

  try {
    _fs["default"].writeFileSync(_constants["default"].PM2_MODULE_CONF_FILE, serializeConfiguration(json_conf));
  } catch (e) {
    console.error(e.message);
    return null;
  }
};

Configuration.multiset = function (serial, cb) {
  var arrays = [];
  serial = serial.match(/(?:[^ "]+|"[^"]*")+/g);

  while (serial.length > 0) {
    arrays.push(serial.splice(0, 2));
  }

  (0, _eachSeries["default"])(arrays, function (el, next) {
    Configuration.set(el[0], el[1], next);
  }, cb);
};

Configuration.get = function (key, cb) {
  Configuration.getAll(function (err, data) {
    var climb = splitKey(key);
    climb.some(function (val) {
      if (!data[val]) {
        data = null;
        return true;
      }

      data = data[val];
      return false;
    });
    if (!data) return cb({
      err: 'Unknown key'
    }, null);
    return cb(null, data);
  });
};

Configuration.getSync = function (key) {
  try {
    var data = Configuration.getAllSync();
  } catch (e) {
    return null;
  }

  var climb = splitKey(key);
  climb.some(function (val) {
    if (!data[val]) {
      data = null;
      return true;
    }

    data = data[val];
    return false;
  });
  if (!data) return null;
  return data;
};

Configuration.getAll = function (cb) {
  _fs["default"].readFile(_constants["default"].PM2_MODULE_CONF_FILE, "utf8", function (err, data) {
    if (err) return cb(err);
    return cb(null, JSON.parse(data));
  });
};

Configuration.getAllSync = function () {
  try {
    return JSON.parse(_fs["default"].readFileSync(_constants["default"].PM2_MODULE_CONF_FILE, "utf8"));
  } catch (e) {
    console.error(e.stack || e);
    return {};
  }
};

var _default = Configuration;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db25maWd1cmF0aW9uLnRzIl0sIm5hbWVzIjpbIkNvbmZpZ3VyYXRpb24iLCJzcGxpdEtleSIsImtleSIsInZhbHVlcyIsImluZGV4T2YiLCJtYXRjaCIsIm1hcCIsImR0IiwicmVwbGFjZSIsInNlcmlhbGl6ZUNvbmZpZ3VyYXRpb24iLCJqc29uX2NvbmYiLCJKU09OIiwic3RyaW5naWZ5Iiwic2V0IiwidmFsdWUiLCJjYiIsImZzIiwicmVhZEZpbGUiLCJjc3QiLCJQTTJfTU9EVUxFX0NPTkZfRklMRSIsImVyciIsImRhdGEiLCJwYXJzZSIsImxlbmd0aCIsImxldmVscyIsInRtcCIsImZvckVhY2giLCJpbmRleCIsIkNvbW1vbiIsInByaW50T3V0IiwiUFJFRklYX01TRyIsIndyaXRlRmlsZSIsInVuc2V0Iiwic2V0U3luY0lmTm90RXhpc3QiLCJjb25mIiwicmVhZEZpbGVTeW5jIiwiZSIsImV4aXN0cyIsIk9iamVjdCIsImtleXMiLCJzb21lIiwic2V0U3luYyIsIndyaXRlRmlsZVN5bmMiLCJjb25zb2xlIiwiZXJyb3IiLCJtZXNzYWdlIiwidW5zZXRTeW5jIiwibXVsdGlzZXQiLCJzZXJpYWwiLCJhcnJheXMiLCJwdXNoIiwic3BsaWNlIiwiZWwiLCJuZXh0IiwiZ2V0IiwiZ2V0QWxsIiwiY2xpbWIiLCJ2YWwiLCJnZXRTeW5jIiwiZ2V0QWxsU3luYyIsInN0YWNrIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUtBOztBQUVBOztBQUNBOztBQUNBOztBQVRBOzs7OztBQVdBLElBQUlBLGFBQWtCLEdBQUcsRUFBekI7O0FBRUEsU0FBU0MsUUFBVCxDQUFrQkMsR0FBbEIsRUFBdUI7QUFDckIsTUFBSUMsTUFBTSxHQUFHLENBQUNELEdBQUQsQ0FBYjtBQUVBLE1BQUlBLEdBQUcsQ0FBQ0UsT0FBSixDQUFZLEdBQVosSUFBbUIsQ0FBQyxDQUF4QixFQUNFRCxNQUFNLEdBQUdELEdBQUcsQ0FBQ0csS0FBSixDQUFVLHNCQUFWLEVBQWtD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QVgsQ0FBUDtBQUNELEdBRkQsQ0FFRSxPQUFPaUIsQ0FBUCxFQUFVO0FBQ1ZPLElBQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjUixDQUFDLENBQUN3QixLQUFGLElBQVd4QixDQUF6QjtBQUNBLFdBQU8sRUFBUDtBQUNEO0FBQ0YsQ0FQRDs7ZUFTZXBDLGEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAyMDEzIHRoZSBQTTIgcHJvamVjdCBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBsaWNlbnNlIHRoYXRcbiAqIGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLlxuICovXG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuXG5pbXBvcnQgQ29tbW9uIGZyb20gJy4vQ29tbW9uJztcbmltcG9ydCBlYWNoU2VyaWVzIGZyb20gJ2FzeW5jL2VhY2hTZXJpZXMnO1xuaW1wb3J0IGNzdCBmcm9tICcuLi9jb25zdGFudHMuanMnO1xuXG52YXIgQ29uZmlndXJhdGlvbjogYW55ID0ge307XG5cbmZ1bmN0aW9uIHNwbGl0S2V5KGtleSkge1xuICB2YXIgdmFsdWVzID0gW2tleV07XG5cbiAgaWYgKGtleS5pbmRleE9mKCcuJykgPiAtMSlcbiAgICB2YWx1ZXMgPSBrZXkubWF0Y2goLyg/OlteLlwiXSt8XCJbXlwiXSpcIikrL2cpLm1hcChmdW5jdGlvbiAoZHQpIHsgcmV0dXJuIGR0LnJlcGxhY2UoL1wiL2csICcnKSB9KTtcbiAgZWxzZSBpZiAoa2V5LmluZGV4T2YoJzonKSA+IC0xKVxuICAgIHZhbHVlcyA9IGtleS5tYXRjaCgvKD86W146XCJdK3xcIlteXCJdKlwiKSsvZykubWFwKGZ1bmN0aW9uIChkdCkgeyByZXR1cm4gZHQucmVwbGFjZSgvXCIvZywgJycpIH0pO1xuXG4gIHJldHVybiB2YWx1ZXM7XG59XG5cbmZ1bmN0aW9uIHNlcmlhbGl6ZUNvbmZpZ3VyYXRpb24oanNvbl9jb25mKSB7XG4gIHJldHVybiBKU09OLnN0cmluZ2lmeShqc29uX2NvbmYsIG51bGwsIDQpXG59XG5cbkNvbmZpZ3VyYXRpb24uc2V0ID0gZnVuY3Rpb24gKGtleSwgdmFsdWUsIGNiKSB7XG4gIGZzLnJlYWRGaWxlKGNzdC5QTTJfTU9EVUxFX0NPTkZfRklMRSwgXCJ1dGY4XCIsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHtcbiAgICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKTtcblxuICAgIHZhciBqc29uX2NvbmYgPSBKU09OLnBhcnNlKGRhdGEpO1xuXG4gICAgdmFyIHZhbHVlcyA9IHNwbGl0S2V5KGtleSk7XG5cbiAgICBpZiAodmFsdWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHZhciBsZXZlbHMgPSB2YWx1ZXM7XG5cbiAgICAgIHZhciB0bXAgPSBqc29uX2NvbmY7XG5cbiAgICAgIGxldmVscy5mb3JFYWNoKGZ1bmN0aW9uIChrZXksIGluZGV4KSB7XG4gICAgICAgIGlmIChpbmRleCA9PSBsZXZlbHMubGVuZ3RoIC0gMSlcbiAgICAgICAgICB0bXBba2V5XSA9IHZhbHVlO1xuICAgICAgICBlbHNlIGlmICghdG1wW2tleV0pIHtcbiAgICAgICAgICB0bXBba2V5XSA9IHt9O1xuICAgICAgICAgIHRtcCA9IHRtcFtrZXldO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIGlmICh0eXBlb2YgKHRtcFtrZXldKSAhPSAnb2JqZWN0JylcbiAgICAgICAgICAgIHRtcFtrZXldID0ge307XG4gICAgICAgICAgdG1wID0gdG1wW2tleV07XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgaWYgKGpzb25fY29uZltrZXldICYmIHR5cGVvZiAoanNvbl9jb25mW2tleV0pID09PSAnc3RyaW5nJylcbiAgICAgICAgQ29tbW9uLnByaW50T3V0KGNzdC5QUkVGSVhfTVNHICsgJ1JlcGxhY2luZyBjdXJyZW50IHZhbHVlIGtleSAlcyBieSAlcycsIGtleSwgdmFsdWUpO1xuXG4gICAgICBqc29uX2NvbmZba2V5XSA9IHZhbHVlO1xuICAgIH1cblxuICAgIGZzLndyaXRlRmlsZShjc3QuUE0yX01PRFVMRV9DT05GX0ZJTEUsIHNlcmlhbGl6ZUNvbmZpZ3VyYXRpb24oanNvbl9jb25mKSwgZnVuY3Rpb24gKGVycikge1xuICAgICAgaWYgKGVycikgcmV0dXJuIGNiKGVycik7XG5cbiAgICAgIHJldHVybiBjYihudWxsLCBqc29uX2NvbmYpO1xuICAgIH0pO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfSk7XG59O1xuXG5Db25maWd1cmF0aW9uLnVuc2V0ID0gZnVuY3Rpb24gKGtleSwgY2IpIHtcbiAgZnMucmVhZEZpbGUoY3N0LlBNMl9NT0RVTEVfQ09ORl9GSUxFLCBcInV0ZjhcIiwgZnVuY3Rpb24gKGVyciwgZGF0YSkge1xuICAgIGlmIChlcnIpIHJldHVybiBjYihlcnIpO1xuXG4gICAgdmFyIGpzb25fY29uZiA9IEpTT04ucGFyc2UoZGF0YSk7XG5cbiAgICB2YXIgdmFsdWVzID0gc3BsaXRLZXkoa2V5KTtcblxuICAgIGlmICh2YWx1ZXMubGVuZ3RoID4gMCkge1xuICAgICAgdmFyIGxldmVscyA9IHZhbHVlcztcblxuICAgICAgdmFyIHRtcCA9IGpzb25fY29uZjtcblxuICAgICAgbGV2ZWxzLmZvckVhY2goZnVuY3Rpb24gKGtleSwgaW5kZXgpIHtcbiAgICAgICAgaWYgKGluZGV4ID09IGxldmVscy5sZW5ndGggLSAxKVxuICAgICAgICAgIGRlbGV0ZSB0bXBba2V5XTtcbiAgICAgICAgZWxzZSBpZiAoIXRtcFtrZXldKSB7XG4gICAgICAgICAgdG1wW2tleV0gPSB7fTtcbiAgICAgICAgICB0bXAgPSB0bXBba2V5XTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICBpZiAodHlwZW9mICh0bXBba2V5XSkgIT0gJ29iamVjdCcpXG4gICAgICAgICAgICB0bXBba2V5XSA9IHt9O1xuICAgICAgICAgIHRtcCA9IHRtcFtrZXldO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIH1cbiAgICBlbHNlXG4gICAgICBkZWxldGUganNvbl9jb25mW2tleV07XG5cbiAgICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKTtcblxuICAgIGlmIChrZXkgPT09ICdhbGwnKVxuICAgICAganNvbl9jb25mID0ge307XG5cbiAgICBmcy53cml0ZUZpbGUoY3N0LlBNMl9NT0RVTEVfQ09ORl9GSUxFLCBzZXJpYWxpemVDb25maWd1cmF0aW9uKGpzb25fY29uZiksIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgIGlmIChlcnIpIHJldHVybiBjYihlcnIpO1xuXG4gICAgICByZXR1cm4gY2IobnVsbCwganNvbl9jb25mKTtcbiAgICB9KTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0pO1xufVxuXG5Db25maWd1cmF0aW9uLnNldFN5bmNJZk5vdEV4aXN0ID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHtcbiAgdHJ5IHtcbiAgICB2YXIgY29uZiA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKGNzdC5QTTJfTU9EVUxFX0NPTkZfRklMRSwgXCJ1dGY4XCIpKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgdmFyIHZhbHVlcyA9IHNwbGl0S2V5KGtleSk7XG4gIHZhciBleGlzdHMgPSBmYWxzZTtcblxuICBpZiAodmFsdWVzLmxlbmd0aCA+IDEgJiYgY29uZiAmJiBjb25mW3ZhbHVlc1swXV0pIHtcbiAgICBleGlzdHMgPSBPYmplY3Qua2V5cyhjb25mW3ZhbHVlc1swXV0pLnNvbWUoZnVuY3Rpb24gKGtleSkge1xuICAgICAgaWYgKGtleSA9PSB2YWx1ZXNbMV0pXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0pO1xuICB9XG5cbiAgaWYgKGV4aXN0cyA9PT0gZmFsc2UpXG4gICAgcmV0dXJuIENvbmZpZ3VyYXRpb24uc2V0U3luYyhrZXksIHZhbHVlKTtcblxuICByZXR1cm4gbnVsbDtcbn07XG5cbkNvbmZpZ3VyYXRpb24uc2V0U3luYyA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7XG4gIHRyeSB7XG4gICAgdmFyIGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoY3N0LlBNMl9NT0RVTEVfQ09ORl9GSUxFLCBcInV0ZjhcIik7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHZhciBqc29uX2NvbmYgPSBKU09OLnBhcnNlKGRhdGEpO1xuXG4gIHZhciB2YWx1ZXMgPSBzcGxpdEtleShrZXkpO1xuXG4gIGlmICh2YWx1ZXMubGVuZ3RoID4gMCkge1xuICAgIHZhciBsZXZlbHMgPSB2YWx1ZXM7XG5cbiAgICB2YXIgdG1wID0ganNvbl9jb25mO1xuXG4gICAgbGV2ZWxzLmZvckVhY2goZnVuY3Rpb24gKGtleSwgaW5kZXgpIHtcbiAgICAgIGlmIChpbmRleCA9PSBsZXZlbHMubGVuZ3RoIC0gMSlcbiAgICAgICAgdG1wW2tleV0gPSB2YWx1ZTtcbiAgICAgIGVsc2UgaWYgKCF0bXBba2V5XSkge1xuICAgICAgICB0bXBba2V5XSA9IHt9O1xuICAgICAgICB0bXAgPSB0bXBba2V5XTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBpZiAodHlwZW9mICh0bXBba2V5XSkgIT0gJ29iamVjdCcpXG4gICAgICAgICAgdG1wW2tleV0gPSB7fTtcbiAgICAgICAgdG1wID0gdG1wW2tleV07XG4gICAgICB9XG4gICAgfSk7XG5cbiAgfVxuICBlbHNlIHtcbiAgICBpZiAoanNvbl9jb25mW2tleV0gJiYgdHlwZW9mIChqc29uX2NvbmZba2V5XSkgPT09ICdzdHJpbmcnKVxuICAgICAgQ29tbW9uLnByaW50T3V0KGNzdC5QUkVGSVhfTVNHICsgJ1JlcGxhY2luZyBjdXJyZW50IHZhbHVlIGtleSAlcyBieSAlcycsIGtleSwgdmFsdWUpO1xuXG4gICAganNvbl9jb25mW2tleV0gPSB2YWx1ZTtcbiAgfVxuXG4gIGlmIChrZXkgPT09ICdhbGwnKVxuICAgIGpzb25fY29uZiA9IHt9O1xuXG4gIHRyeSB7XG4gICAgZnMud3JpdGVGaWxlU3luYyhjc3QuUE0yX01PRFVMRV9DT05GX0ZJTEUsIHNlcmlhbGl6ZUNvbmZpZ3VyYXRpb24oanNvbl9jb25mKSk7XG4gICAgcmV0dXJuIGpzb25fY29uZjtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUuZXJyb3IoZS5tZXNzYWdlKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufTtcblxuQ29uZmlndXJhdGlvbi51bnNldFN5bmMgPSBmdW5jdGlvbiAoa2V5KSB7XG4gIHRyeSB7XG4gICAgdmFyIGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoY3N0LlBNMl9NT0RVTEVfQ09ORl9GSUxFLCBcInV0ZjhcIik7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHZhciBqc29uX2NvbmYgPSBKU09OLnBhcnNlKGRhdGEpO1xuXG4gIHZhciB2YWx1ZXMgPSBzcGxpdEtleShrZXkpO1xuXG4gIGlmICh2YWx1ZXMubGVuZ3RoID4gMCkge1xuICAgIHZhciBsZXZlbHMgPSB2YWx1ZXM7XG5cbiAgICB2YXIgdG1wID0ganNvbl9jb25mO1xuXG4gICAgbGV2ZWxzLmZvckVhY2goZnVuY3Rpb24gKGtleSwgaW5kZXgpIHtcbiAgICAgIGlmIChpbmRleCA9PSBsZXZlbHMubGVuZ3RoIC0gMSlcbiAgICAgICAgZGVsZXRlIHRtcFtrZXldO1xuICAgICAgZWxzZSBpZiAoIXRtcFtrZXldKSB7XG4gICAgICAgIHRtcFtrZXldID0ge307XG4gICAgICAgIHRtcCA9IHRtcFtrZXldO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIGlmICh0eXBlb2YgKHRtcFtrZXldKSAhPSAnb2JqZWN0JylcbiAgICAgICAgICB0bXBba2V5XSA9IHt9O1xuICAgICAgICB0bXAgPSB0bXBba2V5XTtcbiAgICAgIH1cbiAgICB9KTtcblxuICB9XG4gIGVsc2VcbiAgICBkZWxldGUganNvbl9jb25mW2tleV07XG5cbiAgaWYgKGtleSA9PT0gJ2FsbCcpXG4gICAganNvbl9jb25mID0ge307XG5cbiAgdHJ5IHtcbiAgICBmcy53cml0ZUZpbGVTeW5jKGNzdC5QTTJfTU9EVUxFX0NPTkZfRklMRSwgc2VyaWFsaXplQ29uZmlndXJhdGlvbihqc29uX2NvbmYpKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUuZXJyb3IoZS5tZXNzYWdlKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufTtcblxuQ29uZmlndXJhdGlvbi5tdWx0aXNldCA9IGZ1bmN0aW9uIChzZXJpYWwsIGNiKSB7XG4gIHZhciBhcnJheXMgPSBbXTtcbiAgc2VyaWFsID0gc2VyaWFsLm1hdGNoKC8oPzpbXiBcIl0rfFwiW15cIl0qXCIpKy9nKTtcblxuICB3aGlsZSAoc2VyaWFsLmxlbmd0aCA+IDApXG4gICAgYXJyYXlzLnB1c2goc2VyaWFsLnNwbGljZSgwLCAyKSk7XG5cbiAgZWFjaFNlcmllcyhhcnJheXMsIGZ1bmN0aW9uIChlbCwgbmV4dCkge1xuICAgIENvbmZpZ3VyYXRpb24uc2V0KGVsWzBdLCBlbFsxXSwgbmV4dCk7XG4gIH0sIGNiKTtcbn07XG5cbkNvbmZpZ3VyYXRpb24uZ2V0ID0gZnVuY3Rpb24gKGtleSwgY2IpIHtcbiAgQ29uZmlndXJhdGlvbi5nZXRBbGwoZnVuY3Rpb24gKGVyciwgZGF0YSkge1xuICAgIHZhciBjbGltYiA9IHNwbGl0S2V5KGtleSk7XG5cbiAgICBjbGltYi5zb21lKGZ1bmN0aW9uICh2YWwpIHtcbiAgICAgIGlmICghZGF0YVt2YWxdKSB7XG4gICAgICAgIGRhdGEgPSBudWxsO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGRhdGEgPSBkYXRhW3ZhbF07XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSk7XG5cbiAgICBpZiAoIWRhdGEpIHJldHVybiBjYih7IGVycjogJ1Vua25vd24ga2V5JyB9LCBudWxsKTtcbiAgICByZXR1cm4gY2IobnVsbCwgZGF0YSk7XG4gIH0pO1xufTtcblxuQ29uZmlndXJhdGlvbi5nZXRTeW5jID0gZnVuY3Rpb24gKGtleSkge1xuICB0cnkge1xuICAgIHZhciBkYXRhID0gQ29uZmlndXJhdGlvbi5nZXRBbGxTeW5jKCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHZhciBjbGltYiA9IHNwbGl0S2V5KGtleSk7XG5cbiAgY2xpbWIuc29tZShmdW5jdGlvbiAodmFsKSB7XG4gICAgaWYgKCFkYXRhW3ZhbF0pIHtcbiAgICAgIGRhdGEgPSBudWxsO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGRhdGEgPSBkYXRhW3ZhbF07XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9KTtcblxuICBpZiAoIWRhdGEpIHJldHVybiBudWxsO1xuICByZXR1cm4gZGF0YTtcbn07XG5cbkNvbmZpZ3VyYXRpb24uZ2V0QWxsID0gZnVuY3Rpb24gKGNiKSB7XG4gIGZzLnJlYWRGaWxlKGNzdC5QTTJfTU9EVUxFX0NPTkZfRklMRSwgXCJ1dGY4XCIsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHtcbiAgICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKTtcbiAgICByZXR1cm4gY2IobnVsbCwgSlNPTi5wYXJzZShkYXRhKSk7XG4gIH0pO1xufTtcblxuQ29uZmlndXJhdGlvbi5nZXRBbGxTeW5jID0gZnVuY3Rpb24gKCkge1xuICB0cnkge1xuICAgIHJldHVybiBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhjc3QuUE0yX01PRFVMRV9DT05GX0ZJTEUsIFwidXRmOFwiKSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmVycm9yKGUuc3RhY2sgfHwgZSk7XG4gICAgcmV0dXJuIHt9O1xuICB9XG59O1xuXG5leHBvcnQgZGVmYXVsdCBDb25maWd1cmF0aW9uO1xuIl19
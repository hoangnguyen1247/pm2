"use strict";

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _constants = _interopRequireDefault(require("../constants"));

var _Utility = _interopRequireDefault(require("./Utility"));

var _ProcessUtils = _interopRequireDefault(require("./ProcessUtils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

// Load all env-vars from master.
var pm2_env = JSON.parse(process.env.pm2_env);

for (var k in pm2_env) {
  process.env[k] = pm2_env[k];
} // Rename process


process.title = process.env.PROCESS_TITLE || 'node ' + pm2_env.pm_exec_path;
delete process.env.pm2_env;
/**
 * Main entrance to wrap the desired code
 */

(function ProcessContainer() {
  _ProcessUtils["default"].injectModules();

  var stdFile = pm2_env.pm_log_path;
  var outFile = pm2_env.pm_out_log_path;
  var errFile = pm2_env.pm_err_log_path;
  var pidFile = pm2_env.pm_pid_path;
  var script = pm2_env.pm_exec_path;
  var original_send = process.send;

  if (typeof process.env.source_map_support != 'undefined' && process.env.source_map_support !== 'false') {
    require('source-map-support').install();
  }

  process.send = function () {
    if (process.connected) return original_send.apply(this, arguments);
  }; //send node version


  if (process.versions && process.versions.node) {
    process.send({
      'node_version': process.versions.node
    });
  }

  if (_constants["default"].MODIFY_REQUIRE) require.main.filename = pm2_env.pm_exec_path; // Resets global paths for require()

  require('module')._initPaths();

  try {
    _fs["default"].writeFileSync(pidFile, process.pid.toString());
  } catch (e) {
    console.error(e.stack || e);
  } // Add args to process if args specified on start


  if (process.env.args != null) process.argv = process.argv.concat(pm2_env.args); // stdio, including: out, err and entire (both out and err if necessary).

  var stds = {
    out: outFile,
    err: errFile
  };
  stdFile && (stds.std = stdFile); // uid/gid management

  if (pm2_env.uid || pm2_env.gid) {
    try {
      if (pm2_env.uid) process.setuid(pm2_env.uid);
      if (process.env.gid) process.setgid(pm2_env.gid);
    } catch (e) {
      setTimeout(function () {
        console.error('%s on call %s', e.message, e.syscall);
        console.error('%s is not accessible', pm2_env.uid);
        return process.exit(1);
      }, 100);
    }
  }

  exec(script, stds);
})();
/**
 * Description
 * @method exec
 * @param {} script
 * @param {} stds
 * @return
 */


function exec(script, stds) {
  if (_path["default"].extname(script) == '.coffee') {
    try {
      require('coffee-script/register');
    } catch (e) {
      console.error('Failed to load CoffeeScript interpreter:', e.message || e);
    }
  }

  if (_path["default"].extname(script) == '.ls') {
    try {
      require('livescript');
    } catch (e) {
      console.error('Failed to load LiveScript interpreter:', e.message || e);
    }
  }

  if (_path["default"].extname(script) == '.ts' || _path["default"].extname(script) == '.tsx') {
    try {
      require('ts-node/register');
    } catch (e) {
      console.error('Failed to load Typescript interpreter:', e.message || e);
    }
  }

  process.on('message', function (msg) {
    if (msg.type === 'log:reload') {
      for (var k in stds) {
        if (_typeof(stds[k]) == 'object' && !isNaN(stds[k].fd)) {
          if (stds[k].destroy) stds[k].destroy();else if (stds[k].end) stds[k].end();else if (stds[k].close) stds[k].close();
          stds[k] = stds[k]._file;
        }
      }

      _Utility["default"].startLogging(stds, function (err) {
        if (err) return console.error('Failed to reload logs:', err.stack);
        console.log('Reloading log...');
      });
    }
  });
  var dayjs = null;
  if (pm2_env.log_date_format) dayjs = require('dayjs');

  _Utility["default"].startLogging(stds, function (err) {
    if (err) {
      process.send({
        type: 'process:exception',
        data: {
          message: err.message,
          syscall: 'ProcessContainer.startLogging'
        }
      });
      throw err;
      return;
    }

    process.stderr.write = function (write) {
      return function (string, cb) {
        var log_data = null; // Disable logs if specified

        if (pm2_env.disable_logs === true) {
          return cb ? cb() : false;
        }

        if (pm2_env.log_type && pm2_env.log_type === 'json') {
          log_data = JSON.stringify({
            message: string.toString(),
            timestamp: pm2_env.log_date_format && dayjs ? dayjs().format(pm2_env.log_date_format) : new Date().toISOString(),
            type: 'err',
            process_id: pm2_env.pm_id,
            app_name: pm2_env.name
          }) + '\n';
        } else if (pm2_env.log_date_format && dayjs) log_data = "".concat(dayjs().format(pm2_env.log_date_format), ": ").concat(string.toString());else log_data = string.toString();

        process.send({
          type: 'log:err',
          topic: 'log:err',
          data: log_data
        });
        if (_Utility["default"].checkPathIsNull(pm2_env.pm_err_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) return cb ? cb() : false; // TODO: please check this

        var encoding = "";
        stds.std && stds.std.write && stds.std.write(log_data, encoding);
        stds.err && stds.err.write && stds.err.write(log_data, encoding, cb);
      };
    }(process.stderr.write);

    process.stdout.write = function (write) {
      return function (string, cb) {
        var log_data = null; // Disable logs if specified

        if (pm2_env.disable_logs === true) {
          return cb ? cb() : false;
        }

        if (pm2_env.log_type && pm2_env.log_type === 'json') {
          log_data = JSON.stringify({
            message: string.toString(),
            timestamp: pm2_env.log_date_format && dayjs ? dayjs().format(pm2_env.log_date_format) : new Date().toISOString(),
            type: 'out',
            process_id: pm2_env.pm_id,
            app_name: pm2_env.name
          }) + '\n';
        } else if (pm2_env.log_date_format && dayjs) log_data = "".concat(dayjs().format(pm2_env.log_date_format), ": ").concat(string.toString());else log_data = string.toString();

        process.send({
          type: 'log:out',
          data: log_data
        });
        if (_Utility["default"].checkPathIsNull(pm2_env.pm_out_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) return cb ? cb() : null; // TODO: please check this

        var encoding = "";
        stds.std && stds.std.write && stds.std.write(log_data, encoding);
        stds.out && stds.out.write && stds.out.write(log_data, encoding, cb);
      };
    }(process.stdout.write);

    function getUncaughtExceptionListener(listener) {
      return function uncaughtListener(err) {
        var error = err && err.stack ? err.stack : err;

        if (listener === 'unhandledRejection') {
          error = 'You have triggered an unhandledRejection, you may have forgotten to catch a Promise rejection:\n' + error;
        }

        logError(['std', 'err'], error); // Notify master that an uncaughtException has been catched

        try {
          if (err) {
            var errObj = {};
            Object.getOwnPropertyNames(err).forEach(function (key) {
              errObj[key] = err[key];
            });
          }

          process.send({
            type: 'log:err',
            topic: 'log:err',
            data: '\n' + error + '\n'
          });
          process.send({
            type: 'process:exception',
            data: errObj !== undefined ? errObj : {
              message: 'No error but ' + listener + ' was caught!'
            }
          });
        } catch (e) {
          logError(['std', 'err'], 'Channel is already closed can\'t broadcast error:\n' + e.stack);
        }

        if (!process.listeners(listener).filter(function (listener) {
          return listener !== uncaughtListener;
        }).length) {
          if (listener == 'uncaughtException') {
            process.emit('disconnect');
            process.exit(_constants["default"].CODE_UNCAUGHTEXCEPTION);
          }
        }
      };
    }

    process.on('uncaughtException', getUncaughtExceptionListener('uncaughtException'));
    process.on('unhandledRejection', getUncaughtExceptionListener('unhandledRejection')); // Change dir to fix process.cwd

    process.chdir(pm2_env.pm_cwd || process.env.PWD || _path["default"].dirname(script));

    require('module')._load(script, null, true);

    function logError(types, error) {
      try {
        types.forEach(function (type) {
          stds[type] && typeof stds[type].write == 'function' && stds[type].write(error + '\n');
        });
      } catch (e) {}
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Qcm9jZXNzQ29udGFpbmVyTGVnYWN5LnRzIl0sIm5hbWVzIjpbInBtMl9lbnYiLCJKU09OIiwicGFyc2UiLCJwcm9jZXNzIiwiZW52IiwiayIsInRpdGxlIiwiUFJPQ0VTU19USVRMRSIsInBtX2V4ZWNfcGF0aCIsIlByb2Nlc3NDb250YWluZXIiLCJQcm9jZXNzVXRpbHMiLCJpbmplY3RNb2R1bGVzIiwic3RkRmlsZSIsInBtX2xvZ19wYXRoIiwib3V0RmlsZSIsInBtX291dF9sb2dfcGF0aCIsImVyckZpbGUiLCJwbV9lcnJfbG9nX3BhdGgiLCJwaWRGaWxlIiwicG1fcGlkX3BhdGgiLCJzY3JpcHQiLCJvcmlnaW5hbF9zZW5kIiwic2VuZCIsInNvdXJjZV9tYXBfc3VwcG9ydCIsInJlcXVpcmUiLCJpbnN0YWxsIiwiY29ubmVjdGVkIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJ2ZXJzaW9ucyIsIm5vZGUiLCJjc3QiLCJNT0RJRllfUkVRVUlSRSIsIm1haW4iLCJmaWxlbmFtZSIsIl9pbml0UGF0aHMiLCJmcyIsIndyaXRlRmlsZVN5bmMiLCJwaWQiLCJ0b1N0cmluZyIsImUiLCJjb25zb2xlIiwiZXJyb3IiLCJzdGFjayIsImFyZ3MiLCJhcmd2IiwiY29uY2F0Iiwic3RkcyIsIm91dCIsImVyciIsInN0ZCIsInVpZCIsImdpZCIsInNldHVpZCIsInNldGdpZCIsInNldFRpbWVvdXQiLCJtZXNzYWdlIiwic3lzY2FsbCIsImV4aXQiLCJleGVjIiwicCIsImV4dG5hbWUiLCJvbiIsIm1zZyIsInR5cGUiLCJpc05hTiIsImZkIiwiZGVzdHJveSIsImVuZCIsImNsb3NlIiwiX2ZpbGUiLCJVdGlsaXR5Iiwic3RhcnRMb2dnaW5nIiwibG9nIiwiZGF5anMiLCJsb2dfZGF0ZV9mb3JtYXQiLCJkYXRhIiwic3RkZXJyIiwid3JpdGUiLCJzdHJpbmciLCJjYiIsImxvZ19kYXRhIiwiZGlzYWJsZV9sb2dzIiwibG9nX3R5cGUiLCJzdHJpbmdpZnkiLCJ0aW1lc3RhbXAiLCJmb3JtYXQiLCJEYXRlIiwidG9JU09TdHJpbmciLCJwcm9jZXNzX2lkIiwicG1faWQiLCJhcHBfbmFtZSIsIm5hbWUiLCJ0b3BpYyIsImNoZWNrUGF0aElzTnVsbCIsImVuY29kaW5nIiwic3Rkb3V0IiwiZ2V0VW5jYXVnaHRFeGNlcHRpb25MaXN0ZW5lciIsImxpc3RlbmVyIiwidW5jYXVnaHRMaXN0ZW5lciIsImxvZ0Vycm9yIiwiZXJyT2JqIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsImZvckVhY2giLCJrZXkiLCJ1bmRlZmluZWQiLCJsaXN0ZW5lcnMiLCJmaWx0ZXIiLCJsZW5ndGgiLCJlbWl0IiwiQ09ERV9VTkNBVUdIVEVYQ0VQVElPTiIsImNoZGlyIiwicG1fY3dkIiwiUFdEIiwiZGlybmFtZSIsIl9sb2FkIiwidHlwZXMiXSwibWFwcGluZ3MiOiI7O0FBVUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBO0FBQ0EsSUFBSUEsT0FBTyxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0MsT0FBTyxDQUFDQyxHQUFSLENBQVlKLE9BQXZCLENBQWQ7O0FBQ0EsS0FBSyxJQUFJSyxDQUFULElBQWNMLE9BQWQsRUFBdUI7QUFDckJHLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxDQUFaLElBQWlCTCxPQUFPLENBQUNLLENBQUQsQ0FBeEI7QUFDRCxDLENBRUQ7OztBQUNBRixPQUFPLENBQUNHLEtBQVIsR0FBZ0JILE9BQU8sQ0FBQ0MsR0FBUixDQUFZRyxhQUFaLElBQTZCLFVBQVVQLE9BQU8sQ0FBQ1EsWUFBL0Q7QUFFQSxPQUFPTCxPQUFPLENBQUNDLEdBQVIsQ0FBWUosT0FBbkI7QUFFQTs7OztBQUdBLENBQUMsU0FBU1MsZ0JBQVQsR0FBNEI7QUFFM0JDLDJCQUFhQyxhQUFiOztBQUVBLE1BQUlDLE9BQU8sR0FBR1osT0FBTyxDQUFDYSxXQUF0QjtBQUNBLE1BQUlDLE9BQU8sR0FBR2QsT0FBTyxDQUFDZSxlQUF0QjtBQUNBLE1BQUlDLE9B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dGhlIFBNMiBwcm9qZWN0IGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIGxpY2Vuc2UgdGhhdFxuICogY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuXG4gKlxuICogVGhpcyBmaWxlIHdyYXAgdGFyZ2V0IGFwcGxpY2F0aW9uXG4gKiAtIHJlZGlyZWN0IHN0ZGluLCBzdGRlcnIgdG8gYnVzICsgbG9nIGZpbGVzXG4gKiAtIHJlbmFtZSBwcm9jZXNzXG4gKiAtIHBpZFxuICovXG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHAgZnJvbSAncGF0aCc7XG5pbXBvcnQgY3N0IGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgVXRpbGl0eSBmcm9tICcuL1V0aWxpdHknO1xuaW1wb3J0IFByb2Nlc3NVdGlscyBmcm9tICcuL1Byb2Nlc3NVdGlscyc7XG5cbi8vIExvYWQgYWxsIGVudi12YXJzIGZyb20gbWFzdGVyLlxudmFyIHBtMl9lbnYgPSBKU09OLnBhcnNlKHByb2Nlc3MuZW52LnBtMl9lbnYpO1xuZm9yICh2YXIgayBpbiBwbTJfZW52KSB7XG4gIHByb2Nlc3MuZW52W2tdID0gcG0yX2VudltrXTtcbn1cblxuLy8gUmVuYW1lIHByb2Nlc3NcbnByb2Nlc3MudGl0bGUgPSBwcm9jZXNzLmVudi5QUk9DRVNTX1RJVExFIHx8ICdub2RlICcgKyBwbTJfZW52LnBtX2V4ZWNfcGF0aDtcblxuZGVsZXRlIHByb2Nlc3MuZW52LnBtMl9lbnY7XG5cbi8qKlxuICogTWFpbiBlbnRyYW5jZSB0byB3cmFwIHRoZSBkZXNpcmVkIGNvZGVcbiAqL1xuKGZ1bmN0aW9uIFByb2Nlc3NDb250YWluZXIoKSB7XG5cbiAgUHJvY2Vzc1V0aWxzLmluamVjdE1vZHVsZXMoKVxuXG4gIHZhciBzdGRGaWxlID0gcG0yX2Vudi5wbV9sb2dfcGF0aDtcbiAgdmFyIG91dEZpbGUgPSBwbTJfZW52LnBtX291dF9sb2dfcGF0aDtcbiAgdmFyIGVyckZpbGUgPSBwbTJfZW52LnBtX2Vycl9sb2dfcGF0aDtcbiAgdmFyIHBpZEZpbGUgPSBwbTJfZW52LnBtX3BpZF9wYXRoO1xuICB2YXIgc2NyaXB0ID0gcG0yX2Vudi5wbV9leGVjX3BhdGg7XG5cbiAgdmFyIG9yaWdpbmFsX3NlbmQgPSBwcm9jZXNzLnNlbmQ7XG5cbiAgaWYgKHR5cGVvZiAocHJvY2Vzcy5lbnYuc291cmNlX21hcF9zdXBwb3J0KSAhPSAndW5kZWZpbmVkJyAmJlxuICAgIHByb2Nlc3MuZW52LnNvdXJjZV9tYXBfc3VwcG9ydCAhPT0gJ2ZhbHNlJykge1xuICAgIHJlcXVpcmUoJ3NvdXJjZS1tYXAtc3VwcG9ydCcpLmluc3RhbGwoKTtcbiAgfVxuXG4gIHByb2Nlc3Muc2VuZCA9IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAocHJvY2Vzcy5jb25uZWN0ZWQpXG4gICAgICByZXR1cm4gb3JpZ2luYWxfc2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMgYXMgYW55KTtcbiAgfTtcblxuICAvL3NlbmQgbm9kZSB2ZXJzaW9uXG4gIGlmIChwcm9jZXNzLnZlcnNpb25zICYmIHByb2Nlc3MudmVyc2lvbnMubm9kZSkge1xuICAgIHByb2Nlc3Muc2VuZCh7XG4gICAgICAnbm9kZV92ZXJzaW9uJzogcHJvY2Vzcy52ZXJzaW9ucy5ub2RlXG4gICAgfSk7XG4gIH1cblxuICBpZiAoY3N0Lk1PRElGWV9SRVFVSVJFKVxuICAgIHJlcXVpcmUubWFpbi5maWxlbmFtZSA9IHBtMl9lbnYucG1fZXhlY19wYXRoO1xuXG4gIC8vIFJlc2V0cyBnbG9iYWwgcGF0aHMgZm9yIHJlcXVpcmUoKVxuICByZXF1aXJlKCdtb2R1bGUnKS5faW5pdFBhdGhzKCk7XG5cbiAgdHJ5IHtcbiAgICBmcy53cml0ZUZpbGVTeW5jKHBpZEZpbGUsIHByb2Nlc3MucGlkLnRvU3RyaW5nKCkpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgY29uc29sZS5lcnJvcihlLnN0YWNrIHx8IGUpO1xuICB9XG5cbiAgLy8gQWRkIGFyZ3MgdG8gcHJvY2VzcyBpZiBhcmdzIHNwZWNpZmllZCBvbiBzdGFydFxuICBpZiAocHJvY2Vzcy5lbnYuYXJncyAhPSBudWxsKVxuICAgIHByb2Nlc3MuYXJndiA9IHByb2Nlc3MuYXJndi5jb25jYXQocG0yX2Vudi5hcmdzKTtcblxuICAvLyBzdGRpbywgaW5jbHVkaW5nOiBvdXQsIGVyciBhbmQgZW50aXJlIChib3RoIG91dCBhbmQgZXJyIGlmIG5lY2Vzc2FyeSkuXG4gIHZhciBzdGRzOiBhbnkgPSB7XG4gICAgb3V0OiBvdXRGaWxlLFxuICAgIGVycjogZXJyRmlsZVxuICB9O1xuICBzdGRGaWxlICYmIChzdGRzLnN0ZCA9IHN0ZEZpbGUpO1xuXG4gIC8vIHVpZC9naWQgbWFuYWdlbWVudFxuICBpZiAocG0yX2Vudi51aWQgfHwgcG0yX2Vudi5naWQpIHtcbiAgICB0cnkge1xuICAgICAgaWYgKHBtMl9lbnYudWlkKVxuICAgICAgICBwcm9jZXNzLnNldHVpZChwbTJfZW52LnVpZCk7XG4gICAgICBpZiAocHJvY2Vzcy5lbnYuZ2lkKVxuICAgICAgICBwcm9jZXNzLnNldGdpZChwbTJfZW52LmdpZCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJyVzIG9uIGNhbGwgJXMnLCBlLm1lc3NhZ2UsIGUuc3lzY2FsbCk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJyVzIGlzIG5vdCBhY2Nlc3NpYmxlJywgcG0yX2Vudi51aWQpO1xuICAgICAgICByZXR1cm4gcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgfSwgMTAwKTtcbiAgICB9XG4gIH1cblxuICBleGVjKHNjcmlwdCwgc3Rkcyk7XG59KSgpO1xuXG4vKipcbiAqIERlc2NyaXB0aW9uXG4gKiBAbWV0aG9kIGV4ZWNcbiAqIEBwYXJhbSB7fSBzY3JpcHRcbiAqIEBwYXJhbSB7fSBzdGRzXG4gKiBAcmV0dXJuXG4gKi9cbmZ1bmN0aW9uIGV4ZWMoc2NyaXB0LCBzdGRzKSB7XG4gIGlmIChwLmV4dG5hbWUoc2NyaXB0KSA9PSAnLmNvZmZlZScpIHtcbiAgICB0cnkge1xuICAgICAgcmVxdWlyZSgnY29mZmVlLXNjcmlwdC9yZWdpc3RlcicpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIENvZmZlZVNjcmlwdCBpbnRlcnByZXRlcjonLCBlLm1lc3NhZ2UgfHwgZSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHAuZXh0bmFtZShzY3JpcHQpID09ICcubHMnKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJlcXVpcmUoJ2xpdmVzY3JpcHQnKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBMaXZlU2NyaXB0IGludGVycHJldGVyOicsIGUubWVzc2FnZSB8fCBlKTtcbiAgICB9XG4gIH1cblxuICBpZiAocC5leHRuYW1lKHNjcmlwdCkgPT0gJy50cycgfHwgcC5leHRuYW1lKHNjcmlwdCkgPT0gJy50c3gnKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJlcXVpcmUoJ3RzLW5vZGUvcmVnaXN0ZXInKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBUeXBlc2NyaXB0IGludGVycHJldGVyOicsIGUubWVzc2FnZSB8fCBlKTtcbiAgICB9XG4gIH1cblxuICBwcm9jZXNzLm9uKCdtZXNzYWdlJywgZnVuY3Rpb24gKG1zZykge1xuICAgIGlmIChtc2cudHlwZSA9PT0gJ2xvZzpyZWxvYWQnKSB7XG4gICAgICBmb3IgKHZhciBrIGluIHN0ZHMpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBzdGRzW2tdID09ICdvYmplY3QnICYmICFpc05hTihzdGRzW2tdLmZkKSkge1xuICAgICAgICAgIGlmIChzdGRzW2tdLmRlc3Ryb3kpIHN0ZHNba10uZGVzdHJveSgpO1xuICAgICAgICAgIGVsc2UgaWYgKHN0ZHNba10uZW5kKSBzdGRzW2tdLmVuZCgpO1xuICAgICAgICAgIGVsc2UgaWYgKHN0ZHNba10uY2xvc2UpIHN0ZHNba10uY2xvc2UoKTtcbiAgICAgICAgICBzdGRzW2tdID0gc3Rkc1trXS5fZmlsZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgVXRpbGl0eS5zdGFydExvZ2dpbmcoc3RkcywgZnVuY3Rpb24gKGVycikge1xuICAgICAgICBpZiAoZXJyKVxuICAgICAgICAgIHJldHVybiBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gcmVsb2FkIGxvZ3M6JywgZXJyLnN0YWNrKTtcbiAgICAgICAgY29uc29sZS5sb2coJ1JlbG9hZGluZyBsb2cuLi4nKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgdmFyIGRheWpzID0gbnVsbDtcblxuICBpZiAocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQpXG4gICAgZGF5anMgPSByZXF1aXJlKCdkYXlqcycpO1xuXG4gIFV0aWxpdHkuc3RhcnRMb2dnaW5nKHN0ZHMsIGZ1bmN0aW9uIChlcnIpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBwcm9jZXNzLnNlbmQoe1xuICAgICAgICB0eXBlOiAncHJvY2VzczpleGNlcHRpb24nLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICAgICAgc3lzY2FsbDogJ1Byb2Nlc3NDb250YWluZXIuc3RhcnRMb2dnaW5nJ1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRocm93IGVycjtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBwcm9jZXNzLnN0ZGVyci53cml0ZSA9IChmdW5jdGlvbiAod3JpdGUpIHtcbiAgICAgIHJldHVybiBmdW5jdGlvbiAoc3RyaW5nLCBjYikge1xuICAgICAgICB2YXIgbG9nX2RhdGEgPSBudWxsO1xuXG4gICAgICAgIC8vIERpc2FibGUgbG9ncyBpZiBzcGVjaWZpZWRcbiAgICAgICAgaWYgKHBtMl9lbnYuZGlzYWJsZV9sb2dzID09PSB0cnVlKSB7XG4gICAgICAgICAgcmV0dXJuIGNiID8gY2IoKSA6IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBtMl9lbnYubG9nX3R5cGUgJiYgcG0yX2Vudi5sb2dfdHlwZSA9PT0gJ2pzb24nKSB7XG4gICAgICAgICAgbG9nX2RhdGEgPSBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICBtZXNzYWdlOiBzdHJpbmcudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIHRpbWVzdGFtcDogcG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQgJiYgZGF5anMgP1xuICAgICAgICAgICAgICBkYXlqcygpLmZvcm1hdChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCkgOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICB0eXBlOiAnZXJyJyxcbiAgICAgICAgICAgIHByb2Nlc3NfaWQ6IHBtMl9lbnYucG1faWQsXG4gICAgICAgICAgICBhcHBfbmFtZTogcG0yX2Vudi5uYW1lXG4gICAgICAgICAgfSkgKyAnXFxuJztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCAmJiBkYXlqcylcbiAgICAgICAgICBsb2dfZGF0YSA9IGAke2RheWpzKCkuZm9ybWF0KHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0KX06ICR7c3RyaW5nLnRvU3RyaW5nKCl9YDtcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGxvZ19kYXRhID0gc3RyaW5nLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgcHJvY2Vzcy5zZW5kKHtcbiAgICAgICAgICB0eXBlOiAnbG9nOmVycicsXG4gICAgICAgICAgdG9waWM6ICdsb2c6ZXJyJyxcbiAgICAgICAgICBkYXRhOiBsb2dfZGF0YVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoVXRpbGl0eS5jaGVja1BhdGhJc051bGwocG0yX2Vudi5wbV9lcnJfbG9nX3BhdGgpICYmXG4gICAgICAgICAgKCFwbTJfZW52LnBtX2xvZ19wYXRoIHx8IFV0aWxpdHkuY2hlY2tQYXRoSXNOdWxsKHBtMl9lbnYucG1fbG9nX3BhdGgpKSlcbiAgICAgICAgICByZXR1cm4gY2IgPyBjYigpIDogZmFsc2U7XG5cbiAgICAgICAgICAvLyBUT0RPOiBwbGVhc2UgY2hlY2sgdGhpc1xuICAgICAgICAgIGNvbnN0IGVuY29kaW5nID0gXCJcIjtcbiAgICAgICAgc3Rkcy5zdGQgJiYgc3Rkcy5zdGQud3JpdGUgJiYgc3Rkcy5zdGQud3JpdGUobG9nX2RhdGEsIGVuY29kaW5nKTtcbiAgICAgICAgc3Rkcy5lcnIgJiYgc3Rkcy5lcnIud3JpdGUgJiYgc3Rkcy5lcnIud3JpdGUobG9nX2RhdGEsIGVuY29kaW5nLCBjYik7XG4gICAgICB9O1xuICAgIH0pKHByb2Nlc3Muc3RkZXJyLndyaXRlKTtcblxuICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlID0gKGZ1bmN0aW9uICh3cml0ZSkge1xuICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzdHJpbmcsIGNiKSB7XG4gICAgICAgIHZhciBsb2dfZGF0YSA9IG51bGw7XG5cbiAgICAgICAgLy8gRGlzYWJsZSBsb2dzIGlmIHNwZWNpZmllZFxuICAgICAgICBpZiAocG0yX2Vudi5kaXNhYmxlX2xvZ3MgPT09IHRydWUpIHtcbiAgICAgICAgICByZXR1cm4gY2IgPyBjYigpIDogZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocG0yX2Vudi5sb2dfdHlwZSAmJiBwbTJfZW52LmxvZ190eXBlID09PSAnanNvbicpIHtcbiAgICAgICAgICBsb2dfZGF0YSA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IHN0cmluZy50b1N0cmluZygpLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCAmJiBkYXlqcyA/XG4gICAgICAgICAgICAgIGRheWpzKCkuZm9ybWF0KHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0KSA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIHR5cGU6ICdvdXQnLFxuICAgICAgICAgICAgcHJvY2Vzc19pZDogcG0yX2Vudi5wbV9pZCxcbiAgICAgICAgICAgIGFwcF9uYW1lOiBwbTJfZW52Lm5hbWVcbiAgICAgICAgICB9KSArICdcXG4nO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0ICYmIGRheWpzKVxuICAgICAgICAgIGxvZ19kYXRhID0gYCR7ZGF5anMoKS5mb3JtYXQocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQpfTogJHtzdHJpbmcudG9TdHJpbmcoKX1gO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgbG9nX2RhdGEgPSBzdHJpbmcudG9TdHJpbmcoKTtcblxuICAgICAgICBwcm9jZXNzLnNlbmQoe1xuICAgICAgICAgIHR5cGU6ICdsb2c6b3V0JyxcbiAgICAgICAgICBkYXRhOiBsb2dfZGF0YVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoVXRpbGl0eS5jaGVja1BhdGhJc051bGwocG0yX2Vudi5wbV9vdXRfbG9nX3BhdGgpICYmXG4gICAgICAgICAgKCFwbTJfZW52LnBtX2xvZ19wYXRoIHx8IFV0aWxpdHkuY2hlY2tQYXRoSXNOdWxsKHBtMl9lbnYucG1fbG9nX3BhdGgpKSlcbiAgICAgICAgICByZXR1cm4gY2IgPyBjYigpIDogbnVsbDtcblxuICAgICAgICAgIC8vIFRPRE86IHBsZWFzZSBjaGVjayB0aGlzXG4gICAgICAgICAgY29uc3QgZW5jb2RpbmcgPSBcIlwiO1xuICAgICAgICBzdGRzLnN0ZCAmJiBzdGRzLnN0ZC53cml0ZSAmJiBzdGRzLnN0ZC53cml0ZShsb2dfZGF0YSwgZW5jb2RpbmcpO1xuICAgICAgICBzdGRzLm91dCAmJiBzdGRzLm91dC53cml0ZSAmJiBzdGRzLm91dC53cml0ZShsb2dfZGF0YSwgZW5jb2RpbmcsIGNiKTtcbiAgICAgIH07XG4gICAgfSkocHJvY2Vzcy5zdGRvdXQud3JpdGUpO1xuXG4gICAgZnVuY3Rpb24gZ2V0VW5jYXVnaHRFeGNlcHRpb25MaXN0ZW5lcihsaXN0ZW5lcikge1xuICAgICAgcmV0dXJuIGZ1bmN0aW9uIHVuY2F1Z2h0TGlzdGVuZXIoZXJyKSB7XG4gICAgICAgIHZhciBlcnJvciA9IGVyciAmJiBlcnIuc3RhY2sgPyBlcnIuc3RhY2sgOiBlcnI7XG5cbiAgICAgICAgaWYgKGxpc3RlbmVyID09PSAndW5oYW5kbGVkUmVqZWN0aW9uJykge1xuICAgICAgICAgIGVycm9yID0gJ1lvdSBoYXZlIHRyaWdnZXJlZCBhbiB1bmhhbmRsZWRSZWplY3Rpb24sIHlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gY2F0Y2ggYSBQcm9taXNlIHJlamVjdGlvbjpcXG4nICsgZXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICBsb2dFcnJvcihbJ3N0ZCcsICdlcnInXSwgZXJyb3IpO1xuXG4gICAgICAgIC8vIE5vdGlmeSBtYXN0ZXIgdGhhdCBhbiB1bmNhdWdodEV4Y2VwdGlvbiBoYXMgYmVlbiBjYXRjaGVkXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgdmFyIGVyck9iaiA9IHt9O1xuXG4gICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhlcnIpLmZvckVhY2goZnVuY3Rpb24gKGtleSkge1xuICAgICAgICAgICAgICBlcnJPYmpba2V5XSA9IGVycltrZXldO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcHJvY2Vzcy5zZW5kKHtcbiAgICAgICAgICAgIHR5cGU6ICdsb2c6ZXJyJyxcbiAgICAgICAgICAgIHRvcGljOiAnbG9nOmVycicsXG4gICAgICAgICAgICBkYXRhOiAnXFxuJyArIGVycm9yICsgJ1xcbidcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwcm9jZXNzLnNlbmQoe1xuICAgICAgICAgICAgdHlwZTogJ3Byb2Nlc3M6ZXhjZXB0aW9uJyxcbiAgICAgICAgICAgIGRhdGE6IGVyck9iaiAhPT0gdW5kZWZpbmVkID8gZXJyT2JqIDogeyBtZXNzYWdlOiAnTm8gZXJyb3IgYnV0ICcgKyBsaXN0ZW5lciArICcgd2FzIGNhdWdodCEnIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIGxvZ0Vycm9yKFsnc3RkJywgJ2VyciddLCAnQ2hhbm5lbCBpcyBhbHJlYWR5IGNsb3NlZCBjYW5cXCd0IGJyb2FkY2FzdCBlcnJvcjpcXG4nICsgZS5zdGFjayk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXByb2Nlc3MubGlzdGVuZXJzKGxpc3RlbmVyKS5maWx0ZXIoZnVuY3Rpb24gKGxpc3RlbmVyKSB7XG4gICAgICAgICAgcmV0dXJuIGxpc3RlbmVyICE9PSB1bmNhdWdodExpc3RlbmVyO1xuICAgICAgICB9KS5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAobGlzdGVuZXIgPT0gJ3VuY2F1Z2h0RXhjZXB0aW9uJykge1xuICAgICAgICAgICAgcHJvY2Vzcy5lbWl0KCdkaXNjb25uZWN0Jyk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoY3N0LkNPREVfVU5DQVVHSFRFWENFUFRJT04pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgZ2V0VW5jYXVnaHRFeGNlcHRpb25MaXN0ZW5lcigndW5jYXVnaHRFeGNlcHRpb24nKSk7XG4gICAgcHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgZ2V0VW5jYXVnaHRFeGNlcHRpb25MaXN0ZW5lcigndW5oYW5kbGVkUmVqZWN0aW9uJykpO1xuXG4gICAgLy8gQ2hhbmdlIGRpciB0byBmaXggcHJvY2Vzcy5jd2RcbiAgICBwcm9jZXNzLmNoZGlyKHBtMl9lbnYucG1fY3dkIHx8IHByb2Nlc3MuZW52LlBXRCB8fCBwLmRpcm5hbWUoc2NyaXB0KSk7XG5cbiAgICByZXF1aXJlKCdtb2R1bGUnKS5fbG9hZChzY3JpcHQsIG51bGwsIHRydWUpO1xuXG4gICAgZnVuY3Rpb24gbG9nRXJyb3IodHlwZXMsIGVycm9yKSB7XG4gICAgICB0cnkge1xuICAgICAgICB0eXBlcy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7XG4gICAgICAgICAgc3Rkc1t0eXBlXSAmJiB0eXBlb2Ygc3Rkc1t0eXBlXS53cml0ZSA9PSAnZnVuY3Rpb24nICYmIHN0ZHNbdHlwZV0ud3JpdGUoZXJyb3IgKyAnXFxuJyk7XG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZSkgeyB9XG4gICAgfVxuICB9KTtcbn1cbiJdfQ==
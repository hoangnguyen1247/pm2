"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _constants = _interopRequireDefault(require("../constants"));

var _Utility = _interopRequireDefault(require("./Utility"));

var _ProcessUtils = _interopRequireDefault(require("./ProcessUtils"));

/**
 * Copyright 2013 the PM2 project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 *
 * This file wrap target application
 * - redirect stdin, stderr to bus + log files
 * - rename process
 * - pid
 */
// Load all env-vars from master.
var pm2_env = JSON.parse(process.env.pm2_env);

for (var k in pm2_env) {
  process.env[k] = pm2_env[k];
} // Rename process


process.title = process.env.PROCESS_TITLE || 'node ' + pm2_env.pm_exec_path;
delete process.env.pm2_env;
/**
 * Main entrance to wrap the desired code
 */

(function ProcessContainer() {
  _ProcessUtils["default"].injectModules();

  var stdFile = pm2_env.pm_log_path;
  var outFile = pm2_env.pm_out_log_path;
  var errFile = pm2_env.pm_err_log_path;
  var pidFile = pm2_env.pm_pid_path;
  var script = pm2_env.pm_exec_path;
  var original_send = process.send;

  if (typeof process.env.source_map_support != 'undefined' && process.env.source_map_support !== 'false') {
    require('source-map-support').install();
  }

  process.send = function () {
    if (process.connected) return original_send.apply(this, arguments);
  }; //send node version


  if (process.versions && process.versions.node) {
    process.send({
      'node_version': process.versions.node
    });
  }

  if (_constants["default"].MODIFY_REQUIRE) require.main.filename = pm2_env.pm_exec_path; // Resets global paths for require()

  require('module')._initPaths();

  try {
    _fs["default"].writeFileSync(pidFile, process.pid.toString());
  } catch (e) {
    console.error(e.stack || e);
  } // Add args to process if args specified on start


  if (process.env.args != null) process.argv = process.argv.concat(pm2_env.args); // stdio, including: out, err and entire (both out and err if necessary).

  var stds = {
    out: outFile,
    err: errFile
  };
  stdFile && (stds.std = stdFile); // uid/gid management

  if (pm2_env.uid || pm2_env.gid) {
    try {
      if (pm2_env.uid) process.setuid(pm2_env.uid);
      if (process.env.gid) process.setgid(pm2_env.gid);
    } catch (e) {
      setTimeout(function () {
        console.error('%s on call %s', e.message, e.syscall);
        console.error('%s is not accessible', pm2_env.uid);
        return process.exit(1);
      }, 100);
    }
  }

  exec(script, stds);
})();
/**
 * Description
 * @method exec
 * @param {} script
 * @param {} stds
 * @return
 */


function exec(script, stds) {
  if (_path["default"].extname(script) == '.coffee') {
    try {
      require('coffee-script/register');
    } catch (e) {
      console.error('Failed to load CoffeeScript interpreter:', e.message || e);
    }
  }

  if (_path["default"].extname(script) == '.ls') {
    try {
      require('livescript');
    } catch (e) {
      console.error('Failed to load LiveScript interpreter:', e.message || e);
    }
  }

  if (_path["default"].extname(script) == '.ts' || _path["default"].extname(script) == '.tsx') {
    try {
      require('ts-node/register');
    } catch (e) {
      console.error('Failed to load Typescript interpreter:', e.message || e);
    }
  }

  process.on('message', function (msg) {
    if (msg.type === 'log:reload') {
      for (var k in stds) {
        if ((0, _typeof2["default"])(stds[k]) == 'object' && !isNaN(stds[k].fd)) {
          if (stds[k].destroy) stds[k].destroy();else if (stds[k].end) stds[k].end();else if (stds[k].close) stds[k].close();
          stds[k] = stds[k]._file;
        }
      }

      _Utility["default"].startLogging(stds, function (err) {
        if (err) return console.error('Failed to reload logs:', err.stack);
        console.log('Reloading log...');
      });
    }
  });
  var dayjs = null;
  if (pm2_env.log_date_format) dayjs = require('dayjs');

  _Utility["default"].startLogging(stds, function (err) {
    if (err) {
      process.send({
        type: 'process:exception',
        data: {
          message: err.message,
          syscall: 'ProcessContainer.startLogging'
        }
      });
      throw err;
      return;
    }

    process.stderr.write = function (write) {
      return function (string, cb) {
        var log_data = null; // Disable logs if specified

        if (pm2_env.disable_logs === true) {
          return cb ? cb() : false;
        }

        if (pm2_env.log_type && pm2_env.log_type === 'json') {
          log_data = JSON.stringify({
            message: string.toString(),
            timestamp: pm2_env.log_date_format && dayjs ? dayjs().format(pm2_env.log_date_format) : new Date().toISOString(),
            type: 'err',
            process_id: pm2_env.pm_id,
            app_name: pm2_env.name
          }) + '\n';
        } else if (pm2_env.log_date_format && dayjs) log_data = "".concat(dayjs().format(pm2_env.log_date_format), ": ").concat(string.toString());else log_data = string.toString();

        process.send({
          type: 'log:err',
          topic: 'log:err',
          data: log_data
        });
        if (_Utility["default"].checkPathIsNull(pm2_env.pm_err_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) return cb ? cb() : false; // TODO: please check this

        var encoding = "";
        stds.std && stds.std.write && stds.std.write(log_data, encoding);
        stds.err && stds.err.write && stds.err.write(log_data, encoding, cb);
      };
    }(process.stderr.write);

    process.stdout.write = function (write) {
      return function (string, cb) {
        var log_data = null; // Disable logs if specified

        if (pm2_env.disable_logs === true) {
          return cb ? cb() : false;
        }

        if (pm2_env.log_type && pm2_env.log_type === 'json') {
          log_data = JSON.stringify({
            message: string.toString(),
            timestamp: pm2_env.log_date_format && dayjs ? dayjs().format(pm2_env.log_date_format) : new Date().toISOString(),
            type: 'out',
            process_id: pm2_env.pm_id,
            app_name: pm2_env.name
          }) + '\n';
        } else if (pm2_env.log_date_format && dayjs) log_data = "".concat(dayjs().format(pm2_env.log_date_format), ": ").concat(string.toString());else log_data = string.toString();

        process.send({
          type: 'log:out',
          data: log_data
        });
        if (_Utility["default"].checkPathIsNull(pm2_env.pm_out_log_path) && (!pm2_env.pm_log_path || _Utility["default"].checkPathIsNull(pm2_env.pm_log_path))) return cb ? cb() : null; // TODO: please check this

        var encoding = "";
        stds.std && stds.std.write && stds.std.write(log_data, encoding);
        stds.out && stds.out.write && stds.out.write(log_data, encoding, cb);
      };
    }(process.stdout.write);

    function getUncaughtExceptionListener(listener) {
      return function uncaughtListener(err) {
        var error = err && err.stack ? err.stack : err;

        if (listener === 'unhandledRejection') {
          error = 'You have triggered an unhandledRejection, you may have forgotten to catch a Promise rejection:\n' + error;
        }

        logError(['std', 'err'], error); // Notify master that an uncaughtException has been catched

        try {
          if (err) {
            var errObj = {};
            Object.getOwnPropertyNames(err).forEach(function (key) {
              errObj[key] = err[key];
            });
          }

          process.send({
            type: 'log:err',
            topic: 'log:err',
            data: '\n' + error + '\n'
          });
          process.send({
            type: 'process:exception',
            data: errObj !== undefined ? errObj : {
              message: 'No error but ' + listener + ' was caught!'
            }
          });
        } catch (e) {
          logError(['std', 'err'], 'Channel is already closed can\'t broadcast error:\n' + e.stack);
        }

        if (!process.listeners(listener).filter(function (listener) {
          return listener !== uncaughtListener;
        }).length) {
          if (listener == 'uncaughtException') {
            process.emit('disconnect');
            process.exit(_constants["default"].CODE_UNCAUGHTEXCEPTION);
          }
        }
      };
    }

    process.on('uncaughtException', getUncaughtExceptionListener('uncaughtException'));
    process.on('unhandledRejection', getUncaughtExceptionListener('unhandledRejection')); // Change dir to fix process.cwd

    process.chdir(pm2_env.pm_cwd || process.env.PWD || _path["default"].dirname(script));

    require('module')._load(script, null, true);

    function logError(types, error) {
      try {
        types.forEach(function (type) {
          stds[type] && typeof stds[type].write == 'function' && stds[type].write(error + '\n');
        });
      } catch (e) {}
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Qcm9jZXNzQ29udGFpbmVyTGVnYWN5LnRzIl0sIm5hbWVzIjpbInBtMl9lbnYiLCJKU09OIiwicGFyc2UiLCJwcm9jZXNzIiwiZW52IiwiayIsInRpdGxlIiwiUFJPQ0VTU19USVRMRSIsInBtX2V4ZWNfcGF0aCIsIlByb2Nlc3NDb250YWluZXIiLCJQcm9jZXNzVXRpbHMiLCJpbmplY3RNb2R1bGVzIiwic3RkRmlsZSIsInBtX2xvZ19wYXRoIiwib3V0RmlsZSIsInBtX291dF9sb2dfcGF0aCIsImVyckZpbGUiLCJwbV9lcnJfbG9nX3BhdGgiLCJwaWRGaWxlIiwicG1fcGlkX3BhdGgiLCJzY3JpcHQiLCJvcmlnaW5hbF9zZW5kIiwic2VuZCIsInNvdXJjZV9tYXBfc3VwcG9ydCIsInJlcXVpcmUiLCJpbnN0YWxsIiwiY29ubmVjdGVkIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJ2ZXJzaW9ucyIsIm5vZGUiLCJjc3QiLCJNT0RJRllfUkVRVUlSRSIsIm1haW4iLCJmaWxlbmFtZSIsIl9pbml0UGF0aHMiLCJmcyIsIndyaXRlRmlsZVN5bmMiLCJwaWQiLCJ0b1N0cmluZyIsImUiLCJjb25zb2xlIiwiZXJyb3IiLCJzdGFjayIsImFyZ3MiLCJhcmd2IiwiY29uY2F0Iiwic3RkcyIsIm91dCIsImVyciIsInN0ZCIsInVpZCIsImdpZCIsInNldHVpZCIsInNldGdpZCIsInNldFRpbWVvdXQiLCJtZXNzYWdlIiwic3lzY2FsbCIsImV4aXQiLCJleGVjIiwicCIsImV4dG5hbWUiLCJvbiIsIm1zZyIsInR5cGUiLCJpc05hTiIsImZkIiwiZGVzdHJveSIsImVuZCIsImNsb3NlIiwiX2ZpbGUiLCJVdGlsaXR5Iiwic3RhcnRMb2dnaW5nIiwibG9nIiwiZGF5anMiLCJsb2dfZGF0ZV9mb3JtYXQiLCJkYXRhIiwic3RkZXJyIiwid3JpdGUiLCJzdHJpbmciLCJjYiIsImxvZ19kYXRhIiwiZGlzYWJsZV9sb2dzIiwibG9nX3R5cGUiLCJzdHJpbmdpZnkiLCJ0aW1lc3RhbXAiLCJmb3JtYXQiLCJEYXRlIiwidG9JU09TdHJpbmciLCJwcm9jZXNzX2lkIiwicG1faWQiLCJhcHBfbmFtZSIsIm5hbWUiLCJ0b3BpYyIsImNoZWNrUGF0aElzTnVsbCIsImVuY29kaW5nIiwic3Rkb3V0IiwiZ2V0VW5jYXVnaHRFeGNlcHRpb25MaXN0ZW5lciIsImxpc3RlbmVyIiwidW5jYXVnaHRMaXN0ZW5lciIsImxvZ0Vycm9yIiwiZXJyT2JqIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsImZvckVhY2giLCJrZXkiLCJ1bmRlZmluZWQiLCJsaXN0ZW5lcnMiLCJmaWx0ZXIiLCJsZW5ndGgiLCJlbWl0IiwiQ09ERV9VTkNBVUdIVEVYQ0VQVElPTiIsImNoZGlyIiwicG1fY3dkIiwiUFdEIiwiZGlybmFtZSIsIl9sb2FkIiwidHlwZXMiXSwibWFwcGluZ3MiOiI7Ozs7OztBQVVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQWRBOzs7Ozs7Ozs7O0FBZ0JBO0FBQ0EsSUFBSUEsT0FBTyxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0MsT0FBTyxDQUFDQyxHQUFSLENBQVlKLE9BQXZCLENBQWQ7O0FBQ0EsS0FBSyxJQUFJSyxDQUFULElBQWNMLE9BQWQsRUFBdUI7QUFDckJHLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxDQUFaLElBQWlCTCxPQUFPLENBQUNLLENBQUQsQ0FBeEI7QUFDRCxDLENBRUQ7OztBQUNBRixPQUFPLENBQUNHLEtBQVIsR0FBZ0JILE9BQU8sQ0FBQ0MsR0FBUixDQUFZRyxhQUFaLElBQTZCLFVBQVVQLE9BQU8sQ0FBQ1EsWUFBL0Q7QUFFQSxPQUFPTCxPQUFPLENBQUNDLEdBQVIsQ0FBWUosT0FBbkI7QUFFQTs7OztBQUdBLENBQUMsU0FBU1MsZ0JBQVQsR0FBNEI7QUFFM0JDLDJCQUFhQyxhQUFiOztBQUVBLE1BQUlDLE9BQU8sR0FBR1osT0FBTyxDQUFDYSxXQUF0QjtBQUNBLE1BQUlDLE9BQU8sR0FBR2QsT0FBTyxDQUFDZSxlQUF0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IENvcHlyaWdodCAyMDEzIHRoZSBQTTIgcHJvamVjdCBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBsaWNlbnNlIHRoYXRcbiAqIGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLlxuICpcbiAqIFRoaXMgZmlsZSB3cmFwIHRhcmdldCBhcHBsaWNhdGlvblxuICogLSByZWRpcmVjdCBzdGRpbiwgc3RkZXJyIHRvIGJ1cyArIGxvZyBmaWxlc1xuICogLSByZW5hbWUgcHJvY2Vzc1xuICogLSBwaWRcbiAqL1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGNzdCBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IFV0aWxpdHkgZnJvbSAnLi9VdGlsaXR5JztcbmltcG9ydCBQcm9jZXNzVXRpbHMgZnJvbSAnLi9Qcm9jZXNzVXRpbHMnO1xuXG4vLyBMb2FkIGFsbCBlbnYtdmFycyBmcm9tIG1hc3Rlci5cbnZhciBwbTJfZW52ID0gSlNPTi5wYXJzZShwcm9jZXNzLmVudi5wbTJfZW52KTtcbmZvciAodmFyIGsgaW4gcG0yX2Vudikge1xuICBwcm9jZXNzLmVudltrXSA9IHBtMl9lbnZba107XG59XG5cbi8vIFJlbmFtZSBwcm9jZXNzXG5wcm9jZXNzLnRpdGxlID0gcHJvY2Vzcy5lbnYuUFJPQ0VTU19USVRMRSB8fCAnbm9kZSAnICsgcG0yX2Vudi5wbV9leGVjX3BhdGg7XG5cbmRlbGV0ZSBwcm9jZXNzLmVudi5wbTJfZW52O1xuXG4vKipcbiAqIE1haW4gZW50cmFuY2UgdG8gd3JhcCB0aGUgZGVzaXJlZCBjb2RlXG4gKi9cbihmdW5jdGlvbiBQcm9jZXNzQ29udGFpbmVyKCkge1xuXG4gIFByb2Nlc3NVdGlscy5pbmplY3RNb2R1bGVzKClcblxuICB2YXIgc3RkRmlsZSA9IHBtMl9lbnYucG1fbG9nX3BhdGg7XG4gIHZhciBvdXRGaWxlID0gcG0yX2Vudi5wbV9vdXRfbG9nX3BhdGg7XG4gIHZhciBlcnJGaWxlID0gcG0yX2Vudi5wbV9lcnJfbG9nX3BhdGg7XG4gIHZhciBwaWRGaWxlID0gcG0yX2Vudi5wbV9waWRfcGF0aDtcbiAgdmFyIHNjcmlwdCA9IHBtMl9lbnYucG1fZXhlY19wYXRoO1xuXG4gIHZhciBvcmlnaW5hbF9zZW5kID0gcHJvY2Vzcy5zZW5kO1xuXG4gIGlmICh0eXBlb2YgKHByb2Nlc3MuZW52LnNvdXJjZV9tYXBfc3VwcG9ydCkgIT0gJ3VuZGVmaW5lZCcgJiZcbiAgICBwcm9jZXNzLmVudi5zb3VyY2VfbWFwX3N1cHBvcnQgIT09ICdmYWxzZScpIHtcbiAgICByZXF1aXJlKCdzb3VyY2UtbWFwLXN1cHBvcnQnKS5pbnN0YWxsKCk7XG4gIH1cblxuICBwcm9jZXNzLnNlbmQgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHByb2Nlc3MuY29ubmVjdGVkKVxuICAgICAgcmV0dXJuIG9yaWdpbmFsX3NlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzIGFzIGFueSk7XG4gIH07XG5cbiAgLy9zZW5kIG5vZGUgdmVyc2lvblxuICBpZiAocHJvY2Vzcy52ZXJzaW9ucyAmJiBwcm9jZXNzLnZlcnNpb25zLm5vZGUpIHtcbiAgICBwcm9jZXNzLnNlbmQoe1xuICAgICAgJ25vZGVfdmVyc2lvbic6IHByb2Nlc3MudmVyc2lvbnMubm9kZVxuICAgIH0pO1xuICB9XG5cbiAgaWYgKGNzdC5NT0RJRllfUkVRVUlSRSlcbiAgICByZXF1aXJlLm1haW4uZmlsZW5hbWUgPSBwbTJfZW52LnBtX2V4ZWNfcGF0aDtcblxuICAvLyBSZXNldHMgZ2xvYmFsIHBhdGhzIGZvciByZXF1aXJlKClcbiAgcmVxdWlyZSgnbW9kdWxlJykuX2luaXRQYXRocygpO1xuXG4gIHRyeSB7XG4gICAgZnMud3JpdGVGaWxlU3luYyhwaWRGaWxlLCBwcm9jZXNzLnBpZC50b1N0cmluZygpKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUuZXJyb3IoZS5zdGFjayB8fCBlKTtcbiAgfVxuXG4gIC8vIEFkZCBhcmdzIHRvIHByb2Nlc3MgaWYgYXJncyBzcGVjaWZpZWQgb24gc3RhcnRcbiAgaWYgKHByb2Nlc3MuZW52LmFyZ3MgIT0gbnVsbClcbiAgICBwcm9jZXNzLmFyZ3YgPSBwcm9jZXNzLmFyZ3YuY29uY2F0KHBtMl9lbnYuYXJncyk7XG5cbiAgLy8gc3RkaW8sIGluY2x1ZGluZzogb3V0LCBlcnIgYW5kIGVudGlyZSAoYm90aCBvdXQgYW5kIGVyciBpZiBuZWNlc3NhcnkpLlxuICB2YXIgc3RkczogYW55ID0ge1xuICAgIG91dDogb3V0RmlsZSxcbiAgICBlcnI6IGVyckZpbGVcbiAgfTtcbiAgc3RkRmlsZSAmJiAoc3Rkcy5zdGQgPSBzdGRGaWxlKTtcblxuICAvLyB1aWQvZ2lkIG1hbmFnZW1lbnRcbiAgaWYgKHBtMl9lbnYudWlkIHx8IHBtMl9lbnYuZ2lkKSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChwbTJfZW52LnVpZClcbiAgICAgICAgcHJvY2Vzcy5zZXR1aWQocG0yX2Vudi51aWQpO1xuICAgICAgaWYgKHByb2Nlc3MuZW52LmdpZClcbiAgICAgICAgcHJvY2Vzcy5zZXRnaWQocG0yX2Vudi5naWQpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKCclcyBvbiBjYWxsICVzJywgZS5tZXNzYWdlLCBlLnN5c2NhbGwpO1xuICAgICAgICBjb25zb2xlLmVycm9yKCclcyBpcyBub3QgYWNjZXNzaWJsZScsIHBtMl9lbnYudWlkKTtcbiAgICAgICAgcmV0dXJuIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH0sIDEwMCk7XG4gICAgfVxuICB9XG5cbiAgZXhlYyhzY3JpcHQsIHN0ZHMpO1xufSkoKTtcblxuLyoqXG4gKiBEZXNjcmlwdGlvblxuICogQG1ldGhvZCBleGVjXG4gKiBAcGFyYW0ge30gc2NyaXB0XG4gKiBAcGFyYW0ge30gc3Rkc1xuICogQHJldHVyblxuICovXG5mdW5jdGlvbiBleGVjKHNjcmlwdCwgc3Rkcykge1xuICBpZiAocC5leHRuYW1lKHNjcmlwdCkgPT0gJy5jb2ZmZWUnKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJlcXVpcmUoJ2NvZmZlZS1zY3JpcHQvcmVnaXN0ZXInKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBDb2ZmZWVTY3JpcHQgaW50ZXJwcmV0ZXI6JywgZS5tZXNzYWdlIHx8IGUpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChwLmV4dG5hbWUoc2NyaXB0KSA9PSAnLmxzJykge1xuICAgIHRyeSB7XG4gICAgICByZXF1aXJlKCdsaXZlc2NyaXB0Jyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGxvYWQgTGl2ZVNjcmlwdCBpbnRlcnByZXRlcjonLCBlLm1lc3NhZ2UgfHwgZSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHAuZXh0bmFtZShzY3JpcHQpID09ICcudHMnIHx8IHAuZXh0bmFtZShzY3JpcHQpID09ICcudHN4Jykge1xuICAgIHRyeSB7XG4gICAgICByZXF1aXJlKCd0cy1ub2RlL3JlZ2lzdGVyJyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGxvYWQgVHlwZXNjcmlwdCBpbnRlcnByZXRlcjonLCBlLm1lc3NhZ2UgfHwgZSk7XG4gICAgfVxuICB9XG5cbiAgcHJvY2Vzcy5vbignbWVzc2FnZScsIGZ1bmN0aW9uIChtc2cpIHtcbiAgICBpZiAobXNnLnR5cGUgPT09ICdsb2c6cmVsb2FkJykge1xuICAgICAgZm9yICh2YXIgayBpbiBzdGRzKSB7XG4gICAgICAgIGlmICh0eXBlb2Ygc3Rkc1trXSA9PSAnb2JqZWN0JyAmJiAhaXNOYU4oc3Rkc1trXS5mZCkpIHtcbiAgICAgICAgICBpZiAoc3Rkc1trXS5kZXN0cm95KSBzdGRzW2tdLmRlc3Ryb3koKTtcbiAgICAgICAgICBlbHNlIGlmIChzdGRzW2tdLmVuZCkgc3Rkc1trXS5lbmQoKTtcbiAgICAgICAgICBlbHNlIGlmIChzdGRzW2tdLmNsb3NlKSBzdGRzW2tdLmNsb3NlKCk7XG4gICAgICAgICAgc3Rkc1trXSA9IHN0ZHNba10uX2ZpbGU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIFV0aWxpdHkuc3RhcnRMb2dnaW5nKHN0ZHMsIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgaWYgKGVycilcbiAgICAgICAgICByZXR1cm4gY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHJlbG9hZCBsb2dzOicsIGVyci5zdGFjayk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdSZWxvYWRpbmcgbG9nLi4uJyk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIHZhciBkYXlqcyA9IG51bGw7XG5cbiAgaWYgKHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0KVxuICAgIGRheWpzID0gcmVxdWlyZSgnZGF5anMnKTtcblxuICBVdGlsaXR5LnN0YXJ0TG9nZ2luZyhzdGRzLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgcHJvY2Vzcy5zZW5kKHtcbiAgICAgICAgdHlwZTogJ3Byb2Nlc3M6ZXhjZXB0aW9uJyxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICAgIHN5c2NhbGw6ICdQcm9jZXNzQ29udGFpbmVyLnN0YXJ0TG9nZ2luZydcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcHJvY2Vzcy5zdGRlcnIud3JpdGUgPSAoZnVuY3Rpb24gKHdyaXRlKSB7XG4gICAgICByZXR1cm4gZnVuY3Rpb24gKHN0cmluZywgY2IpIHtcbiAgICAgICAgdmFyIGxvZ19kYXRhID0gbnVsbDtcblxuICAgICAgICAvLyBEaXNhYmxlIGxvZ3MgaWYgc3BlY2lmaWVkXG4gICAgICAgIGlmIChwbTJfZW52LmRpc2FibGVfbG9ncyA9PT0gdHJ1ZSkge1xuICAgICAgICAgIHJldHVybiBjYiA/IGNiKCkgOiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwbTJfZW52LmxvZ190eXBlICYmIHBtMl9lbnYubG9nX3R5cGUgPT09ICdqc29uJykge1xuICAgICAgICAgIGxvZ19kYXRhID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgbWVzc2FnZTogc3RyaW5nLnRvU3RyaW5nKCksXG4gICAgICAgICAgICB0aW1lc3RhbXA6IHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0ICYmIGRheWpzID9cbiAgICAgICAgICAgICAgZGF5anMoKS5mb3JtYXQocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQpIDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgdHlwZTogJ2VycicsXG4gICAgICAgICAgICBwcm9jZXNzX2lkOiBwbTJfZW52LnBtX2lkLFxuICAgICAgICAgICAgYXBwX25hbWU6IHBtMl9lbnYubmFtZVxuICAgICAgICAgIH0pICsgJ1xcbic7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAocG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQgJiYgZGF5anMpXG4gICAgICAgICAgbG9nX2RhdGEgPSBgJHtkYXlqcygpLmZvcm1hdChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCl9OiAke3N0cmluZy50b1N0cmluZygpfWA7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICBsb2dfZGF0YSA9IHN0cmluZy50b1N0cmluZygpO1xuXG4gICAgICAgIHByb2Nlc3Muc2VuZCh7XG4gICAgICAgICAgdHlwZTogJ2xvZzplcnInLFxuICAgICAgICAgIHRvcGljOiAnbG9nOmVycicsXG4gICAgICAgICAgZGF0YTogbG9nX2RhdGFcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKFV0aWxpdHkuY2hlY2tQYXRoSXNOdWxsKHBtMl9lbnYucG1fZXJyX2xvZ19wYXRoKSAmJlxuICAgICAgICAgICghcG0yX2Vudi5wbV9sb2dfcGF0aCB8fCBVdGlsaXR5LmNoZWNrUGF0aElzTnVsbChwbTJfZW52LnBtX2xvZ19wYXRoKSkpXG4gICAgICAgICAgcmV0dXJuIGNiID8gY2IoKSA6IGZhbHNlO1xuXG4gICAgICAgICAgLy8gVE9ETzogcGxlYXNlIGNoZWNrIHRoaXNcbiAgICAgICAgICBjb25zdCBlbmNvZGluZyA9IFwiXCI7XG4gICAgICAgIHN0ZHMuc3RkICYmIHN0ZHMuc3RkLndyaXRlICYmIHN0ZHMuc3RkLndyaXRlKGxvZ19kYXRhLCBlbmNvZGluZyk7XG4gICAgICAgIHN0ZHMuZXJyICYmIHN0ZHMuZXJyLndyaXRlICYmIHN0ZHMuZXJyLndyaXRlKGxvZ19kYXRhLCBlbmNvZGluZywgY2IpO1xuICAgICAgfTtcbiAgICB9KShwcm9jZXNzLnN0ZGVyci53cml0ZSk7XG5cbiAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSA9IChmdW5jdGlvbiAod3JpdGUpIHtcbiAgICAgIHJldHVybiBmdW5jdGlvbiAoc3RyaW5nLCBjYikge1xuICAgICAgICB2YXIgbG9nX2RhdGEgPSBudWxsO1xuXG4gICAgICAgIC8vIERpc2FibGUgbG9ncyBpZiBzcGVjaWZpZWRcbiAgICAgICAgaWYgKHBtMl9lbnYuZGlzYWJsZV9sb2dzID09PSB0cnVlKSB7XG4gICAgICAgICAgcmV0dXJuIGNiID8gY2IoKSA6IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBtMl9lbnYubG9nX3R5cGUgJiYgcG0yX2Vudi5sb2dfdHlwZSA9PT0gJ2pzb24nKSB7XG4gICAgICAgICAgbG9nX2RhdGEgPSBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICBtZXNzYWdlOiBzdHJpbmcudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIHRpbWVzdGFtcDogcG0yX2Vudi5sb2dfZGF0ZV9mb3JtYXQgJiYgZGF5anMgP1xuICAgICAgICAgICAgICBkYXlqcygpLmZvcm1hdChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCkgOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICB0eXBlOiAnb3V0JyxcbiAgICAgICAgICAgIHByb2Nlc3NfaWQ6IHBtMl9lbnYucG1faWQsXG4gICAgICAgICAgICBhcHBfbmFtZTogcG0yX2Vudi5uYW1lXG4gICAgICAgICAgfSkgKyAnXFxuJztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChwbTJfZW52LmxvZ19kYXRlX2Zvcm1hdCAmJiBkYXlqcylcbiAgICAgICAgICBsb2dfZGF0YSA9IGAke2RheWpzKCkuZm9ybWF0KHBtMl9lbnYubG9nX2RhdGVfZm9ybWF0KX06ICR7c3RyaW5nLnRvU3RyaW5nKCl9YDtcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGxvZ19kYXRhID0gc3RyaW5nLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgcHJvY2Vzcy5zZW5kKHtcbiAgICAgICAgICB0eXBlOiAnbG9nOm91dCcsXG4gICAgICAgICAgZGF0YTogbG9nX2RhdGFcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKFV0aWxpdHkuY2hlY2tQYXRoSXNOdWxsKHBtMl9lbnYucG1fb3V0X2xvZ19wYXRoKSAmJlxuICAgICAgICAgICghcG0yX2Vudi5wbV9sb2dfcGF0aCB8fCBVdGlsaXR5LmNoZWNrUGF0aElzTnVsbChwbTJfZW52LnBtX2xvZ19wYXRoKSkpXG4gICAgICAgICAgcmV0dXJuIGNiID8gY2IoKSA6IG51bGw7XG5cbiAgICAgICAgICAvLyBUT0RPOiBwbGVhc2UgY2hlY2sgdGhpc1xuICAgICAgICAgIGNvbnN0IGVuY29kaW5nID0gXCJcIjtcbiAgICAgICAgc3Rkcy5zdGQgJiYgc3Rkcy5zdGQud3JpdGUgJiYgc3Rkcy5zdGQud3JpdGUobG9nX2RhdGEsIGVuY29kaW5nKTtcbiAgICAgICAgc3Rkcy5vdXQgJiYgc3Rkcy5vdXQud3JpdGUgJiYgc3Rkcy5vdXQud3JpdGUobG9nX2RhdGEsIGVuY29kaW5nLCBjYik7XG4gICAgICB9O1xuICAgIH0pKHByb2Nlc3Muc3Rkb3V0LndyaXRlKTtcblxuICAgIGZ1bmN0aW9uIGdldFVuY2F1Z2h0RXhjZXB0aW9uTGlzdGVuZXIobGlzdGVuZXIpIHtcbiAgICAgIHJldHVybiBmdW5jdGlvbiB1bmNhdWdodExpc3RlbmVyKGVycikge1xuICAgICAgICB2YXIgZXJyb3IgPSBlcnIgJiYgZXJyLnN0YWNrID8gZXJyLnN0YWNrIDogZXJyO1xuXG4gICAgICAgIGlmIChsaXN0ZW5lciA9PT0gJ3VuaGFuZGxlZFJlamVjdGlvbicpIHtcbiAgICAgICAgICBlcnJvciA9ICdZb3UgaGF2ZSB0cmlnZ2VyZWQgYW4gdW5oYW5kbGVkUmVqZWN0aW9uLCB5b3UgbWF5IGhhdmUgZm9yZ290dGVuIHRvIGNhdGNoIGEgUHJvbWlzZSByZWplY3Rpb246XFxuJyArIGVycm9yO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nRXJyb3IoWydzdGQnLCAnZXJyJ10sIGVycm9yKTtcblxuICAgICAgICAvLyBOb3RpZnkgbWFzdGVyIHRoYXQgYW4gdW5jYXVnaHRFeGNlcHRpb24gaGFzIGJlZW4gY2F0Y2hlZFxuICAgICAgICB0cnkge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIHZhciBlcnJPYmogPSB7fTtcblxuICAgICAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoZXJyKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgICAgICAgZXJyT2JqW2tleV0gPSBlcnJba2V5XTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHByb2Nlc3Muc2VuZCh7XG4gICAgICAgICAgICB0eXBlOiAnbG9nOmVycicsXG4gICAgICAgICAgICB0b3BpYzogJ2xvZzplcnInLFxuICAgICAgICAgICAgZGF0YTogJ1xcbicgKyBlcnJvciArICdcXG4nXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcHJvY2Vzcy5zZW5kKHtcbiAgICAgICAgICAgIHR5cGU6ICdwcm9jZXNzOmV4Y2VwdGlvbicsXG4gICAgICAgICAgICBkYXRhOiBlcnJPYmogIT09IHVuZGVmaW5lZCA/IGVyck9iaiA6IHsgbWVzc2FnZTogJ05vIGVycm9yIGJ1dCAnICsgbGlzdGVuZXIgKyAnIHdhcyBjYXVnaHQhJyB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBsb2dFcnJvcihbJ3N0ZCcsICdlcnInXSwgJ0NoYW5uZWwgaXMgYWxyZWFkeSBjbG9zZWQgY2FuXFwndCBicm9hZGNhc3QgZXJyb3I6XFxuJyArIGUuc3RhY2spO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFwcm9jZXNzLmxpc3RlbmVycyhsaXN0ZW5lcikuZmlsdGVyKGZ1bmN0aW9uIChsaXN0ZW5lcikge1xuICAgICAgICAgIHJldHVybiBsaXN0ZW5lciAhPT0gdW5jYXVnaHRMaXN0ZW5lcjtcbiAgICAgICAgfSkubGVuZ3RoKSB7XG4gICAgICAgICAgaWYgKGxpc3RlbmVyID09ICd1bmNhdWdodEV4Y2VwdGlvbicpIHtcbiAgICAgICAgICAgIHByb2Nlc3MuZW1pdCgnZGlzY29ubmVjdCcpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KGNzdC5DT0RFX1VOQ0FVR0hURVhDRVBUSU9OKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIGdldFVuY2F1Z2h0RXhjZXB0aW9uTGlzdGVuZXIoJ3VuY2F1Z2h0RXhjZXB0aW9uJykpO1xuICAgIHByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIGdldFVuY2F1Z2h0RXhjZXB0aW9uTGlzdGVuZXIoJ3VuaGFuZGxlZFJlamVjdGlvbicpKTtcblxuICAgIC8vIENoYW5nZSBkaXIgdG8gZml4IHByb2Nlc3MuY3dkXG4gICAgcHJvY2Vzcy5jaGRpcihwbTJfZW52LnBtX2N3ZCB8fCBwcm9jZXNzLmVudi5QV0QgfHwgcC5kaXJuYW1lKHNjcmlwdCkpO1xuXG4gICAgcmVxdWlyZSgnbW9kdWxlJykuX2xvYWQoc2NyaXB0LCBudWxsLCB0cnVlKTtcblxuICAgIGZ1bmN0aW9uIGxvZ0Vycm9yKHR5cGVzLCBlcnJvcikge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdHlwZXMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkge1xuICAgICAgICAgIHN0ZHNbdHlwZV0gJiYgdHlwZW9mIHN0ZHNbdHlwZV0ud3JpdGUgPT0gJ2Z1bmN0aW9uJyAmJiBzdGRzW3R5cGVdLndyaXRlKGVycm9yICsgJ1xcbicpO1xuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHsgfVxuICAgIH1cbiAgfSk7XG59XG4iXX0=